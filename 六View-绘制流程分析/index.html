<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="在我的系列文章上一篇： App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析 中已经分析了一个 App 从点击它的图标到 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用的整个流程。我们都知道，普通 App 屏幕上显示的内容都是由一个个自己设计的界面被系统加载而来的，而这些界面中的元素又是怎么被渲染出来的呢？本文将继续基于 Android Nougat 从源码的角度来进一步分析整个过程。"><meta property="og:title" content="六、View 绘制流程分析"><meta property="og:description" content="在我的系列文章上一篇： App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析 中已经分析了一个 App 从点击它的图标到 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用的整个流程。我们都知道，普通 App 屏幕上显示的内容都是由一个个自己设计的界面被系统加载而来的，而这些界面中的元素又是怎么被渲染出来的呢？本文将继续基于 Android Nougat 从源码的角度来进一步分析整个过程。"><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="六、View 绘制流程分析"><meta name=twitter:description content="在我的系列文章上一篇： App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析 中已经分析了一个 App 从点击它的图标到 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用的整个流程。我们都知道，普通 App 屏幕上显示的内容都是由一个个自己设计的界面被系统加载而来的，而这些界面中的元素又是怎么被渲染出来的呢？本文将继续基于 Android Nougat 从源码的角度来进一步分析整个过程。"><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>六、View 绘制流程分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.592437b1fbffed6c8a18843d158121af.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.a7a23db1d0aa39ecac0c61a41b5e946c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.293b6ed88f797000f698881f747ba3eb.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>六、View 绘制流程分析</h1><p class=meta>Last updated
Mar 25, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/DecorView/>Decor view</a></li><li><a href=https://www.guanpj.top/tags/ViewRootImpl/>View root impl</a></li><li><a href=https://www.guanpj.top/tags/WMS/>Wms</a></li><li><a href=https://www.guanpj.top/tags/Framework/>Framework</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#一初始化-phonewindow-和-windowmanager>一：初始化 PhoneWindow 和 WindowManager</a></li><li><a href=#二初始化-decorview>二：初始化 DecorView</a><ol><li><a href=#源码分析>源码分析</a></li><li><a href=#小结>小结</a></li></ol></li><li><a href=#三初始化-viewrootimpl-并关联-decorview>三：初始化 ViewRootImpl 并关联 DecorView</a><ol><li><a href=#源码分析-1>源码分析</a></li><li><a href=#小结-1>小结</a></li></ol></li><li><a href=#四建立-phonewindow-和-windowmanagerservice-之间的连接>四：建立 PhoneWindow 和 WindowManagerService 之间的连接</a><ol><li><a href=#源码分析-2>源码分析</a></li><li><a href=#小结-2>小结</a></li></ol></li><li><a href=#五建立与-surfaceflinger-的连接>五：建立与 SurfaceFlinger 的连接</a><ol><li><a href=#源码分析-3>源码分析</a></li><li><a href=#小结-3>小结</a></li></ol></li><li><a href=#六申请-surface>六：申请 Surface</a></li><li><a href=#七正式绘制-view>七：正式绘制 View</a><ol><li><a href=#理解-measurespec>理解 MeasureSpec</a></li><li><a href=#measure-流程分析>Measure 流程分析</a></li><li><a href=#layout-流程分析>Layout 流程分析</a></li><li><a href=#draw-流程分析>Draw 流程分析</a></li><li><a href=#小结-4>小结</a></li></ol></li><li><a href=#八显示-view>八：显示 View</a></li><li><a href=#总结>总结</a></li></ol></nav></details></aside><p>在我的系列文章上一篇：
<a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析</a> 中已经分析了一个 App 从点击它的图标到 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用的整个流程。我们都知道，普通 App 屏幕上显示的内容都是由一个个自己设计的界面被系统加载而来的，而这些界面中的元素又是怎么被渲染出来的呢？本文将继续基于 Android Nougat 从源码的角度来进一步分析整个过程。</p><p>在开始之前，回顾一下上一篇文章中分析的从 ActivityThread 到 Activity 过程的时序图：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045616.png width=auto alt></p><a href=#一初始化-phonewindow-和-windowmanager><h1 id=一初始化-phonewindow-和-windowmanager><span class=hanchor arialabel=Anchor># </span>一：初始化 PhoneWindow 和 WindowManager</h1></a><p>如上图所示，在 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用之前，它的 attach() 方法将会先被调用，因此，我们将 attach() 方法作为这篇文章主线的开头：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>attach</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=n>ActivityThread</span> <span class=n>aThread</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Instrumentation</span> <span class=n>instr</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span> <span class=kt>int</span> <span class=n>ident</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Application</span> <span class=n>application</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>ActivityInfo</span> <span class=n>info</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>CharSequence</span> <span class=n>title</span><span class=o>,</span> <span class=n>Activity</span> <span class=n>parent</span><span class=o>,</span> <span class=n>String</span> <span class=n>id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>NonConfigurationInstances</span> <span class=n>lastNonConfigurationInstances</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Configuration</span> <span class=n>config</span><span class=o>,</span> <span class=n>String</span> <span class=n>referrer</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Window</span> <span class=n>window</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>attachBaseContext</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mWindow 是一个 PhoneWindow 对象实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mWindow</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PhoneWindow</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>window</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mWindow</span><span class=o>.</span><span class=na>setWindowControllerCallback</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mWindow</span><span class=o>.</span><span class=na>setCallback</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mWindow</span><span class=o>.</span><span class=na>setOnWindowDismissedCallback</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mWindow</span><span class=o>.</span><span class=na>getLayoutInflater</span><span class=o>().</span><span class=na>setPrivateFactory</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 Window 的 setWindowManager 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mWindow</span><span class=o>.</span><span class=na>setWindowManager</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>WindowManager</span><span class=o>)</span><span class=n>context</span><span class=o>.</span><span class=na>getSystemService</span><span class=o>(</span><span class=n>Context</span><span class=o>.</span><span class=na>WINDOW_SERVICE</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>mToken</span><span class=o>,</span> <span class=n>mComponent</span><span class=o>.</span><span class=na>flattenToString</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>info</span><span class=o>.</span><span class=na>flags</span> <span class=o>&amp;</span> <span class=n>ActivityInfo</span><span class=o>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mParent</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mWindow</span><span class=o>.</span><span class=na>setContainer</span><span class=o>(</span><span class=n>mParent</span><span class=o>.</span><span class=na>getWindow</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 从 Window 中获取 WindowManager
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mWindowManager</span> <span class=o>=</span> <span class=n>mWindow</span><span class=o>.</span><span class=na>getWindowManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>mCurrentConfig</span> <span class=o>=</span> <span class=n>config</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>mWindow 是一个 Window 类型的变量，在 attach() 方法中，创建了一个 PhoneWindow 对象实例并赋值给了 mWindow，PhoneWindow 直接继承自 Window 类。然后调用了 Window 的 setWindowManager() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setWindowManager</span><span class=o>(</span><span class=n>WindowManager</span> <span class=n>wm</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>appToken</span><span class=o>,</span> <span class=n>String</span> <span class=n>appName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>hardwareAccelerated</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mWindowManager 就是 WindowManagerImpl 对象的实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mWindowManager</span> <span class=o>=</span> <span class=o>((</span><span class=n>WindowManagerImpl</span><span class=o>)</span><span class=n>wm</span><span class=o>).</span><span class=na>createLocalWindowManager</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>因此，Acitvity 中的 mWindow 变量就是 PhoneWindow 类的实例，而 mWindowManager 是 WindowManagerImpl 类的实例，attach() 方法的主要工作就是初始化这两个变量。</p><a href=#二初始化-decorview><h1 id=二初始化-decorview><span class=hanchor arialabel=Anchor># </span>二：初始化 DecorView</h1></a><a href=#源码分析><h2 id=源码分析><span class=hanchor arialabel=Anchor># </span>源码分析</h2></a><p>接下来到了 onCreate 方法，我们都知道，如果想要让自己设计的 layout 布局文件或者 View 显示在 Activity 中，必须要在 Activity 的 onCreate() 方法中应该调用 setContentView() 方法将我们的布局 id 或者 View 传递过去，查看其中一个 setContentView() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setContentView</span><span class=o>(</span><span class=nd>@LayoutRes</span> <span class=kt>int</span> <span class=n>layoutResID</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>getWindow</span><span class=o>().</span><span class=na>setContentView</span><span class=o>(</span><span class=n>layoutResID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>initWindowDecorActionBar</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>继续查看 PhoneWindow 类的 setContentView() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setContentView</span><span class=o>(</span><span class=kt>int</span> <span class=n>layoutResID</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mContentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span><span class=c1>// 是否首次调用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 初始化 Decor
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>installDecor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>hasFeature</span><span class=o>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=o>))</span> <span class=o>{</span><span class=c1>// 转场动画，默认 false
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mContentParent</span><span class=o>.</span><span class=na>removeAllViews</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>hasFeature</span><span class=o>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 解析布局文件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mLayoutInflater</span><span class=o>.</span><span class=na>inflate</span><span class=o>(</span><span class=n>layoutResID</span><span class=o>,</span> <span class=n>mContentParent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果是首次调用这个方法，则 mContentParent 为 null，否则如果没有转场动画的话就移除 mContentParent 的全部子 View，继续跟踪 installDecor() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>installDecor</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mForceDecorInstall</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mDecor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 生成 DecorView 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mDecor</span> <span class=o>=</span> <span class=n>generateDecor</span><span class=o>(-</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mDecor</span><span class=o>.</span><span class=na>setDescendantFocusability</span><span class=o>(</span><span class=n>ViewGroup</span><span class=o>.</span><span class=na>FOCUS_AFTER_DESCENDANTS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mDecor</span><span class=o>.</span><span class=na>setIsRootNamespace</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>mInvalidatePanelMenuPosted</span> <span class=o>&amp;&amp;</span> <span class=n>mInvalidatePanelMenuFeatures</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mDecor</span><span class=o>.</span><span class=na>postOnAnimation</span><span class=o>(</span><span class=n>mInvalidatePanelMenuRunnable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mDecor</span><span class=o>.</span><span class=na>setWindow</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mContentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 generateLayout 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mContentParent</span> <span class=o>=</span> <span class=n>generateLayout</span><span class=o>(</span><span class=n>mDecor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当 mDecor 为 null 的时候会调用 generateDecor() 方法创建一个 DecorView 类的实例，DecorView 继承自 FrameLayout。接下来判断 mContentParent 是否为 null（前面已经提到过，首次加载的时候就是 null），如果是则调用 generateLayout() 方法，这个方法就会创建 mContentParent 对象，跟踪进去：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=n>ViewGroup</span> <span class=nf>generateLayout</span><span class=o>(</span><span class=n>DecorView</span> <span class=n>decor</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>TypedArray</span> <span class=n>a</span> <span class=o>=</span> <span class=n>getWindowStyle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过 WindowStyle 中设置的各种属性对 Window 进行各种初始化操作
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mIsFloating</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=na>getBoolean</span><span class=o>(</span><span class=n>R</span><span class=o>.</span><span class=na>styleable</span><span class=o>.</span><span class=na>Window_windowIsFloating</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>flagsToUpdate</span> <span class=o>=</span> <span class=o>(</span><span class=n>FLAG_LAYOUT_IN_SCREEN</span><span class=o>|</span><span class=n>FLAG_LAYOUT_INSET_DECOR</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span> <span class=o>(~</span><span class=n>getForcedWindowFlags</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mIsFloating</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setLayout</span><span class=o>(</span><span class=n>WRAP_CONTENT</span><span class=o>,</span> <span class=n>WRAP_CONTENT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>setFlags</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>flagsToUpdate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setFlags</span><span class=o>(</span><span class=n>FLAG_LAYOUT_IN_SCREEN</span><span class=o>|</span><span class=n>FLAG_LAYOUT_INSET_DECOR</span><span class=o>,</span> <span class=n>flagsToUpdate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>....</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>layoutResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>features</span> <span class=o>=</span> <span class=n>getLocalFeatures</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 根据设定好的 features 值获取相应的布局文件并赋值给 layoutResource
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_SWIPE_TO_DISMISS</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_swipe_dismiss</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>((</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_LEFT_ICON</span><span class=o>)</span> <span class=o>|</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_RIGHT_ICON</span><span class=o>)))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mIsFloating</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>TypedValue</span> <span class=n>res</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TypedValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>getContext</span><span class=o>().</span><span class=na>getTheme</span><span class=o>().</span><span class=na>resolveAttribute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>attr</span><span class=o>.</span><span class=na>dialogTitleIconsDecorLayout</span><span class=o>,</span> <span class=n>res</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>res</span><span class=o>.</span><span class=na>resourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_title_icons</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>removeFeature</span><span class=o>(</span><span class=n>FEATURE_ACTION_BAR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>((</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_PROGRESS</span><span class=o>)</span> <span class=o>|</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_INDETERMINATE_PROGRESS</span><span class=o>)))</span> <span class=o>!=</span> <span class=n>0</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_ACTION_BAR</span><span class=o>))</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_progress</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_CUSTOM_TITLE</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mIsFloating</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>TypedValue</span> <span class=n>res</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TypedValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>getContext</span><span class=o>().</span><span class=na>getTheme</span><span class=o>().</span><span class=na>resolveAttribute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>attr</span><span class=o>.</span><span class=na>dialogCustomTitleDecorLayout</span><span class=o>,</span> <span class=n>res</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>res</span><span class=o>.</span><span class=na>resourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_custom_title</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>removeFeature</span><span class=o>(</span><span class=n>FEATURE_ACTION_BAR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_NO_TITLE</span><span class=o>))</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mIsFloating</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>TypedValue</span> <span class=n>res</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TypedValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>getContext</span><span class=o>().</span><span class=na>getTheme</span><span class=o>().</span><span class=na>resolveAttribute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>attr</span><span class=o>.</span><span class=na>dialogTitleDecorLayout</span><span class=o>,</span> <span class=n>res</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>res</span><span class=o>.</span><span class=na>resourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_ACTION_BAR</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=na>getResourceId</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>styleable</span><span class=o>.</span><span class=na>Window_windowActionBarFullscreenDecorLayout</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_action_bar</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_title</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_ACTION_MODE_OVERLAY</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_simple_overlay_action_mode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_simple</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mDecor</span><span class=o>.</span><span class=na>startChanging</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 onResourcesLoaded 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mDecor</span><span class=o>.</span><span class=na>onResourcesLoaded</span><span class=o>(</span><span class=n>mLayoutInflater</span><span class=o>,</span> <span class=n>layoutResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 在 layoutResource 中根据 id:com.android.internal.R.id.content 获取一个 ViewGroup 并赋值给 contentParent  对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ViewGroup</span> <span class=n>contentParent</span> <span class=o>=</span> <span class=o>(</span><span class=n>ViewGroup</span><span class=o>)</span><span class=n>findViewById</span><span class=o>(</span><span class=n>ID_ANDROID_CONTENT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>contentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Window couldn&#39;t find content container view&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>mDecor</span><span class=o>.</span><span class=na>finishChanging</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 返回 contentParent
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>contentParent</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DecorView 的 onResourcesLoaded() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>onResourcesLoaded</span><span class=o>(</span><span class=n>LayoutInflater</span> <span class=n>inflater</span><span class=o>,</span> <span class=kt>int</span> <span class=n>layoutResource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>mDecorCaptionView</span> <span class=o>=</span> <span class=n>createDecorCaptionView</span><span class=o>(</span><span class=n>inflater</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 解析 layoutResource 文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>View</span> <span class=n>root</span> <span class=o>=</span> <span class=n>inflater</span><span class=o>.</span><span class=na>inflate</span><span class=o>(</span><span class=n>layoutResource</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mDecorCaptionView</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 作为根布局添加到 mDecor 中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>addView</span><span class=o>(</span><span class=n>root</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=k>new</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>(</span><span class=n>MATCH_PARENT</span><span class=o>,</span> <span class=n>MATCH_PARENT</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mContentRoot</span> <span class=o>=</span> <span class=o>(</span><span class=n>ViewGroup</span><span class=o>)</span> <span class=n>root</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>initializeElevation</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，generateLayout() 方法主要分为四个部分：</p><ol><li>首先会通过 com.android.internal.R.styleable.Window 中设置的各种属性对 Window 进行各 requestFeature 或者 setFlags 等操作。</li><li>接下来是根据设定好的 features 值选择不同的窗口修饰布局文件，得到 layoutResource 值。</li></ol><blockquote><p>因此在自己的 Activity 中设置全屏的 requestFeature() 等方法也需要在 setContentView 之前调用，才能够根据你的设置来选择不同的根布局。</p></blockquote><ol start=3><li>将 layoutResource 值传给 DecorView 的 onResourcesLoaded() 方法，通过 LayoutInflater 把布局转化成 View 作为根视图并将其添加到 mDecor。</li><li>在 mDecor 中查找 id 为 com.android.internal.R.id.content 的 ViewGroup 并作为返回值返回，这个 ViewGroup 一般为 FrameLayout。</li></ol><p>关于第四点，可能有人会有疑问，为什么根据 id 为 com.android.internal.R.id.content 就一定能找到对应的 ViewGroup？答案就在前面我们分析过的 generateLayout() 方法中，这里会根据设定好的 features 值获取相应的布局文件并赋值给 layoutResource，而这所有的布局文件中都包括了一个 id 为 content 的 FrameLayout，除此之外有些布局文件中还可能有 ActiionBar 和 Title 等，这些布局文件存放于 [该目录下](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/res/res/layout/)。以 R.layout.screen_simple 为例，它的内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;LinearLayout</span> <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:fitsSystemWindows=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:orientation=</span><span class=s>&#34;vertical&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ViewStub</span> <span class=na>android:id=</span><span class=s>&#34;@+id/action_mode_bar_stub&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:inflatedId=</span><span class=s>&#34;@+id/action_mode_bar&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:layout=</span><span class=s>&#34;@layout/action_mode_bar&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:theme=</span><span class=s>&#34;?attr/actionBarTheme&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;FrameLayout</span>
</span></span><span class=line><span class=cl>         <span class=na>android:id=</span><span class=s>&#34;@android:id/content&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:foregroundInsidePadding=</span><span class=s>&#34;false&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:foregroundGravity=</span><span class=s>&#34;fill_horizontal|top&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:foreground=</span><span class=s>&#34;?android:attr/windowContentOverlay&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/LinearLayout&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>回到 PhoneWindow 的 setContentView() 方法，执行完 installDecor() 之后，mDecor 被初始化了，同时 mContentParent 也被赋了值， 回到 setContentView() 方法，最后一个重要步骤就是通过 mLayoutInflater.inflater 将我们的 layout 布局文件压入 mDecor 中 id 为 content 的 FrameLayout 中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setContentView</span><span class=o>(</span><span class=kt>int</span> <span class=n>layoutResID</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mContentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span><span class=c1>// 是否首次调用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 初始化 Decor
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>installDecor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>hasFeature</span><span class=o>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=o>))</span> <span class=o>{</span><span class=c1>// 转场动画，默认 false
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mContentParent</span><span class=o>.</span><span class=na>removeAllViews</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>hasFeature</span><span class=o>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 解析布局文件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mLayoutInflater</span><span class=o>.</span><span class=na>inflate</span><span class=o>(</span><span class=n>layoutResID</span><span class=o>,</span> <span class=n>mContentParent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#小结><h2 id=小结><span class=hanchor arialabel=Anchor># </span>小结</h2></a><p>至此，setContentView() 方法的流程就走完了，总体来看分为三个步骤：</p><ol><li>初始化 mDecor，它是 DecorView 类的实例，DecorView 继承自 FrameLayout；</li><li>根据 theme 中的属性值，选择相应的布局文件并通过 infalter.inflater() 方法将它加载出来并 add 到 mDecor 中；这些布局文件都有一个 id 为 content 的 FrameLayout；</li><li>在 Activity 的 setContentView() 方法中设置的 layout 布局文件，会通过 mLayoutInflater.inflater() 压入 mDecor 中 id 为 content 的 FrameLayout 中。</li></ol><p>这个过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045625.png width=auto alt></p><p>Activity、PhoneWindow、DecorView 和 ContentView 的关系如下图所示：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045628.png width=auto alt></p><p>但是，此时我们的布局还没有显示出来，接着往下看。</p><a href=#三初始化-viewrootimpl-并关联-decorview><h1 id=三初始化-viewrootimpl-并关联-decorview><span class=hanchor arialabel=Anchor># </span>三：初始化 ViewRootImpl 并关联 DecorView</h1></a><a href=#源码分析-1><h2 id=源码分析-1><span class=hanchor arialabel=Anchor># </span>源码分析</h2></a><p>在开篇的时序图中我们可以看到，ActivityThread 在 handleLaunchActivity() 方法中的 performLaunchActivity() 操作间接调用了 Activity 的 attach() 和 onCreate()：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleLaunchActivity</span><span class=o>(</span><span class=n>ActivityClientRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>customIntent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>WindowManagerGlobal</span><span class=o>.</span><span class=na>initialize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行 performLaunchActivity 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Activity</span> <span class=n>a</span> <span class=o>=</span> <span class=n>performLaunchActivity</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>customIntent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=na>createdConfig</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>mConfiguration</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Bundle</span> <span class=n>oldState</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 执行 handleResumeActivity 方法，最终调用 onStart 和 onResume 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>handleResumeActivity</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>isForward</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>startsNotResumed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>startsNotResumed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mCalled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callActivityOnPause</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>paused</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 停止该 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>finishActivity</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>接着会调用 handleResumeActivity() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>handleResumeActivity</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>clearHide</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isForward</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>reallyResume</span><span class=o>,</span> <span class=kt>int</span> <span class=n>seq</span><span class=o>,</span> <span class=n>String</span> <span class=n>reason</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ActivityClientRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=n>mActivities</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>token</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 最终会调用 onStart() 和 onResume() 等方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>r</span> <span class=o>=</span> <span class=n>performResumeActivity</span><span class=o>(</span><span class=n>token</span><span class=o>,</span> <span class=n>clearHide</span><span class=o>,</span> <span class=n>reason</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>r</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Activity</span> <span class=n>a</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>window</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>a</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>willBeVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>window</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>getWindow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取 DecorView 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>View</span> <span class=n>decor</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>window</span><span class=o>.</span><span class=na>getDecorView</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将 DecorView 设置成不可见
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>decor</span><span class=o>.</span><span class=na>setVisibility</span><span class=o>(</span><span class=n>View</span><span class=o>.</span><span class=na>INVISIBLE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取 ViewManager，这里是 WindowManagerImpl 实例
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ViewManager</span> <span class=n>wm</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=na>getWindowManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>l</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>window</span><span class=o>.</span><span class=na>getAttributes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span><span class=o>.</span><span class=na>mDecor</span> <span class=o>=</span> <span class=n>decor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>l</span><span class=o>.</span><span class=na>type</span> <span class=o>=</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>TYPE_BASE_APPLICATION</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>l</span><span class=o>.</span><span class=na>softInputMode</span> <span class=o>|=</span> <span class=n>forwardBit</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>a</span><span class=o>.</span><span class=na>mVisibleFromClient</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>a</span><span class=o>.</span><span class=na>mWindowAdded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 标记设置为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>a</span><span class=o>.</span><span class=na>mWindowAdded</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 调用 WindowManagerImpl 的 addView 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>wm</span><span class=o>.</span><span class=na>addView</span><span class=o>(</span><span class=n>decor</span><span class=o>,</span> <span class=n>l</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> 
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>willBeVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>willBeVisible</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mDecor</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>hideForNow</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mVisibleFromClient</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 调用 makeVisible 方法将 DecorView 设置为可见
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>makeVisible</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 在此过程出现异常，则直接杀死 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>finishActivity</span><span class=o>(</span><span class=n>token</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>Activity</span><span class=o>.</span><span class=na>DONT_FINISH_TASK_WITH_ACTIVITY</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>ex</span><span class=o>.</span><span class=na>rethrowFromSystemServer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行完 performResumeActivity() 方法之后，接着会取出 ActivityClientRecord 中的 Activity 对象，并得到之前在 setContentView 流程中初始化好的 DecorView 对象，然后会将它作为参数传入 ViewManager 类型的对象 wm 的 addView 方法，ViewManager 是一个接口，那么它是由谁来实现的呢？</p><p>其实这就是文章开头部分提到过的，在 Activity 的 attach() 方法中，会初始化 PhoneWindow 和 WindowManager 对象，而这个 WindowManager 对象则是由 WindowManagerImpl 来实现的。</p><p>所以，Activity 的 getWindowManager() 此时获取到的就是 WindowManagerImpl 对象的实例，再看它的 addView() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>addView</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>applyDefaultToken</span><span class=o>(</span><span class=n>params</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mGlobal 是 WindowManagerGlobal 对象的实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mGlobal</span><span class=o>.</span><span class=na>addView</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>params</span><span class=o>,</span> <span class=n>mContext</span><span class=o>.</span><span class=na>getDisplay</span><span class=o>(),</span> <span class=n>mParentWindow</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里将任务委托给了 mGlobal ，而它又是 WindowManagerGlobal 对象的实例，查看它的 addView() 方法：</p><p><a href=https://android.googlesource.com/platform/frameworks/base/+/refs/heads/nougat-release/core/java/android/view/WindowManagerGlobal.java rel=noopener>core/java/android/view/WindowManagerGlobal.java</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>addView</span><span class=o>(</span><span class=n>View</span> <span class=n>view</span><span class=o>,</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Display</span> <span class=n>display</span><span class=o>,</span> <span class=n>Window</span> <span class=n>parentWindow</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>wparams</span> <span class=o>=</span> <span class=o>(</span><span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>)</span> <span class=n>params</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>parentWindow</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>parentWindow</span><span class=o>.</span><span class=na>adjustLayoutParamsForSubWindow</span><span class=o>(</span><span class=n>wparams</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If there&#39;s no parent, then hardware acceleration for this view is
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// set from the application&#39;s hardware acceleration setting.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>final</span> <span class=n>Context</span> <span class=n>context</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationInfo</span><span class=o>().</span><span class=na>flags</span>
</span></span><span class=line><span class=cl>                    <span class=o>&amp;</span> <span class=n>ApplicationInfo</span><span class=o>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>wparams</span><span class=o>.</span><span class=na>flags</span> <span class=o>|=</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=n>ViewRootImpl</span> <span class=n>root</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>View</span> <span class=n>panelParentView</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>mLock</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建 ViewRootImpl
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>root</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ViewRootImpl</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>(),</span> <span class=n>display</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>view</span><span class=o>.</span><span class=na>setLayoutParams</span><span class=o>(</span><span class=n>wparams</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mViews</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mRoots</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>root</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mParams</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>wparams</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将传过来的 DecorView 添加到 ViewRootImpl 中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>root</span><span class=o>.</span><span class=na>setView</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>wparams</span><span class=o>,</span> <span class=n>panelParentView</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的变量中，mViews 存储的是所有 Window 对应的 View，mRoots 存储的是所有 Window 对应的 ViewRootImpl 对象，mParams 存储的是所有 Window 对应的布局参数。</p><a href=#小结-1><h2 id=小结-1><span class=hanchor arialabel=Anchor># </span>小结</h2></a><p>可以看到，ViewRootImpl 是 DecorView 的管理者，它负责 View Tree 的测量、布局和绘制，以及后面会说到的通过 Choreographer 来控制 View Tree 的刷新操作。</p><a href=#四建立-phonewindow-和-windowmanagerservice-之间的连接><h1 id=四建立-phonewindow-和-windowmanagerservice-之间的连接><span class=hanchor arialabel=Anchor># </span>四：建立 PhoneWindow 和 WindowManagerService 之间的连接</h1></a><p>WMS 是所有 Window 窗口的管理员，负责 Window 的添加和删除、Surface 的管理和事件的派发等等，因此每一个 Activity 中的 PhoneWindow 对象如果需要显示等操作，就必须通过与 WMS 的交互才能进行。</p><a href=#源码分析-2><h2 id=源码分析-2><span class=hanchor arialabel=Anchor># </span>源码分析</h2></a><p>接着上一个步骤的流程，查看 ViewRootImpl 的 setView 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setView</span><span class=o>(</span><span class=n>View</span> <span class=n>view</span><span class=o>,</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>attrs</span><span class=o>,</span> <span class=n>View</span> <span class=n>panelParentView</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mView</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mView</span> <span class=o>=</span> <span class=n>view</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>requestLayout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=o>...</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>res</span> <span class=o>=</span> <span class=n>mWindowSession</span><span class=o>.</span><span class=na>addToDisplay</span><span class=o>(</span><span class=n>mWindow</span><span class=o>,</span> <span class=n>mSeq</span><span class=o>,</span> <span class=n>mWindowAttributes</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>getHostVisibility</span><span class=o>(),</span> <span class=n>mDisplay</span><span class=o>.</span><span class=na>getDisplayId</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                      <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mContentInsets</span><span class=o>,</span> <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mStableInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mOutsets</span><span class=o>,</span> <span class=n>mInputChannel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>restore</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>attrs</span><span class=o>.</span><span class=na>restore</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=n>view</span><span class=o>.</span><span class=na>assignParent</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>忽略 requestLayout 方法，先看注释 2 处：这里调用了 mWindowSession.addToDisplay() 方法来完成最终的添加流程，mWindowSession 为 IWindowSession 的实例，而 IWindowSession 是一个 Binder 的 Client 代理对象，对应的 Server 端的实现为 Session 类。在这之前代码都是运行在 app 进程的，而 Session 则是运行在 WMS 所在的进程（即 SystemServer 进程）中。</p><p>如此，往 Window 中添加 View 的流程就交给 WindowManagerService 去处理了，app 进程的 ViewRootImpl 要想和 WMS 通讯则需要借助 Binder 机制并通过 Session 来进行操作。Session 的 addToDisplay() 方法如下：</p><p>[services/core/java/com/android/server/wm/Session.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /refs/heads/nougat-release/services/core/java/com/android/server/wm/Session.java)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>int</span> <span class=nf>addToDisplay</span><span class=o>(</span><span class=n>IWindow</span> <span class=n>window</span><span class=o>,</span> <span class=kt>int</span> <span class=n>seq</span><span class=o>,</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>attrs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=kt>int</span> <span class=n>displayId</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outContentInsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outStableInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Rect</span> <span class=n>outOutsets</span><span class=o>,</span> <span class=n>InputChannel</span> <span class=n>outInputChannel</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mService</span><span class=o>.</span><span class=na>addWindow</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>window</span><span class=o>,</span> <span class=n>seq</span><span class=o>,</span> <span class=n>attrs</span><span class=o>,</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=n>displayId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>outContentInsets</span><span class=o>,</span> <span class=n>outStableInsets</span><span class=o>,</span> <span class=n>outOutsets</span><span class=o>,</span> <span class=n>outInputChannel</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里调用了 WMS 的 addWindow() 方法并将自身作为参数传了进去，每个应用程序都会对应一个 Session，WMS 会用一个 List 来保存这些 Session。接着 WMS 会为这个添加的窗口分配 Surface，并确定窗口显示次序，因此负责显示界面的是画布 Surface，而不是窗口本身。WMS 会将它管理的 Surface 交由 SurfaceFlinger 处理，SurfaceFlinger 会将这些 Surface 混合并绘制到屏幕上。</p><p>关于 WMS 的详细分析会在后续的文章中进行。</p><p>这个是一个典型的 Binder 双向通讯模型，Binder 机制的文章可参考
<a href=https://www.jianshu.com/p/73e351d25773 rel=noopener>借助 AIDL 理解 Android Binder 机制</a>。这个过程如下图所示：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045637.png width=auto alt></p><a href=#小结-2><h2 id=小结-2><span class=hanchor arialabel=Anchor># </span>小结</h2></a><p>用一张图总结 Activity、Window 和 WMS 之间的关系：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045640.png width=auto alt></p><a href=#五建立与-surfaceflinger-的连接><h1 id=五建立与-surfaceflinger-的连接><span class=hanchor arialabel=Anchor># </span>五：建立与 SurfaceFlinger 的连接</h1></a><p>SurfaceFlinger 是 Android 最重要的系统服务之一，它的职责主要是进行 Layer(Surface 在 Native 叫法) 的合成和渲染。</p><a href=#源码分析-3><h2 id=源码分析-3><span class=hanchor arialabel=Anchor># </span>源码分析</h2></a><p>接上面的步骤，WindowState 的 attach() 方法将会调用到 Session 的 windowAddedLocked() 方法：</p><p>[services/core/java/com/android/server/wm/WindowState.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /refs/heads/nougat-release/services/core/java/com/android/server/wm/WindowState.java)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>attach</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>WindowManagerService</span><span class=o>.</span><span class=na>localLOGV</span><span class=o>)</span> <span class=n>Slog</span><span class=o>.</span><span class=na>v</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Attaching &#34;</span> <span class=o>+</span> <span class=k>this</span> <span class=o>+</span> <span class=s>&#34; token=&#34;</span> <span class=o>+</span> <span class=n>mToken</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=s>&#34;, list=&#34;</span> <span class=o>+</span> <span class=n>mToken</span><span class=o>.</span><span class=na>windows</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mSession</span><span class=o>.</span><span class=na>windowAddedLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Session.java</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>windowAddedLocked</span><span class=o>(</span><span class=n>String</span> <span class=n>packageName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mSurfaceSession</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span> 
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>mSurfaceSession</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SurfaceSession</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>SurfaceSession</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mNativeClient</span><span class=o>;</span> <span class=c1>// SurfaceComposerClient*
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>native</span> <span class=kt>long</span> <span class=nf>nativeCreate</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SurfaceSession</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mNativeClient</span> <span class=o>=</span> <span class=n>nativeCreate</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>nativeCreate() 方法是一个 native 方法：</p><p>[core/jni/android_view_SurfaceSession.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /refs/heads/nougat-release/core/jni/android_view_SurfaceSession.cpp)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>static</span> <span class=n>jlong</span> <span class=nf>nativeCreate</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>,</span> <span class=n>jclass</span> <span class=n>clazz</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SurfaceComposerClient</span><span class=o>*</span> <span class=n>client</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SurfaceComposerClient</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>-&gt;</span><span class=n>incStrong</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>nativeCreate</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>jlong</span><span class=o>&gt;</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>nativeCreate 方法主要构造了一个 SurfaceComposerClient 对象，它是应用程序与 SurfaceFlinger 沟通的桥梁，SurfaceComposerClient 指针在第一次使用的时候会调用以下方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=n>SurfaceComposerClient</span><span class=o>::</span><span class=n>onFirstRef</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>....</span>
</span></span><span class=line><span class=cl>    <span class=n>sp</span><span class=o>&lt;</span><span class=n>ISurfaceComposerClient</span><span class=o>&gt;</span> <span class=n>conn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// sf 就是 SurfaceFlinger 对象指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>conn</span> <span class=o>=</span> <span class=p>(</span><span class=n>rootProducer</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>)</span> <span class=o>?</span> <span class=n>sf</span><span class=o>-&gt;</span><span class=n>createScopedConnection</span><span class=p>(</span><span class=n>rootProducer</span><span class=p>)</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sf</span><span class=o>-&gt;</span><span class=n>createConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>它通过 SurfaceFlinger 的 createScopedConnection 方法创建了一个 ISurfaceComposerClient 对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>SurfaceFlinger</span><span class=p>.</span><span class=n>cpp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sp</span><span class=o>&lt;</span><span class=n>ISurfaceComposerClient</span><span class=o>&gt;</span> <span class=n>SurfaceFlinger</span><span class=o>::</span><span class=n>createConnection</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>initClient</span><span class=p>(</span><span class=k>new</span> <span class=n>Client</span><span class=p>(</span><span class=k>this</span><span class=p>));</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>ISurfaceComposerClient</span><span class=o>&gt;</span> <span class=n>initClient</span><span class=p>(</span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>Client</span><span class=o>&gt;&amp;</span> <span class=n>client</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>status_t</span> <span class=n>err</span> <span class=o>=</span> <span class=n>client</span><span class=o>-&gt;</span><span class=n>initCheck</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 只是做了错误检查，然后返回 client 本身
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>==</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>client</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Client 类实现了 ISurfaceComposerClient(继承了 IInterface) 接口，因此它可以进行跨进程通信，SurfaceComposerClient 就是通过它来和 SurfaceFlinger 通信。除此之外它还可以创建 Surface，并且维护一个应用程序的所有 Layer。</p><p>initClicent 方法做了一些错误检查，然后返回 Client 本身。</p><a href=#小结-3><h2 id=小结-3><span class=hanchor arialabel=Anchor># </span>小结</h2></a><p>这个过程如下图：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045645.png width=auto alt></p><a href=#六申请-surface><h1 id=六申请-surface><span class=hanchor arialabel=Anchor># </span>六：申请 Surface</h1></a><p>经过步骤四和步骤五，ViewRootImpl 与 WMS、SurfaceFlinger 都已经建立连接，但是这时 View 还是没有显示出来。我们都知道，所有的 UI 最终都是要通过 Surface 来显示的，那么 Surface 是什么时候创建的呢？回到步骤四开头部分 ViewRootImpl 的 setView 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setView</span><span class=o>(</span><span class=n>View</span> <span class=n>view</span><span class=o>,</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>attrs</span><span class=o>,</span> <span class=n>View</span> <span class=n>panelParentView</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mView</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mView</span> <span class=o>=</span> <span class=n>view</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Schedule the first layout -before- adding to the window
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// manager, to make sure we do the relayout before receiving
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// any other events from the system.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>requestLayout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=o>...</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span> <span class=o>=</span> <span class=n>mWindowSession</span><span class=o>.</span><span class=na>addToDisplay</span><span class=o>(</span><span class=n>mWindow</span><span class=o>,</span> <span class=n>mSeq</span><span class=o>,</span> <span class=n>mWindowAttributes</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>getHostVisibility</span><span class=o>(),</span> <span class=n>mDisplay</span><span class=o>.</span><span class=na>getDisplayId</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                        <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mContentInsets</span><span class=o>,</span> <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mStableInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mOutsets</span><span class=o>,</span> <span class=n>mInputChannel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> 
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注释处保留了官方原文，意思大概是 WMS 除了窗口管理，还需要处理事件派发，因此在与 WMS 进行关联之前，要确保 View Tree 已经进行了 layout 操作，以接收来自 WMS 的事件。</p><p>跟踪 ViewRootImpl 的 requestLayout() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>requestLayout</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>mHandlingLayoutInLayoutRequest</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>checkThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>mLayoutRequested</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>scheduleTraversals</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>scheduleTraversals() 方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>scheduleTraversals</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>mTraversalScheduled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mTraversalScheduled</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置同步障碍，暂停处理后面的同步消息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mTraversalBarrier</span> <span class=o>=</span> <span class=n>mHandler</span><span class=o>.</span><span class=na>getLooper</span><span class=o>().</span><span class=na>getQueue</span><span class=o>().</span><span class=na>postSyncBarrier</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 在下一帧到来的时候执行 mTraversalRunnable
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mChoreographer</span><span class=o>.</span><span class=na>postCallback</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>Choreographer</span><span class=o>.</span><span class=na>CALLBACK_TRAVERSAL</span><span class=o>,</span> <span class=n>mTraversalRunnable</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，设置同步障碍，暂停处理后面的同步消息，然后利用 Choreographer 类在下一绘制帧来临的时候执行 mTraversalRunnable 对象（关于 Choreographer 原理，可查看
<a href=https://blog.csdn.net/yangwen123/article/details/39518923 rel=noopener>Android 系统 Choreographer 机制实现过程</a>）。</p><p>简单地说，Choreographer 内部会接收来自 SurfaceFlinger 发出的 VSync 垂直同步信号，这个信号周期一般为 16ms 左右。SurfaceFlinger 是由 init 进程启动的运行在底层的一个系统进程，它的主要职责是合成和渲染 Surface(Layer)，并向目标进程发送垂直同步信号 VSync。因此，如果需要接收 Vsync 信号，必须先与 SurfaceFlinger 建立连接，而这正是先走步骤五流程的原因。</p><p>mTraversalRunnable 是一个 Runnable 对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kd>class</span> <span class=nc>TraversalRunnable</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>doTraversal</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=n>TraversalRunnable</span> <span class=n>mTraversalRunnable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TraversalRunnable</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>run() 方法里面只有一句代码，doTraversal() 方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>doTraversal</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mTraversalScheduled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mTraversalScheduled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 移除同步障碍
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mHandler</span><span class=o>.</span><span class=na>getLooper</span><span class=o>().</span><span class=na>getQueue</span><span class=o>().</span><span class=na>removeSyncBarrier</span><span class=o>(</span><span class=n>mTraversalBarrier</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 正式进入 View 绘制流程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>performTraversals</span><span class=o>();</span>
</span></span><span class=line><span class=cl>         <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>移除了同步障碍之后，所有绘制之前的准备工作已经执行完毕，接下来会调用 performTraversals() 方法正式进入 View 的绘制流程。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performTraversals</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>finalView</span> <span class=n>host</span> <span class=o>=</span> <span class=n>mView</span><span class=o>;</span> <span class=c1>// mView 其实就是 DecorView
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>relayoutWindow</span><span class=o>(</span><span class=n>params</span><span class=o>,</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=n>insetsPending</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行 Measure 流程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performMeasure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行 Layout 流程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performLayout</span><span class=o>(</span><span class=n>lp</span><span class=o>,</span> <span class=n>desiredWindowWidth</span><span class=o>,</span> <span class=n>desiredWindowHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行 Draw 流程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performLayout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>跟踪 relayoutWindow 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>relayoutWindow</span><span class=o>(</span><span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=o>,</span> <span class=kt>int</span> <span class=n>viewVisibility</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>insetsPending</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>relayoutResult</span> <span class=o>=</span> <span class=n>mWindowSession</span><span class=o>.</span><span class=na>relayout</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>mWindow</span><span class=o>,</span> <span class=n>mSeq</span><span class=o>,</span> <span class=n>params</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>mView</span><span class=o>.</span><span class=na>getMeasuredWidth</span><span class=o>()</span> <span class=o>*</span> <span class=n>appScale</span> <span class=o>+</span> <span class=n>0</span><span class=o>.</span><span class=na>5f</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>mView</span><span class=o>.</span><span class=na>getMeasuredHeight</span><span class=o>()</span> <span class=o>*</span> <span class=n>appScale</span> <span class=o>+</span> <span class=n>0</span><span class=o>.</span><span class=na>5f</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>viewVisibility</span><span class=o>,</span> <span class=n>insetsPending</span> <span class=o>?</span> <span class=n>WindowManagerGlobal</span><span class=o>.</span><span class=na>RELAYOUT_INSETS_PENDING</span> <span class=o>:</span> <span class=n>0</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mWinFrame</span><span class=o>,</span> <span class=n>mPendingOverscanInsets</span><span class=o>,</span> <span class=n>mPendingContentInsets</span><span class=o>,</span> <span class=n>mPendingVisibleInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPendingStableInsets</span><span class=o>,</span> <span class=n>mPendingOutsets</span><span class=o>,</span> <span class=n>mPendingBackDropFrame</span><span class=o>,</span> <span class=n>mPendingConfiguration</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mSurface</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里又是 Binder 调用（强烈建议掌握），它将调用到 WMS 的 relayout 方法，注意最后一个参数就是 SurfaceView 对象，它在 ViewRootImpl 中定义的时候就已经进行了初始化：</p><p>final Surface mSurface = new Surface();</p><p>再来看 WMS 的 relayoutWindow：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>int</span> <span class=nf>relayoutWindow</span><span class=o>(</span><span class=n>Session</span> <span class=n>session</span><span class=o>,</span> <span class=n>IWindow</span> <span class=n>client</span><span class=o>,</span> <span class=kt>int</span> <span class=n>seq</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>attrs</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestedWidth</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>requestedHeight</span><span class=o>,</span> <span class=kt>int</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Rect</span> <span class=n>outFrame</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outOverscanInsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outContentInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Rect</span> <span class=n>outVisibleInsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outStableInsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outOutsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outBackdropFrame</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Configuration</span> <span class=n>outConfig</span><span class=o>,</span> <span class=n>Surface</span> <span class=n>outSurface</span><span class=o>){</span> 
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>createSurfaceControl</span><span class=o>(</span><span class=n>outSurface</span><span class=o>,</span> <span class=n>result</span><span class=o>,</span> <span class=n>win</span><span class=o>,</span> <span class=n>winAnimator</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>createSurfaceControl</span><span class=o>(</span><span class=n>Surface</span> <span class=n>outSurface</span><span class=o>,</span> <span class=kt>int</span> <span class=n>result</span><span class=o>,</span> <span class=n>WindowState</span> <span class=n>win</span><span class=o>,</span><span class=n>WindowStateAnimator</span> <span class=n>winAnimator</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>surfaceController</span> <span class=o>=</span> <span class=n>winAnimator</span><span class=o>.</span><span class=na>createSurfaceLocked</span><span class=o>(</span><span class=n>win</span><span class=o>.</span><span class=na>mAttrs</span><span class=o>.</span><span class=na>type</span><span class=o>,</span> <span class=n>win</span><span class=o>.</span><span class=na>mOwnerUid</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>surfaceController</span><span class=o>.</span><span class=na>getSurface</span><span class=o>(</span><span class=n>outSurface</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里首先调用 WindowStateAnimator 的 createSurfaceLocked 生成一个真正有效的 Surface 对象，这个对象是在 Native 层的，接着 getSurface 方法将 Java 层的 Surface 对象与其关联起来。</p><a href=#七正式绘制-view><h1 id=七正式绘制-view><span class=hanchor arialabel=Anchor># </span>七：正式绘制 View</h1></a><p>接上一步骤的内容，申请了 Surface 之后，ViewRootImpl 的 performTraversals() 方法将会继续执行，这个方法内容相当多，忽略条件判断，精简过后如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performTraversals</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>relayoutResult</span> <span class=o>=</span> <span class=n>relayoutWindow</span><span class=o>(</span><span class=n>params</span><span class=o>,</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=n>insetsPending</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>lp</span> <span class=o>=</span> <span class=n>mWindowAttributes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取 DecorView 宽和高的 MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>childWidthMeasureSpec</span> <span class=o>=</span> <span class=n>getRootMeasureSpec</span><span class=o>(</span><span class=n>mWidth</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>width</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>childHeightMeasureSpec</span> <span class=o>=</span> <span class=n>getRootMeasureSpec</span><span class=o>(</span><span class=n>mHeight</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行 Measure 流程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performMeasure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行 Layout 流程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performLayout</span><span class=o>(</span><span class=n>lp</span><span class=o>,</span> <span class=n>desiredWindowWidth</span><span class=o>,</span> <span class=n>desiredWindowHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行 Draw 流程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performLayout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，根据 getRootMeasureSpec() 方法获取到 childWidthMeasureSpec 和 childHeightMeasureSpec 的值，用于 DecorView 的绘制。因为 DecorView 是所有子元素的根元素，子元素的布局层层嵌套，因此会接着从 DecorView 开始进行一层层地对所有子元素进行测量、布局和绘制，分别对应 performMeasure()、performLayout() 和 performLayout() 方法，整个过程的示意图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045652.png width=auto alt></p><a href=#理解-measurespec><h2 id=理解-measurespec><span class=hanchor arialabel=Anchor># </span>理解 MeasureSpec</h2></a><p>MeasureSpec 是 View 的一个内部类，简单来说就是一个 32 位的 int 值，采用它的高 2 位表示三种 SpecMode（测量模式），低 30 位用来表示 SpecSize（某种测量模式下的规格大小）。采用这种表示方法是为了避免创建过多的对象以减少内存分配，MeasureSpec 的定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MeasureSpec</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MODE_SHIFT</span> <span class=o>=</span> <span class=n>30</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MODE_MASK</span> <span class=o>=</span> <span class=n>0x3</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 不限定测量模式：父容器不对 View 作任何限制，View 想要多大给多大，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 这种模式通常用于系统内部。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>UNSPECIFIED</span> <span class=o>=</span> <span class=n>0</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 精确为 SpecSize：父容器已经确定 View 需要的大小，就是 SpecSize，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 对应布局参数是 match_parent 或具体数值时的情况
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>EXACTLY</span> <span class=o>=</span> <span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 最大只能是 SpecSize：父容器规定 View 最大只能是 SpecSize，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 对应布局参数是 wrap_content 时的情况
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>AT_MOST</span> <span class=o>=</span> <span class=n>2</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 根据 SpecMode 和 SpecSize 创建一个 MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>makeMeasureSpec</span><span class=o>(</span><span class=kt>int</span> <span class=n>size</span><span class=o>,</span> <span class=kt>int</span> <span class=n>mode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>sUseBrokenMakeMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>size</span> <span class=o>+</span> <span class=n>mode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>(</span><span class=n>size</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MODE_MASK</span><span class=o>)</span> <span class=o>|</span> <span class=o>(</span><span class=n>mode</span> <span class=o>&amp;</span> <span class=n>MODE_MASK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 获取 SpecMode
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getMode</span><span class=o>(</span><span class=kt>int</span> <span class=n>measureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>measureSpec</span> <span class=o>&amp;</span> <span class=n>MODE_MASK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取 SpecSize
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=o>(</span><span class=kt>int</span> <span class=n>measureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>measureSpec</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MODE_MASK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 调整 MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kt>int</span> <span class=nf>adjust</span><span class=o>(</span><span class=kt>int</span> <span class=n>measureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>delta</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>mode</span> <span class=o>=</span> <span class=n>getMode</span><span class=o>(</span><span class=n>measureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mode</span> <span class=o>==</span> <span class=n>UNSPECIFIED</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>make</span> <span class=nf>MeasureSpec</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>UNSPECIFIED</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>getSize</span><span class=o>(</span><span class=n>measureSpec</span><span class=o>)</span> <span class=o>+</span> <span class=n>delta</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>size</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>size</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>makeMeasureSpec</span><span class=o>(</span><span class=n>size</span><span class=o>,</span> <span class=n>mode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>接着看 getRootMeasureSpec() 方法，传入的第一个参数是整个屏幕的宽或者高，第二个参数是 Window 的 LayoutParams：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getRootMeasureSpec</span><span class=o>(</span><span class=kt>int</span> <span class=n>windowSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>rootDimension</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>measureSpec</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>rootDimension</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>MATCH_PARENT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>measureSpec</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>makeMeasureSpec</span><span class=o>(</span><span class=n>windowSize</span><span class=o>,</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>measureSpec</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>makeMeasureSpec</span><span class=o>(</span><span class=n>windowSize</span><span class=o>,</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>measureSpec</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>makeMeasureSpec</span><span class=o>(</span><span class=n>rootDimension</span><span class=o>,</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>measureSpec</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从代码逻辑来看，DecorView 的 MeasureSpec 的产生遵循如下规律：</p><ul><li>LayoutParams = MATCH_PARENT：精确模式，大小就是屏幕的宽或者高；</li><li>LayoutParams = WRAP_CONTENT：最大不能超过屏幕的宽或者高；</li><li>固定大小：精确模式，大小为 LayoutParams 中指定的值。</li></ul><p>但是对于普通的 View 来说，View 的 measure() 方法是由父容器 ViewGroup 调用的，看一下 ViewGroup 的 measureChildWithMargins() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>measureChildWithMargins</span><span class=o>(</span><span class=n>View</span> <span class=n>child</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>parentWidthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>widthUsed</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>parentHeightMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightUsed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取子元素的布局参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>MarginLayoutParams</span> <span class=n>lp</span> <span class=o>=</span> <span class=o>(</span><span class=n>MarginLayoutParams</span><span class=o>)</span> <span class=n>child</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 产生子元素的 MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childWidthMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=o>(</span><span class=n>parentWidthMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPaddingLeft</span> <span class=o>+</span> <span class=n>mPaddingRight</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>leftMargin</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>rightMargin</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>widthUsed</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>width</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childHeightMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=o>(</span><span class=n>parentHeightMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPaddingTop</span> <span class=o>+</span> <span class=n>mPaddingBottom</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>bottomMargin</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>heightUsed</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>child</span><span class=o>.</span><span class=na>measure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，在调用子元素 的 measure() 方法之前，先要调用 getChildMeasureSpec() 方法产生子元素的 MeasureSpec，子元素的产生除了跟父容器的 MeasureSpec 和子元素本身的 LayoutParams 有关之外，还与子元素的 Margin 和父容器的 Padding 值以及父容器当前占用空间有关，具体的过程可以看 getChildMeasureSpec() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getChildMeasureSpec</span><span class=o>(</span><span class=kt>int</span> <span class=n>spec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>padding</span><span class=o>,</span> <span class=kt>int</span> <span class=n>childDimesion</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>specMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getMode</span><span class=o>(</span><span class=n>spec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>specSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>spec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 子元素最大可用空间为父容器的尺寸减去父容器中已被占用的空间的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>specSize</span> <span class=o>-</span> <span class=n>padding</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>resultSize</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>resultMode</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>sepcMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Parent has imposed an exact size on us
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>childDimension</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>MATCH_PARENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to be our size. So be it.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimesion</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to determine its own size. It can&#39;t be
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// bigger than us.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Parent has imposed a maximum size on us 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants a specific size... so be it
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>childDimension</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>MATCH_PARENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to be our size, but our size is not fixed.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// Constrain child to not be bigger than us.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to determine its own size. It can&#39;t be
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// bigger than us.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Parent asked to see how big we want to be
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>UNSPECIFIED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants a specific size... let him have it
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>childDimension</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>MATCH_PARENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to be our size... find out how big it should be
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>UNSPECIFIED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to determine its own size....
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// find out how big it should be
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>==</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>UNSPECIFIED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>makeMeasureSpec</span><span class=o>(</span><span class=n>resultSize</span><span class=o>,</span> <span class=n>resultMode</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>整个过程稍微有点复杂，可以参考以下表格：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045658.png width=auto alt></p><a href=#measure-流程分析><h2 id=measure-流程分析><span class=hanchor arialabel=Anchor># </span>Measure 流程分析</h2></a><p>回到 performTraversals() 方法中，获取到 DecorView 的 MeasureSpec 后接着会调用 performMeasure() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>childHeightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>mView</span><span class=o>.</span><span class=na>measure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>mView 就是之前通过 setView() 方法传递过来的 DecorView 实例，它继承自 FrameLayout，而 FrameLayout 又是一个 ViewGroup 同时继承自 View。View 的 measure() 方法是 final 类型的，不允许子类去重写，因此这里调用的实际上是 View 的 measure 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>measure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>onMeasure</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>View 的 onMeasure() 实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>getDefaultSize</span><span class=o>(</span><span class=n>getSuggestedMinimumWidth</span><span class=o>(),</span> <span class=n>widthMeasureSpec</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>getDefaultSize</span><span class=o>(</span><span class=n>getSuggestedMinimumHeight</span><span class=o>(),</span> <span class=n>heightMeasureSpec</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，View 默认的 onMeasure() 方法首先会调用 getDefaultSize() 获取宽和高的默认值，然后再调用 setMeasuredDimension() 将获取的值进行设置，查看 getDefaultSize() 的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getDefaultSize</span><span class=o>(</span><span class=kt>int</span> <span class=n>size</span><span class=o>,</span> <span class=kt>int</span> <span class=n>measureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>specMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getMode</span><span class=o>(</span><span class=n>measureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>specSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>measureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>specMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>UNSPECIFIED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>specSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>无论是 AT_MOST 还是 EXACTLY，最终返回的都是 measureSpec 中的 specSize，这个 specSize 就是测量后的最终结果。至于 UNSPECIFIED 的情况，则会返回一个建议的最小值，这个值和子元素设置的最小值它的背景大小有关。</p><p>从 onMeasure() 的默认实现可以看出，如果我们自定义一个直接继承自 View 的控件如果不重写 onMeasure() 方法，在使用这个控件并把 layout_width 或 layout_height 设置成 wrap_content 的时候，效果将会和 match_parent 一样！因为布局中使用 wrap_content 的时候，根据上面 getChildMeasureSpec() 方法总结出来的表格可以知道，此时的 specMode 是 AT_MOST，specSize 是 parentSize，而 parentSize 是父容器当前剩余的空间大小，此时 getDefaultSize() 就会返回 specSize，因此子元素的宽或高就被设置成了等于当前父容器剩余空间的大小了，这显然不符合我们的预期，如何解决这个问题呢？一个通用的方案就是像如下方式重写 onMeasure() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>onMeasure</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>widthMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getMode</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>widthSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>heightMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getMode</span><span class=o>(</span><span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>heightSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 默认的宽/高
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>mWidth</span> <span class=o>=</span> <span class=n>default_width</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>mHeight</span> <span class=o>=</span> <span class=n>default_height</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 当布局参数设置为 wrap_content 时，使用默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>getLayoutParams</span><span class=o>().</span><span class=na>width</span> <span class=o>==</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span> <span class=o>&amp;&amp;</span> <span class=n>getLayoutParams</span><span class=o>().</span><span class=na>height</span> <span class=o>==</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>mWidth</span><span class=o>,</span> <span class=n>mHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 宽 / 高任意一个布局参数为 wrap_content 时，都使用默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>getLayoutParams</span><span class=o>().</span><span class=na>width</span> <span class=o>==</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>mWidth</span><span class=o>,</span> <span class=n>heightSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>getLayoutParams</span><span class=o>().</span><span class=na>height</span> <span class=o>==</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>widthSize</span><span class=o>,</span> <span class=n>mHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>因为 DecorView 继承自 FrameLayout，它是一个 ViewGroup，ViewGroup 是一个抽象类，它并没有定义一个具体的测量过程，默认使用 View 的 onMeasure() 进行测量。它的测量过程需要各个子类通过重写 onMeasure() 方法去实现，因为不同的子类具有不同的布局特性，因此需要不一样的测量逻辑，DecorView 也自然重写了 onMeasure() 方法来实现自己的测量逻辑，简略后方法内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>widthMode</span> <span class=o>=</span> <span class=n>getMode</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>heightMode</span> <span class=o>=</span> <span class=n>getMode</span><span class=o>(</span><span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>widthMode</span> <span class=o>==</span> <span class=n>AT_MOST</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>heightMode</span> <span class=o>==</span> <span class=n>AT_MOST</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>onMeasure</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最终会调用父类 FrameLayout 的 onMeasure() 方法，简略后方法内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>getChildCount</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>View</span> <span class=n>child</span> <span class=o>=</span> <span class=n>getChildAt</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mMeasureAllChildren</span> <span class=o>||</span> <span class=n>child</span><span class=o>.</span><span class=na>getVisibility</span><span class=o>()</span> <span class=o>!=</span> <span class=n>GONE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>measureChildWithMargins</span><span class=o>(</span><span class=n>child</span><span class=o>,</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>resolveSizeAndState</span><span class=o>(</span><span class=n>maxWidth</span><span class=o>,</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>childState</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>resolveSizeAndState</span><span class=o>(</span><span class=n>maxHeight</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>childState</span> <span class=o>&lt;&lt;</span> <span class=n>MEASURED_HEIGHT_STATE_SHIFT</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里会遍历它的每一个子元素，并调用 measureChildWithMargins() 方法，这个方法其实前面已经出现过，它的作用是计算出子元素的 MeasureSpec 后调用子元素本身的 measure() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>measureChildWithMargins</span><span class=o>(</span><span class=n>View</span> <span class=n>child</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>parentWidthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>widthUsed</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>parentHeightMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightUsed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取子元素的布局参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>MarginLayoutParams</span> <span class=n>lp</span> <span class=o>=</span> <span class=o>(</span><span class=n>MarginLayoutParams</span><span class=o>)</span> <span class=n>child</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 产生子元素的 MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childWidthMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=o>(</span><span class=n>parentWidthMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPaddingLeft</span> <span class=o>+</span> <span class=n>mPaddingRight</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>leftMargin</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>rightMargin</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>widthUsed</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>width</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childHeightMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=o>(</span><span class=n>parentHeightMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPaddingTop</span> <span class=o>+</span> <span class=n>mPaddingBottom</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>bottomMargin</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>heightUsed</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>child</span><span class=o>.</span><span class=na>measure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此时实际上调用的也是 View 的 measure() 方法，从上面的内容可以知道，子元素的 onMeasure() 方法又会被调用，这样便实现了层层递归地调用到了每个子元素的 onMeasure() 方法进行测量。</p><a href=#layout-流程分析><h2 id=layout-流程分析><span class=hanchor arialabel=Anchor># </span>Layout 流程分析</h2></a><p>再次回到 performTraversals() 方法，执行完 performMeasure() 遍历测量所有子元素之后，接着会调用 performLayout() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performLayout</span><span class=o>(</span><span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>lp</span><span class=o>,</span> <span class=kt>int</span> <span class=n>desiredWindowWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>desiredWindowHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 DecorView 的 layout() 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>host</span><span class=o>.</span><span class=na>layout</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>host</span><span class=o>.</span><span class=na>getMeasuredWidth</span><span class=o>(),</span> <span class=n>host</span><span class=o>.</span><span class=na>getMeasuredHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的 getMeasuredWidth() 和 getMeasuredHeight() 就是 DecorView 在前面 Measure 流程中计算得到的测量值，它们都被作为参数传入 layout() 方法中，这里调用的是 View 的 layout() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>layout</span><span class=o>(</span><span class=kt>int</span> <span class=n>l</span><span class=o>,</span> <span class=kt>int</span> <span class=n>t</span><span class=o>,</span> <span class=kt>int</span> <span class=n>r</span><span class=o>,</span> <span class=kt>int</span> <span class=n>b</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// View 状态是否发生了变化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>changed</span> <span class=o>=</span> <span class=n>isLayoutModeOptical</span><span class=o>(</span><span class=n>mParent</span><span class=o>)</span> <span class=o>?</span>
</span></span><span class=line><span class=cl>                <span class=n>setOpticalFrame</span><span class=o>(</span><span class=n>l</span><span class=o>,</span> <span class=n>t</span><span class=o>,</span> <span class=n>r</span><span class=o>,</span> <span class=n>b</span><span class=o>)</span> <span class=o>:</span> <span class=n>setFrame</span><span class=o>(</span><span class=n>l</span><span class=o>,</span> <span class=n>t</span><span class=o>,</span> <span class=n>r</span><span class=o>,</span> <span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果 View 状态有变化，则重新布局
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>changed</span> <span class=o>||</span> <span class=o>(</span><span class=n>mPrivateFlags</span> <span class=o>&amp;</span> <span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=o>)</span> <span class=o>==</span> <span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>onLayout</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>l</span><span class=o>,</span> <span class=n>t</span><span class=o>,</span> <span class=n>r</span><span class=o>,</span> <span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>setOpticalFrame() 内部也直接调用了 setFrame() 方法，查看 setFrame() 方法的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>setFrame</span><span class=o>(</span><span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>changed</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mLeft</span> <span class=o>!=</span> <span class=n>left</span> <span class=o>||</span> <span class=n>mRight</span> <span class=o>!=</span> <span class=n>right</span> <span class=o>||</span> <span class=n>mTop</span> <span class=o>!=</span> <span class=n>top</span> <span class=o>||</span> <span class=n>mBottom</span> <span class=o>!=</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>changed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>oldWidth</span> <span class=o>=</span> <span class=n>mRight</span> <span class=o>-</span> <span class=n>mLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>oldHeight</span> <span class=o>=</span> <span class=n>mBottom</span> <span class=o>-</span> <span class=n>mTop</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>newWidth</span> <span class=o>=</span> <span class=n>right</span> <span class=o>-</span> <span class=n>left</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>newHeight</span> <span class=o>=</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>top</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>sizeChanged</span> <span class=o>=</span> <span class=o>(</span><span class=n>newWidth</span> <span class=o>!=</span> <span class=n>oldWidth</span><span class=o>)</span> <span class=o>||</span> <span class=o>(</span><span class=n>newHeight</span> <span class=o>!=</span> <span class=n>oldHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Invalidate our old position
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>invalidate</span><span class=o>(</span><span class=n>sizeChanged</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 变量初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>mLeft</span> <span class=o>=</span> <span class=n>left</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mTop</span> <span class=o>=</span> <span class=n>top</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mRight</span> <span class=o>=</span> <span class=n>right</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mBottom</span> <span class=o>=</span> <span class=n>bottom</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 更新用于渲染的显示列表
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mRenderNode</span><span class=o>.</span><span class=na>setLeftTopRightBottom</span><span class=o>(</span><span class=n>mLeft</span><span class=o>,</span> <span class=n>mTop</span><span class=o>,</span> <span class=n>mRight</span><span class=o>,</span> <span class=n>mBottom</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>sizeChanged</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果 View 大小发生变化，则会在里面回调 onSizeChanged 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>sizeChange</span><span class=o>(</span><span class=n>newWidth</span><span class=o>,</span> <span class=n>newHeight</span><span class=o>,</span> <span class=n>oldWidth</span><span class=o>,</span> <span class=n>oldHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 返回是否发生变化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>changed</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>setFrame() 方法的主要作用有以下几点：</p><ol><li>判断 View 位置是否发生变化，并根据变化情况进行相应的处理；</li><li>初始化 mLeft、mBottom、mRight 和 mTop 变量，首次调用这个方法的时候返回值为 <em>true</em>；</li><li>调用 RenderNode 中原生方法更新用于渲染的显示列表。</li></ol><p>回到 layout() 方法，根据 setFrame() 方法返回的状态判断是否需要调用 onLayout() 进行重新布局，查看 onLayout() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Assign a size and position to a view and all of its
</span></span></span><span class=line><span class=cl><span class=cm> * descendants
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;This is the second phase of the layout mechanism.
</span></span></span><span class=line><span class=cl><span class=cm> * (The first is measuring). In this phase, each parent calls
</span></span></span><span class=line><span class=cl><span class=cm> * layout on all of its children to position them.
</span></span></span><span class=line><span class=cl><span class=cm> * This is typically done using the child measurements
</span></span></span><span class=line><span class=cl><span class=cm> * that were stored in the measure pass().&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;Derived classes should not override this method.
</span></span></span><span class=line><span class=cl><span class=cm> * Derived classes with children should override
</span></span></span><span class=line><span class=cl><span class=cm> * onLayout. In that method, they should
</span></span></span><span class=line><span class=cl><span class=cm> * call layout on each of their children.&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onLayout</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>changed</span><span class=o>,</span> <span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>onLayout() 方法是一个空方法，从注释最后一段内容可以了解到，单一的 View 并不需要重写这个方法，当 View 的子类具有子元素（即 ViewGroup）的时候，应该重写这个方法并调用每个子元素的 layout() 方法，因此作为一个 ViewGroup，我们查看 DecorView 的 onLayout() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onLayout</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>changed</span><span class=o>,</span> <span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>onLayout</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的主要逻辑是调用父类的 onLayout() 方法，继续跟踪 FrameLayout 的 onLayout() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onLayout</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>changed</span><span class=o>,</span> <span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>layoutChildren</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=kc>false</span> <span class=cm>/* no force left gravity */</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>layoutChildren</span><span class=o>(</span><span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>forceLeftGravity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>getChildCount</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>parentLeft</span> <span class=o>=</span> <span class=n>getPaddingLeftWithForeground</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>parentRight</span> <span class=o>=</span> <span class=n>right</span> <span class=o>-</span> <span class=n>left</span> <span class=o>-</span> <span class=n>getPaddingRightWithForeground</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>parentTop</span> <span class=o>=</span> <span class=n>getPaddingTopWithForeground</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>parentBottom</span> <span class=o>=</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>top</span> <span class=o>-</span> <span class=n>getPaddingBottomWithForeground</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>View</span> <span class=n>child</span> <span class=o>=</span> <span class=n>getChildAt</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>child</span><span class=o>.</span><span class=na>getVisibility</span><span class=o>()</span> <span class=o>!=</span> <span class=n>GONE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>LayoutParams</span> <span class=n>lp</span> <span class=o>=</span> <span class=o>(</span><span class=n>LayoutParams</span><span class=o>)</span> <span class=n>child</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>child</span><span class=o>.</span><span class=na>getMeasuredWidth</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>child</span><span class=o>.</span><span class=na>getMeasuredHeight</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>childLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>childTop</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>gravity</span> <span class=o>=</span> <span class=n>lp</span><span class=o>.</span><span class=na>gravity</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>gravity</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>gravity</span> <span class=o>=</span> <span class=n>DEFAULT_CHILD_GRAVITY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>layoutDirection</span> <span class=o>=</span> <span class=n>getLayoutDirection</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>absoluteGravity</span> <span class=o>=</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>getAbsoluteGravity</span><span class=o>(</span><span class=n>gravity</span><span class=o>,</span> <span class=n>layoutDirection</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>verticalGravity</span> <span class=o>=</span> <span class=n>gravity</span> <span class=o>&amp;</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>VERTICAL_GRAVITY_MASK</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>switch</span> <span class=o>(</span><span class=n>absoluteGravity</span> <span class=o>&amp;</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>HORIZONTAL_GRAVITY_MASK</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>CENTER_HORIZONTAL</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childLeft</span> <span class=o>=</span> <span class=n>parentLeft</span> <span class=o>+</span> <span class=o>(</span><span class=n>parentRight</span> <span class=o>-</span> <span class=n>parentLeft</span> <span class=o>-</span> <span class=n>width</span><span class=o>)</span> <span class=o>/</span> <span class=n>2</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=n>lp</span><span class=o>.</span><span class=na>leftMargin</span> <span class=o>-</span> <span class=n>lp</span><span class=o>.</span><span class=na>rightMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>RIGHT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(!</span><span class=n>forceLeftGravity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>childLeft</span> <span class=o>=</span> <span class=n>parentRight</span> <span class=o>-</span> <span class=n>width</span> <span class=o>-</span> <span class=n>lp</span><span class=o>.</span><span class=na>rightMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>LEFT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childLeft</span> <span class=o>=</span> <span class=n>parentLeft</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>leftMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>switch</span> <span class=o>(</span><span class=n>verticalGravity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>TOP</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childTop</span> <span class=o>=</span> <span class=n>parentTop</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>CENTER_VERTICAL</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childTop</span> <span class=o>=</span> <span class=n>parentTop</span> <span class=o>+</span> <span class=o>(</span><span class=n>parentBottom</span> <span class=o>-</span> <span class=n>parentTop</span> <span class=o>-</span> <span class=n>height</span><span class=o>)</span> <span class=o>/</span> <span class=n>2</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span> <span class=o>-</span> <span class=n>lp</span><span class=o>.</span><span class=na>bottomMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>BOTTOM</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childTop</span> <span class=o>=</span> <span class=n>parentBottom</span> <span class=o>-</span> <span class=n>height</span> <span class=o>-</span> <span class=n>lp</span><span class=o>.</span><span class=na>bottomMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childTop</span> <span class=o>=</span> <span class=n>parentTop</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用每个子元素的 layout 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>child</span><span class=o>.</span><span class=na>layout</span><span class=o>(</span><span class=n>childLeft</span><span class=o>,</span> <span class=n>childTop</span><span class=o>,</span> <span class=n>childLeft</span> <span class=o>+</span> <span class=n>width</span><span class=o>,</span> <span class=n>childTop</span> <span class=o>+</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 layoutChildren() 方法中，根据自己的布局逻辑，计算出每个子元素的 left、top、right 和 bottom 值，并调用它们的 layout() 方法。</p><p>Layout 流程的作用是 ViewGroup 用来确定它的子元素的位置， 当 ViewGroup 的位置被确定后，在它的 onLayout() 方法中就会遍历调用所有子元素的 layout() 方法，子元素的 layout() 方法被调用的时候它的 onLayout() 方法又会被调用，这样就实现了层层递归。</p><a href=#draw-流程分析><h2 id=draw-流程分析><span class=hanchor arialabel=Anchor># </span>Draw 流程分析</h2></a><p>最后，又一次回到主线中的 performTraversals() 方法，此时，经过 Measure 流程确定了每个 View 的大小并且经过 Layout 流程确定了每个 View 的摆放位置，下面将进入下一个流程确定每个 View 的具体绘制细节。查看 performDraw() 方法内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performDraw</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>fullRedrawNeeded</span> <span class=o>=</span> <span class=n>mFullRedrawNeeded</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mFullRedrawNeeded</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mIsDrawing</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>draw</span><span class=o>(</span><span class=n>fullRedrawNeeded</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mIsDrawing</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>跟踪 draw() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>draw</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>fullRedrawNeeded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// “脏”区域，即需要重绘的区域
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>Rect</span> <span class=n>dirty</span> <span class=o>=</span> <span class=n>mDirty</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>fullRedrawNeeded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mIgnoreDirtyState</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>dirty</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>mWidth</span> <span class=o>*</span> <span class=n>appScale</span> <span class=o>+</span> <span class=n>0</span><span class=o>.</span><span class=na>5f</span><span class=o>),</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>mHeight</span> <span class=o>*</span> <span class=n>appScale</span> <span class=o>+</span> <span class=n>0</span><span class=o>.</span><span class=na>5f</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>dirty</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()</span> <span class=o>||</span> <span class=n>mIsAnimating</span> <span class=o>||</span> <span class=n>accessibilityFocusDirty</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mHardwareRenderer</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mHardwareRenderer</span><span class=o>.</span><span class=na>isEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用 drawSoftware 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(!</span><span class=n>drawSoftware</span><span class=o>(</span><span class=n>surface</span><span class=o>,</span> <span class=n>mAttachInfo</span><span class=o>,</span> <span class=n>xOffset</span><span class=o>,</span> <span class=n>yOffset</span><span class=o>,</span> <span class=n>scalingRequired</span><span class=o>,</span> <span class=n>dirty</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>查看 drawSoftware() 方法实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>drawSoftware</span><span class=o>(</span><span class=n>Surface</span> <span class=n>surface</span><span class=o>,</span> <span class=n>AttachInfo</span> <span class=n>attachInfo</span><span class=o>,</span> <span class=kt>int</span> <span class=n>xoff</span><span class=o>,</span> <span class=kt>int</span> <span class=n>yoff</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>scalingRequired</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>dirty</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Draw with software renderer.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>Canvas</span> <span class=n>canvas</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>left</span> <span class=o>=</span> <span class=n>dirty</span><span class=o>.</span><span class=na>left</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>top</span> <span class=o>=</span> <span class=n>dirty</span><span class=o>.</span><span class=na>top</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>right</span> <span class=o>=</span> <span class=n>dirty</span><span class=o>.</span><span class=na>right</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>bottom</span> <span class=o>=</span> <span class=n>dirty</span><span class=o>.</span><span class=na>bottom</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 锁定canvas区域，由 dirty 区域决定
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>canvas</span> <span class=o>=</span> <span class=n>mSurface</span><span class=o>.</span><span class=na>lockCanvas</span><span class=o>(</span><span class=n>dirty</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>setDensity</span><span class=o>(</span><span class=n>mDensity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Surface</span><span class=o>.</span><span class=na>OutOfResourcesException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>handleOutOfResourcesException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IllegalArgumentException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mLayoutRequested</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>    <span class=c1>// ask wm for a new surface next time.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用 DecorView 的 draw 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mView</span><span class=o>.</span><span class=na>draw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mLayoutRequested</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>    <span class=c1>// ask wm for a new surface next time.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//noinspection ReturnInsideFinallyBlock
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>继续查看 DecorView 的 draw() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>draw</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>draw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mMenuBackground</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mMenuBackground</span><span class=o>.</span><span class=na>draw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>主要是调用了父类的 draw 方法，FrameLayout 和 ViewGroup 都没有重写 draw() 方法，所以直接看 View 的 draw() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>draw</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>privateFlags</span> <span class=o>=</span> <span class=n>mPrivateFlags</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>dirtyOpaque</span> <span class=o>=</span> <span class=o>(</span><span class=n>privateFlags</span> <span class=o>&amp;</span> <span class=n>PFLAG_DIRTY_MASK</span><span class=o>)</span> <span class=o>==</span> <span class=n>PFLAG_DIRTY_OPAQUE</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>mAttachInfo</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mIgnoreDirtyState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mPrivateFlags</span> <span class=o>=</span> <span class=o>(</span><span class=n>privateFlags</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>PFLAG_DIRTY_MASK</span><span class=o>)</span> <span class=o>|</span> <span class=n>PFLAG_DRAWN</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * Draw traversal performs several drawing steps which must be executed
</span></span></span><span class=line><span class=cl><span class=cm>     * in the appropriate order:
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     *      1. Draw the background
</span></span></span><span class=line><span class=cl><span class=cm>     *      2. If necessary, save the canvas&#39; layers to prepare for fading
</span></span></span><span class=line><span class=cl><span class=cm>     *      3. Draw view&#39;s content
</span></span></span><span class=line><span class=cl><span class=cm>     *      4. Draw children
</span></span></span><span class=line><span class=cl><span class=cm>     *      5. If necessary, draw the fading edges and restore layers
</span></span></span><span class=line><span class=cl><span class=cm>     *      6. Draw decorations (scrollbars for instance)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 1, draw the background, if needed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>saveCount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>dirtyOpaque</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>drawBackground</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// skip step 2 &amp; 5 if possible (common case)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>viewFlags</span> <span class=o>=</span> <span class=n>mViewFlags</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>horizontalEdges</span> <span class=o>=</span> <span class=o>(</span><span class=n>viewFlags</span> <span class=o>&amp;</span> <span class=n>FADING_EDGE_HORIZONTAL</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>verticalEdges</span> <span class=o>=</span> <span class=o>(</span><span class=n>viewFlags</span> <span class=o>&amp;</span> <span class=n>FADING_EDGE_VERTICAL</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>verticalEdges</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>horizontalEdges</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Step 3, draw the content
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(!</span><span class=n>dirtyOpaque</span><span class=o>)</span> <span class=n>onDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Step 4, draw the children
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>dispatchDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Overlay is part of the content and draws beneath Foreground
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>mOverlay</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mOverlay</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mOverlay</span><span class=o>.</span><span class=na>getOverlayView</span><span class=o>().</span><span class=na>dispatchDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Step 6, draw decorations (foreground, scrollbars)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>onDrawForeground</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// we&#39;re done...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * Here we do the full fledged routine...
</span></span></span><span class=line><span class=cl><span class=cm>     * (this is an uncommon case where speed matters less,
</span></span></span><span class=line><span class=cl><span class=cm>     * this is why we repeat some of the tests that have been
</span></span></span><span class=line><span class=cl><span class=cm>     * done above)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>drawTop</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>drawBottom</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>drawLeft</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>drawRight</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>topFadeStrength</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>bottomFadeStrength</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>leftFadeStrength</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>rightFadeStrength</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 2, save the canvas&#39; layers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>paddingLeft</span> <span class=o>=</span> <span class=n>mPaddingLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>offsetRequired</span> <span class=o>=</span> <span class=n>isPaddingOffsetRequired</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>offsetRequired</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>paddingLeft</span> <span class=o>+=</span> <span class=n>getLeftPaddingOffset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>left</span> <span class=o>=</span> <span class=n>mScrollX</span> <span class=o>+</span> <span class=n>paddingLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>right</span> <span class=o>=</span> <span class=n>left</span> <span class=o>+</span> <span class=n>mRight</span> <span class=o>-</span> <span class=n>mLeft</span> <span class=o>-</span> <span class=n>mPaddingRight</span> <span class=o>-</span> <span class=n>paddingLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>top</span> <span class=o>=</span> <span class=n>mScrollY</span> <span class=o>+</span> <span class=n>getFadeTop</span><span class=o>(</span><span class=n>offsetRequired</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>bottom</span> <span class=o>=</span> <span class=n>top</span> <span class=o>+</span> <span class=n>getFadeHeight</span><span class=o>(</span><span class=n>offsetRequired</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>offsetRequired</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>right</span> <span class=o>+=</span> <span class=n>getRightPaddingOffset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>bottom</span> <span class=o>+=</span> <span class=n>getBottomPaddingOffset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ScrollabilityCache</span> <span class=n>scrollabilityCache</span> <span class=o>=</span> <span class=n>mScrollCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>float</span> <span class=n>fadeHeight</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>fadingEdgeLength</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=n>fadeHeight</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// clip the fade length if top and bottom fades overlap
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// overlapping fades produce odd-looking artifacts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>verticalEdges</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>top</span> <span class=o>+</span> <span class=n>length</span> <span class=o>&gt;</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>length</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>length</span> <span class=o>=</span> <span class=o>(</span><span class=n>bottom</span> <span class=o>-</span> <span class=n>top</span><span class=o>)</span> <span class=o>/</span> <span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// also clip horizontal fades if necessary
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>horizontalEdges</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>left</span> <span class=o>+</span> <span class=n>length</span> <span class=o>&gt;</span> <span class=n>right</span> <span class=o>-</span> <span class=n>length</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>length</span> <span class=o>=</span> <span class=o>(</span><span class=n>right</span> <span class=o>-</span> <span class=n>left</span><span class=o>)</span> <span class=o>/</span> <span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>verticalEdges</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>topFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>getTopFadingEdgeStrength</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>drawTop</span> <span class=o>=</span> <span class=n>topFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bottomFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>getBottomFadingEdgeStrength</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>drawBottom</span> <span class=o>=</span> <span class=n>bottomFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>horizontalEdges</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>leftFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>getLeftFadingEdgeStrength</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>drawLeft</span> <span class=o>=</span> <span class=n>leftFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>rightFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>getRightFadingEdgeStrength</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>drawRight</span> <span class=o>=</span> <span class=n>rightFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>saveCount</span> <span class=o>=</span> <span class=n>canvas</span><span class=o>.</span><span class=na>getSaveCount</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>solidColor</span> <span class=o>=</span> <span class=n>getSolidColor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>solidColor</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>flags</span> <span class=o>=</span> <span class=n>Canvas</span><span class=o>.</span><span class=na>HAS_ALPHA_LAYER_SAVE_FLAG</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>drawTop</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>canvas</span><span class=o>.</span><span class=na>saveLayer</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>top</span> <span class=o>+</span> <span class=n>length</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>drawBottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>canvas</span><span class=o>.</span><span class=na>saveLayer</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>length</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>drawLeft</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>canvas</span><span class=o>.</span><span class=na>saveLayer</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>left</span> <span class=o>+</span> <span class=n>length</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>drawRight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>canvas</span><span class=o>.</span><span class=na>saveLayer</span><span class=o>(</span><span class=n>right</span> <span class=o>-</span> <span class=n>length</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>setFadeColor</span><span class=o>(</span><span class=n>solidColor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 3, draw the content
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>dirtyOpaque</span><span class=o>)</span> <span class=n>onDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 4, draw the children
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>dispatchDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 5, draw the fade effect and restore layers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>Paint</span> <span class=n>p</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>paint</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Matrix</span> <span class=n>matrix</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>matrix</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Shader</span> <span class=n>fade</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>shader</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>drawTop</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>topFadeStrength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postTranslate</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>fade</span><span class=o>.</span><span class=na>setLocalMatrix</span><span class=o>(</span><span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=na>setShader</span><span class=o>(</span><span class=n>fade</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>drawRect</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>top</span> <span class=o>+</span> <span class=n>length</span><span class=o>,</span> <span class=n>p</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>drawBottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>bottomFadeStrength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postRotate</span><span class=o>(</span><span class=n>180</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postTranslate</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>bottom</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>fade</span><span class=o>.</span><span class=na>setLocalMatrix</span><span class=o>(</span><span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=na>setShader</span><span class=o>(</span><span class=n>fade</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>drawRect</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>length</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=n>p</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>drawLeft</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>leftFadeStrength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postRotate</span><span class=o>(-</span><span class=n>90</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postTranslate</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>fade</span><span class=o>.</span><span class=na>setLocalMatrix</span><span class=o>(</span><span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=na>setShader</span><span class=o>(</span><span class=n>fade</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>drawRect</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>left</span> <span class=o>+</span> <span class=n>length</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=n>p</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>drawRight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>rightFadeStrength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postRotate</span><span class=o>(</span><span class=n>90</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postTranslate</span><span class=o>(</span><span class=n>right</span><span class=o>,</span> <span class=n>top</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>fade</span><span class=o>.</span><span class=na>setLocalMatrix</span><span class=o>(</span><span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=na>setShader</span><span class=o>(</span><span class=n>fade</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>drawRect</span><span class=o>(</span><span class=n>right</span> <span class=o>-</span> <span class=n>length</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=n>p</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>canvas</span><span class=o>.</span><span class=na>restoreToCount</span><span class=o>(</span><span class=n>saveCount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Overlay is part of the content and draws beneath Foreground
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>mOverlay</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mOverlay</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mOverlay</span><span class=o>.</span><span class=na>getOverlayView</span><span class=o>().</span><span class=na>dispatchDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 6, draw decorations (foreground, scrollbars)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>onDrawForeground</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从代码注释中可以看到，draw() 过程分为六个步骤，分别是：</p><ol><li>绘制 View 的背景；</li><li>保存当前 canvas 的图层；</li><li>绘制 View 的内容；</li><li>如果有子元素，则调用子元素的 draw() 方法；</li><li>绘制淡入淡出效果并恢复图层；</li><li>绘制 View 的装饰（滚动条等）。</li></ol><p>其中第二步和第五步一般情况下不会用到，我们继续看第三步，看看它是如何分配子元素的绘制的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>dispatchDraw</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>显然，单一的 View 并没有子元素，因此，看看 ViewGroup 是怎么实现这个过程的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>dispatchDraw</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>childrenCount</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>transientIndex</span> <span class=o>&gt;=</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=n>mTransientIndices</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>transientIndex</span><span class=o>)</span> <span class=o>==</span> <span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>View</span> <span class=n>transientChild</span> <span class=o>=</span> <span class=n>mTransientViews</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>transientIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span><span class=n>transientChild</span><span class=o>.</span><span class=na>mViewFlags</span> <span class=o>&amp;</span> <span class=n>VISIBILITY_MASK</span><span class=o>)</span> <span class=o>==</span> <span class=n>VISIBLE</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                    <span class=n>transientChild</span><span class=o>.</span><span class=na>getAnimation</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>more</span> <span class=o>|=</span> <span class=n>drawChild</span><span class=o>(</span><span class=n>canvas</span><span class=o>,</span> <span class=n>transientChild</span><span class=o>,</span> <span class=n>drawingTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>drawChild</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>,</span> <span class=n>View</span> <span class=n>child</span><span class=o>,</span> <span class=kt>long</span> <span class=n>drawingTime</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>child</span><span class=o>.</span><span class=na>draw</span><span class=o>(</span><span class=n>canvas</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>drawingTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 ViewGroup 的 dispatchDraw() 中，遍历每个子元素并调用了它们的 draw() 方法，由此实现了层层递归调用，最终完成绘制。</p><a href=#小结-4><h2 id=小结-4><span class=hanchor arialabel=Anchor># </span>小结</h2></a><p>纵观整个 Measure、Layout 和 Draw 过程，使用流程图表示如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045712.png width=auto alt></p><a href=#八显示-view><h1 id=八显示-view><span class=hanchor arialabel=Anchor># </span>八：显示 View</h1></a><p>不知道你还记不记得，上一步骤中执行的 View 的 Measure、Layout 和 Draw 流程都是前面 handleResumeActivity() 中的 wm.addView() 方法为源头的，回顾 handleResumeActivity() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>handleResumeActivity</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>clearHide</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isForward</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>reallyResume</span><span class=o>,</span> <span class=kt>int</span> <span class=n>seq</span><span class=o>,</span> <span class=n>String</span> <span class=n>reason</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ActivityClientRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=n>mActivities</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>token</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 最终会调用 onStart() 和 onResume() 等方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>r</span> <span class=o>=</span> <span class=n>performResumeActivity</span><span class=o>(</span><span class=n>token</span><span class=o>,</span> <span class=n>clearHide</span><span class=o>,</span> <span class=n>reason</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>r</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Activity</span> <span class=n>a</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>window</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>a</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>willBeVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>window</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>getWindow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取 DecorView 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>View</span> <span class=n>decor</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>window</span><span class=o>.</span><span class=na>getDecorView</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将 DecorView 设置成不可见
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>decor</span><span class=o>.</span><span class=na>setVisibility</span><span class=o>(</span><span class=n>View</span><span class=o>.</span><span class=na>INVISIBLE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取 ViewManager，这里是 WindowManagerImpl 实例
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ViewManager</span> <span class=n>wm</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=na>getWindowManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>l</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>window</span><span class=o>.</span><span class=na>getAttributes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span><span class=o>.</span><span class=na>mDecor</span> <span class=o>=</span> <span class=n>decor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>l</span><span class=o>.</span><span class=na>type</span> <span class=o>=</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>TYPE_BASE_APPLICATION</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>l</span><span class=o>.</span><span class=na>softInputMode</span> <span class=o>|=</span> <span class=n>forwardBit</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>a</span><span class=o>.</span><span class=na>mVisibleFromClient</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>a</span><span class=o>.</span><span class=na>mWindowAdded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 标记设置为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>a</span><span class=o>.</span><span class=na>mWindowAdded</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 调用 WindowManagerImpl 的 addView 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>wm</span><span class=o>.</span><span class=na>addView</span><span class=o>(</span><span class=n>decor</span><span class=o>,</span> <span class=n>l</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> 
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>willBeVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>willBeVisible</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mDecor</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>hideForNow</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mVisibleFromClient</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 调用 makeVisible 方法将 DecorView 设置为可见
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>makeVisible</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 在此过程出现异常，则直接杀死 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>finishActivity</span><span class=o>(</span><span class=n>token</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>Activity</span><span class=o>.</span><span class=na>DONT_FINISH_TASK_WITH_ACTIVITY</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>ex</span><span class=o>.</span><span class=na>rethrowFromSystemServer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到在调用 wm.addView() 方法之前，DecorView 是处于不可见的状态的，因此，即使经过了 Measure、Layout 和 Draw 流程，我们的 View 仍然没有显示在屏幕上，看看 Activity 的 makeVisible() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>makeVisible</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>mWindowAdded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ViewManager</span> <span class=n>wm</span> <span class=o>=</span> <span class=n>getWindowManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>wm</span><span class=o>.</span><span class=na>addView</span><span class=o>(</span><span class=n>mDecor</span><span class=o>,</span> <span class=n>getWindow</span><span class=o>().</span><span class=na>getAttributes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>mWindowAdded</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mDecor</span><span class=o>.</span><span class=na>setVisibility</span><span class=o>(</span><span class=n>View</span><span class=o>.</span><span class=na>VISIBLE</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行 DecorView 的 setVisibility() 之后，我们的 View 才正式出现在屏幕上！</p><a href=#总结><h1 id=总结><span class=hanchor arialabel=Anchor># </span>总结</h1></a><ul><li>Window 是一个抽象类，提供了各种窗口操作的方法；</li><li>PhoneWindow 是 Window 的唯一实现类，每个 Acitvity 中都会有一个 PhoneWindw 实例；</li><li>DecorView —— 顶级视图，它继承自 FrameLayout，setContentView() 时，PhoneWindow 会创建 DecorView 并与 DecorView 建立关联；</li><li>PhoneWindow 会根据 Theme 和 Feature 等将对应的布局文件将布局解析并添加到 DecorView 中，这些布局中都包含了一个 id 为 content 的 FrameLayout；</li><li>setContentView() 方法中设置的 layout 布局文件会被 PhoneWindow 解析并压入 DecorView 中 id 为 content 的 FrameLayout 中；</li><li>View 的正式绘制是从 ViewRootImpl 的 performTraversals() 方法开始的；</li><li>单一 View 一般需要重写 onMeasure() 方法根据布局参数和父 View 的测量规格计算自己的宽高并保存；</li><li>ViewGroup 需要重写 onMeasure() 方法计算所有子元素的尺寸然后计算自己的尺寸并保存；</li><li>单一 View 一般不需要重写 onLayout() 方法；</li><li>ViewGroup 需要重写 onLayot() 方法根据测量的值确定所有子元素的位置；</li><li>单一 View 需要重写 onDraw() 方法绘制自身；</li><li>ViewGroup 需要重写 onDraw() 方法绘制自身以及遍历子元素对它们进行绘制。</li><li>在 Activity 的 onResume() 生命周期被调用后，ActivityThread 才会调用 activity.makeVisible() 让 DecorView 可见。</li></ul><p><strong>系列文章</strong></p><p><a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>按下电源键后竟然发生了这一幕 —— Android 系统启动流程分析</a></p><p><a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析</a></p><p><a href=https://guanpj.cn/2017/11/09/Android-View-Workflow/ rel=noopener>屏幕上内容究竟是怎样画出来的 —— Android View 工作原理详解</a>（本文）</p><p><strong>参考文章</strong></p><p><a href=https://blog.csdn.net/yanbober/article/details/46128379 rel=noopener>Android 应用层 View 绘制流程与源码分析</a></p><p><a href=https://www.jianshu.com/p/158736a2549d rel=noopener>（3）自定义 View Layout 过程 - 最易懂的自定义 View 原理系列</a></p><blockquote><p>如果你对文章内容有疑问或者有不同的意见，欢迎留言，我们一同探讨。</p></blockquote></article><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>