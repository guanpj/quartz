<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="åœ¨æˆ‘çš„ç³»åˆ—æ–‡ç« ä¸Šä¸€ç¯‡ï¼š App ç«Ÿç„¶æ˜¯è¿™æ ·è·‘èµ·æ¥çš„ â€”â€” Android App/Activity å¯åŠ¨æµç¨‹åˆ†æ ä¸­å·²ç»åˆ†æäº†ä¸€ä¸ª App ä»ç‚¹å‡»å®ƒçš„å›¾æ ‡åˆ° Activity çš„ onCreate()ã€onStart() å’Œ onResume() ç­‰ç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨çš„æ•´ä¸ªæµç¨‹ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ™®é€š App å±å¹•ä¸Šæ˜¾ç¤ºçš„å†…å®¹éƒ½æ˜¯ç”±ä¸€ä¸ªä¸ªè‡ªå·±è®¾è®¡çš„ç•Œé¢è¢«ç³»ç»ŸåŠ è½½è€Œæ¥çš„ï¼Œè€Œè¿™äº›ç•Œé¢ä¸­çš„å…ƒç´ åˆæ˜¯æ€ä¹ˆè¢«æ¸²æŸ“å‡ºæ¥çš„å‘¢ï¼Ÿæœ¬æ–‡å°†ç»§ç»­åŸºäº Android Nougat ä»æºç çš„è§’åº¦æ¥è¿›ä¸€æ­¥åˆ†ææ•´ä¸ªè¿‡ç¨‹ã€‚"><meta property="og:title" content="å…­ã€View ç»˜åˆ¶æµç¨‹åˆ†æ"><meta property="og:description" content="åœ¨æˆ‘çš„ç³»åˆ—æ–‡ç« ä¸Šä¸€ç¯‡ï¼š App ç«Ÿç„¶æ˜¯è¿™æ ·è·‘èµ·æ¥çš„ â€”â€” Android App/Activity å¯åŠ¨æµç¨‹åˆ†æ ä¸­å·²ç»åˆ†æäº†ä¸€ä¸ª App ä»ç‚¹å‡»å®ƒçš„å›¾æ ‡åˆ° Activity çš„ onCreate()ã€onStart() å’Œ onResume() ç­‰ç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨çš„æ•´ä¸ªæµç¨‹ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ™®é€š App å±å¹•ä¸Šæ˜¾ç¤ºçš„å†…å®¹éƒ½æ˜¯ç”±ä¸€ä¸ªä¸ªè‡ªå·±è®¾è®¡çš„ç•Œé¢è¢«ç³»ç»ŸåŠ è½½è€Œæ¥çš„ï¼Œè€Œè¿™äº›ç•Œé¢ä¸­çš„å…ƒç´ åˆæ˜¯æ€ä¹ˆè¢«æ¸²æŸ“å‡ºæ¥çš„å‘¢ï¼Ÿæœ¬æ–‡å°†ç»§ç»­åŸºäº Android Nougat ä»æºç çš„è§’åº¦æ¥è¿›ä¸€æ­¥åˆ†ææ•´ä¸ªè¿‡ç¨‹ã€‚"><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="å…­ã€View ç»˜åˆ¶æµç¨‹åˆ†æ"><meta name=twitter:description content="åœ¨æˆ‘çš„ç³»åˆ—æ–‡ç« ä¸Šä¸€ç¯‡ï¼š App ç«Ÿç„¶æ˜¯è¿™æ ·è·‘èµ·æ¥çš„ â€”â€” Android App/Activity å¯åŠ¨æµç¨‹åˆ†æ ä¸­å·²ç»åˆ†æäº†ä¸€ä¸ª App ä»ç‚¹å‡»å®ƒçš„å›¾æ ‡åˆ° Activity çš„ onCreate()ã€onStart() å’Œ onResume() ç­‰ç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨çš„æ•´ä¸ªæµç¨‹ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ™®é€š App å±å¹•ä¸Šæ˜¾ç¤ºçš„å†…å®¹éƒ½æ˜¯ç”±ä¸€ä¸ªä¸ªè‡ªå·±è®¾è®¡çš„ç•Œé¢è¢«ç³»ç»ŸåŠ è½½è€Œæ¥çš„ï¼Œè€Œè¿™äº›ç•Œé¢ä¸­çš„å…ƒç´ åˆæ˜¯æ€ä¹ˆè¢«æ¸²æŸ“å‡ºæ¥çš„å‘¢ï¼Ÿæœ¬æ–‡å°†ç»§ç»­åŸºäº Android Nougat ä»æºç çš„è§’åº¦æ¥è¿›ä¸€æ­¥åˆ†ææ•´ä¸ªè¿‡ç¨‹ã€‚"><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>å…­ã€View ç»˜åˆ¶æµç¨‹åˆ†æ</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.592437b1fbffed6c8a18843d158121af.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.a7a23db1d0aa39ecac0c61a41b5e946c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.293b6ed88f797000f698881f747ba3eb.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>å…­ã€View ç»˜åˆ¶æµç¨‹åˆ†æ</h1><p class=meta>Last updated
Mar 25, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/DecorView/>Decor view</a></li><li><a href=https://www.guanpj.top/tags/ViewRootImpl/>View root impl</a></li><li><a href=https://www.guanpj.top/tags/WMS/>Wms</a></li><li><a href=https://www.guanpj.top/tags/Framework/>Framework</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#ä¸€åˆå§‹åŒ–-phonewindow-å’Œ-windowmanager>ä¸€ï¼šåˆå§‹åŒ– PhoneWindow å’Œ WindowManager</a></li><li><a href=#äºŒåˆå§‹åŒ–-decorview>äºŒï¼šåˆå§‹åŒ– DecorView</a><ol><li><a href=#æºç åˆ†æ>æºç åˆ†æ</a></li><li><a href=#å°ç»“>å°ç»“</a></li></ol></li><li><a href=#ä¸‰åˆå§‹åŒ–-viewrootimpl-å¹¶å…³è”-decorview>ä¸‰ï¼šåˆå§‹åŒ– ViewRootImpl å¹¶å…³è” DecorView</a><ol><li><a href=#æºç åˆ†æ-1>æºç åˆ†æ</a></li><li><a href=#å°ç»“-1>å°ç»“</a></li></ol></li><li><a href=#å››å»ºç«‹-phonewindow-å’Œ-windowmanagerservice-ä¹‹é—´çš„è¿æ¥>å››ï¼šå»ºç«‹ PhoneWindow å’Œ WindowManagerService ä¹‹é—´çš„è¿æ¥</a><ol><li><a href=#æºç åˆ†æ-2>æºç åˆ†æ</a></li><li><a href=#å°ç»“-2>å°ç»“</a></li></ol></li><li><a href=#äº”å»ºç«‹ä¸-surfaceflinger-çš„è¿æ¥>äº”ï¼šå»ºç«‹ä¸ SurfaceFlinger çš„è¿æ¥</a><ol><li><a href=#æºç åˆ†æ-3>æºç åˆ†æ</a></li><li><a href=#å°ç»“-3>å°ç»“</a></li></ol></li><li><a href=#å…­ç”³è¯·-surface>å…­ï¼šç”³è¯· Surface</a></li><li><a href=#ä¸ƒæ­£å¼ç»˜åˆ¶-view>ä¸ƒï¼šæ­£å¼ç»˜åˆ¶ View</a><ol><li><a href=#ç†è§£-measurespec>ç†è§£ MeasureSpec</a></li><li><a href=#measure-æµç¨‹åˆ†æ>Measure æµç¨‹åˆ†æ</a></li><li><a href=#layout-æµç¨‹åˆ†æ>Layout æµç¨‹åˆ†æ</a></li><li><a href=#draw-æµç¨‹åˆ†æ>Draw æµç¨‹åˆ†æ</a></li><li><a href=#å°ç»“-4>å°ç»“</a></li></ol></li><li><a href=#å…«æ˜¾ç¤º-view>å…«ï¼šæ˜¾ç¤º View</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></nav></details></aside><p>åœ¨æˆ‘çš„ç³»åˆ—æ–‡ç« ä¸Šä¸€ç¯‡ï¼š
<a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App ç«Ÿç„¶æ˜¯è¿™æ ·è·‘èµ·æ¥çš„ â€”â€” Android App/Activity å¯åŠ¨æµç¨‹åˆ†æ</a> ä¸­å·²ç»åˆ†æäº†ä¸€ä¸ª App ä»ç‚¹å‡»å®ƒçš„å›¾æ ‡åˆ° Activity çš„ onCreate()ã€onStart() å’Œ onResume() ç­‰ç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨çš„æ•´ä¸ªæµç¨‹ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ™®é€š App å±å¹•ä¸Šæ˜¾ç¤ºçš„å†…å®¹éƒ½æ˜¯ç”±ä¸€ä¸ªä¸ªè‡ªå·±è®¾è®¡çš„ç•Œé¢è¢«ç³»ç»ŸåŠ è½½è€Œæ¥çš„ï¼Œè€Œè¿™äº›ç•Œé¢ä¸­çš„å…ƒç´ åˆæ˜¯æ€ä¹ˆè¢«æ¸²æŸ“å‡ºæ¥çš„å‘¢ï¼Ÿæœ¬æ–‡å°†ç»§ç»­åŸºäº Android Nougat ä»æºç çš„è§’åº¦æ¥è¿›ä¸€æ­¥åˆ†ææ•´ä¸ªè¿‡ç¨‹ã€‚</p><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œå›é¡¾ä¸€ä¸‹ä¸Šä¸€ç¯‡æ–‡ç« ä¸­åˆ†æçš„ä» ActivityThread åˆ° Activity è¿‡ç¨‹çš„æ—¶åºå›¾ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045616.png width=auto alt></p><a href=#ä¸€åˆå§‹åŒ–-phonewindow-å’Œ-windowmanager><h1 id=ä¸€åˆå§‹åŒ–-phonewindow-å’Œ-windowmanager><span class=hanchor arialabel=Anchor># </span>ä¸€ï¼šåˆå§‹åŒ– PhoneWindow å’Œ WindowManager</h1></a><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ Activity çš„ onCreate()ã€onStart() å’Œ onResume() ç­‰ç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨ä¹‹å‰ï¼Œå®ƒçš„ attach() æ–¹æ³•å°†ä¼šå…ˆè¢«è°ƒç”¨ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°† attach() æ–¹æ³•ä½œä¸ºè¿™ç¯‡æ–‡ç« ä¸»çº¿çš„å¼€å¤´ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>attach</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=n>ActivityThread</span> <span class=n>aThread</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Instrumentation</span> <span class=n>instr</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span> <span class=kt>int</span> <span class=n>ident</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Application</span> <span class=n>application</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>ActivityInfo</span> <span class=n>info</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>CharSequence</span> <span class=n>title</span><span class=o>,</span> <span class=n>Activity</span> <span class=n>parent</span><span class=o>,</span> <span class=n>String</span> <span class=n>id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>NonConfigurationInstances</span> <span class=n>lastNonConfigurationInstances</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Configuration</span> <span class=n>config</span><span class=o>,</span> <span class=n>String</span> <span class=n>referrer</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Window</span> <span class=n>window</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>attachBaseContext</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mWindow æ˜¯ä¸€ä¸ª PhoneWindow å¯¹è±¡å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mWindow</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PhoneWindow</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>window</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mWindow</span><span class=o>.</span><span class=na>setWindowControllerCallback</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mWindow</span><span class=o>.</span><span class=na>setCallback</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mWindow</span><span class=o>.</span><span class=na>setOnWindowDismissedCallback</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mWindow</span><span class=o>.</span><span class=na>getLayoutInflater</span><span class=o>().</span><span class=na>setPrivateFactory</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒç”¨ Window çš„ setWindowManager æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mWindow</span><span class=o>.</span><span class=na>setWindowManager</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>WindowManager</span><span class=o>)</span><span class=n>context</span><span class=o>.</span><span class=na>getSystemService</span><span class=o>(</span><span class=n>Context</span><span class=o>.</span><span class=na>WINDOW_SERVICE</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>mToken</span><span class=o>,</span> <span class=n>mComponent</span><span class=o>.</span><span class=na>flattenToString</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>info</span><span class=o>.</span><span class=na>flags</span> <span class=o>&amp;</span> <span class=n>ActivityInfo</span><span class=o>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mParent</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mWindow</span><span class=o>.</span><span class=na>setContainer</span><span class=o>(</span><span class=n>mParent</span><span class=o>.</span><span class=na>getWindow</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä» Window ä¸­è·å– WindowManager
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mWindowManager</span> <span class=o>=</span> <span class=n>mWindow</span><span class=o>.</span><span class=na>getWindowManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>mCurrentConfig</span> <span class=o>=</span> <span class=n>config</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>mWindow æ˜¯ä¸€ä¸ª Window ç±»å‹çš„å˜é‡ï¼Œåœ¨ attach() æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª PhoneWindow å¯¹è±¡å®ä¾‹å¹¶èµ‹å€¼ç»™äº† mWindowï¼ŒPhoneWindow ç›´æ¥ç»§æ‰¿è‡ª Window ç±»ã€‚ç„¶åè°ƒç”¨äº† Window çš„ setWindowManager() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setWindowManager</span><span class=o>(</span><span class=n>WindowManager</span> <span class=n>wm</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>appToken</span><span class=o>,</span> <span class=n>String</span> <span class=n>appName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>hardwareAccelerated</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mWindowManager å°±æ˜¯ WindowManagerImpl å¯¹è±¡çš„å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mWindowManager</span> <span class=o>=</span> <span class=o>((</span><span class=n>WindowManagerImpl</span><span class=o>)</span><span class=n>wm</span><span class=o>).</span><span class=na>createLocalWindowManager</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å› æ­¤ï¼ŒAcitvity ä¸­çš„ mWindow å˜é‡å°±æ˜¯ PhoneWindow ç±»çš„å®ä¾‹ï¼Œè€Œ mWindowManager æ˜¯ WindowManagerImpl ç±»çš„å®ä¾‹ï¼Œattach() æ–¹æ³•çš„ä¸»è¦å·¥ä½œå°±æ˜¯åˆå§‹åŒ–è¿™ä¸¤ä¸ªå˜é‡ã€‚</p><a href=#äºŒåˆå§‹åŒ–-decorview><h1 id=äºŒåˆå§‹åŒ–-decorview><span class=hanchor arialabel=Anchor># </span>äºŒï¼šåˆå§‹åŒ– DecorView</h1></a><a href=#æºç åˆ†æ><h2 id=æºç åˆ†æ><span class=hanchor arialabel=Anchor># </span>æºç åˆ†æ</h2></a><p>æ¥ä¸‹æ¥åˆ°äº† onCreate æ–¹æ³•ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¦‚æœæƒ³è¦è®©è‡ªå·±è®¾è®¡çš„ layout å¸ƒå±€æ–‡ä»¶æˆ–è€… View æ˜¾ç¤ºåœ¨ Activity ä¸­ï¼Œå¿…é¡»è¦åœ¨ Activity çš„ onCreate() æ–¹æ³•ä¸­åº”è¯¥è°ƒç”¨ setContentView() æ–¹æ³•å°†æˆ‘ä»¬çš„å¸ƒå±€ id æˆ–è€… View ä¼ é€’è¿‡å»ï¼ŒæŸ¥çœ‹å…¶ä¸­ä¸€ä¸ª setContentView() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setContentView</span><span class=o>(</span><span class=nd>@LayoutRes</span> <span class=kt>int</span> <span class=n>layoutResID</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>getWindow</span><span class=o>().</span><span class=na>setContentView</span><span class=o>(</span><span class=n>layoutResID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>initWindowDecorActionBar</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»§ç»­æŸ¥çœ‹ PhoneWindow ç±»çš„ setContentView() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setContentView</span><span class=o>(</span><span class=kt>int</span> <span class=n>layoutResID</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mContentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span><span class=c1>// æ˜¯å¦é¦–æ¬¡è°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// åˆå§‹åŒ– Decor
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>installDecor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>hasFeature</span><span class=o>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=o>))</span> <span class=o>{</span><span class=c1>// è½¬åœºåŠ¨ç”»ï¼Œé»˜è®¤ false
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mContentParent</span><span class=o>.</span><span class=na>removeAllViews</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>hasFeature</span><span class=o>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è§£æå¸ƒå±€æ–‡ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mLayoutInflater</span><span class=o>.</span><span class=na>inflate</span><span class=o>(</span><span class=n>layoutResID</span><span class=o>,</span> <span class=n>mContentParent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœæ˜¯é¦–æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåˆ™ mContentParent ä¸º nullï¼Œå¦åˆ™å¦‚æœæ²¡æœ‰è½¬åœºåŠ¨ç”»çš„è¯å°±ç§»é™¤ mContentParent çš„å…¨éƒ¨å­ Viewï¼Œç»§ç»­è·Ÿè¸ª installDecor() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>installDecor</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mForceDecorInstall</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mDecor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç”Ÿæˆ DecorView å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mDecor</span> <span class=o>=</span> <span class=n>generateDecor</span><span class=o>(-</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mDecor</span><span class=o>.</span><span class=na>setDescendantFocusability</span><span class=o>(</span><span class=n>ViewGroup</span><span class=o>.</span><span class=na>FOCUS_AFTER_DESCENDANTS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mDecor</span><span class=o>.</span><span class=na>setIsRootNamespace</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>mInvalidatePanelMenuPosted</span> <span class=o>&amp;&amp;</span> <span class=n>mInvalidatePanelMenuFeatures</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mDecor</span><span class=o>.</span><span class=na>postOnAnimation</span><span class=o>(</span><span class=n>mInvalidatePanelMenuRunnable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mDecor</span><span class=o>.</span><span class=na>setWindow</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mContentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ generateLayout æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mContentParent</span> <span class=o>=</span> <span class=n>generateLayout</span><span class=o>(</span><span class=n>mDecor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“ mDecor ä¸º null çš„æ—¶å€™ä¼šè°ƒç”¨ generateDecor() æ–¹æ³•åˆ›å»ºä¸€ä¸ª DecorView ç±»çš„å®ä¾‹ï¼ŒDecorView ç»§æ‰¿è‡ª FrameLayoutã€‚æ¥ä¸‹æ¥åˆ¤æ–­ mContentParent æ˜¯å¦ä¸º nullï¼ˆå‰é¢å·²ç»æåˆ°è¿‡ï¼Œé¦–æ¬¡åŠ è½½çš„æ—¶å€™å°±æ˜¯ nullï¼‰ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ generateLayout() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±ä¼šåˆ›å»º mContentParent å¯¹è±¡ï¼Œè·Ÿè¸ªè¿›å»ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=n>ViewGroup</span> <span class=nf>generateLayout</span><span class=o>(</span><span class=n>DecorView</span> <span class=n>decor</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>TypedArray</span> <span class=n>a</span> <span class=o>=</span> <span class=n>getWindowStyle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é€šè¿‡ WindowStyle ä¸­è®¾ç½®çš„å„ç§å±æ€§å¯¹ Window è¿›è¡Œå„ç§åˆå§‹åŒ–æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mIsFloating</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=na>getBoolean</span><span class=o>(</span><span class=n>R</span><span class=o>.</span><span class=na>styleable</span><span class=o>.</span><span class=na>Window_windowIsFloating</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>flagsToUpdate</span> <span class=o>=</span> <span class=o>(</span><span class=n>FLAG_LAYOUT_IN_SCREEN</span><span class=o>|</span><span class=n>FLAG_LAYOUT_INSET_DECOR</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span> <span class=o>(~</span><span class=n>getForcedWindowFlags</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mIsFloating</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setLayout</span><span class=o>(</span><span class=n>WRAP_CONTENT</span><span class=o>,</span> <span class=n>WRAP_CONTENT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>setFlags</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>flagsToUpdate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setFlags</span><span class=o>(</span><span class=n>FLAG_LAYOUT_IN_SCREEN</span><span class=o>|</span><span class=n>FLAG_LAYOUT_INSET_DECOR</span><span class=o>,</span> <span class=n>flagsToUpdate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>....</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>layoutResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>features</span> <span class=o>=</span> <span class=n>getLocalFeatures</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ®è®¾å®šå¥½çš„ features å€¼è·å–ç›¸åº”çš„å¸ƒå±€æ–‡ä»¶å¹¶èµ‹å€¼ç»™ layoutResource
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_SWIPE_TO_DISMISS</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_swipe_dismiss</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>((</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_LEFT_ICON</span><span class=o>)</span> <span class=o>|</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_RIGHT_ICON</span><span class=o>)))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mIsFloating</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>TypedValue</span> <span class=n>res</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TypedValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>getContext</span><span class=o>().</span><span class=na>getTheme</span><span class=o>().</span><span class=na>resolveAttribute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>attr</span><span class=o>.</span><span class=na>dialogTitleIconsDecorLayout</span><span class=o>,</span> <span class=n>res</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>res</span><span class=o>.</span><span class=na>resourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_title_icons</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>removeFeature</span><span class=o>(</span><span class=n>FEATURE_ACTION_BAR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>((</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_PROGRESS</span><span class=o>)</span> <span class=o>|</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_INDETERMINATE_PROGRESS</span><span class=o>)))</span> <span class=o>!=</span> <span class=n>0</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_ACTION_BAR</span><span class=o>))</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_progress</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_CUSTOM_TITLE</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mIsFloating</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>TypedValue</span> <span class=n>res</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TypedValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>getContext</span><span class=o>().</span><span class=na>getTheme</span><span class=o>().</span><span class=na>resolveAttribute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>attr</span><span class=o>.</span><span class=na>dialogCustomTitleDecorLayout</span><span class=o>,</span> <span class=n>res</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>res</span><span class=o>.</span><span class=na>resourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_custom_title</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>removeFeature</span><span class=o>(</span><span class=n>FEATURE_ACTION_BAR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_NO_TITLE</span><span class=o>))</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mIsFloating</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>TypedValue</span> <span class=n>res</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TypedValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>getContext</span><span class=o>().</span><span class=na>getTheme</span><span class=o>().</span><span class=na>resolveAttribute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>attr</span><span class=o>.</span><span class=na>dialogTitleDecorLayout</span><span class=o>,</span> <span class=n>res</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>res</span><span class=o>.</span><span class=na>resourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_ACTION_BAR</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=na>getResourceId</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>styleable</span><span class=o>.</span><span class=na>Window_windowActionBarFullscreenDecorLayout</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_action_bar</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_title</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>features</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>FEATURE_ACTION_MODE_OVERLAY</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_simple_overlay_action_mode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>layoutResource</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>screen_simple</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mDecor</span><span class=o>.</span><span class=na>startChanging</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒç”¨ onResourcesLoaded æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mDecor</span><span class=o>.</span><span class=na>onResourcesLoaded</span><span class=o>(</span><span class=n>mLayoutInflater</span><span class=o>,</span> <span class=n>layoutResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åœ¨ layoutResource ä¸­æ ¹æ® id:com.android.internal.R.id.content è·å–ä¸€ä¸ª ViewGroup å¹¶èµ‹å€¼ç»™ contentParent  å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ViewGroup</span> <span class=n>contentParent</span> <span class=o>=</span> <span class=o>(</span><span class=n>ViewGroup</span><span class=o>)</span><span class=n>findViewById</span><span class=o>(</span><span class=n>ID_ANDROID_CONTENT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>contentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Window couldn&#39;t find content container view&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>mDecor</span><span class=o>.</span><span class=na>finishChanging</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è¿”å› contentParent
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>contentParent</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DecorView çš„ onResourcesLoaded() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>onResourcesLoaded</span><span class=o>(</span><span class=n>LayoutInflater</span> <span class=n>inflater</span><span class=o>,</span> <span class=kt>int</span> <span class=n>layoutResource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>mDecorCaptionView</span> <span class=o>=</span> <span class=n>createDecorCaptionView</span><span class=o>(</span><span class=n>inflater</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è§£æ layoutResource æ–‡ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>View</span> <span class=n>root</span> <span class=o>=</span> <span class=n>inflater</span><span class=o>.</span><span class=na>inflate</span><span class=o>(</span><span class=n>layoutResource</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mDecorCaptionView</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ä½œä¸ºæ ¹å¸ƒå±€æ·»åŠ åˆ° mDecor ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>addView</span><span class=o>(</span><span class=n>root</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=k>new</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>(</span><span class=n>MATCH_PARENT</span><span class=o>,</span> <span class=n>MATCH_PARENT</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mContentRoot</span> <span class=o>=</span> <span class=o>(</span><span class=n>ViewGroup</span><span class=o>)</span> <span class=n>root</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>initializeElevation</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒgenerateLayout() æ–¹æ³•ä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>é¦–å…ˆä¼šé€šè¿‡ com.android.internal.R.styleable.Window ä¸­è®¾ç½®çš„å„ç§å±æ€§å¯¹ Window è¿›è¡Œå„ requestFeature æˆ–è€… setFlags ç­‰æ“ä½œã€‚</li><li>æ¥ä¸‹æ¥æ˜¯æ ¹æ®è®¾å®šå¥½çš„ features å€¼é€‰æ‹©ä¸åŒçš„çª—å£ä¿®é¥°å¸ƒå±€æ–‡ä»¶ï¼Œå¾—åˆ° layoutResource å€¼ã€‚</li></ol><blockquote><p>å› æ­¤åœ¨è‡ªå·±çš„ Activity ä¸­è®¾ç½®å…¨å±çš„ requestFeature() ç­‰æ–¹æ³•ä¹Ÿéœ€è¦åœ¨ setContentView ä¹‹å‰è°ƒç”¨ï¼Œæ‰èƒ½å¤Ÿæ ¹æ®ä½ çš„è®¾ç½®æ¥é€‰æ‹©ä¸åŒçš„æ ¹å¸ƒå±€ã€‚</p></blockquote><ol start=3><li>å°† layoutResource å€¼ä¼ ç»™ DecorView çš„ onResourcesLoaded() æ–¹æ³•ï¼Œé€šè¿‡ LayoutInflater æŠŠå¸ƒå±€è½¬åŒ–æˆ View ä½œä¸ºæ ¹è§†å›¾å¹¶å°†å…¶æ·»åŠ åˆ° mDecorã€‚</li><li>åœ¨ mDecor ä¸­æŸ¥æ‰¾ id ä¸º com.android.internal.R.id.content çš„ ViewGroup å¹¶ä½œä¸ºè¿”å›å€¼è¿”å›ï¼Œè¿™ä¸ª ViewGroup ä¸€èˆ¬ä¸º FrameLayoutã€‚</li></ol><p>å…³äºç¬¬å››ç‚¹ï¼Œå¯èƒ½æœ‰äººä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæ ¹æ® id ä¸º com.android.internal.R.id.content å°±ä¸€å®šèƒ½æ‰¾åˆ°å¯¹åº”çš„ ViewGroupï¼Ÿç­”æ¡ˆå°±åœ¨å‰é¢æˆ‘ä»¬åˆ†æè¿‡çš„ generateLayout() æ–¹æ³•ä¸­ï¼Œè¿™é‡Œä¼šæ ¹æ®è®¾å®šå¥½çš„ features å€¼è·å–ç›¸åº”çš„å¸ƒå±€æ–‡ä»¶å¹¶èµ‹å€¼ç»™ layoutResourceï¼Œè€Œè¿™æ‰€æœ‰çš„å¸ƒå±€æ–‡ä»¶ä¸­éƒ½åŒ…æ‹¬äº†ä¸€ä¸ª id ä¸º content çš„ FrameLayoutï¼Œé™¤æ­¤ä¹‹å¤–æœ‰äº›å¸ƒå±€æ–‡ä»¶ä¸­è¿˜å¯èƒ½æœ‰ ActiionBar å’Œ Title ç­‰ï¼Œè¿™äº›å¸ƒå±€æ–‡ä»¶å­˜æ”¾äº [è¯¥ç›®å½•ä¸‹](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/res/res/layout/)ã€‚ä»¥ R.layout.screen_simple ä¸ºä¾‹ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;LinearLayout</span> <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:fitsSystemWindows=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:orientation=</span><span class=s>&#34;vertical&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ViewStub</span> <span class=na>android:id=</span><span class=s>&#34;@+id/action_mode_bar_stub&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:inflatedId=</span><span class=s>&#34;@+id/action_mode_bar&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:layout=</span><span class=s>&#34;@layout/action_mode_bar&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>android:theme=</span><span class=s>&#34;?attr/actionBarTheme&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;FrameLayout</span>
</span></span><span class=line><span class=cl>         <span class=na>android:id=</span><span class=s>&#34;@android:id/content&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:foregroundInsidePadding=</span><span class=s>&#34;false&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:foregroundGravity=</span><span class=s>&#34;fill_horizontal|top&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>android:foreground=</span><span class=s>&#34;?android:attr/windowContentOverlay&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/LinearLayout&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>å›åˆ° PhoneWindow çš„ setContentView() æ–¹æ³•ï¼Œæ‰§è¡Œå®Œ installDecor() ä¹‹åï¼ŒmDecor è¢«åˆå§‹åŒ–äº†ï¼ŒåŒæ—¶ mContentParent ä¹Ÿè¢«èµ‹äº†å€¼ï¼Œ å›åˆ° setContentView() æ–¹æ³•ï¼Œæœ€åä¸€ä¸ªé‡è¦æ­¥éª¤å°±æ˜¯é€šè¿‡ mLayoutInflater.inflater å°†æˆ‘ä»¬çš„ layout å¸ƒå±€æ–‡ä»¶å‹å…¥ mDecor ä¸­ id ä¸º content çš„ FrameLayout ä¸­ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setContentView</span><span class=o>(</span><span class=kt>int</span> <span class=n>layoutResID</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mContentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span><span class=c1>// æ˜¯å¦é¦–æ¬¡è°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// åˆå§‹åŒ– Decor
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>installDecor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>hasFeature</span><span class=o>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=o>))</span> <span class=o>{</span><span class=c1>// è½¬åœºåŠ¨ç”»ï¼Œé»˜è®¤ false
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mContentParent</span><span class=o>.</span><span class=na>removeAllViews</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>hasFeature</span><span class=o>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è§£æå¸ƒå±€æ–‡ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mLayoutInflater</span><span class=o>.</span><span class=na>inflate</span><span class=o>(</span><span class=n>layoutResID</span><span class=o>,</span> <span class=n>mContentParent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#å°ç»“><h2 id=å°ç»“><span class=hanchor arialabel=Anchor># </span>å°ç»“</h2></a><p>è‡³æ­¤ï¼ŒsetContentView() æ–¹æ³•çš„æµç¨‹å°±èµ°å®Œäº†ï¼Œæ€»ä½“æ¥çœ‹åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>åˆå§‹åŒ– mDecorï¼Œå®ƒæ˜¯ DecorView ç±»çš„å®ä¾‹ï¼ŒDecorView ç»§æ‰¿è‡ª FrameLayoutï¼›</li><li>æ ¹æ® theme ä¸­çš„å±æ€§å€¼ï¼Œé€‰æ‹©ç›¸åº”çš„å¸ƒå±€æ–‡ä»¶å¹¶é€šè¿‡ infalter.inflater() æ–¹æ³•å°†å®ƒåŠ è½½å‡ºæ¥å¹¶ add åˆ° mDecor ä¸­ï¼›è¿™äº›å¸ƒå±€æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª id ä¸º content çš„ FrameLayoutï¼›</li><li>åœ¨ Activity çš„ setContentView() æ–¹æ³•ä¸­è®¾ç½®çš„ layout å¸ƒå±€æ–‡ä»¶ï¼Œä¼šé€šè¿‡ mLayoutInflater.inflater() å‹å…¥ mDecor ä¸­ id ä¸º content çš„ FrameLayout ä¸­ã€‚</li></ol><p>è¿™ä¸ªè¿‡ç¨‹çš„æ—¶åºå›¾å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045625.png width=auto alt></p><p>Activityã€PhoneWindowã€DecorView å’Œ ContentView çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045628.png width=auto alt></p><p>ä½†æ˜¯ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„å¸ƒå±€è¿˜æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ï¼Œæ¥ç€å¾€ä¸‹çœ‹ã€‚</p><a href=#ä¸‰åˆå§‹åŒ–-viewrootimpl-å¹¶å…³è”-decorview><h1 id=ä¸‰åˆå§‹åŒ–-viewrootimpl-å¹¶å…³è”-decorview><span class=hanchor arialabel=Anchor># </span>ä¸‰ï¼šåˆå§‹åŒ– ViewRootImpl å¹¶å…³è” DecorView</h1></a><a href=#æºç åˆ†æ-1><h2 id=æºç åˆ†æ-1><span class=hanchor arialabel=Anchor># </span>æºç åˆ†æ</h2></a><p>åœ¨å¼€ç¯‡çš„æ—¶åºå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒActivityThread åœ¨ handleLaunchActivity() æ–¹æ³•ä¸­çš„ performLaunchActivity() æ“ä½œé—´æ¥è°ƒç”¨äº† Activity çš„ attach() å’Œ onCreate()ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleLaunchActivity</span><span class=o>(</span><span class=n>ActivityClientRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>customIntent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>WindowManagerGlobal</span><span class=o>.</span><span class=na>initialize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰§è¡Œ performLaunchActivity æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Activity</span> <span class=n>a</span> <span class=o>=</span> <span class=n>performLaunchActivity</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>customIntent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=na>createdConfig</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>mConfiguration</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Bundle</span> <span class=n>oldState</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ‰§è¡Œ handleResumeActivity æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ onStart å’Œ onResume æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>handleResumeActivity</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>isForward</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>startsNotResumed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>startsNotResumed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mCalled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callActivityOnPause</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>paused</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åœæ­¢è¯¥ Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>finishActivity</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥ç€ä¼šè°ƒç”¨ handleResumeActivity() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>handleResumeActivity</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>clearHide</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isForward</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>reallyResume</span><span class=o>,</span> <span class=kt>int</span> <span class=n>seq</span><span class=o>,</span> <span class=n>String</span> <span class=n>reason</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ActivityClientRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=n>mActivities</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>token</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æœ€ç»ˆä¼šè°ƒç”¨ onStart() å’Œ onResume() ç­‰æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>r</span> <span class=o>=</span> <span class=n>performResumeActivity</span><span class=o>(</span><span class=n>token</span><span class=o>,</span> <span class=n>clearHide</span><span class=o>,</span> <span class=n>reason</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>r</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Activity</span> <span class=n>a</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>window</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>a</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>willBeVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>window</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>getWindow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è·å– DecorView 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>View</span> <span class=n>decor</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>window</span><span class=o>.</span><span class=na>getDecorView</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å°† DecorView è®¾ç½®æˆä¸å¯è§
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>decor</span><span class=o>.</span><span class=na>setVisibility</span><span class=o>(</span><span class=n>View</span><span class=o>.</span><span class=na>INVISIBLE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è·å– ViewManagerï¼Œè¿™é‡Œæ˜¯ WindowManagerImpl å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ViewManager</span> <span class=n>wm</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=na>getWindowManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>l</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>window</span><span class=o>.</span><span class=na>getAttributes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span><span class=o>.</span><span class=na>mDecor</span> <span class=o>=</span> <span class=n>decor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>l</span><span class=o>.</span><span class=na>type</span> <span class=o>=</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>TYPE_BASE_APPLICATION</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>l</span><span class=o>.</span><span class=na>softInputMode</span> <span class=o>|=</span> <span class=n>forwardBit</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>a</span><span class=o>.</span><span class=na>mVisibleFromClient</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>a</span><span class=o>.</span><span class=na>mWindowAdded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// æ ‡è®°è®¾ç½®ä¸º true
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>a</span><span class=o>.</span><span class=na>mWindowAdded</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è°ƒç”¨ WindowManagerImpl çš„ addView æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>wm</span><span class=o>.</span><span class=na>addView</span><span class=o>(</span><span class=n>decor</span><span class=o>,</span> <span class=n>l</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> 
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>willBeVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>willBeVisible</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mDecor</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>hideForNow</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mVisibleFromClient</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è°ƒç”¨ makeVisible æ–¹æ³•å°† DecorView è®¾ç½®ä¸ºå¯è§
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>makeVisible</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// åœ¨æ­¤è¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œåˆ™ç›´æ¥æ€æ­» Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>finishActivity</span><span class=o>(</span><span class=n>token</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>Activity</span><span class=o>.</span><span class=na>DONT_FINISH_TASK_WITH_ACTIVITY</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>ex</span><span class=o>.</span><span class=na>rethrowFromSystemServer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œå®Œ performResumeActivity() æ–¹æ³•ä¹‹åï¼Œæ¥ç€ä¼šå–å‡º ActivityClientRecord ä¸­çš„ Activity å¯¹è±¡ï¼Œå¹¶å¾—åˆ°ä¹‹å‰åœ¨ setContentView æµç¨‹ä¸­åˆå§‹åŒ–å¥½çš„ DecorView å¯¹è±¡ï¼Œç„¶åä¼šå°†å®ƒä½œä¸ºå‚æ•°ä¼ å…¥ ViewManager ç±»å‹çš„å¯¹è±¡ wm çš„ addView æ–¹æ³•ï¼ŒViewManager æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå®ƒæ˜¯ç”±è°æ¥å®ç°çš„å‘¢ï¼Ÿ</p><p>å…¶å®è¿™å°±æ˜¯æ–‡ç« å¼€å¤´éƒ¨åˆ†æåˆ°è¿‡çš„ï¼Œåœ¨ Activity çš„ attach() æ–¹æ³•ä¸­ï¼Œä¼šåˆå§‹åŒ– PhoneWindow å’Œ WindowManager å¯¹è±¡ï¼Œè€Œè¿™ä¸ª WindowManager å¯¹è±¡åˆ™æ˜¯ç”± WindowManagerImpl æ¥å®ç°çš„ã€‚</p><p>æ‰€ä»¥ï¼ŒActivity çš„ getWindowManager() æ­¤æ—¶è·å–åˆ°çš„å°±æ˜¯ WindowManagerImpl å¯¹è±¡çš„å®ä¾‹ï¼Œå†çœ‹å®ƒçš„ addView() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>addView</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>applyDefaultToken</span><span class=o>(</span><span class=n>params</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mGlobal æ˜¯ WindowManagerGlobal å¯¹è±¡çš„å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mGlobal</span><span class=o>.</span><span class=na>addView</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>params</span><span class=o>,</span> <span class=n>mContext</span><span class=o>.</span><span class=na>getDisplay</span><span class=o>(),</span> <span class=n>mParentWindow</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå°†ä»»åŠ¡å§”æ‰˜ç»™äº† mGlobal ï¼Œè€Œå®ƒåˆæ˜¯ WindowManagerGlobal å¯¹è±¡çš„å®ä¾‹ï¼ŒæŸ¥çœ‹å®ƒçš„ addView() æ–¹æ³•ï¼š</p><p><a href=https://android.googlesource.com/platform/frameworks/base/+/refs/heads/nougat-release/core/java/android/view/WindowManagerGlobal.java rel=noopener>core/java/android/view/WindowManagerGlobal.java</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>addView</span><span class=o>(</span><span class=n>View</span> <span class=n>view</span><span class=o>,</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Display</span> <span class=n>display</span><span class=o>,</span> <span class=n>Window</span> <span class=n>parentWindow</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>wparams</span> <span class=o>=</span> <span class=o>(</span><span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>)</span> <span class=n>params</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>parentWindow</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>parentWindow</span><span class=o>.</span><span class=na>adjustLayoutParamsForSubWindow</span><span class=o>(</span><span class=n>wparams</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If there&#39;s no parent, then hardware acceleration for this view is
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// set from the application&#39;s hardware acceleration setting.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>final</span> <span class=n>Context</span> <span class=n>context</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationInfo</span><span class=o>().</span><span class=na>flags</span>
</span></span><span class=line><span class=cl>                    <span class=o>&amp;</span> <span class=n>ApplicationInfo</span><span class=o>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>wparams</span><span class=o>.</span><span class=na>flags</span> <span class=o>|=</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=n>ViewRootImpl</span> <span class=n>root</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>View</span> <span class=n>panelParentView</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>mLock</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åˆ›å»º ViewRootImpl
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>root</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ViewRootImpl</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>(),</span> <span class=n>display</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>view</span><span class=o>.</span><span class=na>setLayoutParams</span><span class=o>(</span><span class=n>wparams</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mViews</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mRoots</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>root</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mParams</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>wparams</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å°†ä¼ è¿‡æ¥çš„ DecorView æ·»åŠ åˆ° ViewRootImpl ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>root</span><span class=o>.</span><span class=na>setView</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>wparams</span><span class=o>,</span> <span class=n>panelParentView</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„å˜é‡ä¸­ï¼ŒmViews å­˜å‚¨çš„æ˜¯æ‰€æœ‰ Window å¯¹åº”çš„ Viewï¼ŒmRoots å­˜å‚¨çš„æ˜¯æ‰€æœ‰ Window å¯¹åº”çš„ ViewRootImpl å¯¹è±¡ï¼ŒmParams å­˜å‚¨çš„æ˜¯æ‰€æœ‰ Window å¯¹åº”çš„å¸ƒå±€å‚æ•°ã€‚</p><a href=#å°ç»“-1><h2 id=å°ç»“-1><span class=hanchor arialabel=Anchor># </span>å°ç»“</h2></a><p>å¯ä»¥çœ‹åˆ°ï¼ŒViewRootImpl æ˜¯ DecorView çš„ç®¡ç†è€…ï¼Œå®ƒè´Ÿè´£ View Tree çš„æµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶ï¼Œä»¥åŠåé¢ä¼šè¯´åˆ°çš„é€šè¿‡ Choreographer æ¥æ§åˆ¶ View Tree çš„åˆ·æ–°æ“ä½œã€‚</p><a href=#å››å»ºç«‹-phonewindow-å’Œ-windowmanagerservice-ä¹‹é—´çš„è¿æ¥><h1 id=å››å»ºç«‹-phonewindow-å’Œ-windowmanagerservice-ä¹‹é—´çš„è¿æ¥><span class=hanchor arialabel=Anchor># </span>å››ï¼šå»ºç«‹ PhoneWindow å’Œ WindowManagerService ä¹‹é—´çš„è¿æ¥</h1></a><p>WMS æ˜¯æ‰€æœ‰ Window çª—å£çš„ç®¡ç†å‘˜ï¼Œè´Ÿè´£ Window çš„æ·»åŠ å’Œåˆ é™¤ã€Surface çš„ç®¡ç†å’Œäº‹ä»¶çš„æ´¾å‘ç­‰ç­‰ï¼Œå› æ­¤æ¯ä¸€ä¸ª Activity ä¸­çš„ PhoneWindow å¯¹è±¡å¦‚æœéœ€è¦æ˜¾ç¤ºç­‰æ“ä½œï¼Œå°±å¿…é¡»é€šè¿‡ä¸ WMS çš„äº¤äº’æ‰èƒ½è¿›è¡Œã€‚</p><a href=#æºç åˆ†æ-2><h2 id=æºç åˆ†æ-2><span class=hanchor arialabel=Anchor># </span>æºç åˆ†æ</h2></a><p>æ¥ç€ä¸Šä¸€ä¸ªæ­¥éª¤çš„æµç¨‹ï¼ŒæŸ¥çœ‹ ViewRootImpl çš„ setView æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setView</span><span class=o>(</span><span class=n>View</span> <span class=n>view</span><span class=o>,</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>attrs</span><span class=o>,</span> <span class=n>View</span> <span class=n>panelParentView</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mView</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mView</span> <span class=o>=</span> <span class=n>view</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>requestLayout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=o>...</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>res</span> <span class=o>=</span> <span class=n>mWindowSession</span><span class=o>.</span><span class=na>addToDisplay</span><span class=o>(</span><span class=n>mWindow</span><span class=o>,</span> <span class=n>mSeq</span><span class=o>,</span> <span class=n>mWindowAttributes</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>getHostVisibility</span><span class=o>(),</span> <span class=n>mDisplay</span><span class=o>.</span><span class=na>getDisplayId</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                      <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mContentInsets</span><span class=o>,</span> <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mStableInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mOutsets</span><span class=o>,</span> <span class=n>mInputChannel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>restore</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>attrs</span><span class=o>.</span><span class=na>restore</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=n>view</span><span class=o>.</span><span class=na>assignParent</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¿½ç•¥ requestLayout æ–¹æ³•ï¼Œå…ˆçœ‹æ³¨é‡Š 2 å¤„ï¼šè¿™é‡Œè°ƒç”¨äº† mWindowSession.addToDisplay() æ–¹æ³•æ¥å®Œæˆæœ€ç»ˆçš„æ·»åŠ æµç¨‹ï¼ŒmWindowSession ä¸º IWindowSession çš„å®ä¾‹ï¼Œè€Œ IWindowSession æ˜¯ä¸€ä¸ª Binder çš„ Client ä»£ç†å¯¹è±¡ï¼Œå¯¹åº”çš„ Server ç«¯çš„å®ç°ä¸º Session ç±»ã€‚åœ¨è¿™ä¹‹å‰ä»£ç éƒ½æ˜¯è¿è¡Œåœ¨ app è¿›ç¨‹çš„ï¼Œè€Œ Session åˆ™æ˜¯è¿è¡Œåœ¨ WMS æ‰€åœ¨çš„è¿›ç¨‹ï¼ˆå³ SystemServer è¿›ç¨‹ï¼‰ä¸­ã€‚</p><p>å¦‚æ­¤ï¼Œå¾€ Window ä¸­æ·»åŠ  View çš„æµç¨‹å°±äº¤ç»™ WindowManagerService å»å¤„ç†äº†ï¼Œapp è¿›ç¨‹çš„ ViewRootImpl è¦æƒ³å’Œ WMS é€šè®¯åˆ™éœ€è¦å€ŸåŠ© Binder æœºåˆ¶å¹¶é€šè¿‡ Session æ¥è¿›è¡Œæ“ä½œã€‚Session çš„ addToDisplay() æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>[services/core/java/com/android/server/wm/Session.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /refs/heads/nougat-release/services/core/java/com/android/server/wm/Session.java)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>int</span> <span class=nf>addToDisplay</span><span class=o>(</span><span class=n>IWindow</span> <span class=n>window</span><span class=o>,</span> <span class=kt>int</span> <span class=n>seq</span><span class=o>,</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>attrs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=kt>int</span> <span class=n>displayId</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outContentInsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outStableInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Rect</span> <span class=n>outOutsets</span><span class=o>,</span> <span class=n>InputChannel</span> <span class=n>outInputChannel</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mService</span><span class=o>.</span><span class=na>addWindow</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>window</span><span class=o>,</span> <span class=n>seq</span><span class=o>,</span> <span class=n>attrs</span><span class=o>,</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=n>displayId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>outContentInsets</span><span class=o>,</span> <span class=n>outStableInsets</span><span class=o>,</span> <span class=n>outOutsets</span><span class=o>,</span> <span class=n>outInputChannel</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè°ƒç”¨äº† WMS çš„ addWindow() æ–¹æ³•å¹¶å°†è‡ªèº«ä½œä¸ºå‚æ•°ä¼ äº†è¿›å»ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šå¯¹åº”ä¸€ä¸ª Sessionï¼ŒWMS ä¼šç”¨ä¸€ä¸ª List æ¥ä¿å­˜è¿™äº› Sessionã€‚æ¥ç€ WMS ä¼šä¸ºè¿™ä¸ªæ·»åŠ çš„çª—å£åˆ†é… Surfaceï¼Œå¹¶ç¡®å®šçª—å£æ˜¾ç¤ºæ¬¡åºï¼Œå› æ­¤è´Ÿè´£æ˜¾ç¤ºç•Œé¢çš„æ˜¯ç”»å¸ƒ Surfaceï¼Œè€Œä¸æ˜¯çª—å£æœ¬èº«ã€‚WMS ä¼šå°†å®ƒç®¡ç†çš„ Surface äº¤ç”± SurfaceFlinger å¤„ç†ï¼ŒSurfaceFlinger ä¼šå°†è¿™äº› Surface æ··åˆå¹¶ç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚</p><p>å…³äº WMS çš„è¯¦ç»†åˆ†æä¼šåœ¨åç»­çš„æ–‡ç« ä¸­è¿›è¡Œã€‚</p><p>è¿™ä¸ªæ˜¯ä¸€ä¸ªå…¸å‹çš„ Binder åŒå‘é€šè®¯æ¨¡å‹ï¼ŒBinder æœºåˆ¶çš„æ–‡ç« å¯å‚è€ƒ
<a href=https://www.jianshu.com/p/73e351d25773 rel=noopener>å€ŸåŠ© AIDL ç†è§£ Android Binder æœºåˆ¶</a>ã€‚è¿™ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045637.png width=auto alt></p><a href=#å°ç»“-2><h2 id=å°ç»“-2><span class=hanchor arialabel=Anchor># </span>å°ç»“</h2></a><p>ç”¨ä¸€å¼ å›¾æ€»ç»“ Activityã€Window å’Œ WMS ä¹‹é—´çš„å…³ç³»ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045640.png width=auto alt></p><a href=#äº”å»ºç«‹ä¸-surfaceflinger-çš„è¿æ¥><h1 id=äº”å»ºç«‹ä¸-surfaceflinger-çš„è¿æ¥><span class=hanchor arialabel=Anchor># </span>äº”ï¼šå»ºç«‹ä¸ SurfaceFlinger çš„è¿æ¥</h1></a><p>SurfaceFlinger æ˜¯ Android æœ€é‡è¦çš„ç³»ç»ŸæœåŠ¡ä¹‹ä¸€ï¼Œå®ƒçš„èŒè´£ä¸»è¦æ˜¯è¿›è¡Œ Layer(Surface åœ¨ Native å«æ³•) çš„åˆæˆå’Œæ¸²æŸ“ã€‚</p><a href=#æºç åˆ†æ-3><h2 id=æºç åˆ†æ-3><span class=hanchor arialabel=Anchor># </span>æºç åˆ†æ</h2></a><p>æ¥ä¸Šé¢çš„æ­¥éª¤ï¼ŒWindowState çš„ attach() æ–¹æ³•å°†ä¼šè°ƒç”¨åˆ° Session çš„ windowAddedLocked() æ–¹æ³•ï¼š</p><p>[services/core/java/com/android/server/wm/WindowState.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /refs/heads/nougat-release/services/core/java/com/android/server/wm/WindowState.java)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>attach</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>WindowManagerService</span><span class=o>.</span><span class=na>localLOGV</span><span class=o>)</span> <span class=n>Slog</span><span class=o>.</span><span class=na>v</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Attaching &#34;</span> <span class=o>+</span> <span class=k>this</span> <span class=o>+</span> <span class=s>&#34; token=&#34;</span> <span class=o>+</span> <span class=n>mToken</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=s>&#34;, list=&#34;</span> <span class=o>+</span> <span class=n>mToken</span><span class=o>.</span><span class=na>windows</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mSession</span><span class=o>.</span><span class=na>windowAddedLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Session.java</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>windowAddedLocked</span><span class=o>(</span><span class=n>String</span> <span class=n>packageName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mSurfaceSession</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span> 
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>mSurfaceSession</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SurfaceSession</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>SurfaceSession</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mNativeClient</span><span class=o>;</span> <span class=c1>// SurfaceComposerClient*
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>native</span> <span class=kt>long</span> <span class=nf>nativeCreate</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SurfaceSession</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mNativeClient</span> <span class=o>=</span> <span class=n>nativeCreate</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>nativeCreate() æ–¹æ³•æ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼š</p><p>[core/jni/android_view_SurfaceSession.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /refs/heads/nougat-release/core/jni/android_view_SurfaceSession.cpp)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>static</span> <span class=n>jlong</span> <span class=nf>nativeCreate</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>,</span> <span class=n>jclass</span> <span class=n>clazz</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SurfaceComposerClient</span><span class=o>*</span> <span class=n>client</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SurfaceComposerClient</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>-&gt;</span><span class=n>incStrong</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>nativeCreate</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>jlong</span><span class=o>&gt;</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>nativeCreate æ–¹æ³•ä¸»è¦æ„é€ äº†ä¸€ä¸ª SurfaceComposerClient å¯¹è±¡ï¼Œå®ƒæ˜¯åº”ç”¨ç¨‹åºä¸ SurfaceFlinger æ²Ÿé€šçš„æ¡¥æ¢ï¼ŒSurfaceComposerClient æŒ‡é’ˆåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™ä¼šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=n>SurfaceComposerClient</span><span class=o>::</span><span class=n>onFirstRef</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>....</span>
</span></span><span class=line><span class=cl>    <span class=n>sp</span><span class=o>&lt;</span><span class=n>ISurfaceComposerClient</span><span class=o>&gt;</span> <span class=n>conn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// sf å°±æ˜¯ SurfaceFlinger å¯¹è±¡æŒ‡é’ˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>conn</span> <span class=o>=</span> <span class=p>(</span><span class=n>rootProducer</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>)</span> <span class=o>?</span> <span class=n>sf</span><span class=o>-&gt;</span><span class=n>createScopedConnection</span><span class=p>(</span><span class=n>rootProducer</span><span class=p>)</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sf</span><span class=o>-&gt;</span><span class=n>createConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®ƒé€šè¿‡ SurfaceFlinger çš„ createScopedConnection æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ª ISurfaceComposerClient å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>SurfaceFlinger</span><span class=p>.</span><span class=n>cpp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sp</span><span class=o>&lt;</span><span class=n>ISurfaceComposerClient</span><span class=o>&gt;</span> <span class=n>SurfaceFlinger</span><span class=o>::</span><span class=n>createConnection</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>initClient</span><span class=p>(</span><span class=k>new</span> <span class=n>Client</span><span class=p>(</span><span class=k>this</span><span class=p>));</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>ISurfaceComposerClient</span><span class=o>&gt;</span> <span class=n>initClient</span><span class=p>(</span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>Client</span><span class=o>&gt;&amp;</span> <span class=n>client</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>status_t</span> <span class=n>err</span> <span class=o>=</span> <span class=n>client</span><span class=o>-&gt;</span><span class=n>initCheck</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åªæ˜¯åšäº†é”™è¯¯æ£€æŸ¥ï¼Œç„¶åè¿”å› client æœ¬èº«
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>==</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>client</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Client ç±»å®ç°äº† ISurfaceComposerClient(ç»§æ‰¿äº† IInterface) æ¥å£ï¼Œå› æ­¤å®ƒå¯ä»¥è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ï¼ŒSurfaceComposerClient å°±æ˜¯é€šè¿‡å®ƒæ¥å’Œ SurfaceFlinger é€šä¿¡ã€‚é™¤æ­¤ä¹‹å¤–å®ƒè¿˜å¯ä»¥åˆ›å»º Surfaceï¼Œå¹¶ä¸”ç»´æŠ¤ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„æ‰€æœ‰ Layerã€‚</p><p>initClicent æ–¹æ³•åšäº†ä¸€äº›é”™è¯¯æ£€æŸ¥ï¼Œç„¶åè¿”å› Client æœ¬èº«ã€‚</p><a href=#å°ç»“-3><h2 id=å°ç»“-3><span class=hanchor arialabel=Anchor># </span>å°ç»“</h2></a><p>è¿™ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045645.png width=auto alt></p><a href=#å…­ç”³è¯·-surface><h1 id=å…­ç”³è¯·-surface><span class=hanchor arialabel=Anchor># </span>å…­ï¼šç”³è¯· Surface</h1></a><p>ç»è¿‡æ­¥éª¤å››å’Œæ­¥éª¤äº”ï¼ŒViewRootImpl ä¸ WMSã€SurfaceFlinger éƒ½å·²ç»å»ºç«‹è¿æ¥ï¼Œä½†æ˜¯è¿™æ—¶ View è¿˜æ˜¯æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ‰€æœ‰çš„ UI æœ€ç»ˆéƒ½æ˜¯è¦é€šè¿‡ Surface æ¥æ˜¾ç¤ºçš„ï¼Œé‚£ä¹ˆ Surface æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„å‘¢ï¼Ÿå›åˆ°æ­¥éª¤å››å¼€å¤´éƒ¨åˆ† ViewRootImpl çš„ setView æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setView</span><span class=o>(</span><span class=n>View</span> <span class=n>view</span><span class=o>,</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>attrs</span><span class=o>,</span> <span class=n>View</span> <span class=n>panelParentView</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mView</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mView</span> <span class=o>=</span> <span class=n>view</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Schedule the first layout -before- adding to the window
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// manager, to make sure we do the relayout before receiving
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// any other events from the system.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>requestLayout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=o>...</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span> <span class=o>=</span> <span class=n>mWindowSession</span><span class=o>.</span><span class=na>addToDisplay</span><span class=o>(</span><span class=n>mWindow</span><span class=o>,</span> <span class=n>mSeq</span><span class=o>,</span> <span class=n>mWindowAttributes</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>getHostVisibility</span><span class=o>(),</span> <span class=n>mDisplay</span><span class=o>.</span><span class=na>getDisplayId</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                        <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mContentInsets</span><span class=o>,</span> <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mStableInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mOutsets</span><span class=o>,</span> <span class=n>mInputChannel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> 
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ³¨é‡Šå¤„ä¿ç•™äº†å®˜æ–¹åŸæ–‡ï¼Œæ„æ€å¤§æ¦‚æ˜¯ WMS é™¤äº†çª—å£ç®¡ç†ï¼Œè¿˜éœ€è¦å¤„ç†äº‹ä»¶æ´¾å‘ï¼Œå› æ­¤åœ¨ä¸ WMS è¿›è¡Œå…³è”ä¹‹å‰ï¼Œè¦ç¡®ä¿ View Tree å·²ç»è¿›è¡Œäº† layout æ“ä½œï¼Œä»¥æ¥æ”¶æ¥è‡ª WMS çš„äº‹ä»¶ã€‚</p><p>è·Ÿè¸ª ViewRootImpl çš„ requestLayout() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>requestLayout</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>mHandlingLayoutInLayoutRequest</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>checkThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>mLayoutRequested</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>scheduleTraversals</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>scheduleTraversals() æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>scheduleTraversals</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>mTraversalScheduled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mTraversalScheduled</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è®¾ç½®åŒæ­¥éšœç¢ï¼Œæš‚åœå¤„ç†åé¢çš„åŒæ­¥æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mTraversalBarrier</span> <span class=o>=</span> <span class=n>mHandler</span><span class=o>.</span><span class=na>getLooper</span><span class=o>().</span><span class=na>getQueue</span><span class=o>().</span><span class=na>postSyncBarrier</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åœ¨ä¸‹ä¸€å¸§åˆ°æ¥çš„æ—¶å€™æ‰§è¡Œ mTraversalRunnable
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mChoreographer</span><span class=o>.</span><span class=na>postCallback</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>Choreographer</span><span class=o>.</span><span class=na>CALLBACK_TRAVERSAL</span><span class=o>,</span> <span class=n>mTraversalRunnable</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆï¼Œè®¾ç½®åŒæ­¥éšœç¢ï¼Œæš‚åœå¤„ç†åé¢çš„åŒæ­¥æ¶ˆæ¯ï¼Œç„¶ååˆ©ç”¨ Choreographer ç±»åœ¨ä¸‹ä¸€ç»˜åˆ¶å¸§æ¥ä¸´çš„æ—¶å€™æ‰§è¡Œ mTraversalRunnable å¯¹è±¡ï¼ˆå…³äº Choreographer åŸç†ï¼Œå¯æŸ¥çœ‹
<a href=https://blog.csdn.net/yangwen123/article/details/39518923 rel=noopener>Android ç³»ç»Ÿ Choreographer æœºåˆ¶å®ç°è¿‡ç¨‹</a>ï¼‰ã€‚</p><p>ç®€å•åœ°è¯´ï¼ŒChoreographer å†…éƒ¨ä¼šæ¥æ”¶æ¥è‡ª SurfaceFlinger å‘å‡ºçš„ VSync å‚ç›´åŒæ­¥ä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·å‘¨æœŸä¸€èˆ¬ä¸º 16ms å·¦å³ã€‚SurfaceFlinger æ˜¯ç”± init è¿›ç¨‹å¯åŠ¨çš„è¿è¡Œåœ¨åº•å±‚çš„ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼Œå®ƒçš„ä¸»è¦èŒè´£æ˜¯åˆæˆå’Œæ¸²æŸ“ Surface(Layer)ï¼Œå¹¶å‘ç›®æ ‡è¿›ç¨‹å‘é€å‚ç›´åŒæ­¥ä¿¡å· VSyncã€‚å› æ­¤ï¼Œå¦‚æœéœ€è¦æ¥æ”¶ Vsync ä¿¡å·ï¼Œå¿…é¡»å…ˆä¸ SurfaceFlinger å»ºç«‹è¿æ¥ï¼Œè€Œè¿™æ­£æ˜¯å…ˆèµ°æ­¥éª¤äº”æµç¨‹çš„åŸå› ã€‚</p><p>mTraversalRunnable æ˜¯ä¸€ä¸ª Runnable å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kd>class</span> <span class=nc>TraversalRunnable</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>doTraversal</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=n>TraversalRunnable</span> <span class=n>mTraversalRunnable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TraversalRunnable</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>run() æ–¹æ³•é‡Œé¢åªæœ‰ä¸€å¥ä»£ç ï¼ŒdoTraversal() æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>doTraversal</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mTraversalScheduled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mTraversalScheduled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç§»é™¤åŒæ­¥éšœç¢
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mHandler</span><span class=o>.</span><span class=na>getLooper</span><span class=o>().</span><span class=na>getQueue</span><span class=o>().</span><span class=na>removeSyncBarrier</span><span class=o>(</span><span class=n>mTraversalBarrier</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ­£å¼è¿›å…¥ View ç»˜åˆ¶æµç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>performTraversals</span><span class=o>();</span>
</span></span><span class=line><span class=cl>         <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç§»é™¤äº†åŒæ­¥éšœç¢ä¹‹åï¼Œæ‰€æœ‰ç»˜åˆ¶ä¹‹å‰çš„å‡†å¤‡å·¥ä½œå·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œæ¥ä¸‹æ¥ä¼šè°ƒç”¨ performTraversals() æ–¹æ³•æ­£å¼è¿›å…¥ View çš„ç»˜åˆ¶æµç¨‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performTraversals</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>finalView</span> <span class=n>host</span> <span class=o>=</span> <span class=n>mView</span><span class=o>;</span> <span class=c1>// mView å…¶å®å°±æ˜¯ DecorView
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>relayoutWindow</span><span class=o>(</span><span class=n>params</span><span class=o>,</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=n>insetsPending</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰§è¡Œ Measure æµç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performMeasure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰§è¡Œ Layout æµç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performLayout</span><span class=o>(</span><span class=n>lp</span><span class=o>,</span> <span class=n>desiredWindowWidth</span><span class=o>,</span> <span class=n>desiredWindowHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰§è¡Œ Draw æµç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performLayout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è·Ÿè¸ª relayoutWindow æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>relayoutWindow</span><span class=o>(</span><span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=o>,</span> <span class=kt>int</span> <span class=n>viewVisibility</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>insetsPending</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>relayoutResult</span> <span class=o>=</span> <span class=n>mWindowSession</span><span class=o>.</span><span class=na>relayout</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>mWindow</span><span class=o>,</span> <span class=n>mSeq</span><span class=o>,</span> <span class=n>params</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>mView</span><span class=o>.</span><span class=na>getMeasuredWidth</span><span class=o>()</span> <span class=o>*</span> <span class=n>appScale</span> <span class=o>+</span> <span class=n>0</span><span class=o>.</span><span class=na>5f</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>mView</span><span class=o>.</span><span class=na>getMeasuredHeight</span><span class=o>()</span> <span class=o>*</span> <span class=n>appScale</span> <span class=o>+</span> <span class=n>0</span><span class=o>.</span><span class=na>5f</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>viewVisibility</span><span class=o>,</span> <span class=n>insetsPending</span> <span class=o>?</span> <span class=n>WindowManagerGlobal</span><span class=o>.</span><span class=na>RELAYOUT_INSETS_PENDING</span> <span class=o>:</span> <span class=n>0</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mWinFrame</span><span class=o>,</span> <span class=n>mPendingOverscanInsets</span><span class=o>,</span> <span class=n>mPendingContentInsets</span><span class=o>,</span> <span class=n>mPendingVisibleInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPendingStableInsets</span><span class=o>,</span> <span class=n>mPendingOutsets</span><span class=o>,</span> <span class=n>mPendingBackDropFrame</span><span class=o>,</span> <span class=n>mPendingConfiguration</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mSurface</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œåˆæ˜¯ Binder è°ƒç”¨ï¼ˆå¼ºçƒˆå»ºè®®æŒæ¡ï¼‰ï¼Œå®ƒå°†è°ƒç”¨åˆ° WMS çš„ relayout æ–¹æ³•ï¼Œæ³¨æ„æœ€åä¸€ä¸ªå‚æ•°å°±æ˜¯ SurfaceView å¯¹è±¡ï¼Œå®ƒåœ¨ ViewRootImpl ä¸­å®šä¹‰çš„æ—¶å€™å°±å·²ç»è¿›è¡Œäº†åˆå§‹åŒ–ï¼š</p><p>final Surface mSurface = new Surface();</p><p>å†æ¥çœ‹ WMS çš„ relayoutWindowï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>int</span> <span class=nf>relayoutWindow</span><span class=o>(</span><span class=n>Session</span> <span class=n>session</span><span class=o>,</span> <span class=n>IWindow</span> <span class=n>client</span><span class=o>,</span> <span class=kt>int</span> <span class=n>seq</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>attrs</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestedWidth</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>requestedHeight</span><span class=o>,</span> <span class=kt>int</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Rect</span> <span class=n>outFrame</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outOverscanInsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outContentInsets</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Rect</span> <span class=n>outVisibleInsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outStableInsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outOutsets</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>outBackdropFrame</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Configuration</span> <span class=n>outConfig</span><span class=o>,</span> <span class=n>Surface</span> <span class=n>outSurface</span><span class=o>){</span> 
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>createSurfaceControl</span><span class=o>(</span><span class=n>outSurface</span><span class=o>,</span> <span class=n>result</span><span class=o>,</span> <span class=n>win</span><span class=o>,</span> <span class=n>winAnimator</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>createSurfaceControl</span><span class=o>(</span><span class=n>Surface</span> <span class=n>outSurface</span><span class=o>,</span> <span class=kt>int</span> <span class=n>result</span><span class=o>,</span> <span class=n>WindowState</span> <span class=n>win</span><span class=o>,</span><span class=n>WindowStateAnimator</span> <span class=n>winAnimator</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>surfaceController</span> <span class=o>=</span> <span class=n>winAnimator</span><span class=o>.</span><span class=na>createSurfaceLocked</span><span class=o>(</span><span class=n>win</span><span class=o>.</span><span class=na>mAttrs</span><span class=o>.</span><span class=na>type</span><span class=o>,</span> <span class=n>win</span><span class=o>.</span><span class=na>mOwnerUid</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>surfaceController</span><span class=o>.</span><span class=na>getSurface</span><span class=o>(</span><span class=n>outSurface</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé¦–å…ˆè°ƒç”¨ WindowStateAnimator çš„ createSurfaceLocked ç”Ÿæˆä¸€ä¸ªçœŸæ­£æœ‰æ•ˆçš„ Surface å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯åœ¨ Native å±‚çš„ï¼Œæ¥ç€ getSurface æ–¹æ³•å°† Java å±‚çš„ Surface å¯¹è±¡ä¸å…¶å…³è”èµ·æ¥ã€‚</p><a href=#ä¸ƒæ­£å¼ç»˜åˆ¶-view><h1 id=ä¸ƒæ­£å¼ç»˜åˆ¶-view><span class=hanchor arialabel=Anchor># </span>ä¸ƒï¼šæ­£å¼ç»˜åˆ¶ View</h1></a><p>æ¥ä¸Šä¸€æ­¥éª¤çš„å†…å®¹ï¼Œç”³è¯·äº† Surface ä¹‹åï¼ŒViewRootImpl çš„ performTraversals() æ–¹æ³•å°†ä¼šç»§ç»­æ‰§è¡Œï¼Œè¿™ä¸ªæ–¹æ³•å†…å®¹ç›¸å½“å¤šï¼Œå¿½ç•¥æ¡ä»¶åˆ¤æ–­ï¼Œç²¾ç®€è¿‡åå¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performTraversals</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>relayoutResult</span> <span class=o>=</span> <span class=n>relayoutWindow</span><span class=o>(</span><span class=n>params</span><span class=o>,</span> <span class=n>viewVisibility</span><span class=o>,</span> <span class=n>insetsPending</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>lp</span> <span class=o>=</span> <span class=n>mWindowAttributes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å– DecorView å®½å’Œé«˜çš„ MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>childWidthMeasureSpec</span> <span class=o>=</span> <span class=n>getRootMeasureSpec</span><span class=o>(</span><span class=n>mWidth</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>width</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>childHeightMeasureSpec</span> <span class=o>=</span> <span class=n>getRootMeasureSpec</span><span class=o>(</span><span class=n>mHeight</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰§è¡Œ Measure æµç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performMeasure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰§è¡Œ Layout æµç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performLayout</span><span class=o>(</span><span class=n>lp</span><span class=o>,</span> <span class=n>desiredWindowWidth</span><span class=o>,</span> <span class=n>desiredWindowHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰§è¡Œ Draw æµç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>performLayout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆï¼Œæ ¹æ® getRootMeasureSpec() æ–¹æ³•è·å–åˆ° childWidthMeasureSpec å’Œ childHeightMeasureSpec çš„å€¼ï¼Œç”¨äº DecorView çš„ç»˜åˆ¶ã€‚å› ä¸º DecorView æ˜¯æ‰€æœ‰å­å…ƒç´ çš„æ ¹å…ƒç´ ï¼Œå­å…ƒç´ çš„å¸ƒå±€å±‚å±‚åµŒå¥—ï¼Œå› æ­¤ä¼šæ¥ç€ä» DecorView å¼€å§‹è¿›è¡Œä¸€å±‚å±‚åœ°å¯¹æ‰€æœ‰å­å…ƒç´ è¿›è¡Œæµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶ï¼Œåˆ†åˆ«å¯¹åº” performMeasure()ã€performLayout() å’Œ performLayout() æ–¹æ³•ï¼Œæ•´ä¸ªè¿‡ç¨‹çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045652.png width=auto alt></p><a href=#ç†è§£-measurespec><h2 id=ç†è§£-measurespec><span class=hanchor arialabel=Anchor># </span>ç†è§£ MeasureSpec</h2></a><p>MeasureSpec æ˜¯ View çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ª 32 ä½çš„ int å€¼ï¼Œé‡‡ç”¨å®ƒçš„é«˜ 2 ä½è¡¨ç¤ºä¸‰ç§ SpecModeï¼ˆæµ‹é‡æ¨¡å¼ï¼‰ï¼Œä½ 30 ä½ç”¨æ¥è¡¨ç¤º SpecSizeï¼ˆæŸç§æµ‹é‡æ¨¡å¼ä¸‹çš„è§„æ ¼å¤§å°ï¼‰ã€‚é‡‡ç”¨è¿™ç§è¡¨ç¤ºæ–¹æ³•æ˜¯ä¸ºäº†é¿å…åˆ›å»ºè¿‡å¤šçš„å¯¹è±¡ä»¥å‡å°‘å†…å­˜åˆ†é…ï¼ŒMeasureSpec çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MeasureSpec</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MODE_SHIFT</span> <span class=o>=</span> <span class=n>30</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MODE_MASK</span> <span class=o>=</span> <span class=n>0x3</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸é™å®šæµ‹é‡æ¨¡å¼ï¼šçˆ¶å®¹å™¨ä¸å¯¹ View ä½œä»»ä½•é™åˆ¶ï¼ŒView æƒ³è¦å¤šå¤§ç»™å¤šå¤§ï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// è¿™ç§æ¨¡å¼é€šå¸¸ç”¨äºç³»ç»Ÿå†…éƒ¨ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>UNSPECIFIED</span> <span class=o>=</span> <span class=n>0</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ç²¾ç¡®ä¸º SpecSizeï¼šçˆ¶å®¹å™¨å·²ç»ç¡®å®š View éœ€è¦çš„å¤§å°ï¼Œå°±æ˜¯ SpecSizeï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// å¯¹åº”å¸ƒå±€å‚æ•°æ˜¯ match_parent æˆ–å…·ä½“æ•°å€¼æ—¶çš„æƒ…å†µ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>EXACTLY</span> <span class=o>=</span> <span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æœ€å¤§åªèƒ½æ˜¯ SpecSizeï¼šçˆ¶å®¹å™¨è§„å®š View æœ€å¤§åªèƒ½æ˜¯ SpecSizeï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// å¯¹åº”å¸ƒå±€å‚æ•°æ˜¯ wrap_content æ—¶çš„æƒ…å†µ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>AT_MOST</span> <span class=o>=</span> <span class=n>2</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ® SpecMode å’Œ SpecSize åˆ›å»ºä¸€ä¸ª MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>makeMeasureSpec</span><span class=o>(</span><span class=kt>int</span> <span class=n>size</span><span class=o>,</span> <span class=kt>int</span> <span class=n>mode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>sUseBrokenMakeMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>size</span> <span class=o>+</span> <span class=n>mode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>(</span><span class=n>size</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MODE_MASK</span><span class=o>)</span> <span class=o>|</span> <span class=o>(</span><span class=n>mode</span> <span class=o>&amp;</span> <span class=n>MODE_MASK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// è·å– SpecMode
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getMode</span><span class=o>(</span><span class=kt>int</span> <span class=n>measureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>measureSpec</span> <span class=o>&amp;</span> <span class=n>MODE_MASK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å– SpecSize
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=o>(</span><span class=kt>int</span> <span class=n>measureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>measureSpec</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MODE_MASK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒæ•´ MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kt>int</span> <span class=nf>adjust</span><span class=o>(</span><span class=kt>int</span> <span class=n>measureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>delta</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>mode</span> <span class=o>=</span> <span class=n>getMode</span><span class=o>(</span><span class=n>measureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mode</span> <span class=o>==</span> <span class=n>UNSPECIFIED</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>make</span> <span class=nf>MeasureSpec</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>UNSPECIFIED</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>getSize</span><span class=o>(</span><span class=n>measureSpec</span><span class=o>)</span> <span class=o>+</span> <span class=n>delta</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>size</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>size</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>makeMeasureSpec</span><span class=o>(</span><span class=n>size</span><span class=o>,</span> <span class=n>mode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥ç€çœ‹ getRootMeasureSpec() æ–¹æ³•ï¼Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ•´ä¸ªå±å¹•çš„å®½æˆ–è€…é«˜ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ Window çš„ LayoutParamsï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getRootMeasureSpec</span><span class=o>(</span><span class=kt>int</span> <span class=n>windowSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>rootDimension</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>measureSpec</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>rootDimension</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>MATCH_PARENT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>measureSpec</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>makeMeasureSpec</span><span class=o>(</span><span class=n>windowSize</span><span class=o>,</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>measureSpec</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>makeMeasureSpec</span><span class=o>(</span><span class=n>windowSize</span><span class=o>,</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>measureSpec</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>makeMeasureSpec</span><span class=o>(</span><span class=n>rootDimension</span><span class=o>,</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>measureSpec</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»ä»£ç é€»è¾‘æ¥çœ‹ï¼ŒDecorView çš„ MeasureSpec çš„äº§ç”Ÿéµå¾ªå¦‚ä¸‹è§„å¾‹ï¼š</p><ul><li>LayoutParams = MATCH_PARENTï¼šç²¾ç¡®æ¨¡å¼ï¼Œå¤§å°å°±æ˜¯å±å¹•çš„å®½æˆ–è€…é«˜ï¼›</li><li>LayoutParams = WRAP_CONTENTï¼šæœ€å¤§ä¸èƒ½è¶…è¿‡å±å¹•çš„å®½æˆ–è€…é«˜ï¼›</li><li>å›ºå®šå¤§å°ï¼šç²¾ç¡®æ¨¡å¼ï¼Œå¤§å°ä¸º LayoutParams ä¸­æŒ‡å®šçš„å€¼ã€‚</li></ul><p>ä½†æ˜¯å¯¹äºæ™®é€šçš„ View æ¥è¯´ï¼ŒView çš„ measure() æ–¹æ³•æ˜¯ç”±çˆ¶å®¹å™¨ ViewGroup è°ƒç”¨çš„ï¼Œçœ‹ä¸€ä¸‹ ViewGroup çš„ measureChildWithMargins() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>measureChildWithMargins</span><span class=o>(</span><span class=n>View</span> <span class=n>child</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>parentWidthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>widthUsed</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>parentHeightMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightUsed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å–å­å…ƒç´ çš„å¸ƒå±€å‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>MarginLayoutParams</span> <span class=n>lp</span> <span class=o>=</span> <span class=o>(</span><span class=n>MarginLayoutParams</span><span class=o>)</span> <span class=n>child</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// äº§ç”Ÿå­å…ƒç´ çš„ MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childWidthMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=o>(</span><span class=n>parentWidthMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPaddingLeft</span> <span class=o>+</span> <span class=n>mPaddingRight</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>leftMargin</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>rightMargin</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>widthUsed</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>width</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childHeightMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=o>(</span><span class=n>parentHeightMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPaddingTop</span> <span class=o>+</span> <span class=n>mPaddingBottom</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>bottomMargin</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>heightUsed</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>child</span><span class=o>.</span><span class=na>measure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨è°ƒç”¨å­å…ƒç´  çš„ measure() æ–¹æ³•ä¹‹å‰ï¼Œå…ˆè¦è°ƒç”¨ getChildMeasureSpec() æ–¹æ³•äº§ç”Ÿå­å…ƒç´ çš„ MeasureSpecï¼Œå­å…ƒç´ çš„äº§ç”Ÿé™¤äº†è·Ÿçˆ¶å®¹å™¨çš„ MeasureSpec å’Œå­å…ƒç´ æœ¬èº«çš„ LayoutParams æœ‰å…³ä¹‹å¤–ï¼Œè¿˜ä¸å­å…ƒç´ çš„ Margin å’Œçˆ¶å®¹å™¨çš„ Padding å€¼ä»¥åŠçˆ¶å®¹å™¨å½“å‰å ç”¨ç©ºé—´æœ‰å…³ï¼Œå…·ä½“çš„è¿‡ç¨‹å¯ä»¥çœ‹ getChildMeasureSpec() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getChildMeasureSpec</span><span class=o>(</span><span class=kt>int</span> <span class=n>spec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>padding</span><span class=o>,</span> <span class=kt>int</span> <span class=n>childDimesion</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>specMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getMode</span><span class=o>(</span><span class=n>spec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>specSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>spec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å­å…ƒç´ æœ€å¤§å¯ç”¨ç©ºé—´ä¸ºçˆ¶å®¹å™¨çš„å°ºå¯¸å‡å»çˆ¶å®¹å™¨ä¸­å·²è¢«å ç”¨çš„ç©ºé—´çš„å¤§å°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>specSize</span> <span class=o>-</span> <span class=n>padding</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>resultSize</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>resultMode</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>sepcMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Parent has imposed an exact size on us
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>childDimension</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>MATCH_PARENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to be our size. So be it.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimesion</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to determine its own size. It can&#39;t be
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// bigger than us.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Parent has imposed a maximum size on us 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants a specific size... so be it
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>childDimension</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>MATCH_PARENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to be our size, but our size is not fixed.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// Constrain child to not be bigger than us.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to determine its own size. It can&#39;t be
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// bigger than us.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Parent asked to see how big we want to be
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>UNSPECIFIED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants a specific size... let him have it
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>childDimension</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>MATCH_PARENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to be our size... find out how big it should be
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>UNSPECIFIED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Child wants to determine its own size....
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// find out how big it should be
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>resultSize</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>resultMode</span> <span class=o>==</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>UNSPECIFIED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>makeMeasureSpec</span><span class=o>(</span><span class=n>resultSize</span><span class=o>,</span> <span class=n>resultMode</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ•´ä¸ªè¿‡ç¨‹ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹è¡¨æ ¼ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045658.png width=auto alt></p><a href=#measure-æµç¨‹åˆ†æ><h2 id=measure-æµç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>Measure æµç¨‹åˆ†æ</h2></a><p>å›åˆ° performTraversals() æ–¹æ³•ä¸­ï¼Œè·å–åˆ° DecorView çš„ MeasureSpec åæ¥ç€ä¼šè°ƒç”¨ performMeasure() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>childHeightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>mView</span><span class=o>.</span><span class=na>measure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>mView å°±æ˜¯ä¹‹å‰é€šè¿‡ setView() æ–¹æ³•ä¼ é€’è¿‡æ¥çš„ DecorView å®ä¾‹ï¼Œå®ƒç»§æ‰¿è‡ª FrameLayoutï¼Œè€Œ FrameLayout åˆæ˜¯ä¸€ä¸ª ViewGroup åŒæ—¶ç»§æ‰¿è‡ª Viewã€‚View çš„ measure() æ–¹æ³•æ˜¯ final ç±»å‹çš„ï¼Œä¸å…è®¸å­ç±»å»é‡å†™ï¼Œå› æ­¤è¿™é‡Œè°ƒç”¨çš„å®é™…ä¸Šæ˜¯ View çš„ measure æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>measure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>onMeasure</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>View çš„ onMeasure() å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>getDefaultSize</span><span class=o>(</span><span class=n>getSuggestedMinimumWidth</span><span class=o>(),</span> <span class=n>widthMeasureSpec</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>getDefaultSize</span><span class=o>(</span><span class=n>getSuggestedMinimumHeight</span><span class=o>(),</span> <span class=n>heightMeasureSpec</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒView é»˜è®¤çš„ onMeasure() æ–¹æ³•é¦–å…ˆä¼šè°ƒç”¨ getDefaultSize() è·å–å®½å’Œé«˜çš„é»˜è®¤å€¼ï¼Œç„¶åå†è°ƒç”¨ setMeasuredDimension() å°†è·å–çš„å€¼è¿›è¡Œè®¾ç½®ï¼ŒæŸ¥çœ‹ getDefaultSize() çš„ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getDefaultSize</span><span class=o>(</span><span class=kt>int</span> <span class=n>size</span><span class=o>,</span> <span class=kt>int</span> <span class=n>measureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>specMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getMode</span><span class=o>(</span><span class=n>measureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>specSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>measureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>specMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>UNSPECIFIED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>AT_MOST</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>EXACTLY</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>specSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ— è®ºæ˜¯ AT_MOST è¿˜æ˜¯ EXACTLYï¼Œæœ€ç»ˆè¿”å›çš„éƒ½æ˜¯ measureSpec ä¸­çš„ specSizeï¼Œè¿™ä¸ª specSize å°±æ˜¯æµ‹é‡åçš„æœ€ç»ˆç»“æœã€‚è‡³äº UNSPECIFIED çš„æƒ…å†µï¼Œåˆ™ä¼šè¿”å›ä¸€ä¸ªå»ºè®®çš„æœ€å°å€¼ï¼Œè¿™ä¸ªå€¼å’Œå­å…ƒç´ è®¾ç½®çš„æœ€å°å€¼å®ƒçš„èƒŒæ™¯å¤§å°æœ‰å…³ã€‚</p><p>ä» onMeasure() çš„é»˜è®¤å®ç°å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªç›´æ¥ç»§æ‰¿è‡ª View çš„æ§ä»¶å¦‚æœä¸é‡å†™ onMeasure() æ–¹æ³•ï¼Œåœ¨ä½¿ç”¨è¿™ä¸ªæ§ä»¶å¹¶æŠŠ layout_width æˆ– layout_height è®¾ç½®æˆ wrap_content çš„æ—¶å€™ï¼Œæ•ˆæœå°†ä¼šå’Œ match_parent ä¸€æ ·ï¼å› ä¸ºå¸ƒå±€ä¸­ä½¿ç”¨ wrap_content çš„æ—¶å€™ï¼Œæ ¹æ®ä¸Šé¢ getChildMeasureSpec() æ–¹æ³•æ€»ç»“å‡ºæ¥çš„è¡¨æ ¼å¯ä»¥çŸ¥é“ï¼Œæ­¤æ—¶çš„ specMode æ˜¯ AT_MOSTï¼ŒspecSize æ˜¯ parentSizeï¼Œè€Œ parentSize æ˜¯çˆ¶å®¹å™¨å½“å‰å‰©ä½™çš„ç©ºé—´å¤§å°ï¼Œæ­¤æ—¶ getDefaultSize() å°±ä¼šè¿”å› specSizeï¼Œå› æ­¤å­å…ƒç´ çš„å®½æˆ–é«˜å°±è¢«è®¾ç½®æˆäº†ç­‰äºå½“å‰çˆ¶å®¹å™¨å‰©ä½™ç©ºé—´çš„å¤§å°äº†ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä¸€ä¸ªé€šç”¨çš„æ–¹æ¡ˆå°±æ˜¯åƒå¦‚ä¸‹æ–¹å¼é‡å†™ onMeasure() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>onMeasure</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>widthMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getMode</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>widthSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>heightMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getMode</span><span class=o>(</span><span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>heightSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é»˜è®¤çš„å®½/é«˜
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>mWidth</span> <span class=o>=</span> <span class=n>default_width</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>mHeight</span> <span class=o>=</span> <span class=n>default_height</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å½“å¸ƒå±€å‚æ•°è®¾ç½®ä¸º wrap_content æ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>getLayoutParams</span><span class=o>().</span><span class=na>width</span> <span class=o>==</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span> <span class=o>&amp;&amp;</span> <span class=n>getLayoutParams</span><span class=o>().</span><span class=na>height</span> <span class=o>==</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>mWidth</span><span class=o>,</span> <span class=n>mHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å®½ / é«˜ä»»æ„ä¸€ä¸ªå¸ƒå±€å‚æ•°ä¸º wrap_content æ—¶ï¼Œéƒ½ä½¿ç”¨é»˜è®¤å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>getLayoutParams</span><span class=o>().</span><span class=na>width</span> <span class=o>==</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>mWidth</span><span class=o>,</span> <span class=n>heightSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>getLayoutParams</span><span class=o>().</span><span class=na>height</span> <span class=o>==</span> <span class=n>ViewGroup</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>widthSize</span><span class=o>,</span> <span class=n>mHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å› ä¸º DecorView ç»§æ‰¿è‡ª FrameLayoutï¼Œå®ƒæ˜¯ä¸€ä¸ª ViewGroupï¼ŒViewGroup æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå¹¶æ²¡æœ‰å®šä¹‰ä¸€ä¸ªå…·ä½“çš„æµ‹é‡è¿‡ç¨‹ï¼Œé»˜è®¤ä½¿ç”¨ View çš„ onMeasure() è¿›è¡Œæµ‹é‡ã€‚å®ƒçš„æµ‹é‡è¿‡ç¨‹éœ€è¦å„ä¸ªå­ç±»é€šè¿‡é‡å†™ onMeasure() æ–¹æ³•å»å®ç°ï¼Œå› ä¸ºä¸åŒçš„å­ç±»å…·æœ‰ä¸åŒçš„å¸ƒå±€ç‰¹æ€§ï¼Œå› æ­¤éœ€è¦ä¸ä¸€æ ·çš„æµ‹é‡é€»è¾‘ï¼ŒDecorView ä¹Ÿè‡ªç„¶é‡å†™äº† onMeasure() æ–¹æ³•æ¥å®ç°è‡ªå·±çš„æµ‹é‡é€»è¾‘ï¼Œç®€ç•¥åæ–¹æ³•å†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>widthMode</span> <span class=o>=</span> <span class=n>getMode</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>heightMode</span> <span class=o>=</span> <span class=n>getMode</span><span class=o>(</span><span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>widthMode</span> <span class=o>==</span> <span class=n>AT_MOST</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>heightMode</span> <span class=o>==</span> <span class=n>AT_MOST</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>onMeasure</span><span class=o>(</span><span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æœ€ç»ˆä¼šè°ƒç”¨çˆ¶ç±» FrameLayout çš„ onMeasure() æ–¹æ³•ï¼Œç®€ç•¥åæ–¹æ³•å†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=o>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>getChildCount</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>View</span> <span class=n>child</span> <span class=o>=</span> <span class=n>getChildAt</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mMeasureAllChildren</span> <span class=o>||</span> <span class=n>child</span><span class=o>.</span><span class=na>getVisibility</span><span class=o>()</span> <span class=o>!=</span> <span class=n>GONE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>measureChildWithMargins</span><span class=o>(</span><span class=n>child</span><span class=o>,</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>setMeasuredDimension</span><span class=o>(</span><span class=n>resolveSizeAndState</span><span class=o>(</span><span class=n>maxWidth</span><span class=o>,</span> <span class=n>widthMeasureSpec</span><span class=o>,</span> <span class=n>childState</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>resolveSizeAndState</span><span class=o>(</span><span class=n>maxHeight</span><span class=o>,</span> <span class=n>heightMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>childState</span> <span class=o>&lt;&lt;</span> <span class=n>MEASURED_HEIGHT_STATE_SHIFT</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¼šéå†å®ƒçš„æ¯ä¸€ä¸ªå­å…ƒç´ ï¼Œå¹¶è°ƒç”¨ measureChildWithMargins() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®å‰é¢å·²ç»å‡ºç°è¿‡ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®¡ç®—å‡ºå­å…ƒç´ çš„ MeasureSpec åè°ƒç”¨å­å…ƒç´ æœ¬èº«çš„ measure() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>measureChildWithMargins</span><span class=o>(</span><span class=n>View</span> <span class=n>child</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>parentWidthMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>widthUsed</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>parentHeightMeasureSpec</span><span class=o>,</span> <span class=kt>int</span> <span class=n>heightUsed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å–å­å…ƒç´ çš„å¸ƒå±€å‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>MarginLayoutParams</span> <span class=n>lp</span> <span class=o>=</span> <span class=o>(</span><span class=n>MarginLayoutParams</span><span class=o>)</span> <span class=n>child</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// äº§ç”Ÿå­å…ƒç´ çš„ MeasureSpec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childWidthMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=o>(</span><span class=n>parentWidthMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPaddingLeft</span> <span class=o>+</span> <span class=n>mPaddingRight</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>leftMargin</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>rightMargin</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>widthUsed</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>width</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childHeightMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=o>(</span><span class=n>parentHeightMeasureSpec</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mPaddingTop</span> <span class=o>+</span> <span class=n>mPaddingBottom</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>bottomMargin</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>heightUsed</span><span class=o>,</span> <span class=n>lp</span><span class=o>.</span><span class=na>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>child</span><span class=o>.</span><span class=na>measure</span><span class=o>(</span><span class=n>childWidthMeasureSpec</span><span class=o>,</span> <span class=n>childHeightMeasureSpec</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ­¤æ—¶å®é™…ä¸Šè°ƒç”¨çš„ä¹Ÿæ˜¯ View çš„ measure() æ–¹æ³•ï¼Œä»ä¸Šé¢çš„å†…å®¹å¯ä»¥çŸ¥é“ï¼Œå­å…ƒç´ çš„ onMeasure() æ–¹æ³•åˆä¼šè¢«è°ƒç”¨ï¼Œè¿™æ ·ä¾¿å®ç°äº†å±‚å±‚é€’å½’åœ°è°ƒç”¨åˆ°äº†æ¯ä¸ªå­å…ƒç´ çš„ onMeasure() æ–¹æ³•è¿›è¡Œæµ‹é‡ã€‚</p><a href=#layout-æµç¨‹åˆ†æ><h2 id=layout-æµç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>Layout æµç¨‹åˆ†æ</h2></a><p>å†æ¬¡å›åˆ° performTraversals() æ–¹æ³•ï¼Œæ‰§è¡Œå®Œ performMeasure() éå†æµ‹é‡æ‰€æœ‰å­å…ƒç´ ä¹‹åï¼Œæ¥ç€ä¼šè°ƒç”¨ performLayout() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performLayout</span><span class=o>(</span><span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>lp</span><span class=o>,</span> <span class=kt>int</span> <span class=n>desiredWindowWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>desiredWindowHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒç”¨ DecorView çš„ layout() æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>host</span><span class=o>.</span><span class=na>layout</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>host</span><span class=o>.</span><span class=na>getMeasuredWidth</span><span class=o>(),</span> <span class=n>host</span><span class=o>.</span><span class=na>getMeasuredHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„ getMeasuredWidth() å’Œ getMeasuredHeight() å°±æ˜¯ DecorView åœ¨å‰é¢ Measure æµç¨‹ä¸­è®¡ç®—å¾—åˆ°çš„æµ‹é‡å€¼ï¼Œå®ƒä»¬éƒ½è¢«ä½œä¸ºå‚æ•°ä¼ å…¥ layout() æ–¹æ³•ä¸­ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ View çš„ layout() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>layout</span><span class=o>(</span><span class=kt>int</span> <span class=n>l</span><span class=o>,</span> <span class=kt>int</span> <span class=n>t</span><span class=o>,</span> <span class=kt>int</span> <span class=n>r</span><span class=o>,</span> <span class=kt>int</span> <span class=n>b</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// View çŠ¶æ€æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>changed</span> <span class=o>=</span> <span class=n>isLayoutModeOptical</span><span class=o>(</span><span class=n>mParent</span><span class=o>)</span> <span class=o>?</span>
</span></span><span class=line><span class=cl>                <span class=n>setOpticalFrame</span><span class=o>(</span><span class=n>l</span><span class=o>,</span> <span class=n>t</span><span class=o>,</span> <span class=n>r</span><span class=o>,</span> <span class=n>b</span><span class=o>)</span> <span class=o>:</span> <span class=n>setFrame</span><span class=o>(</span><span class=n>l</span><span class=o>,</span> <span class=n>t</span><span class=o>,</span> <span class=n>r</span><span class=o>,</span> <span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœ View çŠ¶æ€æœ‰å˜åŒ–ï¼Œåˆ™é‡æ–°å¸ƒå±€
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>changed</span> <span class=o>||</span> <span class=o>(</span><span class=n>mPrivateFlags</span> <span class=o>&amp;</span> <span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=o>)</span> <span class=o>==</span> <span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>onLayout</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>l</span><span class=o>,</span> <span class=n>t</span><span class=o>,</span> <span class=n>r</span><span class=o>,</span> <span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>setOpticalFrame() å†…éƒ¨ä¹Ÿç›´æ¥è°ƒç”¨äº† setFrame() æ–¹æ³•ï¼ŒæŸ¥çœ‹ setFrame() æ–¹æ³•çš„å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>setFrame</span><span class=o>(</span><span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>changed</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mLeft</span> <span class=o>!=</span> <span class=n>left</span> <span class=o>||</span> <span class=n>mRight</span> <span class=o>!=</span> <span class=n>right</span> <span class=o>||</span> <span class=n>mTop</span> <span class=o>!=</span> <span class=n>top</span> <span class=o>||</span> <span class=n>mBottom</span> <span class=o>!=</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>changed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>oldWidth</span> <span class=o>=</span> <span class=n>mRight</span> <span class=o>-</span> <span class=n>mLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>oldHeight</span> <span class=o>=</span> <span class=n>mBottom</span> <span class=o>-</span> <span class=n>mTop</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>newWidth</span> <span class=o>=</span> <span class=n>right</span> <span class=o>-</span> <span class=n>left</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>newHeight</span> <span class=o>=</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>top</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>sizeChanged</span> <span class=o>=</span> <span class=o>(</span><span class=n>newWidth</span> <span class=o>!=</span> <span class=n>oldWidth</span><span class=o>)</span> <span class=o>||</span> <span class=o>(</span><span class=n>newHeight</span> <span class=o>!=</span> <span class=n>oldHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Invalidate our old position
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>invalidate</span><span class=o>(</span><span class=n>sizeChanged</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// å˜é‡åˆå§‹åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>mLeft</span> <span class=o>=</span> <span class=n>left</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mTop</span> <span class=o>=</span> <span class=n>top</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mRight</span> <span class=o>=</span> <span class=n>right</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mBottom</span> <span class=o>=</span> <span class=n>bottom</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ›´æ–°ç”¨äºæ¸²æŸ“çš„æ˜¾ç¤ºåˆ—è¡¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mRenderNode</span><span class=o>.</span><span class=na>setLeftTopRightBottom</span><span class=o>(</span><span class=n>mLeft</span><span class=o>,</span> <span class=n>mTop</span><span class=o>,</span> <span class=n>mRight</span><span class=o>,</span> <span class=n>mBottom</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>sizeChanged</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å¦‚æœ View å¤§å°å‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¼šåœ¨é‡Œé¢å›è°ƒ onSizeChanged æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>sizeChange</span><span class=o>(</span><span class=n>newWidth</span><span class=o>,</span> <span class=n>newHeight</span><span class=o>,</span> <span class=n>oldWidth</span><span class=o>,</span> <span class=n>oldHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è¿”å›æ˜¯å¦å‘ç”Ÿå˜åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>changed</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>setFrame() æ–¹æ³•çš„ä¸»è¦ä½œç”¨æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>åˆ¤æ–­ View ä½ç½®æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¹¶æ ¹æ®å˜åŒ–æƒ…å†µè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼›</li><li>åˆå§‹åŒ– mLeftã€mBottomã€mRight å’Œ mTop å˜é‡ï¼Œé¦–æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™è¿”å›å€¼ä¸º <em>true</em>ï¼›</li><li>è°ƒç”¨ RenderNode ä¸­åŸç”Ÿæ–¹æ³•æ›´æ–°ç”¨äºæ¸²æŸ“çš„æ˜¾ç¤ºåˆ—è¡¨ã€‚</li></ol><p>å›åˆ° layout() æ–¹æ³•ï¼Œæ ¹æ® setFrame() æ–¹æ³•è¿”å›çš„çŠ¶æ€åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨ onLayout() è¿›è¡Œé‡æ–°å¸ƒå±€ï¼ŒæŸ¥çœ‹ onLayout() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Assign a size and position to a view and all of its
</span></span></span><span class=line><span class=cl><span class=cm> * descendants
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;This is the second phase of the layout mechanism.
</span></span></span><span class=line><span class=cl><span class=cm> * (The first is measuring). In this phase, each parent calls
</span></span></span><span class=line><span class=cl><span class=cm> * layout on all of its children to position them.
</span></span></span><span class=line><span class=cl><span class=cm> * This is typically done using the child measurements
</span></span></span><span class=line><span class=cl><span class=cm> * that were stored in the measure pass().&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;Derived classes should not override this method.
</span></span></span><span class=line><span class=cl><span class=cm> * Derived classes with children should override
</span></span></span><span class=line><span class=cl><span class=cm> * onLayout. In that method, they should
</span></span></span><span class=line><span class=cl><span class=cm> * call layout on each of their children.&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onLayout</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>changed</span><span class=o>,</span> <span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>onLayout() æ–¹æ³•æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œä»æ³¨é‡Šæœ€åä¸€æ®µå†…å®¹å¯ä»¥äº†è§£åˆ°ï¼Œå•ä¸€çš„ View å¹¶ä¸éœ€è¦é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œå½“ View çš„å­ç±»å…·æœ‰å­å…ƒç´ ï¼ˆå³ ViewGroupï¼‰çš„æ—¶å€™ï¼Œåº”è¯¥é‡å†™è¿™ä¸ªæ–¹æ³•å¹¶è°ƒç”¨æ¯ä¸ªå­å…ƒç´ çš„ layout() æ–¹æ³•ï¼Œå› æ­¤ä½œä¸ºä¸€ä¸ª ViewGroupï¼Œæˆ‘ä»¬æŸ¥çœ‹ DecorView çš„ onLayout() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onLayout</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>changed</span><span class=o>,</span> <span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>onLayout</span><span class=o>(</span><span class=n>changed</span><span class=o>,</span> <span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„ä¸»è¦é€»è¾‘æ˜¯è°ƒç”¨çˆ¶ç±»çš„ onLayout() æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¸ª FrameLayout çš„ onLayout() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onLayout</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>changed</span><span class=o>,</span> <span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>layoutChildren</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=kc>false</span> <span class=cm>/* no force left gravity */</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>layoutChildren</span><span class=o>(</span><span class=kt>int</span> <span class=n>left</span><span class=o>,</span> <span class=kt>int</span> <span class=n>top</span><span class=o>,</span> <span class=kt>int</span> <span class=n>right</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>forceLeftGravity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>getChildCount</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>parentLeft</span> <span class=o>=</span> <span class=n>getPaddingLeftWithForeground</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>parentRight</span> <span class=o>=</span> <span class=n>right</span> <span class=o>-</span> <span class=n>left</span> <span class=o>-</span> <span class=n>getPaddingRightWithForeground</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>parentTop</span> <span class=o>=</span> <span class=n>getPaddingTopWithForeground</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>parentBottom</span> <span class=o>=</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>top</span> <span class=o>-</span> <span class=n>getPaddingBottomWithForeground</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>View</span> <span class=n>child</span> <span class=o>=</span> <span class=n>getChildAt</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>child</span><span class=o>.</span><span class=na>getVisibility</span><span class=o>()</span> <span class=o>!=</span> <span class=n>GONE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>LayoutParams</span> <span class=n>lp</span> <span class=o>=</span> <span class=o>(</span><span class=n>LayoutParams</span><span class=o>)</span> <span class=n>child</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>child</span><span class=o>.</span><span class=na>getMeasuredWidth</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>child</span><span class=o>.</span><span class=na>getMeasuredHeight</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>childLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>childTop</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>gravity</span> <span class=o>=</span> <span class=n>lp</span><span class=o>.</span><span class=na>gravity</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>gravity</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>gravity</span> <span class=o>=</span> <span class=n>DEFAULT_CHILD_GRAVITY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>layoutDirection</span> <span class=o>=</span> <span class=n>getLayoutDirection</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>absoluteGravity</span> <span class=o>=</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>getAbsoluteGravity</span><span class=o>(</span><span class=n>gravity</span><span class=o>,</span> <span class=n>layoutDirection</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>verticalGravity</span> <span class=o>=</span> <span class=n>gravity</span> <span class=o>&amp;</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>VERTICAL_GRAVITY_MASK</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>switch</span> <span class=o>(</span><span class=n>absoluteGravity</span> <span class=o>&amp;</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>HORIZONTAL_GRAVITY_MASK</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>CENTER_HORIZONTAL</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childLeft</span> <span class=o>=</span> <span class=n>parentLeft</span> <span class=o>+</span> <span class=o>(</span><span class=n>parentRight</span> <span class=o>-</span> <span class=n>parentLeft</span> <span class=o>-</span> <span class=n>width</span><span class=o>)</span> <span class=o>/</span> <span class=n>2</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=n>lp</span><span class=o>.</span><span class=na>leftMargin</span> <span class=o>-</span> <span class=n>lp</span><span class=o>.</span><span class=na>rightMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>RIGHT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(!</span><span class=n>forceLeftGravity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>childLeft</span> <span class=o>=</span> <span class=n>parentRight</span> <span class=o>-</span> <span class=n>width</span> <span class=o>-</span> <span class=n>lp</span><span class=o>.</span><span class=na>rightMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>LEFT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childLeft</span> <span class=o>=</span> <span class=n>parentLeft</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>leftMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>switch</span> <span class=o>(</span><span class=n>verticalGravity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>TOP</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childTop</span> <span class=o>=</span> <span class=n>parentTop</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>CENTER_VERTICAL</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childTop</span> <span class=o>=</span> <span class=n>parentTop</span> <span class=o>+</span> <span class=o>(</span><span class=n>parentBottom</span> <span class=o>-</span> <span class=n>parentTop</span> <span class=o>-</span> <span class=n>height</span><span class=o>)</span> <span class=o>/</span> <span class=n>2</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span> <span class=o>-</span> <span class=n>lp</span><span class=o>.</span><span class=na>bottomMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>Gravity</span><span class=o>.</span><span class=na>BOTTOM</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childTop</span> <span class=o>=</span> <span class=n>parentBottom</span> <span class=o>-</span> <span class=n>height</span> <span class=o>-</span> <span class=n>lp</span><span class=o>.</span><span class=na>bottomMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>childTop</span> <span class=o>=</span> <span class=n>parentTop</span> <span class=o>+</span> <span class=n>lp</span><span class=o>.</span><span class=na>topMargin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è°ƒç”¨æ¯ä¸ªå­å…ƒç´ çš„ layout æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>child</span><span class=o>.</span><span class=na>layout</span><span class=o>(</span><span class=n>childLeft</span><span class=o>,</span> <span class=n>childTop</span><span class=o>,</span> <span class=n>childLeft</span> <span class=o>+</span> <span class=n>width</span><span class=o>,</span> <span class=n>childTop</span> <span class=o>+</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ layoutChildren() æ–¹æ³•ä¸­ï¼Œæ ¹æ®è‡ªå·±çš„å¸ƒå±€é€»è¾‘ï¼Œè®¡ç®—å‡ºæ¯ä¸ªå­å…ƒç´ çš„ leftã€topã€right å’Œ bottom å€¼ï¼Œå¹¶è°ƒç”¨å®ƒä»¬çš„ layout() æ–¹æ³•ã€‚</p><p>Layout æµç¨‹çš„ä½œç”¨æ˜¯ ViewGroup ç”¨æ¥ç¡®å®šå®ƒçš„å­å…ƒç´ çš„ä½ç½®ï¼Œ å½“ ViewGroup çš„ä½ç½®è¢«ç¡®å®šåï¼Œåœ¨å®ƒçš„ onLayout() æ–¹æ³•ä¸­å°±ä¼šéå†è°ƒç”¨æ‰€æœ‰å­å…ƒç´ çš„ layout() æ–¹æ³•ï¼Œå­å…ƒç´ çš„ layout() æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™å®ƒçš„ onLayout() æ–¹æ³•åˆä¼šè¢«è°ƒç”¨ï¼Œè¿™æ ·å°±å®ç°äº†å±‚å±‚é€’å½’ã€‚</p><a href=#draw-æµç¨‹åˆ†æ><h2 id=draw-æµç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>Draw æµç¨‹åˆ†æ</h2></a><p>æœ€åï¼Œåˆä¸€æ¬¡å›åˆ°ä¸»çº¿ä¸­çš„ performTraversals() æ–¹æ³•ï¼Œæ­¤æ—¶ï¼Œç»è¿‡ Measure æµç¨‹ç¡®å®šäº†æ¯ä¸ª View çš„å¤§å°å¹¶ä¸”ç»è¿‡ Layout æµç¨‹ç¡®å®šäº†æ¯ä¸ª View çš„æ‘†æ”¾ä½ç½®ï¼Œä¸‹é¢å°†è¿›å…¥ä¸‹ä¸€ä¸ªæµç¨‹ç¡®å®šæ¯ä¸ª View çš„å…·ä½“ç»˜åˆ¶ç»†èŠ‚ã€‚æŸ¥çœ‹ performDraw() æ–¹æ³•å†…å®¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performDraw</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>fullRedrawNeeded</span> <span class=o>=</span> <span class=n>mFullRedrawNeeded</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mFullRedrawNeeded</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mIsDrawing</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>draw</span><span class=o>(</span><span class=n>fullRedrawNeeded</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mIsDrawing</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è·Ÿè¸ª draw() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>draw</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>fullRedrawNeeded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// â€œè„â€åŒºåŸŸï¼Œå³éœ€è¦é‡ç»˜çš„åŒºåŸŸ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>Rect</span> <span class=n>dirty</span> <span class=o>=</span> <span class=n>mDirty</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>fullRedrawNeeded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mIgnoreDirtyState</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>dirty</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>mWidth</span> <span class=o>*</span> <span class=n>appScale</span> <span class=o>+</span> <span class=n>0</span><span class=o>.</span><span class=na>5f</span><span class=o>),</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>mHeight</span> <span class=o>*</span> <span class=n>appScale</span> <span class=o>+</span> <span class=n>0</span><span class=o>.</span><span class=na>5f</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>dirty</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()</span> <span class=o>||</span> <span class=n>mIsAnimating</span> <span class=o>||</span> <span class=n>accessibilityFocusDirty</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mHardwareRenderer</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mHardwareRenderer</span><span class=o>.</span><span class=na>isEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è°ƒç”¨ drawSoftware æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(!</span><span class=n>drawSoftware</span><span class=o>(</span><span class=n>surface</span><span class=o>,</span> <span class=n>mAttachInfo</span><span class=o>,</span> <span class=n>xOffset</span><span class=o>,</span> <span class=n>yOffset</span><span class=o>,</span> <span class=n>scalingRequired</span><span class=o>,</span> <span class=n>dirty</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æŸ¥çœ‹ drawSoftware() æ–¹æ³•å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>drawSoftware</span><span class=o>(</span><span class=n>Surface</span> <span class=n>surface</span><span class=o>,</span> <span class=n>AttachInfo</span> <span class=n>attachInfo</span><span class=o>,</span> <span class=kt>int</span> <span class=n>xoff</span><span class=o>,</span> <span class=kt>int</span> <span class=n>yoff</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>scalingRequired</span><span class=o>,</span> <span class=n>Rect</span> <span class=n>dirty</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Draw with software renderer.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>Canvas</span> <span class=n>canvas</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>left</span> <span class=o>=</span> <span class=n>dirty</span><span class=o>.</span><span class=na>left</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>top</span> <span class=o>=</span> <span class=n>dirty</span><span class=o>.</span><span class=na>top</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>right</span> <span class=o>=</span> <span class=n>dirty</span><span class=o>.</span><span class=na>right</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>bottom</span> <span class=o>=</span> <span class=n>dirty</span><span class=o>.</span><span class=na>bottom</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// é”å®šcanvasåŒºåŸŸï¼Œç”± dirty åŒºåŸŸå†³å®š
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>canvas</span> <span class=o>=</span> <span class=n>mSurface</span><span class=o>.</span><span class=na>lockCanvas</span><span class=o>(</span><span class=n>dirty</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>setDensity</span><span class=o>(</span><span class=n>mDensity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Surface</span><span class=o>.</span><span class=na>OutOfResourcesException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>handleOutOfResourcesException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IllegalArgumentException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mLayoutRequested</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>    <span class=c1>// ask wm for a new surface next time.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è°ƒç”¨ DecorView çš„ draw æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mView</span><span class=o>.</span><span class=na>draw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mLayoutRequested</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>    <span class=c1>// ask wm for a new surface next time.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//noinspection ReturnInsideFinallyBlock
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»§ç»­æŸ¥çœ‹ DecorView çš„ draw() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>draw</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>draw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mMenuBackground</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mMenuBackground</span><span class=o>.</span><span class=na>draw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸»è¦æ˜¯è°ƒç”¨äº†çˆ¶ç±»çš„ draw æ–¹æ³•ï¼ŒFrameLayout å’Œ ViewGroup éƒ½æ²¡æœ‰é‡å†™ draw() æ–¹æ³•ï¼Œæ‰€ä»¥ç›´æ¥çœ‹ View çš„ draw() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>draw</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>privateFlags</span> <span class=o>=</span> <span class=n>mPrivateFlags</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>dirtyOpaque</span> <span class=o>=</span> <span class=o>(</span><span class=n>privateFlags</span> <span class=o>&amp;</span> <span class=n>PFLAG_DIRTY_MASK</span><span class=o>)</span> <span class=o>==</span> <span class=n>PFLAG_DIRTY_OPAQUE</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>mAttachInfo</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>mAttachInfo</span><span class=o>.</span><span class=na>mIgnoreDirtyState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mPrivateFlags</span> <span class=o>=</span> <span class=o>(</span><span class=n>privateFlags</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>PFLAG_DIRTY_MASK</span><span class=o>)</span> <span class=o>|</span> <span class=n>PFLAG_DRAWN</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * Draw traversal performs several drawing steps which must be executed
</span></span></span><span class=line><span class=cl><span class=cm>     * in the appropriate order:
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     *      1. Draw the background
</span></span></span><span class=line><span class=cl><span class=cm>     *      2. If necessary, save the canvas&#39; layers to prepare for fading
</span></span></span><span class=line><span class=cl><span class=cm>     *      3. Draw view&#39;s content
</span></span></span><span class=line><span class=cl><span class=cm>     *      4. Draw children
</span></span></span><span class=line><span class=cl><span class=cm>     *      5. If necessary, draw the fading edges and restore layers
</span></span></span><span class=line><span class=cl><span class=cm>     *      6. Draw decorations (scrollbars for instance)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 1, draw the background, if needed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>saveCount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>dirtyOpaque</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>drawBackground</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// skip step 2 &amp; 5 if possible (common case)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>viewFlags</span> <span class=o>=</span> <span class=n>mViewFlags</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>horizontalEdges</span> <span class=o>=</span> <span class=o>(</span><span class=n>viewFlags</span> <span class=o>&amp;</span> <span class=n>FADING_EDGE_HORIZONTAL</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>verticalEdges</span> <span class=o>=</span> <span class=o>(</span><span class=n>viewFlags</span> <span class=o>&amp;</span> <span class=n>FADING_EDGE_VERTICAL</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>verticalEdges</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>horizontalEdges</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Step 3, draw the content
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(!</span><span class=n>dirtyOpaque</span><span class=o>)</span> <span class=n>onDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Step 4, draw the children
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>dispatchDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Overlay is part of the content and draws beneath Foreground
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>mOverlay</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mOverlay</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mOverlay</span><span class=o>.</span><span class=na>getOverlayView</span><span class=o>().</span><span class=na>dispatchDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Step 6, draw decorations (foreground, scrollbars)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>onDrawForeground</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// we&#39;re done...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * Here we do the full fledged routine...
</span></span></span><span class=line><span class=cl><span class=cm>     * (this is an uncommon case where speed matters less,
</span></span></span><span class=line><span class=cl><span class=cm>     * this is why we repeat some of the tests that have been
</span></span></span><span class=line><span class=cl><span class=cm>     * done above)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>drawTop</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>drawBottom</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>drawLeft</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>drawRight</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>topFadeStrength</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>bottomFadeStrength</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>leftFadeStrength</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>rightFadeStrength</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 2, save the canvas&#39; layers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>paddingLeft</span> <span class=o>=</span> <span class=n>mPaddingLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>offsetRequired</span> <span class=o>=</span> <span class=n>isPaddingOffsetRequired</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>offsetRequired</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>paddingLeft</span> <span class=o>+=</span> <span class=n>getLeftPaddingOffset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>left</span> <span class=o>=</span> <span class=n>mScrollX</span> <span class=o>+</span> <span class=n>paddingLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>right</span> <span class=o>=</span> <span class=n>left</span> <span class=o>+</span> <span class=n>mRight</span> <span class=o>-</span> <span class=n>mLeft</span> <span class=o>-</span> <span class=n>mPaddingRight</span> <span class=o>-</span> <span class=n>paddingLeft</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>top</span> <span class=o>=</span> <span class=n>mScrollY</span> <span class=o>+</span> <span class=n>getFadeTop</span><span class=o>(</span><span class=n>offsetRequired</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>bottom</span> <span class=o>=</span> <span class=n>top</span> <span class=o>+</span> <span class=n>getFadeHeight</span><span class=o>(</span><span class=n>offsetRequired</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>offsetRequired</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>right</span> <span class=o>+=</span> <span class=n>getRightPaddingOffset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>bottom</span> <span class=o>+=</span> <span class=n>getBottomPaddingOffset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ScrollabilityCache</span> <span class=n>scrollabilityCache</span> <span class=o>=</span> <span class=n>mScrollCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>float</span> <span class=n>fadeHeight</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>fadingEdgeLength</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=n>fadeHeight</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// clip the fade length if top and bottom fades overlap
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// overlapping fades produce odd-looking artifacts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>verticalEdges</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>top</span> <span class=o>+</span> <span class=n>length</span> <span class=o>&gt;</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>length</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>length</span> <span class=o>=</span> <span class=o>(</span><span class=n>bottom</span> <span class=o>-</span> <span class=n>top</span><span class=o>)</span> <span class=o>/</span> <span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// also clip horizontal fades if necessary
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>horizontalEdges</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>left</span> <span class=o>+</span> <span class=n>length</span> <span class=o>&gt;</span> <span class=n>right</span> <span class=o>-</span> <span class=n>length</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>length</span> <span class=o>=</span> <span class=o>(</span><span class=n>right</span> <span class=o>-</span> <span class=n>left</span><span class=o>)</span> <span class=o>/</span> <span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>verticalEdges</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>topFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>getTopFadingEdgeStrength</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>drawTop</span> <span class=o>=</span> <span class=n>topFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bottomFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>getBottomFadingEdgeStrength</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>drawBottom</span> <span class=o>=</span> <span class=n>bottomFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>horizontalEdges</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>leftFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>getLeftFadingEdgeStrength</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>drawLeft</span> <span class=o>=</span> <span class=n>leftFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>rightFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>,</span> <span class=n>getRightFadingEdgeStrength</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>drawRight</span> <span class=o>=</span> <span class=n>rightFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>.</span><span class=na>0f</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>saveCount</span> <span class=o>=</span> <span class=n>canvas</span><span class=o>.</span><span class=na>getSaveCount</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>solidColor</span> <span class=o>=</span> <span class=n>getSolidColor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>solidColor</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>flags</span> <span class=o>=</span> <span class=n>Canvas</span><span class=o>.</span><span class=na>HAS_ALPHA_LAYER_SAVE_FLAG</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>drawTop</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>canvas</span><span class=o>.</span><span class=na>saveLayer</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>top</span> <span class=o>+</span> <span class=n>length</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>drawBottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>canvas</span><span class=o>.</span><span class=na>saveLayer</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>length</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>drawLeft</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>canvas</span><span class=o>.</span><span class=na>saveLayer</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>left</span> <span class=o>+</span> <span class=n>length</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>drawRight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>canvas</span><span class=o>.</span><span class=na>saveLayer</span><span class=o>(</span><span class=n>right</span> <span class=o>-</span> <span class=n>length</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>setFadeColor</span><span class=o>(</span><span class=n>solidColor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 3, draw the content
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>dirtyOpaque</span><span class=o>)</span> <span class=n>onDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 4, draw the children
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>dispatchDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 5, draw the fade effect and restore layers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>Paint</span> <span class=n>p</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>paint</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Matrix</span> <span class=n>matrix</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>matrix</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Shader</span> <span class=n>fade</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=o>.</span><span class=na>shader</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>drawTop</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>topFadeStrength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postTranslate</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>fade</span><span class=o>.</span><span class=na>setLocalMatrix</span><span class=o>(</span><span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=na>setShader</span><span class=o>(</span><span class=n>fade</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>drawRect</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>top</span> <span class=o>+</span> <span class=n>length</span><span class=o>,</span> <span class=n>p</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>drawBottom</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>bottomFadeStrength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postRotate</span><span class=o>(</span><span class=n>180</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postTranslate</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>bottom</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>fade</span><span class=o>.</span><span class=na>setLocalMatrix</span><span class=o>(</span><span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=na>setShader</span><span class=o>(</span><span class=n>fade</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>drawRect</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>length</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=n>p</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>drawLeft</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>leftFadeStrength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postRotate</span><span class=o>(-</span><span class=n>90</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postTranslate</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>fade</span><span class=o>.</span><span class=na>setLocalMatrix</span><span class=o>(</span><span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=na>setShader</span><span class=o>(</span><span class=n>fade</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>drawRect</span><span class=o>(</span><span class=n>left</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>left</span> <span class=o>+</span> <span class=n>length</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=n>p</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>drawRight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>rightFadeStrength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postRotate</span><span class=o>(</span><span class=n>90</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=na>postTranslate</span><span class=o>(</span><span class=n>right</span><span class=o>,</span> <span class=n>top</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>fade</span><span class=o>.</span><span class=na>setLocalMatrix</span><span class=o>(</span><span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=na>setShader</span><span class=o>(</span><span class=n>fade</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>canvas</span><span class=o>.</span><span class=na>drawRect</span><span class=o>(</span><span class=n>right</span> <span class=o>-</span> <span class=n>length</span><span class=o>,</span> <span class=n>top</span><span class=o>,</span> <span class=n>right</span><span class=o>,</span> <span class=n>bottom</span><span class=o>,</span> <span class=n>p</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>canvas</span><span class=o>.</span><span class=na>restoreToCount</span><span class=o>(</span><span class=n>saveCount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Overlay is part of the content and draws beneath Foreground
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>mOverlay</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mOverlay</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mOverlay</span><span class=o>.</span><span class=na>getOverlayView</span><span class=o>().</span><span class=na>dispatchDraw</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Step 6, draw decorations (foreground, scrollbars)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>onDrawForeground</span><span class=o>(</span><span class=n>canvas</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»ä»£ç æ³¨é‡Šä¸­å¯ä»¥çœ‹åˆ°ï¼Œdraw() è¿‡ç¨‹åˆ†ä¸ºå…­ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ol><li>ç»˜åˆ¶ View çš„èƒŒæ™¯ï¼›</li><li>ä¿å­˜å½“å‰ canvas çš„å›¾å±‚ï¼›</li><li>ç»˜åˆ¶ View çš„å†…å®¹ï¼›</li><li>å¦‚æœæœ‰å­å…ƒç´ ï¼Œåˆ™è°ƒç”¨å­å…ƒç´ çš„ draw() æ–¹æ³•ï¼›</li><li>ç»˜åˆ¶æ·¡å…¥æ·¡å‡ºæ•ˆæœå¹¶æ¢å¤å›¾å±‚ï¼›</li><li>ç»˜åˆ¶ View çš„è£…é¥°ï¼ˆæ»šåŠ¨æ¡ç­‰ï¼‰ã€‚</li></ol><p>å…¶ä¸­ç¬¬äºŒæ­¥å’Œç¬¬äº”æ­¥ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šç”¨åˆ°ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ç¬¬ä¸‰æ­¥ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•åˆ†é…å­å…ƒç´ çš„ç»˜åˆ¶çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>dispatchDraw</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ˜¾ç„¶ï¼Œå•ä¸€çš„ View å¹¶æ²¡æœ‰å­å…ƒç´ ï¼Œå› æ­¤ï¼Œçœ‹çœ‹ ViewGroup æ˜¯æ€ä¹ˆå®ç°è¿™ä¸ªè¿‡ç¨‹çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>dispatchDraw</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>childrenCount</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>transientIndex</span> <span class=o>&gt;=</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=n>mTransientIndices</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>transientIndex</span><span class=o>)</span> <span class=o>==</span> <span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>View</span> <span class=n>transientChild</span> <span class=o>=</span> <span class=n>mTransientViews</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>transientIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span><span class=n>transientChild</span><span class=o>.</span><span class=na>mViewFlags</span> <span class=o>&amp;</span> <span class=n>VISIBILITY_MASK</span><span class=o>)</span> <span class=o>==</span> <span class=n>VISIBLE</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                    <span class=n>transientChild</span><span class=o>.</span><span class=na>getAnimation</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>more</span> <span class=o>|=</span> <span class=n>drawChild</span><span class=o>(</span><span class=n>canvas</span><span class=o>,</span> <span class=n>transientChild</span><span class=o>,</span> <span class=n>drawingTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>drawChild</span><span class=o>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=o>,</span> <span class=n>View</span> <span class=n>child</span><span class=o>,</span> <span class=kt>long</span> <span class=n>drawingTime</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>child</span><span class=o>.</span><span class=na>draw</span><span class=o>(</span><span class=n>canvas</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>drawingTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ ViewGroup çš„ dispatchDraw() ä¸­ï¼Œéå†æ¯ä¸ªå­å…ƒç´ å¹¶è°ƒç”¨äº†å®ƒä»¬çš„ draw() æ–¹æ³•ï¼Œç”±æ­¤å®ç°äº†å±‚å±‚é€’å½’è°ƒç”¨ï¼Œæœ€ç»ˆå®Œæˆç»˜åˆ¶ã€‚</p><a href=#å°ç»“-4><h2 id=å°ç»“-4><span class=hanchor arialabel=Anchor># </span>å°ç»“</h2></a><p>çºµè§‚æ•´ä¸ª Measureã€Layout å’Œ Draw è¿‡ç¨‹ï¼Œä½¿ç”¨æµç¨‹å›¾è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045712.png width=auto alt></p><a href=#å…«æ˜¾ç¤º-view><h1 id=å…«æ˜¾ç¤º-view><span class=hanchor arialabel=Anchor># </span>å…«ï¼šæ˜¾ç¤º View</h1></a><p>ä¸çŸ¥é“ä½ è¿˜è®°ä¸è®°å¾—ï¼Œä¸Šä¸€æ­¥éª¤ä¸­æ‰§è¡Œçš„ View çš„ Measureã€Layout å’Œ Draw æµç¨‹éƒ½æ˜¯å‰é¢ handleResumeActivity() ä¸­çš„ wm.addView() æ–¹æ³•ä¸ºæºå¤´çš„ï¼Œå›é¡¾ handleResumeActivity() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>handleResumeActivity</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>clearHide</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isForward</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>reallyResume</span><span class=o>,</span> <span class=kt>int</span> <span class=n>seq</span><span class=o>,</span> <span class=n>String</span> <span class=n>reason</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ActivityClientRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=n>mActivities</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>token</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æœ€ç»ˆä¼šè°ƒç”¨ onStart() å’Œ onResume() ç­‰æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>r</span> <span class=o>=</span> <span class=n>performResumeActivity</span><span class=o>(</span><span class=n>token</span><span class=o>,</span> <span class=n>clearHide</span><span class=o>,</span> <span class=n>reason</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>r</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Activity</span> <span class=n>a</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>window</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>a</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>willBeVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>window</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>getWindow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è·å– DecorView 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>View</span> <span class=n>decor</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>window</span><span class=o>.</span><span class=na>getDecorView</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å°† DecorView è®¾ç½®æˆä¸å¯è§
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>decor</span><span class=o>.</span><span class=na>setVisibility</span><span class=o>(</span><span class=n>View</span><span class=o>.</span><span class=na>INVISIBLE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è·å– ViewManagerï¼Œè¿™é‡Œæ˜¯ WindowManagerImpl å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ViewManager</span> <span class=n>wm</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=na>getWindowManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span> <span class=n>l</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>window</span><span class=o>.</span><span class=na>getAttributes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span><span class=o>.</span><span class=na>mDecor</span> <span class=o>=</span> <span class=n>decor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>l</span><span class=o>.</span><span class=na>type</span> <span class=o>=</span> <span class=n>WindowManager</span><span class=o>.</span><span class=na>LayoutParams</span><span class=o>.</span><span class=na>TYPE_BASE_APPLICATION</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>l</span><span class=o>.</span><span class=na>softInputMode</span> <span class=o>|=</span> <span class=n>forwardBit</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>a</span><span class=o>.</span><span class=na>mVisibleFromClient</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>a</span><span class=o>.</span><span class=na>mWindowAdded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// æ ‡è®°è®¾ç½®ä¸º true
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>a</span><span class=o>.</span><span class=na>mWindowAdded</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è°ƒç”¨ WindowManagerImpl çš„ addView æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>wm</span><span class=o>.</span><span class=na>addView</span><span class=o>(</span><span class=n>decor</span><span class=o>,</span> <span class=n>l</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> 
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>willBeVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>willBeVisible</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mDecor</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>hideForNow</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mVisibleFromClient</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è°ƒç”¨ makeVisible æ–¹æ³•å°† DecorView è®¾ç½®ä¸ºå¯è§
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>makeVisible</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// åœ¨æ­¤è¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œåˆ™ç›´æ¥æ€æ­» Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>finishActivity</span><span class=o>(</span><span class=n>token</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>Activity</span><span class=o>.</span><span class=na>DONT_FINISH_TASK_WITH_ACTIVITY</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>ex</span><span class=o>.</span><span class=na>rethrowFromSystemServer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨ wm.addView() æ–¹æ³•ä¹‹å‰ï¼ŒDecorView æ˜¯å¤„äºä¸å¯è§çš„çŠ¶æ€çš„ï¼Œå› æ­¤ï¼Œå³ä½¿ç»è¿‡äº† Measureã€Layout å’Œ Draw æµç¨‹ï¼Œæˆ‘ä»¬çš„ View ä»ç„¶æ²¡æœ‰æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œçœ‹çœ‹ Activity çš„ makeVisible() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>makeVisible</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>mWindowAdded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ViewManager</span> <span class=n>wm</span> <span class=o>=</span> <span class=n>getWindowManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>wm</span><span class=o>.</span><span class=na>addView</span><span class=o>(</span><span class=n>mDecor</span><span class=o>,</span> <span class=n>getWindow</span><span class=o>().</span><span class=na>getAttributes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>mWindowAdded</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mDecor</span><span class=o>.</span><span class=na>setVisibility</span><span class=o>(</span><span class=n>View</span><span class=o>.</span><span class=na>VISIBLE</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œ DecorView çš„ setVisibility() ä¹‹åï¼Œæˆ‘ä»¬çš„ View æ‰æ­£å¼å‡ºç°åœ¨å±å¹•ä¸Šï¼</p><a href=#æ€»ç»“><h1 id=æ€»ç»“><span class=hanchor arialabel=Anchor># </span>æ€»ç»“</h1></a><ul><li>Window æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæä¾›äº†å„ç§çª—å£æ“ä½œçš„æ–¹æ³•ï¼›</li><li>PhoneWindow æ˜¯ Window çš„å”¯ä¸€å®ç°ç±»ï¼Œæ¯ä¸ª Acitvity ä¸­éƒ½ä¼šæœ‰ä¸€ä¸ª PhoneWindw å®ä¾‹ï¼›</li><li>DecorView â€”â€” é¡¶çº§è§†å›¾ï¼Œå®ƒç»§æ‰¿è‡ª FrameLayoutï¼ŒsetContentView() æ—¶ï¼ŒPhoneWindow ä¼šåˆ›å»º DecorView å¹¶ä¸ DecorView å»ºç«‹å…³è”ï¼›</li><li>PhoneWindow ä¼šæ ¹æ® Theme å’Œ Feature ç­‰å°†å¯¹åº”çš„å¸ƒå±€æ–‡ä»¶å°†å¸ƒå±€è§£æå¹¶æ·»åŠ åˆ° DecorView ä¸­ï¼Œè¿™äº›å¸ƒå±€ä¸­éƒ½åŒ…å«äº†ä¸€ä¸ª id ä¸º content çš„ FrameLayoutï¼›</li><li>setContentView() æ–¹æ³•ä¸­è®¾ç½®çš„ layout å¸ƒå±€æ–‡ä»¶ä¼šè¢« PhoneWindow è§£æå¹¶å‹å…¥ DecorView ä¸­ id ä¸º content çš„ FrameLayout ä¸­ï¼›</li><li>View çš„æ­£å¼ç»˜åˆ¶æ˜¯ä» ViewRootImpl çš„ performTraversals() æ–¹æ³•å¼€å§‹çš„ï¼›</li><li>å•ä¸€ View ä¸€èˆ¬éœ€è¦é‡å†™ onMeasure() æ–¹æ³•æ ¹æ®å¸ƒå±€å‚æ•°å’Œçˆ¶ View çš„æµ‹é‡è§„æ ¼è®¡ç®—è‡ªå·±çš„å®½é«˜å¹¶ä¿å­˜ï¼›</li><li>ViewGroup éœ€è¦é‡å†™ onMeasure() æ–¹æ³•è®¡ç®—æ‰€æœ‰å­å…ƒç´ çš„å°ºå¯¸ç„¶åè®¡ç®—è‡ªå·±çš„å°ºå¯¸å¹¶ä¿å­˜ï¼›</li><li>å•ä¸€ View ä¸€èˆ¬ä¸éœ€è¦é‡å†™ onLayout() æ–¹æ³•ï¼›</li><li>ViewGroup éœ€è¦é‡å†™ onLayot() æ–¹æ³•æ ¹æ®æµ‹é‡çš„å€¼ç¡®å®šæ‰€æœ‰å­å…ƒç´ çš„ä½ç½®ï¼›</li><li>å•ä¸€ View éœ€è¦é‡å†™ onDraw() æ–¹æ³•ç»˜åˆ¶è‡ªèº«ï¼›</li><li>ViewGroup éœ€è¦é‡å†™ onDraw() æ–¹æ³•ç»˜åˆ¶è‡ªèº«ä»¥åŠéå†å­å…ƒç´ å¯¹å®ƒä»¬è¿›è¡Œç»˜åˆ¶ã€‚</li><li>åœ¨ Activity çš„ onResume() ç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨åï¼ŒActivityThread æ‰ä¼šè°ƒç”¨ activity.makeVisible() è®© DecorView å¯è§ã€‚</li></ul><p><strong>ç³»åˆ—æ–‡ç« </strong></p><p><a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>æŒ‰ä¸‹ç”µæºé”®åç«Ÿç„¶å‘ç”Ÿäº†è¿™ä¸€å¹• â€”â€” Android ç³»ç»Ÿå¯åŠ¨æµç¨‹åˆ†æ</a></p><p><a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App ç«Ÿç„¶æ˜¯è¿™æ ·è·‘èµ·æ¥çš„ â€”â€” Android App/Activity å¯åŠ¨æµç¨‹åˆ†æ</a></p><p><a href=https://guanpj.cn/2017/11/09/Android-View-Workflow/ rel=noopener>å±å¹•ä¸Šå†…å®¹ç©¶ç«Ÿæ˜¯æ€æ ·ç”»å‡ºæ¥çš„ â€”â€” Android View å·¥ä½œåŸç†è¯¦è§£</a>ï¼ˆæœ¬æ–‡ï¼‰</p><p><strong>å‚è€ƒæ–‡ç« </strong></p><p><a href=https://blog.csdn.net/yanbober/article/details/46128379 rel=noopener>Android åº”ç”¨å±‚ View ç»˜åˆ¶æµç¨‹ä¸æºç åˆ†æ</a></p><p><a href=https://www.jianshu.com/p/158736a2549d rel=noopener>ï¼ˆ3ï¼‰è‡ªå®šä¹‰ View Layout è¿‡ç¨‹ - æœ€æ˜“æ‡‚çš„è‡ªå®šä¹‰ View åŸç†ç³»åˆ—</a></p><blockquote><p>å¦‚æœä½ å¯¹æ–‡ç« å†…å®¹æœ‰ç–‘é—®æˆ–è€…æœ‰ä¸åŒçš„æ„è§ï¼Œæ¬¢è¿ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€åŒæ¢è®¨ã€‚</p></blockquote></article><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>