<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="https://juejin.cn/post/6881436122950402056
è¯·æ±‚æµç¨‹ åŒæ­¥è¯·æ±‚ MainActivity.kt
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  val user = &#34;guanpj&#34; val client = OkHttpClient."><meta property="og:title" content="OkHttp ä½¿ç”¨åŠæºç åˆ†æ "><meta property="og:description" content="https://juejin.cn/post/6881436122950402056
è¯·æ±‚æµç¨‹ åŒæ­¥è¯·æ±‚ MainActivity.kt
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  val user = &#34;guanpj&#34; val client = OkHttpClient."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="OkHttp ä½¿ç”¨åŠæºç åˆ†æ "><meta name=twitter:description content="https://juejin.cn/post/6881436122950402056
è¯·æ±‚æµç¨‹ åŒæ­¥è¯·æ±‚ MainActivity.kt
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  val user = &#34;guanpj&#34; val client = OkHttpClient."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>OkHttp ä½¿ç”¨åŠæºç åˆ†æ</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.138d20df1c76453999963c9af77d96e4.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.cf6439e057b2800c40a018b5e420d51c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.370886dee394ffa436835dd8e7756e9b.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><div class=row><div class=col-md-3 id=toc><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#è¯·æ±‚æµç¨‹>è¯·æ±‚æµç¨‹</a><ol><li><a href=#strongåŒæ­¥è¯·æ±‚strong><strong>åŒæ­¥è¯·æ±‚</strong></a></li><li><a href=#strongå¼‚æ­¥è¯·æ±‚strong><strong>å¼‚æ­¥è¯·æ±‚</strong></a></li><li><a href=#getresponsewithinterceptorchain>getResponseWithInterceptorChain</a></li></ol></li><li><a href=#okhttpclient>OkHttpClient</a></li><li><a href=#strongrequest-å’Œ-responsestrong><strong>Request å’Œ Response</strong></a></li><li><a href=#realcall>RealCall</a></li><li><a href=#interceptor>Interceptor</a><ol><li><a href=#clientinterceptors>client.interceptors</a></li><li><a href=#retryandfollowupinterceptor>RetryAndFollowUpInterceptor</a></li><li><a href=#bridgeinterceptor>BridgeInterceptor</a></li><li><a href=#cacheinterceptor>CacheInterceptor</a></li><li><a href=#connectinterceptor>ConnectInterceptor</a></li><li><a href=#clientnetworkinterceptors>client.networkInterceptors</a></li><li><a href=#callserverinterceptor>CallServerInterceptor</a></li></ol></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></nav></details></aside></div><div class=col-md-9><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>OkHttp ä½¿ç”¨åŠæºç åˆ†æ</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/OkHttp/>OK HTTP</a></li><li><a href=https://www.guanpj.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>æºç è§£æ</a></li></ul><p><a href=https://juejin.cn/post/6881436122950402056 rel=noopener>https://juejin.cn/post/6881436122950402056</a></p><a href=#è¯·æ±‚æµç¨‹><h1 id=è¯·æ±‚æµç¨‹><span class=hanchor arialabel=Anchor># </span>è¯·æ±‚æµç¨‹</h1></a><a href=#strongåŒæ­¥è¯·æ±‚strong><h2 id=strongåŒæ­¥è¯·æ±‚strong><span class=hanchor arialabel=Anchor># </span><strong>åŒæ­¥è¯·æ±‚</strong></h2></a><p><em>MainActivity.kt</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>user</span> <span class=p>=</span> <span class=s2>&#34;guanpj&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>client</span> <span class=p>=</span> <span class=n>OkHttpClient</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>connectTimeout</span><span class=p>(</span><span class=m>15</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>writeTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>readTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>proxy</span><span class=p>(</span><span class=n>Proxy</span><span class=p>.</span><span class=n>NO_PROXY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addInterceptor</span><span class=p>(</span><span class=n>HttpLoggingInterceptor</span> <span class=p>{</span> <span class=n>message</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>BuildConfig</span><span class=p>.</span><span class=n>DEBUG</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=p>.</span><span class=n>i</span><span class=p>(</span><span class=s2>&#34;OkHttp&#34;</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span> <span class=p>=</span> <span class=n>Request</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>url</span><span class=p>(</span><span class=s2>&#34;https://api.github.com/users/</span><span class=si>$user</span><span class=s2>/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>).</span><span class=n>execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>println</span><span class=p>(</span><span class=s2>&#34;Response status code: </span><span class=si>${response.code}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><em>OkHttpClient.kt</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=cm>/** Prepares the [request] to be executed at some point in the future. */</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>):</span> <span class=n>Call</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>         <span class=n>RealCall</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>forWebSocket</span> <span class=p>=</span> <span class=k>false</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><em>RealCall.execute</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>execute</span><span class=p>():</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//ä¿è¯æ¯ä¸ª call åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>check</span><span class=p>(</span><span class=n>executed</span><span class=p>.</span><span class=n>compareAndSet</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=k>true</span><span class=p>))</span> <span class=p>{</span> <span class=s2>&#34;Already Executed&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>timeout</span><span class=p>.</span><span class=n>enter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>callStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>executed</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getResponseWithInterceptorChain</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>finished</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><em>Dispatcher.executed</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Synchronized</span> <span class=k>internal</span> <span class=k>fun</span> <span class=nf>executed</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>RealCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>runningSyncCalls</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ extcuted æ–¹æ³•ä¸­å¹¶æ²¡æœ‰å…·ä½“æ‰§è¡Œè¯·æ±‚çš„æ–¹æ³•ï¼Œä»…ä»…æ˜¯æŠŠå½“å‰å¯¹è±¡å­˜å…¥ runningSyncCalls é›†åˆä¸­ã€‚åŒæ­¥è¯·æ±‚çš„æ ¸å¿ƒéƒ¨åˆ†åœ¨æ¥ä¸‹æ¥çš„ getResponseWithInterceptorChain ä¸­ï¼Œæ­¤æ–¹æ³•ç›´æ¥è¿”å›äº†è¯·æ±‚ç»“æœ Responseï¼Œäº‹å®ä¸Šè¿™ä¸ªæ–¹æ³•è°ƒç”¨æ ˆéå¸¸å¤æ‚ï¼Œè¿™é‡Œå…ˆæŒ‰ä¸‹ä¸è¡¨ã€‚æœ€ååœ¨ finially ä»£ç å—ä¸­è°ƒç”¨äº† <code>client.dispatcher.finished(this)</code>ï¼Œä¹Ÿæ˜¯ä¼ å…¥äº† this å¯¹è±¡ï¼Œæˆ‘ä»¬æœ‰ç†ç”±çŒœæµ‹è¿™ä¸€æ­¥å°±æ˜¯å°†å®ƒä» runningSyncCalls é›†åˆä¸­ç§»é™¤ï¼Œè¿™é‡ŒåŒæ ·ç­‰åˆ°å¼‚æ­¥è¯·æ±‚æµç¨‹ä¸€å¹¶åˆ†æã€‚</p><a href=#strongå¼‚æ­¥è¯·æ±‚strong><h2 id=strongå¼‚æ­¥è¯·æ±‚strong><span class=hanchor arialabel=Anchor># </span><strong>å¼‚æ­¥è¯·æ±‚</strong></h2></a><p><em>MainActivity.kt</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>user</span> <span class=p>=</span> <span class=s2>&#34;guanpj&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>client</span> <span class=p>=</span> <span class=n>OkHttpClient</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span> <span class=p>=</span> <span class=n>Request</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>url</span><span class=p>(</span><span class=s2>&#34;https://api.github.com/users/</span><span class=si>$user</span><span class=s2>/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=p>.</span><span class=n>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>enqueue</span><span class=p>(</span><span class=k>object</span> <span class=err>: </span><span class=nc>Callback</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onFailure</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>Call</span><span class=p>,</span> <span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=p>.</span><span class=n>printStackTrace</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onResponse</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>Call</span><span class=p>,</span> <span class=n>response</span><span class=p>:</span> <span class=n>Response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>println</span><span class=p>(</span><span class=s2>&#34;Response status code: </span><span class=si>${response.code}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p><em>RealCall.enqueue</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>enqueue</span><span class=p>(</span><span class=n>responseCallback</span><span class=p>:</span> <span class=n>Callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>check</span><span class=p>(</span><span class=n>executed</span><span class=p>.</span><span class=n>compareAndSet</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=k>true</span><span class=p>))</span> <span class=p>{</span> <span class=s2>&#34;Already Executed&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>callStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>//åŒ…è£…æˆ AsyncCallï¼Œæ”¾å…¥å¾…æ‰§è¡Œçš„å¼‚æ­¥è¯·æ±‚è¯·æ±‚åˆ—è¡¨
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>enqueue</span><span class=p>(</span><span class=n>AsyncCall</span><span class=p>(</span><span class=n>responseCallback</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><em>Dispatcher.enqueue</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>enqueue</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>AsyncCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>synchronized</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//é¦–å…ˆå°† call æ”¾å…¥ readyAsyncCalls é›†åˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>readyAsyncCalls</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Mutate the AsyncCall so that it shares the AtomicInteger of an existing running call to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the same host.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(!</span><span class=n>call</span><span class=p>.</span><span class=n>call</span><span class=p>.</span><span class=n>forWebSocket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>existingCall</span> <span class=p>=</span> <span class=n>findExistingCallWithHost</span><span class=p>(</span><span class=n>call</span><span class=p>.</span><span class=n>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>existingCall</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=n>call</span><span class=p>.</span><span class=n>reuseCallsPerHostFrom</span><span class=p>(</span><span class=n>existingCall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//ç„¶åè°ƒç”¨æ­¤æ–¹æ³•æ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>promoteAndExecute</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>readyAsyncCalls æ„æ€æ¸©ä¸ºâ€œå‡†å¤‡å¥½çš„å¼‚æ­¥è¯·æ±‚â€ï¼Œè€Œ promoteAndExecute æ–¹æ³•å•ä»å‘½åæ¥çœ‹å°±æ˜¯æå‡å’Œæ‰§è¡Œï¼Œå…·ä½“åˆ†æå¦‚ä¸‹ï¼š</p><p><em>Dispatcher.promoteAndExecute</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>promoteAndExecute</span><span class=p>():</span> <span class=n>Boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>assertThreadDoesntHoldLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>//æ–°å»ºä¸€ä¸ªåˆ—è¡¨å­˜æ”¾å¯æ‰§è¡Œçš„è¯·æ±‚
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>val</span> <span class=py>executableCalls</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>&lt;</span><span class=n>AsyncCall</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>isRunning</span><span class=p>:</span> <span class=n>Boolean</span>
</span></span><span class=line><span class=cl>  <span class=n>synchronized</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>i</span> <span class=p>=</span> <span class=n>readyAsyncCalls</span><span class=p>.</span><span class=n>iterator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//éå†å‡†å¤‡å¥½çš„å¼‚æ­¥è¯·æ±‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>hasNext</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>asyncCall</span> <span class=p>=</span> <span class=n>i</span><span class=p>.</span><span class=n>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=c1>//æ€»è¯·æ±‚æ•°ä¸èƒ½è¶…è¿‡ 64 ä¸ª
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>runningAsyncCalls</span><span class=p>.</span><span class=n>size</span> <span class=o>&gt;=</span> <span class=k>this</span><span class=p>.</span><span class=n>maxRequests</span><span class=p>)</span> <span class=k>break</span> <span class=c1>// Max capacity.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>//æ¯ä¸ªä¸»æœºè¯·æ±‚æ•°é‡ä¸èƒ½è¶…è¿‡ 5 ä¸ª
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>asyncCall</span><span class=p>.</span><span class=n>callsPerHost</span><span class=p>.</span><span class=k>get</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=k>this</span><span class=p>.</span><span class=n>maxRequestsPerHost</span><span class=p>)</span> <span class=k>continue</span> <span class=c1>// Host max capacity.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>//ä» readyAsyncCalls é›†åˆä¸­ç§»é™¤
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>i</span><span class=p>.</span><span class=n>remove</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=c1>//å®‰å…¨è‡ªå¢
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>asyncCall</span><span class=p>.</span><span class=n>callsPerHost</span><span class=p>.</span><span class=n>incrementAndGet</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=c1>//åŠ å…¥åˆ° executableCalls é›†åˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>executableCalls</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>asyncCall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=c1>//åŠ å…¥åˆ° runningAsyncCalls é›†åˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>runningAsyncCalls</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>asyncCall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//è·å–æ­£åœ¨æ‰§è¡Œä¸­çš„è¯·æ±‚ï¼ˆåŒæ­¥å’Œå¼‚æ­¥ï¼‰æ€»æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>isRunning</span> <span class=p>=</span> <span class=n>runningCallsCount</span><span class=p>()</span> <span class=p>&gt;</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//éå†å¯æ‰§è¡Œè¯·æ±‚çš„é›†åˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=k>in</span> <span class=m>0</span> <span class=n>until</span> <span class=n>executableCalls</span><span class=p>.</span><span class=n>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>asyncCall</span> <span class=p>=</span> <span class=n>executableCalls</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1>//è°ƒç”¨å®ƒä»¬çš„ executeOn æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>asyncCall</span><span class=p>.</span><span class=n>executeOn</span><span class=p>(</span><span class=n>executorService</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//è¿”å›æ­£åœ¨æ‰§è¡Œä¸­çš„è¯·æ±‚ï¼ˆåŒæ­¥å’Œå¼‚æ­¥ï¼‰æ€»æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>isRunning</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Synchronized</span> <span class=k>fun</span> <span class=nf>runningCallsCount</span><span class=p>():</span> <span class=n>Int</span> 
</span></span><span class=line><span class=cl>        <span class=p>=</span> <span class=n>runningAsyncCalls</span><span class=p>.</span><span class=n>size</span> <span class=p>+</span> <span class=n>runningSyncCalls</span><span class=p>.</span><span class=n>size</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•å¯æ‹†åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>é¦–å…ˆï¼Œä¸€ä¸ªè¯·æ±‚ä»ä¸Šä¸€æ­¥è¢«æ”¾å…¥ readyAsyncCalls é›†åˆä¸­ï¼Œåœ¨è¿™é‡Œå°†éå†è¯¥é›†åˆå¹¶åœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹å°†é›†åˆä¸­çš„è¯·æ±‚ç§»é™¤å¹¶åˆ†åˆ«åŠ å…¥åˆ° runningAsyncCalls å’Œ executableCalls é›†åˆï¼›</li><li>æ¥ç€éå† executableCalls é›†åˆå¹¶è°ƒç”¨æ¯ä¸ª AysncCall çš„ executeOn æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ executorService å¯¹åƒç”¨äºæ‰§è¡Œè¿™ä¸ª Callã€‚AsyncCall æ˜¯ RealCall ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼›</li><li>æœ€åè¿”å›æ­£åœ¨æ‰§è¡Œä¸­çš„åŒæ­¥å’Œå¼‚æ­¥è¯·æ±‚çš„æ€»æ•°ã€‚</li></ol><p>è¿™é‡Œé‡ç‚¹çœ‹ç¬¬äºŒç‚¹ï¼š</p><p><em>RealCall.AsyncCall</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>inner</span> <span class=k>class</span> <span class=nc>AsyncCall</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>val</span> <span class=py>responseCallback</span><span class=p>:</span> <span class=n>Callback</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>Runnable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Volatile</span> <span class=k>var</span> <span class=py>callsPerHost</span> <span class=p>=</span> <span class=n>AtomicInteger</span><span class=p>(</span><span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>set</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>reuseCallsPerHostFrom</span><span class=p>(</span><span class=n>other</span><span class=p>:</span> <span class=n>AsyncCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=n>callsPerHost</span> <span class=p>=</span> <span class=n>other</span><span class=p>.</span><span class=n>callsPerHost</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>host</span><span class=p>:</span> <span class=n>String</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=n>originalRequest</span><span class=p>.</span><span class=n>url</span><span class=p>.</span><span class=n>host</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span>
</span></span><span class=line><span class=cl>      <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=n>originalRequest</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>call</span><span class=p>:</span> <span class=n>RealCall</span>
</span></span><span class=line><span class=cl>      <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=k>this</span><span class=nd>@RealCall</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Attempt to enqueue this async call on [executorService]. This will attempt to clean up
</span></span></span><span class=line><span class=cl><span class=cm>   * if the executor has been shut down by reporting the call as failed.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>executeOn</span><span class=p>(</span><span class=n>executorService</span><span class=p>:</span> <span class=n>ExecutorService</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>assertThreadDoesntHoldLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>success</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//è°ƒç”¨ executorService æ‰§è¡Œè‡ªå·±
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>executorService</span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>success</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>RejectedExecutionException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>ioException</span> <span class=p>=</span> <span class=n>InterruptedIOException</span><span class=p>(</span><span class=s2>&#34;executor rejected&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>ioException</span><span class=p>.</span><span class=n>initCause</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>noMoreExchanges</span><span class=p>(</span><span class=n>ioException</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>responseCallback</span><span class=p>.</span><span class=n>onFailure</span><span class=p>(</span><span class=k>this</span><span class=nd>@RealCall</span><span class=p>,</span> <span class=n>ioException</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(!</span><span class=n>success</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>finished</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=c1>// This call is no longer running!
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>//è¢« executorService.execute æ—¶è°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>override</span> <span class=k>fun</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>threadName</span><span class=p>(</span><span class=s2>&#34;OkHttp </span><span class=si>${redactedUrl()}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>var</span> <span class=py>signalledCallback</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>      <span class=n>timeout</span><span class=p>.</span><span class=n>enter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//1ã€åœ¨ executorService ä¸­å¼‚æ­¥æ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>getResponseWithInterceptorChain</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>signalledCallback</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>        <span class=c1>//2ã€å›è°ƒç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>responseCallback</span><span class=p>.</span><span class=n>onResponse</span><span class=p>(</span><span class=k>this</span><span class=nd>@RealCall</span><span class=p>,</span> <span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>signalledCallback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Do not signal the callback twice!
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>Platform</span><span class=p>.</span><span class=k>get</span><span class=p>().</span><span class=n>log</span><span class=p>(</span><span class=s2>&#34;Callback failure for </span><span class=si>${toLoggableString()}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>Platform</span><span class=p>.</span><span class=n>INFO</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>//å›è°ƒç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>responseCallback</span><span class=p>.</span><span class=n>onFailure</span><span class=p>(</span><span class=k>this</span><span class=nd>@RealCall</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>t</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=n>signalledCallback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>val</span> <span class=py>canceledException</span> <span class=p>=</span> <span class=n>IOException</span><span class=p>(</span><span class=s2>&#34;canceled due to </span><span class=si>$t</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>canceledException</span><span class=p>.</span><span class=n>addSuppressed</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=c1>//å›è°ƒç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>responseCallback</span><span class=p>.</span><span class=n>onFailure</span><span class=p>(</span><span class=k>this</span><span class=nd>@RealCall</span><span class=p>,</span> <span class=n>canceledException</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>t</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//3ã€åç»­æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>finished</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å› ä¸ºæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæ‰€ä»¥è¯·æ±‚æ“ä½œå¿…ç„¶æ˜¯åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ run æ–¹æ³•ä¸­ï¼Œå¼‚æ­¥è¯·æ±‚æ­£å¸¸æƒ…å†µä¸‹åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>è°ƒç”¨ getResponseWithInterceptorChain æ–¹æ³•è·å– Resonse ç»“æœï¼Œè¿™ç‚¹å’ŒåŒæ­¥è¯·æ±‚ä¸€æ ·ã€‚</li><li>å°† Response å¯¹è±¡é€šè¿‡ responseCallback è¿›è¡Œå›è°ƒã€‚</li><li>åœ¨ finally ä¸­è°ƒç”¨ <code>client.dispatcher.finished(this)</code> æ–¹æ³•ã€‚</li></ol><p>ç¬¬ä¸€æ­¥è¿˜æ˜¯ç•™åˆ°åé¢ï¼Œç¬¬äºŒæ­¥æ— é¡»å¤šè§£é‡Šï¼Œæ¥çœ‹ç¬¬ä¸‰æ­¥ï¼Œåœ¨åŒæ­¥è¯·æ±‚æµç¨‹çš„è¶³åä¹ŸåŒæ ·æ‰§è¡Œäº†è¿™ä¸ªæ­¥éª¤ã€‚</p><p><em>Dispatcher.finish</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>finished</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>AsyncCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>call</span><span class=p>.</span><span class=n>callsPerHost</span><span class=p>.</span><span class=n>decrementAndGet</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>finished</span><span class=p>(</span><span class=n>runningAsyncCalls</span><span class=p>,</span> <span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>finished</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>RealCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>finished</span><span class=p>(</span><span class=n>runningSyncCalls</span><span class=p>,</span> <span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span><span class=p>&gt;</span> <span class=nf>finished</span><span class=p>(</span><span class=n>calls</span><span class=p>:</span> <span class=n>Deque</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;,</span> <span class=n>call</span><span class=p>:</span> <span class=n>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>idleCallback</span><span class=p>:</span> <span class=n>Runnable</span><span class=p>?</span>
</span></span><span class=line><span class=cl>  <span class=n>synchronized</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(!</span><span class=n>calls</span><span class=p>.</span><span class=n>remove</span><span class=p>(</span><span class=n>call</span><span class=p>))</span> <span class=k>throw</span> <span class=n>AssertionError</span><span class=p>(</span><span class=s2>&#34;Call wasn&#39;t in-flight!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>idleCallback</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>idleCallback</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>isRunning</span> <span class=p>=</span> <span class=n>promoteAndExecute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!is</span><span class=n>Running</span> <span class=o>&amp;&amp;</span> <span class=n>idleCallback</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>idleCallback</span><span class=p>.</span><span class=n>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸ç®¡åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„ Callï¼Œæœ€åéƒ½ä¼šèµ°åˆ°æœ€åä¸€ä¸ªæ–¹æ³•ï¼Œæœç„¶è¿™é‡Œåˆ†åˆ«ç§»é™¤äº† runningAsyncCalls å’Œ runningSyncCalls é›†åˆä¸­çš„ Call å¯¹è±¡ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿™é‡Œå†æ¬¡è°ƒç”¨äº† promoteAndExecute æ–¹æ³•ï¼Œå‰é¢æåˆ°è¿‡ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯æ­£åœ¨æ‰§è¡Œä¸­çš„åŒæ­¥å’Œå¼‚æ­¥è¯·æ±‚ä¸ªæ•°ã€‚å½“æ‰€æœ‰è¯·æ±‚éƒ½æ‰§è¡Œå®Œæˆåï¼Œä¼šè°ƒç”¨ idleCallback.run æ–¹æ³•è¿›è¡Œå›è°ƒã€‚</p><a href=#getresponsewithinterceptorchain><h2 id=getresponsewithinterceptorchain><span class=hanchor arialabel=Anchor># </span>getResponseWithInterceptorChain</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>getResponseWithInterceptorChain</span><span class=p>():</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Build a full stack of interceptors.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>val</span> <span class=py>interceptors</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>&lt;</span><span class=n>Interceptor</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>client</span><span class=p>.</span><span class=n>interceptors</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>RetryAndFollowUpInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>BridgeInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=n>cookieJar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>CacheInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=n>cache</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>ConnectInterceptor</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(!</span><span class=n>forWebSocket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>client</span><span class=p>.</span><span class=n>networkInterceptors</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>CallServerInterceptor</span><span class=p>(</span><span class=n>forWebSocket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>chain</span> <span class=p>=</span> <span class=n>RealInterceptorChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span> <span class=p>=</span> <span class=k>this</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>interceptors</span> <span class=p>=</span> <span class=n>interceptors</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>index</span> <span class=p>=</span> <span class=m>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span> <span class=p>=</span> <span class=k>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>request</span> <span class=p>=</span> <span class=n>originalRequest</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>connectTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>connectTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>readTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>readTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>writeTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>writeTimeoutMillis</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>calledNoMoreExchanges</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>originalRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>isCanceled</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>response</span><span class=p>.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=n>IOException</span><span class=p>(</span><span class=s2>&#34;Canceled&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>calledNoMoreExchanges</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>noMoreExchanges</span><span class=p>(</span><span class=n>e</span><span class=p>)</span> <span class=k>as</span> <span class=n>Throwable</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(!</span><span class=n>calledNoMoreExchanges</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>noMoreExchanges</span><span class=p>(</span><span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆå°†ä»¥ä¸‹æ‹¦æˆªå™¨ä¾æ¬¡åŠ å…¥åˆ° List ä¸­ï¼š</p><ol><li>OkHttpClient è®¾ç½®çš„æ‹¦æˆªå™¨ interceptors()</li><li>é‡è¯•ã€é‡å®šå‘æ‹¦æˆªå™¨ RetryAndFollowUpInterceptor</li><li>æŠŠç”¨æˆ·è¯·æ±‚è½¬æ¢ä¸ºæœåŠ¡å™¨è¯·æ±‚ã€æŠŠæœåŠ¡å™¨è¿”å“åº”è½¬æ¢ä¸ºç”¨æˆ·å“åº”çš„ BridgeInterceptor</li><li>è¯»å–ç¼“å­˜ç›´æ¥è¿”å›ã€å°†å“åº”å†™å…¥åˆ°ç¼“å­˜ä¸­çš„ CacheInterceptor</li><li>ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥çš„ ConnectInterceptor</li><li>OkHttpClient è®¾ç½®çš„ç½‘ç»œæ‹¦æˆªå™¨ networkInterceptors()</li><li>çœŸæ­£æ‰§è¡Œç½‘ç»œè¯·æ±‚çš„ CallServerInterceptor</li></ol><p>å°†æ‰€æœ‰çš„æ‹¦æˆªå™¨ä¿å­˜åœ¨ interceptors é›†åˆä¸­åï¼Œåˆ›å»ºä¸€ä¸ªæ‹¦æˆªå™¨è´£ä»»é“¾ RealInterceptorChainï¼Œå¹¶è°ƒç”¨å…¶ proceed å¼€å§‹å¤„ç†ç½‘ç»œè¯·æ±‚ã€‚é‚£ä¹ˆè´£ä»»é“¾æ¨¡å¼æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ</p><p>é¦–å…ˆæŸ¥çœ‹ RealInterceptorChain çš„æºç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>RealInterceptorChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>call</span><span class=p>:</span> <span class=n>RealCall</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>val</span> <span class=py>interceptors</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Interceptor</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>val</span> <span class=py>index</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>exchange</span><span class=p>:</span> <span class=n>Exchange</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>connectTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>readTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>writeTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>var</span> <span class=py>calls</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>fun</span> <span class=nf>copy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>index</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>exchange</span><span class=p>:</span> <span class=n>Exchange</span><span class=p>?</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>exchange</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>:</span> <span class=n>Request</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>connectTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>connectTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>readTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>readTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>writeTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>writeTimeoutMillis</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>=</span> <span class=n>RealInterceptorChain</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=n>interceptors</span><span class=p>,</span> <span class=n>index</span><span class=p>,</span> <span class=n>exchange</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>connectTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>readTimeoutMillis</span><span class=p>,</span> <span class=n>writeTimeoutMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>override</span> <span class=k>fun</span> <span class=nf>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>check</span><span class=p>(</span><span class=n>index</span> <span class=p>&lt;</span> <span class=n>interceptors</span><span class=p>.</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>calls</span><span class=o>++</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Call the next interceptor in the chain.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=py>next</span> <span class=p>=</span> <span class=n>copy</span><span class=p>(</span><span class=n>index</span> <span class=p>=</span> <span class=n>index</span> <span class=p>+</span> <span class=m>1</span><span class=p>,</span> <span class=n>request</span> <span class=p>=</span> <span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>interceptor</span> <span class=p>=</span> <span class=n>interceptors</span><span class=p>[</span><span class=n>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Suppress</span><span class=p>(</span><span class=s2>&#34;USELESS_ELVIS&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>interceptor</span><span class=p>.</span><span class=n>intercept</span><span class=p>(</span><span class=n>next</span><span class=p>)</span> <span class=o>?:</span> <span class=k>throw</span> <span class=n>NullPointerException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;interceptor </span><span class=si>$interceptor</span><span class=s2> returned null&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ä¸è€ƒè™‘ OkHttpClient.interceptor() çš„æƒ…å†µä¸‹ï¼Œé¦–æ¬¡æ‰§è¡Œ getResponseWithInterceptorChain æ–¹æ³•æ—¶ä¸Šé¢è¿™ä¸¤æ®µä»£ç çš„è§£é‡Šå¦‚ä¸‹ï¼š</p><ol><li>åœ¨ getResponseWithInterceptorChain åˆ›å»ºäº†ä¸€ä¸ª index ä¸º 0 çš„ RealInterceptorChainï¼Œæ¥ç€è°ƒç”¨äº†å…¶ proceed æ–¹æ³•ï¼›</li><li>åœ¨ RealInterceptorChain.proceed æ–¹æ³•ä¸­ï¼Œå°† index+1 å¹¶ä¸”å’Œå…¶å®ƒæˆå‘˜å˜é‡ä¸€èµ· copy å‡ºä¸€ä¸ªæ–°çš„ RealInterceptorChain å¯¹è±¡ nextï¼›</li><li>ç„¶åå¯¹å½“å‰ index çš„æ‹¦æˆªå™¨ï¼ˆå³ RetryAndFollowUpInterceptorï¼‰æ‰§è¡Œ interceptor.intercept(next)ã€‚åœ¨ RetryAndFollowUpInterceptor æ–¹æ³•ä¸­æ‰§è¡Œäº† next.proceed æ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„ next åŒæ ·æ˜¯ RealInterceptorChain å®ä¾‹ï¼Œæ‰€ä»¥å›åˆ°äº† RealInterceptorChain.proceed æ–¹æ³•ä¸­ï¼›</li><li>æ­¤æ—¶ index=1ï¼ŒåŒç†é“¾æ¡å¯ä»¥ä¸€ç›´æ‰§è¡Œä¸‹å»ç›´åˆ° index ç­‰äº n-1ï¼›</li><li>é‡åˆ°æœ€åä¸€ä¸ªæ‹¦æˆªå™¨ CallServerInterceptorï¼Œé“¾ä¸èƒ½ç»§ç»­ä¸‹å»äº†ï¼ŒCallServerInterceptor.intercept æ–¹æ³•ä¸­ä¹Ÿä¸ä¼šå† proceed äº†ï¼›</li><li>CallServerInterceptor å»ºç«‹è¿æ¥åå¼€å§‹é€’å½’è¿”å›ï¼ŒResponse çš„è¿”å›ä¸ Request ç›¸åï¼Œä¼šä»æœ€åä¸€ä¸ªå¼€å§‹ä¾æ¬¡å¾€å‰ç»è¿‡è¿™äº› Intercetorã€‚</li></ol><p>ä¸‹å›¾ä¸º OkHttp å·¥ä½œçš„å¤§è‡´æµç¨‹ï¼Œå‚è€ƒè‡ª
<a href=https://blog.piasy.com/2016/07/11/Understand-OkHttp/index.html rel=noopener>æ‹†è½®å­ç³»åˆ—ï¼šæ‹† OkHttp</a></p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035335.png width=auto alt></p><p>åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚æµç¨‹æ—¶åºå›¾å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035341.png width=auto alt></p><a href=#okhttpclient><h1 id=okhttpclient><span class=hanchor arialabel=Anchor># </span>OkHttpClient</h1></a><p>OkHttpClient ç›¸å½“äºé…ç½®ä¸­å¿ƒï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šå…±äº«è¿™äº›é…ç½®ï¼ˆä¾‹å¦‚å‡ºé”™æ˜¯å¦é‡è¯•ã€å…±äº«çš„è¿æ¥æ± ï¼‰ã€‚ OkHttpClient ä¸­çš„é…ç½®ä¸»è¦æœ‰:</p><ul><li><code>Dispatcher dispatcher</code> : è°ƒåº¦å™¨ï¼Œç”¨äºè°ƒåº¦åå°å‘èµ·çš„ç½‘ç»œè¯·æ±‚ï¼Œ æœ‰åå°æ€»è¯·æ±‚æ•°å’Œå•ä¸»æœºæ€»è¯·æ±‚æ•°çš„æ§åˆ¶ã€‚</li><li><code>List&lt;Protocol> protocols</code> : æ”¯æŒçš„åº”ç”¨å±‚åè®®ï¼Œå³ HTTP/1.1ã€ HTTP/2 ç­‰ã€‚</li><li><code>List&lt;ConnectionSpec> connectionSpecs</code> : åº”ç”¨å±‚æ”¯æŒçš„ Socket è®¾ç½®ï¼Œå³ä½¿ç”¨æ˜æ–‡ä¼ è¾“ï¼ˆç”¨äº HTTPï¼‰è¿˜æ˜¯æŸä¸ªç‰ˆæœ¬çš„ TLSï¼ˆç”¨äº HTTPSï¼‰ã€‚</li><li><code>List&lt;Interceptor> interceptors</code> : å¤§å¤šæ•°æ—¶å€™ä½¿ç”¨çš„ Interceptor éƒ½åº”è¯¥é…ç½®åˆ°è¿™é‡Œã€‚</li><li><code>List&lt;Interceptor> networkInterceptors</code> : ç›´æ¥å’Œç½‘ç»œè¯·æ±‚äº¤äº’çš„ Interceptor é…ç½®åˆ°è¿™é‡Œï¼Œä¾‹å¦‚å¦‚æœè¦æŸ¥çœ‹è¿”å›çš„ 301 æŠ¥æ–‡æˆ–è€…æœªè§£å‹çš„ Response Bodyï¼Œéœ€è¦åœ¨è¿™é‡Œçœ‹ã€‚</li><li>CookieJar cookieJar : ç®¡ç† Cookie çš„æ§åˆ¶å™¨ã€‚OkHttp æä¾›äº† Cookie å­˜å–çš„åˆ¤æ–­æ”¯æŒï¼ˆå³ä»€ä¹ˆæ—¶å€™éœ€è¦å­˜ Cookieï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦è¯»å– Cookieï¼Œä½†æ²¡æœ‰ç»™å‡ºå…·ä½“çš„å­˜å–å®ç°ã€‚å¦‚æœéœ€è¦å­˜å– Cookieï¼Œéœ€è¦è‡ªå·±å†™å®ç°ï¼Œä¾‹å¦‚ç”¨ Map å­˜åœ¨å†…å­˜é‡Œï¼Œæˆ–è€…ç”¨åˆ«çš„æ–¹å¼å­˜åœ¨æœ¬åœ°å­˜å‚¨æˆ–è€…æ•°æ®åº“ã€‚</li><li>Cache cache : Cache å­˜å‚¨çš„é…ç½®ã€‚é»˜è®¤æ˜¯æ²¡æœ‰ï¼Œå¦‚æœéœ€è¦ç”¨ï¼Œå¾—è‡ªå·±é…ç½®å‡º Cache å­˜å‚¨çš„æ–‡ä»¶ä½ç½®ä»¥åŠå­˜å‚¨ç©ºé—´ä¸Šé™ã€‚</li><li>HostnameVerifier hostnameVerifier : ç”¨äºéªŒè¯ HTTPS æ¡æ‰‹è¿‡ç¨‹ä¸­ä¸‹è½½åˆ°çš„è¯ä¹¦æ‰€å±è€…æ˜¯å¦å’Œè‡ªå·±è¦è®¿é—®çš„ä¸»æœºåä¸€è‡´ã€‚</li><li>CertificatePinner certificatePinner : ç”¨äºè®¾ç½® HTTPS æ¡æ‰‹ è¿‡ç¨‹ä¸­é’ˆå¯¹æŸä¸ª Host é¢å¤–çš„çš„ Certificate Public Key Pinnerï¼Œå³æŠŠç½‘ç«™è¯ä¹¦é“¾ä¸­çš„æ¯ä¸€ä¸ªè¯ä¹¦å…¬é’¥ç›´æ¥æ‹¿æ¥æå‰é…ç½®è¿› OkHttpClient é‡Œå»ï¼Œä½œä¸ºæ­£å¸¸çš„è¯ä¹¦éªŒè¯æœºåˆ¶ä¹‹å¤–çš„ä¸€æ¬¡é¢å¤–éªŒè¯ã€‚</li><li>Authenticator authenticator : ç”¨äºè‡ªåŠ¨é‡æ–°è®¤è¯ã€‚é…ç½®ä¹‹åï¼Œåœ¨è¯·æ±‚æ”¶åˆ° 401 çŠ¶æ€ç çš„å“åº”æ—¶ï¼Œä¼šç›´æ¥è°ƒç”¨ authenticator ï¼Œæ‰‹åŠ¨åŠ å…¥ Authorization header ä¹‹åè‡ªåŠ¨é‡æ–°å‘èµ·è¯·æ±‚ã€‚</li><li>boolean followRedirects : é‡åˆ°é‡å®šå‘çš„è¦æ±‚æ˜¯ï¼Œæ˜¯å¦è‡ªåŠ¨ followã€‚</li><li>boolean followSslRedirects : åœ¨é‡å®šå‘æ—¶ï¼Œå¦‚æœåŸå…ˆè¯·æ±‚çš„æ˜¯ http è€Œé‡å®šå‘çš„ç›®æ ‡æ˜¯ httpsï¼Œæˆ–è€…åŸå…ˆè¯·æ±‚çš„æ˜¯ https è€Œé‡å®šå‘çš„ç›®æ ‡æ˜¯ httpï¼Œæ˜¯å¦ä¾ç„¶è‡ªåŠ¨ followã€‚æ³¨æ„ï¼šä¸æ˜¯ã€Œæ˜¯å¦è‡ªåŠ¨ follow HTTPS URL é‡å®šå‘çš„æ„æ€ï¼Œè€Œæ˜¯æ˜¯å¦è‡ªåŠ¨ follow åœ¨ HTTP å’Œ HTTPS ä¹‹é—´åˆ‡æ¢çš„é‡å®šå‘ã€‚</li><li>boolean retryOnConnectionFailure : åœ¨è¯·æ±‚å¤±è´¥çš„æ—¶å€™æ˜¯å¦è‡ªåŠ¨é‡è¯•ã€‚æ³¨æ„ï¼šå¤§å¤šæ•°çš„è¯·æ±‚å¤±è´¥å¹¶ä¸å±äº OkHttp æ‰€å®šä¹‰çš„ã€Œéœ€è¦é‡è¯•ã€ï¼Œ è¿™ç§é‡è¯•åªé€‚ç”¨äºã€ŒåŒä¸€ä¸ªåŸŸåçš„å¤šä¸ª IP åˆ‡æ¢é‡è¯•ã€ã€ŒSocket å¤±æ•ˆé‡è¯•ã€ ç­‰æƒ…å†µã€‚</li><li>int connectTimeout : å»ºç«‹è¿æ¥ï¼ˆTCP æˆ– TLSï¼‰çš„è¶…æ—¶æ—¶é—´ã€‚</li><li>int readTimeout : å‘èµ·è¯·æ±‚åˆ°è¯»åˆ°å“åº”æ•°æ®çš„è¶…æ—¶æ—¶é—´ã€‚</li><li>int writeTimeout : å‘èµ·è¯·æ±‚å¹¶è¢«ç›®æ ‡æœåŠ¡å™¨æ¥å—çš„è¶…æ—¶æ—¶é—´ã€‚ï¼ˆå› ä¸ºæœ‰æ—¶å€™å¯¹æ–¹æœåŠ¡å™¨å¯èƒ½ç”±äºæŸç§åŸå› è€Œä¸è¯»å–ä½ çš„ Requestï¼‰</li></ul><a href=#strongrequest-å’Œ-responsestrong><h1 id=strongrequest-å’Œ-responsestrong><span class=hanchor arialabel=Anchor># </span><strong>Request å’Œ Response</strong></h1></a><p>Request æ˜¯å‘é€è¯·æ±‚å°è£…ç±»ï¼Œå†…éƒ¨æœ‰ url, header , methodï¼Œbody ç­‰å¸¸è§çš„å‚æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>Request</span> <span class=k>internal</span> <span class=k>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;url&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>url</span><span class=p>:</span> <span class=n>HttpUrl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;method&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>method</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;headers&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>headers</span><span class=p>:</span> <span class=n>Headers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;body&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>body</span><span class=p>:</span> <span class=n>RequestBody</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>tags</span><span class=p>:</span> <span class=n>Map</span><span class=p>&lt;</span><span class=n>Class</span><span class=p>&lt;*&gt;,</span> <span class=n>Any</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Response æ˜¯è¯·æ±‚çš„ç»“æœï¼ŒåŒ…å« codeã€messageã€headerã€body:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>Response</span> <span class=k>internal</span> <span class=k>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * The wire-level request that initiated this HTTP response. This is not necessarily the same
</span></span></span><span class=line><span class=cl><span class=cm>   * request issued by the application:
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * * It may be transformed by the HTTP client. For example, the client may copy headers like
</span></span></span><span class=line><span class=cl><span class=cm>   *   `Content-Length` from the request body.
</span></span></span><span class=line><span class=cl><span class=cm>   * * It may be the request generated in response to an HTTP redirect or authentication
</span></span></span><span class=line><span class=cl><span class=cm>   *   challenge. In this case the request URL may be different than the initial request URL.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;request&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Returns the HTTP protocol, such as [Protocol.HTTP_1_1] or [Protocol.HTTP_1_0]. */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;protocol&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>protocol</span><span class=p>:</span> <span class=n>Protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Returns the HTTP status message. */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>message</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Returns the HTTP status code. */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>code</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns the TLS handshake of the connection that carried this response, or null if the
</span></span></span><span class=line><span class=cl><span class=cm>   * response was received without TLS.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;handshake&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>handshake</span><span class=p>:</span> <span class=n>Handshake</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Returns the HTTP headers. */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;headers&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>headers</span><span class=p>:</span> <span class=n>Headers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns a non-null value if this response was passed to [Callback.onResponse] or returned
</span></span></span><span class=line><span class=cl><span class=cm>   * from [Call.execute]. Response bodies must be [closed][ResponseBody] and may
</span></span></span><span class=line><span class=cl><span class=cm>   * be consumed only once.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * This always returns null on responses returned from [cacheResponse], [networkResponse],
</span></span></span><span class=line><span class=cl><span class=cm>   * and [priorResponse].
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;body&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>body</span><span class=p>:</span> <span class=n>ResponseBody</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns the raw response received from the network. Will be null if this response didn&#39;t use
</span></span></span><span class=line><span class=cl><span class=cm>   * the network, such as when the response is fully cached. The body of the returned response
</span></span></span><span class=line><span class=cl><span class=cm>   * should not be read.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;networkResponse&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>networkResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns the raw response received from the cache. Will be null if this response didn&#39;t use
</span></span></span><span class=line><span class=cl><span class=cm>   * the cache. For conditional get requests the cache response and network response may both be
</span></span></span><span class=line><span class=cl><span class=cm>   * non-null. The body of the returned response should not be read.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;cacheResponse&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>cacheResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns the response for the HTTP redirect or authorization challenge that triggered this
</span></span></span><span class=line><span class=cl><span class=cm>   * response, or null if this response wasn&#39;t triggered by an automatic retry. The body of the
</span></span></span><span class=line><span class=cl><span class=cm>   * returned response should not be read because it has already been consumed by the redirecting
</span></span></span><span class=line><span class=cl><span class=cm>   * client.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;priorResponse&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>priorResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns a [timestamp][System.currentTimeMillis] taken immediately before OkHttp
</span></span></span><span class=line><span class=cl><span class=cm>   * transmitted the initiating request over the network. If this response is being served from the
</span></span></span><span class=line><span class=cl><span class=cm>   * cache then this is the timestamp of the original request.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;sentRequestAtMillis&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>sentRequestAtMillis</span><span class=p>:</span> <span class=n>Long</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns a [timestamp][System.currentTimeMillis] taken immediately after OkHttp
</span></span></span><span class=line><span class=cl><span class=cm>   * received this response&#39;s headers from the network. If this response is being served from the
</span></span></span><span class=line><span class=cl><span class=cm>   * cache then this is the timestamp of the original response.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;receivedResponseAtMillis&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>receivedResponseAtMillis</span><span class=p>:</span> <span class=n>Long</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;exchange&#34;</span><span class=p>)</span> <span class=k>internal</span> <span class=k>val</span> <span class=py>exchange</span><span class=p>:</span> <span class=n>Exchange</span><span class=p>?</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>Closeable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸¤ä¸ªç±»çš„å®šä¹‰æ˜¯å®Œå…¨ç¬¦åˆ Http åè®®æ‰€å®šä¹‰çš„è¯·æ±‚å†…å®¹å’Œå“åº”å†…å®¹ã€‚</p><a href=#realcall><h1 id=realcall><span class=hanchor arialabel=Anchor># </span>RealCall</h1></a><p>OkHttpClient çš„ newCall(Request) æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª RealCall å¯¹è±¡ï¼Œå®ƒæ˜¯ Call æ¥å£çš„å®ç°ã€‚</p><p>å½“è°ƒç”¨ RealCall.execute() çš„æ—¶å€™ï¼Œ RealCall.getResponseWithInterceptorChain() ä¼šè¢«è°ƒç”¨ï¼Œå®ƒä¼šå‘èµ·ç½‘ç»œè¯·æ±‚å¹¶æ‹¿åˆ°è¿”å›çš„å“åº”ï¼Œè£…è¿›ä¸€ä¸ª Response å¯¹è±¡å¹¶ä½œä¸ºè¿”å›å€¼è¿”å›ï¼›</p><p>RealCall.enqueue() è¢«è°ƒç”¨çš„æ—¶å€™å¤§åŒå°å¼‚ï¼ŒåŒºåˆ«åœ¨äº enqueue() ä¼šä½¿ç”¨ Dispatcher çš„çº¿ç¨‹æ± æ¥æŠŠè¯·æ±‚æ”¾åœ¨åå°çº¿ç¨‹è¿›è¡Œï¼Œä½†å®è´¨ä¸Šä½¿ç”¨çš„ä¹Ÿæ˜¯ getResponseWithInterceptorChain() æ–¹æ³•ã€‚</p><p>getResponseWithInterceptorChain() æ–¹æ³•åšçš„äº‹ï¼šæŠŠæ‰€æœ‰é…ç½®å¥½çš„ Interceptor æ”¾åœ¨ä¸€ä¸ª List é‡Œï¼Œç„¶åä½œä¸ºå‚æ•°ï¼Œåˆ›å»ºä¸€ä¸ª RealInterceptorChain å¯¹è±¡ï¼Œå¹¶è°ƒ chain.proceed(request) æ¥å‘èµ·è¯·æ±‚å’Œè·å–å“åº”ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>getResponseWithInterceptorChain</span><span class=p>():</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Build a full stack of interceptors.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>val</span> <span class=py>interceptors</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>&lt;</span><span class=n>Interceptor</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>client</span><span class=p>.</span><span class=n>interceptors</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>RetryAndFollowUpInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>BridgeInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=n>cookieJar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>CacheInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=n>cache</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>ConnectInterceptor</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(!</span><span class=n>forWebSocket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>client</span><span class=p>.</span><span class=n>networkInterceptors</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>CallServerInterceptor</span><span class=p>(</span><span class=n>forWebSocket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>chain</span> <span class=p>=</span> <span class=n>RealInterceptorChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span> <span class=p>=</span> <span class=k>this</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>interceptors</span> <span class=p>=</span> <span class=n>interceptors</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>index</span> <span class=p>=</span> <span class=m>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span> <span class=p>=</span> <span class=k>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>request</span> <span class=p>=</span> <span class=n>originalRequest</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>connectTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>connectTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>readTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>readTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>writeTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>writeTimeoutMillis</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ RealInterceptorChain ä¸­ï¼Œå¤šä¸ª Interceptor ä¼šä¾æ¬¡è°ƒç”¨è‡ªå·±çš„ intercept() æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šåšä¸‰ä»¶äº‹:</p><ol><li>å¯¹è¯·æ±‚è¿›è¡Œé¢„å¤„ç†</li><li>é¢„å¤„ç†ä¹‹åï¼Œé‡æ–°è°ƒç”¨ RealIntercepterChain.proceed() æŠŠè¯·æ±‚äº¤ç»™ä¸‹ä¸€ä¸ª Interceptor</li><li>åœ¨ä¸‹ä¸€ä¸ª Interceptor å¤„ç†å®Œæˆå¹¶è¿”å›ä¹‹åï¼Œæ‹¿åˆ° Response è¿›è¡Œåç»­å¤„ç†</li></ol><p>ç»“åˆæºç å’Œè¯¥ç¤ºæ„å›¾ï¼Œå¯ä»¥å¾—åˆ°æ‹¦æˆªå™¨å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>æ‹¦æˆªå™¨æŒ‰ç…§æ·»åŠ é¡ºåºä¾æ¬¡æ‰§è¡Œ</li><li>æ‹¦æˆªå™¨çš„æ‰§è¡Œä» RealInterceptorChain.proceed() å¼€å§‹ï¼Œè¿›å…¥åˆ°ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨çš„æ‰§è¡Œé€»è¾‘</li><li>æ¯ä¸ªæ‹¦æˆªå™¨åœ¨æ‰§è¡Œä¹‹å‰ï¼Œä¼šå°†å‰©ä½™å°šæœªæ‰§è¡Œçš„æ‹¦æˆªå™¨ç»„æˆæ–°çš„ RealInterceptorChain</li><li>æ‹¦æˆªå™¨çš„é€»è¾‘è¢«æ–°çš„è´£ä»»é“¾è°ƒç”¨ next.proceed() åˆ‡åˆ†ä¸º startã€next.proceedã€end è¿™ä¸‰ä¸ªéƒ¨åˆ†ä¾æ¬¡æ‰§è¡Œ</li><li>next.proceed() æ‰€ä»£è¡¨çš„å…¶å®å°±æ˜¯å‰©ä½™æ‰€æœ‰æ‹¦æˆªå™¨çš„æ‰§è¡Œé€»è¾‘</li><li>æ‰€æœ‰æ‹¦æˆªå™¨æœ€ç»ˆå½¢æˆä¸€ä¸ªå±‚å±‚å†…åµŒçš„åµŒå¥—ç»“æ„</li></ul><a href=#interceptor><h1 id=interceptor><span class=hanchor arialabel=Anchor># </span>Interceptor</h1></a><p>ä¸Šé¢æåˆ°è¿‡ï¼ŒOkHttp çš„æ‰€æœ‰æ‹¦æˆªå™¨ä¼šç»„æˆé“¾å¼ç»“æ„ï¼šå„ä¸ªæ‹¦æˆªå™¨å®Œæˆå‰ç½®å·¥ä½œåè°ƒç”¨ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨çš„ proceed æ–¹æ³•ï¼Œå†æ‰§è¡Œåç½®å·¥ä½œã€‚é€šè¿‡é€’å½’è°ƒç”¨ï¼Œæ¯ä¸ªæ‹¦æˆªå™¨å®Œæˆå„è‡ªçš„ä»»åŠ¡ã€‚</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035349.png width=auto alt></p><a href=#clientinterceptors><h2 id=clientinterceptors><span class=hanchor arialabel=Anchor># </span>client.interceptors</h2></a><p>é¦–å…ˆæ˜¯å¼€å‘è€…ä½¿ç”¨ addInterceptor(Interceptor) æ‰€è®¾ç½®çš„ï¼Œå®ƒä»¬ä¼šæŒ‰ç…§å¼€å‘è€…çš„è¦æ±‚ï¼Œåœ¨æ‰€æœ‰å…¶ä»– Interceptor å¤„ç†ä¹‹å‰ï¼Œè¿›è¡Œæœ€æ—©çš„é¢„å¤„ç†å·¥ä½œï¼Œä»¥åŠåœ¨æ”¶åˆ° Response ä¹‹åï¼Œåšæœ€åçš„å–„åå·¥ä½œã€‚å¦‚æœä½ æœ‰ç»Ÿä¸€çš„ header è¦æ·»åŠ ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®ã€‚</p><a href=#retryandfollowupinterceptor><h2 id=retryandfollowupinterceptor><span class=hanchor arialabel=Anchor># </span>RetryAndFollowUpInterceptor</h2></a><p>å®ƒä¼šå¯¹è¿æ¥åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå¹¶ä¸”è´Ÿè´£åœ¨è¯·æ±‚å¤±è´¥æ—¶çš„é‡è¯•ï¼Œä»¥åŠé‡å®šå‘çš„è‡ªåŠ¨åç»­è¯·æ±‚ã€‚å®ƒçš„å­˜åœ¨ï¼Œå¯ä»¥è®©<strong>é‡è¯•å’Œé‡å®šå‘</strong>å¯¹äºå¼€å‘è€…æ˜¯æ— æ„ŸçŸ¥çš„ã€‚</p><p>RetryAndFollowUpInterceptor.intercept ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>realChain</span> <span class=p>=</span> <span class=n>chain</span> <span class=k>as</span> <span class=n>RealInterceptorChain</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>request</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>call</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>call</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>followUpCount</span> <span class=p>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>priorResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>newExchangeFinder</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>recoveredFailures</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>&lt;</span><span class=n>IOException</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span><span class=p>.</span><span class=n>enterNetworkInterceptorExchange</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>newExchangeFinder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>response</span><span class=p>:</span> <span class=n>Response</span>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>closeActiveExchange</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//å…ˆåˆ¤æ–­è¯·æ±‚æ˜¯å¦å·²è¢«å–æ¶ˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>call</span><span class=p>.</span><span class=n>isCanceled</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>IOException</span><span class=p>(</span><span class=s2>&#34;Canceled&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//æ‰§è¡Œä¸‹ä¸€ä¸ªé“¾çš„ proceed
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>response</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>newExchangeFinder</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>RouteException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//åˆ¤æ–­æ˜¯å¦èƒ½æ¢å¤ï¼Œå¦‚æœèƒ½åˆ™ç»§ç»­ï¼Œå¦åˆ™ç»“æŸ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// The attempt to connect via a route failed. The request will not have been sent.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(!</span><span class=n>recover</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=n>lastConnectException</span><span class=p>,</span> <span class=n>call</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>requestSendStarted</span> <span class=p>=</span> <span class=k>false</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>throw</span> <span class=n>e</span><span class=p>.</span><span class=n>firstConnectException</span><span class=p>.</span><span class=n>withSuppressed</span><span class=p>(</span><span class=n>recoveredFailures</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>recoveredFailures</span> <span class=o>+=</span> <span class=n>e</span><span class=p>.</span><span class=n>firstConnectException</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>newExchangeFinder</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// An attempt to communicate with a server failed. The request may have been sent.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(!</span><span class=n>recover</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>call</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>requestSendStarted</span> <span class=p>=</span> <span class=n>e</span> <span class=o>!is</span> <span class=n>ConnectionShutdownException</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>throw</span> <span class=n>e</span><span class=p>.</span><span class=n>withSuppressed</span><span class=p>(</span><span class=n>recoveredFailures</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>recoveredFailures</span> <span class=o>+=</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>newExchangeFinder</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Attach the prior response if it exists. Such responses never have a body.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>priorResponse</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=p>=</span> <span class=n>response</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>priorResponse</span><span class=p>(</span><span class=n>priorResponse</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>exchange</span> <span class=p>=</span> <span class=n>call</span><span class=p>.</span><span class=n>interceptorScopedExchange</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>followUp</span> <span class=p>=</span> <span class=n>followUpRequest</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=n>exchange</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>followUp</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>exchange</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>exchange</span><span class=p>.</span><span class=n>isDuplex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>call</span><span class=p>.</span><span class=n>timeoutEarlyExit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>closeActiveExchange</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>followUpBody</span> <span class=p>=</span> <span class=n>followUp</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>followUpBody</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>followUpBody</span><span class=p>.</span><span class=n>isOneShot</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>closeActiveExchange</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>        <span class=c1>//è¿”å›
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>response</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>++</span><span class=n>followUpCount</span> <span class=p>&gt;</span> <span class=n>MAX_FOLLOW_UPS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ProtocolException</span><span class=p>(</span><span class=s2>&#34;Too many follow-up requests: </span><span class=si>$followUpCount</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>request</span> <span class=p>=</span> <span class=n>followUp</span>
</span></span><span class=line><span class=cl>      <span class=n>priorResponse</span> <span class=p>=</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span><span class=p>.</span><span class=n>exitNetworkInterceptorExchange</span><span class=p>(</span><span class=n>closeActiveExchange</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>recover</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>call</span><span class=p>:</span> <span class=n>RealCall</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>userRequest</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>requestSendStarted</span><span class=p>:</span> <span class=n>Boolean</span>
</span></span><span class=line><span class=cl><span class=p>):</span> <span class=n>Boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// The application layer has forbidden retries.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(!</span><span class=n>client</span><span class=p>.</span><span class=n>retryOnConnectionFailure</span><span class=p>)</span> <span class=k>return</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// We can&#39;t send the request body again.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>requestSendStarted</span> <span class=o>&amp;&amp;</span> <span class=n>requestIsOneShot</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>userRequest</span><span class=p>))</span> <span class=k>return</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// This exception is fatal.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!is</span><span class=n>Recoverable</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>requestSendStarted</span><span class=p>))</span> <span class=k>return</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// No more routes to attempt.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(!</span><span class=n>call</span><span class=p>.</span><span class=n>retryAfterFailure</span><span class=p>())</span> <span class=k>return</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// For failure recovery, use the same route selector with a new connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=k>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>followUpRequest</span><span class=p>(</span><span class=n>userResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>,</span> <span class=n>exchange</span><span class=p>:</span> <span class=n>Exchange</span><span class=p>?):</span> <span class=n>Request</span><span class=p>?</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>route</span> <span class=p>=</span> <span class=n>exchange</span><span class=o>?.</span><span class=n>connection</span><span class=o>?.</span><span class=n>route</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>responseCode</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>code</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>method</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span><span class=p>.</span><span class=n>method</span>
</span></span><span class=line><span class=cl>  <span class=k>when</span> <span class=p>(</span><span class=n>responseCode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_PROXY_AUTH</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>selectedProxy</span> <span class=p>=</span> <span class=n>route</span><span class=o>!!</span><span class=p>.</span><span class=n>proxy</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>selectedProxy</span><span class=p>.</span><span class=n>type</span><span class=p>()</span> <span class=o>!=</span> <span class=n>Proxy</span><span class=p>.</span><span class=n>Type</span><span class=p>.</span><span class=n>HTTP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ProtocolException</span><span class=p>(</span><span class=s2>&#34;Received HTTP_PROXY_AUTH (407) code while not using proxy&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>client</span><span class=p>.</span><span class=n>proxyAuthenticator</span><span class=p>.</span><span class=n>authenticate</span><span class=p>(</span><span class=n>route</span><span class=p>,</span> <span class=n>userResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_UNAUTHORIZED</span> <span class=o>-&gt;</span> <span class=k>return</span> <span class=n>client</span><span class=p>.</span><span class=n>authenticator</span><span class=p>.</span><span class=n>authenticate</span><span class=p>(</span><span class=n>route</span><span class=p>,</span> <span class=n>userResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_PERM_REDIRECT</span><span class=p>,</span> <span class=n>HTTP_TEMP_REDIRECT</span><span class=p>,</span> <span class=n>HTTP_MULT_CHOICE</span><span class=p>,</span> <span class=n>HTTP_MOVED_PERM</span><span class=p>,</span> <span class=n>HTTP_MOVED_TEMP</span><span class=p>,</span> <span class=n>HTTP_SEE_OTHER</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>buildRedirectRequest</span><span class=p>(</span><span class=n>userResponse</span><span class=p>,</span> <span class=n>method</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_CLIENT_TIMEOUT</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 408&#39;s are rare in practice, but some servers like HAProxy use this response code. The
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// spec says that we may repeat the request without modifications. Modern browsers also
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// repeat the request (even non-idempotent ones.)
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(!</span><span class=n>client</span><span class=p>.</span><span class=n>retryOnConnectionFailure</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// The application layer has directed us not to retry the request.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>requestBody</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>requestBody</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>requestBody</span><span class=p>.</span><span class=n>isOneShot</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>priorResponse</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>priorResponse</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>priorResponse</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>priorResponse</span><span class=p>.</span><span class=n>code</span> <span class=o>==</span> <span class=n>HTTP_CLIENT_TIMEOUT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// We attempted to retry and got another timeout. Give up.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>retryAfter</span><span class=p>(</span><span class=n>userResponse</span><span class=p>,</span> <span class=m>0</span><span class=p>)</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_UNAVAILABLE</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>priorResponse</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>priorResponse</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>priorResponse</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>priorResponse</span><span class=p>.</span><span class=n>code</span> <span class=o>==</span> <span class=n>HTTP_UNAVAILABLE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// We attempted to retry and got another timeout. Give up.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>retryAfter</span><span class=p>(</span><span class=n>userResponse</span><span class=p>,</span> <span class=n>Integer</span><span class=p>.</span><span class=n>MAX_VALUE</span><span class=p>)</span> <span class=o>==</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// specifically received an instruction to retry without delay
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_MISDIRECTED_REQUEST</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// OkHttp can coalesce HTTP/2 connections even if the domain names are different. See
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// RealConnection.isEligible(). If we attempted this and the server returned HTTP 421, then
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// we can retry on a different connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>val</span> <span class=py>requestBody</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>requestBody</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>requestBody</span><span class=p>.</span><span class=n>isOneShot</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>exchange</span> <span class=o>==</span> <span class=k>null</span> <span class=o>||</span> <span class=p>!</span><span class=n>exchange</span><span class=p>.</span><span class=n>isCoalescedConnection</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>connection</span><span class=p>.</span><span class=n>noCoalescedConnections</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=o>-&gt;</span> <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªè¿‡ç¨‹çš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035354.png width=auto alt></p><p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒRetryAndFollowUpInterceptor å¼€å¯äº†ä¸€ä¸ª while(true) çš„å¾ªç¯ï¼Œå¹¶åœ¨å¾ªç¯å†…éƒ¨å®Œæˆä¸¤ä¸ªé‡è¦çš„åˆ¤å®šï¼Œå¦‚å›¾ä¸­çš„è“è‰²æ–¹æ¡†ï¼š</p><ol><li>å½“è¯·æ±‚å†…éƒ¨æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œåˆ¤å®šæ˜¯å¦éœ€è¦é‡è¯•</li><li>å½“å“åº”ç»“æœæ˜¯ 3xx é‡å®šå‘æ—¶ï¼Œæ„å»ºæ–°çš„è¯·æ±‚å¹¶å‘é€è¯·æ±‚</li></ol><p>é‡è¯•çš„é€»è¾‘ç›¸å¯¹å¤æ‚ï¼Œæœ‰å¦‚ä¸‹çš„åˆ¤å®šé€»è¾‘ï¼ˆå…·ä½“ä»£ç åœ¨ RetryAndFollowUpInterceptor ç±»çš„ recover æ–¹æ³•ï¼‰ï¼š</p><ul><li>è§„åˆ™ 1: client çš„ retryOnConnectionFailure å‚æ•°è®¾ç½®ä¸º falseï¼Œä¸è¿›è¡Œé‡è¯•</li><li>è§„åˆ™ 2: è¯·æ±‚çš„ body å·²ç»å‘å‡ºï¼Œä¸è¿›è¡Œé‡è¯•</li><li>è§„åˆ™ 3: ç‰¹æ®Šçš„å¼‚å¸¸ç±»å‹ä¸è¿›è¡Œé‡è¯•ï¼ˆå¦‚ ProtocolExceptionï¼ŒSSLHandshakeException ç­‰ï¼‰</li><li>è§„åˆ™ 4: æ²¡æœ‰æ›´å¤šçš„ routeï¼ˆåŒ…å« proxy å’Œ inetaddressï¼‰ï¼Œä¸è¿›è¡Œé‡è¯•</li></ul><a href=#bridgeinterceptor><h2 id=bridgeinterceptor><span class=hanchor arialabel=Anchor># </span>BridgeInterceptor</h2></a><p>è´Ÿè´£ä¸€äº›ä¸å½±å“å¼€å‘è€…å¼€å‘ï¼Œä½†å½±å“ HTTP äº¤äº’çš„ä¸€äº›é¢å¤–é¢„å¤„ç†ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>userRequest</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>request</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>requestBuilder</span> <span class=p>=</span> <span class=n>userRequest</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>body</span> <span class=p>=</span> <span class=n>userRequest</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>body</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>contentType</span> <span class=p>=</span> <span class=n>body</span><span class=p>.</span><span class=n>contentType</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>contentType</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=n>contentType</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>contentLength</span> <span class=p>=</span> <span class=n>body</span><span class=p>.</span><span class=n>contentLength</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>contentLength</span> <span class=o>!=</span> <span class=p>-</span><span class=m>1L</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Content-Length&#34;</span><span class=p>,</span> <span class=n>contentLength</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>removeHeader</span><span class=p>(</span><span class=s2>&#34;Transfer-Encoding&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Transfer-Encoding&#34;</span><span class=p>,</span> <span class=s2>&#34;chunked&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>removeHeader</span><span class=p>(</span><span class=s2>&#34;Content-Length&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Host&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Host&#34;</span><span class=p>,</span> <span class=n>userRequest</span><span class=p>.</span><span class=n>url</span><span class=p>.</span><span class=n>toHostHeader</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Connection&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Connection&#34;</span><span class=p>,</span> <span class=s2>&#34;Keep-Alive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If we add an &#34;Accept-Encoding: gzip&#34; header field we&#39;re responsible for also decompressing
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// the transfer stream.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>var</span> <span class=py>transparentGzip</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Accept-Encoding&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Range&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>transparentGzip</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Accept-Encoding&#34;</span><span class=p>,</span> <span class=s2>&#34;gzip&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>cookies</span> <span class=p>=</span> <span class=n>cookieJar</span><span class=p>.</span><span class=n>loadForRequest</span><span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cookies</span><span class=p>.</span><span class=n>isNotEmpty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Cookie&#34;</span><span class=p>,</span> <span class=n>cookieHeader</span><span class=p>(</span><span class=n>cookies</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;User-Agent&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;User-Agent&#34;</span><span class=p>,</span> <span class=n>userAgent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>networkResponse</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>requestBuilder</span><span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>//æ”¶åˆ°å“åº”åï¼Œå­˜å‚¨ Cookieï¼š
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>cookieJar</span><span class=p>.</span><span class=n>receiveHeaders</span><span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>url</span><span class=p>,</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>responseBuilder</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>request</span><span class=p>(</span><span class=n>userRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>transparentGzip</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;gzip&#34;</span><span class=p>.</span><span class=n>equals</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Content-Encoding&#34;</span><span class=p>),</span> <span class=n>ignoreCase</span> <span class=p>=</span> <span class=k>true</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=n>networkResponse</span><span class=p>.</span><span class=n>promisesBody</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>responseBody</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>responseBody</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>gzipSource</span> <span class=p>=</span> <span class=n>GzipSource</span><span class=p>(</span><span class=n>responseBody</span><span class=p>.</span><span class=n>source</span><span class=p>())</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>strippedHeaders</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>headers</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>removeAll</span><span class=p>(</span><span class=s2>&#34;Content-Encoding&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>removeAll</span><span class=p>(</span><span class=s2>&#34;Content-Length&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>responseBuilder</span><span class=p>.</span><span class=n>headers</span><span class=p>(</span><span class=n>strippedHeaders</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>contentType</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>responseBuilder</span><span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=n>RealResponseBody</span><span class=p>(</span><span class=n>contentType</span><span class=p>,</span> <span class=p>-</span><span class=m>1L</span><span class=p>,</span> <span class=n>gzipSource</span><span class=p>.</span><span class=n>buffer</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>responseBuilder</span><span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>BridgeInterceptor æ‹¦æˆªå™¨çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ol><li>è´Ÿè´£æŠŠç”¨æˆ·æ„é€ çš„è¯·æ±‚è½¬æ¢ä¸ºå‘é€åˆ°æœåŠ¡å™¨çš„è¯·æ±‚ ã€æŠŠæœåŠ¡å™¨è¿”å›çš„å“åº”è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„å“åº”ï¼Œæ˜¯ä»åº”ç”¨ç¨‹åºä»£ç åˆ°ç½‘ç»œä»£ç çš„æ¡¥æ¢</li><li>è®¾ç½®å†…å®¹é•¿åº¦ï¼Œå†…å®¹ç¼–ç </li><li>è®¾ç½® gzip å‹ç¼©ï¼Œå¹¶åœ¨æ¥æ”¶åˆ°å†…å®¹åè¿›è¡Œè§£å‹ã€‚çœå»äº†åº”ç”¨å±‚å¤„ç†æ•°æ®è§£å‹çš„éº»çƒ¦</li><li>æ·»åŠ  cookie</li><li>è®¾ç½®å…¶ä»–æŠ¥å¤´ï¼Œå¦‚ Content-Lengthã€User-Agentã€Hostã€Keep-alive ç­‰ã€‚å…¶ä¸­ Keep-Alive æ˜¯å®ç°è¿æ¥å¤ç”¨çš„å¿…è¦æ­¥éª¤</li></ol><a href=#cacheinterceptor><h2 id=cacheinterceptor><span class=hanchor arialabel=Anchor># </span>CacheInterceptor</h2></a><p>è´Ÿè´£ Cache çš„å¤„ç†ã€‚æŠŠå®ƒæ”¾åœ¨åé¢çš„ç½‘ç»œäº¤äº’ç›¸å…³ Interceptor çš„å‰é¢çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœæœ¬åœ°æœ‰äº†å¯ç”¨çš„ Cacheï¼Œä¸€ä¸ªè¯·æ±‚å¯ä»¥åœ¨æ²¡æœ‰å‘ç”Ÿå®è´¨ç½‘ç»œäº¤äº’çš„æƒ…å†µä¸‹å°±è¿”å›ç¼“å­˜ç»“æœï¼Œè€Œå®Œå…¨ä¸éœ€è¦å¼€å‘è€…åšå‡ºä»»ä½•çš„é¢å¤–å·¥ä½œï¼Œè®© Cache æ›´åŠ æ— æ„ŸçŸ¥ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>call</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>call</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>cacheCandidate</span> <span class=p>=</span> <span class=n>cache</span><span class=o>?.</span><span class=k>get</span><span class=p>(</span><span class=n>chain</span><span class=p>.</span><span class=n>request</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>now</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>strategy</span> <span class=p>=</span> <span class=n>CacheStrategy</span><span class=p>.</span><span class=n>Factory</span><span class=p>(</span><span class=n>now</span><span class=p>,</span> <span class=n>chain</span><span class=p>.</span><span class=n>request</span><span class=p>(),</span> <span class=n>cacheCandidate</span><span class=p>).</span><span class=n>compute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>networkRequest</span> <span class=p>=</span> <span class=n>strategy</span><span class=p>.</span><span class=n>networkRequest</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>cacheResponse</span> <span class=p>=</span> <span class=n>strategy</span><span class=p>.</span><span class=n>cacheResponse</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>cache</span><span class=o>?.</span><span class=n>trackResponse</span><span class=p>(</span><span class=n>strategy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>listener</span> <span class=p>=</span> <span class=p>(</span><span class=n>call</span> <span class=k>as</span><span class=p>?</span> <span class=n>RealCall</span><span class=p>)</span><span class=o>?.</span><span class=n>eventListener</span> <span class=o>?:</span> <span class=n>EventListener</span><span class=p>.</span><span class=n>NONE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cacheCandidate</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>cacheResponse</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// The cache candidate wasn&#39;t applicable. Close it.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cacheCandidate</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If we&#39;re forbidden from using the network and the cache is insufficient, fail.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>networkRequest</span> <span class=o>==</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>cacheResponse</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Response</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>request</span><span class=p>(</span><span class=n>chain</span><span class=p>.</span><span class=n>request</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>protocol</span><span class=p>(</span><span class=n>Protocol</span><span class=p>.</span><span class=n>HTTP_1_1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>code</span><span class=p>(</span><span class=n>HTTP_GATEWAY_TIMEOUT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>message</span><span class=p>(</span><span class=s2>&#34;Unsatisfiable Request (only-if-cached)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=n>EMPTY_RESPONSE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>(-</span><span class=m>1L</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>().</span><span class=n>also</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>listener</span><span class=p>.</span><span class=n>satisfactionFailure</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If we don&#39;t need the network, we&#39;re done.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>networkRequest</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cacheResponse</span><span class=o>!!</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>cacheResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>().</span><span class=n>also</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>listener</span><span class=p>.</span><span class=n>cacheHit</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cacheResponse</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span><span class=p>.</span><span class=n>cacheConditionalHit</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=n>cacheResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>cache</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span><span class=p>.</span><span class=n>cacheMiss</span><span class=p>(</span><span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ²¡æœ‰å‘½ä¸­ç¼“å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>var</span> <span class=py>networkResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>networkResponse</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>networkRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If we&#39;re crashing on I/O or otherwise, don&#39;t leak the cache body.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>networkResponse</span> <span class=o>==</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>cacheCandidate</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cacheCandidate</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å¦‚æœç¼“å­˜ç­–ç•¥ä¸­ï¼Œç½‘ç»œå“åº”å’Œå“åº”ç¼“å­˜éƒ½ä¸ä¸ºnullï¼Œéœ€è¦æ›´æ–°å“åº”ç¼“å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// (æ¯”å¦‚ éœ€è¦å‘æœåŠ¡å™¨ç¡®è®¤ç¼“å­˜æ˜¯å¦å¯ç”¨çš„æƒ…å†µ)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// If we have a cache response too, then we&#39;re doing a conditional get.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>cacheResponse</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 304 çš„è¿”å›æ˜¯ä¸å¸¦ body çš„,æ­¤æ—¶å¿…é¡»è·å– cache çš„ body
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>networkResponse</span><span class=o>?.</span><span class=n>code</span> <span class=o>==</span> <span class=n>HTTP_NOT_MODIFIED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>cacheResponse</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>headers</span><span class=p>(</span><span class=n>combine</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>.</span><span class=n>headers</span><span class=p>,</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>headers</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>cacheResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>networkResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>networkResponse</span><span class=p>.</span><span class=n>body</span><span class=o>!!</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Update the cache after combining headers but before stripping the
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Content-Encoding header (as performed by initContentStream()).
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>cache</span><span class=o>!!</span><span class=p>.</span><span class=n>trackConditionalCacheHit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>cache</span><span class=p>.</span><span class=n>update</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>,</span> <span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>response</span><span class=p>.</span><span class=n>also</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>listener</span><span class=p>.</span><span class=n>cacheHit</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cacheResponse</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ„å»ºå“åº”å¯¹è±¡ï¼Œç­‰å¾…è¿”å›
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=o>!!</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>cacheResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>networkResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cache</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å°†è¯·æ±‚æ”¾åˆ°ç¼“å­˜ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=n>promisesBody</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>CacheStrategy</span><span class=p>.</span><span class=n>isCacheable</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=n>networkRequest</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Offer this request to the cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>val</span> <span class=py>cacheRequest</span> <span class=p>=</span> <span class=n>cache</span><span class=p>.</span><span class=n>put</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>cacheWritingResponse</span><span class=p>(</span><span class=n>cacheRequest</span><span class=p>,</span> <span class=n>response</span><span class=p>).</span><span class=n>also</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>cacheResponse</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// This will log a conditional cache miss only.
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>listener</span><span class=p>.</span><span class=n>cacheMiss</span><span class=p>(</span><span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœè¯·æ±‚ä¸èƒ½è¢«ç¼“å­˜ï¼Œåˆ™ç§»é™¤è¯¥è¯·æ±‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>HttpMethod</span><span class=p>.</span><span class=n>invalidatesCache</span><span class=p>(</span><span class=n>networkRequest</span><span class=p>.</span><span class=n>method</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cache</span><span class=p>.</span><span class=n>remove</span><span class=p>(</span><span class=n>networkRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>_</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// The cache cannot be written.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªè¿‡ç¨‹çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é€šè¿‡ Request å°è¯•åˆ° Cache ä¸­æ‹¿ç¼“å­˜ï¼Œå½“ç„¶å‰ææ˜¯ OkHttpClient ä¸­é…ç½®äº†ç¼“å­˜ï¼Œé»˜è®¤æ˜¯ä¸æ”¯æŒçš„ã€‚</li><li>æ ¹æ® responseã€timeã€request åˆ›å»ºä¸€ä¸ªç¼“å­˜ç­–ç•¥ï¼Œç”¨äºåˆ¤æ–­æ€æ ·ä½¿ç”¨ç¼“å­˜ã€‚</li><li>å¦‚æœç¼“å­˜ç­–ç•¥ä¸­è®¾ç½®ç¦æ­¢ä½¿ç”¨ç½‘ç»œï¼Œå¹¶ä¸”ç¼“å­˜åˆä¸ºç©ºï¼Œåˆ™æ„å»ºä¸€ä¸ª Response ç›´æ¥è¿”å›ï¼ˆè¿”å›ç ä¸º 504ï¼‰</li><li>ç¼“å­˜ç­–ç•¥ä¸­è®¾ç½®ä¸ä½¿ç”¨ç½‘ç»œï¼Œä½†æ˜¯åˆç¼“å­˜ï¼Œç›´æ¥è¿”å›ç¼“å­˜</li><li>æ¥ç€èµ°åç»­è¿‡æ»¤å™¨çš„æµç¨‹ï¼Œchain.proceed(networkRequest)</li><li>å½“ç¼“å­˜å­˜åœ¨çš„æ—¶å€™ï¼Œå¦‚æœç½‘ç»œè¿”å›çš„ Response ä¸º 304ï¼Œåˆ™ä½¿ç”¨ç¼“å­˜çš„ Responseã€‚</li><li>æ„å»ºç½‘ç»œè¯·æ±‚çš„ Response</li><li>å½“åœ¨ OkHttpClient ä¸­é…ç½®äº†ç¼“å­˜ï¼Œåˆ™å°†è¿™ä¸ª Response ç¼“å­˜èµ·æ¥ã€‚</li><li>ç¼“å­˜èµ·æ¥çš„æ­¥éª¤ä¹Ÿæ˜¯å…ˆç¼“å­˜ headerï¼Œå†ç¼“å­˜ bodyã€‚</li><li>è¿”å› Response</li></ol><a href=#connectinterceptor><h2 id=connectinterceptor><span class=hanchor arialabel=Anchor># </span>ConnectInterceptor</h2></a><p>è´Ÿè´£å»ºç«‹è¿æ¥ï¼Œå®ƒçš„æºç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>object</span> <span class=nc>ConnectInterceptor</span> <span class=p>:</span> <span class=n>Interceptor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>realChain</span> <span class=p>=</span> <span class=n>chain</span> <span class=k>as</span> <span class=n>RealInterceptorChain</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>exchange</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>call</span><span class=p>.</span><span class=n>initExchange</span><span class=p>(</span><span class=n>chain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>connectedChain</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>copy</span><span class=p>(</span><span class=n>exchange</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å¼€å§‹ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨çš„å·¥ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>connectedChain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>realChain</span><span class=p>.</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªç±»æœ¬èº«å¾ˆç®€å•ï¼Œä»æºç æ¥çœ‹ï¼Œå…³é”®çš„ä»£ç åªæœ‰æ³¨é‡Š 1 å¤„çš„é‚£ä¸€å¥ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼šä» RealCall ä¸­è·å¾—äº†ä¸€ä¸ªæ–°çš„ ExChange çš„å¯¹è±¡ã€‚è·Ÿè¸ªå®ƒçš„æ‰§è¡Œï¼Œå¯ä»¥å‘ç°å®ƒæœ‰å¦‚ä¸‹è°ƒç”¨é€»è¾‘ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035402.png width=auto alt></p><p>åœ¨è¿™ä¸ªæ­¥éª¤ä¸­ï¼ŒConnectInterceptor æœ€ç»ˆä¼šé€šè¿‡ Socket åˆ›å»ºå‡ºç½‘ç»œè¯·æ±‚æ‰€éœ€è¦çš„ TCP è¿æ¥ï¼ˆå¦‚æœæ˜¯ HTTPï¼‰ï¼Œæˆ–è€…æ˜¯å»ºç«‹åœ¨ TCP è¿æ¥ä¹‹ä¸Šçš„ TLS è¿æ¥ï¼ˆå¦‚æœæ˜¯ HTTPSï¼‰ã€‚å¹¶ä¸”ä¼šåˆ›å»ºå‡ºå¯¹åº”çš„ HttpCodec å¯¹è±¡ ï¼ˆç”¨äºç¼–ç è§£ç  HTTP è¯·æ±‚ï¼‰ï¼Œå¹¶ä¸”æœ€ç»ˆå°è£…æˆ Exchange å¯¹è±¡å¹¶è¿”å›ã€‚</p><a href=#clientnetworkinterceptors><h2 id=clientnetworkinterceptors><span class=hanchor arialabel=Anchor># </span>client.networkInterceptors</h2></a><p>client.networkInterceptors æ˜¯ç”±å¼€å‘è€…ä½¿ç”¨ addNetworkInterceptor(Interceptor) æ‰€è®¾ç½®çš„ï¼Œå®ƒä»¬çš„è¡Œä¸ºé€»è¾‘å’Œä½¿ç”¨ addInterceptor(Interceptor) åˆ›å»ºçš„ä¸€æ ·ï¼Œä½†ç”±äºä½ç½®ä¸åŒï¼Œæ‰€ä»¥è¿™é‡Œåˆ›å»ºçš„ Interceptor ä¼šçœ‹åˆ°æ¯ä¸ªè¯·æ±‚å’Œå“åº”çš„æ•°æ®ï¼ˆåŒ…æ‹¬é‡å®šå‘ä»¥åŠé‡è¯•çš„ä¸€äº›ä¸­é—´è¯·æ±‚å’Œå“åº”ï¼‰ï¼Œå¹¶ä¸”çœ‹åˆ°çš„æ˜¯å®Œæ•´åŸå§‹æ•°æ®ï¼Œè€Œä¸æ˜¯æ²¡æœ‰åŠ  Content-Length çš„è¯·æ±‚æ•°æ®ï¼Œæˆ–è€… Body è¿˜æ²¡æœ‰è¢« gzip è§£å‹çš„å“åº”æ•°æ®ã€‚å¤šæ•°æƒ…å†µï¼Œè¿™ä¸ªæ–¹æ³•ä¸éœ€è¦è¢«ä½¿ç”¨ï¼Œä¸è¿‡å¦‚æœéœ€è¦åšç½‘ç»œè°ƒè¯•ï¼Œå¯ä»¥ç”¨å®ƒæ¥å®ç°ã€‚</p><a href=#callserverinterceptor><h2 id=callserverinterceptor><span class=hanchor arialabel=Anchor># </span>CallServerInterceptor</h2></a><p>CalllServerInterceptor æ˜¯æœ€åä¸€ä¸ªæ‹¦æˆªå™¨äº†ï¼Œå®ƒè´Ÿè´£å®è´¨çš„è¯·æ±‚ä¸å“åº”çš„ I/O æ“ä½œï¼Œå³ï¼šå¾€ Socket é‡Œå†™å…¥è¯·æ±‚æ•°æ®å’Œä» Socket é‡Œè¯»å–å“åº”æ•°æ®ï¼Œè¿›è¡Œ http è¯·æ±‚æŠ¥æ–‡çš„å°è£…ä¸è¯·æ±‚æŠ¥æ–‡çš„è§£æã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>realChain</span> <span class=p>=</span> <span class=n>chain</span> <span class=k>as</span> <span class=n>RealInterceptorChain</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>exchange</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>exchange</span><span class=o>!!</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>request</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>requestBody</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>sentRequestMillis</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>exchange</span><span class=p>.</span><span class=n>writeRequestHeaders</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>invokeStartEvent</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>responseBuilder</span><span class=p>:</span> <span class=n>Response</span><span class=p>.</span><span class=n>Builder</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>HttpMethod</span><span class=p>.</span><span class=n>permitsRequestBody</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>method</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>requestBody</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If there&#39;s a &#34;Expect: 100-continue&#34; header on the request, wait for a &#34;HTTP/1.1 100
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Continue&#34; response before transmitting the request body. If we don&#39;t get that, return
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// what we did get (such as a 4xx response) without ever transmitting the request body.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=s2>&#34;100-continue&#34;</span><span class=p>.</span><span class=n>equals</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Expect&#34;</span><span class=p>),</span> <span class=n>ignoreCase</span> <span class=p>=</span> <span class=k>true</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>flushRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>responseBuilder</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>readResponseHeaders</span><span class=p>(</span><span class=n>expectContinue</span> <span class=p>=</span> <span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>responseHeadersStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>invokeStartEvent</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>responseBuilder</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>requestBody</span><span class=p>.</span><span class=n>isDuplex</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Prepare a duplex body so that the application can send a request body later.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>exchange</span><span class=p>.</span><span class=n>flushRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>bufferedRequestBody</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>createRequestBody</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=k>true</span><span class=p>).</span><span class=n>buffer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>requestBody</span><span class=p>.</span><span class=n>writeTo</span><span class=p>(</span><span class=n>bufferedRequestBody</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Write the request body if the &#34;Expect: 100-continue&#34; expectation was met.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>bufferedRequestBody</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>createRequestBody</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=k>false</span><span class=p>).</span><span class=n>buffer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>requestBody</span><span class=p>.</span><span class=n>writeTo</span><span class=p>(</span><span class=n>bufferedRequestBody</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>bufferedRequestBody</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>noRequestBody</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(!</span><span class=n>exchange</span><span class=p>.</span><span class=n>connection</span><span class=p>.</span><span class=n>isMultiplexed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If the &#34;Expect: 100-continue&#34; expectation wasn&#39;t met, prevent the HTTP/1 connection
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// from being reused. Otherwise we&#39;re still obligated to transmit the request body to
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// leave the connection in a consistent state.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>exchange</span><span class=p>.</span><span class=n>noNewExchangesOnConnection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>exchange</span><span class=p>.</span><span class=n>noRequestBody</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>requestBody</span> <span class=o>==</span> <span class=k>null</span> <span class=o>||</span> <span class=p>!</span><span class=n>requestBody</span><span class=p>.</span><span class=n>isDuplex</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>exchange</span><span class=p>.</span><span class=n>finishRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>responseBuilder</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>responseBuilder</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>readResponseHeaders</span><span class=p>(</span><span class=n>expectContinue</span> <span class=p>=</span> <span class=k>false</span><span class=p>)</span><span class=o>!!</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>invokeStartEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>responseHeadersStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>invokeStartEvent</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>response</span> <span class=p>=</span> <span class=n>responseBuilder</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>request</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>handshake</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=n>connection</span><span class=p>.</span><span class=n>handshake</span><span class=p>())</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>(</span><span class=n>sentRequestMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>())</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>code</span> <span class=p>=</span> <span class=n>response</span><span class=p>.</span><span class=n>code</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>code</span> <span class=o>==</span> <span class=m>100</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Server sent a 100-continue even though we did not request one. Try again to read the actual
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// response status.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>responseBuilder</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>readResponseHeaders</span><span class=p>(</span><span class=n>expectContinue</span> <span class=p>=</span> <span class=k>false</span><span class=p>)</span><span class=o>!!</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>invokeStartEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>responseHeadersStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=p>=</span> <span class=n>responseBuilder</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>request</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>handshake</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=n>connection</span><span class=p>.</span><span class=n>handshake</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>(</span><span class=n>sentRequestMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=p>=</span> <span class=n>response</span><span class=p>.</span><span class=n>code</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>exchange</span><span class=p>.</span><span class=n>responseHeadersEnd</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>response</span> <span class=p>=</span> <span class=k>if</span> <span class=p>(</span><span class=n>forWebSocket</span> <span class=o>&amp;&amp;</span> <span class=n>code</span> <span class=o>==</span> <span class=m>101</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Connection is upgrading, but we need to ensure interceptors see a non-null response body.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>response</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=n>EMPTY_RESPONSE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=n>openResponseBody</span><span class=p>(</span><span class=n>response</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=s2>&#34;close&#34;</span><span class=p>.</span><span class=n>equals</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=n>request</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Connection&#34;</span><span class=p>),</span> <span class=n>ignoreCase</span> <span class=p>=</span> <span class=k>true</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;close&#34;</span><span class=p>.</span><span class=n>equals</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Connection&#34;</span><span class=p>),</span> <span class=n>ignoreCase</span> <span class=p>=</span> <span class=k>true</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>exchange</span><span class=p>.</span><span class=n>noNewExchangesOnConnection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>code</span> <span class=o>==</span> <span class=m>204</span> <span class=o>||</span> <span class=n>code</span> <span class=o>==</span> <span class=m>205</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>response</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>contentLength</span><span class=p>()</span> <span class=o>?:</span> <span class=p>-</span><span class=m>1L</span> <span class=p>&gt;</span> <span class=m>0L</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>ProtocolException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;HTTP </span><span class=si>$code</span><span class=s2> had non-zero Content-Length: </span><span class=si>${response.body?.contentLength()}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>CallServerInterceptor ç”±ä»¥ä¸‹æ­¥éª¤ç»„æˆï¼š</p><ol><li>å‘æœåŠ¡å™¨å‘é€ request header</li><li>å¦‚æœæœ‰ request bodyï¼Œå°±å‘æœåŠ¡å™¨å‘é€</li><li>è¯»å– response headerï¼Œå…ˆæ„é€ ä¸€ä¸ª Response å¯¹è±¡</li><li>å¦‚æœæœ‰ response bodyï¼Œå°±åœ¨ 3 çš„åŸºç¡€ä¸ŠåŠ ä¸Š body æ„é€ ä¸€ä¸ªæ–°çš„ Response å¯¹è±¡</li></ol><p>å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒå·¥ä½œéƒ½ç”± <strong>HttpCodec</strong> å¯¹è±¡å®Œæˆï¼Œè€Œ HttpCodec å®é™…ä¸Šåˆ©ç”¨çš„æ˜¯ Okioï¼Œè€Œ Okio å®é™…ä¸Šè¿˜æ˜¯ç”¨çš„ Socketï¼Œåªä¸è¿‡æ˜¯ç»è¿‡äº†å±‚å±‚åµŒå¥—ã€‚</p><a href=#æ€»ç»“><h1 id=æ€»ç»“><span class=hanchor arialabel=Anchor># </span>æ€»ç»“</h1></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035408.png width=auto alt></p></article><hr><div class=page-end id=footer><div class=fixed-right><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></div></div></body></html>