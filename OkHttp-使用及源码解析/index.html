<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="https://juejin.cn/post/6881436122950402056
请求流程 同步请求 MainActivity.kt
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  val user = &#34;guanpj&#34; val client = OkHttpClient."><meta property="og:title" content="OkHttp 使用及源码分析 "><meta property="og:description" content="https://juejin.cn/post/6881436122950402056
请求流程 同步请求 MainActivity.kt
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  val user = &#34;guanpj&#34; val client = OkHttpClient."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="OkHttp 使用及源码分析 "><meta name=twitter:description content="https://juejin.cn/post/6881436122950402056
请求流程 同步请求 MainActivity.kt
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  val user = &#34;guanpj&#34; val client = OkHttpClient."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>OkHttp 使用及源码分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.138d20df1c76453999963c9af77d96e4.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.cf6439e057b2800c40a018b5e420d51c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.370886dee394ffa436835dd8e7756e9b.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><div class=row><div class=col-md-3 id=toc><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#请求流程>请求流程</a><ol><li><a href=#strong同步请求strong><strong>同步请求</strong></a></li><li><a href=#strong异步请求strong><strong>异步请求</strong></a></li><li><a href=#getresponsewithinterceptorchain>getResponseWithInterceptorChain</a></li></ol></li><li><a href=#okhttpclient>OkHttpClient</a></li><li><a href=#strongrequest-和-responsestrong><strong>Request 和 Response</strong></a></li><li><a href=#realcall>RealCall</a></li><li><a href=#interceptor>Interceptor</a><ol><li><a href=#clientinterceptors>client.interceptors</a></li><li><a href=#retryandfollowupinterceptor>RetryAndFollowUpInterceptor</a></li><li><a href=#bridgeinterceptor>BridgeInterceptor</a></li><li><a href=#cacheinterceptor>CacheInterceptor</a></li><li><a href=#connectinterceptor>ConnectInterceptor</a></li><li><a href=#clientnetworkinterceptors>client.networkInterceptors</a></li><li><a href=#callserverinterceptor>CallServerInterceptor</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></details></aside></div><div class=col-md-9><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>OkHttp 使用及源码分析</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/OkHttp/>OK HTTP</a></li><li><a href=https://www.guanpj.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>源码解析</a></li></ul><p><a href=https://juejin.cn/post/6881436122950402056 rel=noopener>https://juejin.cn/post/6881436122950402056</a></p><a href=#请求流程><h1 id=请求流程><span class=hanchor arialabel=Anchor># </span>请求流程</h1></a><a href=#strong同步请求strong><h2 id=strong同步请求strong><span class=hanchor arialabel=Anchor># </span><strong>同步请求</strong></h2></a><p><em>MainActivity.kt</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>user</span> <span class=p>=</span> <span class=s2>&#34;guanpj&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>client</span> <span class=p>=</span> <span class=n>OkHttpClient</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>connectTimeout</span><span class=p>(</span><span class=m>15</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>writeTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>readTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>proxy</span><span class=p>(</span><span class=n>Proxy</span><span class=p>.</span><span class=n>NO_PROXY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addInterceptor</span><span class=p>(</span><span class=n>HttpLoggingInterceptor</span> <span class=p>{</span> <span class=n>message</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>BuildConfig</span><span class=p>.</span><span class=n>DEBUG</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=p>.</span><span class=n>i</span><span class=p>(</span><span class=s2>&#34;OkHttp&#34;</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span> <span class=p>=</span> <span class=n>Request</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>url</span><span class=p>(</span><span class=s2>&#34;https://api.github.com/users/</span><span class=si>$user</span><span class=s2>/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>).</span><span class=n>execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>println</span><span class=p>(</span><span class=s2>&#34;Response status code: </span><span class=si>${response.code}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><em>OkHttpClient.kt</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=cm>/** Prepares the [request] to be executed at some point in the future. */</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>):</span> <span class=n>Call</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>         <span class=n>RealCall</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>forWebSocket</span> <span class=p>=</span> <span class=k>false</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><em>RealCall.execute</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>execute</span><span class=p>():</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//保证每个 call 只能被执行一次
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>check</span><span class=p>(</span><span class=n>executed</span><span class=p>.</span><span class=n>compareAndSet</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=k>true</span><span class=p>))</span> <span class=p>{</span> <span class=s2>&#34;Already Executed&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>timeout</span><span class=p>.</span><span class=n>enter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>callStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>executed</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getResponseWithInterceptorChain</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>finished</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><em>Dispatcher.executed</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Synchronized</span> <span class=k>internal</span> <span class=k>fun</span> <span class=nf>executed</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>RealCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>runningSyncCalls</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，在 extcuted 方法中并没有具体执行请求的方法，仅仅是把当前对象存入 runningSyncCalls 集合中。同步请求的核心部分在接下来的 getResponseWithInterceptorChain 中，此方法直接返回了请求结果 Response，事实上这个方法调用栈非常复杂，这里先按下不表。最后在 finially 代码块中调用了 <code>client.dispatcher.finished(this)</code>，也是传入了 this 对象，我们有理由猜测这一步就是将它从 runningSyncCalls 集合中移除，这里同样等到异步请求流程一并分析。</p><a href=#strong异步请求strong><h2 id=strong异步请求strong><span class=hanchor arialabel=Anchor># </span><strong>异步请求</strong></h2></a><p><em>MainActivity.kt</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>user</span> <span class=p>=</span> <span class=s2>&#34;guanpj&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>client</span> <span class=p>=</span> <span class=n>OkHttpClient</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span> <span class=p>=</span> <span class=n>Request</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>url</span><span class=p>(</span><span class=s2>&#34;https://api.github.com/users/</span><span class=si>$user</span><span class=s2>/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=p>.</span><span class=n>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>enqueue</span><span class=p>(</span><span class=k>object</span> <span class=err>: </span><span class=nc>Callback</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onFailure</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>Call</span><span class=p>,</span> <span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=p>.</span><span class=n>printStackTrace</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onResponse</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>Call</span><span class=p>,</span> <span class=n>response</span><span class=p>:</span> <span class=n>Response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>println</span><span class=p>(</span><span class=s2>&#34;Response status code: </span><span class=si>${response.code}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p><em>RealCall.enqueue</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>enqueue</span><span class=p>(</span><span class=n>responseCallback</span><span class=p>:</span> <span class=n>Callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>check</span><span class=p>(</span><span class=n>executed</span><span class=p>.</span><span class=n>compareAndSet</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=k>true</span><span class=p>))</span> <span class=p>{</span> <span class=s2>&#34;Already Executed&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>callStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>//包装成 AsyncCall，放入待执行的异步请求请求列表
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>enqueue</span><span class=p>(</span><span class=n>AsyncCall</span><span class=p>(</span><span class=n>responseCallback</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><em>Dispatcher.enqueue</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>enqueue</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>AsyncCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>synchronized</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//首先将 call 放入 readyAsyncCalls 集合
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>readyAsyncCalls</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Mutate the AsyncCall so that it shares the AtomicInteger of an existing running call to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the same host.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(!</span><span class=n>call</span><span class=p>.</span><span class=n>call</span><span class=p>.</span><span class=n>forWebSocket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>existingCall</span> <span class=p>=</span> <span class=n>findExistingCallWithHost</span><span class=p>(</span><span class=n>call</span><span class=p>.</span><span class=n>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>existingCall</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=n>call</span><span class=p>.</span><span class=n>reuseCallsPerHostFrom</span><span class=p>(</span><span class=n>existingCall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//然后调用此方法执行
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>promoteAndExecute</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>readyAsyncCalls 意思温为“准备好的异步请求”，而 promoteAndExecute 方法单从命名来看就是提升和执行，具体分析如下：</p><p><em>Dispatcher.promoteAndExecute</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>promoteAndExecute</span><span class=p>():</span> <span class=n>Boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>assertThreadDoesntHoldLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>//新建一个列表存放可执行的请求
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>val</span> <span class=py>executableCalls</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>&lt;</span><span class=n>AsyncCall</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>isRunning</span><span class=p>:</span> <span class=n>Boolean</span>
</span></span><span class=line><span class=cl>  <span class=n>synchronized</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>i</span> <span class=p>=</span> <span class=n>readyAsyncCalls</span><span class=p>.</span><span class=n>iterator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//遍历准备好的异步请求
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>hasNext</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>asyncCall</span> <span class=p>=</span> <span class=n>i</span><span class=p>.</span><span class=n>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=c1>//总请求数不能超过 64 个
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>runningAsyncCalls</span><span class=p>.</span><span class=n>size</span> <span class=o>&gt;=</span> <span class=k>this</span><span class=p>.</span><span class=n>maxRequests</span><span class=p>)</span> <span class=k>break</span> <span class=c1>// Max capacity.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>//每个主机请求数量不能超过 5 个
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>asyncCall</span><span class=p>.</span><span class=n>callsPerHost</span><span class=p>.</span><span class=k>get</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=k>this</span><span class=p>.</span><span class=n>maxRequestsPerHost</span><span class=p>)</span> <span class=k>continue</span> <span class=c1>// Host max capacity.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>//从 readyAsyncCalls 集合中移除
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>i</span><span class=p>.</span><span class=n>remove</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=c1>//安全自增
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>asyncCall</span><span class=p>.</span><span class=n>callsPerHost</span><span class=p>.</span><span class=n>incrementAndGet</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=c1>//加入到 executableCalls 集合
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>executableCalls</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>asyncCall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=c1>//加入到 runningAsyncCalls 集合
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>runningAsyncCalls</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>asyncCall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//获取正在执行中的请求（同步和异步）总数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>isRunning</span> <span class=p>=</span> <span class=n>runningCallsCount</span><span class=p>()</span> <span class=p>&gt;</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//遍历可执行请求的集合
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=k>in</span> <span class=m>0</span> <span class=n>until</span> <span class=n>executableCalls</span><span class=p>.</span><span class=n>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>asyncCall</span> <span class=p>=</span> <span class=n>executableCalls</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1>//调用它们的 executeOn 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>asyncCall</span><span class=p>.</span><span class=n>executeOn</span><span class=p>(</span><span class=n>executorService</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//返回正在执行中的请求（同步和异步）总数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>isRunning</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Synchronized</span> <span class=k>fun</span> <span class=nf>runningCallsCount</span><span class=p>():</span> <span class=n>Int</span> 
</span></span><span class=line><span class=cl>        <span class=p>=</span> <span class=n>runningAsyncCalls</span><span class=p>.</span><span class=n>size</span> <span class=p>+</span> <span class=n>runningSyncCalls</span><span class=p>.</span><span class=n>size</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，该方法可拆分为三个步骤：</p><ol><li>首先，一个请求从上一步被放入 readyAsyncCalls 集合中，在这里将遍历该集合并在条件允许的情况下将集合中的请求移除并分别加入到 runningAsyncCalls 和 executableCalls 集合；</li><li>接着遍历 executableCalls 集合并调用每个 AysncCall 的 executeOn 方法，并传入 executorService 对像用于执行这个 Call。AsyncCall 是 RealCall 中的一个内部类；</li><li>最后返回正在执行中的同步和异步请求的总数。</li></ol><p>这里重点看第二点：</p><p><em>RealCall.AsyncCall</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>inner</span> <span class=k>class</span> <span class=nc>AsyncCall</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>val</span> <span class=py>responseCallback</span><span class=p>:</span> <span class=n>Callback</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>Runnable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Volatile</span> <span class=k>var</span> <span class=py>callsPerHost</span> <span class=p>=</span> <span class=n>AtomicInteger</span><span class=p>(</span><span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>set</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>reuseCallsPerHostFrom</span><span class=p>(</span><span class=n>other</span><span class=p>:</span> <span class=n>AsyncCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=n>callsPerHost</span> <span class=p>=</span> <span class=n>other</span><span class=p>.</span><span class=n>callsPerHost</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>host</span><span class=p>:</span> <span class=n>String</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=n>originalRequest</span><span class=p>.</span><span class=n>url</span><span class=p>.</span><span class=n>host</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span>
</span></span><span class=line><span class=cl>      <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=n>originalRequest</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>call</span><span class=p>:</span> <span class=n>RealCall</span>
</span></span><span class=line><span class=cl>      <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=k>this</span><span class=nd>@RealCall</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Attempt to enqueue this async call on [executorService]. This will attempt to clean up
</span></span></span><span class=line><span class=cl><span class=cm>   * if the executor has been shut down by reporting the call as failed.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>executeOn</span><span class=p>(</span><span class=n>executorService</span><span class=p>:</span> <span class=n>ExecutorService</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>assertThreadDoesntHoldLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>success</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//调用 executorService 执行自己
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>executorService</span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>success</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>RejectedExecutionException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>ioException</span> <span class=p>=</span> <span class=n>InterruptedIOException</span><span class=p>(</span><span class=s2>&#34;executor rejected&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>ioException</span><span class=p>.</span><span class=n>initCause</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>noMoreExchanges</span><span class=p>(</span><span class=n>ioException</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>responseCallback</span><span class=p>.</span><span class=n>onFailure</span><span class=p>(</span><span class=k>this</span><span class=nd>@RealCall</span><span class=p>,</span> <span class=n>ioException</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(!</span><span class=n>success</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>finished</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=c1>// This call is no longer running!
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>//被 executorService.execute 时调用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>override</span> <span class=k>fun</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>threadName</span><span class=p>(</span><span class=s2>&#34;OkHttp </span><span class=si>${redactedUrl()}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>var</span> <span class=py>signalledCallback</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>      <span class=n>timeout</span><span class=p>.</span><span class=n>enter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//1、在 executorService 中异步执行
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>getResponseWithInterceptorChain</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>signalledCallback</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>        <span class=c1>//2、回调结果
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>responseCallback</span><span class=p>.</span><span class=n>onResponse</span><span class=p>(</span><span class=k>this</span><span class=nd>@RealCall</span><span class=p>,</span> <span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>signalledCallback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Do not signal the callback twice!
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>Platform</span><span class=p>.</span><span class=k>get</span><span class=p>().</span><span class=n>log</span><span class=p>(</span><span class=s2>&#34;Callback failure for </span><span class=si>${toLoggableString()}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>Platform</span><span class=p>.</span><span class=n>INFO</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>//回调结果
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>responseCallback</span><span class=p>.</span><span class=n>onFailure</span><span class=p>(</span><span class=k>this</span><span class=nd>@RealCall</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>t</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=n>signalledCallback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>val</span> <span class=py>canceledException</span> <span class=p>=</span> <span class=n>IOException</span><span class=p>(</span><span class=s2>&#34;canceled due to </span><span class=si>$t</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>canceledException</span><span class=p>.</span><span class=n>addSuppressed</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=c1>//回调结果
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>responseCallback</span><span class=p>.</span><span class=n>onFailure</span><span class=p>(</span><span class=k>this</span><span class=nd>@RealCall</span><span class=p>,</span> <span class=n>canceledException</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>t</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//3、后续操作
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>client</span><span class=p>.</span><span class=n>dispatcher</span><span class=p>.</span><span class=n>finished</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>因为是异步请求，所以请求操作必然是在异步线程中执行的，可以看到，在 run 方法中，异步请求正常情况下分为三个步骤：</p><ol><li>调用 getResponseWithInterceptorChain 方法获取 Resonse 结果，这点和同步请求一样。</li><li>将 Response 对象通过 responseCallback 进行回调。</li><li>在 finally 中调用 <code>client.dispatcher.finished(this)</code> 方法。</li></ol><p>第一步还是留到后面，第二步无须多解释，来看第三步，在同步请求流程的足后也同样执行了这个步骤。</p><p><em>Dispatcher.finish</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>finished</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>AsyncCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>call</span><span class=p>.</span><span class=n>callsPerHost</span><span class=p>.</span><span class=n>decrementAndGet</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>finished</span><span class=p>(</span><span class=n>runningAsyncCalls</span><span class=p>,</span> <span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>finished</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>RealCall</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>finished</span><span class=p>(</span><span class=n>runningSyncCalls</span><span class=p>,</span> <span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span><span class=p>&gt;</span> <span class=nf>finished</span><span class=p>(</span><span class=n>calls</span><span class=p>:</span> <span class=n>Deque</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;,</span> <span class=n>call</span><span class=p>:</span> <span class=n>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>idleCallback</span><span class=p>:</span> <span class=n>Runnable</span><span class=p>?</span>
</span></span><span class=line><span class=cl>  <span class=n>synchronized</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(!</span><span class=n>calls</span><span class=p>.</span><span class=n>remove</span><span class=p>(</span><span class=n>call</span><span class=p>))</span> <span class=k>throw</span> <span class=n>AssertionError</span><span class=p>(</span><span class=s2>&#34;Call wasn&#39;t in-flight!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>idleCallback</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>idleCallback</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>isRunning</span> <span class=p>=</span> <span class=n>promoteAndExecute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!is</span><span class=n>Running</span> <span class=o>&amp;&amp;</span> <span class=n>idleCallback</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>idleCallback</span><span class=p>.</span><span class=n>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>不管同步还是异步的 Call，最后都会走到最后一个方法，果然这里分别移除了 runningAsyncCalls 和 runningSyncCalls 集合中的 Call 对象。除此之外，这里再次调用了 promoteAndExecute 方法，前面提到过，这里返回的是正在执行中的同步和异步请求个数。当所有请求都执行完成后，会调用 idleCallback.run 方法进行回调。</p><a href=#getresponsewithinterceptorchain><h2 id=getresponsewithinterceptorchain><span class=hanchor arialabel=Anchor># </span>getResponseWithInterceptorChain</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>getResponseWithInterceptorChain</span><span class=p>():</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Build a full stack of interceptors.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>val</span> <span class=py>interceptors</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>&lt;</span><span class=n>Interceptor</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>client</span><span class=p>.</span><span class=n>interceptors</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>RetryAndFollowUpInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>BridgeInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=n>cookieJar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>CacheInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=n>cache</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>ConnectInterceptor</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(!</span><span class=n>forWebSocket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>client</span><span class=p>.</span><span class=n>networkInterceptors</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>CallServerInterceptor</span><span class=p>(</span><span class=n>forWebSocket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>chain</span> <span class=p>=</span> <span class=n>RealInterceptorChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span> <span class=p>=</span> <span class=k>this</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>interceptors</span> <span class=p>=</span> <span class=n>interceptors</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>index</span> <span class=p>=</span> <span class=m>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span> <span class=p>=</span> <span class=k>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>request</span> <span class=p>=</span> <span class=n>originalRequest</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>connectTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>connectTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>readTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>readTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>writeTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>writeTimeoutMillis</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>calledNoMoreExchanges</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>originalRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>isCanceled</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>response</span><span class=p>.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=n>IOException</span><span class=p>(</span><span class=s2>&#34;Canceled&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>calledNoMoreExchanges</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>noMoreExchanges</span><span class=p>(</span><span class=n>e</span><span class=p>)</span> <span class=k>as</span> <span class=n>Throwable</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(!</span><span class=n>calledNoMoreExchanges</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>noMoreExchanges</span><span class=p>(</span><span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先将以下拦截器依次加入到 List 中：</p><ol><li>OkHttpClient 设置的拦截器 interceptors()</li><li>重试、重定向拦截器 RetryAndFollowUpInterceptor</li><li>把用户请求转换为服务器请求、把服务器返响应转换为用户响应的 BridgeInterceptor</li><li>读取缓存直接返回、将响应写入到缓存中的 CacheInterceptor</li><li>与服务器建立连接的 ConnectInterceptor</li><li>OkHttpClient 设置的网络拦截器 networkInterceptors()</li><li>真正执行网络请求的 CallServerInterceptor</li></ol><p>将所有的拦截器保存在 interceptors 集合中后，创建一个拦截器责任链 RealInterceptorChain，并调用其 proceed 开始处理网络请求。那么责任链模式是如何工作的呢？</p><p>首先查看 RealInterceptorChain 的源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>RealInterceptorChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>call</span><span class=p>:</span> <span class=n>RealCall</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>val</span> <span class=py>interceptors</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Interceptor</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>val</span> <span class=py>index</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>exchange</span><span class=p>:</span> <span class=n>Exchange</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>connectTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>readTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>writeTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>var</span> <span class=py>calls</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>fun</span> <span class=nf>copy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>index</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>exchange</span><span class=p>:</span> <span class=n>Exchange</span><span class=p>?</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>exchange</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>:</span> <span class=n>Request</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>connectTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>connectTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>readTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>readTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>writeTimeoutMillis</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>writeTimeoutMillis</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>=</span> <span class=n>RealInterceptorChain</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=n>interceptors</span><span class=p>,</span> <span class=n>index</span><span class=p>,</span> <span class=n>exchange</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>connectTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>readTimeoutMillis</span><span class=p>,</span> <span class=n>writeTimeoutMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>override</span> <span class=k>fun</span> <span class=nf>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>check</span><span class=p>(</span><span class=n>index</span> <span class=p>&lt;</span> <span class=n>interceptors</span><span class=p>.</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>calls</span><span class=o>++</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Call the next interceptor in the chain.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=py>next</span> <span class=p>=</span> <span class=n>copy</span><span class=p>(</span><span class=n>index</span> <span class=p>=</span> <span class=n>index</span> <span class=p>+</span> <span class=m>1</span><span class=p>,</span> <span class=n>request</span> <span class=p>=</span> <span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>interceptor</span> <span class=p>=</span> <span class=n>interceptors</span><span class=p>[</span><span class=n>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Suppress</span><span class=p>(</span><span class=s2>&#34;USELESS_ELVIS&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>interceptor</span><span class=p>.</span><span class=n>intercept</span><span class=p>(</span><span class=n>next</span><span class=p>)</span> <span class=o>?:</span> <span class=k>throw</span> <span class=n>NullPointerException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;interceptor </span><span class=si>$interceptor</span><span class=s2> returned null&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在不考虑 OkHttpClient.interceptor() 的情况下，首次执行 getResponseWithInterceptorChain 方法时上面这两段代码的解释如下：</p><ol><li>在 getResponseWithInterceptorChain 创建了一个 index 为 0 的 RealInterceptorChain，接着调用了其 proceed 方法；</li><li>在 RealInterceptorChain.proceed 方法中，将 index+1 并且和其它成员变量一起 copy 出一个新的 RealInterceptorChain 对象 next；</li><li>然后对当前 index 的拦截器（即 RetryAndFollowUpInterceptor）执行 interceptor.intercept(next)。在 RetryAndFollowUpInterceptor 方法中执行了 next.proceed 方法，而这里的 next 同样是 RealInterceptorChain 实例，所以回到了 RealInterceptorChain.proceed 方法中；</li><li>此时 index=1，同理链条可以一直执行下去直到 index 等于 n-1；</li><li>遇到最后一个拦截器 CallServerInterceptor，链不能继续下去了，CallServerInterceptor.intercept 方法中也不会再 proceed 了；</li><li>CallServerInterceptor 建立连接后开始递归返回，Response 的返回与 Request 相反，会从最后一个开始依次往前经过这些 Intercetor。</li></ol><p>下图为 OkHttp 工作的大致流程，参考自
<a href=https://blog.piasy.com/2016/07/11/Understand-OkHttp/index.html rel=noopener>拆轮子系列：拆 OkHttp</a></p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035335.png width=auto alt></p><p>同步请求和异步请求流程时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035341.png width=auto alt></p><a href=#okhttpclient><h1 id=okhttpclient><span class=hanchor arialabel=Anchor># </span>OkHttpClient</h1></a><p>OkHttpClient 相当于配置中心，所有的请求都会共享这些配置（例如出错是否重试、共享的连接池）。 OkHttpClient 中的配置主要有:</p><ul><li><code>Dispatcher dispatcher</code> : 调度器，用于调度后台发起的网络请求， 有后台总请求数和单主机总请求数的控制。</li><li><code>List&lt;Protocol> protocols</code> : 支持的应用层协议，即 HTTP/1.1、 HTTP/2 等。</li><li><code>List&lt;ConnectionSpec> connectionSpecs</code> : 应用层支持的 Socket 设置，即使用明文传输（用于 HTTP）还是某个版本的 TLS（用于 HTTPS）。</li><li><code>List&lt;Interceptor> interceptors</code> : 大多数时候使用的 Interceptor 都应该配置到这里。</li><li><code>List&lt;Interceptor> networkInterceptors</code> : 直接和网络请求交互的 Interceptor 配置到这里，例如如果要查看返回的 301 报文或者未解压的 Response Body，需要在这里看。</li><li>CookieJar cookieJar : 管理 Cookie 的控制器。OkHttp 提供了 Cookie 存取的判断支持（即什么时候需要存 Cookie，什么时候需要读取 Cookie，但没有给出具体的存取实现。如果需要存取 Cookie，需要自己写实现，例如用 Map 存在内存里，或者用别的方式存在本地存储或者数据库。</li><li>Cache cache : Cache 存储的配置。默认是没有，如果需要用，得自己配置出 Cache 存储的文件位置以及存储空间上限。</li><li>HostnameVerifier hostnameVerifier : 用于验证 HTTPS 握手过程中下载到的证书所属者是否和自己要访问的主机名一致。</li><li>CertificatePinner certificatePinner : 用于设置 HTTPS 握手 过程中针对某个 Host 额外的的 Certificate Public Key Pinner，即把网站证书链中的每一个证书公钥直接拿来提前配置进 OkHttpClient 里去，作为正常的证书验证机制之外的一次额外验证。</li><li>Authenticator authenticator : 用于自动重新认证。配置之后，在请求收到 401 状态码的响应时，会直接调用 authenticator ，手动加入 Authorization header 之后自动重新发起请求。</li><li>boolean followRedirects : 遇到重定向的要求是，是否自动 follow。</li><li>boolean followSslRedirects : 在重定向时，如果原先请求的是 http 而重定向的目标是 https，或者原先请求的是 https 而重定向的目标是 http，是否依然自动 follow。注意：不是「是否自动 follow HTTPS URL 重定向的意思，而是是否自动 follow 在 HTTP 和 HTTPS 之间切换的重定向。</li><li>boolean retryOnConnectionFailure : 在请求失败的时候是否自动重试。注意：大多数的请求失败并不属于 OkHttp 所定义的「需要重试」， 这种重试只适用于「同一个域名的多个 IP 切换重试」「Socket 失效重试」 等情况。</li><li>int connectTimeout : 建立连接（TCP 或 TLS）的超时时间。</li><li>int readTimeout : 发起请求到读到响应数据的超时时间。</li><li>int writeTimeout : 发起请求并被目标服务器接受的超时时间。（因为有时候对方服务器可能由于某种原因而不读取你的 Request）</li></ul><a href=#strongrequest-和-responsestrong><h1 id=strongrequest-和-responsestrong><span class=hanchor arialabel=Anchor># </span><strong>Request 和 Response</strong></h1></a><p>Request 是发送请求封装类，内部有 url, header , method，body 等常见的参数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>Request</span> <span class=k>internal</span> <span class=k>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;url&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>url</span><span class=p>:</span> <span class=n>HttpUrl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;method&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>method</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;headers&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>headers</span><span class=p>:</span> <span class=n>Headers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;body&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>body</span><span class=p>:</span> <span class=n>RequestBody</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>  <span class=k>internal</span> <span class=k>val</span> <span class=py>tags</span><span class=p>:</span> <span class=n>Map</span><span class=p>&lt;</span><span class=n>Class</span><span class=p>&lt;*&gt;,</span> <span class=n>Any</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Response 是请求的结果，包含 code、message、header、body:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>Response</span> <span class=k>internal</span> <span class=k>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * The wire-level request that initiated this HTTP response. This is not necessarily the same
</span></span></span><span class=line><span class=cl><span class=cm>   * request issued by the application:
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * * It may be transformed by the HTTP client. For example, the client may copy headers like
</span></span></span><span class=line><span class=cl><span class=cm>   *   `Content-Length` from the request body.
</span></span></span><span class=line><span class=cl><span class=cm>   * * It may be the request generated in response to an HTTP redirect or authentication
</span></span></span><span class=line><span class=cl><span class=cm>   *   challenge. In this case the request URL may be different than the initial request URL.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;request&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Returns the HTTP protocol, such as [Protocol.HTTP_1_1] or [Protocol.HTTP_1_0]. */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;protocol&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>protocol</span><span class=p>:</span> <span class=n>Protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Returns the HTTP status message. */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>message</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Returns the HTTP status code. */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>code</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns the TLS handshake of the connection that carried this response, or null if the
</span></span></span><span class=line><span class=cl><span class=cm>   * response was received without TLS.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;handshake&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>handshake</span><span class=p>:</span> <span class=n>Handshake</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Returns the HTTP headers. */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;headers&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>headers</span><span class=p>:</span> <span class=n>Headers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns a non-null value if this response was passed to [Callback.onResponse] or returned
</span></span></span><span class=line><span class=cl><span class=cm>   * from [Call.execute]. Response bodies must be [closed][ResponseBody] and may
</span></span></span><span class=line><span class=cl><span class=cm>   * be consumed only once.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * This always returns null on responses returned from [cacheResponse], [networkResponse],
</span></span></span><span class=line><span class=cl><span class=cm>   * and [priorResponse].
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;body&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>body</span><span class=p>:</span> <span class=n>ResponseBody</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns the raw response received from the network. Will be null if this response didn&#39;t use
</span></span></span><span class=line><span class=cl><span class=cm>   * the network, such as when the response is fully cached. The body of the returned response
</span></span></span><span class=line><span class=cl><span class=cm>   * should not be read.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;networkResponse&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>networkResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns the raw response received from the cache. Will be null if this response didn&#39;t use
</span></span></span><span class=line><span class=cl><span class=cm>   * the cache. For conditional get requests the cache response and network response may both be
</span></span></span><span class=line><span class=cl><span class=cm>   * non-null. The body of the returned response should not be read.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;cacheResponse&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>cacheResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns the response for the HTTP redirect or authorization challenge that triggered this
</span></span></span><span class=line><span class=cl><span class=cm>   * response, or null if this response wasn&#39;t triggered by an automatic retry. The body of the
</span></span></span><span class=line><span class=cl><span class=cm>   * returned response should not be read because it has already been consumed by the redirecting
</span></span></span><span class=line><span class=cl><span class=cm>   * client.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;priorResponse&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>priorResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns a [timestamp][System.currentTimeMillis] taken immediately before OkHttp
</span></span></span><span class=line><span class=cl><span class=cm>   * transmitted the initiating request over the network. If this response is being served from the
</span></span></span><span class=line><span class=cl><span class=cm>   * cache then this is the timestamp of the original request.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;sentRequestAtMillis&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>sentRequestAtMillis</span><span class=p>:</span> <span class=n>Long</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns a [timestamp][System.currentTimeMillis] taken immediately after OkHttp
</span></span></span><span class=line><span class=cl><span class=cm>   * received this response&#39;s headers from the network. If this response is being served from the
</span></span></span><span class=line><span class=cl><span class=cm>   * cache then this is the timestamp of the original response.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;receivedResponseAtMillis&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>receivedResponseAtMillis</span><span class=p>:</span> <span class=n>Long</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@get</span><span class=p>:</span><span class=n>JvmName</span><span class=p>(</span><span class=s2>&#34;exchange&#34;</span><span class=p>)</span> <span class=k>internal</span> <span class=k>val</span> <span class=py>exchange</span><span class=p>:</span> <span class=n>Exchange</span><span class=p>?</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>Closeable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这两个类的定义是完全符合 Http 协议所定义的请求内容和响应内容。</p><a href=#realcall><h1 id=realcall><span class=hanchor arialabel=Anchor># </span>RealCall</h1></a><p>OkHttpClient 的 newCall(Request) 方法会返回一个 RealCall 对象，它是 Call 接口的实现。</p><p>当调用 RealCall.execute() 的时候， RealCall.getResponseWithInterceptorChain() 会被调用，它会发起网络请求并拿到返回的响应，装进一个 Response 对象并作为返回值返回；</p><p>RealCall.enqueue() 被调用的时候大同小异，区别在于 enqueue() 会使用 Dispatcher 的线程池来把请求放在后台线程进行，但实质上使用的也是 getResponseWithInterceptorChain() 方法。</p><p>getResponseWithInterceptorChain() 方法做的事：把所有配置好的 Interceptor 放在一个 List 里，然后作为参数，创建一个 RealInterceptorChain 对象，并调 chain.proceed(request) 来发起请求和获取响应。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>internal</span> <span class=k>fun</span> <span class=nf>getResponseWithInterceptorChain</span><span class=p>():</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Build a full stack of interceptors.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>val</span> <span class=py>interceptors</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>&lt;</span><span class=n>Interceptor</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>client</span><span class=p>.</span><span class=n>interceptors</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>RetryAndFollowUpInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>BridgeInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=n>cookieJar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>CacheInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=n>cache</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>ConnectInterceptor</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(!</span><span class=n>forWebSocket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>client</span><span class=p>.</span><span class=n>networkInterceptors</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>interceptors</span> <span class=o>+=</span> <span class=n>CallServerInterceptor</span><span class=p>(</span><span class=n>forWebSocket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>chain</span> <span class=p>=</span> <span class=n>RealInterceptorChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span> <span class=p>=</span> <span class=k>this</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>interceptors</span> <span class=p>=</span> <span class=n>interceptors</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>index</span> <span class=p>=</span> <span class=m>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span> <span class=p>=</span> <span class=k>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>request</span> <span class=p>=</span> <span class=n>originalRequest</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>connectTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>connectTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>readTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>readTimeoutMillis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>writeTimeoutMillis</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>writeTimeoutMillis</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 RealInterceptorChain 中，多个 Interceptor 会依次调用自己的 intercept() 方法。这个方法会做三件事:</p><ol><li>对请求进行预处理</li><li>预处理之后，重新调用 RealIntercepterChain.proceed() 把请求交给下一个 Interceptor</li><li>在下一个 Interceptor 处理完成并返回之后，拿到 Response 进行后续处理</li></ol><p>结合源码和该示意图，可以得到拦截器具有如下特点：</p><ul><li>拦截器按照添加顺序依次执行</li><li>拦截器的执行从 RealInterceptorChain.proceed() 开始，进入到第一个拦截器的执行逻辑</li><li>每个拦截器在执行之前，会将剩余尚未执行的拦截器组成新的 RealInterceptorChain</li><li>拦截器的逻辑被新的责任链调用 next.proceed() 切分为 start、next.proceed、end 这三个部分依次执行</li><li>next.proceed() 所代表的其实就是剩余所有拦截器的执行逻辑</li><li>所有拦截器最终形成一个层层内嵌的嵌套结构</li></ul><a href=#interceptor><h1 id=interceptor><span class=hanchor arialabel=Anchor># </span>Interceptor</h1></a><p>上面提到过，OkHttp 的所有拦截器会组成链式结构：各个拦截器完成前置工作后调用下一个拦截器的 proceed 方法，再执行后置工作。通过递归调用，每个拦截器完成各自的任务。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035349.png width=auto alt></p><a href=#clientinterceptors><h2 id=clientinterceptors><span class=hanchor arialabel=Anchor># </span>client.interceptors</h2></a><p>首先是开发者使用 addInterceptor(Interceptor) 所设置的，它们会按照开发者的要求，在所有其他 Interceptor 处理之前，进行最早的预处理工作，以及在收到 Response 之后，做最后的善后工作。如果你有统一的 header 要添加，可以在这里设置。</p><a href=#retryandfollowupinterceptor><h2 id=retryandfollowupinterceptor><span class=hanchor arialabel=Anchor># </span>RetryAndFollowUpInterceptor</h2></a><p>它会对连接做一些初始化工作，并且负责在请求失败时的重试，以及重定向的自动后续请求。它的存在，可以让<strong>重试和重定向</strong>对于开发者是无感知的。</p><p>RetryAndFollowUpInterceptor.intercept 代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>realChain</span> <span class=p>=</span> <span class=n>chain</span> <span class=k>as</span> <span class=n>RealInterceptorChain</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>request</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>call</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>call</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>followUpCount</span> <span class=p>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>priorResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>newExchangeFinder</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>recoveredFailures</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>&lt;</span><span class=n>IOException</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span><span class=p>.</span><span class=n>enterNetworkInterceptorExchange</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>newExchangeFinder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>response</span><span class=p>:</span> <span class=n>Response</span>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>closeActiveExchange</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//先判断请求是否已被取消
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>call</span><span class=p>.</span><span class=n>isCanceled</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>IOException</span><span class=p>(</span><span class=s2>&#34;Canceled&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//执行下一个链的 proceed
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>response</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>newExchangeFinder</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>RouteException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//判断是否能恢复，如果能则继续，否则结束
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// The attempt to connect via a route failed. The request will not have been sent.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(!</span><span class=n>recover</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=n>lastConnectException</span><span class=p>,</span> <span class=n>call</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>requestSendStarted</span> <span class=p>=</span> <span class=k>false</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>throw</span> <span class=n>e</span><span class=p>.</span><span class=n>firstConnectException</span><span class=p>.</span><span class=n>withSuppressed</span><span class=p>(</span><span class=n>recoveredFailures</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>recoveredFailures</span> <span class=o>+=</span> <span class=n>e</span><span class=p>.</span><span class=n>firstConnectException</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>newExchangeFinder</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// An attempt to communicate with a server failed. The request may have been sent.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(!</span><span class=n>recover</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>call</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>requestSendStarted</span> <span class=p>=</span> <span class=n>e</span> <span class=o>!is</span> <span class=n>ConnectionShutdownException</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>throw</span> <span class=n>e</span><span class=p>.</span><span class=n>withSuppressed</span><span class=p>(</span><span class=n>recoveredFailures</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>recoveredFailures</span> <span class=o>+=</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>newExchangeFinder</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Attach the prior response if it exists. Such responses never have a body.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>priorResponse</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=p>=</span> <span class=n>response</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>priorResponse</span><span class=p>(</span><span class=n>priorResponse</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>exchange</span> <span class=p>=</span> <span class=n>call</span><span class=p>.</span><span class=n>interceptorScopedExchange</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>followUp</span> <span class=p>=</span> <span class=n>followUpRequest</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=n>exchange</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>followUp</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>exchange</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>exchange</span><span class=p>.</span><span class=n>isDuplex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>call</span><span class=p>.</span><span class=n>timeoutEarlyExit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>closeActiveExchange</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>followUpBody</span> <span class=p>=</span> <span class=n>followUp</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>followUpBody</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>followUpBody</span><span class=p>.</span><span class=n>isOneShot</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>closeActiveExchange</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>        <span class=c1>//返回
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>response</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>++</span><span class=n>followUpCount</span> <span class=p>&gt;</span> <span class=n>MAX_FOLLOW_UPS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ProtocolException</span><span class=p>(</span><span class=s2>&#34;Too many follow-up requests: </span><span class=si>$followUpCount</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>request</span> <span class=p>=</span> <span class=n>followUp</span>
</span></span><span class=line><span class=cl>      <span class=n>priorResponse</span> <span class=p>=</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span><span class=p>.</span><span class=n>exitNetworkInterceptorExchange</span><span class=p>(</span><span class=n>closeActiveExchange</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>recover</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=p>:</span> <span class=n>IOException</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>call</span><span class=p>:</span> <span class=n>RealCall</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>userRequest</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>requestSendStarted</span><span class=p>:</span> <span class=n>Boolean</span>
</span></span><span class=line><span class=cl><span class=p>):</span> <span class=n>Boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// The application layer has forbidden retries.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(!</span><span class=n>client</span><span class=p>.</span><span class=n>retryOnConnectionFailure</span><span class=p>)</span> <span class=k>return</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// We can&#39;t send the request body again.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>requestSendStarted</span> <span class=o>&amp;&amp;</span> <span class=n>requestIsOneShot</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>userRequest</span><span class=p>))</span> <span class=k>return</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// This exception is fatal.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!is</span><span class=n>Recoverable</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>requestSendStarted</span><span class=p>))</span> <span class=k>return</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// No more routes to attempt.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(!</span><span class=n>call</span><span class=p>.</span><span class=n>retryAfterFailure</span><span class=p>())</span> <span class=k>return</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// For failure recovery, use the same route selector with a new connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=k>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>followUpRequest</span><span class=p>(</span><span class=n>userResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>,</span> <span class=n>exchange</span><span class=p>:</span> <span class=n>Exchange</span><span class=p>?):</span> <span class=n>Request</span><span class=p>?</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>route</span> <span class=p>=</span> <span class=n>exchange</span><span class=o>?.</span><span class=n>connection</span><span class=o>?.</span><span class=n>route</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>responseCode</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>code</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>method</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span><span class=p>.</span><span class=n>method</span>
</span></span><span class=line><span class=cl>  <span class=k>when</span> <span class=p>(</span><span class=n>responseCode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_PROXY_AUTH</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>selectedProxy</span> <span class=p>=</span> <span class=n>route</span><span class=o>!!</span><span class=p>.</span><span class=n>proxy</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>selectedProxy</span><span class=p>.</span><span class=n>type</span><span class=p>()</span> <span class=o>!=</span> <span class=n>Proxy</span><span class=p>.</span><span class=n>Type</span><span class=p>.</span><span class=n>HTTP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ProtocolException</span><span class=p>(</span><span class=s2>&#34;Received HTTP_PROXY_AUTH (407) code while not using proxy&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>client</span><span class=p>.</span><span class=n>proxyAuthenticator</span><span class=p>.</span><span class=n>authenticate</span><span class=p>(</span><span class=n>route</span><span class=p>,</span> <span class=n>userResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_UNAUTHORIZED</span> <span class=o>-&gt;</span> <span class=k>return</span> <span class=n>client</span><span class=p>.</span><span class=n>authenticator</span><span class=p>.</span><span class=n>authenticate</span><span class=p>(</span><span class=n>route</span><span class=p>,</span> <span class=n>userResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_PERM_REDIRECT</span><span class=p>,</span> <span class=n>HTTP_TEMP_REDIRECT</span><span class=p>,</span> <span class=n>HTTP_MULT_CHOICE</span><span class=p>,</span> <span class=n>HTTP_MOVED_PERM</span><span class=p>,</span> <span class=n>HTTP_MOVED_TEMP</span><span class=p>,</span> <span class=n>HTTP_SEE_OTHER</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>buildRedirectRequest</span><span class=p>(</span><span class=n>userResponse</span><span class=p>,</span> <span class=n>method</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_CLIENT_TIMEOUT</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 408&#39;s are rare in practice, but some servers like HAProxy use this response code. The
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// spec says that we may repeat the request without modifications. Modern browsers also
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// repeat the request (even non-idempotent ones.)
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(!</span><span class=n>client</span><span class=p>.</span><span class=n>retryOnConnectionFailure</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// The application layer has directed us not to retry the request.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>requestBody</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>requestBody</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>requestBody</span><span class=p>.</span><span class=n>isOneShot</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>priorResponse</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>priorResponse</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>priorResponse</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>priorResponse</span><span class=p>.</span><span class=n>code</span> <span class=o>==</span> <span class=n>HTTP_CLIENT_TIMEOUT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// We attempted to retry and got another timeout. Give up.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>retryAfter</span><span class=p>(</span><span class=n>userResponse</span><span class=p>,</span> <span class=m>0</span><span class=p>)</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_UNAVAILABLE</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>priorResponse</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>priorResponse</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>priorResponse</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>priorResponse</span><span class=p>.</span><span class=n>code</span> <span class=o>==</span> <span class=n>HTTP_UNAVAILABLE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// We attempted to retry and got another timeout. Give up.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>retryAfter</span><span class=p>(</span><span class=n>userResponse</span><span class=p>,</span> <span class=n>Integer</span><span class=p>.</span><span class=n>MAX_VALUE</span><span class=p>)</span> <span class=o>==</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// specifically received an instruction to retry without delay
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HTTP_MISDIRECTED_REQUEST</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// OkHttp can coalesce HTTP/2 connections even if the domain names are different. See
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// RealConnection.isEligible(). If we attempted this and the server returned HTTP 421, then
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// we can retry on a different connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>val</span> <span class=py>requestBody</span> <span class=p>=</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>requestBody</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>requestBody</span><span class=p>.</span><span class=n>isOneShot</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>exchange</span> <span class=o>==</span> <span class=k>null</span> <span class=o>||</span> <span class=p>!</span><span class=n>exchange</span><span class=p>.</span><span class=n>isCoalescedConnection</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>connection</span><span class=p>.</span><span class=n>noCoalescedConnections</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>userResponse</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=o>-&gt;</span> <span class=k>return</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个过程的大致流程如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035354.png width=auto alt></p><p>从上图中可以看出，RetryAndFollowUpInterceptor 开启了一个 while(true) 的循环，并在循环内部完成两个重要的判定，如图中的蓝色方框：</p><ol><li>当请求内部抛出异常时，判定是否需要重试</li><li>当响应结果是 3xx 重定向时，构建新的请求并发送请求</li></ol><p>重试的逻辑相对复杂，有如下的判定逻辑（具体代码在 RetryAndFollowUpInterceptor 类的 recover 方法）：</p><ul><li>规则 1: client 的 retryOnConnectionFailure 参数设置为 false，不进行重试</li><li>规则 2: 请求的 body 已经发出，不进行重试</li><li>规则 3: 特殊的异常类型不进行重试（如 ProtocolException，SSLHandshakeException 等）</li><li>规则 4: 没有更多的 route（包含 proxy 和 inetaddress），不进行重试</li></ul><a href=#bridgeinterceptor><h2 id=bridgeinterceptor><span class=hanchor arialabel=Anchor># </span>BridgeInterceptor</h2></a><p>负责一些不影响开发者开发，但影响 HTTP 交互的一些额外预处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>userRequest</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>request</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>requestBuilder</span> <span class=p>=</span> <span class=n>userRequest</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>body</span> <span class=p>=</span> <span class=n>userRequest</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>body</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>contentType</span> <span class=p>=</span> <span class=n>body</span><span class=p>.</span><span class=n>contentType</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>contentType</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=n>contentType</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>contentLength</span> <span class=p>=</span> <span class=n>body</span><span class=p>.</span><span class=n>contentLength</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>contentLength</span> <span class=o>!=</span> <span class=p>-</span><span class=m>1L</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Content-Length&#34;</span><span class=p>,</span> <span class=n>contentLength</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>removeHeader</span><span class=p>(</span><span class=s2>&#34;Transfer-Encoding&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Transfer-Encoding&#34;</span><span class=p>,</span> <span class=s2>&#34;chunked&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>requestBuilder</span><span class=p>.</span><span class=n>removeHeader</span><span class=p>(</span><span class=s2>&#34;Content-Length&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Host&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Host&#34;</span><span class=p>,</span> <span class=n>userRequest</span><span class=p>.</span><span class=n>url</span><span class=p>.</span><span class=n>toHostHeader</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Connection&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Connection&#34;</span><span class=p>,</span> <span class=s2>&#34;Keep-Alive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If we add an &#34;Accept-Encoding: gzip&#34; header field we&#39;re responsible for also decompressing
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// the transfer stream.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>var</span> <span class=py>transparentGzip</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Accept-Encoding&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Range&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>transparentGzip</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Accept-Encoding&#34;</span><span class=p>,</span> <span class=s2>&#34;gzip&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>cookies</span> <span class=p>=</span> <span class=n>cookieJar</span><span class=p>.</span><span class=n>loadForRequest</span><span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cookies</span><span class=p>.</span><span class=n>isNotEmpty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Cookie&#34;</span><span class=p>,</span> <span class=n>cookieHeader</span><span class=p>(</span><span class=n>cookies</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;User-Agent&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestBuilder</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;User-Agent&#34;</span><span class=p>,</span> <span class=n>userAgent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>networkResponse</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>requestBuilder</span><span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>//收到响应后，存储 Cookie：
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>cookieJar</span><span class=p>.</span><span class=n>receiveHeaders</span><span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=n>url</span><span class=p>,</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>responseBuilder</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>request</span><span class=p>(</span><span class=n>userRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>transparentGzip</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;gzip&#34;</span><span class=p>.</span><span class=n>equals</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Content-Encoding&#34;</span><span class=p>),</span> <span class=n>ignoreCase</span> <span class=p>=</span> <span class=k>true</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=n>networkResponse</span><span class=p>.</span><span class=n>promisesBody</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>responseBody</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>responseBody</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>gzipSource</span> <span class=p>=</span> <span class=n>GzipSource</span><span class=p>(</span><span class=n>responseBody</span><span class=p>.</span><span class=n>source</span><span class=p>())</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>strippedHeaders</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>headers</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>removeAll</span><span class=p>(</span><span class=s2>&#34;Content-Encoding&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>removeAll</span><span class=p>(</span><span class=s2>&#34;Content-Length&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>responseBuilder</span><span class=p>.</span><span class=n>headers</span><span class=p>(</span><span class=n>strippedHeaders</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>contentType</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>responseBuilder</span><span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=n>RealResponseBody</span><span class=p>(</span><span class=n>contentType</span><span class=p>,</span> <span class=p>-</span><span class=m>1L</span><span class=p>,</span> <span class=n>gzipSource</span><span class=p>.</span><span class=n>buffer</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>responseBuilder</span><span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>BridgeInterceptor 拦截器的功能如下：</p><ol><li>负责把用户构造的请求转换为发送到服务器的请求 、把服务器返回的响应转换为用户友好的响应，是从应用程序代码到网络代码的桥梁</li><li>设置内容长度，内容编码</li><li>设置 gzip 压缩，并在接收到内容后进行解压。省去了应用层处理数据解压的麻烦</li><li>添加 cookie</li><li>设置其他报头，如 Content-Length、User-Agent、Host、Keep-alive 等。其中 Keep-Alive 是实现连接复用的必要步骤</li></ol><a href=#cacheinterceptor><h2 id=cacheinterceptor><span class=hanchor arialabel=Anchor># </span>CacheInterceptor</h2></a><p>负责 Cache 的处理。把它放在后面的网络交互相关 Interceptor 的前面的好处是，如果本地有了可用的 Cache，一个请求可以在没有发生实质网络交互的情况下就返回缓存结果，而完全不需要开发者做出任何的额外工作，让 Cache 更加无感知。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>call</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>call</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>cacheCandidate</span> <span class=p>=</span> <span class=n>cache</span><span class=o>?.</span><span class=k>get</span><span class=p>(</span><span class=n>chain</span><span class=p>.</span><span class=n>request</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>now</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>strategy</span> <span class=p>=</span> <span class=n>CacheStrategy</span><span class=p>.</span><span class=n>Factory</span><span class=p>(</span><span class=n>now</span><span class=p>,</span> <span class=n>chain</span><span class=p>.</span><span class=n>request</span><span class=p>(),</span> <span class=n>cacheCandidate</span><span class=p>).</span><span class=n>compute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>networkRequest</span> <span class=p>=</span> <span class=n>strategy</span><span class=p>.</span><span class=n>networkRequest</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>cacheResponse</span> <span class=p>=</span> <span class=n>strategy</span><span class=p>.</span><span class=n>cacheResponse</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>cache</span><span class=o>?.</span><span class=n>trackResponse</span><span class=p>(</span><span class=n>strategy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>listener</span> <span class=p>=</span> <span class=p>(</span><span class=n>call</span> <span class=k>as</span><span class=p>?</span> <span class=n>RealCall</span><span class=p>)</span><span class=o>?.</span><span class=n>eventListener</span> <span class=o>?:</span> <span class=n>EventListener</span><span class=p>.</span><span class=n>NONE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cacheCandidate</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>cacheResponse</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// The cache candidate wasn&#39;t applicable. Close it.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cacheCandidate</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If we&#39;re forbidden from using the network and the cache is insufficient, fail.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>networkRequest</span> <span class=o>==</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>cacheResponse</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Response</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>request</span><span class=p>(</span><span class=n>chain</span><span class=p>.</span><span class=n>request</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>protocol</span><span class=p>(</span><span class=n>Protocol</span><span class=p>.</span><span class=n>HTTP_1_1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>code</span><span class=p>(</span><span class=n>HTTP_GATEWAY_TIMEOUT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>message</span><span class=p>(</span><span class=s2>&#34;Unsatisfiable Request (only-if-cached)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=n>EMPTY_RESPONSE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>(-</span><span class=m>1L</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>().</span><span class=n>also</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>listener</span><span class=p>.</span><span class=n>satisfactionFailure</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If we don&#39;t need the network, we&#39;re done.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>networkRequest</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cacheResponse</span><span class=o>!!</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>cacheResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>().</span><span class=n>also</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>listener</span><span class=p>.</span><span class=n>cacheHit</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cacheResponse</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span><span class=p>.</span><span class=n>cacheConditionalHit</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=n>cacheResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>cache</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span><span class=p>.</span><span class=n>cacheMiss</span><span class=p>(</span><span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 没有命中缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>var</span> <span class=py>networkResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>networkResponse</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>networkRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If we&#39;re crashing on I/O or otherwise, don&#39;t leak the cache body.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>networkResponse</span> <span class=o>==</span> <span class=k>null</span> <span class=o>&amp;&amp;</span> <span class=n>cacheCandidate</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cacheCandidate</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果缓存策略中，网络响应和响应缓存都不为null，需要更新响应缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// (比如 需要向服务器确认缓存是否可用的情况)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// If we have a cache response too, then we&#39;re doing a conditional get.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>cacheResponse</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 304 的返回是不带 body 的,此时必须获取 cache 的 body
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>networkResponse</span><span class=o>?.</span><span class=n>code</span> <span class=o>==</span> <span class=n>HTTP_NOT_MODIFIED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>cacheResponse</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>headers</span><span class=p>(</span><span class=n>combine</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>.</span><span class=n>headers</span><span class=p>,</span> <span class=n>networkResponse</span><span class=p>.</span><span class=n>headers</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>cacheResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>networkResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>networkResponse</span><span class=p>.</span><span class=n>body</span><span class=o>!!</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Update the cache after combining headers but before stripping the
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Content-Encoding header (as performed by initContentStream()).
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>cache</span><span class=o>!!</span><span class=p>.</span><span class=n>trackConditionalCacheHit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>cache</span><span class=p>.</span><span class=n>update</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>,</span> <span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>response</span><span class=p>.</span><span class=n>also</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>listener</span><span class=p>.</span><span class=n>cacheHit</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cacheResponse</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>closeQuietly</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 构建响应对象，等待返回
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>networkResponse</span><span class=o>!!</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>cacheResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>networkResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cache</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将请求放到缓存中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=n>promisesBody</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>CacheStrategy</span><span class=p>.</span><span class=n>isCacheable</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=n>networkRequest</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Offer this request to the cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>val</span> <span class=py>cacheRequest</span> <span class=p>=</span> <span class=n>cache</span><span class=p>.</span><span class=n>put</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>cacheWritingResponse</span><span class=p>(</span><span class=n>cacheRequest</span><span class=p>,</span> <span class=n>response</span><span class=p>).</span><span class=n>also</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>cacheResponse</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// This will log a conditional cache miss only.
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>listener</span><span class=p>.</span><span class=n>cacheMiss</span><span class=p>(</span><span class=n>call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果请求不能被缓存，则移除该请求
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>HttpMethod</span><span class=p>.</span><span class=n>invalidatesCache</span><span class=p>(</span><span class=n>networkRequest</span><span class=p>.</span><span class=n>method</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cache</span><span class=p>.</span><span class=n>remove</span><span class=p>(</span><span class=n>networkRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>_</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// The cache cannot be written.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个过程的流程如下：</p><ol><li>通过 Request 尝试到 Cache 中拿缓存，当然前提是 OkHttpClient 中配置了缓存，默认是不支持的。</li><li>根据 response、time、request 创建一个缓存策略，用于判断怎样使用缓存。</li><li>如果缓存策略中设置禁止使用网络，并且缓存又为空，则构建一个 Response 直接返回（返回码为 504）</li><li>缓存策略中设置不使用网络，但是又缓存，直接返回缓存</li><li>接着走后续过滤器的流程，chain.proceed(networkRequest)</li><li>当缓存存在的时候，如果网络返回的 Response 为 304，则使用缓存的 Response。</li><li>构建网络请求的 Response</li><li>当在 OkHttpClient 中配置了缓存，则将这个 Response 缓存起来。</li><li>缓存起来的步骤也是先缓存 header，再缓存 body。</li><li>返回 Response</li></ol><a href=#connectinterceptor><h2 id=connectinterceptor><span class=hanchor arialabel=Anchor># </span>ConnectInterceptor</h2></a><p>负责建立连接，它的源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>object</span> <span class=nc>ConnectInterceptor</span> <span class=p>:</span> <span class=n>Interceptor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>realChain</span> <span class=p>=</span> <span class=n>chain</span> <span class=k>as</span> <span class=n>RealInterceptorChain</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>exchange</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>call</span><span class=p>.</span><span class=n>initExchange</span><span class=p>(</span><span class=n>chain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>connectedChain</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>copy</span><span class=p>(</span><span class=n>exchange</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//开始下一个拦截器的工作
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>connectedChain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>realChain</span><span class=p>.</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个类本身很简单，从源码来看，关键的代码只有注释 1 处的那一句。它的作用是：从 RealCall 中获得了一个新的 ExChange 的对象。跟踪它的执行，可以发现它有如下调用逻辑：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035402.png width=auto alt></p><p>在这个步骤中，ConnectInterceptor 最终会通过 Socket 创建出网络请求所需要的 TCP 连接（如果是 HTTP），或者是建立在 TCP 连接之上的 TLS 连接（如果是 HTTPS）。并且会创建出对应的 HttpCodec 对象 （用于编码解码 HTTP 请求），并且最终封装成 Exchange 对象并返回。</p><a href=#clientnetworkinterceptors><h2 id=clientnetworkinterceptors><span class=hanchor arialabel=Anchor># </span>client.networkInterceptors</h2></a><p>client.networkInterceptors 是由开发者使用 addNetworkInterceptor(Interceptor) 所设置的，它们的行为逻辑和使用 addInterceptor(Interceptor) 创建的一样，但由于位置不同，所以这里创建的 Interceptor 会看到每个请求和响应的数据（包括重定向以及重试的一些中间请求和响应），并且看到的是完整原始数据，而不是没有加 Content-Length 的请求数据，或者 Body 还没有被 gzip 解压的响应数据。多数情况，这个方法不需要被使用，不过如果需要做网络调试，可以用它来实现。</p><a href=#callserverinterceptor><h2 id=callserverinterceptor><span class=hanchor arialabel=Anchor># </span>CallServerInterceptor</h2></a><p>CalllServerInterceptor 是最后一个拦截器了，它负责实质的请求与响应的 I/O 操作，即：往 Socket 里写入请求数据和从 Socket 里读取响应数据，进行 http 请求报文的封装与请求报文的解析。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Throws</span><span class=p>(</span><span class=n>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>realChain</span> <span class=p>=</span> <span class=n>chain</span> <span class=k>as</span> <span class=n>RealInterceptorChain</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>exchange</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>exchange</span><span class=o>!!</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>request</span> <span class=p>=</span> <span class=n>realChain</span><span class=p>.</span><span class=n>request</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>requestBody</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>body</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>sentRequestMillis</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>exchange</span><span class=p>.</span><span class=n>writeRequestHeaders</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>invokeStartEvent</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>responseBuilder</span><span class=p>:</span> <span class=n>Response</span><span class=p>.</span><span class=n>Builder</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>HttpMethod</span><span class=p>.</span><span class=n>permitsRequestBody</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>method</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>requestBody</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If there&#39;s a &#34;Expect: 100-continue&#34; header on the request, wait for a &#34;HTTP/1.1 100
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Continue&#34; response before transmitting the request body. If we don&#39;t get that, return
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// what we did get (such as a 4xx response) without ever transmitting the request body.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=s2>&#34;100-continue&#34;</span><span class=p>.</span><span class=n>equals</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Expect&#34;</span><span class=p>),</span> <span class=n>ignoreCase</span> <span class=p>=</span> <span class=k>true</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>flushRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>responseBuilder</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>readResponseHeaders</span><span class=p>(</span><span class=n>expectContinue</span> <span class=p>=</span> <span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>responseHeadersStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>invokeStartEvent</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>responseBuilder</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>requestBody</span><span class=p>.</span><span class=n>isDuplex</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Prepare a duplex body so that the application can send a request body later.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>exchange</span><span class=p>.</span><span class=n>flushRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>bufferedRequestBody</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>createRequestBody</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=k>true</span><span class=p>).</span><span class=n>buffer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>requestBody</span><span class=p>.</span><span class=n>writeTo</span><span class=p>(</span><span class=n>bufferedRequestBody</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Write the request body if the &#34;Expect: 100-continue&#34; expectation was met.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>bufferedRequestBody</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>createRequestBody</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=k>false</span><span class=p>).</span><span class=n>buffer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>requestBody</span><span class=p>.</span><span class=n>writeTo</span><span class=p>(</span><span class=n>bufferedRequestBody</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>bufferedRequestBody</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>noRequestBody</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(!</span><span class=n>exchange</span><span class=p>.</span><span class=n>connection</span><span class=p>.</span><span class=n>isMultiplexed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If the &#34;Expect: 100-continue&#34; expectation wasn&#39;t met, prevent the HTTP/1 connection
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// from being reused. Otherwise we&#39;re still obligated to transmit the request body to
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// leave the connection in a consistent state.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>exchange</span><span class=p>.</span><span class=n>noNewExchangesOnConnection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>exchange</span><span class=p>.</span><span class=n>noRequestBody</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>requestBody</span> <span class=o>==</span> <span class=k>null</span> <span class=o>||</span> <span class=p>!</span><span class=n>requestBody</span><span class=p>.</span><span class=n>isDuplex</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>exchange</span><span class=p>.</span><span class=n>finishRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>responseBuilder</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>responseBuilder</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>readResponseHeaders</span><span class=p>(</span><span class=n>expectContinue</span> <span class=p>=</span> <span class=k>false</span><span class=p>)</span><span class=o>!!</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>invokeStartEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>responseHeadersStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=n>invokeStartEvent</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>response</span> <span class=p>=</span> <span class=n>responseBuilder</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>request</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>handshake</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=n>connection</span><span class=p>.</span><span class=n>handshake</span><span class=p>())</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>(</span><span class=n>sentRequestMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>())</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>var</span> <span class=py>code</span> <span class=p>=</span> <span class=n>response</span><span class=p>.</span><span class=n>code</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>code</span> <span class=o>==</span> <span class=m>100</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Server sent a 100-continue even though we did not request one. Try again to read the actual
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// response status.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>responseBuilder</span> <span class=p>=</span> <span class=n>exchange</span><span class=p>.</span><span class=n>readResponseHeaders</span><span class=p>(</span><span class=n>expectContinue</span> <span class=p>=</span> <span class=k>false</span><span class=p>)</span><span class=o>!!</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>invokeStartEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exchange</span><span class=p>.</span><span class=n>responseHeadersStart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=p>=</span> <span class=n>responseBuilder</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>request</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>handshake</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=n>connection</span><span class=p>.</span><span class=n>handshake</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>sentRequestAtMillis</span><span class=p>(</span><span class=n>sentRequestMillis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>receivedResponseAtMillis</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>currentTimeMillis</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=p>=</span> <span class=n>response</span><span class=p>.</span><span class=n>code</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>exchange</span><span class=p>.</span><span class=n>responseHeadersEnd</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>response</span> <span class=p>=</span> <span class=k>if</span> <span class=p>(</span><span class=n>forWebSocket</span> <span class=o>&amp;&amp;</span> <span class=n>code</span> <span class=o>==</span> <span class=m>101</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Connection is upgrading, but we need to ensure interceptors see a non-null response body.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>response</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=n>EMPTY_RESPONSE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=n>openResponseBody</span><span class=p>(</span><span class=n>response</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=s2>&#34;close&#34;</span><span class=p>.</span><span class=n>equals</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=n>request</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Connection&#34;</span><span class=p>),</span> <span class=n>ignoreCase</span> <span class=p>=</span> <span class=k>true</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;close&#34;</span><span class=p>.</span><span class=n>equals</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=s2>&#34;Connection&#34;</span><span class=p>),</span> <span class=n>ignoreCase</span> <span class=p>=</span> <span class=k>true</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>exchange</span><span class=p>.</span><span class=n>noNewExchangesOnConnection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>code</span> <span class=o>==</span> <span class=m>204</span> <span class=o>||</span> <span class=n>code</span> <span class=o>==</span> <span class=m>205</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>response</span><span class=p>.</span><span class=n>body</span><span class=o>?.</span><span class=n>contentLength</span><span class=p>()</span> <span class=o>?:</span> <span class=p>-</span><span class=m>1L</span> <span class=p>&gt;</span> <span class=m>0L</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>ProtocolException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;HTTP </span><span class=si>$code</span><span class=s2> had non-zero Content-Length: </span><span class=si>${response.body?.contentLength()}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>CallServerInterceptor 由以下步骤组成：</p><ol><li>向服务器发送 request header</li><li>如果有 request body，就向服务器发送</li><li>读取 response header，先构造一个 Response 对象</li><li>如果有 response body，就在 3 的基础上加上 body 构造一个新的 Response 对象</li></ol><p>可以看到，核心工作都由 <strong>HttpCodec</strong> 对象完成，而 HttpCodec 实际上利用的是 Okio，而 Okio 实际上还是用的 Socket，只不过是经过了层层嵌套。</p><a href=#总结><h1 id=总结><span class=hanchor arialabel=Anchor># </span>总结</h1></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/OkHttp/clipboard_20230323_035408.png width=auto alt></p></article><hr><div class=page-end id=footer><div class=fixed-right><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></div></div></body></html>