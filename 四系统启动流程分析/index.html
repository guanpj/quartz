<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="作为一名 Android 程序员，你有没有想过：那么复杂的 Android 系统，它是怎样运行起来的，我们的 App 又是怎样被 Android 系统加载后呈现在屏幕上的呢？Android 系统的启动是一个比较复杂的过程，涉及到了一些我们没有接触过的知识，本文将基于 Android Nougat 最新的代码上讲述 Android 系统的启动流程。
Bootloader —— 第一个程序 当按下电源键（加电）或者系统重启（复位）的时候，引导芯片会从 ROM（这里一般指 Flash ROM，即闪存）中预定义的位置将 Bootloader 载入到 RAM 中，接着，Bootloader 将会把 Linux 内核载入到 RAM 中并启动。"><meta property="og:title" content="四、系统启动流程分析"><meta property="og:description" content="作为一名 Android 程序员，你有没有想过：那么复杂的 Android 系统，它是怎样运行起来的，我们的 App 又是怎样被 Android 系统加载后呈现在屏幕上的呢？Android 系统的启动是一个比较复杂的过程，涉及到了一些我们没有接触过的知识，本文将基于 Android Nougat 最新的代码上讲述 Android 系统的启动流程。
Bootloader —— 第一个程序 当按下电源键（加电）或者系统重启（复位）的时候，引导芯片会从 ROM（这里一般指 Flash ROM，即闪存）中预定义的位置将 Bootloader 载入到 RAM 中，接着，Bootloader 将会把 Linux 内核载入到 RAM 中并启动。"><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="四、系统启动流程分析"><meta name=twitter:description content="作为一名 Android 程序员，你有没有想过：那么复杂的 Android 系统，它是怎样运行起来的，我们的 App 又是怎样被 Android 系统加载后呈现在屏幕上的呢？Android 系统的启动是一个比较复杂的过程，涉及到了一些我们没有接触过的知识，本文将基于 Android Nougat 最新的代码上讲述 Android 系统的启动流程。
Bootloader —— 第一个程序 当按下电源键（加电）或者系统重启（复位）的时候，引导芯片会从 ROM（这里一般指 Flash ROM，即闪存）中预定义的位置将 Bootloader 载入到 RAM 中，接着，Bootloader 将会把 Linux 内核载入到 RAM 中并启动。"><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>四、系统启动流程分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.0452046239b15cdfa822e3a8fa41b16d.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.cf6439e057b2800c40a018b5e420d51c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.1f87191420a247c6d88fe779812e5de3.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>四、系统启动流程分析</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/zygote/>Zygote</a></li><li><a href=https://www.guanpj.top/tags/Bootloader/>Bootloader</a></li><li><a href=https://www.guanpj.top/tags/Framework/>Framework</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#bootloader--第一个程序>Bootloader —— 第一个程序</a></li><li><a href=#init-进程--1-号进程>init 进程 —— 1 号进程</a></li><li><a href=#servicemanager-进程--binder-服务的总管>servicemanager 进程 —— Binder 服务的总管</a></li><li><a href=#zygote-进程--java-进程的始祖>zygote 进程 —— Java 进程的始祖</a><ol><li><a href=#1启动-java-虚拟机>1.启动 Java 虚拟机</a></li><li><a href=#2加载-zygoteinit>2.加载 ZygoteInit</a><ol><li><a href=#1注册一个-socket>1.注册一个 Socket</a></li><li><a href=#2预加载各类资源>2.预加载各类资源</a></li><li><a href=#3启动-system_server-进程>3.启动 system_server 进程</a></li><li><a href=#4开启循环循环等待-fork-进程请求>4.开启循环循环等待 fork 进程请求</a></li><li><a href=#5子进程执行入口函数>5.子进程执行入口函数</a></li><li><a href=#6番外socket-客户端发送创建进程请求>6.番外：Socket 客户端发送创建进程请求</a></li></ol></li><li><a href=#小结>小结</a></li></ol></li><li><a href=#system_server-进程--承载-framework-层核心业务>system_server 进程 —— 承载 framework 层核心业务</a><ol><li><a href=#1启动-native-层系统服务>1.启动 Native 层系统服务</a></li><li><a href=#2启动-java-层系统服务>2.启动 Java 层系统服务</a></li><li><a href=#小结-1>小结</a></li></ol></li><li><a href=#launcher--android-系统的桌面>Launcher —— Android 系统的“桌面”</a></li><li><a href=#总结>总结</a></li></ol></nav></details></aside><p>作为一名 Android 程序员，你有没有想过：那么复杂的 Android 系统，它是怎样运行起来的，我们的 App 又是怎样被 Android 系统加载后呈现在屏幕上的呢？Android 系统的启动是一个比较复杂的过程，涉及到了一些我们没有接触过的知识，本文将基于 Android Nougat 最新的代码上讲述 Android 系统的启动流程。</p><a href=#bootloader--第一个程序><h1 id=bootloader--第一个程序><span class=hanchor arialabel=Anchor># </span>Bootloader —— 第一个程序</h1></a><p>当按下电源键（加电）或者系统重启（复位）的时候，引导芯片会从
<a href=https://zh.wikipedia.org/wiki/%E5%94%AF%E8%AE%80%E8%A8%98%E6%86%B6%E9%AB%94 rel=noopener>ROM</a>（这里一般指 Flash ROM，即闪存）中预定义的位置将 Bootloader 载入到 RAM 中，接着，Bootloader 将会把 Linux 内核载入到 RAM 中并启动。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045201.png width=auto alt></p><p>Bootloader 是在系统内核运行之前运行的一段小程序，也是系统运行的第一个程序，它的主要作用是：</p><ol><li>初始化
<a href=https://zh.wikipedia.org/wiki/%E9%9A%8F%E6%9C%BA%E5%AD%98%E5%8F%96%E5%AD%98%E5%82%A8%E5%99%A8 rel=noopener>RAM</a>（一般指内存）</li><li>初始化硬件设备</li><li>加载内核和内存空间影像图</li><li>跳转到内核</li></ol><a href=#init-进程--1-号进程><h1 id=init-进程--1-号进程><span class=hanchor arialabel=Anchor># </span>init 进程 —— 1 号进程</h1></a><p>Linux 内核启动过程中会创建 init 进程，init 进程是用户空间的第一个进程（pid=1），对应的可执行程序的源文件文件为 [/system/core/init/Init.cpp](
<a href=https://android.googlesource.com/platform/system/core/ rel=noopener>https://android.googlesource.com/platform/system/core/</a> /nougat-release/init/init.cpp)，它的 main 方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>**</span> <span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>basename</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=s>&#34;ueventd&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ueventd_main</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>basename</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=s>&#34;watchdogd&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>watchdogd_main</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>umask</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>add_environment</span><span class=p>(</span><span class=s>&#34;PATH&#34;</span><span class=p>,</span> <span class=n>_PATH_DEFPATH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>is_first_stage</span> <span class=o>=</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s>&#34;--second-stage&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建文件并挂载
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>is_first_stage</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mount</span><span class=p>(</span><span class=s>&#34;tmpfs&#34;</span><span class=p>,</span> <span class=s>&#34;/dev&#34;</span><span class=p>,</span> <span class=s>&#34;tmpfs&#34;</span><span class=p>,</span> <span class=n>MS_NOSUID</span><span class=p>,</span> <span class=s>&#34;mode=0755&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mkdir</span><span class=p>(</span><span class=s>&#34;/dev/pts&#34;</span><span class=p>,</span> <span class=mo>0755</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mkdir</span><span class=p>(</span><span class=s>&#34;/dev/socket&#34;</span><span class=p>,</span> <span class=mo>0755</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mount</span><span class=p>(</span><span class=s>&#34;devpts&#34;</span><span class=p>,</span> <span class=s>&#34;/dev/pts&#34;</span><span class=p>,</span> <span class=s>&#34;devpts&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cp>#define MAKE_STR(x) __STRING(x)
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=n>mount</span><span class=p>(</span><span class=s>&#34;proc&#34;</span><span class=p>,</span> <span class=s>&#34;/proc&#34;</span><span class=p>,</span> <span class=s>&#34;proc&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;hidepid=2,gid=&#34;</span> <span class=n>MAKE_STR</span><span class=p>(</span><span class=n>AID_READPROC</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>mount</span><span class=p>(</span><span class=s>&#34;sysfs&#34;</span><span class=p>,</span> <span class=s>&#34;/sys&#34;</span><span class=p>,</span> <span class=s>&#34;sysfs&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>open_devnull_stdio</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>klog_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>klog_set_level</span><span class=p>(</span><span class=n>KLOG_NOTICE_LEVEL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>NOTICE</span><span class=p>(</span><span class=s>&#34;init %s started!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>is_first_stage</span> <span class=o>?</span> <span class=s>&#34;first stage&#34;</span> <span class=o>:</span> <span class=s>&#34;second stage&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>is_first_stage</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Indicate that booting is in progress to background fw loaders, etc.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>close</span><span class=p>(</span><span class=n>open</span><span class=p>(</span><span class=s>&#34;/dev/.booting&#34;</span><span class=p>,</span> <span class=n>O_WRONLY</span> <span class=o>|</span> <span class=n>O_CREAT</span> <span class=o>|</span> <span class=n>O_CLOEXEC</span><span class=p>,</span> <span class=mo>0000</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 初始化属性相关资源
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>property_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>process_kernel_dt</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>process_kernel_cmdline</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>export_kernel_boot_props</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 启动属性服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>start_property_service</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>BuiltinFunctionMap</span> <span class=n>function_map</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Action</span><span class=o>::</span><span class=n>set_function_map</span><span class=p>(</span><span class=o>&amp;</span><span class=n>function_map</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Parser</span><span class=o>&amp;</span> <span class=n>parser</span> <span class=o>=</span> <span class=n>Parser</span><span class=o>::</span><span class=n>GetInstance</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=p>.</span><span class=n>AddSectionParser</span><span class=p>(</span><span class=s>&#34;service&#34;</span><span class=p>,</span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>ServiceParser</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=p>.</span><span class=n>AddSectionParser</span><span class=p>(</span><span class=s>&#34;on&#34;</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>ActionParser</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=p>.</span><span class=n>AddSectionParser</span><span class=p>(</span><span class=s>&#34;import&#34;</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>ImportParser</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 解析init.rc配置文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>parser</span><span class=p>.</span><span class=n>ParseConfig</span><span class=p>(</span><span class=s>&#34;/init.rc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>   
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>waiting_for_exec</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>am</span><span class=p>.</span><span class=n>ExecuteOneCommand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>restart_processes</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>timeout</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>process_needs_restart</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>timeout</span> <span class=o>=</span> <span class=p>(</span><span class=n>process_needs_restart</span> <span class=o>-</span> <span class=n>gettime</span><span class=p>())</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>timeout</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>timeout</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>am</span><span class=p>.</span><span class=n>HasMoreCommands</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>timeout</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>bootchart_sample</span><span class=p>(</span><span class=o>&amp;</span><span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>epoll_event</span> <span class=n>ev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>nr</span> <span class=o>=</span> <span class=n>TEMP_FAILURE_RETRY</span><span class=p>(</span><span class=n>epoll_wait</span><span class=p>(</span><span class=n>epoll_fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ev</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>timeout</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>nr</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ERROR</span><span class=p>(</span><span class=s>&#34;epoll_wait failed: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>nr</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)())</span> <span class=n>ev</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>)();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>init 进程的职责主要有四个：</p><ol><li>解析和运行所有 init.rc 文件</li><li>生成设备驱动节点</li><li>处理子进程的终结</li><li>提供属性服务</li></ol><p>这里重点看第一点，[init.rc](
<a href=https://android.googlesource.com/platform/system/core/ rel=noopener>https://android.googlesource.com/platform/system/core/</a> /nougat-release/rootdir/init.rc) 是一个配置文件，它由 Android 初始化语言编写，zygote 进程和 servicemanager 进程都是由 init 进程解析 init.rc 中特定的语句启动的，比如，启动 zygote 进程的代码格式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server
</span></span><span class=line><span class=cl>    class main
</span></span><span class=line><span class=cl>    socket zygote stream 660 root system
</span></span><span class=line><span class=cl>    onrestart write /sys/android_power/request_state wake
</span></span><span class=line><span class=cl>    onrestart write /sys/power/state on
</span></span><span class=line><span class=cl>    onrestart restart audioserver
</span></span><span class=line><span class=cl>    onrestart restart cameraserver
</span></span><span class=line><span class=cl>    onrestart restart media
</span></span><span class=line><span class=cl>    onrestart restart netd
</span></span><span class=line><span class=cl>    writepid /dev/cpuset/foreground/tasks /dev/stune/foreground/tasks
</span></span></code></pre></td></tr></table></div></div><p>事实上，在 [system/core/rootdir](
<a href=https://android.googlesource.com/platform/system/core/ rel=noopener>https://android.googlesource.com/platform/system/core/</a> /nougat-release/rootdir) 目录下，有多个 init.rc 文件，在不同的硬件环境下，相应的 init.rc 文件会被导入，比如在 64 位操作系统中，上面启动 zygote 进程的代码是从 [init.zygote64.rc](
<a href=https://android.googlesource.com/platform/system/core/ rel=noopener>https://android.googlesource.com/platform/system/core/</a> /nougat-release/rootdir/init.zygote64.rc) 文件中导入的。它的含义主要为：</p><ol><li>service zygote 表示启动一个名为 zygote 的服务</li><li>/system/bin/app_process64 表示服务对应执行文件的路径</li><li>-Xzygote /system/bin &ndash;zygote &ndash;start-system-server 表示启动服务的参数</li></ol><a href=#servicemanager-进程--binder-服务的总管><h1 id=servicemanager-进程--binder-服务的总管><span class=hanchor arialabel=Anchor># </span>servicemanager 进程 —— Binder 服务的总管</h1></a><p>我在文章
<a href=https://ywue4d2ujm.feishu.cn/docs/doccnnNIKMdICh9atjwTbBRYxpf# rel=noopener>Binder 机制分析</a>中讲到“Binder 通信模型和通信过程”的时候提到过 ServerManager，它是 Binder IPC 的核心，是上下文的管理者，Binder 服务端必须先向 ServerManager 注册才能够为客户端提供服务，Binder 客户端在与服务端通信之前需要从 ServerManager 中查找并获取 Binder 服务端的引用。然而 ServerManager 在向 Binder 驱动申请成为上下文管理者的时候又涉及到了 Binder IPC 过程，这时候应该怎么处理呢？</p><p>servicemanager 进程是由 init 进程通过解析 init.rc 文件来启动的，对应的代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>service servicemanager /system/bin/servicemanager
</span></span><span class=line><span class=cl>    class core
</span></span><span class=line><span class=cl>    user system
</span></span><span class=line><span class=cl>    group system
</span></span><span class=line><span class=cl>    critical
</span></span><span class=line><span class=cl>    onrestart restart healthd
</span></span><span class=line><span class=cl>    onrestart restart zygote
</span></span><span class=line><span class=cl>    onrestart restart media
</span></span><span class=line><span class=cl>    onrestart restart surfaceflinger
</span></span><span class=line><span class=cl>    onrestart restart drm
</span></span></code></pre></td></tr></table></div></div><p>servicemanager 进程对应可执行程序的源文件为 [framework/native/cmds/servicemanager/service_manager.c](
<a href=https://android.googlesource.com/platform/frameworks/native/ rel=noopener>https://android.googlesource.com/platform/frameworks/native/</a> /nougat-release/cmds/servicemanager/service_manager.c)，简化后的代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=n>bs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 打开binder驱动，申请 128k 字节大小的内存空间
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>bs</span> <span class=o>=</span> <span class=n>binder_open</span><span class=p>(</span><span class=mi>128</span><span class=o>*</span><span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 成为上下文管理者
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>binder_become_context_manager</span><span class=p>(</span><span class=n>bs</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 验证 selinux 权限，判断进程是否有权注册或查看指定服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>selinux_enabled</span> <span class=o>=</span> <span class=n>is_selinux_enabled</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>sehandle</span> <span class=o>=</span> <span class=n>selinux_android_service_context_handle</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>selinux_status_open</span><span class=p>(</span><span class=nb>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>selinux_enabled</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>sehandle</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>abort</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>getcon</span><span class=p>(</span><span class=o>&amp;</span><span class=n>service_manager_context</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>abort</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 进入无限循环，处理 client 端发来的请求 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>binder_loop</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span> <span class=n>svcmgr_handler</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里重点关注两点，首先，在申请了一块大小为 128k 的内存空间并验证 selinux 权限后，接着调用 [framework/native/cmds/servicemanager/binder.c](
<a href=https://android.googlesource.com/platform/frameworks/native/ rel=noopener>https://android.googlesource.com/platform/frameworks/native/</a> /nougat-release/cmds/servicemanager/binder.c) 中的 binder_become_context_manager 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>binder_become_context_manager</span><span class=p>(</span><span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=n>bs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过ioctl，发送 BINDER_SET_CONTEXT_MGR 指令
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>ioctl</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>,</span> <span class=n>BINDER_SET_CONTEXT_MGR</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后，调用 binder_loop 方法进入循环来处理 client 发来的请求，注意第二个参数是一个方法体，用于处理各种状态回调：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>svcmgr_handler</span><span class=p>(</span><span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=n>bs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=k>struct</span> <span class=n>binder_transaction_data</span> <span class=o>*</span><span class=n>txn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=k>struct</span> <span class=n>binder_io</span> <span class=o>*</span><span class=n>msg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=k>struct</span> <span class=n>binder_io</span> <span class=o>*</span><span class=n>reply</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>svcinfo</span> <span class=o>*</span><span class=n>si</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=o>*</span><span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>size_t</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>strict_policy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>allow_isolated</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>strict_policy</span> <span class=o>=</span> <span class=n>bio_get_uint32</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>bio_get_string16</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span><span class=p>(</span><span class=n>txn</span><span class=o>-&gt;</span><span class=n>code</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>SVC_MGR_GET_SERVICE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>SVC_MGR_CHECK_SERVICE</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// 获取服务名
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>s</span> <span class=o>=</span> <span class=n>bio_get_string16</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// 根据名称查找相应服务
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>handle</span> <span class=o>=</span> <span class=n>do_find_service</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=n>txn</span><span class=o>-&gt;</span><span class=n>sender_euid</span><span class=p>,</span> <span class=n>txn</span><span class=o>-&gt;</span><span class=n>sender_pid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bio_put_ref</span><span class=p>(</span><span class=n>reply</span><span class=p>,</span> <span class=n>handle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>SVC_MGR_ADD_SERVICE</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// 获取服务名
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>s</span> <span class=o>=</span> <span class=n>bio_get_string16</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>handle</span> <span class=o>=</span> <span class=n>bio_get_ref</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>allow_isolated</span> <span class=o>=</span> <span class=n>bio_get_uint32</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span> <span class=o>?</span> <span class=mi>1</span> <span class=o>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>         <span class=c1>// 注册指定服务
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>do_add_service</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=n>handle</span><span class=p>,</span> <span class=n>txn</span><span class=o>-&gt;</span><span class=n>sender_euid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>allow_isolated</span><span class=p>,</span> <span class=n>txn</span><span class=o>-&gt;</span><span class=n>sender_pid</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>servicemanager 进程在启动过程的工作内容如下：</p><ol><li>调用 binder_open 方法打开 Binder 驱动，并申请分配一块 128k 的内存空间</li><li>调用 binder_become_context_manager 方法发送 BINDER_SET_CONTEXT_MGR 给 Binder 驱动，使自己成为上下文管理者</li><li>验证 selinux 权限，判断进程是否有注册或查看指定服务的权限</li><li>调用 binder_loop 方法进入循环状态，等待 Client 请求</li><li>根据服务名称注册服务·</li><li>接收 Binder 死亡通知</li></ol><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045211.png width=auto alt></p><a href=#zygote-进程--java-进程的始祖><h1 id=zygote-进程--java-进程的始祖><span class=hanchor arialabel=Anchor># </span>zygote 进程 —— Java 进程的始祖</h1></a><a href=#1启动-java-虚拟机><h2 id=1启动-java-虚拟机><span class=hanchor arialabel=Anchor># </span>1.启动 Java 虚拟机</h2></a><p>通过解析 init.rc 文件，zygote 进程对应的可执行程序的源文件为 [frameworks/base/cmds/app_process/app_main.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/cmds/app_process/app_main.cpp)，它的 main 方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=k>const</span> <span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=n>AppRuntime</span> <span class=n>runtime</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>computeArgBlockSize</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Parse runtime arguments.  Stop at first unrecognized option.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>bool</span> <span class=n>zygote</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>startSystemServer</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>application</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>String8</span> <span class=n>niceName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>String8</span> <span class=n>className</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>i</span><span class=p>;</span>  <span class=c1>// Skip unused &#34;parent dir&#34; argument.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>argc</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>arg</span> <span class=o>=</span> <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=s>&#34;--zygote&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 当前进程是否用于承载 zygote
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>zygote</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>niceName</span> <span class=o>=</span> <span class=n>ZYGOTE_NICE_NAME</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=s>&#34;--start-system-server&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>            <span class=c1>// 是否需要启动 system_server 进程
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>startSystemServer</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=s>&#34;--application&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 启动进入独立的程序模式
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>application</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=s>&#34;--nice-name=&#34;</span><span class=p>,</span> <span class=mi>12</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 此进程的别名
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>niceName</span><span class=p>.</span><span class=n>setTo</span><span class=p>(</span><span class=n>arg</span> <span class=o>+</span> <span class=mi>12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=s>&#34;--&#34;</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>className</span><span class=p>.</span><span class=n>setTo</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>--</span><span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>zygote</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 AppRuntime 父类 AndroidRuntime 的 start 方法创建 zygote 进程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>runtime</span><span class=p>.</span><span class=n>start</span><span class=p>(</span><span class=s>&#34;com.android.internal.os.ZygoteInit&#34;</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>zygote</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>className</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>runtime</span><span class=p>.</span><span class=n>start</span><span class=p>(</span><span class=s>&#34;com.android.internal.os.RuntimeInit&#34;</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>zygote</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;Error: no class name or --zygote supplied.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>app_usage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LOG_ALWAYS_FATAL</span><span class=p>(</span><span class=s>&#34;app_process: no class name or --zygote supplied.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在我们的场景中， init.rc 指定了 &ndash;zygote 选项，结合以上代码的注释可知，app_process64 接下来将启动 “ZygoteInit” 并传入 “start-system-server” 作为参数。</p><p>之后 ZygoteInit 将会运行于 Java 虚拟机上——因为 runtime 变量实际上就是一个 AndroidRuntime 对象， [frameworks/base/core/jni/AndroidRuntime.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/jni/AndroidRuntime.cpp) 的 start 方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=n>AndroidRuntime</span><span class=o>::</span><span class=n>start</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>className</span><span class=p>,</span> <span class=k>const</span> <span class=n>Vector</span><span class=o>&lt;</span><span class=n>String8</span><span class=o>&gt;&amp;</span> <span class=n>options</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>zygote</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* start the virtual machine */</span>
</span></span><span class=line><span class=cl>    <span class=n>JniInvocation</span> <span class=n>jni_invocation</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>jni_invocation</span><span class=p>.</span><span class=n>Init</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 启动 DVM
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>startVm</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mJavaVM</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>env</span><span class=p>,</span> <span class=n>zygote</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 虚拟机启动后的回调
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>onVmCreated</span><span class=p>(</span><span class=n>env</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 注册 JNI 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>startReg</span><span class=p>(</span><span class=n>env</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;Unable to register all android natives</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>jclass</span> <span class=n>stringClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>jobjectArray</span> <span class=n>strArray</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>jstring</span> <span class=n>classNameStr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>stringClass</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>FindClass</span><span class=p>(</span><span class=s>&#34;java/lang/String&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>assert</span><span class=p>(</span><span class=n>stringClass</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>strArray</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>NewObjectArray</span><span class=p>(</span><span class=n>options</span><span class=p>.</span><span class=n>size</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>stringClass</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>assert</span><span class=p>(</span><span class=n>strArray</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 从 app_main 的 main 函数得知 className 为 com.android.internal.os.ZygoteInit
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>classNameStr</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>NewStringUTF</span><span class=p>(</span><span class=n>className</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>assert</span><span class=p>(</span><span class=n>classNameStr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>env</span><span class=o>-&gt;</span><span class=n>SetObjectArrayElement</span><span class=p>(</span><span class=n>strArray</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>classNameStr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>options</span><span class=p>.</span><span class=n>size</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>jstring</span> <span class=n>optionsStr</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>NewStringUTF</span><span class=p>(</span><span class=n>options</span><span class=p>.</span><span class=n>itemAt</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=n>string</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>assert</span><span class=p>(</span><span class=n>optionsStr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>env</span><span class=o>-&gt;</span><span class=n>SetObjectArrayElement</span><span class=p>(</span><span class=n>strArray</span><span class=p>,</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>optionsStr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>slashClassName</span> <span class=o>=</span> <span class=n>toSlashClassName</span><span class=p>(</span><span class=n>className</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>jclass</span> <span class=n>startClass</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>FindClass</span><span class=p>(</span><span class=n>slashClassName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>startClass</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;JavaVM unable to locate class &#39;%s&#39;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>slashClassName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* keep going */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 找到 ZygoteInit 的 main 函数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>jmethodID</span> <span class=n>startMeth</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>GetStaticMethodID</span><span class=p>(</span><span class=n>startClass</span><span class=p>,</span> <span class=s>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;([Ljava/lang/String;)V&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>startMeth</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;JavaVM unable to find main() in &#39;%s&#39;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>className</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=cm>/* keep going */</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 通过 JNI 调用 ZygoteInit 的 main 函数
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>env</span><span class=o>-&gt;</span><span class=n>CallStaticVoidMethod</span><span class=p>(</span><span class=n>startClass</span><span class=p>,</span> <span class=n>startMeth</span><span class=p>,</span> <span class=n>strArray</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>ExceptionCheck</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=n>threadExitUncaughtException</span><span class=p>(</span><span class=n>env</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2加载-zygoteinit><h2 id=2加载-zygoteinit><span class=hanchor arialabel=Anchor># </span>2.加载 ZygoteInit</h2></a><p>通过 JNI 的方式进入 [frameworks/base/core/java/com/android/internal/os/ZygoteInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteInit.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span> <span class=n>argv</span><span class=o>[])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>       
</span></span><span class=line><span class=cl>        <span class=c1>// 注册Zygote用的Socket
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>registerZygoteSocket</span><span class=o>(</span><span class=n>socketName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 预加载类和资源
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>preload</span><span class=o>();</span><span class=c1>//2
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>startSystemServer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 启动SystemServer进程
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>startSystemServer</span><span class=o>(</span><span class=n>abiList</span><span class=o>,</span> <span class=n>socketName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>i</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Accepting command socket connections&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 等待客户端请求
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>runSelectLoop</span><span class=o>(</span><span class=n>abiList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>MethodAndArgsCaller</span> <span class=n>caller</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>caller</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Zygote died with exception&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#1注册一个-socket><h3 id=1注册一个-socket><span class=hanchor arialabel=Anchor># </span>1.注册一个 Socket</h3></a><p>registerZygoteSocket 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>registerZygoteSocket</span><span class=o>(</span><span class=n>String</span> <span class=n>socketName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>sServerSocket</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>fileDesc</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>String</span> <span class=n>fullSocketName</span> <span class=o>=</span> <span class=n>ANDROID_SOCKET_PREFIX</span> <span class=o>+</span> <span class=n>socketName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>env</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>getenv</span><span class=o>(</span><span class=n>fullSocketName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>fileDesc</span> <span class=o>=</span> <span class=n>Integer</span><span class=o>.</span><span class=na>parseInt</span><span class=o>(</span><span class=n>env</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>fullSocketName</span> <span class=o>+</span> <span class=s>&#34; unset or invalid&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>FileDescriptor</span> <span class=n>fd</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileDescriptor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>fd</span><span class=o>.</span><span class=na>setInt$</span><span class=o>(</span><span class=n>fileDesc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 创建 Socket 客户端
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>sServerSocket</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LocalServerSocket</span><span class=o>(</span><span class=n>fd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;Error binding to local socket &#39;&#34;</span> <span class=o>+</span> <span class=n>fileDesc</span> <span class=o>+</span> <span class=s>&#34;&#39;&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2预加载各类资源><h3 id=2预加载各类资源><span class=hanchor arialabel=Anchor># </span>2.预加载各类资源</h3></a><p>Preload 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kt>void</span> <span class=nf>preload</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;begin preload&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=o>,</span> <span class=s>&#34;BeginIcuCachePinning&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>beginIcuCachePinning</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=o>,</span> <span class=s>&#34;PreloadClasses&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>preloadClasses</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=o>,</span> <span class=s>&#34;PreloadResources&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>preloadResources</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=o>,</span> <span class=s>&#34;PreloadOpenGL&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>preloadOpenGL</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>preloadSharedLibraries</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>preloadTextResources</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Ask the WebViewFactory to do any initialization that must run in the zygote process,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// for memory sharing purposes.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WebViewFactory</span><span class=o>.</span><span class=na>prepareWebViewInZygote</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>endIcuCachePinning</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>warmUpJcaProviders</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;end preload&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#3启动-system_server-进程><h3 id=3启动-system_server-进程><span class=hanchor arialabel=Anchor># </span>3.启动 system_server 进程</h3></a><p>startSystemServer 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>startSystemServer</span><span class=o>(</span><span class=n>String</span> <span class=n>abiList</span><span class=o>,</span> <span class=n>String</span> <span class=n>socketName</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>MethodAndArgsCaller</span><span class=o>,</span> <span class=n>RuntimeException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Hardcoded command line to start the system server */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// SystemServer 启动参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>String</span> <span class=n>args</span><span class=o>[]</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;--setuid=1000&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;--setgid=1000&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007,3009,3010&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;--capabilities=&#34;</span> <span class=o>+</span> <span class=n>capabilities</span> <span class=o>+</span> <span class=s>&#34;,&#34;</span> <span class=o>+</span> <span class=n>capabilities</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;--nice-name=system_server&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;--runtime-args&#34;</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>        <span class=s>&#34;com.android.server.SystemServer&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=o>};</span>
</span></span><span class=line><span class=cl>    <span class=n>ZygoteConnection</span><span class=o>.</span><span class=na>Arguments</span> <span class=n>parsedArgs</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>pid</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>parsedArgs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ZygoteConnection</span><span class=o>.</span><span class=na>Arguments</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ZygoteConnection</span><span class=o>.</span><span class=na>applyDebuggerSystemProperty</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ZygoteConnection</span><span class=o>.</span><span class=na>applyInvokeWithSystemProperty</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 Zygote.java fock 出新线程，名字叫 system_server
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pid</span> <span class=o>=</span> <span class=n>Zygote</span><span class=o>.</span><span class=na>forkSystemServer</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>uid</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>gid</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>debugFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>permittedCapabilities</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>effectiveCapabilities</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IllegalArgumentException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// pid 为 0 则为 fock 出来的子线程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>pid</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>hasSecondZygote</span><span class=o>(</span><span class=n>abiList</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>waitForSecondaryZygote</span><span class=o>(</span><span class=n>socketName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 启动 SystemServer 进程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>handleSystemServerProcess</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，拼装启动参数——注意，最后一个选现 &ndash;runtime-args 的参数为 <strong>&ldquo;com.android.server.SystemServer&rdquo;</strong>，接着会调用 [frameworks/base/core/java/com/android/internal/os/Zygote.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/Zygote.java) 的 forkSystemServer 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>forkSystemServer</span><span class=o>(</span><span class=kt>int</span> <span class=n>uid</span><span class=o>,</span> <span class=kt>int</span> <span class=n>gid</span><span class=o>,</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>gids</span><span class=o>,</span> <span class=kt>int</span> <span class=n>debugFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span><span class=o>[][]</span> <span class=n>rlimits</span><span class=o>,</span> <span class=kt>long</span> <span class=n>permittedCapabilities</span><span class=o>,</span> <span class=kt>long</span> <span class=n>effectiveCapabilities</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>VM_HOOKS</span><span class=o>.</span><span class=na>preFork</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 Native 层的方法 fock 出子线程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>pid</span> <span class=o>=</span> <span class=n>nativeForkSystemServer</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>uid</span><span class=o>,</span> <span class=n>gid</span><span class=o>,</span> <span class=n>gids</span><span class=o>,</span> <span class=n>debugFlags</span><span class=o>,</span> <span class=n>rlimits</span><span class=o>,</span> <span class=n>permittedCapabilities</span><span class=o>,</span> <span class=n>effectiveCapabilities</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Enable tracing as soon as we enter the system_server.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>pid</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span><span class=c1>// fock 出来的子线程中执行
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Trace</span><span class=o>.</span><span class=na>setTracingEnabled</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>VM_HOOKS</span><span class=o>.</span><span class=na>postForkCommon</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pid</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过 nativeForkSystemServer 方法内部调用 nativeForkSystemServer 这个 Native 方法在当前进程中 fork 出一个子进程，随后这个进程会通过 handleSystemServerProcess() 方法来启动各种支撑系统运行的 system_server 进程。</p><a href=#4开启循环循环等待-fork-进程请求><h3 id=4开启循环循环等待-fork-进程请求><span class=hanchor arialabel=Anchor># </span>4.开启循环循环等待 fork 进程请求</h3></a><p>回头接着看 ZygoteInit.java 流程中的 runSelectLoop 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>runSelectLoop</span><span class=o>(</span><span class=n>String</span> <span class=n>abiList</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>FileDescriptor</span><span class=o>&gt;</span> <span class=n>fds</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>FileDescriptor</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ZygoteConnection</span><span class=o>&gt;</span> <span class=n>peers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ZygoteConnection</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// sServerSocket 对象就是刚才在 registerZygoteSocket 方法中创建的服务端 Socket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>fds</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>sServerSocket</span><span class=o>.</span><span class=na>getFileDescriptor</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>peers</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 循环读取状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>StructPollfd</span><span class=o>[]</span> <span class=n>pollFds</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StructPollfd</span><span class=o>[</span><span class=n>fds</span><span class=o>.</span><span class=na>size</span><span class=o>()];</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>pollFds</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>pollFds</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StructPollfd</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>pollFds</span><span class=o>[</span><span class=n>i</span><span class=o>].</span><span class=na>fd</span> <span class=o>=</span> <span class=n>fds</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pollFds</span><span class=o>[</span><span class=n>i</span><span class=o>].</span><span class=na>events</span> <span class=o>=</span> <span class=o>(</span><span class=kt>short</span><span class=o>)</span> <span class=n>POLLIN</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Os</span><span class=o>.</span><span class=na>poll</span><span class=o>(</span><span class=n>pollFds</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ErrnoException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;poll failed&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>pollFds</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>;</span> <span class=o>--</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 读取的状态不是客户端连接或者数据请求时，进入下一次循环
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>((</span><span class=n>pollFds</span><span class=o>[</span><span class=n>i</span><span class=o>].</span><span class=na>revents</span> <span class=o>&amp;</span> <span class=n>POLLIN</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span><span class=c1>// i = 0 表示跟客户端 Socket 连接上了
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>ZygoteConnection</span> <span class=n>newPeer</span> <span class=o>=</span> <span class=n>acceptCommandPeer</span><span class=o>(</span><span class=n>abiList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>peers</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>newPeer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>fds</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>newPeer</span><span class=o>.</span><span class=na>getFileDesciptor</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span><span class=c1>// i &gt; 0 表示接收到客户端 Socket 发送过来的请求
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// runOnce 方法创建一个新的应用程序进程
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kt>boolean</span> <span class=n>done</span> <span class=o>=</span> <span class=n>peers</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>runOnce</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>done</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>peers</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>fds</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>runSelectLoop 方法的主体是一个 while 死循环，这决定了它作为 zygote 的守护体存在。</p><p>[frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteConnection.java) 的 runOnce 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>runOnce</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>args</span><span class=o>[];</span>
</span></span><span class=line><span class=cl>    <span class=n>Arguments</span> <span class=n>parsedArgs</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FileDescriptor</span><span class=o>[]</span> <span class=n>descriptors</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 读取 socket 客户端发送过来的参数列表
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>args</span> <span class=o>=</span> <span class=n>readArgumentList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>descriptors</span> <span class=o>=</span> <span class=n>mSocket</span><span class=o>.</span><span class=na>getAncillaryFileDescriptors</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// EOF reached.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>closeSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将 socket 客户端传递过来的参数，解析成 Arguments 对象格式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>parsedArgs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Arguments</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 forkAndSpecialize 方法 fock 出子进程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pid</span> <span class=o>=</span> <span class=n>Zygote</span><span class=o>.</span><span class=na>forkAndSpecialize</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>uid</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>gid</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>debugFlags</span><span class=o>,</span> <span class=n>rlimits</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>mountExternal</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>seInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span><span class=o>,</span> <span class=n>fdsToClose</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>appDataDir</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>pid</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 子进程执行
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>serverPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverPipeFd</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 进入子进程流程
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>handleChildProc</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>,</span> <span class=n>descriptors</span><span class=o>,</span> <span class=n>childPipeFd</span><span class=o>,</span> <span class=n>newStderr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 父进程执行
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>childPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>childPipeFd</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>handleParentProc</span><span class=o>(</span><span class=n>pid</span><span class=o>,</span> <span class=n>descriptors</span><span class=o>,</span> <span class=n>serverPipeFd</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>childPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>serverPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当收到 fork 请求时，首先获取从 socket 客户端传入的参数并存入 parsedArgs 变量，接着在代码块 25 行调用的是
<a href=https://android.googlesource.com/platform/frameworks/base/+/nougat-release/core/java/com/android/internal/os/Zygote.java rel=noopener>Zygote.java</a> 的 forkAndSpecialize() 方法来 fork 出子进程，从这里开始一分为二，父进程和子进程继续往下执行。</p><a href=#5子进程执行入口函数><h3 id=5子进程执行入口函数><span class=hanchor arialabel=Anchor># </span>5.子进程执行入口函数</h3></a><p>pid==0 表示为子进程这个分支，接着会执行 handleChildProc() 方法并将 parsedArgs 传入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleChildProc</span><span class=o>(</span><span class=n>Arguments</span> <span class=n>parsedArgs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>FileDescriptor</span><span class=o>[]</span> <span class=n>descriptors</span><span class=o>,</span> <span class=n>FileDescriptor</span> <span class=n>pipeFd</span><span class=o>,</span> <span class=n>PrintStream</span> <span class=n>newStderr</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>     <span class=c1>// 关闭 socket
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>closeSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>     <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>     <span class=o>...</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Process</span><span class=o>.</span><span class=na>setArgV0</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// End of the postFork event.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>invokeWith</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>WrapperInit</span><span class=o>.</span><span class=na>execApplication</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>invokeWith</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>targetSdkVersion</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>VMRuntime</span><span class=o>.</span><span class=na>getCurrentInstructionSet</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>pipeFd</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>remainingArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>RuntimeInit</span><span class=o>.</span><span class=na>zygoteInit</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>targetSdkVersion</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>remainingArgs</span><span class=o>,</span> <span class=kc>null</span> <span class=cm>/* classLoader */</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>由于子进程 fork 自 zygote，因此也复制了 zygote 进程的地址空间，因此也会得到 zygote 进程创建的 socket，而这个 socket 对于子进程是无用的，因此需要关闭该 socket。</p><p>接着在最后会调用 RuntimeInit 的 zygoteInit 方法并传入 parsedArgs.remainingArgs。这里先不看 zygoteInit 的内容，但是可以剧透一下：后面的一系列流程概括起来就是找到并执行目标进程的入口函数，并执行它的 main 函数。</p><a href=#6番外socket-客户端发送创建进程请求><h3 id=6番外socket-客户端发送创建进程请求><span class=hanchor arialabel=Anchor># </span>6.番外：Socket 客户端发送创建进程请求</h3></a><p>应用程序启动时，必须要启动一个进程用于承载这个应用，而向 zygote 进程发送 fork 进程请求的则是 ActivityManagerService，简称 AMS：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>startProcessLocked</span><span class=o>(</span><span class=n>ProcessRecord</span> <span class=n>app</span><span class=o>,</span> <span class=n>String</span> <span class=n>hostingType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>hostingNameStr</span><span class=o>,</span> <span class=n>String</span> <span class=n>abiOverride</span><span class=o>,</span> <span class=n>String</span> <span class=n>entryPoint</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>entryPointArgs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Start the process.  It will either succeed and return a result containing
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// the PID of the new process, or else throw a RuntimeException.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>boolean</span> <span class=n>isActivityProcess</span> <span class=o>=</span> <span class=o>(</span><span class=n>entryPoint</span> <span class=o>==</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>entryPoint</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=n>entryPoint</span> <span class=o>=</span> <span class=s>&#34;android.app.ActivityThread&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>,</span> <span class=s>&#34;Start proc: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>processName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>checkTime</span><span class=o>(</span><span class=n>startTime</span><span class=o>,</span> <span class=s>&#34;startProcess: asking zygote to start proc&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Process</span><span class=o>.</span><span class=na>ProcessStartResult</span> <span class=n>startResult</span> <span class=o>=</span> <span class=n>Process</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=n>entryPoint</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>processName</span><span class=o>,</span> <span class=n>uid</span><span class=o>,</span> <span class=n>uid</span><span class=o>,</span> <span class=n>gids</span><span class=o>,</span> <span class=n>debugFlags</span><span class=o>,</span> <span class=n>mountExternal</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>targetSdkVersion</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>seinfo</span><span class=o>,</span> <span class=n>requiredAbi</span><span class=o>,</span> <span class=n>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>dataDir</span><span class=o>,</span> <span class=n>entryPointArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>checkTime</span><span class=o>(</span><span class=n>startTime</span><span class=o>,</span> <span class=s>&#34;startProcess: returned from zygote!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，Process.start 方法显示就是去启动一个新的进程以承载业务，而第一个参数 entryPoint 经过兜兜转转最终就是 invokeStaticMain() 方法的 className 参数，entryPoint 的默认值为 &ldquo;android.app.ActivityThread&rdquo;。</p><p>也就是说，zygote 进程在接到 AMS 请求的时候，会 fork 出一个子进程并且将 ActivityThread 作为入口，而 ActivityThread 就是我们熟知的 Android 应用程序的“主线程”：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>,</span> <span class=s>&#34;ActivityThreadMain&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Looper</span><span class=o>.</span><span class=na>prepareMainLooper</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ActivityThread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ActivityThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>thread</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>sMainThreadHandler</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sMainThreadHandler</span> <span class=o>=</span> <span class=n>thread</span><span class=o>.</span><span class=na>getHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=kc>false</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Looper</span><span class=o>.</span><span class=na>myLooper</span><span class=o>().</span><span class=na>setMessageLogging</span><span class=o>(</span><span class=k>new</span>
</span></span><span class=line><span class=cl>                <span class=n>LogPrinter</span><span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>,</span> <span class=s>&#34;ActivityThread&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// End of event ActivityThreadMain.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Looper</span><span class=o>.</span><span class=na>loop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Main thread loop unexpectedly exited&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#小结><h2 id=小结><span class=hanchor arialabel=Anchor># </span>小结</h2></a><p>从 App_main 开始，zygote 启动过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045226.png width=auto alt></p><p>可以看到，这个过程中 zygote 首先启动了 AndroidRuntime 并通过它反射调用了 ZygoteInit.main() 方法，由此进入了 Java 的世界，因此 zygote 是 Java 层的第一个进程，也是其他 Java 进程的始祖，其他 Java 进程的创建必须依赖 zygote。</p><p>zygote 进程的任务分别是：</p><ol><li>创建 AppRuntime（继承自 AndroidRuntime）， 并调用它的 <strong>start</strong> 方法</li><li>调用 AndroidRuntime 的 <strong>startVM()</strong> 方法创建 DVM（Dalvik Virtual Machine），并调用 <strong>startReg()</strong> 方法为 DVM 注册 JNI</li><li>通过 JNI 调用 <strong>ZygoteInit.main()</strong> 方法，第一次进入 Java 的世界</li><li>调用 <strong>registerZygoteSocket()</strong> 函数建立 Socket 通道，使 zygote 进程成为 Socket 服务端</li><li>调用 <strong>preload()</strong> 方法预加载各种资源</li><li>调用 <strong>startSystemServer()</strong> 函数 fock 出 system_server 进程</li><li>通过 <strong>runSelectLoop()</strong> 函数等待 ActivityManagerService 发送请求创建新的应用程序进程</li></ol><a href=#system_server-进程--承载-framework-层核心业务><h1 id=system_server-进程--承载-framework-层核心业务><span class=hanchor arialabel=Anchor># </span>system_server 进程 —— 承载 framework 层核心业务</h1></a><p>system_server 进程主要用户创建系统服务，framework 层的 AMS、WMS 和 PMS 等关键服务都是由它创建出来的。</p><p>在上一小节中我们已经知道，zygote 进程在启动的过程中会通过 startSystemServer 方法 fock 出了一个叫 system_server 的进程，然后在该方法内执行了 handleSystemServerProcess 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>handleSystemServerProcess</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>ZygoteConnection</span><span class=o>.</span><span class=na>Arguments</span> <span class=n>parsedArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** 这个 Socket 对 system_server 来说同样无用处，这里将其关闭 **/</span>
</span></span><span class=line><span class=cl>    <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>invokeWith</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ClassLoader</span> <span class=n>cl</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>systemServerClasspath</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cl</span> <span class=o>=</span> <span class=n>createSystemServerClassLoader</span><span class=o>(</span><span class=n>systemServerClasspath</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>targetSdkVersion</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>setContextClassLoader</span><span class=o>(</span><span class=n>cl</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 又是调用了它的 zygoteInit 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>RuntimeInit</span><span class=o>.</span><span class=na>zygoteInit</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>targetSdkVersion</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>remainingArgs</span><span class=o>,</span> <span class=n>cl</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里再次出现了
<a href=https://android.googlesource.com/platform/frameworks/base/+/nougat-release/core/java/com/android/internal/os/RuntimeInit.java rel=noopener>RuntimeInit</a>.zygoteInit() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>zygoteInit</span><span class=o>(</span><span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>,</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>DEBUG</span><span class=o>)</span> <span class=n>Slog</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;RuntimeInit: Starting application from zygote&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>,</span> <span class=s>&#34;RuntimeInit&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>redirectLogStreams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>commonInit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过 Native 层中 AndroidRuntime.cpp 的 JNI 方法最终调用 app_main.cpp 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 的 onZygoteInit 方法启动 Binder 线程池， 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 使 system_server 进程可以使用 Binder 与其他进程通信 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>nativeZygoteInit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 继续往下调用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>applicationInit</span><span class=o>(</span><span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>argv</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>顾名思义，这是一个初始化方法，它将通过三个方面来完成初始化。</p><p>首先是 commonInit，通用部分的初始化，包括设置默认的 uncaught exception handler、为 HttpURLConnection 准备好默认的 HTTP User-Agent 等；接着，nativeZygoteInit() 这个是一个 Native 层的初始化方法；最后是 applicatInit()，它是程序运行的起点。</p><p>经过这两个过程的初始化后，程序现在会出现两个分支：nativeZygoteInit 主导的 Native 层系统服务启动，以及 applicationInit 负责的 Java 层系统服务的启动。</p><a href=#1启动-native-层系统服务><h2 id=1启动-native-层系统服务><span class=hanchor arialabel=Anchor># </span>1.启动 Native 层系统服务</h2></a><p>nativeZygoteInit() 是一个 Native 方法，它对应的文件为 [frameworks/base/core/jni/AndroidRuntime.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/jni/AndroidRuntime.cpp)，与该方法对应的函数为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>com_android_internal_os_RuntimeInit_nativeZygoteInit</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>,</span> <span class=n>jobject</span> <span class=n>clazz</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>gCurRuntime</span><span class=o>-&gt;</span><span class=n>onZygoteInit</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>gCurRuntime 是一个 AndroidRuntime 对象全局变量，结合之前的分析可以猜测，AndroidRuntime 是一个父类，真正的实现则在 [frameworks/base/cmds/app_process/app_main.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/cmds/app_process/app_main.cpp) 中的 AppRuntime 。当新建 AppRuntime 实例时，它的父类构造函数就会被调用并为 gCurRuntime 赋值。上述的 onZygoteInit() 方法也在 app_main 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>virtual</span> <span class=kt>void</span> <span class=nf>onZygoteInit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sp</span><span class=o>&lt;</span><span class=n>ProcessState</span><span class=o>&gt;</span> <span class=n>proc</span> <span class=o>=</span> <span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;App process: starting thread pool.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>proc</span><span class=o>-&gt;</span><span class=n>startThreadPool</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这段代码是 Binder 机制中的重要组成部分，其中 startThreadPool() 方法将开启 Binder 线程池以保证其它线程可以正确访问到 Zygote 启动的服务。Zygote 通过 JNI 和回调的方式非常巧妙地把 Native 层和 Java 层、SystemServe 和 app_process 关联起来了。</p><a href=#2启动-java-层系统服务><h2 id=2启动-java-层系统服务><span class=hanchor arialabel=Anchor># </span>2.启动 Java 层系统服务</h2></a><p>接着看 RuntimeInit 的 applicationInit() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>applicationInit</span><span class=o>(</span><span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>,</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>invokeStaticMain</span><span class=o>(</span><span class=n>args</span><span class=o>.</span><span class=na>startClass</span><span class=o>,</span> <span class=n>args</span><span class=o>.</span><span class=na>startArgs</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>RuntimeInit 的 invokeStaticMain 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>invokeStaticMain</span><span class=o>(</span><span class=n>String</span> <span class=n>className</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>,</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span>
</span></span><span class=line><span class=cl>         <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>cl</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/** className 为 ZygoteInit.java 中 startSystemServer 方法
</span></span></span><span class=line><span class=cl><span class=cm>        传递过来的 &#34;com.android.server.SystemServer&#34;，这里通过反射得到 SystemServer 类 **/</span>
</span></span><span class=line><span class=cl>        <span class=n>cl</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>className</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ClassNotFoundException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Missing class when invoking static main &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Method</span> <span class=n>m</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 找到 SystemServer 类的 main 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>m</span> <span class=o>=</span> <span class=n>cl</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(</span><span class=s>&#34;main&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>Class</span><span class=o>[]</span> <span class=o>{</span> <span class=n>String</span><span class=o>[].</span><span class=na>class</span> <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchMethodException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Missing static main on &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SecurityException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Problem getting static main on &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>modifiers</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span> <span class=o>(</span><span class=n>Modifier</span><span class=o>.</span><span class=na>isStatic</span><span class=o>(</span><span class=n>modifiers</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>isPublic</span><span class=o>(</span><span class=n>modifiers</span><span class=o>)))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Main method is not public and static on &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** 将 main 方法包装在 ZygoteInit.MethodAndArgsCaller 类中并作为异常抛出
</span></span></span><span class=line><span class=cl><span class=cm>    捕获异常的地方在上一小节中 ZygoteInit.java 的 main 方法 **/</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span><span class=o>(</span><span class=n>m</span><span class=o>,</span> <span class=n>argv</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结合注释内容来看捕获这个异常的 [frameworks/base/core/java/com/android/internal/os/ZygoteInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteInit.java) 的 main 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span> <span class=n>argv</span><span class=o>[])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>MethodAndArgsCaller</span> <span class=n>caller</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 接收到 caller 对象后调用它的 run 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>caller</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Zygote died with exception&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ZygoteInit 的 MethodAndArgsCaller 类是一个 Exception 类，同时也实现了 Runnable 接口：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MethodAndArgsCaller</span> <span class=kd>extends</span> <span class=n>Exception</span>
</span></span><span class=line><span class=cl>        <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Method</span> <span class=n>mMethod</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>mArgs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>MethodAndArgsCaller</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mMethod</span> <span class=o>=</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mArgs</span> <span class=o>=</span> <span class=n>args</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用传递过来的 mMethod
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mMethod</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[]</span> <span class=o>{</span> <span class=n>mArgs</span> <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IllegalAccessException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InvocationTargetException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样，system_server 进程便启动起来并进入了 SystemServer.java 的 main 方法。</p><p>这里需要思考一下，为什么需要抛出异常到 ZygoteInit 中执行？官方解释就是抛出异常的时候 Android 虚拟机会清空该进程堆内存中的栈帧，因此前面一系列启动 system_server 进程的过程中方法调用过程就被清除了，节省了堆栈的空间，使 ZygoteInit.java 的 main 方法处于所有 Java 进程的方法栈中的栈顶。</p><p>同样地，zygote 进程接收到 AMS 请求并创建进程后，也会执行 ActivityThread 的 main 方法并将其作为 app 进程方法栈中的栈顶。</p><blockquote><p>从最新 Android Pie 的代码中看，[ZygoteInit](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /pie-release/core/java/com/android/internal/os/ZygoteInit.java) 中的这个过程从 forkSystemServer() 方法开始，以及 runSelectLoop() 方法，已经变成在每一步中将包装好的 MethodAndArgsCaller 对象作为返回值返回，最后再执行这个对象的 call 方法，这样每个方法都在返回过程被弹出栈帧了，同样达到了以上的效果。</p></blockquote><p>查看 [frameworks/base/services/java/com/android/server/SystemServer.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/java/com/android/server/SystemServer.java) 的源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * The main entry point from zygote.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 run 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>new</span> <span class=n>SystemServer</span><span class=o>().</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 加载 libandroid_servers.so
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>System</span><span class=o>.</span><span class=na>loadLibrary</span><span class=o>(</span><span class=s>&#34;android_servers&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建 SystemServiceManager
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mSystemServiceManager</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SystemServiceManager</span><span class=o>(</span><span class=n>mSystemContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>LocalServices</span><span class=o>.</span><span class=na>addService</span><span class=o>(</span><span class=n>SystemServiceManager</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>mSystemServiceManager</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>    
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_SYSTEM_SERVER</span><span class=o>,</span> <span class=s>&#34;StartServices&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 启动引导服务
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startBootstrapServices</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 启动核心服务
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startCoreServices</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 启动其他服务
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startOtherServices</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_SYSTEM_SERVER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，在 run 方法中，主要执行了启动引导服务、核心服务和其他服务的任务，这些服务加起来一共有 80 多个，它们对应这个各种不同的功能，部分服务如下：</p><table><thead><tr><th>引导服务</th><th>作用</th></tr></thead><tbody><tr><td>Installer</td><td>系统安装 apk 时的一个服务类，启动完成 Installer 服务之后才能启动其他的系统服务</td></tr><tr><td>ActivityManagerService</td><td>负责四大组件的启动、切换、调度。</td></tr><tr><td>PowerManagerService</td><td>计算系统中和 Power 相关的计算，然后决策系统应该如何反应</td></tr><tr><td>LightsService</td><td>管理和显示背光 LED</td></tr><tr><td>DisplayManagerService</td><td>用来管理所有显示设备</td></tr><tr><td>UserManagerService</td><td>多用户模式管理</td></tr><tr><td>SensorService</td><td>为系统提供各种感应器服务</td></tr><tr><td>PackageManagerService</td><td>用来对 apk 进行安装、解析、删除、卸载等等操作</td></tr></tbody></table><table><thead><tr><th>核心服务</th><th>作用</th></tr></thead><tbody><tr><td>BatteryService</td><td>管理电池相关的服务</td></tr><tr><td>UsageStatsService</td><td>收集用户使用每一个 APP 的频率、使用时常</td></tr><tr><td>WebViewUpdateService</td><td>WebView 更新服务</td></tr></tbody></table><table><thead><tr><th>其他服务</th><th>作用</th></tr></thead><tbody><tr><td>CameraService</td><td>摄像头相关服务</td></tr><tr><td>AlarmManagerService</td><td>全局定时器管理服务</td></tr><tr><td>InputManagerService</td><td>管理输入事件</td></tr><tr><td>WindowManagerService</td><td>窗口管理服务</td></tr><tr><td>VrManagerService</td><td>VR 模式管理服务</td></tr><tr><td>BluetoothService</td><td>蓝牙管理服务</td></tr><tr><td>NotificationManagerService</td><td>通知管理服务</td></tr><tr><td>DeviceStorageMonitorService</td><td>存储相关管理服务</td></tr><tr><td>LocationManagerService</td><td>定位管理服务</td></tr><tr><td>AudioService</td><td>音频相关管理服务</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><a href=#小结-1><h2 id=小结-1><span class=hanchor arialabel=Anchor># </span>小结</h2></a><p>system_server 进程在启动过程中完成的工作分别是:</p><ol><li>通用部分的初始化</li><li>启动 Binder 线程池，使进程可以通过 Binder 与其他进程进程通信</li><li>创建 SystemServiceManager</li><li>使用 SystemServiceManager 对各种系统服务进行创建、启动和生命周期管理</li></ol><a href=#launcher--android-系统的桌面><h1 id=launcher--android-系统的桌面><span class=hanchor arialabel=Anchor># </span>Launcher —— Android 系统的“桌面”</h1></a><p>在上一节 [frameworks/base/services/java/com/android/server/SystemServer.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/java/com/android/server/SystemServer.java) 的 main 方法中，有一句：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>startOtherServices</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 AMS 的 systemReady 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mActivityManagerService</span><span class=o>.</span><span class=na>systemReady</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>继续跟踪：</p><p>[frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityManagerService.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>systemReady</span><span class=o>(</span><span class=kd>final</span> <span class=n>Runnable</span> <span class=n>goingCallback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 ActivityStackSupervisor 的 resumeFocusedStackTopActivityLocked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>resumeFocusedStackTopActivityLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>mUserController</span><span class=o>.</span><span class=na>sendUserSwitchBroadcastsLocked</span><span class=o>(-</span><span class=n>1</span><span class=o>,</span> <span class=n>currentUserId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>[frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStackSupervisor.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>resumeFocusedStackTopActivityLocked</span><span class=o>(</span><span class=n>ActivityStack</span> <span class=n>targetStack</span><span class=o>,</span> <span class=n>ActivityRecord</span> <span class=n>target</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ActivityOptions</span> <span class=n>targetOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>targetStack</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>isFocusedStack</span><span class=o>(</span><span class=n>targetStack</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 ActivityStack 的 resumeTopActivityUncheckedLocked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>targetStack</span><span class=o>.</span><span class=na>resumeTopActivityUncheckedLocked</span><span class=o>(</span><span class=n>target</span><span class=o>,</span> <span class=n>targetOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ActivityRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=n>mFocusedStack</span><span class=o>.</span><span class=na>topRunningActivityLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>r</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span> <span class=o>!=</span> <span class=n>RESUMED</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mFocusedStack</span><span class=o>.</span><span class=na>resumeTopActivityUncheckedLocked</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>[ActivityStack](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStack.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>resumeTopActivityUncheckedLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>prev</span><span class=o>,</span> <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>inResumeTopActivity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Protect against recursion.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>inResumeTopActivity</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mService</span><span class=o>.</span><span class=na>mLockScreenShown</span> <span class=o>==</span> <span class=n>ActivityManagerService</span><span class=o>.</span><span class=na>LOCK_SCREEN_LEAVING</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mService</span><span class=o>.</span><span class=na>mLockScreenShown</span> <span class=o>=</span> <span class=n>ActivityManagerService</span><span class=o>.</span><span class=na>LOCK_SCREEN_HIDDEN</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>mService</span><span class=o>.</span><span class=na>updateSleepIfNeededLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 resumeTopActivityInnerLocked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>result</span> <span class=o>=</span> <span class=n>resumeTopActivityInnerLocked</span><span class=o>(</span><span class=n>prev</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>inResumeTopActivity</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>resumeTopActivityInnerLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>prev</span><span class=o>,</span> <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 回到 ActivityStackSupervisor 的 resumeHomeStackTask 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>return</span> <span class=n>isOnHomeDisplay</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>resumeHomeStackTask</span><span class=o>(</span><span class=n>returnTaskType</span><span class=o>,</span> <span class=n>prev</span><span class=o>,</span> <span class=s>&#34;prevFinished&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span>                 
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>[frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStackSupervisor.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>resumeHomeStackTask</span><span class=o>(</span><span class=kt>int</span> <span class=n>homeStackTaskType</span><span class=o>,</span> <span class=n>ActivityRecord</span> <span class=n>prev</span><span class=o>,</span> <span class=n>String</span> <span class=n>reason</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>r</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>finishing</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mService</span><span class=o>.</span><span class=na>setFocusedActivityLocked</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>myReason</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>resumeFocusedStackTopActivityLocked</span><span class=o>(</span><span class=n>mHomeStack</span><span class=o>,</span> <span class=n>prev</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 再次回到 AMS 的 startHomeActivityLocked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>mService</span><span class=o>.</span><span class=na>startHomeActivityLocked</span><span class=o>(</span><span class=n>mCurrentUser</span><span class=o>,</span> <span class=n>myReason</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>startHomeActivityLocked</span><span class=o>(</span><span class=kt>int</span> <span class=n>userId</span><span class=o>,</span> <span class=n>String</span> <span class=n>reason</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mFactoryTest</span> <span class=o>==</span> <span class=n>FactoryTest</span><span class=o>.</span><span class=na>FACTORY_TEST_LOW_LEVEL</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>mTopAction</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取 Intent
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Intent</span> <span class=n>intent</span> <span class=o>=</span> <span class=n>getHomeIntent</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ActivityInfo</span> <span class=n>aInfo</span> <span class=o>=</span> <span class=n>resolveActivityInfo</span><span class=o>(</span><span class=n>intent</span><span class=o>,</span> <span class=n>STOCK_PM_FLAGS</span><span class=o>,</span> <span class=n>userId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>aInfo</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=na>setComponent</span><span class=o>(</span><span class=k>new</span> <span class=n>ComponentName</span><span class=o>(</span><span class=n>aInfo</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>.</span><span class=na>packageName</span><span class=o>,</span> <span class=n>aInfo</span><span class=o>.</span><span class=na>name</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>aInfo</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ActivityInfo</span><span class=o>(</span><span class=n>aInfo</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>aInfo</span><span class=o>.</span><span class=na>applicationInfo</span> <span class=o>=</span> <span class=n>getAppInfoForUser</span><span class=o>(</span><span class=n>aInfo</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>,</span> <span class=n>userId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ProcessRecord</span> <span class=n>app</span> <span class=o>=</span> <span class=n>getProcessRecordLocked</span><span class=o>(</span><span class=n>aInfo</span><span class=o>.</span><span class=na>processName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>aInfo</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>.</span><span class=na>uid</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>app</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationClass</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>intent</span><span class=o>.</span><span class=na>setFlags</span><span class=o>(</span><span class=n>intent</span><span class=o>.</span><span class=na>getFlags</span><span class=o>()</span> <span class=o>|</span> <span class=n>Intent</span><span class=o>.</span><span class=na>FLAG_ACTIVITY_NEW_TASK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 使用 mActivityStarter 启动 app，这里不再详细跟踪
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mActivityStarter</span><span class=o>.</span><span class=na>startHomeActivityLocked</span><span class=o>(</span><span class=n>intent</span><span class=o>,</span> <span class=n>aInfo</span><span class=o>,</span> <span class=n>reason</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Slog</span><span class=o>.</span><span class=na>wtf</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;No home screen found for &#34;</span> <span class=o>+</span> <span class=n>intent</span><span class=o>,</span> <span class=k>new</span> <span class=n>Throwable</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>getHomeIntent 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Intent</span> <span class=nf>getHomeIntent</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Intent</span> <span class=n>intent</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Intent</span><span class=o>(</span><span class=n>mTopAction</span><span class=o>,</span> <span class=n>mTopData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>Uri</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>mTopData</span><span class=o>)</span> <span class=o>:</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>intent</span><span class=o>.</span><span class=na>setComponent</span><span class=o>(</span><span class=n>mTopComponent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>intent</span><span class=o>.</span><span class=na>addFlags</span><span class=o>(</span><span class=n>Intent</span><span class=o>.</span><span class=na>FLAG_DEBUG_TRIAGED_MISSING</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mFactoryTest</span> <span class=o>!=</span> <span class=n>FactoryTest</span><span class=o>.</span><span class=na>FACTORY_TEST_LOW_LEVEL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 添加 android.intent.category.HOME
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>intent</span><span class=o>.</span><span class=na>addCategory</span><span class=o>(</span><span class=n>Intent</span><span class=o>.</span><span class=na>CATEGORY_HOME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>intent</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，最后通过一个隐式 Intent 使用 Intent.FLAG_ACTIVITY_NEW_TASK 模式启动了一个带 Intent.CATEGORY_HOME 标签的 Activity，而带有 Intent.CATEGORY_HOME 标签的 Activity 正是 Launcher App，它的 [AndroidManifest](
<a href=https://android.googlesource.com/platform/packages/apps/Launcher3/ rel=noopener>https://android.googlesource.com/platform/packages/apps/Launcher3/</a> /nougat-release/AndroidManifest.xml?autodive=0) 文件如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;manifest</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>package=</span><span class=s>&#34;com.android.launcher3&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;uses-sdk</span> <span class=na>android:targetSdkVersion=</span><span class=s>&#34;23&#34;</span> <span class=na>android:minSdkVersion=</span><span class=s>&#34;16&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nt>&lt;application</span>
</span></span><span class=line><span class=cl>        <span class=na>android:allowBackup=</span><span class=s>&#34;@bool/enable_backup&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:backupAgent=</span><span class=s>&#34;com.android.launcher3.LauncherBackupAgentHelper&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:hardwareAccelerated=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:icon=</span><span class=s>&#34;@mipmap/ic_launcher_home&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:label=</span><span class=s>&#34;@string/app_name&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:largeHeap=</span><span class=s>&#34;@bool/config_largeHeap&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:restoreAnyVersion=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:supportsRtl=</span><span class=s>&#34;true&#34;</span> <span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;activity</span>
</span></span><span class=line><span class=cl>            <span class=na>android:name=</span><span class=s>&#34;com.android.launcher3.Launcher&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:launchMode=</span><span class=s>&#34;singleTask&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:clearTaskOnLaunch=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:stateNotNeeded=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:theme=</span><span class=s>&#34;@style/Theme&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:windowSoftInputMode=</span><span class=s>&#34;adjustPan&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:screenOrientation=</span><span class=s>&#34;nosensor&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:configChanges=</span><span class=s>&#34;keyboard|keyboardHidden|navigation&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:resumeWhilePausing=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:taskAffinity=</span><span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:enabled=</span><span class=s>&#34;true&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;intent-filter&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&#34;android.intent.action.MAIN&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;category</span> <span class=na>android:name=</span><span class=s>&#34;android.intent.category.HOME&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;category</span> <span class=na>android:name=</span><span class=s>&#34;android.intent.category.DEFAULT&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;category</span> <span class=na>android:name=</span><span class=s>&#34;android.intent.category.MONKEY&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/intent-filter&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/activity&gt;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/application&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/manifest&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Launcher 启动后会将所有已安装的应用图标展示在一个网格布局的 RecyclerView 里面，这时候用户就可以通过点击这些图标来启动相应的 app 了。</p><p>这个过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045238.png width=auto alt></p><p>关于 Launcher 如何将 App 图标显示出来等更多工作细节，可以参考
<a href=https://blog.csdn.net/yanbober/article/details/50525559 rel=noopener>Android M Launcher3 主流程源码浅析</a> 和
<a href=http://liuwangshu.cn/framework/booting/4-launcher.html rel=noopener>Android 系统启动流程（四）Launcher 启动过程与系统启动流程</a>这两篇文章。</p><a href=#总结><h1 id=总结><span class=hanchor arialabel=Anchor># </span>总结</h1></a><p>最后，从整体上来看 Android 系统的启动流程：</p><ol><li>按下电源，固化在 ROM 中预定位置的 Bootloader 将会被加载到内存中</li><li>Bootloader 初始化完软硬件环境后将 Linux 内核启动起来</li><li>Linux 内核启动时会做设置缓存、被保护存储器、计划列表和加载驱动等一些列操作，内核启动完成后会启动 init 进程</li><li>init 进程会初始化并启动属性服务，并且解析并执行所有 init.rc 文件</li><li>init 通过执行特定的 init.rc 文件启动 servermanager 进程，servermanager 被启动后会向 Binder 驱动发送命令让自己成为守护进程并管理所有上下文</li><li>init 通过解析 init.rc 文件启动 zygote 进程</li><li>zygote 进程启动的过程会创建 DVM 并为其注册 JNI 函数，然后创建服务端 Socket、启动 system_server 进程</li><li>启动 system_server 进程的过程会创建 Binder 线程池使其具有 IPC 能力，然后启动 AMS 等各种系统服务</li><li>AMS 启动 Launcher，Launcher 被启动后会将已安装应用的图标显示在界面上</li></ol><p>原来，一个复杂的 Android 系统就这么被运行起来了，碍于本人有限的水平，描述这个过程其实也还简化了很多操作，下面这个图比较全面地总结了这个流程：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045241.png width=auto alt></p><p><strong>系列文章</strong></p><p><a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>按下电源键后竟然发生了这一幕 —— Android 系统启动流程分析</a>（本文）</p><p><a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析</a></p><p><a href=https://guanpj.cn/2017/11/09/Android-View-Workflow/ rel=noopener>屏幕上内容究竟是怎样画出来的 —— Android View 工作原理详解</a></p><p><strong>参考文章</strong></p><p><a href=http://gityuan.com/android/ rel=noopener>Gityuan 大神的系列文章</a></p><p><a href=http://liuwangshu.cn/tags/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8/ rel=noopener>刘望舒老师的系列文章</a></p><p><a href=https://www.ibm.com/developerworks/cn/linux/l-btloader/index.html rel=noopener>嵌入式系统 Boot Loader 技术内幕</a></p><blockquote><p>如果你对文章内容有疑问或者有不同的意见，欢迎留言，我们一同探讨。</p></blockquote></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>