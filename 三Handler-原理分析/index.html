<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="看完这篇还不明白 Handler 你砍我 - 掘金
基本使用 Android 应用层通常使用 Handler 实现线程之间的消息通讯，Handler 是 Android 消息机制中非常重要的一员。以下分析通过剖析 Handler 的工作原理来深入了解 Android 应用开发过程中最常见也是最实用的消息收发机制。
在分析之前，先回顾一下 Handler 的使用方式：首先，最常用的是子线程往主线程发送消息："><meta property="og:title" content="三、Handler 原理分析"><meta property="og:description" content="看完这篇还不明白 Handler 你砍我 - 掘金
基本使用 Android 应用层通常使用 Handler 实现线程之间的消息通讯，Handler 是 Android 消息机制中非常重要的一员。以下分析通过剖析 Handler 的工作原理来深入了解 Android 应用开发过程中最常见也是最实用的消息收发机制。
在分析之前，先回顾一下 Handler 的使用方式：首先，最常用的是子线程往主线程发送消息："><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="三、Handler 原理分析"><meta name=twitter:description content="看完这篇还不明白 Handler 你砍我 - 掘金
基本使用 Android 应用层通常使用 Handler 实现线程之间的消息通讯，Handler 是 Android 消息机制中非常重要的一员。以下分析通过剖析 Handler 的工作原理来深入了解 Android 应用开发过程中最常见也是最实用的消息收发机制。
在分析之前，先回顾一下 Handler 的使用方式：首先，最常用的是子线程往主线程发送消息："><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>三、Handler 原理分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.592437b1fbffed6c8a18843d158121af.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.a7a23db1d0aa39ecac0c61a41b5e946c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.293b6ed88f797000f698881f747ba3eb.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>三、Handler 原理分析</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/Handler/>Handler</a></li><li><a href=https://www.guanpj.top/tags/Framework/>Framework</a></li><li><a href=https://www.guanpj.top/tags/Message/>Message</a></li><li><a href=https://www.guanpj.top/tags/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/>消息机制</a></li><li><a href=https://www.guanpj.top/tags/ThreadLocal/>Thread local</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#基本使用>基本使用</a></li><li><a href=#threadlocal-原理分析>ThreadLocal 原理分析</a><ol><li><a href=#threadlocal-概念和使用方式>ThreadLocal 概念和使用方式</a></li><li><a href=#threadlocal-的-set-和-get-方法>ThreadLocal 的 set 和 get 方法</a></li><li><a href=#关于内存泄漏>关于内存泄漏</a></li><li><a href=#strong使用场景strong><strong>使用场景</strong></a></li><li><a href=#小结>小结</a></li></ol></li><li><a href=#message>Message</a><ol><li><a href=#消息对象>消息对象</a></li><li><a href=#消息池>消息池</a><ol><li><a href=#messageobtain>Message.obtain()</a></li><li><a href=#recycler>recycler()</a></li></ol></li><li><a href=#setasynchronousboolean-async>setAsynchronous(boolean async)</a></li></ol></li><li><a href=#looper-工作原理分析>Looper 工作原理分析</a><ol><li><a href=#looper-与-handler-的关联>Looper 与 Handler 的关联</a></li><li><a href=#looper-的创建与获取>Looper 的创建与获取</a></li><li><a href=#looperloop>Looper.loop()</a></li><li><a href=#messagequeue-原理分析>MessageQueue 原理分析</a><ol><li><a href=#messagequeue-的创建>MessageQueue 的创建</a></li><li><a href=#next-方法分析>next() 方法分析</a></li><li><a href=#enqueuemessage-方法分析>enqueueMessage() 方法分析</a></li><li><a href=#removemessage-方法分析>removeMessage() 方法分析</a></li><li><a href=#同步屏障-syncbarrier同步消息和异步消息>同步屏障 SyncBarrier、同步消息和异步消息</a></li></ol></li></ol></li><li><a href=#handler-发送和接收消息>Handler 发送和接收消息</a><ol><li><a href=#发送-message>发送 Message</a></li><li><a href=#接收-message>接收 Message</a><ol><li><a href=#msgcallbackrun>msg.callback.run()</a></li><li><a href=#mcallbackhandlemessagemsg>mCallback.handleMessage(msg)</a></li><li><a href=#handlemessagemsg>handleMessage(msg)</a></li></ol></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></details></aside><p><a href=https://juejin.cn/post/6866015512192876557 rel=noopener>看完这篇还不明白 Handler 你砍我 - 掘金</a></p><a href=#基本使用><h1 id=基本使用><span class=hanchor arialabel=Anchor># </span>基本使用</h1></a><p>Android 应用层通常使用 Handler 实现线程之间的消息通讯，Handler 是 Android 消息机制中非常重要的一员。以下分析通过剖析 Handler 的工作原理来深入了解 Android 应用开发过程中最常见也是最实用的消息收发机制。</p><p>在分析之前，先回顾一下 Handler 的使用方式：首先，最常用的是子线程往主线程发送消息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=kd>final</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;Main thread handler received msg:&#34;</span> <span class=o>+</span> <span class=n>msg</span><span class=o>.</span><span class=na>what</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//发送Message消息对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=na>obtainMessage</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>message</span><span class=o>.</span><span class=na>what</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>message</span><span class=o>.</span><span class=na>obj</span> <span class=o>=</span> <span class=s>&#34;Hello&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>handler</span><span class=o>.</span><span class=na>sendMessage</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//发送Runnable对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>handler</span><span class=o>.</span><span class=na>post</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;Runnable has been called&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Log输出</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=n>Main</span> <span class=n>thread</span> <span class=n>handler</span> <span class=n>received</span> <span class=n>msg</span><span class=o>:</span><span class=n>0</span>
</span></span><span class=line><span class=cl><span class=n>Runnable</span> <span class=n>has</span> <span class=n>been</span> <span class=n>called</span>
</span></span></code></pre></td></tr></table></div></div><p>如果需要反过来在主线程中往某个子线程发送消息，可以使用如下方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WorkThread</span> <span class=kd>extends</span> <span class=n>Thread</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Handler</span> <span class=n>mHandler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Looper</span> <span class=n>mLooper</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Looper</span><span class=o>.</span><span class=na>prepare</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mLooper</span> <span class=o>=</span> <span class=n>Looper</span><span class=o>.</span><span class=na>myLooper</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                 <span class=s>&#34;:Looper prepared&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>//通知等待Looper的线程
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>notifyAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Looper</span><span class=o>.</span><span class=na>loop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Handler</span> <span class=nf>getWorkHandler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mHandler</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mHandler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>getLooper</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;WorkThread received msg:&#34;</span> <span class=o>+</span> <span class=n>msg</span><span class=o>.</span><span class=na>what</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>};</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mHandler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Looper</span> <span class=nf>getLooper</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=n>isAlive</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>mLooper</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//等待Looper
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>                        <span class=s>&#34;:Wait for looper&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>wait</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mLooper</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//创建WorkThread线程并运行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>WorkThread</span> <span class=n>workThread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WorkThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>workThread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//获取WorkThread线程中的Handler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=n>workThread</span><span class=o>.</span><span class=na>getWorkHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//向WorkThread线程发送消息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Message</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=na>obtainMessage</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>msg</span><span class=o>.</span><span class=na>what</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>handler</span><span class=o>.</span><span class=na>sendMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Log输出</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=nl>main:</span><span class=n>Wait</span> <span class=k>for</span> <span class=n>looper</span>
</span></span><span class=line><span class=cl><span class=n>Thread</span><span class=o>-</span><span class=n>3</span><span class=o>:</span><span class=n>Looper</span> <span class=n>prepared</span>
</span></span><span class=line><span class=cl><span class=n>WorkThread</span> <span class=n>received</span> <span class=n>msg</span><span class=o>:</span><span class=n>1</span>
</span></span></code></pre></td></tr></table></div></div><p>需要注意的是，虽然 WorkThread 线程启动方法 start() 先执行，但是由于线程调度的原因，通过 getWorkHandler() 获取 WorkThread 中的 Handler 时，里面的 getLooper() 方法往往会被更早地执行，因此这里需要加入 wait/notifiy 操作，以确保 Looper 先被创建。</p><p>这里会涉及到 Looper、MessageQueue、Message、ThreadLocal 等概念，下面就围绕这几个概念深度分析 Handler 的工作原理。</p><a href=#threadlocal-原理分析><h1 id=threadlocal-原理分析><span class=hanchor arialabel=Anchor># </span>ThreadLocal 原理分析</h1></a><a href=#threadlocal-概念和使用方式><h2 id=threadlocal-概念和使用方式><span class=hanchor arialabel=Anchor># </span>ThreadLocal 概念和使用方式</h2></a><p>ThreadLocal——顾名思义，即用于存储线程本地变量的类。通常情况下，普通变量是可以被任何一个线程访问的，而使用 ThreadLocal 创建的变量只能被当前线程访问，其它线程不能访问也不能够对它进行修改。</p><p>在实现上，每个使用 ThreadLocal 变量的线程都会初始化一个完全独立的实例副本，当一个线程结束时，它所使用的所有 ThreadLocal 相对的实例副本都可被回收。</p><p>总的来说，ThreadLocal 适用于每个线程需要自己独立的实例且该实例需要在多个方法中被使用，也即变量在线程间隔离而在方法或类间共享的场景。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>threadLocal</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocal</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=n>threadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=s>&#34;a&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Thread:&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> 
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>threadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=s>&#34;b&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Thread:&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>threadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=s>&#34;c&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Thread:&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> 
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#threadlocal-的-set-和-get-方法><h2 id=threadlocal-的-set-和-get-方法><span class=hanchor arialabel=Anchor># </span>ThreadLocal 的 set 和 get 方法</h2></a><p>首先，查看它的 set 方法源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Sets the current thread&#39;s copy of this thread-local variable
</span></span></span><span class=line><span class=cl><span class=cm> * to the specified value.  Most subclasses will have no need to
</span></span></span><span class=line><span class=cl><span class=cm> * override this method, relying solely on the {@link #initialValue}
</span></span></span><span class=line><span class=cl><span class=cm> * method to set the values of thread-locals.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param value the value to be stored in the current thread&#39;s copy of
</span></span></span><span class=line><span class=cl><span class=cm> *        this thread-local.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>set</span><span class=o>(</span><span class=n>T</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ThreadLocalMap</span> <span class=n>map</span> <span class=o>=</span> <span class=n>getMap</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>map</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>map</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>createMap</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Set 方法可分为三个步骤：</p><ul><li>首先获取当前线程实例；</li><li>利用当前线程作为参数获取一个 ThreadLocalMap 的对象；</li><li>如果上述 ThreadLocalMap 对象不为空，则设置值，否则创建这个 ThreadLocalMap 对象并设置值。</li></ul><p>获取 ThreadLocalMap 的 getMap 方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get the map associated with a ThreadLocal. Overridden in
</span></span></span><span class=line><span class=cl><span class=cm> * InheritableThreadLocal.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param  t the current thread
</span></span></span><span class=line><span class=cl><span class=cm> * @return the map
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>ThreadLocalMap</span> <span class=nf>getMap</span><span class=o>(</span><span class=n>Thread</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>t</span><span class=o>.</span><span class=na>threadLocals</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>threadLocals 是 Thread 类的一个成员变量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>pulbic</span> <span class=kd>class</span> <span class=nc>Thread</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* ThreadLocal values pertaining to this thread. This map is maintained
</span></span></span><span class=line><span class=cl><span class=cm>     * by the ThreadLocal class. */</span>
</span></span><span class=line><span class=cl>    <span class=n>ThreadLocal</span><span class=o>.</span><span class=na>ThreadLocalMap</span> <span class=n>threadLocals</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>前面的 set 方法中，如果 ThreadLocalMap 对象未创建，则新建 ThreadLocalMap 对象，并设置初始值。createMap 方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Create the map associated with a ThreadLocal. Overridden in
</span></span></span><span class=line><span class=cl><span class=cm> * InheritableThreadLocal.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param t the current thread
</span></span></span><span class=line><span class=cl><span class=cm> * @param firstValue value for the initial entry of the map
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>createMap</span><span class=o>(</span><span class=n>Thread</span> <span class=n>t</span><span class=o>,</span> <span class=n>T</span> <span class=n>firstValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>.</span><span class=na>threadLocals</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocalMap</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>firstValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>相应地，它的 get 方法就是获取当前线程的 ThreadLocalMap 对象，并根据 Key 获取对应的 Value：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Returns the value in the current thread&#39;s copy of this
</span></span></span><span class=line><span class=cl><span class=cm> * thread-local variable.  If the variable has no value for the
</span></span></span><span class=line><span class=cl><span class=cm> * current thread, it is first initialized to the value returned
</span></span></span><span class=line><span class=cl><span class=cm> * by an invocation of the {@link #initialValue} method.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @return the current thread&#39;s value of this thread-local
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>T</span> <span class=nf>get</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ThreadLocalMap</span> <span class=n>map</span> <span class=o>=</span> <span class=n>getMap</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>map</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ThreadLocalMap</span><span class=o>.</span><span class=na>Entry</span> <span class=n>e</span> <span class=o>=</span> <span class=n>map</span><span class=o>.</span><span class=na>getEntry</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>T</span> <span class=n>result</span> <span class=o>=</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span><span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>setInitialValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#关于内存泄漏><h2 id=关于内存泄漏><span class=hanchor arialabel=Anchor># </span>关于内存泄漏</h2></a><p>有人分析 ThreadLocal 将会导致内存泄漏，理由如下：</p><ul><li>首先 ThreadLocal 实例被线程的 ThreadLocalMap 实例持有，也可以看成被线程持有</li><li>如果应用使用了线程池，那么之前的线程实例处理完之后出于复用的目的依然存活</li><li>所以，ThreadLocal 设定的值被持有，会导致内存泄露</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ThreadLocalMap is a customized hash map suitable only for
</span></span></span><span class=line><span class=cl><span class=cm> * maintaining thread local values. No operations are exported
</span></span></span><span class=line><span class=cl><span class=cm> * outside of the ThreadLocal class. The class is package private to
</span></span></span><span class=line><span class=cl><span class=cm> * allow declaration of fields in class Thread.  To help deal with
</span></span></span><span class=line><span class=cl><span class=cm> * very large and long-lived usages, the hash table entries use
</span></span></span><span class=line><span class=cl><span class=cm> * WeakReferences for keys. However, since reference queues are not
</span></span></span><span class=line><span class=cl><span class=cm> * used, stale entries are guaranteed to be removed only when
</span></span></span><span class=line><span class=cl><span class=cm> * the table starts running out of space.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>static</span> <span class=kd>class</span> <span class=nc>ThreadLocalMap</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * The entries in this hash map extend WeakReference, using
</span></span></span><span class=line><span class=cl><span class=cm>     * its main ref field as the key (which is always a
</span></span></span><span class=line><span class=cl><span class=cm>     * ThreadLocal object).  Note that null keys (i.e. entry.get()
</span></span></span><span class=line><span class=cl><span class=cm>     * == null) mean that the key is no longer referenced, so the
</span></span></span><span class=line><span class=cl><span class=cm>     * entry can be expunged from table.  Such entries are referred to
</span></span></span><span class=line><span class=cl><span class=cm>     * as &#34;stale entries&#34; in the code that follows.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Entry</span> <span class=kd>extends</span> <span class=n>WeakReference</span><span class=o>&lt;</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/** The value associated with this ThreadLocal. */</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Entry</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>k</span><span class=o>,</span> <span class=n>Object</span> <span class=n>v</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>super</span><span class=o>(</span><span class=n>k</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span> <span class=o>=</span> <span class=n>v</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ThreadLocalMap 的 Key 并不是直接使用 ThreadLocal 实例，而是 ThreadLocal 实例的弱引用。弱引用的特点是，如果这个对象只存在弱引用，那么在下一次垃圾回收的时候必然会被清理掉。</p><p>但是这里仅仅回收作为 Key 的 ThreadLocal 对象，Entry 对象和 Value 并没有回收，ThreadLocalMap 里就可能存在很多 Key 为 null 的 Entry。ThreadLocalMap 实现中已经考虑了这种情况，在调用 set()、get()、remove() 方法的时候，会清理掉 key 为 null 的记录。以 get 方法为例，源码如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>T</span> <span class=nf>get</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ThreadLocalMap</span> <span class=n>map</span> <span class=o>=</span> <span class=n>getMap</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>map</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ThreadLocalMap</span><span class=o>.</span><span class=na>Entry</span> <span class=n>e</span> <span class=o>=</span> <span class=n>map</span><span class=o>.</span><span class=na>getEntry</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>T</span> <span class=n>result</span> <span class=o>=</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span><span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>setInitialValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Entry</span> <span class=nf>getEntry</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=na>threadLocalHashCode</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>table</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Entry</span> <span class=n>e</span> <span class=o>=</span> <span class=n>table</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>e</span><span class=o>.</span><span class=na>get</span><span class=o>()</span> <span class=o>==</span> <span class=n>key</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=c1>//当前位置没有找到,可能Hash碰撞了
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>getEntryAfterMiss</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>i</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Entry</span> <span class=nf>getEntryAfterMiss</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>key</span><span class=o>,</span> <span class=kt>int</span> <span class=n>i</span><span class=o>,</span> <span class=n>Entry</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>[]</span> <span class=n>tab</span> <span class=o>=</span> <span class=n>table</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>k</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>k</span> <span class=o>==</span> <span class=n>key</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>//找到了直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>k</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>//检测到有个ThreadLocal对象被回收了,这个时候去清理后面所有Key为null的Entry
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>expungeStaleEntry</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>len</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从源码中可以看到，ThreadLocalMap 清理掉 Key 为 null 的 Entry 的时机是根据 ThreadLocal 对象的 hashCode 去获取 Entry 时发生了 hash 碰撞的情况下，并且下一个 Entry 的 Key 为 null 的时候。因为 ThreadLocalMap 的 Entry 和普通 Map 的不太一样，一般的 Map 是一个链表数组，而它的数组每个元素就是一个 Entry，如果出现 Hash 碰撞了就放到数组的下一个位置，因此如果 get 的时候发现没有碰撞可以认为当前 Map 中的元素还不多，一旦检测到碰撞了并且下一个 Entry 的 Key 被回收了，就调用 expungeStaleEntry 方法来释放 ThreadLocal 为 null 的那些 Entry，进一步避免了内存泄露。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>expungeStaleEntry</span><span class=o>(</span><span class=kt>int</span> <span class=n>staleSlot</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>[]</span> <span class=n>tab</span> <span class=o>=</span> <span class=n>table</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// expunge entry at staleSlot
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>tab</span><span class=o>[</span><span class=n>staleSlot</span><span class=o>].</span><span class=na>value</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>tab</span><span class=o>[</span><span class=n>staleSlot</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span><span class=o>--;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Rehash until we encounter null
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Entry</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>staleSlot</span><span class=o>,</span> <span class=n>len</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=o>(</span><span class=n>e</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>])</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>         <span class=n>i</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>len</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>k</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>k</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//清理key为null的entry
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>e</span><span class=o>.</span><span class=na>value</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>size</span><span class=o>--;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=n>k</span><span class=o>.</span><span class=na>threadLocalHashCode</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>len</span> <span class=o>-</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>//hashCode发生了变化,重新放置entry
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>h</span> <span class=o>!=</span> <span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=o>(</span><span class=n>tab</span><span class=o>[</span><span class=n>h</span><span class=o>]</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>h</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>h</span><span class=o>,</span> <span class=n>len</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>tab</span><span class=o>[</span><span class=n>h</span><span class=o>]</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>i</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>那只如果在出现了 key 为 null 的记录后，没有手动调用 remove() 方法，并且之后也不再调用 get()、set()、remove() 方法的情况下，还是有可能会出现内存泄漏的情况。因此，强烈建议回收自定义的 ThreadLocal 变量，尤其在线程池场景下，因为线程经常会被复用，如果不清理自定义的 ThreadLocal 变量，可能会影响后续业务逻辑和造成内存泄露等问题。 并且尽量在代理中使用 try-finally 块进行回收：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>objectThreadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>userInfo</span><span class=o>);</span> 
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> 
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>objectThreadLocal</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span> 
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong使用场景strong><h2 id=strong使用场景strong><span class=hanchor arialabel=Anchor># </span><strong>使用场景</strong></h2></a><p>根据以上分析，ThreadLocal 适用于如下两种场景</p><ul><li>每个线程需要有自己单独的实例</li><li>实例需要在多个方法中共享，但不希望被多线程共享</li></ul><p>对于第一点，每个线程拥有自己实例，实现它的方式很多。例如可以在线程内部构建一个单独的实例。ThreadLocal 可以以非常方便的形式满足该需求。</p><p>对于第二点，可以在满足第一点（每个线程有自己的实例）的条件下，通过方法间引用传递的形式实现。ThreadLocal 使得代码耦合度更低，且实现更优雅。</p><a href=#小结><h2 id=小结><span class=hanchor arialabel=Anchor># </span>小结</h2></a><p>ThreadLocal 可以保证每个线程拥有一个变量的副本，实现了线程隔离。在实现上，每个 Thread 类持有有一个 ThreadLocalMap 对象，ThreadLocalMap 保存了该线程拥有的所有 ThreadLocal 对象，并利用弱引用机制避免了 Map 无限增大并避免了内存泄露的问题。</p><a href=#message><h1 id=message><span class=hanchor arialabel=Anchor># </span>Message</h1></a><a href=#消息对象><h2 id=消息对象><span class=hanchor arialabel=Anchor># </span>消息对象</h2></a><p>Message 类是应用层消息的载体，是消息机制中的流通对象。它的结构如下：</p><a href=#消息池><h2 id=消息池><span class=hanchor arialabel=Anchor># </span>消息池</h2></a><p>由于 Handler 消息机制在 framework 层和应用层充当了非常广泛的作用，这也意味着它的使用会非常频繁，因此对于 Message 的创建和回收的优化就显得非常必要。当消息池不为空时，可以直接从消息池中获取 Message 对象，而不是直接创建，提高效率。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>Message</span> <span class=n>sPool</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>sPoolSize</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MAX_POOL_SIZE</span> <span class=o>=</span> <span class=n>50</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=n>gCheckRecycle</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span></code></pre></td></tr></table></div></div><p>静态变量 sPool 的 Message，可以认为是消息池的头部，每个 Message 通过 next 成员变量引用下一个 Message 对象；sPoolSize 代表当前消息池的长度；静态变量 MAX_POOL_SIZE 代表消息池的可用大小；消息池的默认大小为 50。</p><a href=#messageobtain><h3 id=messageobtain><span class=hanchor arialabel=Anchor># </span>Message.obtain()</h3></a><p>静态方法 obtain() 可用来获取一个消息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Message</span> <span class=nf>obtain</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>sPoolSync</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>sPool</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Message</span> <span class=n>m</span> <span class=o>=</span> <span class=n>sPool</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>sPool</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span> <span class=c1>//从sPool中取出一个Message对象，并消息链表断开
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>m</span><span class=o>.</span><span class=na>flags</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=c1>// 清除in-use flag
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>sPoolSize</span><span class=o>--;</span> <span class=c1>//消息池的可用大小进行减1操作
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=n>m</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Message</span><span class=o>();</span> <span class=c1>// 当消息池为空时，直接创建Message对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从消息池获取 Message 操作就是把消息池的头部 Message 取走，再将头部指向它的 next。</p><a href=#recycler><h3 id=recycler><span class=hanchor arialabel=Anchor># </span>recycler()</h3></a><p>通过 recycler() 方法可以把不再使用的消息加入消息池：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>recycle</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isInUse</span><span class=o>())</span> <span class=o>{</span> <span class=c1>//判断消息是否正在使用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>gCheckRecycle</span><span class=o>)</span> <span class=o>{</span> <span class=c1>//Android 5.0以后的版本默认为true,之前的版本默认为false.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;This message cannot be recycled because it is still in use.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>recycleUnchecked</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//对于不再使用的消息，加入到消息池
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>recycleUnchecked</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//将消息标示位置为IN_USE，并清空消息所有的参数。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>flags</span> <span class=o>=</span> <span class=n>FLAG_IN_USE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>what</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>arg1</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>arg2</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>replyTo</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sendingUid</span> <span class=o>=</span> <span class=o>-</span><span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>when</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>sPoolSync</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>sPoolSize</span> <span class=o>&lt;</span> <span class=n>MAX_POOL_SIZE</span><span class=o>)</span> <span class=o>{</span> <span class=c1>//当消息池没有满时，将Message对象加入消息池
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>next</span> <span class=o>=</span> <span class=n>sPool</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>sPool</span> <span class=o>=</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>sPoolSize</span><span class=o>++;</span> <span class=c1>//消息池的可用大小进行加1操作
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>recycle() 操作将 Message 加入到消息池的过程，其实就是把 Message 加到消息池的头部。</p><a href=#setasynchronousboolean-async><h2 id=setasynchronousboolean-async><span class=hanchor arialabel=Anchor># </span>setAsynchronous(boolean async)</h2></a><p>设置消息类型为同步或者异步：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Sets whether the message is asynchronous, meaning that it is not
</span></span></span><span class=line><span class=cl><span class=cm> * subject to {@link Looper} synchronization barriers.
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * Certain operations, such as view invalidation, may introduce synchronization
</span></span></span><span class=line><span class=cl><span class=cm> * barriers into the {@link Looper}&#39;s message queue to prevent subsequent messages
</span></span></span><span class=line><span class=cl><span class=cm> * from being delivered until some condition is met.  In the case of view invalidation,
</span></span></span><span class=line><span class=cl><span class=cm> * messages which are posted after a call to {@link android.view.View#invalidate}
</span></span></span><span class=line><span class=cl><span class=cm> * are suspended by means of a synchronization barrier until the next frame is
</span></span></span><span class=line><span class=cl><span class=cm> * ready to be drawn.  The synchronization barrier ensures that the invalidation
</span></span></span><span class=line><span class=cl><span class=cm> * request is completely handled before resuming.
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;/p&gt;&lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * Asynchronous messages are exempt from synchronization barriers.  They typically
</span></span></span><span class=line><span class=cl><span class=cm> * represent interrupts, input events, and other signals that must be handled independently
</span></span></span><span class=line><span class=cl><span class=cm> * even while other work has been suspended.
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;/p&gt;&lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * Note that asynchronous messages may be delivered out of order with respect to
</span></span></span><span class=line><span class=cl><span class=cm> * synchronous messages although they are always delivered in order among themselves.
</span></span></span><span class=line><span class=cl><span class=cm> * If the relative order of these messages matters then they probably should not be
</span></span></span><span class=line><span class=cl><span class=cm> * asynchronous in the first place.  Use with caution.
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param async True if the message is asynchronous.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @see #isAsynchronous()
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setAsynchronous</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>async</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>async</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span> <span class=o>|=</span> <span class=n>FLAG_ASYNCHRONOUS</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>FLAG_ASYNCHRONOUS</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#looper-工作原理分析><h1 id=looper-工作原理分析><span class=hanchor arialabel=Anchor># </span>Looper 工作原理分析</h1></a><a href=#looper-与-handler-的关联><h2 id=looper-与-handler-的关联><span class=hanchor arialabel=Anchor># </span>Looper 与 Handler 的关联</h2></a><p>通常我们会通过以下构造方法创建 Handler 对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Handler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Handler</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Callback</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span><span class=n>callback</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Handler</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Callback</span> <span class=n>callback</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>async</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>FIND_POTENTIAL_LEAKS</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Handler</span><span class=o>&gt;</span> <span class=n>klass</span> <span class=o>=</span> <span class=n>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>((</span><span class=n>klass</span><span class=o>.</span><span class=na>isAnonymousClass</span><span class=o>()</span> <span class=o>||</span> <span class=n>klass</span><span class=o>.</span><span class=na>isMemberClass</span><span class=o>()</span> <span class=o>||</span> <span class=n>klass</span><span class=o>.</span><span class=na>isLocalClass</span><span class=o>())</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=o>(</span><span class=n>klass</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>()</span> <span class=o>&amp;</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>STATIC</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;The following Handler class should be static or leaks might occur: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=n>klass</span><span class=o>.</span><span class=na>getCanonicalName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mLooper</span> <span class=o>=</span> <span class=n>Looper</span><span class=o>.</span><span class=na>myLooper</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mLooper</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Can&#39;t create handler inside thread &#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=s>&#34; that has not called Looper.prepare()&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mQueue</span> <span class=o>=</span> <span class=n>mLooper</span><span class=o>.</span><span class=na>mQueue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mCallback</span> <span class=o>=</span> <span class=n>callback</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mAsynchronous</span> <span class=o>=</span> <span class=n>async</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Handler</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Looper</span> <span class=n>looper</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span><span class=n>looper</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Handler</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Looper</span> <span class=n>looper</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Callback</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span><span class=n>looper</span><span class=o>,</span> <span class=n>callback</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@UnsupportedAppUsage</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Handler</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Looper</span> <span class=n>looper</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Callback</span> <span class=n>callback</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>async</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mLooper</span> <span class=o>=</span> <span class=n>looper</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mQueue</span> <span class=o>=</span> <span class=n>looper</span><span class=o>.</span><span class=na>mQueue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mCallback</span> <span class=o>=</span> <span class=n>callback</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mAsynchronous</span> <span class=o>=</span> <span class=n>async</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，前面两个 Handler 已被标记为废弃，因为的创建必需依赖与 Looper，如果 Handler 被创建于没有 Looper 的线程中将会抛出异常，因此推荐使用后面两种构造方法。</p><p>在构造方法中，成员变量 mQueue 将被赋值为 Looper 中的 MessageQueue 示例；mCallback 则被赋值为调用者传入的对象；mAsynchronous 默认为 false（@UnsupportedAppUsage 标记的构造方法不能直接被外面调用）。</p><a href=#looper-的创建与获取><h2 id=looper-的创建与获取><span class=hanchor arialabel=Anchor># </span>Looper 的创建与获取</h2></a><p>那么 Looper 怎么获取呢？如果要在主线程或者当前线程中接收消息，可以这样创建：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>Looper</span><span class=o>.</span><span class=na>getMainLooper</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=kd>final</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>Looper</span><span class=o>.</span><span class=na>myLooper</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=kd>final</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，也可以像本文开头部分示例的方式一样，传入一个在其它线程中创建的 Looper，表示该 Handler 将在对应的线程中处理消息。那么如何为一个线程创建 Looper 呢？只需要调用 Looper.prepare() 方法即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WorkThread</span> <span class=kd>extends</span> <span class=n>Thread</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Handler</span> <span class=n>mHandler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Looper</span><span class=o>.</span><span class=na>prepare</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mHandler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>Looper</span><span class=o>.</span><span class=na>myLooper</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Looper</span><span class=o>.</span><span class=na>loop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>prepare() 是 Looper 类的一个静态方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>prepare</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>prepare</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>prepare</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>quitAllowed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>sThreadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Only one Looper may be created per thread&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>sThreadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=k>new</span> <span class=n>Looper</span><span class=o>(</span><span class=n>quitAllowed</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=nf>Looper</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>quitAllowed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageQueue</span><span class=o>(</span><span class=n>quitAllowed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里的 Looper 来自于 ThreadLocal 中，并且每个线程最多只能拥有一个 Looper 对象。结合前面的分析可知，这个 Looper 对象只属于当前线程。在创建 Looper 的同时，mQueue 也将被初始化，quitAllowed 表示是否可以退出，意味着每个线程也最多拥有一个 MessageQueue。</p><a href=#looperloop><h2 id=looperloop><span class=hanchor arialabel=Anchor># </span>Looper.loop()</h2></a><p>接着看 Looper 的 loop() 方法，提取关键部分后的代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>loop</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Looper</span> <span class=n>me</span> <span class=o>=</span> <span class=n>myLooper</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>me</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;No Looper; Looper.prepare() wasn&#39;t called on this thread.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>MessageQueue</span> <span class=n>queue</span> <span class=o>=</span> <span class=n>me</span><span class=o>.</span><span class=na>mQueue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 不断获取Message消息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Message</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=na>next</span><span class=o>();</span> <span class=c1>// might block
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>msg</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// No message indicates that the message queue is quitting.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span><span class=o>.</span><span class=na>target</span><span class=o>.</span><span class=na>dispatchMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>msg</span><span class=o>.</span><span class=na>recycleUnchecked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，loop() 方法是一个死循环，这个死循环唯一的退出途径就是 queue.next() 方法返回 null 的时候。循环里面会不断调用 MessageQueue.next() 方法来获取 Message 对象，next() 方法在没有返回 Message 时方法将被阻塞。Looper 处理 Message 的方式是调用它的 target 对象的 dispatchMessage 方法，并把 Message 对象作为参数传进去。</p><a href=#messagequeue-原理分析><h2 id=messagequeue-原理分析><span class=hanchor arialabel=Anchor># </span>MessageQueue 原理分析</h2></a><p>MessageQueue 字面意义为消息队列，但其实它的结构是一个单向链表。它的 next() 和 enqueueMessage() 方法分别对应该链表的获取和添加元素操作。为了方便理解，下面仍然称之为消息队列。</p><a href=#messagequeue-的创建><h3 id=messagequeue-的创建><span class=hanchor arialabel=Anchor># </span>MessageQueue 的创建</h3></a><p>MessageQueue 只有一个构造方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>long</span> <span class=n>mPtr</span><span class=o>;</span> <span class=c1>// used by native code
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>MessageQueue</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>quitAllowed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mQuitAllowed</span> <span class=o>=</span> <span class=n>quitAllowed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化消息队列，mPtr是供native代码调用的一个变量    
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mPtr</span> <span class=o>=</span> <span class=n>nativeInit</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#next-方法分析><h3 id=next-方法分析><span class=hanchor arialabel=Anchor># </span>next() 方法分析</h3></a><p>MessageQueue 的 next() 方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@UnsupportedAppUsage</span>
</span></span><span class=line><span class=cl><span class=n>Message</span> <span class=nf>next</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Return here if the message loop has already quit and been disposed.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// This can happen if the application tries to restart a looper after quit
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// which is not supported.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>long</span> <span class=n>ptr</span> <span class=o>=</span> <span class=n>mPtr</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>ptr</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span><span class=c1>//表示当MessageQueue已经退出，则直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>pendingIdleHandlerCount</span> <span class=o>=</span> <span class=o>-</span><span class=n>1</span><span class=o>;</span> <span class=c1>// -1 only during first iteration
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>nextPollTimeoutMillis</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>nextPollTimeoutMillis</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Binder</span><span class=o>.</span><span class=na>flushPendingCommands</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//阻塞操作，等待时长nextPollTimeoutMillis后，或者消息队列被唤醒，都会返回
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>nativePollOnce</span><span class=o>(</span><span class=n>ptr</span><span class=o>,</span> <span class=n>nextPollTimeoutMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Try to retrieve the next message.  Return if found.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kd>final</span> <span class=kt>long</span> <span class=n>now</span> <span class=o>=</span> <span class=n>SystemClock</span><span class=o>.</span><span class=na>uptimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Message</span> <span class=n>prevMsg</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>Message</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>mMessages</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>msg</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>msg</span><span class=o>.</span><span class=na>target</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 碰到同步屏障，则跳过同步消息，只取出异步消息，并且不会移除屏障
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>do</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>prevMsg</span> <span class=o>=</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>msg</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>while</span> <span class=o>(</span><span class=n>msg</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>msg</span><span class=o>.</span><span class=na>isAsynchronous</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>msg</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>now</span> <span class=o>&lt;</span> <span class=n>msg</span><span class=o>.</span><span class=na>when</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 当前Message的触发事件在当前时间时间之后，则继续等待
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>nextPollTimeoutMillis</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>when</span> <span class=o>-</span> <span class=n>now</span><span class=o>,</span> <span class=n>Integer</span><span class=o>.</span><span class=na>MAX_VALUE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 将目标Message对象从队列中移除，并返回
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>mBlocked</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>prevMsg</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>prevMsg</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>mMessages</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>msg</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>DEBUG</span><span class=o>)</span> <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Returning message: &#34;</span> <span class=o>+</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 设置消息的使用状态：flags |= FLAG_IN_USE
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>msg</span><span class=o>.</span><span class=na>markInUse</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// No more messages.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>nextPollTimeoutMillis</span> <span class=o>=</span> <span class=o>-</span><span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Process the quit message now that all pending messages have been handled.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>mQuitting</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dispose</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// If first time idle, then get the number of idlers to run.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// Idle handles only run if the queue is empty or if the first message
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// in the queue (possibly a barrier) is due to be handled in the future.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>pendingIdleHandlerCount</span> <span class=o>&lt;</span> <span class=n>0</span>
</span></span><span class=line><span class=cl>                    <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>mMessages</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>now</span> <span class=o>&lt;</span> <span class=n>mMessages</span><span class=o>.</span><span class=na>when</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pendingIdleHandlerCount</span> <span class=o>=</span> <span class=n>mIdleHandlers</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>pendingIdleHandlerCount</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// No idle handlers to run.  Loop and wait some more.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>mBlocked</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>mPendingIdleHandlers</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>mPendingIdleHandlers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IdleHandler</span><span class=o>[</span><span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>pendingIdleHandlerCount</span><span class=o>,</span> <span class=n>4</span><span class=o>)];</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>mPendingIdleHandlers</span> <span class=o>=</span> <span class=n>mIdleHandlers</span><span class=o>.</span><span class=na>toArray</span><span class=o>(</span><span class=n>mPendingIdleHandlers</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Run the idle handlers.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// We only ever reach this code block during the first iteration.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>pendingIdleHandlerCount</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>IdleHandler</span> <span class=n>idler</span> <span class=o>=</span> <span class=n>mPendingIdleHandlers</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=n>mPendingIdleHandlers</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span> <span class=c1>// release the reference to the handler
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>keep</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>keep</span> <span class=o>=</span> <span class=n>idler</span><span class=o>.</span><span class=na>queueIdle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Log</span><span class=o>.</span><span class=na>wtf</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;IdleHandler threw exception&#34;</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(!</span><span class=n>keep</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>mIdleHandlers</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>idler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Reset the idle handler count to 0 so we do not run them again.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pendingIdleHandlerCount</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// While calling an idle handler, a new message could have been delivered
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// so go back and look again for a pending message without waiting.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>nextPollTimeoutMillis</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里也同样创建了一个死循环，nativePollOnce() 方法在 JNI 层会调用到内核中的 epoll_wait() 方法，这是阻塞方法（阻塞时线程休眠，释放 CPU 资源），用于等待事件发生或者超时，当被事件到来或者等待 nextPollTimeoutMillis（时间） 后会被唤醒。因此，这里的 <code>for(;;)</code> 并不会造成无限循环。</p><blockquote><p>当 nextPollTimeoutMillis = -1 时，表示消息队列中无消息，会一直等待；当 nextPollTimeoutMillis = 0 时会直接返回。</p></blockquote><p>msg.target == null 表示队列头部的消息是一个同步屏障，此时只会处理异步消息，直到同步屏障被移除。文章后面会补充更详细的关于同步屏障的理解。</p><p>这里后半部分代码中，当处于空闲时，往往会执行 IdleHandler 中的方法。当 nativePollOnce() 返回后， next() 从 mMessages 中提取一个消息。</p><a href=#enqueuemessage-方法分析><h3 id=enqueuemessage-方法分析><span class=hanchor arialabel=Anchor># </span>enqueueMessage() 方法分析</h3></a><p>再来看 enqueueMessage() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>enqueueMessage</span><span class=o>(</span><span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=kt>long</span> <span class=n>when</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 普通Message必须设置target
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>target</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Message must have a target.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果Message具有FLAG_IN_USE标记，则不允许再使用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>isInUse</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=n>msg</span> <span class=o>+</span> <span class=s>&#34; This message is already in use.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// MessageQueue正在退出时，需要回收该Message并加入到消息池，返回false
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>mQuitting</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>IllegalStateException</span> <span class=n>e</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>msg</span><span class=o>.</span><span class=na>target</span> <span class=o>+</span> <span class=s>&#34; sending message to a Handler on a dead thread&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>(),</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>msg</span><span class=o>.</span><span class=na>markInUse</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>msg</span><span class=o>.</span><span class=na>when</span> <span class=o>=</span> <span class=n>when</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>p</span> <span class=o>=</span> <span class=n>mMessages</span><span class=o>;</span><span class=c1>// 头节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>boolean</span> <span class=n>needWake</span><span class=o>;</span> <span class=c1>// 需要唤醒MessageQueue
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>p</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>when</span> <span class=o>==</span> <span class=n>0</span> <span class=o>||</span> <span class=n>when</span> <span class=o>&lt;</span> <span class=n>p</span><span class=o>.</span><span class=na>when</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// p <mark> null表示MessageQueue为空；when </mark> 0表示msg为插队消息；
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// when &lt; p.when表示该消息触发时间是最早的（mMessages为链表头结点）
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 这三种情况都把msg加入到队列头部
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>msg</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>mMessages</span> <span class=o>=</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>needWake</span> <span class=o>=</span> <span class=n>mBlocked</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将消息按时间顺序插入到MessageQueue。一般不需要唤醒MessageQueue，
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 除非最头部存在barrier，并且同时Message是队列中最早的异步消息。
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>needWake</span> <span class=o>=</span> <span class=n>mBlocked</span> <span class=o>&amp;&amp;</span> <span class=n>p</span><span class=o>.</span><span class=na>target</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>msg</span><span class=o>.</span><span class=na>isAsynchronous</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Message</span> <span class=n>prev</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 遍历队列，对比when，找到合适的位置并插入
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>prev</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 如果到达队尾或者when在当前结点之前，表示找到插入位置
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>p</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>when</span> <span class=o>&lt;</span> <span class=n>p</span><span class=o>.</span><span class=na>when</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 当前结点也是异步消息，则不需要唤醒了
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>needWake</span> <span class=o>&amp;&amp;</span> <span class=n>p</span><span class=o>.</span><span class=na>isAsynchronous</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>needWake</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>//插入链表
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>msg</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span> <span class=c1>// invariant: p == prev.next
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>prev</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// We can assume mPtr != 0 because mQuitting is false.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>needWake</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>nativeWake</span><span class=o>(</span><span class=n>mPtr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>根据以上分析可知，MessageQueue 是按照 Message 触发时间的先后顺序排列的，队列头部的消息是将要最早触发的消息。当有消息需要加入消息队列时，会从队列头部开始遍历，直到找到消息应该插入的合适位置，以保证所有消息的时间顺序。</p><p>消息插入一般不需要唤醒 MessageQueue，但是在 MessageQueue 当前处于阻塞状态的大前提下，消息的插入位置为 MessageQueue 头部，或者最头部存在同步障碍时 Message 是队列中最早的异步消息，意味着当前消息需要马上处理，插入后就需要唤醒阻塞中的 MessageQueue。</p><p>当需要唤醒时，通过 nativeWake() 方法在 JNI 层会最终调用到内核中的调用 Looper::wake() 方法向管道 mWakeEventfd 写入字符，此时会唤醒 MessageQueue.next() 方法 nativePollOnce() 处的代码继续向下执行。</p><a href=#removemessage-方法分析><h3 id=removemessage-方法分析><span class=hanchor arialabel=Anchor># </span>removeMessage() 方法分析</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>removeMessages</span><span class=o>(</span><span class=n>Handler</span> <span class=n>h</span><span class=o>,</span> <span class=kt>int</span> <span class=n>what</span><span class=o>,</span> <span class=n>Object</span> <span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>h</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>p</span> <span class=o>=</span> <span class=n>mMessages</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Remove all messages at front.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=o>(</span><span class=n>p</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>p</span><span class=o>.</span><span class=na>target</span> <span class=o>==</span> <span class=n>h</span> <span class=o>&amp;&amp;</span> <span class=n>p</span><span class=o>.</span><span class=na>what</span> <span class=o>==</span> <span class=n>what</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>object</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>p</span><span class=o>.</span><span class=na>obj</span> <span class=o>==</span> <span class=n>object</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Message</span> <span class=n>n</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>mMessages</span> <span class=o>=</span> <span class=n>n</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=na>recycleUnchecked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>n</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Remove all messages after front.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=o>(</span><span class=n>p</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Message</span> <span class=n>n</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>n</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>n</span><span class=o>.</span><span class=na>target</span> <span class=o>==</span> <span class=n>h</span> <span class=o>&amp;&amp;</span> <span class=n>n</span><span class=o>.</span><span class=na>what</span> <span class=o>==</span> <span class=n>what</span>
</span></span><span class=line><span class=cl>                    <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>object</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>n</span><span class=o>.</span><span class=na>obj</span> <span class=o>==</span> <span class=n>object</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Message</span> <span class=n>nn</span> <span class=o>=</span> <span class=n>n</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=o>.</span><span class=na>recycleUnchecked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>p</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>nn</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>n</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个移除消息的方法，采用了两个 while 循环，第一个循环是从队头开始，移除符合条件的消息，第二个循环是从头部移除完连续的满足条件的消息之后，再从队列后面继续查询是否有满足条件的消息需要被移除。</p><a href=#同步屏障-syncbarrier同步消息和异步消息><h3 id=同步屏障-syncbarrier同步消息和异步消息><span class=hanchor arialabel=Anchor># </span>同步屏障 SyncBarrier、同步消息和异步消息</h3></a><p>默认情况下，我们向某个 Handler 发送的消息默认都是异步消息。试想一下，如果某些时候想要让消息快速地发送到指定线程，但是如果该线程的 MessageQueue 中积累了大量未处理消息，则达不到预期的效果。</p><p>因此 Handler 体系提供了一套同步屏障机制，通过区分同步消息和异步消息，让某些特殊的消息得以更快被执行的机制。这也从前面 next() 方法分析中得到验证。</p><p>那么如何设置和取消一个同步屏障呢？方法就是调用它的 postSyncBarrier() 和 removeSyncBarrier () 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@UnsupportedAppUsage</span>
</span></span><span class=line><span class=cl><span class=nd>@TestApi</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>int</span> <span class=nf>postSyncBarrier</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>postSyncBarrier</span><span class=o>(</span><span class=n>SystemClock</span><span class=o>.</span><span class=na>uptimeMillis</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>postSyncBarrier</span><span class=o>(</span><span class=kt>long</span> <span class=n>when</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Enqueue a new sync barrier token.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// We don&#39;t need to wake the queue because the purpose of a barrier is to stall it.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>token</span> <span class=o>=</span> <span class=n>mNextBarrierToken</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Message</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>msg</span><span class=o>.</span><span class=na>markInUse</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>msg</span><span class=o>.</span><span class=na>when</span> <span class=o>=</span> <span class=n>when</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>msg</span><span class=o>.</span><span class=na>arg1</span> <span class=o>=</span> <span class=n>token</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>prev</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>p</span> <span class=o>=</span> <span class=n>mMessages</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>when</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=n>p</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>p</span><span class=o>.</span><span class=na>when</span> <span class=o>&lt;=</span> <span class=n>when</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>prev</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>prev</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// invariant: p == prev.next
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>msg</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>prev</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>mMessages</span> <span class=o>=</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>token</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>removeSyncBarrier</span><span class=o>(</span><span class=kt>int</span> <span class=n>token</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Remove a sync barrier token from the queue.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// If the queue is no longer stalled by a barrier then wake it.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>prev</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>p</span> <span class=o>=</span> <span class=n>mMessages</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>p</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>p</span><span class=o>.</span><span class=na>target</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>p</span><span class=o>.</span><span class=na>arg1</span> <span class=o>!=</span> <span class=n>token</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>prev</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>p</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;The specified message queue synchronization &#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=s>&#34; barrier token has not been posted or has already been removed.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>needWake</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>prev</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>prev</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>needWake</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mMessages</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>needWake</span> <span class=o>=</span> <span class=n>mMessages</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>mMessages</span><span class=o>.</span><span class=na>target</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=na>recycleUnchecked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// If the loop is quitting then it is already awake.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// We can assume mPtr != 0 when mQuitting is false.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>needWake</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mQuitting</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>nativeWake</span><span class=o>(</span><span class=n>mPtr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>前面提到过，普通 Message 必须设置一个 target，对于特殊的 Message 是没有 target 的。 这个消息的价值就是用于拦截同步消息，所以并不会唤醒 Looper。</p><p>postSyncBarrier 方法会返回一个 int 类型的 token，调用 removeSyncBarrier 并传入这个 token 则可以移除同步屏障。</p><p>这两个方法都被标记了 @UnsupportedAppUsage 注解，因此普通开发者无法直接调用。那么它在什么时候会被调用呢？Android 应用框架中为了更快的响应 UI 刷新事件，在 ViewRootImpl.scheduleTraversals 中使用了同步屏障：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>scheduleTraversals</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>mTraversalScheduled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mTraversalScheduled</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置同步障碍，暂停处理后面的同步消息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mTraversalBarrier</span> <span class=o>=</span> <span class=n>mHandler</span><span class=o>.</span><span class=na>getLooper</span><span class=o>().</span><span class=na>getQueue</span><span class=o>().</span><span class=na>postSyncBarrier</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 在下一帧到来的时候执行 mTraversalRunnable
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mChoreographer</span><span class=o>.</span><span class=na>postCallback</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>Choreographer</span><span class=o>.</span><span class=na>CALLBACK_TRAVERSAL</span><span class=o>,</span> <span class=n>mTraversalRunnable</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=n>TraversalRunnable</span> <span class=n>mTraversalRunnable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TraversalRunnable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=kd>class</span> <span class=nc>TraversalRunnable</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>doTraversal</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>doTraversal</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mTraversalScheduled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mTraversalScheduled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 移除同步障碍
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mHandler</span><span class=o>.</span><span class=na>getLooper</span><span class=o>().</span><span class=na>getQueue</span><span class=o>().</span><span class=na>removeSyncBarrier</span><span class=o>(</span><span class=n>mTraversalBarrier</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 正式进入 View 绘制流程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>performTraversals</span><span class=o>();</span>
</span></span><span class=line><span class=cl>         <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>postCallback 方法跟踪：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@UnsupportedAppUsage</span>
</span></span><span class=line><span class=cl><span class=nd>@TestApi</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>postCallback</span><span class=o>(</span><span class=kt>int</span> <span class=n>callbackType</span><span class=o>,</span> <span class=n>Runnable</span> <span class=n>action</span><span class=o>,</span> <span class=n>Object</span> <span class=n>token</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>postCallbackDelayed</span><span class=o>(</span><span class=n>callbackType</span><span class=o>,</span> <span class=n>action</span><span class=o>,</span> <span class=n>token</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@UnsupportedAppUsage</span>
</span></span><span class=line><span class=cl><span class=nd>@TestApi</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>postCallbackDelayed</span><span class=o>(</span><span class=kt>int</span> <span class=n>callbackType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Runnable</span> <span class=n>action</span><span class=o>,</span> <span class=n>Object</span> <span class=n>token</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delayMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>action</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;action must not be null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>callbackType</span> <span class=o>&lt;</span> <span class=n>0</span> <span class=o>||</span> <span class=n>callbackType</span> <span class=o>&gt;</span> <span class=n>CALLBACK_LAST</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;callbackType is invalid&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>postCallbackDelayedInternal</span><span class=o>(</span><span class=n>callbackType</span><span class=o>,</span> <span class=n>action</span><span class=o>,</span> <span class=n>token</span><span class=o>,</span> <span class=n>delayMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>postCallbackDelayedInternal</span><span class=o>(</span><span class=kt>int</span> <span class=n>callbackType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>action</span><span class=o>,</span> <span class=n>Object</span> <span class=n>token</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delayMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>DEBUG_FRAMES</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;PostCallback: type=&#34;</span> <span class=o>+</span> <span class=n>callbackType</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34;, action=&#34;</span> <span class=o>+</span> <span class=n>action</span> <span class=o>+</span> <span class=s>&#34;, token=&#34;</span> <span class=o>+</span> <span class=n>token</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34;, delayMillis=&#34;</span> <span class=o>+</span> <span class=n>delayMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>mLock</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>long</span> <span class=n>now</span> <span class=o>=</span> <span class=n>SystemClock</span><span class=o>.</span><span class=na>uptimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>long</span> <span class=n>dueTime</span> <span class=o>=</span> <span class=n>now</span> <span class=o>+</span> <span class=n>delayMillis</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mCallbackQueues</span><span class=o>[</span><span class=n>callbackType</span><span class=o>].</span><span class=na>addCallbackLocked</span><span class=o>(</span><span class=n>dueTime</span><span class=o>,</span> <span class=n>action</span><span class=o>,</span> <span class=n>token</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>dueTime</span> <span class=o>&lt;=</span> <span class=n>now</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>scheduleFrameLocked</span><span class=o>(</span><span class=n>now</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Message</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>mHandler</span><span class=o>.</span><span class=na>obtainMessage</span><span class=o>(</span><span class=n>MSG_DO_SCHEDULE_CALLBACK</span><span class=o>,</span> <span class=n>action</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span><span class=o>.</span><span class=na>arg1</span> <span class=o>=</span> <span class=n>callbackType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将消息类型设置为异步
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>msg</span><span class=o>.</span><span class=na>setAsynchronous</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>mHandler</span><span class=o>.</span><span class=na>sendMessageAtTime</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>dueTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，最后通过 setAsynchronous() 方法可以将消息设置成异步消息。</p><p>通过设置同步障碍，并且发送异步消息，就可以确保 mTraversalRunnable 优先被执行，mTraversalRunnable 最终会调用 performTraversals 方法触发 View 树的 measure、layout 和 draw 等操作，因此使用同步屏障可以防止 UI 显示出现卡顿。</p><p>这里也可以看到，调用 performTraversals 方法之前会将同步障碍移除掉。</p><p>综合以上分析可知，同步消息必须配合同步障碍才能达到屏蔽异步消息的作用，也就是说，如果没有设置同步屏障，同步消息与异步消息在 Handler 体系中没有任何区别。</p><a href=#handler-发送和接收消息><h1 id=handler-发送和接收消息><span class=hanchor arialabel=Anchor># </span>Handler 发送和接收消息</h1></a><p>前面的分析中，Looper 在 loop() 方法中获取到每一个 Message 对象后，会调用它的 target 对象的 dispatchMessage() 方法，并把 Message 本身作为参数传入。那么 这个 target 对象又是何方神圣？</p><a href=#发送-message><h2 id=发送-message><span class=hanchor arialabel=Anchor># </span>发送 Message</h2></a><p>再来看 Handler 发送消息的过程：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=na>obtainMessage</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>message</span><span class=o>.</span><span class=na>what</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>message</span><span class=o>.</span><span class=na>obj</span> <span class=o>=</span> <span class=s>&#34;Hello&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>handler</span><span class=o>.</span><span class=na>sendMessage</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这里会将包装好的 Message 对象传入 sendMessage 方法中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>sendMessage</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendMessageDelayed</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>sendMessageDelayed</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delayMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>delayMillis</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>delayMillis</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendMessageAtTime</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>SystemClock</span><span class=o>.</span><span class=na>uptimeMillis</span><span class=o>()</span> <span class=o>+</span> <span class=n>delayMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>sendMessageAtTime</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=kt>long</span> <span class=n>uptimeMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>MessageQueue</span> <span class=n>queue</span> <span class=o>=</span> <span class=n>mQueue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>queue</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>RuntimeException</span> <span class=n>e</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span> <span class=o>+</span> <span class=s>&#34; sendMessageAtTime() called with no mQueue&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=s>&#34;Looper&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>(),</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>enqueueMessage</span><span class=o>(</span><span class=n>queue</span><span class=o>,</span> <span class=n>msg</span><span class=o>,</span> <span class=n>uptimeMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>sendEmptyMessage</span><span class=o>(</span><span class=kt>int</span> <span class=n>what</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendEmptyMessageDelayed</span><span class=o>(</span><span class=n>what</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>sendEmptyMessageDelayed</span><span class=o>(</span><span class=kt>int</span> <span class=n>what</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delayMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Message</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=o>.</span><span class=na>what</span> <span class=o>=</span> <span class=n>what</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendMessageDelayed</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>delayMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>sendEmptyMessageAtTime</span><span class=o>(</span><span class=kt>int</span> <span class=n>what</span><span class=o>,</span> <span class=kt>long</span> <span class=n>uptimeMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Message</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=o>.</span><span class=na>what</span> <span class=o>=</span> <span class=n>what</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendMessageAtTime</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>uptimeMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，无论是发送普通消息还是延时消息，最终都会调用到 enqueueMessage() 方法。它们之间的关系如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Handler/clipboard_20230323_044956.png width=auto alt></p><p>enqueueMessage() 方法源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>enqueueMessage</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>MessageQueue</span> <span class=n>queue</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=kt>long</span> <span class=n>uptimeMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=o>.</span><span class=na>target</span> <span class=o>=</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=o>.</span><span class=na>workSourceUid</span> <span class=o>=</span> <span class=n>ThreadLocalWorkSource</span><span class=o>.</span><span class=na>getUid</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mAsynchronous</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>msg</span><span class=o>.</span><span class=na>setAsynchronous</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>queue</span><span class=o>.</span><span class=na>enqueueMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>uptimeMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，每个消息的 target 都被赋值为 Handler 本身了。这里传进来的 MessageQueue 就是 Handler 中的 mQueue 成员变量，它来自 Looper.mQueue。enqueueMessage() 方法就是将封装好的消息加入到 MessageQueue 中。</p><a href=#接收-message><h2 id=接收-message><span class=hanchor arialabel=Anchor># </span>接收 Message</h2></a><p>回过头来看 Handler 的 dispatchMessage() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>dispatchMessage</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>callback</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>handleCallback</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mCallback</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>mCallback</span><span class=o>.</span><span class=na>handleMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>handleMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里一共有三种不同的途径处理 Message。</p><a href=#msgcallbackrun><h3 id=msgcallbackrun><span class=hanchor arialabel=Anchor># </span>msg.callback.run()</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>callback</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>handleCallback</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>handleCallback</span><span class=o>(</span><span class=n>Message</span> <span class=n>message</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=o>.</span><span class=na>callback</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，会判断 Message 的 callback 是否为空，如果不为空则会调用它的 run 方法。那什么时候这个 callback 会被赋值呢？原来 Handler 还有另外一种打开方式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>post</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>r</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span>  <span class=n>sendMessageDelayed</span><span class=o>(</span><span class=n>getPostMessage</span><span class=o>(</span><span class=n>r</span><span class=o>),</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>postAtTime</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>r</span><span class=o>,</span> <span class=kt>long</span> <span class=n>uptimeMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendMessageAtTime</span><span class=o>(</span><span class=n>getPostMessage</span><span class=o>(</span><span class=n>r</span><span class=o>),</span> <span class=n>uptimeMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>postAtTime</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>r</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>token</span><span class=o>,</span> <span class=kt>long</span> <span class=n>uptimeMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendMessageAtTime</span><span class=o>(</span><span class=n>getPostMessage</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>token</span><span class=o>),</span> <span class=n>uptimeMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>postDelayed</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>r</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delayMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendMessageDelayed</span><span class=o>(</span><span class=n>getPostMessage</span><span class=o>(</span><span class=n>r</span><span class=o>),</span> <span class=n>delayMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>postDelayed</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=o>,</span> <span class=kt>int</span> <span class=n>what</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delayMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendMessageDelayed</span><span class=o>(</span><span class=n>getPostMessage</span><span class=o>(</span><span class=n>r</span><span class=o>).</span><span class=na>setWhat</span><span class=o>(</span><span class=n>what</span><span class=o>),</span> <span class=n>delayMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>postDelayed</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>r</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>token</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delayMillis</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sendMessageDelayed</span><span class=o>(</span><span class=n>getPostMessage</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>token</span><span class=o>),</span> <span class=n>delayMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>Message</span> <span class=nf>getPostMessage</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Message</span> <span class=n>m</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=na>callback</span> <span class=o>=</span> <span class=n>r</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>m</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过传入一个 Runnable 对象，最终也会被封装成一个 Message 对象，而这个 Message 对象的 callback 就是传入的 Runnable。</p><a href=#mcallbackhandlemessagemsg><h3 id=mcallbackhandlemessagemsg><span class=hanchor arialabel=Anchor># </span>mCallback.handleMessage(msg)</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>mCallback</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mCallback</span><span class=o>.</span><span class=na>handleMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 msg.callback == null 的情况下，如果 mCallback != null 则调用 mCallback.handleMessage(msg)。这个 mCallback 对象又是从何而来？答案在 Handler 的创建过程：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>public</span> <span class=nx>Handler</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Looper</span> <span class=nx>looper</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>(</span><span class=nx>looper</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>Handler</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Looper</span> <span class=nx>looper</span><span class=p>,</span> <span class=kd>@Nullable</span> <span class=nx>Callback</span> <span class=nx>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>(</span><span class=nx>looper</span><span class=p>,</span> <span class=nx>callback</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@UnsupportedAppUsage</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>Handler</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Looper</span> <span class=nx>looper</span><span class=p>,</span> <span class=kd>@Nullable</span> <span class=nx>Callback</span> <span class=nx>callback</span><span class=p>,</span> <span class=kr>boolean</span> <span class=kr>async</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mLooper</span> <span class=o>=</span> <span class=nx>looper</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>mQueue</span> <span class=o>=</span> <span class=nx>looper</span><span class=p>.</span><span class=nx>mQueue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>mCallback</span> <span class=o>=</span> <span class=nx>callback</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>mAsynchronous</span> <span class=o>=</span> <span class=kr>async</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=kr>interface</span> <span class=nx>Callback</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * @param msg A {@link android.os.Message Message} object
</span></span></span><span class=line><span class=cl><span class=cm>     * @return True if no further handling is desired
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>boolean</span> <span class=nx>handleMessage</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Message</span> <span class=nx>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>需要注意的是，如果 mCallback.handleMessage(msg) 返回了 true，那么代表消息处理完成，直接返回；如果返回 false，则会继续调用 handleMessage(msg) 方法。</p><a href=#handlemessagemsg><h3 id=handlemessagemsg><span class=hanchor arialabel=Anchor># </span>handleMessage(msg)</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Subclasses must implement this to receive messages.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从注释中可以看出，Handler 的子类必须实现这个方法才能接收 Message，因此这种方式是提供给它的子类接收并处理消息的。</p><a href=#总结><h1 id=总结><span class=hanchor arialabel=Anchor># </span>总结</h1></a><p><strong>Message:</strong> 消息载体，用于携带消息参数、消息目标等。可以通过它的 obtain() 和 recycle() 方法进行复用和回收消息。</p><p><strong>MessageQueue:</strong> 消息队列，用来存放 Handler 发送过来的 Message，按照 when 字段进行优先级排序，其本身是一个以 Message 串联起来的一个单链表。enqueueMessage() 和 next() 方法是生产、消费关系，next() 在队列中没有消息或者消息处理时间未到时会进行阻塞；enqueueMessage() 方法会将消息插入到队列指定位置，并且如果当前消息需要马上处理的时候会唤醒阻塞中的队列。</p><p><strong>Handler:</strong> 调用目标线程的 MessageQueue 的 enqueueMessage() 方法发送消息，并且处理接收到的消息。</p><p><strong>Looper:</strong> 轮询调用 MessageQueue 的 next() 方法获取 Message，并调用目标 Handler 进行处理。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Handler/clipboard_20230323_045002.png width=auto alt></p></article><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>