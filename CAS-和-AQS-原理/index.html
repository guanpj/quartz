<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="CAS 介绍 CAS 英文全称是 Compare-And-Swap，中文叫做“比较并交换”，它是一种思想、一种算法。
在大多数处理器的指令中，都会实现 CAS 相关的指令，这一条指令就可以完成“比较并交换”的操作，也正是由于这是一条（而不是多条）CPU 指令，所以 CAS 相关的指令是具备原子性的，这个组合操作在执行期间不会被打断，这样就能保证并发安全。由于这个原子性是由 CPU 保证的，所以无需我们程序员来操心。
CAS 有三个操作数：内存值 V、预期值 A、要修改的值 B。CAS 最核心的思路就是，仅当预期值 A 和当前的内存值 V 相同时，才将内存值修改为 B。"><meta property="og:title" content="CAS 和 AQS 原理"><meta property="og:description" content="CAS 介绍 CAS 英文全称是 Compare-And-Swap，中文叫做“比较并交换”，它是一种思想、一种算法。
在大多数处理器的指令中，都会实现 CAS 相关的指令，这一条指令就可以完成“比较并交换”的操作，也正是由于这是一条（而不是多条）CPU 指令，所以 CAS 相关的指令是具备原子性的，这个组合操作在执行期间不会被打断，这样就能保证并发安全。由于这个原子性是由 CPU 保证的，所以无需我们程序员来操心。
CAS 有三个操作数：内存值 V、预期值 A、要修改的值 B。CAS 最核心的思路就是，仅当预期值 A 和当前的内存值 V 相同时，才将内存值修改为 B。"><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="CAS 和 AQS 原理"><meta name=twitter:description content="CAS 介绍 CAS 英文全称是 Compare-And-Swap，中文叫做“比较并交换”，它是一种思想、一种算法。
在大多数处理器的指令中，都会实现 CAS 相关的指令，这一条指令就可以完成“比较并交换”的操作，也正是由于这是一条（而不是多条）CPU 指令，所以 CAS 相关的指令是具备原子性的，这个组合操作在执行期间不会被打断，这样就能保证并发安全。由于这个原子性是由 CPU 保证的，所以无需我们程序员来操心。
CAS 有三个操作数：内存值 V、预期值 A、要修改的值 B。CAS 最核心的思路就是，仅当预期值 A 和当前的内存值 V 相同时，才将内存值修改为 B。"><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>CAS 和 AQS 原理</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.592437b1fbffed6c8a18843d158121af.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.54f453a52d274109c96a5315ad13b60a.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.56dfca2238c2ee80cdd3372e8d91150b.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>CAS 和 AQS 原理</h1><p class=meta>Last updated
Mar 23, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/CAS/>Cas</a></li><li><a href=https://www.guanpj.top/tags/AQS/>Aqs</a></li><li><a href=https://www.guanpj.top/tags/%E5%8E%9F%E5%AD%90%E7%B1%BB/>原子类</a></li><li><a href=https://www.guanpj.top/tags/ConcurrentHashMap/>Concurrent hash map</a></li><li><a href=https://www.guanpj.top/tags/%E5%B9%B6%E5%8F%91/>并发</a></li><li><a href=https://www.guanpj.top/tags/%E9%94%81/>锁</a></li><li><a href=https://www.guanpj.top/tags/%E9%9D%A2%E8%AF%95/>面试</a></li><li><a href=https://www.guanpj.top/tags/Java/>Java</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#cas>CAS</a><ol><li><a href=#介绍>介绍</a></li><li><a href=#strong使用及原理strong><strong>使用及原理</strong></a><ol><li><a href=#concurrenthashmap>ConcurrentHashMap</a></li><li><a href=#concurrentlinkedqueue>ConcurrentLinkedQueue</a></li><li><a href=#原子类>原子类</a></li><li><a href=#实现原理>实现原理</a></li></ol></li><li><a href=#cas-造成的三个问题>CAS 造成的三个问题</a><ol><li><a href=#aba-问题>ABA 问题</a></li><li><a href=#自旋时间过长>自旋时间过长</a></li><li><a href=#范围不能灵活控制>范围不能灵活控制</a></li></ol></li></ol></li><li><a href=#aqs>AQS</a><ol><li><a href=#介绍-1>介绍</a></li><li><a href=#使用及原理>使用及原理</a><ol><li><a href=#state>state</a></li><li><a href=#fifo-队列>FIFO 队列</a></li><li><a href=#获取释放方法>获取/释放方法</a><ol><li><a href=#strong获取strong><strong>获取</strong></a></li><li><a href=#strong释放strong><strong>释放</strong></a></li></ol></li><li><a href=#countdownlatch-的实现>CountDownLatch 的实现</a></li></ol></li></ol></li></ol></nav></details></aside><a href=#cas><h1 id=cas><span class=hanchor arialabel=Anchor># </span>CAS</h1></a><a href=#介绍><h2 id=介绍><span class=hanchor arialabel=Anchor># </span>介绍</h2></a><p>CAS 英文全称是 Compare-And-Swap，中文叫做“比较并交换”，它是一种思想、一种算法。</p><p>在大多数处理器的指令中，都会实现 CAS 相关的指令，这一条指令就可以完成“比较并交换”的操作，也正是由于这是一条（而不是多条）CPU 指令，所以 CAS 相关的指令是具备原子性的，这个组合操作在执行期间不会被打断，这样就能保证并发安全。由于这个原子性是由 CPU 保证的，所以无需我们程序员来操心。</p><p>CAS 有三个操作数：内存值 V、预期值 A、要修改的值 B。CAS 最核心的思路就是，<strong>仅当预期值 A 和当前的内存值 V 相同时，才将内存值修改为 B。</strong></p><a href=#strong使用及原理strong><h2 id=strong使用及原理strong><span class=hanchor arialabel=Anchor># </span><strong>使用及原理</strong></h2></a><a href=#concurrenthashmap><h3 id=concurrenthashmap><span class=hanchor arialabel=Anchor># </span>ConcurrentHashMap</h3></a><p>截取 ConcurrentHashMap 部分 putVal 方法的代码，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=n>V</span> <span class=nf>putVal</span><span class=o>(</span><span class=n>K</span> <span class=n>key</span><span class=o>,</span> <span class=n>V</span> <span class=n>value</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>onlyIfAbsent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>key</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>value</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=k>throw</span> <span class=k>new</span>   
</span></span><span class=line><span class=cl>                   <span class=n>NullPointerException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>hash</span> <span class=o>=</span> <span class=n>spread</span><span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>hashCode</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>binCount</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[]</span> <span class=n>tab</span> <span class=o>=</span> <span class=n>table</span><span class=o>;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>f</span><span class=o>;</span> <span class=kt>int</span> <span class=n>n</span><span class=o>,</span> <span class=n>i</span><span class=o>,</span> <span class=n>fh</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>tab</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>(</span><span class=n>n</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>tab</span> <span class=o>=</span> <span class=n>initTable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>f</span> <span class=o>=</span> <span class=n>tabAt</span><span class=o>(</span><span class=n>tab</span><span class=o>,</span> <span class=n>i</span> <span class=o>=</span> <span class=o>(</span><span class=n>n</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>&amp;</span> <span class=n>hash</span><span class=o>))</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>casTabAt</span><span class=o>(</span><span class=n>tab</span><span class=o>,</span> <span class=n>i</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                         <span class=k>new</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;(</span><span class=n>hash</span><span class=o>,</span> <span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=kc>null</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span> <span class=c1>// no lock when adding to empty bin
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=kt>boolean</span> <span class=nf>casTabAt</span><span class=o>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[]</span> <span class=n>tab</span><span class=o>,</span> <span class=kt>int</span> <span class=n>i</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>c</span><span class=o>,</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>v</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>U</span><span class=o>.</span><span class=na>compareAndSwapObject</span><span class=o>(</span><span class=n>tab</span><span class=o>,</span> <span class=o>((</span><span class=kt>long</span><span class=o>)</span><span class=n>i</span> <span class=o>&lt;&lt;</span> <span class=n>ASHIFT</span><span class=o>)</span> <span class=o>+</span> <span class=n>ABASE</span><span class=o>,</span> <span class=n>c</span><span class=o>,</span> <span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>该方法里面只有一行代码，即调用变量 U 的 compareAndSwapObject 的方法，U 是 Unsafe 类型的实例。</p><a href=#concurrentlinkedqueue><h3 id=concurrentlinkedqueue><span class=hanchor arialabel=Anchor># </span>ConcurrentLinkedQueue</h3></a><p>接下来看并发容器的第二个案例。非阻塞并发队列 ConcurrentLinkedQueue 的 offer 方法里也有 CAS 的身影，offer 方法的代码如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>offer</span><span class=o>(</span><span class=n>E</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>checkNotNull</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span> <span class=n>newNode</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span> <span class=n>t</span> <span class=o>=</span> <span class=n>tail</span><span class=o>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>t</span><span class=o>;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span> <span class=n>q</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>q</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>p</span><span class=o>.</span><span class=na>casNext</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>newNode</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>p</span> <span class=o>!=</span> <span class=n>t</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>                    <span class=n>casTail</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>newNode</span><span class=o>);</span> 
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>p</span> <span class=o>==</span> <span class=n>q</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=o>(</span><span class=n>t</span> <span class=o>!=</span> <span class=o>(</span><span class=n>t</span> <span class=o>=</span> <span class=n>tail</span><span class=o>))</span> <span class=o>?</span> <span class=n>t</span> <span class=o>:</span> <span class=n>head</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=o>(</span><span class=n>p</span> <span class=o>!=</span> <span class=n>t</span> <span class=o>&amp;&amp;</span> <span class=n>t</span> <span class=o>!=</span> <span class=o>(</span><span class=n>t</span> <span class=o>=</span> <span class=n>tail</span><span class=o>))</span> <span class=o>?</span> <span class=n>t</span> <span class=o>:</span> <span class=n>q</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>casNext</span><span class=o>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span> <span class=n>cmp</span><span class=o>,</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span> <span class=n>val</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>UNSAFE</span><span class=o>.</span><span class=na>compareAndSwapObject</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>nextOffset</span><span class=o>,</span> <span class=n>cmp</span><span class=o>,</span> <span class=n>val</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，在 offer 方法中，有一个 for 循环，这是一个死循环，在第 8 行有一个与 CAS 相关的方法，是 casNext 方法，用于更新节点。那么如果执行 p 的 casNext 方法失败的话，casNext 会返回 false，那么显然代码会继续在 for 循环中进行下一次的尝试。而 casNext 方法中也用到了 UnSafe 类。</p><a href=#原子类><h3 id=原子类><span class=hanchor arialabel=Anchor># </span>原子类</h3></a><p>在编程领域里，原子性意味着“一组操作要么全都操作成功，要么全都失败，不能只操作成功其中的一部分”。而 java.util.concurrent.atomic 下的类，就是具有原子性的类，可以原子性地执行添加、递增、递减等操作。</p><p>原子类的作用和锁有类似之处，是为了保证并发情况下线程安全。不过原子类相比于锁，有一定的优势：</p><ul><li>粒度更细：原子变量可以把竞争范围缩小到变量级别，通常情况下，锁的粒度都要大于原子变量的粒度。</li><li>效率更高：除了高度竞争的情况之外，使用原子类的效率通常会比使用同步互斥锁的效率更高，因为原子类底层利用了 CAS 操作，不会阻塞线程。</li></ul><p>原子类一共可以分为以下这 6 类：</p><table><thead><tr><th>类型</th><th>具体类</th></tr></thead><tbody><tr><td>Atomic* 基本类型原子类</td><td>AtomicInteger、AtomicLong、AtomicBoolean</td></tr><tr><td>Atomic*Array 数组类型原子类</td><td>AtomicIntegerArray、AtomicLongArray、AtomicReferenceArray</td></tr><tr><td>Atomic*Reference 引用类型原子类</td><td>AtomicReference、AtomicStampedReference、AtomicMarkableReference</td></tr><tr><td>Atomic*FieldUpdater 升级类型原子类</td><td>AtomicIntegerfieldupdater、AtomicLongFieldUpdater、AtomicReferenceFieldUpdater</td></tr><tr><td>Adder 累加器</td><td>LongAdder、DoubleAdder</td></tr><tr><td>Accumulator 积累器</td><td>LongAccumulator、DoubleAccumulator</td></tr></tbody></table><p>下面以 AtomicInteger 为例，分析在 Java 中如何利用 CAS 实现原子操作。</p><p>getAndAdd 方法是 AtomicInteger 类的重要方法，这个方法的代码在 Java 1.8 中的实现如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>getAndAdd</span><span class=o>(</span><span class=kt>int</span> <span class=n>delta</span><span class=o>)</span> <span class=o>{</span>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>unsafe</span><span class=o>.</span><span class=na>getAndAddInt</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>valueOffset</span><span class=o>,</span> <span class=n>delta</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，里面再次用到了 Unsafe 这个类，并且调用了 unsafe.getAndAddInt 方法。</p><a href=#实现原理><h3 id=实现原理><span class=hanchor arialabel=Anchor># </span>实现原理</h3></a><p>从以上示例可以看出，Unsafe 其实是 CAS 的核心类，并且其核心方法都是由 native 层面来实现的。由于 Java 无法直接访问底层操作系统，而是需要通过 native 方法来实现。不过尽管如此，JVM 还是留了一个后门，Unsafe 类提供了硬件级别的原子操作，可以利用它直接操作内存数据。</p><p>看一下 AtomicInteger 的一些重要代码，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AtomicInteger</span> <span class=kd>extends</span> <span class=n>Number</span> 
</span></span><span class=line><span class=cl>           <span class=kd>implements</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// setup to use Unsafe.compareAndSwapInt for updates
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Unsafe</span> <span class=n>unsafe</span> <span class=o>=</span> <span class=n>Unsafe</span><span class=o>.</span><span class=na>getUnsafe</span><span class=o>();</span>
</span></span><span class=line><span class=cl>   <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>valueOffset</span><span class=o>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>   <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>           <span class=n>valueOffset</span> <span class=o>=</span> <span class=n>unsafe</span><span class=o>.</span><span class=na>objectFieldOffset</span>
</span></span><span class=line><span class=cl>               <span class=o>(</span><span class=n>AtomicInteger</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=s>&#34;value&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>       <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>Error</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>   <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>int</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>   <span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>get</span><span class=o>()</span> <span class=o>{</span><span class=k>return</span> <span class=n>value</span><span class=o>;}</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，在数据定义的部分，首先获取了 Unsafe 实例，并且定义了 valueOffset。接下来 static 代码块会在类加载的时候执行，执行时会调用 Unsafe 的 objectFieldOffset 方法，从而得到当前这个原子类的 value 的偏移量，并且赋给 valueOffset 变量，这样就获取到了 value 的偏移量，它的含义是在内存中的偏移地址，因为 Unsafe 就是根据内存偏移地址获取数据的原值的，这样就能通过 Unsafe 来实现 CAS 了。</p><p>value 是用 volatile 修饰的，它就是原子类存储的值的变量，由于它被 volatile 修饰，可以保证在多线程之间看到的 value 是同一份，保证了可见性。</p><p>接下来继续看 Unsafe 的 getAndAddInt 方法的实现，代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>getAndAddInt</span><span class=o>(</span><span class=n>Object</span> <span class=n>var1</span><span class=o>,</span> <span class=kt>long</span> <span class=n>var2</span><span class=o>,</span> <span class=kt>int</span> <span class=n>var4</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=kt>int</span> <span class=n>var5</span><span class=o>;</span>
</span></span><span class=line><span class=cl>   <span class=k>do</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=n>var5</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>getIntVolatile</span><span class=o>(</span><span class=n>var1</span><span class=o>,</span> <span class=n>var2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span> <span class=k>while</span><span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>compareAndSwapInt</span><span class=o>(</span><span class=n>var1</span><span class=o>,</span> <span class=n>var2</span><span class=o>,</span> <span class=n>var5</span><span class=o>,</span> <span class=n>var5</span> <span class=o>+</span> <span class=n>var4</span><span class=o>));</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>var5</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，它是一个 do-while 循环，所以这是一个死循环，直到满足循环的退出条件时才可以退出。</p><p>接下来看 do 后面的这一行代码 var5 = this.getIntVolatile(var1, var2) ，这是个 native 方法，作用就是获取在 var1 中的 var2 偏移处的值。</p><p>传入的两个参数，第一个就是当前原子类，第二个就是最开始获取到的 offset，这样一来我们就可以获取到当前内存中偏移量的值，并且保存到 var5 里面。此时 var5 实际上代表当前时刻下的原子类的数值。</p><p>现在再来看 while 的退出条件，也就是 compareAndSwapInt 这个方法，它一共传入了 4 个参数，这 4 个参数是 var1、var2、var5、var5 + var4，为了方便理解，我们给它们取了新了变量名，分别 object、offset、expectedValue、newValue，具体含义如下：</p><ul><li>第一个参数 object 就是将要操作的对象，传入的是 this，也就是 atomicInteger 这个对象本身；</li><li>第二个参数是 offset，也就是偏移量，借助它就可以获取到 value 的数值；</li><li>第三个参数 expectedValue，代表“期望值”，传入的是刚才获取到的 var5；</li><li>而最后一个参数 newValue 是希望修改的数值 ，等于之前取到的数值 var5 再加上 var4，而 var4 就是我们之前所传入的 delta，delta 就是我们希望原子类所改变的数值，比如可以传入 +1，也可以传入 -1。</li></ul><p>所以 compareAndSwapInt 方法的作用就是，判断如果现在原子类里 value 的值和之前获取到的 var5 相等的话，那么就把计算出来的 var5 + var4 给更新上去，所以说这行代码就实现了 CAS 的过程。</p><p>一旦 CAS 操作成功，就会退出这个 while 循环，但是也有可能操作失败。如果操作失败就意味着在获取到 var5 之后，并且在 CAS 操作之前，value 的数值已经发生变化了，证明有其他线程修改过这个变量。</p><p>这样一来，就会再次执行循环体里面的代码，重新获取 var5 的值，也就是获取最新的原子变量的数值，并且再次利用 CAS 去尝试更新，直到更新成功为止，所以这是一个死循环。</p><p>总结一下，Unsafe 的 getAndAddInt 方法是通过循环 + CAS 的方式来实现的，在此过程中，它会通过 compareAndSwapInt 方法来尝试更新 value 的值，如果更新失败就重新获取，然后再次尝试更新，直到更新成功。</p><a href=#cas-造成的三个问题><h2 id=cas-造成的三个问题><span class=hanchor arialabel=Anchor># </span>CAS 造成的三个问题</h2></a><a href=#aba-问题><h3 id=aba-问题><span class=hanchor arialabel=Anchor># </span>ABA 问题</h3></a><p>决定 CAS 是否进行 swap 的判断标准是“当前的值和预期的值是否一致”，如果一致，就认为在此期间这个数值没有发生过变动，这在大多数情况下是没有问题的。</p><p>但是在有的业务场景下，我们想确切知道从上一次看到这个值以来到现在，这个值是否发生过变化。例如，这个值假设从 A 变成了 B，再由 B 变回了 A，此时，它不仅可以认为发生了变化，而且变化了两次。</p><p>解决 ABA 问题，可以在在变量值自身之外，再添加一个版本号，通过对比版本号来判断值是否变化过。</p><a href=#自旋时间过长><h3 id=自旋时间过长><span class=hanchor arialabel=Anchor># </span>自旋时间过长</h3></a><p>由于单次 CAS 不一定能执行成功，所以 CAS 往往是配合着循环来实现的。在高并发场景下有的时候甚至是死循环，不停地进行重试，直到线程竞争不激烈的时候，才能修改成功。</p><p>因此要根据实际情况来选择是否使用 CAS，在高并发的场景下，通常 CAS 的效率是不高的。</p><a href=#范围不能灵活控制><h3 id=范围不能灵活控制><span class=hanchor arialabel=Anchor># </span>范围不能灵活控制</h3></a><p>通常执行 CAS 的时候，是针对某一个而不是多个共享变量的，这个变量可能是 Integer 类型，也有可能是 Long 类型、对象类型等，但是不能针对多个共享变量同时进行 CAS 操作，因为这多个变量之间是独立的，简单的把原子操作组合到一起，并不具备原子性。因此如果想对多个对象同时进行 CAS 操作并想保证线程安全的话，是比较困难的。</p><p>有一个解决方案，那就是利用一个新的类，来整合刚才这一组共享变量，这个新的类中的多个成员变量就是刚才的那多个共享变量，然后再利用 atomic 包中的 AtomicReference 来把这个新对象整体进行 CAS 操作，这样就可以保证线程安全。</p><p>相比之下，如果使用 synchronized 关键字则会比较方便。</p><a href=#aqs><h1 id=aqs><span class=hanchor arialabel=Anchor># </span>AQS</h1></a><a href=#介绍-1><h2 id=介绍-1><span class=hanchor arialabel=Anchor># </span>介绍</h2></a><p>队列同步器 AbstractQueuedSynchronizer，是用来构建锁或者其他同步组件的基础框架，它使用了一个 int 类型的 state 变量表示同步状态，通过内置的 FIFO 队列来完成资源获取线程的排队工作。AQS 定义了一套多线程访问共享资源的同步器框架，许多同步类实现都依赖于它，如常用的 ReentrantLock、Semaphore、CountDownLatch 和 CyclicBarrior 等。</p><p>同步器是实现锁（也可以是任意同步组件）的关键，在锁的实现中聚合同步器。可以这样理解二者之间的关系：</p><p>锁是面向使用者的，它定义了使用者与锁交互的接口（比如可以允许两个线程并行访问），隐藏了实现细节；</p><p>同步器面向的是锁的实现者，它简化了锁的实现方式，屏蔽了同步状态管理、线程的排队、等待与唤醒等底层操作。锁和同步器很好地隔离了使用者和实现者所需关注的领域。</p><p>实现者需要继承同步器并重写指定的方法，随后将同步器组合在自定义同步组件的实现中，并调用同步器提供的模板方法，而这些模板方法将会调用使用者重写的方法。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/CAS-AQS/clipboard_20230323_101329.png width=auto alt></p><a href=#使用及原理><h2 id=使用及原理><span class=hanchor arialabel=Anchor># </span>使用及原理</h2></a><p>如果想使用 AQS 来写一个自己的线程协作工具类，通常而言是分为以下三步，这也是 JDK 里利用 AQS 类的主要步骤：</p><ol><li>新建一个自己的线程协作工具类，在内部写一个 Sync 类，该 Sync 类继承 AbstractQueuedSynchronizer，即 AQS；</li><li>想好设计的线程协作工具类的协作逻辑，在 Sync 类里，根据是否是独占，来重写对应的方法。如果是独占，则重写 tryAcquire 和 tryRelease 等方法；如果是非独占，则重写 tryAcquireShared 和 tryReleaseShared 等方法；
<img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/CAS-AQS/clipboard_20230323_101333.png width=auto alt></li><li>在自己的线程协作工具类中，实现获取/释放的相关方法，并在里面调用 AQS 对应的方法，如果是独占则调用 acquire 或 release 等方法，非独占则调用 acquireShared 或 releaseShared 或 acquireSharedInterruptibly 等方法。</li></ol><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/CAS-AQS/clipboard_20230323_101337.png width=auto alt></p><p>AQS 最核心的三大部分就是状态（state）、FIFO 等待队列和期望协作工具类去实现的获取）/释放等重要方法。</p><a href=#state><h3 id=state><span class=hanchor arialabel=Anchor># </span>state</h3></a><p>state 的含义并不是一成不变的，它会根据具体实现类的作用不同而表示不同的含义。比如说在 Semaphore 中，state 表示的是剩余许可证的数量；在 CountDownLatch 工具类里面，state 表示的是需要“倒数”的数量。他的定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * The synchronization state.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>int</span> <span class=n>state</span><span class=o>;</span>
</span></span></code></pre></td></tr></table></div></div><p>state 的访问方式有三种：</p><ul><li>getState()：获取当前同步状态。</li><li>setState(int newState)：设置当前同步状态，volatile 保证了它的多线程状态下的可见性。</li><li>compareAndSetState(int expect, int update)：使用 CAS 设置当前状态，保证状态设置的原子性。</li></ul><a href=#fifo-队列><h3 id=fifo-队列><span class=hanchor arialabel=Anchor># </span>FIFO 队列</h3></a><p>即先进先出队列，这个队列最主要的作用是存储等待的线程。假设很多线程都想要同时抢锁，那么大部分的线程是抢不到的，那怎么去处理这些抢不到锁的线程呢？就得需要有一个队列来存放、管理它们。所以 AQS 的一大功能就是充当线程的“排队管理器”。</p><p>当多个线程去竞争同一把锁的时候，就需要用排队机制把那些没能拿到锁的线程串在一起；而当前面的线程释放锁之后，这个管理器就会挑选一个合适的线程来尝试抢刚刚释放的那把锁。所以 AQS 就一直在维护这个队列，并把等待的线程都放到队列里面。</p><p>在队列中，分别用 head 和 tail 来表示头节点和尾节点，两者在初始化的时候都指向了一个空节点。头节点可以理解为“当前持有锁的线程”，而在头节点之后的线程就被阻塞了，它们会等待唤醒，唤醒也是由 AQS 负责操作的。</p><a href=#获取释放方法><h3 id=获取释放方法><span class=hanchor arialabel=Anchor># </span>获取/释放方法</h3></a><a href=#strong获取strong><h4 id=strong获取strong><span class=hanchor arialabel=Anchor># </span><strong>获取</strong></h4></a><p>获取操作通常会依赖 state 变量的值，根据 state 值不同，协作工具类也会有不同的逻辑，并且在获取的时候也经常会阻塞。</p><p>比如 ReentrantLock 中的 lock 方法就是其中一个“获取方法”，执行时，如果发现 state 不等于 0 且当前线程不是持有锁的线程，那么就代表这个锁已经被其他线程所持有了。这个时候，当然就获取不到锁，于是就让该线程进入阻塞状态。</p><p>再比如，Semaphore 中的 acquire 方法就是其中一个“获取方法”，作用是获取许可证，此时能不能获取到这个许可证也取决于 state 的值。如果 state 值是正数，那么代表还有剩余的许可证，数量足够的话，就可以成功获取；但如果 state 是 0，则代表已经没有更多的空余许可证了，此时这个线程就获取不到许可证，会进入阻塞状态，所以这里同样也是和 state 的值相关的。</p><p>再举个例子，CountDownLatch 获取方法就是 await 方法（包含重载方法），作用是“等待，直到倒数结束”。执行 await 的时候会判断 state 的值，如果 state 不等于 0，线程就陷入阻塞状态，直到其他线程执行倒数方法把 state 减为 0，此时就代表现在这个门闩放开了，所以之前阻塞的线程就会被唤醒。</p><a href=#strong释放strong><h4 id=strong释放strong><span class=hanchor arialabel=Anchor># </span><strong>释放</strong></h4></a><p>释放方法是站在获取方法的对立面的，通常和刚才的获取方法配合使用。我们刚才讲的获取方法可能会让线程阻塞，比如说获取不到锁就会让线程进入阻塞状态，但是释放方法通常是不会阻塞线程的。</p><p>比如在 Semaphore 信号量里面，释放就是 release 方法（包含重载方法），release() 方法的作用是去释放一个许可证，会让 state 加 1；而在 CountDownLatch 里面，释放就是 countDown 方法，作用是倒数一个数，让 state 减 1。所以也可以看出，在不同的实现类里面，他们对于 state 的操作是截然不同的，需要由每一个协作类根据自己的逻辑去具体实现。</p><a href=#countdownlatch-的实现><h3 id=countdownlatch-的实现><span class=hanchor arialabel=Anchor># </span>CountDownLatch 的实现</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CountDownLatch</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CountDownLatch</span><span class=o>(</span><span class=kt>int</span> <span class=n>count</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>count</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;count &lt; 0&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>sync</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Sync</span><span class=o>(</span><span class=n>count</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>countDown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//AQS 类中的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sync</span><span class=o>.</span><span class=na>releaseShared</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>await</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//AQS 类中的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sync</span><span class=o>.</span><span class=na>acquireSharedInterruptibly</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Sync</span> <span class=n>sync</span><span class=o>;</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Sync</span> 
</span></span><span class=line><span class=cl>              <span class=kd>extends</span> <span class=n>AbstractQueuedSynchronizer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Sync</span><span class=o>(</span><span class=kt>int</span> <span class=n>count</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>setState</span><span class=o>(</span><span class=n>count</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=nf>getCount</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>getState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>tryAcquireShared</span><span class=o>(</span><span class=kt>int</span> <span class=n>acquires</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>(</span><span class=n>getState</span><span class=o>()</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>?</span> <span class=n>1</span> <span class=o>:</span> <span class=o>-</span><span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>tryReleaseShared</span><span class=o>(</span><span class=kt>int</span> <span class=n>releases</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=n>getState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>c</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>nextc</span> <span class=o>=</span> <span class=n>c</span><span class=o>-</span><span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>compareAndSetState</span><span class=o>(</span><span class=n>c</span><span class=o>,</span> <span class=n>nextc</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>nextc</span> <span class=o>==</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>acquireSharedInterruptibly</span><span class=o>(</span><span class=kt>int</span> <span class=n>arg</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>              <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>           <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>interrupted</span><span class=o>())</span>
</span></span><span class=line><span class=cl>               <span class=k>throw</span> <span class=k>new</span> <span class=n>InterruptedException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>           <span class=k>if</span> <span class=o>(</span><span class=n>tryAcquireShared</span><span class=o>(</span><span class=n>arg</span><span class=o>)</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl>               <span class=n>doAcquireSharedInterruptibly</span><span class=o>(</span><span class=n>arg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>       <span class=o>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>tryAcquireShared</span><span class=o>(</span><span class=kt>int</span> <span class=n>acquires</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>(</span><span class=n>getState</span><span class=o>()</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>?</span> <span class=n>1</span> <span class=o>:</span> <span class=o>-</span><span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></article><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>