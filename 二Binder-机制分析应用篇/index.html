<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="AIDL æ˜¯ Android Interface Definition Languageï¼ˆAndroid æ¥å£å®šä¹‰è¯­è¨€ï¼‰çš„ç¼©å†™ï¼Œå®ƒæ˜¯ Android è¿›ç¨‹é—´é€šä¿¡çš„æ¥å£è¯­è¨€ã€‚ç”±äº Android ç³»ç»Ÿçš„ Linux å†…æ ¸é‡‡ç”¨äº†è¿›ç¨‹éš”ç¦»æœºåˆ¶ï¼Œä½¿å¾—ä¸åŒçš„åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹å½“ä¸­ï¼Œæœ‰æ—¶å€™ä¸¤ä¸ªåº”ç”¨ä¹‹é—´éœ€è¦ä¼ é€’æˆ–è€…å…±äº«æŸäº›æ•°æ®ï¼Œå°±éœ€è¦è¿›è¡Œè¿›ç¨‹é—´çš„é€šä¿¡è®¯ã€‚
åœ¨ä¸Šä¸€ç¯‡æ–‡ç« â€”â€”[[ä¸€ã€Binder æœºåˆ¶åˆ†æâ€”â€”æ¦‚å¿µç¯‡]]ä¸­æˆ‘ä»¬å·²ç»åˆ†æäº†ä½¿ç”¨ Binder æœºåˆ¶çš„åŸå› ä»¥åŠåˆ†æäº† Binder æœºåˆ¶ï¼Œè€Œ AIDL ä¹Ÿæ­£æ˜¯è¿ç”¨äº† Binder æœºåˆ¶æ¥å®ç°è¿›ç¨‹é—´çš„é€šè®¯ï¼Œæœ¬ç« æˆ‘ä»¬å°†ç»§ç»­ä» AIDL çš„ä½¿ç”¨è¿‡ç¨‹ä½“éªŒ Binder åœ¨åº”ç”¨å±‚çš„ä½¿ç”¨å’ŒåŸç†ã€‚"><meta property="og:title" content="äºŒã€Binder æœºåˆ¶åˆ†æâ€”â€”åº”ç”¨ç¯‡"><meta property="og:description" content="AIDL æ˜¯ Android Interface Definition Languageï¼ˆAndroid æ¥å£å®šä¹‰è¯­è¨€ï¼‰çš„ç¼©å†™ï¼Œå®ƒæ˜¯ Android è¿›ç¨‹é—´é€šä¿¡çš„æ¥å£è¯­è¨€ã€‚ç”±äº Android ç³»ç»Ÿçš„ Linux å†…æ ¸é‡‡ç”¨äº†è¿›ç¨‹éš”ç¦»æœºåˆ¶ï¼Œä½¿å¾—ä¸åŒçš„åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹å½“ä¸­ï¼Œæœ‰æ—¶å€™ä¸¤ä¸ªåº”ç”¨ä¹‹é—´éœ€è¦ä¼ é€’æˆ–è€…å…±äº«æŸäº›æ•°æ®ï¼Œå°±éœ€è¦è¿›è¡Œè¿›ç¨‹é—´çš„é€šä¿¡è®¯ã€‚
åœ¨ä¸Šä¸€ç¯‡æ–‡ç« â€”â€”[[ä¸€ã€Binder æœºåˆ¶åˆ†æâ€”â€”æ¦‚å¿µç¯‡]]ä¸­æˆ‘ä»¬å·²ç»åˆ†æäº†ä½¿ç”¨ Binder æœºåˆ¶çš„åŸå› ä»¥åŠåˆ†æäº† Binder æœºåˆ¶ï¼Œè€Œ AIDL ä¹Ÿæ­£æ˜¯è¿ç”¨äº† Binder æœºåˆ¶æ¥å®ç°è¿›ç¨‹é—´çš„é€šè®¯ï¼Œæœ¬ç« æˆ‘ä»¬å°†ç»§ç»­ä» AIDL çš„ä½¿ç”¨è¿‡ç¨‹ä½“éªŒ Binder åœ¨åº”ç”¨å±‚çš„ä½¿ç”¨å’ŒåŸç†ã€‚"><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="äºŒã€Binder æœºåˆ¶åˆ†æâ€”â€”åº”ç”¨ç¯‡"><meta name=twitter:description content="AIDL æ˜¯ Android Interface Definition Languageï¼ˆAndroid æ¥å£å®šä¹‰è¯­è¨€ï¼‰çš„ç¼©å†™ï¼Œå®ƒæ˜¯ Android è¿›ç¨‹é—´é€šä¿¡çš„æ¥å£è¯­è¨€ã€‚ç”±äº Android ç³»ç»Ÿçš„ Linux å†…æ ¸é‡‡ç”¨äº†è¿›ç¨‹éš”ç¦»æœºåˆ¶ï¼Œä½¿å¾—ä¸åŒçš„åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹å½“ä¸­ï¼Œæœ‰æ—¶å€™ä¸¤ä¸ªåº”ç”¨ä¹‹é—´éœ€è¦ä¼ é€’æˆ–è€…å…±äº«æŸäº›æ•°æ®ï¼Œå°±éœ€è¦è¿›è¡Œè¿›ç¨‹é—´çš„é€šä¿¡è®¯ã€‚
åœ¨ä¸Šä¸€ç¯‡æ–‡ç« â€”â€”[[ä¸€ã€Binder æœºåˆ¶åˆ†æâ€”â€”æ¦‚å¿µç¯‡]]ä¸­æˆ‘ä»¬å·²ç»åˆ†æäº†ä½¿ç”¨ Binder æœºåˆ¶çš„åŸå› ä»¥åŠåˆ†æäº† Binder æœºåˆ¶ï¼Œè€Œ AIDL ä¹Ÿæ­£æ˜¯è¿ç”¨äº† Binder æœºåˆ¶æ¥å®ç°è¿›ç¨‹é—´çš„é€šè®¯ï¼Œæœ¬ç« æˆ‘ä»¬å°†ç»§ç»­ä» AIDL çš„ä½¿ç”¨è¿‡ç¨‹ä½“éªŒ Binder åœ¨åº”ç”¨å±‚çš„ä½¿ç”¨å’ŒåŸç†ã€‚"><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>äºŒã€Binder æœºåˆ¶åˆ†æâ€”â€”åº”ç”¨ç¯‡</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.592437b1fbffed6c8a18843d158121af.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.54f453a52d274109c96a5315ad13b60a.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.56dfca2238c2ee80cdd3372e8d91150b.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>äºŒã€Binder æœºåˆ¶åˆ†æâ€”â€”åº”ç”¨ç¯‡</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/Binder/>Binder</a></li><li><a href=https://www.guanpj.top/tags/IPC/>IP c</a></li><li><a href=https://www.guanpj.top/tags/ServiceManager/>Service manager</a></li><li><a href=https://www.guanpj.top/tags/AIDL/>Aidl</a></li><li><a href=https://www.guanpj.top/tags/Framework/>Framework</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#aidl-ä½¿ç”¨æ­¥éª¤>AIDL ä½¿ç”¨æ­¥éª¤</a><ol><li><a href=#1åˆ›å»º-aidl-æ¥å£æ–‡ä»¶>1ã€åˆ›å»º .aidl æ¥å£æ–‡ä»¶</a></li><li><a href=#2åˆ›å»º-service>2ã€åˆ›å»º Service</a></li><li><a href=#3ç»‘å®š-service>3ã€ç»‘å®š Service</a></li><li><a href=#4client-ç«¯ä¸-server-ç«¯äº¤äº’>4ã€Client ç«¯ä¸ Server ç«¯äº¤äº’</a></li><li><a href=#5ç»“æœå±•ç¤º>5ã€ç»“æœå±•ç¤º</a></li></ol></li><li><a href=#aidl-é€šè®¯è¿‡ç¨‹åˆ†æ>AIDL é€šè®¯è¿‡ç¨‹åˆ†æ</a><ol><li><a href=#å…³é”®ç±»èŒè´£æè¿°>å…³é”®ç±»èŒè´£æè¿°</a></li><li><a href=#é€šè®¯è¿‡ç¨‹åˆ†æ>é€šè®¯è¿‡ç¨‹åˆ†æ</a></li></ol></li><li><a href=#binder-åœ¨-framework-å±‚çš„åº”ç”¨>Binder åœ¨ Framework å±‚çš„åº”ç”¨</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></nav></details></aside><p>AIDL æ˜¯ Android Interface Definition Languageï¼ˆAndroid æ¥å£å®šä¹‰è¯­è¨€ï¼‰çš„ç¼©å†™ï¼Œå®ƒæ˜¯ Android è¿›ç¨‹é—´é€šä¿¡çš„æ¥å£è¯­è¨€ã€‚ç”±äº Android ç³»ç»Ÿçš„ Linux å†…æ ¸é‡‡ç”¨äº†è¿›ç¨‹éš”ç¦»æœºåˆ¶ï¼Œä½¿å¾—ä¸åŒçš„åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹å½“ä¸­ï¼Œæœ‰æ—¶å€™ä¸¤ä¸ªåº”ç”¨ä¹‹é—´éœ€è¦ä¼ é€’æˆ–è€…å…±äº«æŸäº›æ•°æ®ï¼Œå°±éœ€è¦è¿›è¡Œè¿›ç¨‹é—´çš„é€šä¿¡è®¯ã€‚</p><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« â€”â€”<a href=/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87 rel=noopener class=internal-link data-src=/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87>ä¸€ã€Binder æœºåˆ¶åˆ†æâ€”â€”æ¦‚å¿µç¯‡</a>ä¸­æˆ‘ä»¬å·²ç»åˆ†æäº†ä½¿ç”¨ Binder æœºåˆ¶çš„åŸå› ä»¥åŠåˆ†æäº† Binder æœºåˆ¶ï¼Œè€Œ AIDL ä¹Ÿæ­£æ˜¯è¿ç”¨äº† Binder æœºåˆ¶æ¥å®ç°è¿›ç¨‹é—´çš„é€šè®¯ï¼Œæœ¬ç« æˆ‘ä»¬å°†ç»§ç»­ä» AIDL çš„ä½¿ç”¨è¿‡ç¨‹ä½“éªŒ Binder åœ¨åº”ç”¨å±‚çš„ä½¿ç”¨å’ŒåŸç†ã€‚</p><a href=#aidl-ä½¿ç”¨æ­¥éª¤><h1 id=aidl-ä½¿ç”¨æ­¥éª¤><span class=hanchor arialabel=Anchor># </span>AIDL ä½¿ç”¨æ­¥éª¤</h1></a><a href=#1åˆ›å»º-aidl-æ¥å£æ–‡ä»¶><h2 id=1åˆ›å»º-aidl-æ¥å£æ–‡ä»¶><span class=hanchor arialabel=Anchor># </span>1ã€åˆ›å»º .aidl æ¥å£æ–‡ä»¶</h2></a><p>é¦–å…ˆåœ¨ aidl æ–‡ä»¶å¤¹è¿™ç§æ–°å»ºæ–‡ä»¶å¹¶ä¸”å‘½åä¸º IMyService.aidl<em>ï¼Œ</em>å¹¶ä¸”æŒ‰ç…§ä»¥ä¸‹æ ¼å¼æ·»åŠ æ–¹æ³•ã€‚æ­¤ä¸¾æ˜¯ä¸ºäº†å£°æ˜ä½œä¸º Server ç«¯çš„è¿œç¨‹ Service å…·æœ‰å“ªäº›èƒ½åŠ›ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.me.guanpj.binder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>com.me.guanpj.binder.User</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=c1>// Declare any non-default types here with import statements
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>IMyService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>addUser</span><span class=o>(</span><span class=n>in</span> <span class=n>User</span> <span class=n>user</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=nf>getUserList</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯¹äºå¯¹è±¡å¼•ç”¨ï¼Œè¿˜éœ€è¦å¼•å…¥å®ä½“ç±» User.aidl<em>ï¼š</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// User.aidl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nn>com.me.guanpj.binder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Declare any non-default types here with import statements
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>parcelable</span> <span class=n>User</span><span class=o>;</span>
</span></span></code></pre></td></tr></table></div></div><p>è·¨è¿›ç¨‹ä¼ è¾“çš„ User å®ä½“å¿…é¡»å®ç° Parcelable æ¥å£ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>User</span> <span class=kd>implements</span> <span class=n>Parcelable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>User</span><span class=o>()</span> <span class=o>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>User</span><span class=o>(</span><span class=kt>int</span> <span class=n>id</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=nf>User</span><span class=o>(</span><span class=n>Parcel</span> <span class=n>in</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>writeToParcel</span><span class=o>(</span><span class=n>Parcel</span> <span class=n>dest</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>id</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>.</span><span class=na>writeString</span><span class=o>(</span><span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>describeContents</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Creator</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>CREATOR</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Creator</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>User</span> <span class=nf>createFromParcel</span><span class=o>(</span><span class=n>Parcel</span> <span class=n>in</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>User</span><span class=o>(</span><span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>User</span><span class=o>[]</span> <span class=nf>newArray</span><span class=o>(</span><span class=kt>int</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>User</span><span class=o>[</span><span class=n>size</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>};</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨åˆ›å»º IMyService.aidl æ–‡ä»¶å¹¶ä¸” ReBuild é¡¹ç›®ä¹‹åï¼ŒIDE ä¼šè‡ªåŠ¨åœ¨ build ç›®å½•ç”Ÿæˆä¸€ä¸ªä¸ IMyService.java æ¥å£ç±»ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.me.guanpj.binder</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=c1>// Declare any non-default types here with import statements
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>IMyService</span> <span class=kd>extends</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IInterface</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** Local-side IPC implementation stub class. */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Stub</span> <span class=kd>extends</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Binder</span> <span class=kd>implements</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>IMyService</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>DESCRIPTOR</span> <span class=o>=</span> <span class=s>&#34;com.me.guanpj.binder.IMyService&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=cm>/** Construct the stub at attach it to the interface. */</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=nf>Stub</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>attachInterface</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * Cast an IBinder object into an com.me.guanpj.binder.IMyService interface,
</span></span></span><span class=line><span class=cl><span class=cm>         * generating a proxy if needed.
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>IMyService</span> <span class=nf>asInterface</span><span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>obj</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span><span class=n>obj</span><span class=o>==</span><span class=kc>null</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IInterface</span> <span class=n>iin</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=na>queryLocalInterface</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(((</span><span class=n>iin</span><span class=o>!=</span><span class=kc>null</span><span class=o>)&amp;&amp;(</span><span class=n>iin</span> <span class=k>instanceof</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>IMyService</span><span class=o>)))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=o>((</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>IMyService</span><span class=o>)</span><span class=n>iin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>IMyService</span><span class=o>.</span><span class=na>Stub</span><span class=o>.</span><span class=na>Proxy</span><span class=o>(</span><span class=n>obj</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=nf>asBinder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTransact</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>descriptor</span> <span class=o>=</span> <span class=n>DESCRIPTOR</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>switch</span> <span class=o>(</span><span class=n>code</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>INTERFACE_TRANSACTION</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>reply</span><span class=o>.</span><span class=na>writeString</span><span class=o>(</span><span class=n>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>TRANSACTION_addUser</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>data</span><span class=o>.</span><span class=na>enforceInterface</span><span class=o>(</span><span class=n>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>User</span> <span class=n>_arg0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>((</span><span class=n>0</span><span class=o>!=</span><span class=n>data</span><span class=o>.</span><span class=na>readInt</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>_arg0</span> <span class=o>=</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>User</span><span class=o>.</span><span class=na>CREATOR</span><span class=o>.</span><span class=na>createFromParcel</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>_arg0</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=o>.</span><span class=na>addUser</span><span class=o>(</span><span class=n>_arg0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>TRANSACTION_getUserList</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>data</span><span class=o>.</span><span class=na>enforceInterface</span><span class=o>(</span><span class=n>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>List</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>User</span><span class=o>&gt;</span> <span class=n>_result</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>getUserList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>reply</span><span class=o>.</span><span class=na>writeTypedList</span><span class=o>(</span><span class=n>_result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>onTransact</span><span class=o>(</span><span class=n>code</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Proxy</span> <span class=kd>implements</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>IMyService</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>private</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>Proxy</span><span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>remote</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>mRemote</span> <span class=o>=</span> <span class=n>remote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=nf>asBinder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=nf>getInterfaceDescriptor</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>DESCRIPTOR</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addUser</span><span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>User</span> <span class=n>user</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_data</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_reply</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>_data</span><span class=o>.</span><span class=na>writeInterfaceToken</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>((</span><span class=n>user</span><span class=o>!=</span><span class=kc>null</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>_data</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>user</span><span class=o>.</span><span class=na>writeToParcel</span><span class=o>(</span><span class=n>_data</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>_data</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>Stub</span><span class=o>.</span><span class=na>TRANSACTION_addUser</span><span class=o>,</span> <span class=n>_data</span><span class=o>,</span> <span class=n>_reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>_reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>_reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>_data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>List</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>User</span><span class=o>&gt;</span> <span class=nf>getUserList</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_data</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_reply</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>List</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>User</span><span class=o>&gt;</span> <span class=n>_result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>_data</span><span class=o>.</span><span class=na>writeInterfaceToken</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>Stub</span><span class=o>.</span><span class=na>TRANSACTION_getUserList</span><span class=o>,</span> <span class=n>_data</span><span class=o>,</span> <span class=n>_reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>_reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>_result</span> <span class=o>=</span> <span class=n>_reply</span><span class=o>.</span><span class=na>createTypedArrayList</span><span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>User</span><span class=o>.</span><span class=na>CREATOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>_reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>_data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>_result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>TRANSACTION_addUser</span> <span class=o>=</span> <span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span><span class=o>.</span><span class=na>FIRST_CALL_TRANSACTION</span> <span class=o>+</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>TRANSACTION_getUserList</span> <span class=o>=</span> <span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span><span class=o>.</span><span class=na>FIRST_CALL_TRANSACTION</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addUser</span><span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>User</span> <span class=n>user</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>List</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>binder</span><span class=o>.</span><span class=na>User</span><span class=o>&gt;</span> <span class=nf>getUserList</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®ƒç»§æ‰¿äº† IInterface æ¥å£ï¼ŒIMyService æ¥å£åªæœ‰ä¸€ä¸ªé™æ€æŠ½è±¡ç±» Stubï¼Œå®ƒç»§æ‰¿è‡ª Binder å¹¶å®ç°äº† IMyService æ¥å£ã€‚</p><p>Stub é‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±» Proxyï¼Œå®ƒä¹Ÿç»§æ‰¿äº† IMyServiceï¼ˆæ˜¯ä¸æ˜¯æœ‰ç‚¹ä¹±ï¼Œä¹±å°±å¯¹äº†ï¼Œæˆ‘ä¹Ÿå¾ˆä¹±ï¼‰ã€‚å¦‚æ­¤åµŒå¥—æ˜¯ä¸ºäº†é¿å…æœ‰å¤šä¸ª .aidl æ–‡ä»¶çš„æ—¶å€™è‡ªåŠ¨ç”Ÿæˆè¿™äº›ç±»çš„ç±»åä¸ä¼šé‡å¤ã€‚</p><p>ä¸ºäº†æé«˜ä»£ç å¯è¯»æ€§ï¼Œè¿™é‡Œå°†ç”Ÿæˆçš„ Stub å†…éƒ¨ç±»å•ç‹¬æŠ½å–åˆ°æ–‡ä»¶ Stub.java æ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨å…³é”®æ–¹æ³•ä¸Šæ·»åŠ äº†æ³¨é‡Šå’Œ Logï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Stub</span> <span class=kd>extends</span> <span class=n>Binder</span> <span class=kd>implements</span> <span class=n>IMyService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Construct the mLocalStub at attach it to the interface.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Stub</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>attachInterface</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ ¹æ® Binder æœ¬åœ°å¯¹è±¡æˆ–è€…ä»£ç†å¯¹è±¡è¿”å› IMyServcie æ¥å£
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>IMyService</span> <span class=nf>asInterface</span><span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>obj</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>((</span><span class=n>obj</span> <span class=o>==</span> <span class=kc>null</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//æŸ¥æ‰¾æœ¬åœ°å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IInterface</span> <span class=n>iin</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=na>queryLocalInterface</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(((</span><span class=n>iin</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>iin</span> <span class=k>instanceof</span> <span class=n>IMyService</span><span class=o>)))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”è¿”å›æœ¬åœ°å¯¹è±¡&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>((</span><span class=n>IMyService</span><span class=o>)</span> <span class=n>iin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”è¿”å›ä»£ç†å¯¹è±¡&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>Stub</span><span class=o>.</span><span class=na>Proxy</span><span class=o>(</span><span class=n>obj</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=nf>asBinder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTransact</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=o>(</span><span class=n>code</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>INTERFACE_TRANSACTION</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>reply</span><span class=o>.</span><span class=na>writeString</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>TRANSACTION_addUser</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”æœ¬åœ°å¯¹è±¡é€šè¿‡ Binder æ‰§è¡Œ addUser&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=o>.</span><span class=na>enforceInterface</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>User</span> <span class=n>arg0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>((</span><span class=n>0</span> <span class=o>!=</span> <span class=n>data</span><span class=o>.</span><span class=na>readInt</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//å–å‡ºå®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>arg0</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=na>CREATOR</span><span class=o>.</span><span class=na>createFromParcel</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>arg0</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>//è°ƒç”¨ Binder æœ¬åœ°å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>this</span><span class=o>.</span><span class=na>addUser</span><span class=o>(</span><span class=n>arg0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>TRANSACTION_getUserList</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”æœ¬åœ°å¯¹è±¡é€šè¿‡ Binder æ‰§è¡Œ getUserList&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=o>.</span><span class=na>enforceInterface</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>//è°ƒç”¨ Binder æœ¬åœ°å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>getUserList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>//å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>reply</span><span class=o>.</span><span class=na>writeTypedList</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>onTransact</span><span class=o>(</span><span class=n>code</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Proxy</span> <span class=kd>implements</span> <span class=n>IMyService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Proxy</span><span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>remote</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mRemote</span> <span class=o>=</span> <span class=n>remote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=nf>asBinder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=nf>getInterfaceDescriptor</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>DESCRIPTOR</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addUser</span><span class=o>(</span><span class=n>User</span> <span class=n>user</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_data</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_reply</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>_data</span><span class=o>.</span><span class=na>writeInterfaceToken</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>               <span class=k>if</span> <span class=o>(</span><span class=n>user</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                   <span class=n>_data</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                   <span class=c1>//å°† user å¯¹è±¡çš„å€¼å†™å…¥ _data
</span></span></span><span class=line><span class=cl><span class=c1></span>                   <span class=n>user</span><span class=o>.</span><span class=na>writeToParcel</span><span class=o>(</span><span class=n>_data</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>               <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                   <span class=n>_data</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>               <span class=o>}</span>
</span></span><span class=line><span class=cl>               <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”ä»£ç†å¯¹è±¡é€šè¿‡ Binder è°ƒç”¨ addUser&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>               <span class=c1>//é€šè¿‡ transact è·Ÿ Server äº¤äº’
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>Stub</span><span class=o>.</span><span class=na>TRANSACTION_addUser</span><span class=o>,</span> <span class=n>_data</span><span class=o>,</span> <span class=n>_reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>_reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>_reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>_data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=nf>getUserList</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_data</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_reply</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>_result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>_data</span><span class=o>.</span><span class=na>writeInterfaceToken</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”ä»£ç†å¯¹è±¡é€šè¿‡ Binder è°ƒç”¨ getUserList&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>//é€šè¿‡ transact è·Ÿ Server äº¤äº’
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>Stub</span><span class=o>.</span><span class=na>TRANSACTION_getUserList</span><span class=o>,</span> <span class=n>_data</span><span class=o>,</span> <span class=n>_reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>_reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>//è·å– Server çš„è¿”å›å€¼å¹¶è¿›ç¨‹è½¬æ¢
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>_result</span> <span class=o>=</span> <span class=n>_reply</span><span class=o>.</span><span class=na>createTypedArrayList</span><span class=o>(</span><span class=n>User</span><span class=o>.</span><span class=na>CREATOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>_reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>_data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>_result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2åˆ›å»º-service><h2 id=2åˆ›å»º-service><span class=hanchor arialabel=Anchor># </span>2ã€åˆ›å»º Service</h2></a><p>åˆ›å»º UserServer ç±»å¹¶ç»§æ‰¿è‡ª Serviceï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªå†…éƒ¨ç±» IMyServiceNative å¹¶ä¸”ç»§æ‰¿ Stub ç±»ï¼Œç„¶åå°†è¯¥å®ç°ç±»çš„å®ä¾‹åœ¨ onBind æ–¹æ³•è¿”å›ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserServer</span> <span class=kd>extends</span> <span class=n>Service</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>class</span> <span class=nc>IMyServiceNative</span> <span class=kd>extends</span> <span class=n>Stub</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>users</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addUser</span><span class=o>(</span><span class=n>User</span> <span class=n>user</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;è¿›ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getProcessName</span><span class=o>(</span><span class=n>getApplicationContext</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=s>&#34;ï¼Œçº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”Server æ‰§è¡Œ addUser&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>users</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>user</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=nf>getUserList</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;è¿›ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getProcessName</span><span class=o>(</span><span class=n>getApplicationContext</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=s>&#34;ï¼Œçº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”Server æ‰§è¡Œ getUserList&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>users</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>IMyServiceNative</span> <span class=n>mMyServcieNative</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IMyServiceNative</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>IBinder</span> <span class=nf>onBind</span><span class=o>(</span><span class=n>Intent</span> <span class=n>intent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;è¿›ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getProcessName</span><span class=o>(</span><span class=n>getApplicationContext</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34;ï¼Œçº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”Server onBind&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mMyServcieNative</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å› ä¸º Stub æŠ½è±¡ç±»å®ç°äº† IMyService æ¥å£ï¼Œå®ƒå£°æ˜äº† Server ç«¯å…·æœ‰çš„èƒ½åŠ›ã€‚å› æ­¤åœ¨ IMyServiceNative ä¸­åº”è¯¥å®ç° IMyService æ¥å£ä¸­å£°æ˜çš„ addUser å’Œ getUserList æ–¹æ³•ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦åœ¨ Menifest æ–‡ä»¶ä¸­å£°æ˜ MyService å¹¶æ ‡è®°ä¸ºè¿œç¨‹ Serviceï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;service</span> <span class=na>android:name=</span><span class=s>&#34;.MyService&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:process=</span><span class=s>&#34;:remote&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;intent-filter&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&#34;com.me.guanpj.binder&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/intent-filter&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/service&gt;</span>
</span></span></code></pre></td></tr></table></div></div><a href=#3ç»‘å®š-service><h2 id=3ç»‘å®š-service><span class=hanchor arialabel=Anchor># </span>3ã€ç»‘å®š Service</h2></a><p>ä½œä¸ºå®¢æˆ·ç«¯ï¼Œåœ¨ ClientActivity ä¸­ç»‘å®šè¿œç¨‹ Serviceï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>bindService</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Intent</span> <span class=n>intent</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Intent</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>intent</span><span class=o>.</span><span class=na>setAction</span><span class=o>(</span><span class=s>&#34;com.me.guanpj.binder&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>intent</span><span class=o>.</span><span class=na>setComponent</span><span class=o>(</span><span class=k>new</span> <span class=n>ComponentName</span><span class=o>(</span><span class=s>&#34;com.me.guanpj.binder&#34;</span><span class=o>,</span> <span class=s>&#34;com.me.guanpj.binder.MyService&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;è¿›ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getProcessName</span><span class=o>(</span><span class=n>getApplicationContext</span><span class=o>())</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=s>&#34;ï¼Œçº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”å¼€å§‹ç»‘å®š Servcie&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>bindService</span><span class=o>(</span><span class=n>intent</span><span class=o>,</span> <span class=n>mConn</span><span class=o>,</span> <span class=n>Context</span><span class=o>.</span><span class=na>BIND_AUTO_CREATE</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IMyService</span> <span class=n>myService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>ServiceConnection</span> <span class=n>mConn</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServiceConnection</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onServiceConnected</span><span class=o>(</span><span class=n>ComponentName</span> <span class=n>name</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>service</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;è¿›ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getProcessName</span><span class=o>(</span><span class=n>getApplicationContext</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34;ï¼Œçº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”Client onServiceConnected&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>myService</span> <span class=o>=</span> <span class=n>Stub</span><span class=o>.</span><span class=na>asInterface</span><span class=o>(</span><span class=n>service</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onServiceDisconnected</span><span class=o>(</span><span class=n>ComponentName</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>myService</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ onServiceConnected å›è°ƒæ–¹æ³•ä¸­ï¼Œå°† Binder é©±åŠ¨è¿”å›çš„ service åŒ…è£…æˆ Stub å¯¹è±¡å¹¶èµ‹å€¼ç»™ myServiceï¼Œéšåå°±å¯ä»¥ä½¿ç”¨ myService å®ä¾‹ä¸ Server ç«¯äº¤äº’äº†ã€‚</p><a href=#4client-ç«¯ä¸-server-ç«¯äº¤äº’><h2 id=4client-ç«¯ä¸-server-ç«¯äº¤äº’><span class=hanchor arialabel=Anchor># </span>4ã€Client ç«¯ä¸ Server ç«¯äº¤äº’</h2></a><p>ç»‘å®šè¿œç¨‹ Service å¹¶ä¸”è·å–åˆ° Server ç«¯çš„ä»£ç†å¯¹è±¡åï¼ŒClient ç«¯ä¾¿å¯é€šè¿‡ä»£ç†å¯¹è±¡ä¸ Server ç«¯è¿›è¡Œé€šè®¯äº†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=o>(</span><span class=n>View</span> <span class=n>v</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>v</span><span class=o>.</span><span class=na>getId</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>R</span><span class=o>.</span><span class=na>id</span><span class=o>.</span><span class=na>btn_bind</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>bindService</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>R</span><span class=o>.</span><span class=na>id</span><span class=o>.</span><span class=na>btn_add_user</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=kc>null</span> <span class=o>!=</span> <span class=n>myService</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”Client è°ƒç”¨ addUser&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>myService</span><span class=o>.</span><span class=na>addUser</span><span class=o>(</span><span class=k>new</span> <span class=n>User</span><span class=o>(</span><span class=n>111</span><span class=o>,</span> <span class=s>&#34;gpj&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Toast</span><span class=o>.</span><span class=na>makeText</span><span class=o>(</span><span class=n>ClientActivity</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=s>&#34;å…ˆç»‘å®š Service æ‰èƒ½è°ƒç”¨æ–¹æ³•&#34;</span><span class=o>,</span> <span class=n>Toast</span><span class=o>.</span><span class=na>LENGTH_LONG</span><span class=o>).</span><span class=na>show</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>R</span><span class=o>.</span><span class=na>id</span><span class=o>.</span><span class=na>btn_get_size</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=kc>null</span> <span class=o>!=</span> <span class=n>myService</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”Client è°ƒç”¨ getUserList&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>userList</span> <span class=o>=</span> <span class=n>myService</span><span class=o>.</span><span class=na>getUserList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>tvResult</span><span class=o>.</span><span class=na>setText</span><span class=o>(</span><span class=s>&#34;getUserList size:&#34;</span> <span class=o>+</span> <span class=n>userList</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”UserList Sizeï¼š&#34;</span> <span class=o>+</span> <span class=n>userList</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Toast</span><span class=o>.</span><span class=na>makeText</span><span class=o>(</span><span class=n>ClientActivity</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=s>&#34;å…ˆç»‘å®š Service æ‰èƒ½è°ƒç”¨æ–¹æ³•&#34;</span><span class=o>,</span> <span class=n>Toast</span><span class=o>.</span><span class=na>LENGTH_LONG</span><span class=o>).</span><span class=na>show</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#5ç»“æœå±•ç¤º><h2 id=5ç»“æœå±•ç¤º><span class=hanchor arialabel=Anchor># </span>5ã€ç»“æœå±•ç¤º</h2></a><p>ç»è¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œå¤„äº Client ç«¯çš„ Activity ä¸ä½œä¸ºæœåŠ¡ç«¯çš„è¿œç¨‹ Service è™½ç„¶è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œé€šè¿‡ AIDL ç”Ÿæˆçš„æ¨¡æ¿ä»£ç å¹¶ä¸”ä¾èµ– Binder æœºåˆ¶ï¼Œå®ƒä»¬ä¹‹é—´å®ç°äº†æ•°æ®çš„ä¼ é€’ã€‚</p><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Binder-2/clipboard_20230323_044626.png width=auto alt></p><p>é¦–å…ˆç‚¹å‡» BindService æŒ‰é’®ï¼Œæ­¤æ—¶ä¼šç»‘å®šè¿œç¨‹ Service å¹¶ä¸”è·å–åˆ°æœåŠ¡ç«¯çš„ä»£ç†å¯¹è±¡ myServiceï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binderï¼Œçº¿ç¨‹ï¼šmainâ€”â€”â€”â€”å¼€å§‹ç»‘å®š Servcie
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binder:remoteï¼Œçº¿ç¨‹ï¼šmainâ€”â€”â€”â€”Server onBind
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binderï¼Œçº¿ç¨‹ï¼šmainâ€”â€”â€”â€”Client onServiceConnected
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binderï¼Œçº¿ç¨‹ï¼šmainâ€”â€”â€”â€”è¿”å›ä»£ç†å¯¹è±¡
</span></span></code></pre></td></tr></table></div></div><p>ç‚¹å‡» Add User æŒ‰é’®å¾€ Server ç«¯å¢åŠ ä¸€åç”¨æˆ·ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binderï¼Œçº¿ç¨‹ï¼šmainâ€”â€”â€”â€”Client è°ƒç”¨ addUser
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binderï¼Œçº¿ç¨‹ï¼šmainâ€”â€”â€”â€”ä»£ç†å¯¹è±¡é€šè¿‡ Binder è°ƒç”¨ addUser
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binder:remoteï¼Œçº¿ç¨‹ï¼šBinder:4072_3â€”â€”â€”â€”æœ¬åœ°å¯¹è±¡é€šè¿‡ Binder æ‰§è¡Œ addUser
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binder:remoteï¼Œçº¿ç¨‹ï¼šBinder:4072_3â€”â€”â€”â€”Server æ‰§è¡Œ addUser:User{id=111, name=&#39;gpj&#39;}
</span></span></code></pre></td></tr></table></div></div><p>ç‚¹å‡» Get Size æŒ‰é’®æŸ¥è¯¢ç”¨æˆ·æ•°é‡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binderï¼Œçº¿ç¨‹ï¼šmainâ€”â€”â€”â€”Client è°ƒç”¨ getUserList
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binderï¼Œçº¿ç¨‹ï¼šmainâ€”â€”â€”â€”ä»£ç†å¯¹è±¡é€šè¿‡ Binder è°ƒç”¨ getUserList
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binder:remoteï¼Œçº¿ç¨‹ï¼šBinder:4072_3â€”â€”â€”â€”æœ¬åœ°å¯¹è±¡é€šè¿‡ Binder æ‰§è¡Œ getUserList
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binder:remoteï¼Œçº¿ç¨‹ï¼šBinder:4072_3â€”â€”â€”â€”Server æ‰§è¡Œ getUserList
</span></span><span class=line><span class=cl>E/gpj: è¿›ç¨‹ï¼šcom.me.guanpj.binderï¼Œçº¿ç¨‹ï¼šmainâ€”â€”â€”â€”UserList Sizeï¼š1
</span></span></code></pre></td></tr></table></div></div><a href=#aidl-é€šè®¯è¿‡ç¨‹åˆ†æ><h1 id=aidl-é€šè®¯è¿‡ç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>AIDL é€šè®¯è¿‡ç¨‹åˆ†æ</h1></a><a href=#å…³é”®ç±»èŒè´£æè¿°><h2 id=å…³é”®ç±»èŒè´£æè¿°><span class=hanchor arialabel=Anchor># </span>å…³é”®ç±»èŒè´£æè¿°</h2></a><p>ä»¥ä¸Šä»£ç å·²ç»ä¸Šä¼ åˆ°äº†
<a href=https://github.com/guanpj/BinderDemo rel=noopener>Github</a>ï¼Œå…³é”®çš„ç±»ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Binder-2/clipboard_20230323_044631.png width=auto alt></p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Binder-2/clipboard_20230323_044634.png width=auto alt></p><ul><li><strong>IInterface:</strong> å£°æ˜ï¼ˆè‡ªåŠ¨ç”Ÿæˆæˆ–è€…æ‰‹åŠ¨åˆ›å»ºï¼‰AIDL æ€§è´¨çš„æ¥å£å¿…é¡»ç»§æ‰¿è¿™ä¸ªæ¥å£ï¼Œè¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ª IBinder asBinder() æ–¹æ³•ï¼Œå®ç°å®ƒçš„ç±»ä»£è¡¨å®ƒèƒ½å¤Ÿè¿›ç¨‹è·¨è¿›ç¨‹ä¼ è¾“ï¼ˆ Server ç«¯çš„ Binder æœ¬åœ°å¯¹è±¡ï¼‰æˆ–è€…æŒæœ‰èƒ½å¤Ÿè¿›ç¨‹è·¨è¿›ç¨‹ä¼ è¾“çš„å¯¹è±¡çš„å¼•ç”¨ï¼ˆBinder ä»£ç†å¯¹è±¡ï¼‰ã€‚</li><li><strong>I</strong><strong>MyServcie</strong><strong>:</strong> å¦‚ 1 ä¸­æ‰€è¿°ï¼Œå®ƒéœ€è¦ç»§æ‰¿ IInterface æ¥å£ï¼Œå¹¶ä¸”å®šä¹‰æ–¹æ³•ï¼ˆå£°æ˜ Server ç«¯å…·æœ‰çš„èƒ½åŠ›ï¼š addUser å’Œ getUserListï¼‰ã€‚</li><li><strong>IBinder:</strong> å®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ç°è¿™ä¸ªæ¥å£çš„å¯¹è±¡å°±å…·æœ‰äº†è·¨è¿›ç¨‹ä¼ è¾“çš„èƒ½åŠ›ï¼ˆç”±é©±åŠ¨åº•å±‚æ”¯æŒï¼‰ï¼Œåœ¨è·¨è¿›ç¨‹æ•°æ®æµç»é©±åŠ¨çš„æ—¶å€™ï¼Œé©±åŠ¨ä¼šè¯†åˆ« IBinder ç±»å‹çš„æ•°æ®ï¼Œä»è€Œè‡ªåŠ¨å®Œæˆä¸åŒè¿›ç¨‹ Binder æœ¬åœ°å¯¹è±¡ä»¥åŠ Binder ä»£ç†å¯¹è±¡çš„è½¬æ¢ã€‚</li><li><strong>Binder:</strong> Java å±‚çš„ Binder ç±»ï¼Œä»£è¡¨ Binder æœ¬åœ°å¯¹è±¡ã€‚</li><li><strong>BinderProxy</strong><strong>: </strong>Binder ç±»çš„å†…éƒ¨ç±»ï¼Œæ˜¯ Server ç«¯ Binder å¯¹è±¡çš„æœ¬åœ°ä»£ç†ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿äº† IBinder æ¥å£ï¼Œå› æ­¤éƒ½èƒ½è·¨è¿›ç¨‹è¿›è¡Œä¼ è¾“ï¼ŒBinder é©±åŠ¨åœ¨è·¨è¿›ç¨‹ä¼ è¾“çš„æ—¶å€™ä¼šå°†è¿™ä¸¤ä¸ªå¯¹è±¡è‡ªåŠ¨è¿›è¡Œè½¬æ¢ã€‚</li><li><strong>Stub</strong><strong>:</strong> ç”± IDE è‡ªåŠ¨ç”Ÿæˆçš„æŠ½è±¡ç±»ï¼Œå­—é¢æ„ä¹‰ä¸ºâ€œå­˜æ ¹â€ï¼Œè¿™é‡ŒæŒ‡å¾…æœåŠ¡ç«¯å®ç°çš„æ„æ€ã€‚å®ƒç»§æ‰¿è‡ª Binder å¹¶å®ç°äº† IInterface æ¥å£ï¼Œè¯´æ˜å®ƒæ˜¯ Server ç«¯çš„ Binder æœ¬åœ°å¯¹è±¡ï¼Œå¹¶æ‹¥æœ‰ Server æ‰¿è¯ºç»™ Client çš„èƒ½åŠ›ã€‚</li><li><strong>ClientActivity:</strong> åœ¨è¿™é‡Œå……å½“ Client ç«¯çš„é—¨é¢ï¼Œå®ƒæŒæœ‰ IMyService æ¥å£çš„å®ä¾‹ myServiceï¼Œå¹¶ä¸”é€šè¿‡ myService ä¸æœåŠ¡ç«¯è¿›è¡Œé€šè®¯ã€‚</li><li><strong>UserServer:</strong> å®ƒæ˜¯ä¸€ä¸ª Service ç»„ä»¶ï¼Œå¯ä»¥è¿è¡Œåœ¨ç‹¬ç«‹çš„è¿›ç¨‹ä¸­ã€‚å½“ä½œä¸ºè¿œç¨‹ Service éœ€è¦ä¸ Client ç«¯è¿›è¡Œç»‘å®šæ—¶ï¼Œå¿…é¡»åœ¨ onBind æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ª IBinder å¯¹è±¡ï¼ŒClient ç«¯æ‰èƒ½ä¸ä¹‹è¿›è¡Œäº¤äº’ã€‚</li><li><strong>MyServiceNative: </strong>Server ç«¯çš„ Binder æœ¬åœ°å¯¹è±¡ã€‚å®ƒå®ç°äº† IMyServcie å£°æ˜çš„èƒ½åŠ›ï¼ˆæ–¹æ³•ï¼‰ï¼ŒClient å¯ä»¥é—´æ¥è°ƒç”¨åˆ°å®ƒä»è€Œå®ç°é€šè®¯åŠŸèƒ½</li></ul><a href=#é€šè®¯è¿‡ç¨‹åˆ†æ><h2 id=é€šè®¯è¿‡ç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>é€šè®¯è¿‡ç¨‹åˆ†æ</h2></a><p>ä¸€æ¬¡è·¨è¿›ç¨‹é€šä¿¡å¿…ç„¶ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªè¿›ç¨‹ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ UserServer å¤„äºæœåŠ¡ç«¯è¿›ç¨‹ï¼Œä½¿ç”¨å†…éƒ¨ç±» MyServiceNative<strong> </strong>æä¾›æœåŠ¡ï¼›ClientActivity ä½œä¸ºå®¢æˆ·ç«¯è¿›ç¨‹ï¼Œä½¿ç”¨ UserServer æä¾›çš„æœåŠ¡ã€‚</p><p>å…ˆä» ClientActivity ä¸­ç»‘å®šæœåŠ¡åçš„å›è°ƒæ–¹æ³•ç€æ‰‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ClientActivity</span> <span class=kd>extends</span> <span class=n>AppCompatActivity</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ServiceConnection</span> <span class=n>mConn</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServiceConnection</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onServiceConnected</span><span class=o>(</span><span class=n>ComponentName</span> <span class=n>name</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>service</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;è¿›ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getProcessName</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=s>&#34;ï¼Œçº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”Client onServiceConnected&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>myService</span> <span class=o>=</span> <span class=n>Stub</span><span class=o>.</span><span class=na>asInterface</span><span class=o>(</span><span class=n>service</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onServiceDisconnected</span><span class=o>(</span><span class=n>ComponentName</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>myService</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>};</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>onServiceConnected çš„å‚æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªæ˜¯ Service ç»„ä»¶çš„åå­—ï¼Œè¡¨ç¤ºå“ªä¸ªæœåŠ¡è¢«å¯åŠ¨äº†ï¼›</p><p>é‡ç‚¹æ˜¯ç±»å‹ä¸º IBinder çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œåœ¨ UserServer ä¸­çš„ onBind æ–¹æ³•ä¸­ï¼Œå·²ç»æŠŠ Server ç«¯çš„æœ¬åœ°å¯¹è±¡ MyServiceNative çš„å®ä¾‹è¿”å›ç»™ Binder é©±åŠ¨äº†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserServer</span> <span class=kd>extends</span> <span class=n>Service</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>MyServiceNative</span> <span class=n>mMyServcieNative</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MyServiceNative</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>IBinder</span> <span class=nf>onBind</span><span class=o>(</span><span class=n>Intent</span> <span class=n>intent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;è¿›ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getProcessName</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34;ï¼Œçº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”Server onBind&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mMyServcieNative</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å› æ­¤ï¼Œå½“è¯¥æœåŠ¡è¢«ç»‘å®šçš„æ—¶å€™ï¼ŒBinder é©±åŠ¨ä¼šä¸ºæ ¹æ®è¯¥æœåŠ¡æ‰€åœ¨çš„è¿›ç¨‹å†³å®šæ˜¯è¿”å›æœ¬åœ°å¯¹è±¡è¿˜æ˜¯ä»£ç†å¯¹è±¡ç»™å®¢æˆ·ç«¯ï¼š</p><p>å½“ Service ä¸ ClientActivity ä½äºåŒä¸€ä¸ªè¿›ç¨‹å½“ä¸­çš„æ—¶å€™ï¼ŒonServiceConnected è¿”å› Binder æœ¬åœ°å¯¹è±¡â€”â€”å³ MyServcieNative å®ä¾‹ç»™å®¢æˆ·ç«¯ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Binder-2/clipboard_20230323_044640.png width=auto alt></p><p>å½“ Service è¿è¡Œåœ¨ä¸åŒè¿›ç¨‹ä¸­çš„æ—¶å€™ï¼ˆManifest ä¸­å£°æ˜ Service çš„æ—¶å€™è®¾ç½® proces å±æ€§ï¼‰ï¼Œè¿”å›çš„æ˜¯ BinderProxy å®ä¾‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Binder-2/clipboard_20230323_044643.png width=auto alt></p><p>æ¥ç€ä¼šå°†è¿™ä¸ª IBinder å®ä¾‹ä¼ ç»™ Stub çš„ asInterface æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * æ ¹æ® Binder æœ¬åœ°å¯¹è±¡æˆ–è€…ä»£ç†å¯¹è±¡è¿”å› IMyService æ¥å£
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>IMyService</span> <span class=nf>asInterface</span><span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>obj</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span><span class=n>obj</span> <span class=o>==</span> <span class=kc>null</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//æŸ¥æ‰¾æœ¬åœ°å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IInterface</span> <span class=n>iin</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=na>queryLocalInterface</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(((</span><span class=n>iin</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>iin</span> <span class=k>instanceof</span> <span class=n>IMyService</span><span class=o>)))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”è¿”å›æœ¬åœ°å¯¹è±¡&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>((</span><span class=n>IMyService</span><span class=o>)</span> <span class=n>iin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”è¿”å›ä»£ç†å¯¹è±¡&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Stub</span><span class=o>.</span><span class=na>Proxy</span><span class=o>(</span><span class=n>obj</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆï¼Œä¼šæ ¹æ® DESCRIPTOR è°ƒç”¨ IBinder å¯¹è±¡çš„ queryLocalInterface æ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¾—çœ‹ IBinder çš„å®ç°ç±»æ€ä¹ˆå¤„ç†è¿™ä¸ªæ–¹æ³•äº†ï¼š</p><p><strong>åœ¨ Binder ç±»ä¸­çš„å®ç°ï¼š</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>IInterface</span> <span class=nf>queryLocalInterface</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>descriptor</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//åˆ¤æ–­ mDescriptor è·Ÿå‚æ•° DESCRIPTOR ç›¸åŒï¼Œè¿”å› mOwner
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>mDescriptor</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mDescriptor</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>descriptor</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mOwner</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é‚£ä¹ˆè¿™ä¸ª mOwner å’Œ mDescriptor åˆæ˜¯ä»€ä¹ˆæ—¶å€™è¢«èµ‹å€¼çš„å‘¢ï¼Ÿç­”æ¡ˆåœ¨ Binder çš„å­ç±» Stub çš„æ„é€ æ–¹æ³•é‡Œé¢ï¼Œï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Stub</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å°† Stub å’Œ DESCRIPTOR æ³¨å…¥åˆ°çˆ¶ç±»ï¼ˆBinderï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>attachInterface</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>åœ¨ Binder$BinderProxy ç±»ä¸­çš„å®ç°ï¼š</strong></p><p>BinderProxy å¹¶ä¸æ˜¯ Binder æœ¬åœ°å¯¹è±¡ï¼Œè€Œæ˜¯ Binder çš„æœ¬åœ°ä»£ç†ï¼Œå› æ­¤ queryLocalInterface è¿”å›çš„æ˜¯ nullï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>IInterface</span> <span class=nf>queryLocalInterface</span><span class=o>(</span><span class=n>String</span> <span class=n>descriptor</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ ¹æ®ä»¥ä¸Šåˆ†æå¯ä»¥å¾—å‡ºç»“è®ºï¼š</p><p>å½“ UserServer ä¸å®¢æˆ·ç«¯å¤„äºç›¸åŒè¿›ç¨‹æ—¶ï¼Œobj.queryLocalInterface(DESCRIPTOR) æ–¹æ³•å­˜åœ¨è¿”å›å€¼å¹¶ä¸”æ˜¯ IMyService å®ä¾‹ï¼Œè€Œå®ƒå°±æ˜¯ MyServiceNativeï¼Œå°†å®ƒç›´æ¥è¿”å›ç»™ Client è°ƒç”¨ï¼›</p><p>å¤„äºä¸åŒè¿›ç¨‹æ—¶ï¼Œobj.queryLocalInterface(DESCRIPTOR) è¿”å› nullï¼Œè¿™æ—¶ä½¿ç”¨ Stub$Proxy ç±»å°†å…¶è¿›è¡ŒåŒ…è£…åå†è¿”å›ã€‚Proxy ç±»ä¹Ÿå®ç°äº† IMyService æ¥å£ï¼Œå› æ­¤ï¼Œåœ¨ Client çœ‹æ¥ï¼Œå®ƒä¹Ÿå…·æœ‰ Server æ‰¿è¯ºç»™ Client çš„èƒ½åŠ›ã€‚</p><p>é‚£ä¹ˆï¼Œç»è¿‡åŒ…è£…åçš„ Stub$Proxy å¯¹è±¡æ€ä¹ˆå’Œ Server è¿›è¡Œäº¤äº’å‘¢ï¼Ÿé¦–å…ˆï¼Œå®ƒä¼šæŠŠ BinderProxy å¯¹è±¡ä¿å­˜ä¸‹æ¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Proxy</span><span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>remote</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mRemote</span> <span class=o>=</span> <span class=n>remote</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åï¼Œå®ç° IMyService çš„æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>addUser</span><span class=o>(</span><span class=n>User</span> <span class=n>user</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_data</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_reply</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_data</span><span class=o>.</span><span class=na>writeInterfaceToken</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>user</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>_data</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>//å°† user å¯¹è±¡çš„å€¼å†™å…¥ _data
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>user</span><span class=o>.</span><span class=na>writeToParcel</span><span class=o>(</span><span class=n>_data</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>_data</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”ä»£ç†å¯¹è±¡é€šè¿‡ Binder è°ƒç”¨ addUser&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//é€šè¿‡ transact è·Ÿ Server äº¤äº’
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>Stub</span><span class=o>.</span><span class=na>TRANSACTION_addUser</span><span class=o>,</span> <span class=n>_data</span><span class=o>,</span> <span class=n>_reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>_reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>_data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=nf>getUserList</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_data</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_reply</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>_result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_data</span><span class=o>.</span><span class=na>writeInterfaceToken</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”ä»£ç†å¯¹è±¡é€šè¿‡ Binder è°ƒç”¨ getUserList&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//é€šè¿‡ transact è·Ÿ Server äº¤äº’
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>Stub</span><span class=o>.</span><span class=na>TRANSACTION_getUserList</span><span class=o>,</span> <span class=n>_data</span><span class=o>,</span> <span class=n>_reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>_reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//è·å– Server çš„è¿”å›å€¼å¹¶è¿›ç¨‹è½¬æ¢
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>_result</span> <span class=o>=</span> <span class=n>_reply</span><span class=o>.</span><span class=na>createTypedArrayList</span><span class=o>(</span><span class=n>User</span><span class=o>.</span><span class=na>CREATOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>_data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>_result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡ä»€ä¹ˆæ–¹æ³•ï¼Œéƒ½æ˜¯æ˜¯å°†æœåŠ¡ç«¯çš„æ–¹æ³•ä»£å·ã€å¤„ç†è¿‡çš„å‚æ•°å’Œæ¥æ”¶è¿”å›å€¼çš„å¯¹è±¡ç­‰é€šè¿‡ mRemote.transact() æ–¹æ³• Server è¿›è¡Œäº¤äº’ï¼ŒmRemote æ˜¯ BinderProxy ç±»å‹ï¼Œåœ¨ BinderProxy ç±»ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ transactNative æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>native</span> <span class=kt>boolean</span> <span class=nf>transactNative</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span><span class=o>;</span>
</span></span></code></pre></td></tr></table></div></div><p>å®ƒçš„æœ€ç»ˆå®ç°åœ¨ Native å±‚è¿›è¡Œï¼ŒBinder é©±åŠ¨ä¼šé€šè¿‡ ioctl ç³»ç»Ÿè°ƒç”¨å”¤é†’ Server è¿›ç¨‹ï¼Œå¹¶è°ƒç”¨æœ¬åœ°å¯¹è±¡ MyServiceNative çš„ onTransact å‡½æ•°ï¼ˆåœ¨ Stub ç±»ä¸­ï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTransact</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>code</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>INTERFACE_TRANSACTION</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeString</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>TRANSACTION_addUser</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”æœ¬åœ°å¯¹è±¡é€šè¿‡ Binder æ‰§è¡Œ addUser&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>.</span><span class=na>enforceInterface</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>User</span> <span class=n>arg0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span><span class=n>0</span> <span class=o>!=</span> <span class=n>data</span><span class=o>.</span><span class=na>readInt</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>//å–å‡ºå®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>arg0</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=na>CREATOR</span><span class=o>.</span><span class=na>createFromParcel</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>arg0</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>//è°ƒç”¨ Binder æœ¬åœ°å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=o>.</span><span class=na>addUser</span><span class=o>(</span><span class=n>arg0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>TRANSACTION_getUserList</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=s>&#34;gpj&#34;</span><span class=o>,</span> <span class=s>&#34;çº¿ç¨‹ï¼š&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;â€”â€”â€”â€”æœ¬åœ°å¯¹è±¡é€šè¿‡ Binder æ‰§è¡Œ getUserList&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>.</span><span class=na>enforceInterface</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>//è°ƒç”¨ Binder æœ¬åœ°å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>getUserList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>//å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>reply</span><span class=o>.</span><span class=na>writeTypedList</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>onTransact</span><span class=o>(</span><span class=n>code</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ Server è¿›ç¨‹ä¸­ï¼ŒonTransact ä¼šæ ¹æ® Client ä¼ è¿‡æ¥çš„æ–¹æ³•ä»£å·å†³å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•ï¼Œå¾—åˆ°ç»“æœååˆä¼šé€šè¿‡ Binder é©±åŠ¨è¿”å›ç»™ Clientã€‚</p><p>å›æº¯åˆ° onServiceConnected å›è°ƒæ–¹æ³•ï¼Œå¾…æœåŠ¡è¿æ¥æˆåŠŸåï¼ŒClient å°±éœ€è¦è·Ÿ Server è¿›è¡Œäº¤äº’äº†ï¼Œå¦‚æœ Server è·Ÿ Client åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼ŒClient å¯ä»¥ç›´æ¥è°ƒç”¨ Server çš„æœ¬åœ°å¯¹è±¡ ï¼Œå½“å®ƒä»¬ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ—¶å€™ï¼ŒBinder é©±åŠ¨ä¼šè‡ªåŠ¨å°† Server çš„æœ¬åœ°å¯¹è±¡è½¬æ¢æˆ BinderProxy ä»£ç†å¯¹è±¡ï¼Œç»è¿‡ä¸€å±‚åŒ…è£…ä¹‹åï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ä»£ç†å¯¹è±¡ç»™ Clientã€‚è¿™æ ·ï¼Œæ•´ä¸ª IPC çš„è¿‡ç¨‹å°±å®Œæˆäº†ã€‚</p><p>æ•´ä¸ªè¿‡ç¨‹çš„æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Binder-2/clipboard_20230323_044649.png width=auto alt></p><a href=#binder-åœ¨-framework-å±‚çš„åº”ç”¨><h1 id=binder-åœ¨-framework-å±‚çš„åº”ç”¨><span class=hanchor arialabel=Anchor># </span>Binder åœ¨ Framework å±‚çš„åº”ç”¨</h1></a><p>åœ¨ Activity å¯åŠ¨çš„åˆå§‹é˜¶æ®µçš„æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Binder-2/clipboard_20230323_044652.png width=auto alt></p><p>å…¶ä¸­ï¼Œæœ€åä¸€æ®µä¸­çš„ ActivityManagerProxy ä¸ ActivityManagerServer åˆ†åˆ«å¤„äºä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œå®ƒä»¬ä¹‹é—´çš„é€šè®¯ä¹Ÿä¾èµ– Binder æœºåˆ¶ã€‚</p><p>è¿™é‡Œä» Instrumentation ç±»çš„ execStartActivity() æ–¹æ³•å¼€å§‹åˆ†æï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>ActivityResult</span> <span class=nf>execStartActivity</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Context</span> <span class=n>who</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>contextThread</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span> <span class=n>Activity</span> <span class=n>target</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=na>migrateExtraStreamToClipData</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=na>prepareToLeaveProcess</span><span class=o>(</span><span class=n>who</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è·å– AMS çš„ä»£ç†å¯¹è±¡å¹¶è°ƒç”¨å…¶ startActivity æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>startActivity</span><span class=o>(</span><span class=n>whoThread</span><span class=o>,</span> <span class=n>who</span><span class=o>.</span><span class=na>getBasePackageName</span><span class=o>(),</span> <span class=n>intent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>intent</span><span class=o>.</span><span class=na>resolveTypeIfNeeded</span><span class=o>(</span><span class=n>who</span><span class=o>.</span><span class=na>getContentResolver</span><span class=o>()),</span>
</span></span><span class=line><span class=cl>                    <span class=n>token</span><span class=o>,</span> <span class=n>target</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>target</span><span class=o>.</span><span class=na>mEmbeddedID</span> <span class=o>:</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>requestCode</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>checkStartActivityResult</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>intent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Failure from system&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»¥ä¸Šè¿‡ç¨‹æ˜¯åœ¨ Launcher App æ‰€åœ¨çš„è¿›ç¨‹ä¸­å‘ç”Ÿçš„ï¼ŒAMS æ˜¯è¿è¡Œåœ¨ system_server è¿›ç¨‹ä¸­çš„ï¼Œè¿™æ—¶ AMS å°±ç›¸å½“äº AIDL ä¸­çš„è¿œç¨‹ Serviceï¼ŒApp è¿›ç¨‹è¦ä¸ AMS äº¤äº’ï¼Œéœ€è¦é€šè¿‡ AMS çš„ä»£ç†å¯¹è±¡ AMP(ActivityManagerProxy) æ¥å®Œæˆï¼Œæ¥çœ‹ ActivityManagerNative.getDefault() æ‹¿åˆ°çš„æ˜¯ä»€ä¹ˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>public</span> <span class=n>IActivityManager</span> <span class=nf>getDefault</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>gDefault</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>getDefault æ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityManager</span><span class=o>&gt;</span> <span class=n>gDefault</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityManager</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>IActivityManager</span> <span class=nf>create</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å‘ ServiceManager æŸ¥è¯¢ä¸€ä¸ª key ä¸º &#34;activity&#34; çš„å¼•ç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>IBinder</span> <span class=n>b</span> <span class=o>=</span> <span class=n>ServiceManager</span><span class=o>.</span><span class=na>getService</span><span class=o>(</span><span class=s>&#34;activity&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=kc>false</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=s>&#34;ActivityManager&#34;</span><span class=o>,</span> <span class=s>&#34;default service binder = &#34;</span> <span class=o>+</span> <span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>IActivityManager</span> <span class=n>am</span> <span class=o>=</span> <span class=n>asInterface</span><span class=o>(</span><span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=kc>false</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=s>&#34;ActivityManager&#34;</span><span class=o>,</span> <span class=s>&#34;default service = &#34;</span> <span class=o>+</span> <span class=n>am</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>am</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé€šè¿‡ &ldquo;activity&rdquo; è¿™ä¸ªåå­—å‘ ServiceManager æŸ¥è¯¢ AMS çš„å¼•ç”¨ï¼ˆäº‹å®ä¸Šè¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯é€šè¿‡ Binder æ¥å®ç°çš„ï¼Œè¿™é‡Œä¸å†åˆ†æï¼‰ï¼Œè·å– AMS çš„å¼•ç”¨åï¼Œè°ƒç”¨ asInterface æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>public</span> <span class=n>IActivityManager</span> <span class=nf>asInterface</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>obj</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>obj</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ® descriptor æŸ¥è¯¢ obj æ˜¯å¦ä¸º Binder æœ¬åœ°å¯¹è±¡ï¼Œå…·ä½“è¿‡ç¨‹è¯·çœ‹å‰æ–‡ä¸­æåˆ°çš„æ–‡ç« 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>IActivityManager</span> <span class=n>in</span> <span class=o>=</span> <span class=o>(</span><span class=n>IActivityManager</span><span class=o>)</span><span class=n>obj</span><span class=o>.</span><span class=na>queryLocalInterface</span><span class=o>(</span><span class=n>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>in</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>in</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœ obj ä¸æ˜¯ Binder æœ¬åœ°å¯¹è±¡ï¼Œåˆ™å°†å…¶åŒ…è£…æˆä»£ç†å¯¹è±¡å¹¶è¿”å›
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=n>ActivityManagerProxy</span><span class=o>(</span><span class=n>obj</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å› ä¸º AMS ä¸ Launcher App ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œè¿™é‡Œè¿”å›çš„ IBinder å¯¹è±¡æ˜¯ä¸€ä¸ª Binder ä»£ç†å¯¹è±¡ï¼Œå› æ­¤è¿™ç±»å°†å…¶åŒ…è£…æˆ AMP(ActivityManagerProxy) å¯¹è±¡å¹¶è¿”å›ï¼ŒAMP æ˜¯ AMN(ActivityManagerNative) çš„å†…éƒ¨ç±»ï¼ŒæŸ¥çœ‹ AMP ç±» ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ActivityManagerProxy</span> <span class=kd>implements</span> <span class=n>IActivityManager</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>ActivityManagerProxy</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>remote</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mRemote</span> <span class=o>=</span> <span class=n>remote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>IBinder</span> <span class=nf>asBinder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨å·ä¸º START_ACTIVITY_TRANSACTION
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>START_ACTIVITY_TRANSACTION</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>reply</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>ComponentName</span> <span class=nf>startService</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>service</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=kt>int</span> <span class=n>userId</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>START_SERVICE_TRANSACTION</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ComponentName</span> <span class=n>res</span> <span class=o>=</span> <span class=n>ComponentName</span><span class=o>.</span><span class=na>readFromParcel</span><span class=o>(</span><span class=n>reply</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒAMP é‡Œé¢å°†å®¢æˆ·ç«¯çš„è¯·æ±‚é€šè¿‡ mRemote.transact() è¿›è¡Œè½¬å‘ï¼›mRemote æ­£æ˜¯ Binder é©±åŠ¨è¿”å›æ¥çš„ BinderProxy å¯¹è±¡çš„å®ä¾‹ï¼Œé€šè¿‡ mRemoteï¼ŒBinder é©±åŠ¨æœ€ç»ˆå°†è°ƒç”¨å¤„äº Binder Server ç«¯ AMN ä¸­çš„ onTransact æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTransact</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ®æ–¹æ³•è°ƒç”¨å· code å†³å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=o>(</span><span class=n>code</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>START_ACTIVITY_TRANSACTION</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ startActivity æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>startActivity</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resultTo</span><span class=o>,</span> <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>START_SERVICE_TRANSACTION</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>ComponentName</span> <span class=n>cn</span> <span class=o>=</span> <span class=n>startService</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>service</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>userId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>ComponentName</span><span class=o>.</span><span class=na>writeToParcel</span><span class=o>(</span><span class=n>cn</span><span class=o>,</span> <span class=n>reply</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>AMN æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒçš„ startActivity ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°åœ¨ ActivityManagerService.java ä¸­:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ActivityManagerService</span> <span class=kd>extends</span> <span class=n>ActivityManagerNative</span>
</span></span><span class=line><span class=cl>        <span class=kd>implements</span> <span class=n>Watchdog</span><span class=o>.</span><span class=na>Monitor</span><span class=o>,</span> <span class=n>BatteryStatsImpl</span><span class=o>.</span><span class=na>BatteryCallback</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                   <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                   <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>bOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>startActivityAsUser</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>resultTo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>bOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>UserHandle</span><span class=o>.</span><span class=na>getCallingUserId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ ·æœ€ç»ˆä» App è¿›ç¨‹è°ƒç”¨åˆ°äº† AMS ä¸­çš„æ–¹æ³•ï¼Œå‰©ä¸‹çš„æµç¨‹è¿™é‡Œä¸å†è¿›è¡Œåˆ†æã€‚</p><a href=#æ€»ç»“><h1 id=æ€»ç»“><span class=hanchor arialabel=Anchor># </span>æ€»ç»“</h1></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Binder-2/clipboard_20230323_044658.png width=auto alt></p><p><strong>å‚è€ƒæ–‡ç« </strong></p><p><a href=https://zhuanlan.zhihu.com/p/35519585 rel=noopener>å†™ç»™ Android åº”ç”¨å·¥ç¨‹å¸ˆçš„ Binder åŸç†å‰–æ</a></p><p><a href=https://cloud.tencent.com/developer/article/1329601 rel=noopener>Binder å­¦ä¹ æŒ‡å—</a></p><blockquote><p>æ–‡ç« ä¸­çš„ä»£ç å·²ç»ä¸Šä¼ è‡³æˆ‘çš„ Githubï¼Œå¦‚æœä½ å¯¹æ–‡ç« å†…å®¹æœ‰ç–‘é—®æˆ–è€…æœ‰ä¸åŒçš„æ„è§ï¼Œæ¬¢è¿ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€åŒæ¢è®¨ã€‚</p></blockquote></article><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/ data-ctx="äºŒã€Binder æœºåˆ¶åˆ†æâ€”â€”åº”ç”¨ç¯‡" data-src=/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87 class=internal-link>ä¸€ã€Binder æœºåˆ¶åˆ†æâ€”â€”æ¦‚å¿µç¯‡</a></li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>