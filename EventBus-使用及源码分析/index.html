<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="EventBus ä½¿ç”¨åŠæºç åˆ†æ ä½¿ç”¨  é¦–å…ˆå¼•å…¥ä¾èµ–  1 2 3 4 5 6 7 8 9 10 11 12  apply plugin: 'kotlin-kapt' dependencies { implementation 'org."><meta property="og:title" content><meta property="og:description" content="EventBus ä½¿ç”¨åŠæºç åˆ†æ ä½¿ç”¨  é¦–å…ˆå¼•å…¥ä¾èµ–  1 2 3 4 5 6 7 8 9 10 11 12  apply plugin: 'kotlin-kapt' dependencies { implementation 'org."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="EventBus ä½¿ç”¨åŠæºç åˆ†æ ä½¿ç”¨  é¦–å…ˆå¼•å…¥ä¾èµ–  1 2 3 4 5 6 7 8 9 10 11 12  apply plugin: 'kotlin-kapt' dependencies { implementation 'org."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.0452046239b15cdfa822e3a8fa41b16d.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.9fddd62f4f9253cd4caef08e6b155b10.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.80e532876cce07a5a16fddacc610a74a.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown</p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#eventbus-ä½¿ç”¨åŠæºç åˆ†æ>EventBus ä½¿ç”¨åŠæºç åˆ†æ</a></li><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a></li><li><a href=#åˆ†æ>åˆ†æ</a><ol><li><a href=#è·å–-eventbus-å®ä¾‹>è·å– EventBus å®ä¾‹</a></li><li><a href=#index-æ–‡ä»¶åˆ†æ>Index æ–‡ä»¶åˆ†æ</a><ol><li><a href=#index-æ–‡ä»¶æ¦‚è§ˆ>Index æ–‡ä»¶æ¦‚è§ˆ</a></li><li><a href=#ç±»ä»‹ç»>ç±»ä»‹ç»</a><ol><li><a href=#subscriberinfo-ç»§æ‰¿å…³ç³»>SubscriberInfo ç»§æ‰¿å…³ç³»</a></li><li><a href=#subscribermethod>SubscriberMethod</a></li><li><a href=#subscribermethodinfo>SubscriberMethodInfo</a></li></ol></li><li><a href=#subscriberinfo-æ˜ å°„>SubscriberInfo æ˜ å°„</a></li></ol></li><li><a href=#register-æµç¨‹>register æµç¨‹</a><ol><li><a href=#subscribermethodfinderfindsubscribermethods>SubscriberMethodFinder.findSubscriberMethods()</a><ol><li><a href=#subscribermethodfinderfindusinginfo>SubscriberMethodFinder.findUsingInfo()</a><ol><li><a href=#subscribermethodfinderpreparefindstate>SubscriberMethodFinder.prepareFindState()</a></li><li><a href=#findstateinitforsubscriber>FindState.initForSubscriber()</a></li><li><a href=#subscribermethodfindergetsubscriberinfo>SubscriberMethodFinder.getSubscriberInfo()</a></li></ol></li><li><a href=#subscribermethodfinderfindusingreflection>SubscriberMethodFinder.findUsingReflection()</a></li></ol></li><li><a href=#eventbussubscribe>EventBus.subscribe()</a></li></ol></li><li><a href=#post-æµç¨‹>post æµç¨‹</a></li><li><a href=#unregister-æµç¨‹>unregister æµç¨‹</a></li><li><a href=#è·¨è¿›ç¨‹-eventbus>è·¨è¿›ç¨‹ EventBus</a><ol><li><a href=#ç®€å•å®ç°>ç®€å•å®ç°</a></li><li><a href=#ä½¿ç”¨ç¤ºä¾‹>ä½¿ç”¨ç¤ºä¾‹</a></li></ol></li></ol></li></ol></nav></details></aside><a href=#eventbus-ä½¿ç”¨åŠæºç åˆ†æ><h1 id=eventbus-ä½¿ç”¨åŠæºç åˆ†æ><span class=hanchor arialabel=Anchor># </span>EventBus ä½¿ç”¨åŠæºç åˆ†æ</h1></a><a href=#ä½¿ç”¨><h1 id=ä½¿ç”¨><span class=hanchor arialabel=Anchor># </span>ä½¿ç”¨</h1></a><ol><li>é¦–å…ˆå¼•å…¥ä¾èµ–</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>apply</span> <span class=nl>plugin:</span> <span class=s1>&#39;kotlin-kapt&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s1>&#39;org.greenrobot:eventbus:3.2.0&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>kapt</span> <span class=s1>&#39;org.greenrobot:eventbus-annotation-processor:3.2.0&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>kapt</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>arguments</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>arg</span><span class=o>(</span><span class=s1>&#39;eventBusIndex&#39;</span><span class=o>,</span> <span class=s1>&#39;com.me.guanpj.myapplication.MyEventBusIndex&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»åœ¨ 3.0 ç‰ˆæœ¬å¼€å§‹ï¼ŒEventBus æä¾›äº†ä¸€ä¸ª EventBusAnnotationProcessor æ³¨è§£å¤„ç†å™¨æ¥åœ¨ç¼–è¯‘æœŸé€šè¿‡è¯»å– @Subscribe æ³¨è§£ï¼Œå¹¶è§£æå’Œå¤„ç†å…¶ä¸­æ‰€åŒ…å«çš„ä¿¡æ¯ï¼Œç„¶åç”Ÿæˆ Java ç±»ç´¢å¼•æ¥ä¿å­˜è®¢é˜…è€…ä¸­æ‰€æœ‰çš„äº‹ä»¶å“åº”å‡½æ•°ï¼Œè¿™æ ·å°±æ¯”åœ¨è¿è¡Œæ—¶ä½¿ç”¨åå°„æ¥è·å¾—è®¢é˜…è€…ä¸­æ‰€æœ‰äº‹ä»¶å“åº”å‡½æ•°çš„é€Ÿåº¦è¦å¿«ã€‚</p><p>ä»¥ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹å¯¹ EventBus å„ä¸ªç‰ˆæœ¬æ€§èƒ½çš„å¯¹æ¯”å›¾ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒEventBus 3.x å¦‚æœæ²¡æœ‰ä½¿ç”¨ç´¢å¼•çš„è¯æ€§èƒ½ç›¸è¾ƒäºä¹‹å‰çš„ç‰ˆæœ¬æ˜¯å€’é€€çš„ã€‚ä½¿ç”¨ç´¢å¼•èƒ½è®© EventBus çš„æ€§èƒ½å¤§å¤§å¢åŠ ã€‚</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/EventBus/clipboard_20230323_031615.png width=auto alt></p><ol start=2><li>æ·»åŠ æ··æ·†è§„åˆ™ï¼š</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>-keepattributes *Annotation*
</span></span><span class=line><span class=cl>-keepclassmembers class * {
</span></span><span class=line><span class=cl>    @org.greenrobot.eventbus.Subscribe &lt;methods&gt;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>-keep enum org.greenrobot.eventbus.ThreadMode { *; }
</span></span><span class=line><span class=cl> # And if you use AsyncExecutor:
</span></span><span class=line><span class=cl>-keepclassmembers class * extends org.greenrobot.eventbus.util.ThrowableFailureEvent {
</span></span><span class=line><span class=cl>    &lt;init&gt;(java.lang.Throwable);
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>ä½¿ç”¨ç´¢å¼•æ–‡ä»¶åˆ›å»ºå…¨å±€ EventBus å®ä¾‹</li></ol><p>ç»è¿‡ä»¥ä¸Šé…ç½®ï¼Œå°±å¯ä»¥ä½¿ç”¨ç”Ÿæˆçš„ <code>com.me.guanpj.myapplication.MyEventBusIndex</code> åˆ›å»º EventBus äº†ã€‚</p><blockquote><p>æ³¨æ„ï¼šå¦‚æœé¡¹ç›®ä¸­æ²¡æœ‰è¢« @Subscribe æ ‡è®°çš„äº‹ä»¶æ¥æ”¶æ–¹æ³•ï¼Œ åˆ™ä¸ä¼šç”Ÿæˆç´¢å¼•ç±»ã€‚</p></blockquote><p>æ¨èåœ¨ Application ä¸­ä½¿ç”¨ç”Ÿæˆçš„ç´¢å¼•åˆ›å»ºå…¨å±€ EventBus å®ä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyApplication</span> <span class=p>:</span> <span class=n>Application</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>builder</span><span class=p>().</span><span class=n>addIndex</span><span class=p>(</span><span class=n>MyEventBusIndex</span><span class=p>()).</span><span class=n>installDefaultEventBus</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ ·åé¢é€šè¿‡ <code>EventBus.getDefault()</code> è·å–çš„ EventBus å®ä¾‹éƒ½æ˜¯åˆšæ‰é€šè¿‡ç´¢å¼•åˆ›å»ºçš„ã€‚</p><p>å¦‚æœæ—¢æœ‰ Library çš„ç´¢å¼•ï¼Œä¹Ÿæœ‰ App çš„ç´¢å¼•ï¼Œå¯ä»¥åœ¨ EventBus è®¾ç½®è¿‡ç¨‹ä¸­ä¸€èµ·æ·»åŠ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>EventBus</span><span class=p>.</span><span class=n>builder</span><span class=p>().</span><span class=n>addIndex</span><span class=p>(</span><span class=n>MyEventBusAppIndex</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addIndex</span><span class=p>(</span><span class=n>MyEventBusLibIndex</span><span class=p>()).</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>installDefaultEventBus</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“ç„¶ï¼Œå¦‚æœåœ¨æŸäº›æƒ…å†µä¸‹ä¸æƒ³ä½¿ç”¨å…¨å±€å®ä¾‹ï¼Œä¹Ÿå¯ä»¥å•ç‹¬ç”Ÿæˆä¸€ä¸ªå®ä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>eventBus</span> <span class=p>=</span> <span class=n>EventBus</span><span class=p>.</span><span class=n>builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// äº‹ä»¶æ¥æ”¶å¯¹è±¡æ˜¯å¦æœ‰å±‚æ¬¡ç»“æ„ï¼ˆé»˜è®¤ä¸º trueï¼Œè¶…ç±»ä¹Ÿå°†è¢«é€šçŸ¥ï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>eventInheritance</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¿½ç•¥ç´¢å¼•æ–‡ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>ignoreGeneratedIndex</span><span class=p>(</span><span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰“å°æ²¡æœ‰è®¢é˜…æ¶ˆæ¯ï¼Œé»˜è®¤ä¸º true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>logNoSubscriberMessages</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰“å°è®¢é˜…å¼‚å¸¸çš„æ¶ˆæ¯ï¼Œé»˜è®¤ä¸º true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>logSubscriberExceptions</span><span class=p>(</span><span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è®¾ç½®å‘é€çš„çš„äº‹ä»¶åœ¨æ²¡æœ‰è®¢é˜…è€…çš„æƒ…å†µæ—¶ï¼ŒEventBusæ˜¯å¦ä¿æŒé™é»˜ï¼Œé»˜è®¤ä¸º true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>sendNoSubscriberEvent</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å‘é€åˆ†å‘äº‹ä»¶çš„å¼‚å¸¸ï¼Œé»˜è®¤ä¸º true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>sendSubscriberExceptionEvent</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å¦‚æœ onEvent*** æ–¹æ³•å‡ºç°å¼‚å¸¸ï¼Œæ˜¯å¦å°†æ­¤å¼‚å¸¸åˆ†å‘ç»™è®¢é˜…è€…ï¼Œé»˜è®¤ä¸º false
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>throwSubscriberException</span><span class=p>(</span><span class=n>BuildConfig</span><span class=p>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ± ç”¨äºå¤„ç†åå°çº¿ç¨‹å’Œå¼‚æ­¥çº¿ç¨‹åˆ†å‘äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>executorService</span><span class=p>(</span><span class=n>Executors</span><span class=p>.</span><span class=n>newSingleThreadExecutor</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¯ç”¨ä¸¥æ ¼çš„æ–¹æ³•éªŒè¯ï¼ˆåœ¨ 3.0 ä»¥å‰ï¼Œæ¥æ”¶å¤„ç†äº‹ä»¶çš„æ–¹æ³•åå¿…é¡»ä»¥ onEvent å¼€å¤´ï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// é»˜è®¤ä¸º false
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>strictMethodVerification</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸ºç‰¹å®šæ—¶é—´è·³è¿‡æ–¹æ³•éªŒè¯ï¼ŒåŒ…æ‹¬æ–¹æ³•åã€é™å®šç¬¦
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>skipMethodVerificationFor</span><span class=p>(</span><span class=n>ButtonEvent</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>eventBus</span><span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>å®šä¹‰äº‹ä»¶</li></ol><p>æ–°å»ºä¸€ä¸ªå®ä½“ç±»ç”¨äºäº‹ä»¶çš„ä¼ é€’ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>package</span> <span class=nn>com.me.guanpj.myapplication.event</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>data</span> <span class=k>class</span> <span class=nc>MessageEvent</span><span class=p>(</span><span class=k>val</span> <span class=py>message</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>å‘é€å’Œæ¥æ”¶äº‹ä»¶</li></ol><p>åœ¨éœ€è¦æ¥æ”¶äº‹ä»¶çš„ Activityã€Fragment æˆ–è€…å…¶å®ƒåœ°æ–¹è°ƒç”¨ä¸€æ¬¡ <code>EventBus.getDefault().register(this)</code> è¿›è¡Œæ³¨å†Œï¼Œç„¶åä½¿ç”¨ <code>@Subscribe</code> æ³¨è§£æ ‡è®°æ¥æ”¶äº‹ä»¶çš„æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°ä¸ºä¸€ä¸ªå®ä½“ç±»ï¼Œæˆ–è€…åŸºæœ¬æ•°æ®ç±»å‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventBusActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>buttonClick</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>android</span><span class=p>.</span><span class=n>view</span><span class=p>.</span><span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//EventBus.getDefault().post(MessageEvent(&#34;click&#34;))
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>postSticky</span><span class=p>(</span><span class=n>MessageEvent</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>jump</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>AnotherActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>MAIN</span><span class=p>,</span> <span class=n>priority</span> <span class=p>=</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEvent</span><span class=p>(</span><span class=n>event</span> <span class=p>:</span> <span class=n>MessageEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;EventBusActivity onEvent receive msg: </span><span class=si>${event.message}</span><span class=s2> in thread: </span><span class=si>${Thread.currentThread().name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>BACKGROUND</span><span class=p>,</span> <span class=n>priority</span> <span class=p>=</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEvent1</span><span class=p>(</span><span class=n>event</span> <span class=p>:</span> <span class=n>MessageEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;EventBusActivity onEvent1 receive msg: </span><span class=si>${event.message}</span><span class=s2> in thread: </span><span class=si>${Thread.currentThread().name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>BACKGROUND</span><span class=p>,</span> <span class=n>priority</span> <span class=p>=</span> <span class=m>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEvent2</span><span class=p>(</span><span class=n>event</span> <span class=p>:</span> <span class=n>MessageEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;EventBusActivity onEvent2 receive msg: </span><span class=si>${event.message}</span><span class=s2> in thread: </span><span class=si>${Thread.currentThread().name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>AnotherActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_another</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>MAIN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEvent</span><span class=p>(</span><span class=n>event</span> <span class=p>:</span> <span class=n>MessageEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;AnotherActivity onEvent receive msg: </span><span class=si>${event.message}</span><span class=s2> in thread: </span><span class=si>${Thread.currentThread().name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç²˜æ€§äº‹ä»¶ä¸ä¼šè¢«æ¶ˆè€—ï¼Œé™¤éæ‰‹åŠ¨ç§»é™¤
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>removeStickyEvent</span><span class=p>(</span><span class=n>MessageEvent</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¯æ¬¡è¾“å‡ºçš„æ—¥å¿—éƒ½æ˜¯ä¸€æ ·çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>EventBusActivity onEvent receive msg: click in thread: main
</span></span><span class=line><span class=cl>EventBusActivity onEvent2 receive msg: click in thread: pool-2-thread-1
</span></span><span class=line><span class=cl>EventBusActivity onEvent1 receive msg: click in thread: pool-2-thread-1
</span></span><span class=line><span class=cl>//æ‰“å¼€ MainActivity å
</span></span><span class=line><span class=cl>AnotherActivity receive msg: click in thread: main
</span></span></code></pre></td></tr></table></div></div><a href=#åˆ†æ><h1 id=åˆ†æ><span class=hanchor arialabel=Anchor># </span>åˆ†æ</h1></a><a href=#è·å–-eventbus-å®ä¾‹><h2 id=è·å–-eventbus-å®ä¾‹><span class=hanchor arialabel=Anchor># </span>è·å– EventBus å®ä¾‹</h2></a><p>ä¸ç®¡æ˜¯ç”¨ <code>EventBus.getDefault()</code> è¿˜æ˜¯ <code>EventBus.builder()</code> éƒ½èƒ½å¤Ÿè·å–åˆ° EventBus å¯¹è±¡ï¼Œåªä¸è¿‡å‰è€…æ˜¯è·å–ä¸€ä¸ªå…¨å±€çš„å•ä¾‹ï¼Œåè€…æ˜¯ä½¿ç”¨ builder() é…ç½®å‡ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>EventBus</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>EventBusBuilder</span> <span class=n>DEFAULT_BUILDER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>EventBusBuilder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;&gt;</span> <span class=n>subscriptionsByEventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;&gt;</span> <span class=n>typesBySubscriber</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>stickyEvents</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>EventBus</span> <span class=nf>getDefault</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span> <span class=n>instance</span> <span class=o>=</span> <span class=n>defaultInstance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>instance</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>synchronized</span> <span class=o>(</span><span class=n>EventBus</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>instance</span> <span class=o>=</span> <span class=n>EventBus</span><span class=o>.</span><span class=na>defaultInstance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>instance</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>instance</span> <span class=o>=</span> <span class=n>EventBus</span><span class=o>.</span><span class=na>defaultInstance</span> <span class=o>=</span> <span class=k>new</span> <span class=n>EventBus</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>instance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>EventBusBuilder</span> <span class=nf>builder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>EventBusBuilder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>EventBus</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>(</span><span class=n>DEFAULT_BUILDER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>EventBus</span><span class=o>(</span><span class=n>EventBusBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>getLogger</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriptionsByEventType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>typesBySubscriber</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>stickyEvents</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mainThreadSupport</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>getMainThreadSupport</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>mainThreadPoster</span> <span class=o>=</span> <span class=n>mainThreadSupport</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>mainThreadSupport</span><span class=o>.</span><span class=na>createPoster</span><span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>backgroundPoster</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BackgroundPoster</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncPoster</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AsyncPoster</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>indexCount</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>subscriberInfoIndexes</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>builder</span><span class=o>.</span><span class=na>subscriberInfoIndexes</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>:</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriberMethodFinder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SubscriberMethodFinder</span><span class=o>(</span><span class=n>builder</span><span class=o>.</span><span class=na>subscriberInfoIndexes</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=o>.</span><span class=na>strictMethodVerification</span><span class=o>,</span> <span class=n>builder</span><span class=o>.</span><span class=na>ignoreGeneratedIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>logSubscriberExceptions</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>logSubscriberExceptions</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>logNoSubscriberMessages</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>logNoSubscriberMessages</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>sendSubscriberExceptionEvent</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>sendSubscriberExceptionEvent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>sendNoSubscriberEvent</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>sendNoSubscriberEvent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>throwSubscriberException</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>throwSubscriberException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>eventInheritance</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>eventInheritance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>executorService</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>executorService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹å‡ºï¼Œä¸¤ç§è·å–å¯¹è±¡çš„æ–¹å¼éƒ½ä¼šè°ƒç”¨åˆ° <code>EventBus(EventBusBuilder builder)</code> è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œ<code>getDefault()</code> åªæ˜¯æœ€ç»ˆä¼ å…¥äº†ä¸€ä¸ªç©ºçš„ <code>EventBusBuilder</code> å¯¹è±¡è€Œå·²ã€‚</p><p>åœ¨ <code>EventBus(EventBusBuilder builder)</code> æ„é€ æ–¹æ³•ä¸­ï¼š</p><p>åœ¨æ³¨é‡Š 1 å¤„ï¼Œåˆ›å»ºäº†ä¸€ä¸ª subscriptionsByEventType å¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ª HashMapï¼Œå¹¶ä¸”å…¶ key è¡¨ç¤º Event çš„ç±»å‹ï¼Œvalue ä¸º CopyOnWriteArrayList<subscription>ã€‚è¿™é‡Œçš„ Subscription æ˜¯ä¸€ä¸ªè®¢é˜…ä¿¡æ¯å¯¹è±¡ï¼Œå®ƒé‡Œé¢ä¿å­˜äº†ä¸¤ä¸ªé‡è¦çš„å­—æ®µï¼Œä¸€ä¸ªæ˜¯ç±»å‹ä¸º Object çš„ subscriberï¼Œè¯¥å­—æ®µå³ä¸ºæ³¨å†Œçš„å¯¹è±¡ï¼ˆåœ¨ Android ä¸­æ—¶é€šå¸¸æ˜¯ Activity æˆ–ç€ Fragment å¯¹è±¡ï¼‰ï¼›å¦ä¸€ä¸ªæ˜¯ç±»å‹ä¸º SubscriberMethod çš„å®ä¾‹ï¼Œå®ƒå°±æ˜¯è¢« @Subscribe æ³¨è§£çš„é‚£ä¸ªè®¢é˜…æ–¹æ³•ï¼Œé‡Œé¢ä¿å­˜äº†ä¸€ä¸ªé‡è¦çš„å­—æ®µï¼ševentTypeï¼Œå®ƒçš„ç±»å‹ä¸º Classï¼Œè¡¨ç¤º Event çš„ç±»å‹ã€‚</p><p>åœ¨æ³¨é‡Š 2 å¤„ï¼Œæ–°å»ºäº†ä¸€ä¸ªç±»å‹ä¸º HashMap çš„ typesBySubscriber å¯¹è±¡ï¼Œå®ƒçš„ key ä¸º subscriber å¯¹è±¡ï¼Œ value ä¸º subscriber å¯¹è±¡ä¸­æ‰€æœ‰çš„ Event ç±»å‹ Listï¼Œæ—¥å¸¸ä½¿ç”¨ä¸­ä»…ç”¨äºåˆ¤æ–­æŸä¸ªå¯¹è±¡æ˜¯å¦æ³¨å†Œè¿‡ã€‚</p><p>åœ¨æ³¨é‡Š 3 å¤„æ–°å»ºäº†ä¸€ä¸ªç±»å‹ä¸º ConcurrentHashMap çš„ stickyEvents å¯¹è±¡ï¼Œä¸“ç”¨äºç²˜æ€§äº‹ä»¶å¤„ç†çš„ï¼Œkey åŒæ ·ä¸º Event çš„ç±»å‹ï¼Œvalue ä¸ºå½“å‰çš„äº‹ä»¶ã€‚</p><blockquote><p>æ™®é€šäº‹ä»¶æ˜¯å…ˆæ³¨å†Œï¼Œç„¶åå‘é€äº‹ä»¶æ‰èƒ½æ”¶åˆ°ï¼›è€Œç²˜æ€§äº‹ä»¶åœ¨å‘é€äº‹ä»¶ä¹‹åå†è®¢é˜…ä¹Ÿèƒ½æ”¶åˆ°ã€‚å¹¶ä¸”ï¼Œç²˜æ€§äº‹ä»¶ä¼šä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ¯æ¬¡è¿›å…¥éƒ½ä¼šå»å†…å­˜ä¸­æŸ¥æ‰¾è·å–æœ€æ–°çš„ç²˜æ€§äº‹ä»¶ï¼Œé™¤éæ‰‹åŠ¨ç§»é™¤äº‹ä»¶ã€‚</p></blockquote><p>åœ¨æ³¨é‡Š 4 å¤„ï¼Œæ–°å»ºäº†ä¸‰ä¸ªä¸åŒç±»å‹çš„äº‹ä»¶å‘é€å™¨ï¼š</p><ul><li>mainThreadPosterï¼šä¸»çº¿ç¨‹äº‹ä»¶å‘é€å™¨ï¼Œé€šè¿‡å®ƒçš„ <code>mainThreadPoster.enqueue(subscription, event)</code> æ–¹æ³•å¯ä»¥å°†è®¢é˜…ä¿¡æ¯å’Œå¯¹åº”çš„äº‹ä»¶è¿›è¡Œå…¥é˜Ÿï¼Œç„¶åé€šè¿‡ handler å»å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œåœ¨ handler çš„ <code>handleMessage()</code> ä¸­å»æ‰§è¡Œæ–¹æ³•ã€‚</li><li>backgroundPosterï¼šåå°äº‹ä»¶å‘é€å™¨ï¼Œé€šè¿‡å®ƒçš„ <code>enqueue()</code> å°†æ–¹æ³•åŠ å…¥åˆ°åå°çš„ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæœ€åé€šè¿‡çº¿ç¨‹æ± å»æ‰§è¡Œï¼ŒåŒæ—¶å®ƒä¿è¯ä»»ä¸€æ—¶é—´åªä¸”ä»…èƒ½æœ‰ä¸€ä¸ªä»»åŠ¡ä¼šè¢«çº¿ç¨‹æ± æ‰§è¡Œã€‚</li><li>asyncPosterï¼šå®ç°é€»è¾‘ç±»ä¼¼äº backgroundPosterï¼Œä¸åŒäº backgroundPoster çš„ä¿è¯ä»»ä¸€æ—¶é—´åªä¸”ä»…èƒ½æœ‰ä¸€ä¸ªä»»åŠ¡ä¼šè¢«çº¿ç¨‹æ± æ‰§è¡Œçš„ç‰¹æ€§ï¼ŒasyncPoster åˆ™æ˜¯å¼‚æ­¥è¿è¡Œçš„ï¼Œå¯ä»¥åŒæ—¶æ¥æ”¶å¤šä¸ªä»»åŠ¡ã€‚</li></ul><p>å†çœ‹æ³¨é‡Š 5 è¿™è¡Œä»£ç ï¼Œè¿™é‡Œæ–°å»ºäº†ä¸€ä¸ª SubscriberMethodFinder å¯¹è±¡ï¼Œè¿™æ˜¯ä» EventBus ä¸­æŠ½ç¦»å‡ºçš„è®¢é˜…æ–¹æ³•æŸ¥è¯¢çš„ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ä¼˜ç§€çš„æºç ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸èƒ½çœ‹åˆ°<strong>ç»„åˆä¼˜äºç»§æ‰¿</strong>çš„è¿™ç§å®ç°æ€æƒ³ã€‚</p><p>åœ¨æ³¨é‡Š 6 å¤„ï¼Œä» builder ä¸­å–å‡ºäº†ä¸€ä¸ªé»˜è®¤çš„çº¿ç¨‹æ± å¯¹è±¡ï¼Œå®ƒç”± <strong>Executors çš„ newCachedThreadPool() æ–¹æ³•åˆ›å»ºï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ‰åˆ™ç”¨ã€æ— åˆ™åˆ›å»ºã€æ— æ•°é‡ä¸Šé™</strong>çš„çº¿ç¨‹æ± ã€‚</p><a href=#index-æ–‡ä»¶åˆ†æ><h2 id=index-æ–‡ä»¶åˆ†æ><span class=hanchor arialabel=Anchor># </span>Index æ–‡ä»¶åˆ†æ</h2></a><a href=#index-æ–‡ä»¶æ¦‚è§ˆ><h3 id=index-æ–‡ä»¶æ¦‚è§ˆ><span class=hanchor arialabel=Anchor># </span>Index æ–‡ä»¶æ¦‚è§ˆ</h3></a><p>ç”Ÿæˆçš„ç´¢å¼•ç±»å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MyEventBusIndex</span> <span class=kd>implements</span> <span class=n>SubscriberInfoIndex</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>SubscriberInfo</span><span class=o>&gt;</span> <span class=n>SUBSCRIBER_INDEX</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SUBSCRIBER_INDEX</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>SubscriberInfo</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>putIndex</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleSubscriberInfo</span><span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>EventBusActivity</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>[]</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>(</span><span class=s>&#34;onEvent&#34;</span><span class=o>,</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>MessageEvent</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>ThreadMode</span><span class=o>.</span><span class=na>MAIN</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>(</span><span class=s>&#34;onEvent1&#34;</span><span class=o>,</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>MessageEvent</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>ThreadMode</span><span class=o>.</span><span class=na>BACKGROUND</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=kc>false</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>(</span><span class=s>&#34;onEvent2&#34;</span><span class=o>,</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>MessageEvent</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>ThreadMode</span><span class=o>.</span><span class=na>BACKGROUND</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=kc>false</span><span class=o>),</span>
</span></span><span class=line><span class=cl>        <span class=o>}));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>putIndex</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleSubscriberInfo</span><span class=o>(</span><span class=n>MainActivity</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>[]</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>(</span><span class=s>&#34;onEvent3&#34;</span><span class=o>,</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>MessageEvent</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>ThreadMode</span><span class=o>.</span><span class=na>MAIN</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>3</span><span class=o>,</span> <span class=kc>true</span><span class=o>),</span>
</span></span><span class=line><span class=cl>        <span class=o>}));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>putIndex</span><span class=o>(</span><span class=n>SubscriberInfo</span> <span class=n>info</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SUBSCRIBER_INDEX</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>info</span><span class=o>.</span><span class=na>getSubscriberClass</span><span class=o>(),</span> <span class=n>info</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>SubscriberInfo</span> <span class=nf>getSubscriberInfo</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SubscriberInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>SUBSCRIBER_INDEX</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>info</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>info</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#ç±»ä»‹ç»><h3 id=ç±»ä»‹ç»><span class=hanchor arialabel=Anchor># </span>ç±»ä»‹ç»</h3></a><a href=#subscriberinfo-ç»§æ‰¿å…³ç³»><h4 id=subscriberinfo-ç»§æ‰¿å…³ç³»><span class=hanchor arialabel=Anchor># </span>SubscriberInfo ç»§æ‰¿å…³ç³»</h4></a><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ–°å»ºäº†ä¸€ä¸ª Map é›†åˆï¼Œç”¨äºå­˜æ”¾äº‹ä»¶è®¢é˜…ç±»å’Œå®ƒä»¬çš„è®¢é˜…æ–¹æ³•</p><p><code>SubscriberInfo</code> ä¹‹é—´çš„æ˜ å°„ã€‚<code>SubscriberInfo</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>SubscriberInfo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>getSubscriberClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=nf>getSubscriberMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SubscriberInfo</span> <span class=nf>getSuperSubscriberInfo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=nf>shouldCheckSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œ <code>SubscriberInfo</code> çš„å®ç°ç±»ä¸º <code>SimpleSubscriberInfo</code>ï¼Œè€Œä¸­é—´è¿˜æœ‰ä¸€ä¸ª <code>AbstractSubscriberInfo</code>ï¼Œå®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>AbstractSubscriberInfo</span> <span class=kd>implements</span> <span class=n>SubscriberInfo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>SubscriberInfo</span><span class=o>&gt;</span> <span class=n>superSubscriberInfoClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>shouldCheckSuperclass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=nf>AbstractSubscriberInfo</span><span class=o>(</span><span class=n>Class</span> <span class=n>subscriberClass</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>SubscriberInfo</span><span class=o>&gt;</span> <span class=n>superSubscriberInfoClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                     <span class=kt>boolean</span> <span class=n>shouldCheckSuperclass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>subscriberClass</span> <span class=o>=</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>superSubscriberInfoClass</span> <span class=o>=</span> <span class=n>superSubscriberInfoClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>shouldCheckSuperclass</span> <span class=o>=</span> <span class=n>shouldCheckSuperclass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Class</span> <span class=nf>getSubscriberClass</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>SubscriberInfo</span> <span class=nf>getSuperSubscriberInfo</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=n>superSubscriberInfoClass</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>superSubscriberInfoClass</span><span class=o>.</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InstantiationException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IllegalAccessException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>shouldCheckSuperclass</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>shouldCheckSuperclass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>SubscriberMethod</span> <span class=nf>createSubscriberMethod</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>createSubscriberMethod</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>ThreadMode</span><span class=o>.</span><span class=na>POSTING</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>SubscriberMethod</span> <span class=nf>createSubscriberMethod</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>createSubscriberMethod</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>SubscriberMethod</span> <span class=nf>createSubscriberMethod</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>,</span><span class=kt>int</span> <span class=n>priority</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Method</span> <span class=n>method</span> <span class=o>=</span> <span class=n>subscriberClass</span><span class=o>.</span><span class=na>getDeclaredMethod</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>SubscriberMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span> <span class=n>priority</span><span class=o>,</span> <span class=n>sticky</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchMethodException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Could not find subscriber method in &#34;</span> <span class=o>+</span> <span class=n>subscriberClass</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;. Maybe a missing ProGuard rule?&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SimpleSubscriberInfo</span> <span class=kd>extends</span> <span class=n>AbstractSubscriberInfo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>SubscriberMethodInfo</span><span class=o>[]</span> <span class=n>methodInfos</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SimpleSubscriberInfo</span><span class=o>(</span><span class=n>Class</span> <span class=n>subscriberClass</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>shouldCheckSuperclass</span><span class=o>,</span> <span class=n>SubscriberMethodInfo</span><span class=o>[]</span> <span class=n>methodInfos</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>shouldCheckSuperclass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>methodInfos</span> <span class=o>=</span> <span class=n>methodInfos</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=nf>getSubscriberMethods</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>methodInfos</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=n>methods</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SubscriberMethod</span><span class=o>[</span><span class=n>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberMethodInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>methodInfos</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=n>methods</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>createSubscriberMethod</span><span class=o>(</span><span class=n>info</span><span class=o>.</span><span class=na>methodName</span><span class=o>,</span> <span class=n>info</span><span class=o>.</span><span class=na>eventType</span><span class=o>,</span> <span class=n>info</span><span class=o>.</span><span class=na>threadMode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>info</span><span class=o>.</span><span class=na>priority</span><span class=o>,</span> <span class=n>info</span><span class=o>.</span><span class=na>sticky</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>methods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#subscribermethod><h4 id=subscribermethod><span class=hanchor arialabel=Anchor># </span>SubscriberMethod</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SubscriberMethod</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Method</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** Used for efficient comparison */</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>methodString</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SubscriberMethod</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>,</span> <span class=kt>int</span> <span class=n>priority</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>method</span> <span class=o>=</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>threadMode</span> <span class=o>=</span> <span class=n>threadMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>eventType</span> <span class=o>=</span> <span class=n>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>sticky</span> <span class=o>=</span> <span class=n>sticky</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>other</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>other</span> <span class=o>==</span> <span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>other</span> <span class=k>instanceof</span> <span class=n>SubscriberMethod</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>checkMethodString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberMethod</span> <span class=n>otherSubscriberMethod</span> <span class=o>=</span> <span class=o>(</span><span class=n>SubscriberMethod</span><span class=o>)</span><span class=n>other</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>otherSubscriberMethod</span><span class=o>.</span><span class=na>checkMethodString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Don&#39;t use method.equals because of http://code.google.com/p/android/issues/detail?id=7811#c6
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=n>methodString</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>otherSubscriberMethod</span><span class=o>.</span><span class=na>methodString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>checkMethodString</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>methodString</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Method.toString has more overhead, just take relevant parts of the method
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>StringBuilder</span> <span class=n>builder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>64</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;#&#39;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;(&#39;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>eventType</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>methodString</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>method</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#subscribermethodinfo><h4 id=subscribermethodinfo><span class=hanchor arialabel=Anchor># </span>SubscriberMethodInfo</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SubscriberMethodInfo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>String</span> <span class=n>methodName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SubscriberMethodInfo</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>,</span> <span class=kt>int</span> <span class=n>priority</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>methodName</span> <span class=o>=</span> <span class=n>methodName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>threadMode</span> <span class=o>=</span> <span class=n>threadMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>eventType</span> <span class=o>=</span> <span class=n>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>sticky</span> <span class=o>=</span> <span class=n>sticky</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SubscriberMethodInfo</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>ThreadMode</span><span class=o>.</span><span class=na>POSTING</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SubscriberMethodInfo</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#subscriberinfo-æ˜ å°„><h3 id=subscriberinfo-æ˜ å°„><span class=hanchor arialabel=Anchor># </span>SubscriberInfo æ˜ å°„</h3></a><p>å›åˆ° <code>MyEventBusIndex</code> çš„ static ä»£ç å—ï¼Œå¯¹äºæ¯ä¸€ä¸ªè°ƒç”¨è¿‡ <code>EventBus.register()</code> æ–¹æ³•çš„ç±»ï¼ŒAPTï¼ˆAnnotation Processing Toolï¼‰éƒ½ä¼šä¸ºå®ƒç”Ÿæˆä¸€è¡Œ <code>putIndex(...)</code> ä»£ç ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªæ–°å»ºçš„ <code>SimpleSubscriberInfo</code> å¯¹è±¡ã€‚</p><p>åœ¨ <code>putIndex()</code> æ–¹æ³•ä¸­ä¼šè°ƒç”¨ä¼ å…¥çš„ <code>SimpleSubscriberInfo.getSubscriberClass()</code> è·å–åˆ°è®¢é˜…ç±»çš„ Class å¯¹è±¡ä½œä¸º keyï¼ŒåŒæ—¶æŠŠè‡ªèº«ä½œä¸º value å­˜æ”¾è¿› Map ä¸­ã€‚</p><a href=#register-æµç¨‹><h2 id=register-æµç¨‹><span class=hanchor arialabel=Anchor># </span>register æµç¨‹</h2></a><p>å…ˆçœ‹ <code>EventBus.register</code> æ–¹æ³•ï¼Œåœ¨åˆ†æè¿‡ç¨‹ä¸­é‡åˆ°çš„å­—æ®µå†å›è¿‡å¤´æ¥åˆ†æã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>register</span><span class=o>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å– subscriber çš„ Class å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span> <span class=o>=</span> <span class=n>subscriber</span><span class=o>.</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ® Class ä¿¡æ¯è·å–åˆ°æ‰€æœ‰åŠ äº† @Subscribe çš„äº‹ä»¶å›è°ƒæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>subscriberMethodFinder</span><span class=o>.</span><span class=na>findSubscriberMethods</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// éå†å„ä¸ªæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span> <span class=o>:</span> <span class=n>subscriberMethods</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// æ‰§è¡Œè®¢é˜…æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>subscribe</span><span class=o>(</span><span class=n>subscriber</span><span class=o>,</span> <span class=n>subscriberMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„ä»£ç å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œ2~3 è¡Œå®Œæˆäº†è·å–æ³¨å†Œå¯¹è±¡ä¸­åŠ äº† <code>@Subscribe</code> çš„äº‹ä»¶å›è°ƒæ–¹æ³•ï¼Œåé¢çš„ä»£ç çœŸæ­£å®Œæˆäº†æ³¨å†Œã€‚</p><a href=#subscribermethodfinderfindsubscribermethods><h3 id=subscribermethodfinderfindsubscribermethods><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.findSubscriberMethods()</h3></a><p><code>subscriberMethodFinder</code> åœ¨ EventBus åˆ›å»ºçš„æ—¶å€™å°±å·²ç»ç¡®å®šäº†ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SubscriberMethodFinder</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>BRIDGE</span> <span class=o>=</span> <span class=n>0x40</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SYNTHETIC</span> <span class=o>=</span> <span class=n>0x1000</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MODIFIERS_IGNORE</span> <span class=o>=</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>ABSTRACT</span> <span class=o>|</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>STATIC</span> <span class=o>|</span> <span class=n>BRIDGE</span> <span class=o>|</span> <span class=n>SYNTHETIC</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;&gt;</span> <span class=n>METHOD_CACHE</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberInfoIndex</span><span class=o>&gt;</span> <span class=n>subscriberInfoIndexes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>strictMethodVerification</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>ignoreGeneratedIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>POOL_SIZE</span> <span class=o>=</span> <span class=n>4</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>FindState</span><span class=o>[]</span> <span class=n>FIND_STATE_POOL</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FindState</span><span class=o>[</span><span class=n>POOL_SIZE</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SubscriberMethodFinder</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberInfoIndex</span><span class=o>&gt;</span> <span class=n>subscriberInfoIndexes</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>strictMethodVerification</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                           <span class=kt>boolean</span> <span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>subscriberInfoIndexes</span> <span class=o>=</span> <span class=n>subscriberInfoIndexes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>strictMethodVerification</span> <span class=o>=</span> <span class=n>strictMethodVerification</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>ignoreGeneratedIndex</span> <span class=o>=</span> <span class=n>ignoreGeneratedIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findSubscriberMethods</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethods</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingReflection</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingInfo</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethods</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Subscriber &#34;</span> <span class=o>+</span> <span class=n>subscriberClass</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=s>&#34; and its super classes have no public methods with the @Subscribe annotation&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>,</span> <span class=n>subscriberMethods</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingInfo</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>findState</span><span class=o>.</span><span class=na>initForSubscriber</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>=</span> <span class=n>getSubscriberInfo</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=n>array</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSubscriberMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span> <span class=o>:</span> <span class=n>array</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>checkAdd</span><span class=o>(</span><span class=n>subscriberMethod</span><span class=o>.</span><span class=na>method</span><span class=o>,</span> <span class=n>subscriberMethod</span><span class=o>.</span><span class=na>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>subscriberMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>findState</span><span class=o>.</span><span class=na>moveToSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>getMethodsAndRelease</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>findState</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>POOL_SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>findState</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>FindState</span> <span class=nf>prepareFindState</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>POOL_SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>FindState</span> <span class=n>state</span> <span class=o>=</span> <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>state</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>state</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>FindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>SubscriberInfo</span> <span class=nf>getSubscriberInfo</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSuperSubscriberInfo</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberInfo</span> <span class=n>superclassInfo</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSuperSubscriberInfo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>==</span> <span class=n>superclassInfo</span><span class=o>.</span><span class=na>getSubscriberClass</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>superclassInfo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>subscriberInfoIndexes</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberInfoIndex</span> <span class=n>index</span> <span class=o>:</span> <span class=n>subscriberInfoIndexes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>SubscriberInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=na>getSubscriberInfo</span><span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>info</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>info</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingReflection</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>findState</span><span class=o>.</span><span class=na>initForSubscriber</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>findState</span><span class=o>.</span><span class=na>moveToSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Method</span><span class=o>[]</span> <span class=n>methods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// This is faster than getMethods, especially when subscribers are fat classes like Activities
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getDeclaredMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>th</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>LinkageError</span> <span class=n>error</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// super class of NoClassDefFoundError to be a bit more broad...
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>String</span> <span class=n>msg</span> <span class=o>=</span> <span class=s>&#34;Could not inspect methods of &#34;</span> <span class=o>+</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>msg</span> <span class=o>+=</span> <span class=s>&#34;. Please consider using EventBus annotation processor to avoid reflection.&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>msg</span> <span class=o>+=</span> <span class=s>&#34;. Please make this class visible to EventBus annotation processor to avoid reflection.&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>error</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>findState</span><span class=o>.</span><span class=na>skipSuperClasses</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Method</span> <span class=n>method</span> <span class=o>:</span> <span class=n>methods</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>modifiers</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>PUBLIC</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>MODIFIERS_IGNORE</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>parameterTypes</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span> <span class=o>==</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Subscribe</span> <span class=n>subscribeAnnotation</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getAnnotation</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>subscribeAnnotation</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>=</span> <span class=n>parameterTypes</span><span class=o>[</span><span class=n>0</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>checkAdd</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>ThreadMode</span> <span class=n>threadMode</span> <span class=o>=</span> <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>threadMode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>SubscriberMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                    <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>priority</span><span class=o>(),</span> <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>sticky</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span> <span class=o>+</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;@Subscribe method &#34;</span> <span class=o>+</span> <span class=n>methodName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                            <span class=s>&#34;must have exactly 1 parameter but has &#34;</span> <span class=o>+</span> <span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span> <span class=o>+</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=n>methodName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34; is a illegal @Subscribe method: must be public, non-static, and non-abstract&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kt>void</span> <span class=nf>clearCaches</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>FindState</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>anyMethodByEventType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Class</span><span class=o>&gt;</span> <span class=n>subscriberClassByMethodKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>StringBuilder</span> <span class=n>methodKeyBuilder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>128</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>skipSuperClasses</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>SubscriberInfo</span> <span class=n>subscriberInfo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=nf>initForSubscriber</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>subscriberClass</span> <span class=o>=</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>skipSuperClasses</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberInfo</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=nf>recycle</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberMethods</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>anyMethodByEventType</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberClassByMethodKey</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>setLength</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberClass</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>clazz</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>skipSuperClasses</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberInfo</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=nf>checkAdd</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 2 level check: 1st level with event type only (fast), 2nd level with complete signature when required.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// Usually a subscriber doesn&#39;t have methods listening to the same event type.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Object</span> <span class=n>existing</span> <span class=o>=</span> <span class=n>anyMethodByEventType</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>eventType</span><span class=o>,</span> <span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>existing</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>existing</span> <span class=k>instanceof</span> <span class=n>Method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(!</span><span class=n>checkAddWithMethodSignature</span><span class=o>((</span><span class=n>Method</span><span class=o>)</span> <span class=n>existing</span><span class=o>,</span> <span class=n>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// Paranoia check
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// Put any non-Method object to &#34;consume&#34; the existing Method
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>anyMethodByEventType</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>eventType</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>checkAddWithMethodSignature</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>checkAddWithMethodSignature</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>setLength</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;&gt;&#39;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>eventType</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>methodKey</span> <span class=o>=</span> <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>methodClass</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>methodClassOld</span> <span class=o>=</span> <span class=n>subscriberClassByMethodKey</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>methodKey</span><span class=o>,</span> <span class=n>methodClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>methodClassOld</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>methodClassOld</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>methodClass</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Only add if not already found in a sub class
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Revert the put, old class is further down the class hierarchy
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>subscriberClassByMethodKey</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>methodKey</span><span class=o>,</span> <span class=n>methodClassOld</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=nf>moveToSuperclass</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>skipSuperClasses</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>clazz</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>clazz</span> <span class=o>=</span> <span class=n>clazz</span><span class=o>.</span><span class=na>getSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>String</span> <span class=n>clazzName</span> <span class=o>=</span> <span class=n>clazz</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Skip system classes, this degrades performance.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// Also we might avoid some ClassNotFoundException (see FAQ for background).
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>clazzName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;java.&#34;</span><span class=o>)</span> <span class=o>||</span> <span class=n>clazzName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;javax.&#34;</span><span class=o>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                        <span class=n>clazzName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;android.&#34;</span><span class=o>)</span> <span class=o>||</span> <span class=n>clazzName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;androidx.&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>clazz</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨å®ƒçš„æ„é€ æ–¹æ³•é‡Œï¼Œ<code>subscriberInfoIndexes</code> é‡Œé¢åªæœ‰æ³¨è§£è§£é‡Šå™¨ç”Ÿæˆçš„ <code>MyEventBusIndex</code> å¯¹è±¡ï¼Œå…¶ä»–ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯é»˜è®¤å€¼ falseã€‚</p><p>å…ˆçœ‹çœ‹ <code>findSubscriberMethods(subscriberClass)</code> æ˜¯å¦‚ä½•å®Œæˆ <code>@Subscribe</code> æ–¹æ³•çš„è§£æçš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findSubscriberMethods</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1ã€å¦‚æœèƒ½è·å–ç¼“å­˜ï¼Œç›´æ¥è¿”å›
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethods</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2ã€åˆ¤æ–­æ˜¯å¦å¿½ç•¥ç´¢å¼•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ä½¿ç”¨åå°„æ¥è·å–äº‹ä»¶å›è°ƒæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingReflection</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å°è¯•ä»ç´¢å¼•æ–‡ä»¶è·å–äº‹ä»¶å›è°ƒæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingInfo</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethods</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Subscriber &#34;</span> <span class=o>+</span> <span class=n>subscriberClass</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34; and its super classes have no public methods with the @Subscribe annotation&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3ã€å†™å…¥ç¼“å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>,</span> <span class=n>subscriberMethods</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ³¨é‡Š 1 å¤„æ˜¯å–ç¼“å­˜çš„æ“ä½œã€‚é¡µé¢çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½ä¼šé¢‘ç¹å‘ç”Ÿå˜åŒ–ï¼Œå› è€Œå°±å¯èƒ½å¯¼è‡´äº‹ä»¶çš„é¢‘ç¹æ³¨å†Œã€æ³¨é”€ï¼Œè¿™æ—¶å€™ç¼“å­˜å°±éå¸¸æœ‰ç”¨äº†ã€‚</p><p>æ³¨é‡Š 2 å¤„ï¼Œç”±äº <code>ignoreGeneratedIndex</code> é»˜è®¤ä¸º falseï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ‰§è¡Œ <code>findUsingInfo</code> æ–¹æ³•æ¥è·å–è®¢é˜…ç±»çš„å›è°ƒæ–¹æ³•ã€‚</p><p>æ³¨é‡Š 3 åœ¨æ–¹æ³•æœ€åè¿”å›ä¹‹å‰ï¼Œä¼šè¿›è¡Œç¼“å­˜çš„æ›´æ–°ã€‚</p><p>å…ˆåˆ†æä¸€ä¸‹ <code>findUsingInfo</code> æ–¹æ³•ã€‚</p><a href=#subscribermethodfinderfindusinginfo><h4 id=subscribermethodfinderfindusinginfo><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.findUsingInfo()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingInfo</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>findState</span><span class=o>.</span><span class=na>initForSubscriber</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¼€å¯å¾ªç¯
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è·å–ç›®æ ‡æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>=</span> <span class=n>getSubscriberInfo</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=n>array</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSubscriberMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span> <span class=o>:</span> <span class=n>array</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>checkAdd</span><span class=o>(</span><span class=n>subscriberMethod</span><span class=o>.</span><span class=na>method</span><span class=o>,</span> <span class=n>subscriberMethod</span><span class=o>.</span><span class=na>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>subscriberMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åœ¨çˆ¶ç±»ä¸­æŸ¥æ‰¾ç›®æ ‡æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>findState</span><span class=o>.</span><span class=na>moveToSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#subscribermethodfinderpreparefindstate><h5 id=subscribermethodfinderpreparefindstate><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.prepareFindState()</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>FindState</span> <span class=nf>prepareFindState</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>POOL_SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>FindState</span> <span class=n>state</span> <span class=o>=</span> <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>state</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>state</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>FindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é€šè¿‡ <code>prepareFindState()</code> æ–¹æ³•å°è¯•ä»å¯¹è±¡æ± ä¸­è·å–ä¸€ä¸ª <code>FindState</code> å¯¹è±¡ï¼Œè‹¥å¯¹è±¡æ± ä¸­æ²¡æœ‰å¯ç”¨çš„å¯¹è±¡ï¼Œåˆ™æ–°å»ºä¸€ä¸ªã€‚</p><a href=#findstateinitforsubscriber><h5 id=findstateinitforsubscriber><span class=hanchor arialabel=Anchor># </span>FindState.initForSubscriber()</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>initForSubscriber</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>subscriberClass</span> <span class=o>=</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>skipSuperClasses</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>subscriberInfo</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åˆå§‹åŒ– <code>FindState</code> å¯¹è±¡ï¼Œä½¿å…¶å†…éƒ¨çš„ <code>subscriberClass</code>ã€<code>clazz</code> éƒ½æ˜¯è®¢é˜…ç±»ï¼Œå¹¶ä¸”æ³¨æ„è¿™æ—¶å€™ <code>subscriberInfo = null</code>ã€<code>skipSuperClasses = false</code>ã€‚</p><p>æ¥ç€æŸ¥çœ‹ <code>getSubscriberInfo()</code> æ–¹æ³•ï¼š</p><a href=#subscribermethodfindergetsubscriberinfo><h5 id=subscribermethodfindergetsubscriberinfo><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.getSubscriberInfo()</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>SubscriberInfo</span> <span class=nf>getSubscriberInfo</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSuperSubscriberInfo</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SubscriberInfo</span> <span class=n>superclassInfo</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSuperSubscriberInfo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>==</span> <span class=n>superclassInfo</span><span class=o>.</span><span class=na>getSubscriberClass</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>superclassInfo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriberInfoIndexes</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberInfoIndex</span> <span class=n>index</span> <span class=o>:</span> <span class=n>subscriberInfoIndexes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=na>getSubscriberInfo</span><span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>info</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>info</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé¦–å…ˆä¼šé€šè¿‡ FindState å»çˆ¶ç±»ä¸­ã€‚ã€‚ã€‚</p><p>ä½†æ˜¯è¿™é‡Œ <code>findState.subscriberInfo</code> æ˜¯ä¸º null çš„ï¼Œå› æ­¤ä¸æ»¡è¶³æ¡ä»¶ï¼Œæ¥ä¸‹æ¥ä¼šåˆ¤æ–­ subscriberInfoIndexesï¼ˆæœ¬ä¾‹ä¸­åªåŒ…å«åˆ›å»º EventBus å¯¹è±¡æ—¶ä¼ å…¥çš„ MyEventBusIndex å¯¹è±¡ï¼‰é›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºå°±ä¼šé€šè¿‡ Index ç±»å»æŸ¥æ‰¾ç›®æ ‡æ–¹æ³•ã€‚</p><p>å†æ¬¡å›åˆ° <code>findUsingInfo()</code> æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®æ ‡å›è°ƒæ–¹æ³•ï¼Œä¹Ÿä¼šè°ƒç”¨ <code>findUsingReflectionInSingleClass()</code> ä½¿ç”¨æ¥è·å–å›è°ƒæ–¹æ³•ã€‚å› æ­¤ï¼Œ<code>findUsingInfo()</code> ç­‰äºæ˜¯ <code>findUsingReflection()</code> æ–¹æ³•çš„åŠ å¼ºç‰ˆæœ¬ã€‚</p><p>åé¢çš„ while å¾ªç¯å°±æ˜¯ä»å½“å‰çš„è®¢é˜…ç±»å¼€å§‹ï¼Œä¸€ç›´å‘çˆ¶ç±»è¿›è¡Œå¾ªç¯æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>è¿™é‡Œä¼šè§£æå½“å‰è®¢é˜…ç±»çš„çˆ¶ç±»é‡Œé¢çš„æ–¹æ³•</strong>ã€‚</p><p>å¦‚æœæ‰¾åˆ°ç›®æ ‡å›è°ƒæ–¹æ³•ï¼Œåœ¨é€šè¿‡ <code>findState.checkAdd()</code> æ ¡éªŒä¹‹åï¼Œäº‹ä»¶å›è°ƒæ–¹æ³•éƒ½è¢«åŠ å…¥åˆ°äº† <code>findState.subscriberMethods</code> ä¸­ï¼Œç„¶åç”± <code>getMethodsAndRelease(findState)</code> æ–¹æ³•è¿”å›ã€‚<code>getMethodsAndRelease()</code> æ–¹æ³•å°±æ˜¯å°† <code>findState.subscriberMethods</code> å¤åˆ¶äº†å‡ºæ¥ï¼Œç„¶åå›æ”¶äº† FindState å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>getMethodsAndRelease</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>findState</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>synchronized</span><span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>POOL_SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>findState</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆä¼šä» findState ä¸­å–å‡ºäº†ä¿å­˜çš„ subscriberMethodsï¼›ç„¶åå°† findState é‡Œçš„ä¿å­˜çš„æ‰€æœ‰å¯¹è±¡è¿›è¡Œå›æ”¶ï¼›æ¥ç€ä¼šæŠŠæŠŠ findState å­˜å‚¨åœ¨ FindState æ± ä¸­æ–¹ä¾¿ä¸‹ä¸€æ¬¡ä½¿ç”¨ï¼Œä»¥æé«˜æ€§èƒ½ã€‚æœ€åï¼Œè¿”å› subscriberMethodsã€‚</p><a href=#subscribermethodfinderfindusingreflection><h4 id=subscribermethodfinderfindusingreflection><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.findUsingReflection()</h4></a><p>ä¸Šé¢å°±æ˜¯æ³¨è§£å¤„ç†å™¨ç”Ÿæˆçš„ Index å‚ä¸çš„æ—¶å€™çš„æµç¨‹ã€‚åœ¨è¿™é‡Œè¿˜æ˜¯æœ‰å¿…è¦è¯´ä¸€ä¸‹æ²¡æœ‰ Index å‚ä¸æ—¶çš„æµç¨‹ï¼Œä¹Ÿå°±æ˜¯ <code>findUsingReflectionInSingleClass()</code> æ–¹æ³•æ˜¯å¦‚ä½•è·å–è®¢é˜…ç±»çš„å›è°ƒæ–¹æ³•çš„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingReflection</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>findState</span><span class=o>.</span><span class=na>initForSubscriber</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>findState</span><span class=o>.</span><span class=na>moveToSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡ŒåŒæ ·èµ°åˆ°äº† <code>findUsingReflectionInSingleClass()</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Method</span><span class=o>[]</span> <span class=n>methods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// This is faster than getMethods, especially when subscribers are fat classes like Activities
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// è·å–è¯¥ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œä¸åŒ…æ‹¬çˆ¶ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getDeclaredMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>th</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è·å–è¯¥ç±»ä»¥åŠçˆ¶ç±»çš„æ‰€æœ‰ public æ–¹æ³•ï¼ŒåŒæ—¶æŒ‡å®šå¿½ç•¥çˆ¶ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>LinkageError</span> <span class=n>error</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// super class of NoClassDefFoundError to be a bit more broad...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>String</span> <span class=n>msg</span> <span class=o>=</span> <span class=s>&#34;Could not inspect methods of &#34;</span> <span class=o>+</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>msg</span> <span class=o>+=</span> <span class=s>&#34;. Please consider using EventBus annotation processor to avoid reflection.&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>msg</span> <span class=o>+=</span> <span class=s>&#34;. Please make this class visible to EventBus annotation processor to avoid reflection.&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>error</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ ‡è®°ä¸ºè·³è¿‡çˆ¶ç±»æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>findState</span><span class=o>.</span><span class=na>skipSuperClasses</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Method</span> <span class=n>method</span> <span class=o>:</span> <span class=n>methods</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>modifiers</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åˆ¤æ–­æ–¹æ³•æ˜¯å¦æ˜¯ PUBLIC ä¸”ä¸æ˜¯ ABSTRACTã€STATICã€SYNTHETIC
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>((</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>PUBLIC</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>MODIFIERS_IGNORE</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>parameterTypes</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// åˆ¤æ–­è¯¥æ–¹æ³•çš„å‚æ•°æ˜¯ä¸æ˜¯åªæœ‰ä¸€ä¸ª
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span> <span class=o>==</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// åˆ¤æ–­æ–¹æ³•æ˜¯å¦æœ‰ Subscribe æ³¨è§£
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Subscribe</span> <span class=n>subscribeAnnotation</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getAnnotation</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>subscribeAnnotation</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// ä»¥ä¸Šæ¡ä»¶éƒ½æ»¡è¶³åï¼Œå°±è¿›è¡Œæœ€åçš„æ ¡éªŒï¼Œç„¶åæ·»åŠ åˆ° findState.subscriberMethods ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>=</span> <span class=n>parameterTypes</span><span class=o>[</span><span class=n>0</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>checkAdd</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>ThreadMode</span> <span class=n>threadMode</span> <span class=o>=</span> <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>threadMode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>SubscriberMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>priority</span><span class=o>(),</span> <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>sticky</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// æ–¹æ³•å‚æ•° ï¼= 1,å¦‚æœå¼€å¯äº†ä¸¥æ ¼éªŒè¯åˆ™æŠ›å‡ºå¼‚å¸¸
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span> <span class=o>+</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;@Subscribe method &#34;</span> <span class=o>+</span> <span class=n>methodName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;must have exactly 1 parameter but has &#34;</span> <span class=o>+</span> <span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// æ–¹æ³•ä¿®é¥°ç¬¦ä¸åˆè¦æ±‚ï¼Œå¦‚æœå¼€å¯äº†ä¸¥æ ¼éªŒè¯ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span> <span class=o>+</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=n>methodName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34; is a illegal @Subscribe method: must be public, non-static, and non-abstract&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªæ–¹æ³•å¤§æ¦‚åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ol><li>é¦–å…ˆé€šè¿‡åå°„çš„æ–¹å¼è·å–è®¢é˜…è€…ç±»ä¸­çš„æ‰€æœ‰å£°æ˜æ–¹æ³•ï¼Œç„¶ååœ¨è¿™äº›æ–¹æ³•é‡Œé¢å¯»æ‰¾ä»¥ <code>@Subscribe</code> ä½œä¸ºæ³¨è§£çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li><li>å†ç»è¿‡ç»è¿‡ä¸€è½®æ£€æŸ¥ï¼Œçœ‹çœ‹ <code>findState.subscriberMethods</code> æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°†æ–¹æ³•åã€threadModeã€ä¼˜å…ˆçº§ã€æ˜¯å¦ä¸º sticky æ–¹æ³•ç­‰ä¿¡æ¯å°è£…åˆ° SubscriberMethod å¯¹è±¡ä¸­ï¼Œæœ€åæ·»åŠ åˆ° subscriberMethods åˆ—è¡¨ä¸­ã€‚</li></ol><p>ä»ä¸Šé¢æ–¹æ³•çš„åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè®¢é˜…ç±»çš„æ–¹æ³•è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œæ‰èƒ½å¤Ÿé¡ºåˆ©çš„è¿›è¡Œæ³¨å†Œï¼š</p><ol><li>æ–¹æ³•å¿…é¡»æ˜¯ <code>public</code> çš„ï¼Œä¸”ä¸èƒ½æ˜¯ <code>abstract</code>ã€<code>static</code>ã€<code>synthetic</code> çš„</li><li>æ–¹æ³•å‚æ•°å¿…é¡»åªæœ‰ä¸€ä¸ª</li><li>æ–¹æ³•å¿…é¡»å¸¦æœ‰ <code>@Subscribe</code> æ³¨è§£</li></ol><a href=#eventbussubscribe><h3 id=eventbussubscribe><span class=hanchor arialabel=Anchor># </span>EventBus.subscribe()</h3></a><p>ä¸Šé¢è¿™äº›å†…å®¹å°±æ˜¯è®¢é˜…ç±»å›è°ƒæ–¹æ³•çš„è·å–è¿‡ç¨‹äº†ï¼Œä¸‹é¢è¯´è¯´å›è°ƒæ–¹æ³•æ˜¯å¦‚ä½•è¿›è¡Œæ³¨å†Œçš„ã€‚æ–¹æ³•ä¸º <code>EventBus.subscribe()</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Must be called in synchronized block
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>subscribe</span><span class=o>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=o>,</span> <span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// eventType ä¸ºå›è°ƒæ–¹æ³•çš„å…¥å‚ç±»å‹ï¼ŒObject ç±»å‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>=</span> <span class=n>subscriberMethod</span><span class=o>.</span><span class=na>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å°†è®¢é˜…è€…ä»¥åŠè®¢é˜…æ–¹æ³•å°è£…ä¸ºä¸€ä¸ª Subscription ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Subscription</span> <span class=n>newSubscription</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Subscription</span><span class=o>(</span><span class=n>subscriber</span><span class=o>,</span> <span class=n>subscriberMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span> <span class=n>subscriptions</span> <span class=o>=</span> <span class=n>subscriptionsByEventType</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriptions</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>subscriptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// subscriptionsByEventTypeï¼šä»¥è®¢é˜…æ–¹æ³•çš„å‚æ•°ä¸º keyï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Subscription ä¸º value è¿›è¡Œä¿å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriptionsByEventType</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>eventType</span><span class=o>,</span> <span class=n>subscriptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>subscriptions</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>newSubscription</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Subscriber &#34;</span> <span class=o>+</span> <span class=n>subscriber</span><span class=o>.</span><span class=na>getClass</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; already registered to event &#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åœ¨è®¢é˜…å‚æ•°å¯¹åº”çš„ Subscription åˆ—è¡¨ä¸­æŒ‰ç…§è®¢é˜…æ–¹æ³•çš„ä¼˜å…ˆçº§è¿›è¡Œæ’åº
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// priority çš„æ•°å€¼è¶Šé«˜ï¼Œè¶Šåœ¨åˆ—è¡¨çš„å‰é¢ï¼›ç›¸åŒ priority çš„æ–¹æ³•ï¼Œåæ¥çš„æ–¹æ³•ä¼šåœ¨åé¢
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>subscriptions</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>size</span> <span class=o>||</span> <span class=n>subscriberMethod</span><span class=o>.</span><span class=na>priority</span> <span class=o>&gt;</span> <span class=n>subscriptions</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>subscriberMethod</span><span class=o>.</span><span class=na>priority</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriptions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>newSubscription</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ä» typesBySubscriber ä¸­è·å–
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>subscribedEvents</span> <span class=o>=</span> <span class=n>typesBySubscriber</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriber</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscribedEvents</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>subscribedEvents</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// typesBySubscriberï¼šä»¥è®¢é˜…è€…ä¸º keyï¼Œè®¢é˜…æ–¹æ³•å‚æ•°ä¸º value è¿›è¡Œä¿å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>typesBySubscriber</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>subscriber</span><span class=o>,</span> <span class=n>subscribedEvents</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>subscribedEvents</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœè®¢é˜…æ–¹æ³•è®¢é˜…çš„æ˜¯ç²˜æ€§äº‹ä»¶ï¼Œåˆ™ä¼šåœ¨æ³¨å†Œæ—¶æ¥å—åˆ°æ­¤ç²˜æ€§äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethod</span><span class=o>.</span><span class=na>sticky</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>eventInheritance</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Existing sticky events of all subclasses of eventType have to be considered.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// Note: Iterating over all events may be inefficient with lots of sticky events,
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// thus data structure should be changed to allow a more efficient lookup
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Set</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span> <span class=n>stickyEvents</span><span class=o>.</span><span class=na>entrySet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>:</span> <span class=n>entries</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>candidateEventType</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>eventType</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>candidateEventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Object</span> <span class=n>stickyEvent</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>checkPostStickyEventToSubscription</span><span class=o>(</span><span class=n>newSubscription</span><span class=o>,</span> <span class=n>stickyEvent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>stickyEvent</span> <span class=o>=</span> <span class=n>stickyEvents</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>checkPostStickyEventToSubscription</span><span class=o>(</span><span class=n>newSubscription</span><span class=o>,</span> <span class=n>stickyEvent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼Œä¼šå…ˆå°†è®¢é˜…è€…ä»¥åŠè®¢é˜…äº‹ä»¶åŒ…è£…æˆä¸ºä¸€ä¸ª <code>Subscription</code> å¯¹è±¡ï¼Œç„¶åä¸å…¶ä»–å‚æ•°ä¸€èµ·ä¿å­˜èµ·æ¥ï¼Œå…·ä½“ä¸ºä¸‹é¢ä¸¤ä¸ªä¿å­˜çš„åœ°æ–¹ï¼š</p><ul><li><code>subscriptionsByEventType</code>ï¼šä»¥è®¢é˜…äº‹ä»¶å‚æ•°ä¸º keyï¼Œå¯¹åº” <code>Subscription</code> å¯¹è±¡æ•°ç»„</li><li><code>typesBySubscriber</code>ï¼šä»¥è®¢é˜…è€…å¯¹è±¡ä¸º keyï¼Œå¯¹åº”è®¢é˜…äº‹ä»¶å‚æ•°æ•°ç»„ã€‚ä¸»è¦æ˜¯åœ¨ EventBus çš„ <code>isRegister()</code> æ–¹æ³•ä¸­å»ä½¿ç”¨çš„ï¼Œç”¨æ¥åˆ¤æ–­è¿™ä¸ª Subscriber å¯¹è±¡ æ˜¯å¦å·²è¢«æ³¨å†Œè¿‡ã€‚</li></ul><p>å¦å¤–ï¼ŒSubscription å¯¹è±¡è¿˜ä¼šæ ¹æ® priority è¿›è¡Œæ’åºï¼Œå…·ä½“æ¥è¯´ï¼špriority çš„æ•°å€¼è¶Šé«˜ï¼Œè¶Šåœ¨åˆ—è¡¨çš„å‰é¢ï¼›ç›¸åŒ priority çš„æ–¹æ³•ï¼Œåæ¥çš„æ–¹æ³•ä¼šåœ¨åé¢ã€‚</p><p>åŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥çœ‹å‡ºç²˜æ€§äº‹ä»¶çš„è§¦å‘æœºåˆ¶ï¼š</p><ol><li>ç²˜æ€§äº‹ä»¶å‘å‡ºæ—¶ï¼Œä¼šä¸»åŠ¨é€šçŸ¥æ‰€æœ‰å¯ä»¥å¤„ç†çš„æ–¹æ³•ï¼Œä¸ç®¡æ–¹æ³•æ˜¯å¦æ˜¯ç²˜æ€§çš„</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>postSticky</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>stickyEvents</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>stickyEvents</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getClass</span><span class=o>(),</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Should be posted after it is putted, in case the subscriber wants to remove immediately
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>post</span><span class=o>(</span><span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>åœ¨è®¢é˜…è€…è¿›è¡Œæ³¨å†Œæ—¶ï¼Œå¦‚æœæœ‰å¯ä»¥å“åº”çš„ç²˜æ€§äº‹ä»¶ï¼Œç²˜æ€§æ–¹æ³•ä¼šè¢«è§¦å‘</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>subscriberMethod</span><span class=p>.</span><span class=nx>sticky</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>eventInheritance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(...)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=p>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(...)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nb>Object</span> <span class=nx>stickyEvent</span> <span class=o>=</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>getValue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=nx>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=nx>newSubscription</span><span class=p>,</span> <span class=nx>stickyEvent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>Object</span> <span class=nx>stickyEvent</span> <span class=o>=</span> <span class=nx>stickyEvents</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>eventType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=nx>newSubscription</span><span class=p>,</span> <span class=nx>stickyEvent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#post-æµç¨‹><h2 id=post-æµç¨‹><span class=hanchor arialabel=Anchor># </span>post æµç¨‹</h2></a><p>æˆ‘ä»¬å¯ä»¥è°ƒç”¨ <code>EventBus.post()</code> ä»¥åŠ <code>EventBus.postSticky()</code> è¿™ä¸¤ä¸ªæ–¹æ³•æ¥å‘é€äº‹ä»¶ï¼Œå‰è€…æ˜¯æ™®é€šäº‹ä»¶ï¼Œåè€…æ˜¯ç²˜æ€§äº‹ä»¶ã€‚</p><p>ç²˜æ€§äº‹ä»¶çš„å‘é€æ¯”è¾ƒç®€å•ï¼Œè¯¥æ–¹æ³•é™¤äº†ä¿å­˜äº†äº‹ä»¶ä¹‹å¤–ï¼Œè¿˜è°ƒç”¨äº† <code>post</code> æ–¹æ³•å½“åšéç²˜æ€§äº‹ä»¶è¿›è¡Œäº†åˆ†å‘ã€‚æ­¤æ—¶ï¼Œä¼šä¸»åŠ¨é€šçŸ¥æ‰€æœ‰å¯ä»¥å¤„ç†çš„æ–¹æ³•ï¼Œä¸ç®¡æ–¹æ³•æ˜¯å¦æ˜¯ç²˜æ€§çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>postSticky</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>stickyEvents</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>stickyEvents</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getClass</span><span class=o>(),</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Should be posted after it is putted, in case the subscriber wants to remove immediately
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>post</span><span class=o>(</span><span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦å¤–ï¼Œå‰é¢æåˆ°è¿‡ï¼Œåœ¨è®¢é˜…è€…è¿›è¡Œæ³¨å†Œæ—¶ï¼Œå¦‚æœæœ‰å¯ä»¥å“åº”çš„ç²˜æ€§äº‹ä»¶ï¼Œç²˜æ€§æ–¹æ³•ä¼šè¢«è§¦å‘ã€‚</p><p>ç²˜æ€§äº‹ä»¶ä¸ä¼šè¢«æ¶ˆè€—æ‰ï¼Œé™¤éæ‰‹åŠ¨ remove æ‰ï¼š</p><ul><li><code>removeStickyEvent(Class&lt;T>)</code></li><li><code>removeStickyEvent(Object)</code></li><li><code>removeAllStickyEvents()</code></li></ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹ <code>EventBus.post()</code> æ˜¯å¦‚ä½•è§¦å‘è®¢é˜…è€…çš„å›è°ƒäº‹ä»¶çš„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/** For ThreadLocal, much faster to set (and get multiple values). */</span>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>PostingThreadState</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>eventQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isPosting</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isMainThread</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Subscription</span> <span class=n>subscription</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>event</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>canceled</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>PostingThreadState</span><span class=o>&gt;</span> <span class=n>currentPostingThreadState</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>PostingThreadState</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>PostingThreadState</span> <span class=nf>initialValue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>PostingThreadState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** Posts the given event to the event bus. */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>post</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>PostingThreadState</span> <span class=n>postingState</span> <span class=o>=</span> <span class=n>currentPostingThreadState</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>eventQueue</span> <span class=o>=</span> <span class=n>postingState</span><span class=o>.</span><span class=na>eventQueue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>eventQueue</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>postingState</span><span class=o>.</span><span class=na>isPosting</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>postingState</span><span class=o>.</span><span class=na>isMainThread</span> <span class=o>=</span> <span class=n>isMainThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>postingState</span><span class=o>.</span><span class=na>isPosting</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>postingState</span><span class=o>.</span><span class=na>canceled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Internal error. Abort state was not reset&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(!</span><span class=n>eventQueue</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>postSingleEvent</span><span class=o>(</span><span class=n>eventQueue</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>0</span><span class=o>),</span> <span class=n>postingState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>postingState</span><span class=o>.</span><span class=na>isPosting</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>postingState</span><span class=o>.</span><span class=na>isMainThread</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆä¼šè°ƒç”¨ <code>currentPostingThreadState.get()</code> è·å–ä¸€ä¸ª PostingThreadState å¯¹è±¡ï¼Œ currentPostingThreadState æ˜¯ä¸€ä¸ª ThreadLocal ç±»å‹çš„å¯¹è±¡ï¼Œè€Œ PostingThreadState ä¸­åŒ…å«äº†ä¸€ä¸ª eventQueue å’Œå…¶ä»–ä¸€äº›æ ‡å¿—ä½ã€‚</p><p>æ¥ç€æŠŠä¼ å…¥çš„ eventï¼Œä¿å­˜åˆ°äº†å½“å‰çº¿ç¨‹ä¸­çš„ä¸€ä¸ªå˜é‡ PostingThreadState çš„ eventQueue äº‹ä»¶é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åå¼€å§‹æ‰§è¡Œã€‚å½“åœ¨æçŸ­æ—¶é—´å†…å¤šæ¬¡è°ƒç”¨ <code>post</code> æ–¹æ³•æ—¶ï¼Œåªä¼šå°†äº‹ä»¶æ·»åŠ åˆ°é˜Ÿåˆ—é‡Œé¢ï¼Œç¬¬ 24 è¡Œçš„ä»£ç ä¸æˆç«‹ã€‚è€Œåœ¨ 31-33 è¡Œä»£ç é‡Œé¢ï¼Œä¼šå–æ—¶é—´é˜Ÿåˆ—çš„å¤´è¿›è¡Œäº‹ä»¶åˆ†å‘ã€‚æœ€åæ‰€æœ‰äº‹ä»¶å¤„ç†å®Œæˆåï¼Œæ ‡å¿—ä½å¤ä½ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ <code>postSingleEvent()</code> æ–¹æ³•ï¼Œæ³¨é‡Šéƒ½åœ¨é‡Œé¢ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>postSingleEvent</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>,</span> <span class=n>PostingThreadState</span> <span class=n>postingState</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Error</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventClass</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>subscriptionFound</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// eventInheritance è¡¨ç¤ºäº‹ä»¶æ¥æ”¶ç±»æ˜¯å¦æœ‰å±‚æ¬¡ç»“æ„
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>eventInheritance</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// lookupAllEventTypes æ–¹æ³•çš„ä½œç”¨æ˜¯æŸ¥è¯¢ class çš„çˆ¶ç±»ä»¥åŠæ¥å£
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// æ˜¾ç„¶ç¤ºä¾‹ä¸­å°±æ˜¯ä¸€ä¸ª Object
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>eventTypes</span> <span class=o>=</span> <span class=n>lookupAllEventTypes</span><span class=o>(</span><span class=n>eventClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>countTypes</span> <span class=o>=</span> <span class=n>eventTypes</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>h</span> <span class=o>&lt;</span> <span class=n>countTypes</span><span class=o>;</span> <span class=n>h</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>eventTypes</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>h</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è°ƒç”¨ postSingleEventForEventType æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>subscriptionFound</span> <span class=o>|=</span> <span class=n>postSingleEventForEventType</span><span class=o>(</span><span class=n>event</span><span class=o>,</span> <span class=n>postingState</span><span class=o>,</span> <span class=n>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç›´æ¥ä»¥å½“å‰çš„ eventClass è°ƒç”¨ postSingleEventForEventType æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriptionFound</span> <span class=o>=</span> <span class=n>postSingleEventForEventType</span><span class=o>(</span><span class=n>event</span><span class=o>,</span> <span class=n>postingState</span><span class=o>,</span> <span class=n>eventClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æœ€åï¼Œå½“æ²¡æœ‰è®¢é˜…è€…å¯ä»¥å¤„ç†è¯¥äº‹ä»¶æ—¶ï¼ŒEventBus ä¼šæŠ›å‡ºä¸€ä¸ª NoSubscriberEvent äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>subscriptionFound</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>logNoSubscriberMessages</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=na>log</span><span class=o>(</span><span class=n>Level</span><span class=o>.</span><span class=na>FINE</span><span class=o>,</span> <span class=s>&#34;No subscribers registered for event &#34;</span> <span class=o>+</span> <span class=n>eventClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>sendNoSubscriberEvent</span> <span class=o>&amp;&amp;</span> <span class=n>eventClass</span> <span class=o>!=</span> <span class=n>NoSubscriberEvent</span><span class=o>.</span><span class=na>class</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=n>eventClass</span> <span class=o>!=</span> <span class=n>SubscriberExceptionEvent</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>post</span><span class=o>(</span><span class=k>new</span> <span class=n>NoSubscriberEvent</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>event</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>lookupAllEventTypes æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å–å‡º Event åŠå…¶çˆ¶ç±»å’Œæ¥å£çš„ class åˆ—è¡¨ï¼Œå½“ç„¶é‡å¤å–çš„è¯ä¼šå½±å“æ€§èƒ½ï¼Œæ‰€ä»¥å®ƒä¹Ÿåšäº†ä¸€ä¸ª eventTypesCache çš„ç¼“å­˜ã€‚</p><p>æ¥ç€çœ‹çœ‹ <code>postSingleEventForEventType</code> æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>postSingleEventForEventType</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>,</span> <span class=n>PostingThreadState</span> <span class=n>postingState</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// subscriptions å°±æ˜¯ç¤ºä¾‹ä¸­å¯¹åº”è®¢é˜…æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span> <span class=n>subscriptions</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>subscriptions</span> <span class=o>=</span> <span class=n>subscriptionsByEventType</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>eventClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriptions</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>subscriptions</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Subscription</span> <span class=n>subscription</span> <span class=o>:</span> <span class=n>subscriptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>postingState</span><span class=o>.</span><span class=na>event</span> <span class=o>=</span> <span class=n>event</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>postingState</span><span class=o>.</span><span class=na>subscription</span> <span class=o>=</span> <span class=n>subscription</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>aborted</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è°ƒç”¨ postToSubscription è¿›è¡ŒçœŸæ­£çš„åˆ†å‘
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>postToSubscription</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>,</span> <span class=n>postingState</span><span class=o>.</span><span class=na>isMainThread</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>aborted</span> <span class=o>=</span> <span class=n>postingState</span><span class=o>.</span><span class=na>canceled</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>postingState</span><span class=o>.</span><span class=na>event</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>postingState</span><span class=o>.</span><span class=na>subscription</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>postingState</span><span class=o>.</span><span class=na>canceled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>aborted</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆï¼Œæ ¹æ® Event ç±»å‹ä» subscriptionsByEventType ä¸­å–å‡ºå¯¹åº”çš„ subscriptions å¯¹è±¡ï¼Œæœ€åè°ƒç”¨äº† <code>postToSubscription()</code> æ–¹æ³•ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸ªç»†èŠ‚ï¼Œåªè¦ eventClass å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ Subscriptionï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å°±ä¼šè¿”å› trueï¼Œä¹Ÿå°±æ˜¯è¯´å·²ç»å‘é€ç»™è®¢é˜…è€…äº†ã€‚</p><p>æœ€åçœ‹çœ‹ <code>postToSubscription()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®æ–¹æ³•çš„ threaMode å€¼ï¼Œå†³å®šåœ¨å“ªå¦‚ä½•è§¦å‘å›è°ƒæ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>postToSubscription</span><span class=o>(</span><span class=n>Subscription</span> <span class=n>subscription</span><span class=o>,</span> <span class=n>Object</span> <span class=n>event</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isMainThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>subscription</span><span class=o>.</span><span class=na>subscriberMethod</span><span class=o>.</span><span class=na>threadMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>POSTING</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>invokeSubscriber</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MAIN</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>isMainThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>invokeSubscriber</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>mainThreadPoster</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MAIN_ORDERED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>mainThreadPoster</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>mainThreadPoster</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// temporary: technically not correct as poster not decoupled from subscriber
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>invokeSubscriber</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>BACKGROUND</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>isMainThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>backgroundPoster</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>invokeSubscriber</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>ASYNC</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>asyncPoster</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Unknown thread mode: &#34;</span> <span class=o>+</span> <span class=n>subscription</span><span class=o>.</span><span class=na>subscriberMethod</span><span class=o>.</span><span class=na>threadMode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé¢ 5 ç§ ThreadModeï¼Œé‡‡å–çš„æ‰‹æ®µä¹Ÿä¸ä¸€æ ·ã€‚ä»è¯¥æšä¸¾å€¼çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œåˆ†ä¸º 5 ç§æƒ…å†µï¼Œä¸‹è¡¨å°±æ˜¯æ¯ç§æƒ…å†µçš„å«ä¹‰ï¼š</p><p>æ— è®ºåœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæœ€åéƒ½ä¼šè°ƒç”¨ <code>invokeSubscriber</code> æ–¹æ³•æ¥è§¦å‘å›è°ƒä»»åŠ¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>void</span> <span class=nx>invokeSubscriber</span><span class=p>(</span><span class=nx>Subscription</span> <span class=nx>subscription</span><span class=p>,</span> <span class=nb>Object</span> <span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>subscription</span><span class=p>.</span><span class=nx>subscriberMethod</span><span class=p>.</span><span class=nx>method</span><span class=p>.</span><span class=nx>invoke</span><span class=p>(</span><span class=nx>subscription</span><span class=p>.</span><span class=nx>subscriber</span><span class=p>,</span> <span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>InvocationTargetException</span> <span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>handleSubscriberException</span><span class=p>(</span><span class=nx>subscription</span><span class=p>,</span> <span class=nx>event</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>getCause</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>IllegalAccessException</span> <span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=nx>IllegalStateException</span><span class=p>(</span><span class=s2>&#34;Unexpected exception&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé€šè¿‡åå°„è°ƒç”¨äº†è®¢é˜…è€…çš„å›è°ƒæ–¹æ³•ã€‚è‡³æ­¤ï¼Œäº‹ä»¶çš„å‘é€å·²ç»åˆ†æå®Œæ¯•ã€‚</p><a href=#unregister-æµç¨‹><h2 id=unregister-æµç¨‹><span class=hanchor arialabel=Anchor># </span>unregister æµç¨‹</h2></a><p>æ³¨é”€è¿‡ç¨‹åŸç†æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†æ³¨å†Œæ—¶ä¿å­˜åˆ° <code>subscriptionsByEventType</code>ã€<code>typesBySubscriber</code> ä¸¤ä¸ªé›†åˆä¸­çš„å…ƒç´ åˆ é™¤ã€‚</p><p>è¿™ä¸¤ä¸ªé›†åˆåœ¨æ³¨å†Œè¿‡ç¨‹ä¸­åˆ†æè¿‡ï¼š</p><ul><li><code>subscriptionsByEventType</code> ä»¥è®¢é˜…äº‹ä»¶å‚æ•°ä¸º keyï¼Œå¯¹åº” Subscription å¯¹è±¡æ•°ç»„</li><li><code>typesBySubscriber</code> ä»¥è®¢é˜…è€…å¯¹è±¡ä¸º keyï¼Œå¯¹åº”è®¢é˜…äº‹ä»¶å‚æ•°æ•°ç»„</li></ul><p><code>EventBus.unregister()</code> ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/** Unregisters the given subscriber from all event classes. */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>unregister</span><span class=o>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å…ˆé€šè¿‡ subscriber è®¢é˜…è€…å¯¹è±¡ä»`typesBySubscriber`ä¸­è·å–è®¢é˜…äº‹ä»¶å‚æ•°æ•°ç»„
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>subscribedTypes</span> <span class=o>=</span> <span class=n>typesBySubscriber</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriber</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscribedTypes</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ä»¥è®¢é˜…äº‹ä»¶å‚æ•°ä¸º keyï¼Œä»`subscriptionsByEventType`ä¸­è·å–åˆ°å¯¹åº”çš„`Subscrition`å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>:</span> <span class=n>subscribedTypes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>unsubscribeByEventType</span><span class=o>(</span><span class=n>subscriber</span><span class=o>,</span> <span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>typesBySubscriber</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>subscriber</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=na>log</span><span class=o>(</span><span class=n>Level</span><span class=o>.</span><span class=na>WARNING</span><span class=o>,</span> <span class=s>&#34;Subscriber to unregister was not registered before: &#34;</span> <span class=o>+</span> <span class=n>subscriber</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** Only updates subscriptionsByEventType, not typesBySubscriber! Caller must update typesBySubscriber. */</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>unsubscribeByEventType</span><span class=o>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span> <span class=n>subscriptions</span> <span class=o>=</span> <span class=n>subscriptionsByEventType</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriptions</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>subscriptions</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Subscription</span> <span class=n>subscription</span> <span class=o>=</span> <span class=n>subscriptions</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>subscription</span><span class=o>.</span><span class=na>subscriber</span> <span class=o>==</span> <span class=n>subscriber</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>subscription</span><span class=o>.</span><span class=na>active</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>subscriptions</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>i</span><span class=o>--;</span>
</span></span><span class=line><span class=cl>                <span class=n>size</span><span class=o>--;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…ˆé€šè¿‡ subscriber è®¢é˜…è€…å¯¹è±¡ä» <code>typesBySubscriber</code> ä¸­è·å–è®¢é˜…äº‹ä»¶å‚æ•°æ•°ç»„ï¼›ç„¶åä»¥è®¢é˜…äº‹ä»¶å‚æ•°ä¸º keyï¼Œä» <code>subscriptionsByEventType</code> ä¸­è·å–åˆ°å¯¹åº”çš„ <code>Subscrition</code> å¯¹è±¡ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯ EventBus çš„æ³¨é”€è¿‡ç¨‹äº†ã€‚</p><a href=#è·¨è¿›ç¨‹-eventbus><h2 id=è·¨è¿›ç¨‹-eventbus><span class=hanchor arialabel=Anchor># </span>è·¨è¿›ç¨‹ EventBus</h2></a><p>è·¨è¿›ç¨‹ EventBus çš„éš¾ç‚¹åœ¨äºå¦‚ä½•å°†ä¸€ä¸ªè¿›ç¨‹ä¸­çš„äº‹ä»¶ä¼ é€’åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼ŒæŠ€æœ¯ç‚¹è¿˜æ˜¯ç¦»ä¸æ¥ IPC çš„å‡ ç§å¸¸ç”¨æ–¹å¼ï¼Œè¿™é‡Œæ¯”è¾ƒå®ç”¨çš„æ˜¯ AIDL æ–¹å¼ã€‚</p><p>ä¸‹é¢å…ˆç®€å•çš„è¯´ä¸€ä¸‹åŸç†ï¼š 1. å¼„ä¸€ä¸ªä¸»è¿›ç¨‹çš„ Service ä½œä¸ºæ¶ˆæ¯ä¸­å¿ƒï¼Œç”¨æ¥å‘å„ä¸ªè¿›ç¨‹è½¬å‘äº‹ä»¶ 2. ä¸»è¿›ç¨‹å’Œå­è¿›ç¨‹åœ¨åˆå§‹åŒ–çš„æ—¶å€™éƒ½ç»‘å®šåˆ°è¯¥ Service ä¸Šé¢ï¼Œè¿™æ ·å°±å¾—åˆ°äº†å„è¿›ç¨‹å‘æ¶ˆæ¯ä¸­å¿ƒ Service å‘é€æ¶ˆæ¯çš„é€šé“ 3. åœ¨ç»‘å®šåˆ° Service åï¼Œå„ä¸ªè¿›ç¨‹å‘ Service æ³¨å†Œæœ¬è¿›ç¨‹çš„æ¶ˆæ¯è½¬å‘å™¨ï¼Œè¿™æ ·æ¶ˆæ¯ä¸­å¿ƒ Service å°±å¯ä»¥å¯¹å„è¿›ç¨‹å‘é€æ¶ˆæ¯äº†ï¼Œè‡³æ­¤ C/S ä¹‹é—´åŒå‘çš„è”ç³»é€šé“å·²ç»æ‰“é€š</p><p>ä¸‹é¢åˆ†åˆ«è€ƒè™‘ä¸€ä¸‹æ¶ˆæ¯çš„ä¼ é€’ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å†µè®¨è®ºã€‚ 1. ä¸»è¿›ç¨‹å‘å­è¿›ç¨‹çš„é€šä¿¡ï¼šè·å–ä¸»è¿›ç¨‹ Service ä¸­å„ä¸ªè¿›ç¨‹ï¼ˆåŒ…æ‹¬ä¸»è¿›ç¨‹è‡ªå·±ï¼‰çš„æ¶ˆæ¯è½¬å‘å™¨ï¼Œä¾æ¬¡è½¬å‘æ¶ˆæ¯ 2. å­è¿›ç¨‹å’Œä¸»è¿›ç¨‹çš„é€šä¿¡ï¼šé€šè¿‡åˆå§‹åŒ–ç»‘å®šåˆ° Service æ—¶è·å–åˆ°çš„ Service ä»£ç†å¯¹è±¡ï¼Œå‘ Service å‘é€æ¶ˆæ¯ã€‚Service æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šå‘å„ä¸ªè¿›ç¨‹çš„æ¶ˆæ¯è½¬å‘å™¨ä¾æ¬¡è½¬å‘æ¶ˆæ¯ï¼Œè¿™æ ·ä¸»è¿›ç¨‹ä»¥åŠæ‰€æœ‰å­è¿›ç¨‹éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯ 3. å­è¿›ç¨‹å’Œå­è¿›ç¨‹çš„é€šä¿¡ï¼šå…ˆå‘é€åˆ°ä¸»è¿›ç¨‹ï¼Œä¸»è¿›ç¨‹ä¼šè¿›è¡Œè½¬å‘ã€‚</p><p>æ³¨æ„è¿™é‡Œï¼Œä¸»è¿›ç¨‹ Service æŒæœ‰ä¸»è¿›ç¨‹ä»¥åŠæ‰€æœ‰å­è¿›ç¨‹çš„æ¶ˆæ¯è½¬å‘å™¨ï¼Œè¿™é‡Œä¸å¯¹ä¸»è¿›ç¨‹è¿›è¡Œç‰¹åˆ«å¤„ç†ã€‚æ­¤å¤–ï¼Œæ‰€æœ‰çš„äº‹ä»¶éƒ½ä¼šç”± Service è¿›è¡Œåˆ†å‘ï¼ŒService åˆ†å‘æ—¶ä¼šå¯¹ä¸»è¿›ç¨‹å’Œæ‰€æœ‰å­è¿›ç¨‹è¿›è¡Œåˆ†å‘ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå­è¿›ç¨‹å†…éƒ¨è°ƒç”¨äº†è·¨è¿›ç¨‹ EventBus è¿›è¡Œäº‹ä»¶åˆ†å‘çš„è¯ï¼Œä¼šåœ¨ä¸¤æ¬¡ IPC ä¹‹åå†ç”±æ”¹å­è¿›ç¨‹å†…éƒ¨çš„ EventBus è¿›è¡Œè§¦å‘ã€‚è¿™ä¸¤æ¬¡ IPC æ˜¯ï¼šå­è¿›ç¨‹å‘ä¸»è¿›ç¨‹ Service å‘å‡ºæ¶ˆæ¯ï¼Œä¸»è¿›ç¨‹ Service æ¥æ”¶åˆ°æ¶ˆæ¯åå‘æ‰€æœ‰è¿›ç¨‹è¿›è¡Œåˆ†å‘ã€‚</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/EventBus/clipboard_20230323_031638.png width=auto alt></p><a href=#ç®€å•å®ç°><h3 id=ç®€å•å®ç°><span class=hanchor arialabel=Anchor># </span>ç®€å•å®ç°</h3></a><p>æ–‡ä»¶æ¸…å•å¦‚ä¸‹ï¼š</p><ol><li>æœåŠ¡ç«¯ï¼šIEventBusManager.aidl</li><li>å®¢æˆ·ç«¯ï¼šIEventDispatcher.aidl</li><li>ä¼ è¾“çš„äº‹ä»¶ï¼šIPCEvent.javaã€IPCEvent.aidl</li><li>æ ¸å¿ƒç±»ï¼šIPCEventBus.kt</li></ol><p><strong>src/main/aidl/xyz/yorek/eventbus/IEventBusManager.aidl</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// IEventBusManager.aidl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nn>xyz.yorek.eventbus</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>xyz.yorek.eventbus.IEventDispatcher</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>xyz.yorek.eventbus.IPCEvent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>IEventBusManager</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>register</span><span class=o>(</span><span class=n>IEventDispatcher</span> <span class=n>dispatcher</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>unregister</span><span class=o>(</span><span class=n>IEventDispatcher</span> <span class=n>dispatcher</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/** å‘ä¸»è¿›ç¨‹å‘é€Event */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>postToService</span><span class=o>(</span><span class=n>in</span> <span class=n>IPCEvent</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>src/main/aidl/xyz/yorek/eventbus/IEventDispatcher.aidl</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// IEventDispatcher.aidl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nn>xyz.yorek.eventbus</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>xyz.yorek.eventbus.IPCEvent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>IEventDispatcher</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** æ¥æ”¶å…¶ä»–è¿›ç¨‹å‘é€è¿‡æ¥çš„Event */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>dispatch</span><span class=o>(</span><span class=n>in</span> <span class=n>IPCEvent</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>src/main/aidl/xyz/yorek/eventbus/IPCEvent.aidl</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=o>//</span> <span class=nt>IPCEvent</span><span class=p>.</span><span class=nc>aidl</span>
</span></span><span class=line><span class=cl><span class=nt>package</span> <span class=nt>xyz</span><span class=p>.</span><span class=nc>yorek</span><span class=p>.</span><span class=nc>eventbus</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>parcelable</span> <span class=nt>IPCEvent</span><span class=o>;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>src/main/java/xyz/yorek/eventbus/IPCEvent.java</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>public</span> <span class=kr>class</span> <span class=nx>IPCEvent</span> <span class=kr>implements</span> <span class=nx>Parcelable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nx>int</span> <span class=nx>code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nb>String</span> <span class=nx>msg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nx>IPCEvent() {</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nx>IPCEvent</span><span class=p>(</span><span class=nx>int</span> <span class=nx>code</span><span class=p>,</span> <span class=nb>String</span> <span class=nx>msg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>code</span> <span class=o>=</span> <span class=nx>code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>msg</span> <span class=o>=</span> <span class=nx>msg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>protected</span> <span class=nx>IPCEvent</span><span class=p>(</span><span class=nx>Parcel</span> <span class=k>in</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>code</span> <span class=o>=</span> <span class=k>in</span><span class=p>.</span><span class=nx>readInt</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>msg</span> <span class=o>=</span> <span class=k>in</span><span class=p>.</span><span class=nx>readString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nb>String</span> <span class=nx>toString() {</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;IPCEvent{&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;code=&#34;</span> <span class=o>+</span> <span class=nx>code</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;, msg=&#39;&#34;</span> <span class=o>+</span> <span class=nx>msg</span> <span class=o>+</span> <span class=s1>&#39;\&#39;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nx>int</span> <span class=nx>describeContents() {</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=k>void</span> <span class=nx>writeToParcel</span><span class=p>(</span><span class=nx>Parcel</span> <span class=nx>dest</span><span class=p>,</span> <span class=nx>int</span> <span class=nx>flags</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dest</span><span class=p>.</span><span class=nx>writeInt</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>code</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>dest</span><span class=p>.</span><span class=nx>writeString</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=kr>static</span> <span class=nx>final</span> <span class=nx>Creator</span><span class=p>&lt;</span><span class=nt>IPCEvent</span><span class=p>&gt;</span> <span class=nx>CREATOR</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Creator</span><span class=p>&lt;</span><span class=nt>IPCEvent</span><span class=p>&gt;()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kr>public</span> <span class=nx>IPCEvent</span> <span class=nx>createFromParcel</span><span class=p>(</span><span class=nx>Parcel</span> <span class=nx>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=nx>IPCEvent</span><span class=p>(</span><span class=nx>source</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kr>public</span> <span class=nx>IPCEvent</span><span class=p>[]</span> <span class=nx>newArray</span><span class=p>(</span><span class=nx>int</span> <span class=nx>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=nx>IPCEvent</span><span class=p>[</span><span class=nx>size</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>src/main/java/xyz/yorek/eventbus/IPCEventBus.kt</strong></p><p>å†…å«ä¸€ä¸ªå†…éƒ¨ç±» <code>EventBusManagerService</code>ï¼Œç®¡ç†æ‰€æœ‰è¿›ç¨‹çš„äº‹ä»¶è½¬å‘å™¨ã€‚</p><p>éœ€è¦æ³¨æ„ä¸€ä¸‹è¿™é‡Œé¢çš„ <code>RemoteCallbackList</code> çš„ç‹¬ç‰¹ç”¨æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>object</span> <span class=nc>IPCEventBus</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æœ¬è¿›ç¨‹çš„äº‹ä»¶åˆ†å‘å™¨ï¼ŒæœåŠ¡ç«¯å‘æœ¬è¿›ç¨‹å®¢æˆ·ç«¯å‘é€æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>val</span> <span class=py>mEventDispatcher</span> <span class=p>=</span> <span class=k>object</span> <span class=err>: </span><span class=nc>IEventDispatcher</span><span class=p>.</span><span class=n>Stub</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>dispatch</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>post</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æœ¬è¿›ç¨‹è·å–çš„æœåŠ¡ç«¯ä»£ç†ï¼Œå¯ä»¥å‘æœåŠ¡ç«¯æ³¨å†Œäº‹ä»¶åˆ†å‘å™¨ï¼Œè¿˜å¯ä»¥å‘é€æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>var</span> <span class=py>mEventBusManagerService</span><span class=p>:</span> <span class=n>IEventBusManager</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>mServiceConnection</span> <span class=p>=</span> <span class=k>object</span> <span class=err>: </span><span class=nc>ServiceConnection</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onServiceDisconnected</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=n>ComponentName</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mEventBusManagerService</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onServiceConnected</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=n>ComponentName</span><span class=p>?,</span> <span class=n>service</span><span class=p>:</span> <span class=n>IBinder</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>service</span> <span class=o>?:</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=n>mEventBusManagerService</span> <span class=p>=</span> <span class=n>IEventBusManager</span><span class=p>.</span><span class=n>Stub</span><span class=p>.</span><span class=n>asInterface</span><span class=p>(</span><span class=n>service</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>register</span><span class=p>(</span><span class=n>mEventDispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åˆå§‹åŒ–æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>init</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Application</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>app</span> <span class=p>=</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>intent</span> <span class=p>=</span> <span class=n>Intent</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>EventBusManagerService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=p>.</span><span class=n>bindService</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span> <span class=n>mServiceConnection</span><span class=p>,</span> <span class=n>Context</span><span class=p>.</span><span class=n>BIND_AUTO_CREATE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é”€æ¯æ–¹æ³•ï¼Œè¿›ç¨‹ä¸éœ€è¦æ—¶è°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>destory</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>asBinder</span><span class=p>()</span><span class=o>?.</span><span class=n>isBinderAlive</span> <span class=o>==</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>unregister</span><span class=p>(</span><span class=n>mEventDispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>app</span><span class=p>.</span><span class=n>unbindService</span><span class=p>(</span><span class=n>mServiceConnection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>register</span><span class=p>(</span><span class=n>any</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>register</span><span class=p>(</span><span class=n>any</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>unregister</span><span class=p>(</span><span class=n>any</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>unregister</span><span class=p>(</span><span class=n>any</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å‘æœåŠ¡ç«¯å‘é€æ•°æ®ï¼Œç»è¿‡æœåŠ¡ç«¯è½¬å‘åˆ°å„ä¸ªè¿›ç¨‹ï¼ˆåŒ…æ‹¬ä¸»è¿›ç¨‹ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>post</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>postToService</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>app</span><span class=p>:</span> <span class=n>Application</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æœåŠ¡ç«¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>EventBusManagerService</span> <span class=p>:</span> <span class=n>Service</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å„ä¸ªè¿›ç¨‹çš„äº‹ä»¶åˆ†å‘å™¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>private</span> <span class=k>val</span> <span class=py>mDispatchers</span> <span class=p>=</span> <span class=n>RemoteCallbackList</span><span class=p>&lt;</span><span class=n>IEventDispatcher</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æœåŠ¡ç«¯å®ç°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>private</span> <span class=k>val</span> <span class=py>mEventBusManagerService</span> <span class=p>=</span> <span class=k>object</span> <span class=err>: </span><span class=nc>IEventBusManager</span><span class=p>.</span><span class=n>Stub</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>register</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>:</span> <span class=n>IEventDispatcher</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dispatcher</span> <span class=o>?:</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=n>mDispatchers</span><span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>unregister</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>:</span> <span class=n>IEventDispatcher</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dispatcher</span> <span class=o>?:</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=n>mDispatchers</span><span class=p>.</span><span class=n>unregister</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>postToService</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dispatchEvent</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onBind</span><span class=p>(</span><span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>?)</span> <span class=p>=</span> <span class=n>mEventBusManagerService</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * åˆ†å‘äº‹ä»¶åˆ°å„ä¸ªè¿›ç¨‹
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>fun</span> <span class=nf>dispatchEvent</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>n</span> <span class=p>=</span> <span class=n>mDispatchers</span><span class=p>.</span><span class=n>beginBroadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=k>in</span> <span class=m>0</span> <span class=n>until</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>dispatcher</span> <span class=p>=</span> <span class=n>mDispatchers</span><span class=p>.</span><span class=n>getBroadcastItem</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>dispatcher</span><span class=p>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>mDispatchers</span><span class=p>.</span><span class=n>finishBroadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#ä½¿ç”¨ç¤ºä¾‹><h3 id=ä½¿ç”¨ç¤ºä¾‹><span class=hanchor arialabel=Anchor># </span>ä½¿ç”¨ç¤ºä¾‹</h3></a><p>æˆ‘ä»¬é¦–å…ˆåœ¨ AndroidMenifest ä¸­æ³¨å†Œä¸€ä¸‹ <code>IPCEventBus$EventBusManagerService</code>ï¼›é¡ºä¾¿æ³¨å†Œä¸€ä¸‹ä¸‰ä¸ªåœ¨ä¸åŒè¿›ç¨‹çš„ Activityï¼Œæ–¹ä¾¿æˆ‘ä»¬æµ‹è¯•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- ä¸»è¿›ç¨‹çš„Activity --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>activity</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;.MainActivity&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>intent-filter</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>action</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;android.intent.action.VIEW&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>action</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;android.intent.action.MAIN&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>category</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;android.intent.category.LAUNCHER&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>intent-filter</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>activity</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- å­è¿›ç¨‹1çš„Activity --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>activity</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;.SecondActivity&#34;</span> <span class=na>android:process</span><span class=o>=</span><span class=s>&#34;:second&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- å­è¿›ç¨‹2çš„Activity --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>activity</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;.ThirdActivity&#34;</span> <span class=na>android:process</span><span class=o>=</span><span class=s>&#34;:third&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>service</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;xyz.yorek.eventbus.IPCEventBus$EventBusManagerService&#34;</span> <span class=p>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢ä¸‰ä¸ª Activity å¼•ç”¨äº†åŒæ ·çš„å¸ƒå±€æ–‡ä»¶ï¼Œæ‹¥æœ‰åŒæ ·çš„ä»£ç ã€‚å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ä¸‰è€…çš„ TAG ä¸ä¸€æ ·ï¼Œç”¨æ¥åŒºåˆ†å‘å‡ºçš„æ¶ˆæ¯ã€‚</p><p>ä¸‹é¢æ˜¯ MainActivity çš„å¸ƒå±€ä»¥åŠä»£ç ï¼š</p><p><strong>src/main/res/layout/activity_main.xml</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;androidx.constraintlayout.widget.ConstraintLayout</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:app=</span><span class=s>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:tools=</span><span class=s>&#34;http://schemas.android.com/tools&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>tools:context=</span><span class=s>&#34;.MainActivity&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Button</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/btnPost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:text=</span><span class=s>&#34;post&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:onClick=</span><span class=s>&#34;post&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintBottom_toBottomOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintLeft_toLeftOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintRight_toRightOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toTopOf=</span><span class=s>&#34;parent&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Button</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/btnFirst&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:text=</span><span class=s>&#34;first&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:onClick=</span><span class=s>&#34;first&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/btnPost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toStartOf=</span><span class=s>&#34;@+id/btnSecond&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Button</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/btnSecond&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:text=</span><span class=s>&#34;second&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:onClick=</span><span class=s>&#34;second&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/btnPost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toEndOf=</span><span class=s>&#34;@id/btnFirst&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toStartOf=</span><span class=s>&#34;@+id/btnThird&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Button</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/btnThird&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:text=</span><span class=s>&#34;third&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:onClick=</span><span class=s>&#34;third&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/btnPost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toEndOf=</span><span class=s>&#34;@id/btnSecond&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;parent&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>app/src/main/java/xyz/yorek/eventbus/MainActivity.kt</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>const</span> <span class=k>val</span> <span class=py>TAG</span> <span class=p>=</span> <span class=s2>&#34;MainActivity&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MainActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>IPCEventBus</span><span class=p>.</span><span class=k>init</span><span class=p>(</span><span class=n>application</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_main</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEventReceived</span><span class=p>(</span><span class=n>any</span><span class=p>:</span> <span class=n>Any</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s2>&#34;receive message : </span><span class=si>$any</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>post</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>msg</span> <span class=p>=</span> <span class=s2>&#34;Hello World, from </span><span class=si>$TAG</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>post</span><span class=p>(</span><span class=n>IPCEvent</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=n>msg</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>first</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>MainActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>second</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>SecondActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>third</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>ThirdActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ MainActivity ä¸­æˆ‘ä»¬ post ä¸€ä¸‹æ¶ˆæ¯ï¼Œç„¶åè¿›å…¥ SecondActivity å†æ¬¡ postï¼Œè¿›å…¥ ThirdActivity åæœ€åä¸€æ¬¡ postã€‚</p><p>å„ä¸ªè¿›ç¨‹æ—¥å¿—å¦‚ä¸‹ï¼ˆæŒ‰ç…§æ—¥å¿—æ—¶é—´é¡ºåºï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-apache data-lang=apache><span class=line><span class=cl><span class=err>1569683305</span>.<span class=err>912</span> <span class=err>31157-31157/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : IPCEvent{code=1, msg=&#39;Hello World, from MainActivity&#39;}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>1569683307</span>.<span class=err>622</span> <span class=err>31157-31169/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569683307</span>.<span class=err>625</span> <span class=err>31093-31093/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: receive message : IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>1569683309</span>.<span class=err>245</span> <span class=err>31157-31169/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569683309</span>.<span class=err>245</span> <span class=err>31210-31210/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>third</span> E/ThirdActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569683309</span>.<span class=err>246</span> <span class=err>31093-31246/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span></code></pre></td></tr></table></div></div><p>ä»ä¸Šé¢çš„æ—¥å¿—æ¥çœ‹ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†è·¨è¿›ç¨‹ EventBus çš„åŠŸèƒ½ã€‚</p><p>ä¸‹é¢çš„æ—¥å¿—æ˜¯ä¸€ä»½è¯¦ç»†è®°è½½äº†å„ä¸ªäº‹ä»¶çš„æ—¥å¿—ã€‚ä»æ—¥å¿—çš„ä¸­å¯ä»¥çœ‹å‡ºï¼šæœ¬è¿›ç¨‹çš„æŸçº¿ç¨‹å‘å‡ºçš„äº‹ä»¶ä¼šç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è§¦å‘ï¼›å…¶ä»–è¿›ç¨‹å‘å‡ºçš„äº‹ä»¶ï¼Œä¼šç”±æœ¬è¿›ç¨‹ Binder çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹è§¦å‘ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-apache data-lang=apache><span class=line><span class=cl><span class=err>1569683981</span>.<span class=err>405</span> <span class=err>31484-31484/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch begin : main
</span></span><span class=line><span class=cl><span class=err>1569683981</span>.<span class=err>405</span> <span class=err>31484-31484/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : main IPCEvent{code=1, msg=&#39;Hello World, from MainActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569683981</span>.<span class=err>406</span> <span class=err>31484-31484/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch end : main
</span></span><span class=line><span class=cl><span class=err>1569683981</span>.<span class=err>406</span> <span class=err>31484-31484/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: post message done : main
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>794</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch begin : Binder:31484_1
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>794</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : Binder:31484_1 IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>799</span> <span class=err>32016-32016/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: receive message : main IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>803</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch end : Binder:31484_1
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>804</span> <span class=err>32016-32016/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: post message done : main
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>762</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch begin : Binder:31484_1
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>762</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : Binder:31484_1 IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>764</span> <span class=err>32063-32063/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>third</span> E/ThirdActivity: receive message : main IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>765</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch end : Binder:31484_1
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>765</span> <span class=err>32016-32089/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: receive message : Binder:32016_4 IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>766</span> <span class=err>32063-32063/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>third</span> E/ThirdActivity: post message done : main
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>