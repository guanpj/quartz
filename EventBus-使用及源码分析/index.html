<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="EventBus 使用及源码分析 使用  首先引入依赖  1 2 3 4 5 6 7 8 9 10 11 12  apply plugin: 'kotlin-kapt' dependencies { implementation 'org."><meta property="og:title" content><meta property="og:description" content="EventBus 使用及源码分析 使用  首先引入依赖  1 2 3 4 5 6 7 8 9 10 11 12  apply plugin: 'kotlin-kapt' dependencies { implementation 'org."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="EventBus 使用及源码分析 使用  首先引入依赖  1 2 3 4 5 6 7 8 9 10 11 12  apply plugin: 'kotlin-kapt' dependencies { implementation 'org."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>🌻 guanpjの花园 🌵</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.0452046239b15cdfa822e3a8fa41b16d.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.9fddd62f4f9253cd4caef08e6b155b10.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.80e532876cce07a5a16fddacc610a74a.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown</p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#eventbus-使用及源码分析>EventBus 使用及源码分析</a></li><li><a href=#使用>使用</a></li><li><a href=#分析>分析</a><ol><li><a href=#获取-eventbus-实例>获取 EventBus 实例</a></li><li><a href=#index-文件分析>Index 文件分析</a><ol><li><a href=#index-文件概览>Index 文件概览</a></li><li><a href=#类介绍>类介绍</a><ol><li><a href=#subscriberinfo-继承关系>SubscriberInfo 继承关系</a></li><li><a href=#subscribermethod>SubscriberMethod</a></li><li><a href=#subscribermethodinfo>SubscriberMethodInfo</a></li></ol></li><li><a href=#subscriberinfo-映射>SubscriberInfo 映射</a></li></ol></li><li><a href=#register-流程>register 流程</a><ol><li><a href=#subscribermethodfinderfindsubscribermethods>SubscriberMethodFinder.findSubscriberMethods()</a><ol><li><a href=#subscribermethodfinderfindusinginfo>SubscriberMethodFinder.findUsingInfo()</a><ol><li><a href=#subscribermethodfinderpreparefindstate>SubscriberMethodFinder.prepareFindState()</a></li><li><a href=#findstateinitforsubscriber>FindState.initForSubscriber()</a></li><li><a href=#subscribermethodfindergetsubscriberinfo>SubscriberMethodFinder.getSubscriberInfo()</a></li></ol></li><li><a href=#subscribermethodfinderfindusingreflection>SubscriberMethodFinder.findUsingReflection()</a></li></ol></li><li><a href=#eventbussubscribe>EventBus.subscribe()</a></li></ol></li><li><a href=#post-流程>post 流程</a></li><li><a href=#unregister-流程>unregister 流程</a></li><li><a href=#跨进程-eventbus>跨进程 EventBus</a><ol><li><a href=#简单实现>简单实现</a></li><li><a href=#使用示例>使用示例</a></li></ol></li></ol></li></ol></nav></details></aside><a href=#eventbus-使用及源码分析><h1 id=eventbus-使用及源码分析><span class=hanchor arialabel=Anchor># </span>EventBus 使用及源码分析</h1></a><a href=#使用><h1 id=使用><span class=hanchor arialabel=Anchor># </span>使用</h1></a><ol><li>首先引入依赖</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>apply</span> <span class=nl>plugin:</span> <span class=s1>&#39;kotlin-kapt&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s1>&#39;org.greenrobot:eventbus:3.2.0&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>kapt</span> <span class=s1>&#39;org.greenrobot:eventbus-annotation-processor:3.2.0&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>kapt</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>arguments</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>arg</span><span class=o>(</span><span class=s1>&#39;eventBusIndex&#39;</span><span class=o>,</span> <span class=s1>&#39;com.me.guanpj.myapplication.MyEventBusIndex&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从在 3.0 版本开始，EventBus 提供了一个 EventBusAnnotationProcessor 注解处理器来在编译期通过读取 @Subscribe 注解，并解析和处理其中所包含的信息，然后生成 Java 类索引来保存订阅者中所有的事件响应函数，这样就比在运行时使用反射来获得订阅者中所有事件响应函数的速度要快。</p><p>以下是来自官方对 EventBus 各个版本性能的对比图，可以看到，EventBus 3.x 如果没有使用索引的话性能相较于之前的版本是倒退的。使用索引能让 EventBus 的性能大大增加。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/EventBus/clipboard_20230323_031615.png width=auto alt></p><ol start=2><li>添加混淆规则：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>-keepattributes *Annotation*
</span></span><span class=line><span class=cl>-keepclassmembers class * {
</span></span><span class=line><span class=cl>    @org.greenrobot.eventbus.Subscribe &lt;methods&gt;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>-keep enum org.greenrobot.eventbus.ThreadMode { *; }
</span></span><span class=line><span class=cl> # And if you use AsyncExecutor:
</span></span><span class=line><span class=cl>-keepclassmembers class * extends org.greenrobot.eventbus.util.ThrowableFailureEvent {
</span></span><span class=line><span class=cl>    &lt;init&gt;(java.lang.Throwable);
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>使用索引文件创建全局 EventBus 实例</li></ol><p>经过以上配置，就可以使用生成的 <code>com.me.guanpj.myapplication.MyEventBusIndex</code> 创建 EventBus 了。</p><blockquote><p>注意：如果项目中没有被 @Subscribe 标记的事件接收方法， 则不会生成索引类。</p></blockquote><p>推荐在 Application 中使用生成的索引创建全局 EventBus 实例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyApplication</span> <span class=p>:</span> <span class=n>Application</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>builder</span><span class=p>().</span><span class=n>addIndex</span><span class=p>(</span><span class=n>MyEventBusIndex</span><span class=p>()).</span><span class=n>installDefaultEventBus</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样后面通过 <code>EventBus.getDefault()</code> 获取的 EventBus 实例都是刚才通过索引创建的。</p><p>如果既有 Library 的索引，也有 App 的索引，可以在 EventBus 设置过程中一起添加：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>EventBus</span><span class=p>.</span><span class=n>builder</span><span class=p>().</span><span class=n>addIndex</span><span class=p>(</span><span class=n>MyEventBusAppIndex</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addIndex</span><span class=p>(</span><span class=n>MyEventBusLibIndex</span><span class=p>()).</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>installDefaultEventBus</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，如果在某些情况下不想使用全局实例，也可以单独生成一个实例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>eventBus</span> <span class=p>=</span> <span class=n>EventBus</span><span class=p>.</span><span class=n>builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 事件接收对象是否有层次结构（默认为 true，超类也将被通知）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>eventInheritance</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 忽略索引文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>ignoreGeneratedIndex</span><span class=p>(</span><span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 打印没有订阅消息，默认为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>logNoSubscriberMessages</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 打印订阅异常的消息，默认为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>logSubscriberExceptions</span><span class=p>(</span><span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置发送的的事件在没有订阅者的情况时，EventBus是否保持静默，默认为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>sendNoSubscriberEvent</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送分发事件的异常，默认为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>sendSubscriberExceptionEvent</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//如果 onEvent*** 方法出现异常，是否将此异常分发给订阅者，默认为 false
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>throwSubscriberException</span><span class=p>(</span><span class=n>BuildConfig</span><span class=p>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 定义一个线程池用于处理后台线程和异步线程分发事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>executorService</span><span class=p>(</span><span class=n>Executors</span><span class=p>.</span><span class=n>newSingleThreadExecutor</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 启用严格的方法验证（在 3.0 以前，接收处理事件的方法名必须以 onEvent 开头）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 默认为 false
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>strictMethodVerification</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 为特定时间跳过方法验证，包括方法名、限定符
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>skipMethodVerificationFor</span><span class=p>(</span><span class=n>ButtonEvent</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>eventBus</span><span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>定义事件</li></ol><p>新建一个实体类用于事件的传递：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>package</span> <span class=nn>com.me.guanpj.myapplication.event</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>data</span> <span class=k>class</span> <span class=nc>MessageEvent</span><span class=p>(</span><span class=k>val</span> <span class=py>message</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>发送和接收事件</li></ol><p>在需要接收事件的 Activity、Fragment 或者其它地方调用一次 <code>EventBus.getDefault().register(this)</code> 进行注册，然后使用 <code>@Subscribe</code> 注解标记接收事件的方法，方法参数为一个实体类，或者基本数据类型。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventBusActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>buttonClick</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>android</span><span class=p>.</span><span class=n>view</span><span class=p>.</span><span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//EventBus.getDefault().post(MessageEvent(&#34;click&#34;))
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>postSticky</span><span class=p>(</span><span class=n>MessageEvent</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>jump</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>AnotherActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>MAIN</span><span class=p>,</span> <span class=n>priority</span> <span class=p>=</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEvent</span><span class=p>(</span><span class=n>event</span> <span class=p>:</span> <span class=n>MessageEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;EventBusActivity onEvent receive msg: </span><span class=si>${event.message}</span><span class=s2> in thread: </span><span class=si>${Thread.currentThread().name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>BACKGROUND</span><span class=p>,</span> <span class=n>priority</span> <span class=p>=</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEvent1</span><span class=p>(</span><span class=n>event</span> <span class=p>:</span> <span class=n>MessageEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;EventBusActivity onEvent1 receive msg: </span><span class=si>${event.message}</span><span class=s2> in thread: </span><span class=si>${Thread.currentThread().name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>BACKGROUND</span><span class=p>,</span> <span class=n>priority</span> <span class=p>=</span> <span class=m>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEvent2</span><span class=p>(</span><span class=n>event</span> <span class=p>:</span> <span class=n>MessageEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;EventBusActivity onEvent2 receive msg: </span><span class=si>${event.message}</span><span class=s2> in thread: </span><span class=si>${Thread.currentThread().name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>AnotherActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_another</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>MAIN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEvent</span><span class=p>(</span><span class=n>event</span> <span class=p>:</span> <span class=n>MessageEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;AnotherActivity onEvent receive msg: </span><span class=si>${event.message}</span><span class=s2> in thread: </span><span class=si>${Thread.currentThread().name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 粘性事件不会被消耗，除非手动移除
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>removeStickyEvent</span><span class=p>(</span><span class=n>MessageEvent</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>每次输出的日志都是一样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>EventBusActivity onEvent receive msg: click in thread: main
</span></span><span class=line><span class=cl>EventBusActivity onEvent2 receive msg: click in thread: pool-2-thread-1
</span></span><span class=line><span class=cl>EventBusActivity onEvent1 receive msg: click in thread: pool-2-thread-1
</span></span><span class=line><span class=cl>//打开 MainActivity 后
</span></span><span class=line><span class=cl>AnotherActivity receive msg: click in thread: main
</span></span></code></pre></td></tr></table></div></div><a href=#分析><h1 id=分析><span class=hanchor arialabel=Anchor># </span>分析</h1></a><a href=#获取-eventbus-实例><h2 id=获取-eventbus-实例><span class=hanchor arialabel=Anchor># </span>获取 EventBus 实例</h2></a><p>不管是用 <code>EventBus.getDefault()</code> 还是 <code>EventBus.builder()</code> 都能够获取到 EventBus 对象，只不过前者是获取一个全局的单例，后者是使用 builder() 配置出一个新的对象。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>EventBus</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>EventBusBuilder</span> <span class=n>DEFAULT_BUILDER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>EventBusBuilder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;&gt;</span> <span class=n>subscriptionsByEventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;&gt;</span> <span class=n>typesBySubscriber</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>stickyEvents</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>EventBus</span> <span class=nf>getDefault</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span> <span class=n>instance</span> <span class=o>=</span> <span class=n>defaultInstance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>instance</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>synchronized</span> <span class=o>(</span><span class=n>EventBus</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>instance</span> <span class=o>=</span> <span class=n>EventBus</span><span class=o>.</span><span class=na>defaultInstance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>instance</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>instance</span> <span class=o>=</span> <span class=n>EventBus</span><span class=o>.</span><span class=na>defaultInstance</span> <span class=o>=</span> <span class=k>new</span> <span class=n>EventBus</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>instance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>EventBusBuilder</span> <span class=nf>builder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>EventBusBuilder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>EventBus</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>(</span><span class=n>DEFAULT_BUILDER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>EventBus</span><span class=o>(</span><span class=n>EventBusBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>getLogger</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriptionsByEventType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>typesBySubscriber</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>stickyEvents</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mainThreadSupport</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>getMainThreadSupport</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>mainThreadPoster</span> <span class=o>=</span> <span class=n>mainThreadSupport</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>mainThreadSupport</span><span class=o>.</span><span class=na>createPoster</span><span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>backgroundPoster</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BackgroundPoster</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncPoster</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AsyncPoster</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>indexCount</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>subscriberInfoIndexes</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>builder</span><span class=o>.</span><span class=na>subscriberInfoIndexes</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>:</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriberMethodFinder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SubscriberMethodFinder</span><span class=o>(</span><span class=n>builder</span><span class=o>.</span><span class=na>subscriberInfoIndexes</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=o>.</span><span class=na>strictMethodVerification</span><span class=o>,</span> <span class=n>builder</span><span class=o>.</span><span class=na>ignoreGeneratedIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>logSubscriberExceptions</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>logSubscriberExceptions</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>logNoSubscriberMessages</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>logNoSubscriberMessages</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>sendSubscriberExceptionEvent</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>sendSubscriberExceptionEvent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>sendNoSubscriberEvent</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>sendNoSubscriberEvent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>throwSubscriberException</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>throwSubscriberException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>eventInheritance</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>eventInheritance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>executorService</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>executorService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，两种获取对象的方式都会调用到 <code>EventBus(EventBusBuilder builder)</code> 这个构造方法，<code>getDefault()</code> 只是最终传入了一个空的 <code>EventBusBuilder</code> 对象而已。</p><p>在 <code>EventBus(EventBusBuilder builder)</code> 构造方法中：</p><p>在注释 1 处，创建了一个 subscriptionsByEventType 对象，可以看到它是一个 HashMap，并且其 key 表示 Event 的类型，value 为 CopyOnWriteArrayList<subscription>。这里的 Subscription 是一个订阅信息对象，它里面保存了两个重要的字段，一个是类型为 Object 的 subscriber，该字段即为注册的对象（在 Android 中时通常是 Activity 或着 Fragment 对象）；另一个是类型为 SubscriberMethod 的实例，它就是被 @Subscribe 注解的那个订阅方法，里面保存了一个重要的字段：eventType，它的类型为 Class，表示 Event 的类型。</p><p>在注释 2 处，新建了一个类型为 HashMap 的 typesBySubscriber 对象，它的 key 为 subscriber 对象， value 为 subscriber 对象中所有的 Event 类型 List，日常使用中仅用于判断某个对象是否注册过。</p><p>在注释 3 处新建了一个类型为 ConcurrentHashMap 的 stickyEvents 对象，专用于粘性事件处理的，key 同样为 Event 的类型，value 为当前的事件。</p><blockquote><p>普通事件是先注册，然后发送事件才能收到；而粘性事件在发送事件之后再订阅也能收到。并且，粘性事件会保存在内存中，每次进入都会去内存中查找获取最新的粘性事件，除非手动移除事件。</p></blockquote><p>在注释 4 处，新建了三个不同类型的事件发送器：</p><ul><li>mainThreadPoster：主线程事件发送器，通过它的 <code>mainThreadPoster.enqueue(subscription, event)</code> 方法可以将订阅信息和对应的事件进行入队，然后通过 handler 去发送一个消息，在 handler 的 <code>handleMessage()</code> 中去执行方法。</li><li>backgroundPoster：后台事件发送器，通过它的 <code>enqueue()</code> 将方法加入到后台的一个队列，最后通过线程池去执行，同时它保证任一时间只且仅能有一个任务会被线程池执行。</li><li>asyncPoster：实现逻辑类似于 backgroundPoster，不同于 backgroundPoster 的保证任一时间只且仅能有一个任务会被线程池执行的特性，asyncPoster 则是异步运行的，可以同时接收多个任务。</li></ul><p>再看注释 5 这行代码，这里新建了一个 SubscriberMethodFinder 对象，这是从 EventBus 中抽离出的订阅方法查询的一个对象，在优秀的源码中，我们经常能看到<strong>组合优于继承</strong>的这种实现思想。</p><p>在注释 6 处，从 builder 中取出了一个默认的线程池对象，它由 <strong>Executors 的 newCachedThreadPool() 方法创建，它是一个有则用、无则创建、无数量上限</strong>的线程池。</p><a href=#index-文件分析><h2 id=index-文件分析><span class=hanchor arialabel=Anchor># </span>Index 文件分析</h2></a><a href=#index-文件概览><h3 id=index-文件概览><span class=hanchor arialabel=Anchor># </span>Index 文件概览</h3></a><p>生成的索引类如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MyEventBusIndex</span> <span class=kd>implements</span> <span class=n>SubscriberInfoIndex</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>SubscriberInfo</span><span class=o>&gt;</span> <span class=n>SUBSCRIBER_INDEX</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SUBSCRIBER_INDEX</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>SubscriberInfo</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>putIndex</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleSubscriberInfo</span><span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>EventBusActivity</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>[]</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>(</span><span class=s>&#34;onEvent&#34;</span><span class=o>,</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>MessageEvent</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>ThreadMode</span><span class=o>.</span><span class=na>MAIN</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>(</span><span class=s>&#34;onEvent1&#34;</span><span class=o>,</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>MessageEvent</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>ThreadMode</span><span class=o>.</span><span class=na>BACKGROUND</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=kc>false</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>(</span><span class=s>&#34;onEvent2&#34;</span><span class=o>,</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>MessageEvent</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>ThreadMode</span><span class=o>.</span><span class=na>BACKGROUND</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=kc>false</span><span class=o>),</span>
</span></span><span class=line><span class=cl>        <span class=o>}));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>putIndex</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleSubscriberInfo</span><span class=o>(</span><span class=n>MainActivity</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>[]</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>(</span><span class=s>&#34;onEvent3&#34;</span><span class=o>,</span> <span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>event</span><span class=o>.</span><span class=na>MessageEvent</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>ThreadMode</span><span class=o>.</span><span class=na>MAIN</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>3</span><span class=o>,</span> <span class=kc>true</span><span class=o>),</span>
</span></span><span class=line><span class=cl>        <span class=o>}));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>putIndex</span><span class=o>(</span><span class=n>SubscriberInfo</span> <span class=n>info</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SUBSCRIBER_INDEX</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>info</span><span class=o>.</span><span class=na>getSubscriberClass</span><span class=o>(),</span> <span class=n>info</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>SubscriberInfo</span> <span class=nf>getSubscriberInfo</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SubscriberInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>SUBSCRIBER_INDEX</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>info</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>info</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#类介绍><h3 id=类介绍><span class=hanchor arialabel=Anchor># </span>类介绍</h3></a><a href=#subscriberinfo-继承关系><h4 id=subscriberinfo-继承关系><span class=hanchor arialabel=Anchor># </span>SubscriberInfo 继承关系</h4></a><p>可以看到，这里新建了一个 Map 集合，用于存放事件订阅类和它们的订阅方法</p><p><code>SubscriberInfo</code> 之间的映射。<code>SubscriberInfo</code> 的定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>SubscriberInfo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>getSubscriberClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=nf>getSubscriberMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SubscriberInfo</span> <span class=nf>getSuperSubscriberInfo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=nf>shouldCheckSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里 <code>SubscriberInfo</code> 的实现类为 <code>SimpleSubscriberInfo</code>，而中间还有一个 <code>AbstractSubscriberInfo</code>，它们的定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>AbstractSubscriberInfo</span> <span class=kd>implements</span> <span class=n>SubscriberInfo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>SubscriberInfo</span><span class=o>&gt;</span> <span class=n>superSubscriberInfoClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>shouldCheckSuperclass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=nf>AbstractSubscriberInfo</span><span class=o>(</span><span class=n>Class</span> <span class=n>subscriberClass</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>SubscriberInfo</span><span class=o>&gt;</span> <span class=n>superSubscriberInfoClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                     <span class=kt>boolean</span> <span class=n>shouldCheckSuperclass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>subscriberClass</span> <span class=o>=</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>superSubscriberInfoClass</span> <span class=o>=</span> <span class=n>superSubscriberInfoClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>shouldCheckSuperclass</span> <span class=o>=</span> <span class=n>shouldCheckSuperclass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Class</span> <span class=nf>getSubscriberClass</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>SubscriberInfo</span> <span class=nf>getSuperSubscriberInfo</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=n>superSubscriberInfoClass</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>superSubscriberInfoClass</span><span class=o>.</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InstantiationException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IllegalAccessException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>shouldCheckSuperclass</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>shouldCheckSuperclass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>SubscriberMethod</span> <span class=nf>createSubscriberMethod</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>createSubscriberMethod</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>ThreadMode</span><span class=o>.</span><span class=na>POSTING</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>SubscriberMethod</span> <span class=nf>createSubscriberMethod</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>createSubscriberMethod</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>SubscriberMethod</span> <span class=nf>createSubscriberMethod</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>,</span><span class=kt>int</span> <span class=n>priority</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Method</span> <span class=n>method</span> <span class=o>=</span> <span class=n>subscriberClass</span><span class=o>.</span><span class=na>getDeclaredMethod</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>SubscriberMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span> <span class=n>priority</span><span class=o>,</span> <span class=n>sticky</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchMethodException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Could not find subscriber method in &#34;</span> <span class=o>+</span> <span class=n>subscriberClass</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;. Maybe a missing ProGuard rule?&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SimpleSubscriberInfo</span> <span class=kd>extends</span> <span class=n>AbstractSubscriberInfo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>SubscriberMethodInfo</span><span class=o>[]</span> <span class=n>methodInfos</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SimpleSubscriberInfo</span><span class=o>(</span><span class=n>Class</span> <span class=n>subscriberClass</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>shouldCheckSuperclass</span><span class=o>,</span> <span class=n>SubscriberMethodInfo</span><span class=o>[]</span> <span class=n>methodInfos</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>shouldCheckSuperclass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>methodInfos</span> <span class=o>=</span> <span class=n>methodInfos</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=nf>getSubscriberMethods</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>methodInfos</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=n>methods</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SubscriberMethod</span><span class=o>[</span><span class=n>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberMethodInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>methodInfos</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=n>methods</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>createSubscriberMethod</span><span class=o>(</span><span class=n>info</span><span class=o>.</span><span class=na>methodName</span><span class=o>,</span> <span class=n>info</span><span class=o>.</span><span class=na>eventType</span><span class=o>,</span> <span class=n>info</span><span class=o>.</span><span class=na>threadMode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>info</span><span class=o>.</span><span class=na>priority</span><span class=o>,</span> <span class=n>info</span><span class=o>.</span><span class=na>sticky</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>methods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#subscribermethod><h4 id=subscribermethod><span class=hanchor arialabel=Anchor># </span>SubscriberMethod</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SubscriberMethod</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Method</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** Used for efficient comparison */</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>methodString</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SubscriberMethod</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>,</span> <span class=kt>int</span> <span class=n>priority</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>method</span> <span class=o>=</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>threadMode</span> <span class=o>=</span> <span class=n>threadMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>eventType</span> <span class=o>=</span> <span class=n>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>sticky</span> <span class=o>=</span> <span class=n>sticky</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>other</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>other</span> <span class=o>==</span> <span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>other</span> <span class=k>instanceof</span> <span class=n>SubscriberMethod</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>checkMethodString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberMethod</span> <span class=n>otherSubscriberMethod</span> <span class=o>=</span> <span class=o>(</span><span class=n>SubscriberMethod</span><span class=o>)</span><span class=n>other</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>otherSubscriberMethod</span><span class=o>.</span><span class=na>checkMethodString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Don&#39;t use method.equals because of http://code.google.com/p/android/issues/detail?id=7811#c6
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=n>methodString</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>otherSubscriberMethod</span><span class=o>.</span><span class=na>methodString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>checkMethodString</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>methodString</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Method.toString has more overhead, just take relevant parts of the method
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>StringBuilder</span> <span class=n>builder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>64</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;#&#39;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;(&#39;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>eventType</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>methodString</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>method</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#subscribermethodinfo><h4 id=subscribermethodinfo><span class=hanchor arialabel=Anchor># </span>SubscriberMethodInfo</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SubscriberMethodInfo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>String</span> <span class=n>methodName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SubscriberMethodInfo</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>,</span> <span class=kt>int</span> <span class=n>priority</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>sticky</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>methodName</span> <span class=o>=</span> <span class=n>methodName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>threadMode</span> <span class=o>=</span> <span class=n>threadMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>eventType</span> <span class=o>=</span> <span class=n>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>sticky</span> <span class=o>=</span> <span class=n>sticky</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SubscriberMethodInfo</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>ThreadMode</span><span class=o>.</span><span class=na>POSTING</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SubscriberMethodInfo</span><span class=o>(</span><span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>ThreadMode</span> <span class=n>threadMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>(</span><span class=n>methodName</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#subscriberinfo-映射><h3 id=subscriberinfo-映射><span class=hanchor arialabel=Anchor># </span>SubscriberInfo 映射</h3></a><p>回到 <code>MyEventBusIndex</code> 的 static 代码块，对于每一个调用过 <code>EventBus.register()</code> 方法的类，APT（Annotation Processing Tool）都会为它生成一行 <code>putIndex(...)</code> 代码，并传入一个新建的 <code>SimpleSubscriberInfo</code> 对象。</p><p>在 <code>putIndex()</code> 方法中会调用传入的 <code>SimpleSubscriberInfo.getSubscriberClass()</code> 获取到订阅类的 Class 对象作为 key，同时把自身作为 value 存放进 Map 中。</p><a href=#register-流程><h2 id=register-流程><span class=hanchor arialabel=Anchor># </span>register 流程</h2></a><p>先看 <code>EventBus.register</code> 方法，在分析过程中遇到的字段再回过头来分析。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>register</span><span class=o>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取 subscriber 的 Class 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span> <span class=o>=</span> <span class=n>subscriber</span><span class=o>.</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 根据 Class 信息获取到所有加了 @Subscribe 的事件回调方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>subscriberMethodFinder</span><span class=o>.</span><span class=na>findSubscriberMethods</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 遍历各个方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span> <span class=o>:</span> <span class=n>subscriberMethods</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 执行订阅操作
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>subscribe</span><span class=o>(</span><span class=n>subscriber</span><span class=o>,</span> <span class=n>subscriberMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的代码可以分为两个部分，2~3 行完成了获取注册对象中加了 <code>@Subscribe</code> 的事件回调方法，后面的代码真正完成了注册。</p><a href=#subscribermethodfinderfindsubscribermethods><h3 id=subscribermethodfinderfindsubscribermethods><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.findSubscriberMethods()</h3></a><p><code>subscriberMethodFinder</code> 在 EventBus 创建的时候就已经确定了，它的定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SubscriberMethodFinder</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>BRIDGE</span> <span class=o>=</span> <span class=n>0x40</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SYNTHETIC</span> <span class=o>=</span> <span class=n>0x1000</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MODIFIERS_IGNORE</span> <span class=o>=</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>ABSTRACT</span> <span class=o>|</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>STATIC</span> <span class=o>|</span> <span class=n>BRIDGE</span> <span class=o>|</span> <span class=n>SYNTHETIC</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;&gt;</span> <span class=n>METHOD_CACHE</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberInfoIndex</span><span class=o>&gt;</span> <span class=n>subscriberInfoIndexes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>strictMethodVerification</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>ignoreGeneratedIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>POOL_SIZE</span> <span class=o>=</span> <span class=n>4</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>FindState</span><span class=o>[]</span> <span class=n>FIND_STATE_POOL</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FindState</span><span class=o>[</span><span class=n>POOL_SIZE</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SubscriberMethodFinder</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberInfoIndex</span><span class=o>&gt;</span> <span class=n>subscriberInfoIndexes</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>strictMethodVerification</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                           <span class=kt>boolean</span> <span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>subscriberInfoIndexes</span> <span class=o>=</span> <span class=n>subscriberInfoIndexes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>strictMethodVerification</span> <span class=o>=</span> <span class=n>strictMethodVerification</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>ignoreGeneratedIndex</span> <span class=o>=</span> <span class=n>ignoreGeneratedIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findSubscriberMethods</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethods</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingReflection</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingInfo</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethods</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Subscriber &#34;</span> <span class=o>+</span> <span class=n>subscriberClass</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=s>&#34; and its super classes have no public methods with the @Subscribe annotation&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>,</span> <span class=n>subscriberMethods</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingInfo</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>findState</span><span class=o>.</span><span class=na>initForSubscriber</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>=</span> <span class=n>getSubscriberInfo</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=n>array</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSubscriberMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span> <span class=o>:</span> <span class=n>array</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>checkAdd</span><span class=o>(</span><span class=n>subscriberMethod</span><span class=o>.</span><span class=na>method</span><span class=o>,</span> <span class=n>subscriberMethod</span><span class=o>.</span><span class=na>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>subscriberMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>findState</span><span class=o>.</span><span class=na>moveToSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>getMethodsAndRelease</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>findState</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>POOL_SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>findState</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>FindState</span> <span class=nf>prepareFindState</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>POOL_SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>FindState</span> <span class=n>state</span> <span class=o>=</span> <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>state</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>state</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>FindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>SubscriberInfo</span> <span class=nf>getSubscriberInfo</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSuperSubscriberInfo</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberInfo</span> <span class=n>superclassInfo</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSuperSubscriberInfo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>==</span> <span class=n>superclassInfo</span><span class=o>.</span><span class=na>getSubscriberClass</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>superclassInfo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>subscriberInfoIndexes</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberInfoIndex</span> <span class=n>index</span> <span class=o>:</span> <span class=n>subscriberInfoIndexes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>SubscriberInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=na>getSubscriberInfo</span><span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>info</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>info</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingReflection</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>findState</span><span class=o>.</span><span class=na>initForSubscriber</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>findState</span><span class=o>.</span><span class=na>moveToSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Method</span><span class=o>[]</span> <span class=n>methods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// This is faster than getMethods, especially when subscribers are fat classes like Activities
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getDeclaredMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>th</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>LinkageError</span> <span class=n>error</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// super class of NoClassDefFoundError to be a bit more broad...
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>String</span> <span class=n>msg</span> <span class=o>=</span> <span class=s>&#34;Could not inspect methods of &#34;</span> <span class=o>+</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>msg</span> <span class=o>+=</span> <span class=s>&#34;. Please consider using EventBus annotation processor to avoid reflection.&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>msg</span> <span class=o>+=</span> <span class=s>&#34;. Please make this class visible to EventBus annotation processor to avoid reflection.&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>error</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>findState</span><span class=o>.</span><span class=na>skipSuperClasses</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Method</span> <span class=n>method</span> <span class=o>:</span> <span class=n>methods</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>modifiers</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>PUBLIC</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>MODIFIERS_IGNORE</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>parameterTypes</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span> <span class=o>==</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Subscribe</span> <span class=n>subscribeAnnotation</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getAnnotation</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>subscribeAnnotation</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>=</span> <span class=n>parameterTypes</span><span class=o>[</span><span class=n>0</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>checkAdd</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>ThreadMode</span> <span class=n>threadMode</span> <span class=o>=</span> <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>threadMode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>SubscriberMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                    <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>priority</span><span class=o>(),</span> <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>sticky</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span> <span class=o>+</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;@Subscribe method &#34;</span> <span class=o>+</span> <span class=n>methodName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                            <span class=s>&#34;must have exactly 1 parameter but has &#34;</span> <span class=o>+</span> <span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span> <span class=o>+</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=n>methodName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34; is a illegal @Subscribe method: must be public, non-static, and non-abstract&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kt>void</span> <span class=nf>clearCaches</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>FindState</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>anyMethodByEventType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Class</span><span class=o>&gt;</span> <span class=n>subscriberClassByMethodKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>StringBuilder</span> <span class=n>methodKeyBuilder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>128</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>skipSuperClasses</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>SubscriberInfo</span> <span class=n>subscriberInfo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=nf>initForSubscriber</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>subscriberClass</span> <span class=o>=</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>skipSuperClasses</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberInfo</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=nf>recycle</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberMethods</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>anyMethodByEventType</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberClassByMethodKey</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>setLength</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberClass</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>clazz</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>skipSuperClasses</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriberInfo</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=nf>checkAdd</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 2 level check: 1st level with event type only (fast), 2nd level with complete signature when required.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// Usually a subscriber doesn&#39;t have methods listening to the same event type.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Object</span> <span class=n>existing</span> <span class=o>=</span> <span class=n>anyMethodByEventType</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>eventType</span><span class=o>,</span> <span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>existing</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>existing</span> <span class=k>instanceof</span> <span class=n>Method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(!</span><span class=n>checkAddWithMethodSignature</span><span class=o>((</span><span class=n>Method</span><span class=o>)</span> <span class=n>existing</span><span class=o>,</span> <span class=n>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// Paranoia check
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// Put any non-Method object to &#34;consume&#34; the existing Method
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>anyMethodByEventType</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>eventType</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>checkAddWithMethodSignature</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>checkAddWithMethodSignature</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>setLength</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;&gt;&#39;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>eventType</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>methodKey</span> <span class=o>=</span> <span class=n>methodKeyBuilder</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>methodClass</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>methodClassOld</span> <span class=o>=</span> <span class=n>subscriberClassByMethodKey</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>methodKey</span><span class=o>,</span> <span class=n>methodClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>methodClassOld</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>methodClassOld</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>methodClass</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Only add if not already found in a sub class
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Revert the put, old class is further down the class hierarchy
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>subscriberClassByMethodKey</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>methodKey</span><span class=o>,</span> <span class=n>methodClassOld</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=nf>moveToSuperclass</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>skipSuperClasses</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>clazz</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>clazz</span> <span class=o>=</span> <span class=n>clazz</span><span class=o>.</span><span class=na>getSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>String</span> <span class=n>clazzName</span> <span class=o>=</span> <span class=n>clazz</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Skip system classes, this degrades performance.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// Also we might avoid some ClassNotFoundException (see FAQ for background).
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>clazzName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;java.&#34;</span><span class=o>)</span> <span class=o>||</span> <span class=n>clazzName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;javax.&#34;</span><span class=o>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                        <span class=n>clazzName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;android.&#34;</span><span class=o>)</span> <span class=o>||</span> <span class=n>clazzName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;androidx.&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>clazz</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在它的构造方法里，<code>subscriberInfoIndexes</code> 里面只有注解解释器生成的 <code>MyEventBusIndex</code> 对象，其他两个参数都是默认值 false。</p><p>先看看 <code>findSubscriberMethods(subscriberClass)</code> 是如何完成 <code>@Subscribe</code> 方法的解析的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findSubscriberMethods</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1、如果能获取缓存，直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethods</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2、判断是否忽略索引
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 使用反射来获取事件回调方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingReflection</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 尝试从索引文件获取事件回调方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingInfo</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethods</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Subscriber &#34;</span> <span class=o>+</span> <span class=n>subscriberClass</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34; and its super classes have no public methods with the @Subscribe annotation&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3、写入缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>METHOD_CACHE</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>,</span> <span class=n>subscriberMethods</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注释 1 处是取缓存的操作。页面的生命周期可能会频繁发生变化，因而就可能导致事件的频繁注册、注销，这时候缓存就非常有用了。</p><p>注释 2 处，由于 <code>ignoreGeneratedIndex</code> 默认为 false，所以这里会执行 <code>findUsingInfo</code> 方法来获取订阅类的回调方法。</p><p>注释 3 在方法最后返回之前，会进行缓存的更新。</p><p>先分析一下 <code>findUsingInfo</code> 方法。</p><a href=#subscribermethodfinderfindusinginfo><h4 id=subscribermethodfinderfindusinginfo><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.findUsingInfo()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingInfo</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>findState</span><span class=o>.</span><span class=na>initForSubscriber</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 开启循环
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取目标方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>=</span> <span class=n>getSubscriberInfo</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=n>array</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSubscriberMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span> <span class=o>:</span> <span class=n>array</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>checkAdd</span><span class=o>(</span><span class=n>subscriberMethod</span><span class=o>.</span><span class=na>method</span><span class=o>,</span> <span class=n>subscriberMethod</span><span class=o>.</span><span class=na>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>subscriberMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 在父类中查找目标方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>findState</span><span class=o>.</span><span class=na>moveToSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#subscribermethodfinderpreparefindstate><h5 id=subscribermethodfinderpreparefindstate><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.prepareFindState()</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>FindState</span> <span class=nf>prepareFindState</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>POOL_SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>FindState</span> <span class=n>state</span> <span class=o>=</span> <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>state</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>state</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>FindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过 <code>prepareFindState()</code> 方法尝试从对象池中获取一个 <code>FindState</code> 对象，若对象池中没有可用的对象，则新建一个。</p><a href=#findstateinitforsubscriber><h5 id=findstateinitforsubscriber><span class=hanchor arialabel=Anchor># </span>FindState.initForSubscriber()</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>initForSubscriber</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>subscriberClass</span> <span class=o>=</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>subscriberClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>skipSuperClasses</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>subscriberInfo</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>初始化 <code>FindState</code> 对象，使其内部的 <code>subscriberClass</code>、<code>clazz</code> 都是订阅类，并且注意这时候 <code>subscriberInfo = null</code>、<code>skipSuperClasses = false</code>。</p><p>接着查看 <code>getSubscriberInfo()</code> 方法：</p><a href=#subscribermethodfindergetsubscriberinfo><h5 id=subscribermethodfindergetsubscriberinfo><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.getSubscriberInfo()</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>SubscriberInfo</span> <span class=nf>getSubscriberInfo</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSuperSubscriberInfo</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SubscriberInfo</span> <span class=n>superclassInfo</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>subscriberInfo</span><span class=o>.</span><span class=na>getSuperSubscriberInfo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>==</span> <span class=n>superclassInfo</span><span class=o>.</span><span class=na>getSubscriberClass</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>superclassInfo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriberInfoIndexes</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>SubscriberInfoIndex</span> <span class=n>index</span> <span class=o>:</span> <span class=n>subscriberInfoIndexes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SubscriberInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=na>getSubscriberInfo</span><span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>info</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>info</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里首先会通过 FindState 去父类中。。。</p><p>但是这里 <code>findState.subscriberInfo</code> 是为 null 的，因此不满足条件，接下来会判断 subscriberInfoIndexes（本例中只包含创建 EventBus 对象时传入的 MyEventBusIndex 对象）集合是否为空，如果不为空就会通过 Index 类去查找目标方法。</p><p>再次回到 <code>findUsingInfo()</code> 方法，可以看到，如果没有找到目标回调方法，也会调用 <code>findUsingReflectionInSingleClass()</code> 使用来获取回调方法。因此，<code>findUsingInfo()</code> 等于是 <code>findUsingReflection()</code> 方法的加强版本。</p><p>后面的 while 循环就是从当前的订阅类开始，一直向父类进行循环操作，也就是说，<strong>这里会解析当前订阅类的父类里面的方法</strong>。</p><p>如果找到目标回调方法，在通过 <code>findState.checkAdd()</code> 校验之后，事件回调方法都被加入到了 <code>findState.subscriberMethods</code> 中，然后由 <code>getMethodsAndRelease(findState)</code> 方法返回。<code>getMethodsAndRelease()</code> 方法就是将 <code>findState.subscriberMethods</code> 复制了出来，然后回收了 FindState 对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>getMethodsAndRelease</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>findState</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>synchronized</span><span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>POOL_SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>FIND_STATE_POOL</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>findState</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>subscriberMethods</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先会从 findState 中取出了保存的 subscriberMethods；然后将 findState 里的保存的所有对象进行回收；接着会把把 findState 存储在 FindState 池中方便下一次使用，以提高性能。最后，返回 subscriberMethods。</p><a href=#subscribermethodfinderfindusingreflection><h4 id=subscribermethodfinderfindusingreflection><span class=hanchor arialabel=Anchor># </span>SubscriberMethodFinder.findUsingReflection()</h4></a><p>上面就是注解处理器生成的 Index 参与的时候的流程。在这里还是有必要说一下没有 Index 参与时的流程，也就是 <code>findUsingReflectionInSingleClass()</code> 方法是如何获取订阅类的回调方法的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingReflection</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>findState</span><span class=o>.</span><span class=na>initForSubscriber</span><span class=o>(</span><span class=n>subscriberClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>findState</span><span class=o>.</span><span class=na>moveToSuperclass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=o>(</span><span class=n>findState</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里同样走到了 <code>findUsingReflectionInSingleClass()</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>findUsingReflectionInSingleClass</span><span class=o>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Method</span><span class=o>[]</span> <span class=n>methods</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// This is faster than getMethods, especially when subscribers are fat classes like Activities
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 获取该类的所有方法，不包括父类
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getDeclaredMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>th</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取该类以及父类的所有 public 方法，同时指定忽略父类
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getMethods</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>LinkageError</span> <span class=n>error</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// super class of NoClassDefFoundError to be a bit more broad...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>String</span> <span class=n>msg</span> <span class=o>=</span> <span class=s>&#34;Could not inspect methods of &#34;</span> <span class=o>+</span> <span class=n>findState</span><span class=o>.</span><span class=na>clazz</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>ignoreGeneratedIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>msg</span> <span class=o>+=</span> <span class=s>&#34;. Please consider using EventBus annotation processor to avoid reflection.&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>msg</span> <span class=o>+=</span> <span class=s>&#34;. Please make this class visible to EventBus annotation processor to avoid reflection.&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>error</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 标记为跳过父类方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>findState</span><span class=o>.</span><span class=na>skipSuperClasses</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Method</span> <span class=n>method</span> <span class=o>:</span> <span class=n>methods</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>modifiers</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 判断方法是否是 PUBLIC 且不是 ABSTRACT、STATIC、SYNTHETIC
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>((</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>PUBLIC</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>MODIFIERS_IGNORE</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>parameterTypes</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 判断该方法的参数是不是只有一个
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span> <span class=o>==</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 判断方法是否有 Subscribe 注解
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Subscribe</span> <span class=n>subscribeAnnotation</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getAnnotation</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>subscribeAnnotation</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 以上条件都满足后，就进行最后的校验，然后添加到 findState.subscriberMethods 中
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>=</span> <span class=n>parameterTypes</span><span class=o>[</span><span class=n>0</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>findState</span><span class=o>.</span><span class=na>checkAdd</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>ThreadMode</span> <span class=n>threadMode</span> <span class=o>=</span> <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>threadMode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=n>findState</span><span class=o>.</span><span class=na>subscriberMethods</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>SubscriberMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>eventType</span><span class=o>,</span> <span class=n>threadMode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>priority</span><span class=o>(),</span> <span class=n>subscribeAnnotation</span><span class=o>.</span><span class=na>sticky</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 方法参数 ！= 1,如果开启了严格验证则抛出异常
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span> <span class=o>+</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;@Subscribe method &#34;</span> <span class=o>+</span> <span class=n>methodName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;must have exactly 1 parameter but has &#34;</span> <span class=o>+</span> <span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>Subscribe</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 方法修饰符不合要求，如果开启了严格验证，则抛出异常
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span> <span class=o>+</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=n>methodName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34; is a illegal @Subscribe method: must be public, non-static, and non-abstract&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个方法大概分为两部分：</p><ol><li>首先通过反射的方式获取订阅者类中的所有声明方法，然后在这些方法里面寻找以 <code>@Subscribe</code> 作为注解的方法进行处理。</li><li>再经过经过一轮检查，看看 <code>findState.subscriberMethods</code> 是否存在，如果没有，将方法名、threadMode、优先级、是否为 sticky 方法等信息封装到 SubscriberMethod 对象中，最后添加到 subscriberMethods 列表中。</li></ol><p>从上面方法的分析我们可以看出，订阅类的方法要满足以下条件，才能够顺利的进行注册：</p><ol><li>方法必须是 <code>public</code> 的，且不能是 <code>abstract</code>、<code>static</code>、<code>synthetic</code> 的</li><li>方法参数必须只有一个</li><li>方法必须带有 <code>@Subscribe</code> 注解</li></ol><a href=#eventbussubscribe><h3 id=eventbussubscribe><span class=hanchor arialabel=Anchor># </span>EventBus.subscribe()</h3></a><p>上面这些内容就是订阅类回调方法的获取过程了，下面说说回调方法是如何进行注册的。方法为 <code>EventBus.subscribe()</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Must be called in synchronized block
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>subscribe</span><span class=o>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=o>,</span> <span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// eventType 为回调方法的入参类型，Object 类型
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>=</span> <span class=n>subscriberMethod</span><span class=o>.</span><span class=na>eventType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将订阅者以及订阅方法封装为一个 Subscription 类
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Subscription</span> <span class=n>newSubscription</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Subscription</span><span class=o>(</span><span class=n>subscriber</span><span class=o>,</span> <span class=n>subscriberMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span> <span class=n>subscriptions</span> <span class=o>=</span> <span class=n>subscriptionsByEventType</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriptions</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>subscriptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// subscriptionsByEventType：以订阅方法的参数为 key，
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Subscription 为 value 进行保存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriptionsByEventType</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>eventType</span><span class=o>,</span> <span class=n>subscriptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>subscriptions</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>newSubscription</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Subscriber &#34;</span> <span class=o>+</span> <span class=n>subscriber</span><span class=o>.</span><span class=na>getClass</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; already registered to event &#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 在订阅参数对应的 Subscription 列表中按照订阅方法的优先级进行排序
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// priority 的数值越高，越在列表的前面；相同 priority 的方法，后来的方法会在后面
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>subscriptions</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>size</span> <span class=o>||</span> <span class=n>subscriberMethod</span><span class=o>.</span><span class=na>priority</span> <span class=o>&gt;</span> <span class=n>subscriptions</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>subscriberMethod</span><span class=o>.</span><span class=na>priority</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>subscriptions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>newSubscription</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 从 typesBySubscriber 中获取
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>subscribedEvents</span> <span class=o>=</span> <span class=n>typesBySubscriber</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriber</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscribedEvents</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>subscribedEvents</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// typesBySubscriber：以订阅者为 key，订阅方法参数为 value 进行保存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>typesBySubscriber</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>subscriber</span><span class=o>,</span> <span class=n>subscribedEvents</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>subscribedEvents</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果订阅方法订阅的是粘性事件，则会在注册时接受到此粘性事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriberMethod</span><span class=o>.</span><span class=na>sticky</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>eventInheritance</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Existing sticky events of all subclasses of eventType have to be considered.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// Note: Iterating over all events may be inefficient with lots of sticky events,
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// thus data structure should be changed to allow a more efficient lookup
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Set</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span> <span class=n>stickyEvents</span><span class=o>.</span><span class=na>entrySet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>:</span> <span class=n>entries</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>candidateEventType</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>eventType</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>candidateEventType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Object</span> <span class=n>stickyEvent</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>checkPostStickyEventToSubscription</span><span class=o>(</span><span class=n>newSubscription</span><span class=o>,</span> <span class=n>stickyEvent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>stickyEvent</span> <span class=o>=</span> <span class=n>stickyEvents</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>checkPostStickyEventToSubscription</span><span class=o>(</span><span class=n>newSubscription</span><span class=o>,</span> <span class=n>stickyEvent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在上面的方法中，会先将订阅者以及订阅事件包装成为一个 <code>Subscription</code> 对象，然后与其他参数一起保存起来，具体为下面两个保存的地方：</p><ul><li><code>subscriptionsByEventType</code>：以订阅事件参数为 key，对应 <code>Subscription</code> 对象数组</li><li><code>typesBySubscriber</code>：以订阅者对象为 key，对应订阅事件参数数组。主要是在 EventBus 的 <code>isRegister()</code> 方法中去使用的，用来判断这个 Subscriber 对象 是否已被注册过。</li></ul><p>另外，Subscription 对象还会根据 priority 进行排序，具体来说：priority 的数值越高，越在列表的前面；相同 priority 的方法，后来的方法会在后面。</p><p>同时我们还可以看出粘性事件的触发机制：</p><ol><li>粘性事件发出时，会主动通知所有可以处理的方法，不管方法是否是粘性的</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>postSticky</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>stickyEvents</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>stickyEvents</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getClass</span><span class=o>(),</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Should be posted after it is putted, in case the subscriber wants to remove immediately
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>post</span><span class=o>(</span><span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>在订阅者进行注册时，如果有可以响应的粘性事件，粘性方法会被触发</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>subscriberMethod</span><span class=p>.</span><span class=nx>sticky</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>eventInheritance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(...)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=p>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(...)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nb>Object</span> <span class=nx>stickyEvent</span> <span class=o>=</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>getValue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=nx>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=nx>newSubscription</span><span class=p>,</span> <span class=nx>stickyEvent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>Object</span> <span class=nx>stickyEvent</span> <span class=o>=</span> <span class=nx>stickyEvents</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>eventType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=nx>newSubscription</span><span class=p>,</span> <span class=nx>stickyEvent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#post-流程><h2 id=post-流程><span class=hanchor arialabel=Anchor># </span>post 流程</h2></a><p>我们可以调用 <code>EventBus.post()</code> 以及 <code>EventBus.postSticky()</code> 这两个方法来发送事件，前者是普通事件，后者是粘性事件。</p><p>粘性事件的发送比较简单，该方法除了保存了事件之外，还调用了 <code>post</code> 方法当做非粘性事件进行了分发。此时，会主动通知所有可以处理的方法，不管方法是否是粘性的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>postSticky</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>stickyEvents</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>stickyEvents</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getClass</span><span class=o>(),</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Should be posted after it is putted, in case the subscriber wants to remove immediately
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>post</span><span class=o>(</span><span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>另外，前面提到过，在订阅者进行注册时，如果有可以响应的粘性事件，粘性方法会被触发。</p><p>粘性事件不会被消耗掉，除非手动 remove 掉：</p><ul><li><code>removeStickyEvent(Class&lt;T>)</code></li><li><code>removeStickyEvent(Object)</code></li><li><code>removeAllStickyEvents()</code></li></ul><p>接下来，我们看看 <code>EventBus.post()</code> 是如何触发订阅者的回调事件的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/** For ThreadLocal, much faster to set (and get multiple values). */</span>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>PostingThreadState</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>eventQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isPosting</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isMainThread</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Subscription</span> <span class=n>subscription</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>event</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>canceled</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>PostingThreadState</span><span class=o>&gt;</span> <span class=n>currentPostingThreadState</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>PostingThreadState</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>PostingThreadState</span> <span class=nf>initialValue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>PostingThreadState</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** Posts the given event to the event bus. */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>post</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>PostingThreadState</span> <span class=n>postingState</span> <span class=o>=</span> <span class=n>currentPostingThreadState</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>eventQueue</span> <span class=o>=</span> <span class=n>postingState</span><span class=o>.</span><span class=na>eventQueue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>eventQueue</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>postingState</span><span class=o>.</span><span class=na>isPosting</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>postingState</span><span class=o>.</span><span class=na>isMainThread</span> <span class=o>=</span> <span class=n>isMainThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>postingState</span><span class=o>.</span><span class=na>isPosting</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>postingState</span><span class=o>.</span><span class=na>canceled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=o>(</span><span class=s>&#34;Internal error. Abort state was not reset&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(!</span><span class=n>eventQueue</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>postSingleEvent</span><span class=o>(</span><span class=n>eventQueue</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>0</span><span class=o>),</span> <span class=n>postingState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>postingState</span><span class=o>.</span><span class=na>isPosting</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>postingState</span><span class=o>.</span><span class=na>isMainThread</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先会调用 <code>currentPostingThreadState.get()</code> 获取一个 PostingThreadState 对象， currentPostingThreadState 是一个 ThreadLocal 类型的对象，而 PostingThreadState 中包含了一个 eventQueue 和其他一些标志位。</p><p>接着把传入的 event，保存到了当前线程中的一个变量 PostingThreadState 的 eventQueue 事件队列里面，然后开始执行。当在极短时间内多次调用 <code>post</code> 方法时，只会将事件添加到队列里面，第 24 行的代码不成立。而在 31-33 行代码里面，会取时间队列的头进行事件分发。最后所有事件处理完成后，标志位复位。</p><p>下面我们看看 <code>postSingleEvent()</code> 方法，注释都在里面：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>postSingleEvent</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>,</span> <span class=n>PostingThreadState</span> <span class=n>postingState</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Error</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventClass</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>subscriptionFound</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// eventInheritance 表示事件接收类是否有层次结构
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>eventInheritance</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// lookupAllEventTypes 方法的作用是查询 class 的父类以及接口
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 显然示例中就是一个 Object
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>eventTypes</span> <span class=o>=</span> <span class=n>lookupAllEventTypes</span><span class=o>(</span><span class=n>eventClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>countTypes</span> <span class=o>=</span> <span class=n>eventTypes</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>h</span> <span class=o>&lt;</span> <span class=n>countTypes</span><span class=o>;</span> <span class=n>h</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>eventTypes</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>h</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用 postSingleEventForEventType 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>subscriptionFound</span> <span class=o>|=</span> <span class=n>postSingleEventForEventType</span><span class=o>(</span><span class=n>event</span><span class=o>,</span> <span class=n>postingState</span><span class=o>,</span> <span class=n>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 直接以当前的 eventClass 调用 postSingleEventForEventType 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>subscriptionFound</span> <span class=o>=</span> <span class=n>postSingleEventForEventType</span><span class=o>(</span><span class=n>event</span><span class=o>,</span> <span class=n>postingState</span><span class=o>,</span> <span class=n>eventClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 最后，当没有订阅者可以处理该事件时，EventBus 会抛出一个 NoSubscriberEvent 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>subscriptionFound</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>logNoSubscriberMessages</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=na>log</span><span class=o>(</span><span class=n>Level</span><span class=o>.</span><span class=na>FINE</span><span class=o>,</span> <span class=s>&#34;No subscribers registered for event &#34;</span> <span class=o>+</span> <span class=n>eventClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>sendNoSubscriberEvent</span> <span class=o>&amp;&amp;</span> <span class=n>eventClass</span> <span class=o>!=</span> <span class=n>NoSubscriberEvent</span><span class=o>.</span><span class=na>class</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=n>eventClass</span> <span class=o>!=</span> <span class=n>SubscriberExceptionEvent</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>post</span><span class=o>(</span><span class=k>new</span> <span class=n>NoSubscriberEvent</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>event</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>lookupAllEventTypes 方法的作用就是取出 Event 及其父类和接口的 class 列表，当然重复取的话会影响性能，所以它也做了一个 eventTypesCache 的缓存。</p><p>接着看看 <code>postSingleEventForEventType</code> 方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>postSingleEventForEventType</span><span class=o>(</span><span class=n>Object</span> <span class=n>event</span><span class=o>,</span> <span class=n>PostingThreadState</span> <span class=n>postingState</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// subscriptions 就是示例中对应订阅方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span> <span class=n>subscriptions</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>subscriptions</span> <span class=o>=</span> <span class=n>subscriptionsByEventType</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>eventClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriptions</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>subscriptions</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Subscription</span> <span class=n>subscription</span> <span class=o>:</span> <span class=n>subscriptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>postingState</span><span class=o>.</span><span class=na>event</span> <span class=o>=</span> <span class=n>event</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>postingState</span><span class=o>.</span><span class=na>subscription</span> <span class=o>=</span> <span class=n>subscription</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>aborted</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 调用 postToSubscription 进行真正的分发
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>postToSubscription</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>,</span> <span class=n>postingState</span><span class=o>.</span><span class=na>isMainThread</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>aborted</span> <span class=o>=</span> <span class=n>postingState</span><span class=o>.</span><span class=na>canceled</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>postingState</span><span class=o>.</span><span class=na>event</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>postingState</span><span class=o>.</span><span class=na>subscription</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>postingState</span><span class=o>.</span><span class=na>canceled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>aborted</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，根据 Event 类型从 subscriptionsByEventType 中取出对应的 subscriptions 对象，最后调用了 <code>postToSubscription()</code> 方法。这里需要注意一个细节，只要 eventClass 可以找到对应的 Subscription，那么该方法就会返回 true，也就是说已经发送给订阅者了。</p><p>最后看看 <code>postToSubscription()</code> 方法，该方法会根据方法的 threaMode 值，决定在哪如何触发回调方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>postToSubscription</span><span class=o>(</span><span class=n>Subscription</span> <span class=n>subscription</span><span class=o>,</span> <span class=n>Object</span> <span class=n>event</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isMainThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>subscription</span><span class=o>.</span><span class=na>subscriberMethod</span><span class=o>.</span><span class=na>threadMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>POSTING</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>invokeSubscriber</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MAIN</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>isMainThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>invokeSubscriber</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>mainThreadPoster</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>MAIN_ORDERED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>mainThreadPoster</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>mainThreadPoster</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// temporary: technically not correct as poster not decoupled from subscriber
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>invokeSubscriber</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>BACKGROUND</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>isMainThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>backgroundPoster</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>invokeSubscriber</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>ASYNC</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>asyncPoster</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>subscription</span><span class=o>,</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Unknown thread mode: &#34;</span> <span class=o>+</span> <span class=n>subscription</span><span class=o>.</span><span class=na>subscriberMethod</span><span class=o>.</span><span class=na>threadMode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里面 5 种 ThreadMode，采取的手段也不一样。从该枚举值的定义可以看出，分为 5 种情况，下表就是每种情况的含义：</p><p>无论在哪个线程中执行，最后都会调用 <code>invokeSubscriber</code> 方法来触发回调任务：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>void</span> <span class=nx>invokeSubscriber</span><span class=p>(</span><span class=nx>Subscription</span> <span class=nx>subscription</span><span class=p>,</span> <span class=nb>Object</span> <span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>subscription</span><span class=p>.</span><span class=nx>subscriberMethod</span><span class=p>.</span><span class=nx>method</span><span class=p>.</span><span class=nx>invoke</span><span class=p>(</span><span class=nx>subscription</span><span class=p>.</span><span class=nx>subscriber</span><span class=p>,</span> <span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>InvocationTargetException</span> <span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>handleSubscriberException</span><span class=p>(</span><span class=nx>subscription</span><span class=p>,</span> <span class=nx>event</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>getCause</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>IllegalAccessException</span> <span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=nx>IllegalStateException</span><span class=p>(</span><span class=s2>&#34;Unexpected exception&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里通过反射调用了订阅者的回调方法。至此，事件的发送已经分析完毕。</p><a href=#unregister-流程><h2 id=unregister-流程><span class=hanchor arialabel=Anchor># </span>unregister 流程</h2></a><p>注销过程原理比较简单，就是将注册时保存到 <code>subscriptionsByEventType</code>、<code>typesBySubscriber</code> 两个集合中的元素删除。</p><p>这两个集合在注册过程中分析过：</p><ul><li><code>subscriptionsByEventType</code> 以订阅事件参数为 key，对应 Subscription 对象数组</li><li><code>typesBySubscriber</code> 以订阅者对象为 key，对应订阅事件参数数组</li></ul><p><code>EventBus.unregister()</code> 代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/** Unregisters the given subscriber from all event classes. */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>unregister</span><span class=o>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 先通过 subscriber 订阅者对象从`typesBySubscriber`中获取订阅事件参数数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>subscribedTypes</span> <span class=o>=</span> <span class=n>typesBySubscriber</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>subscriber</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscribedTypes</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 以订阅事件参数为 key，从`subscriptionsByEventType`中获取到对应的`Subscrition`对象
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>:</span> <span class=n>subscribedTypes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>unsubscribeByEventType</span><span class=o>(</span><span class=n>subscriber</span><span class=o>,</span> <span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>typesBySubscriber</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>subscriber</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=na>log</span><span class=o>(</span><span class=n>Level</span><span class=o>.</span><span class=na>WARNING</span><span class=o>,</span> <span class=s>&#34;Subscriber to unregister was not registered before: &#34;</span> <span class=o>+</span> <span class=n>subscriber</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** Only updates subscriptionsByEventType, not typesBySubscriber! Caller must update typesBySubscriber. */</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>unsubscribeByEventType</span><span class=o>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span> <span class=n>subscriptions</span> <span class=o>=</span> <span class=n>subscriptionsByEventType</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>eventType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>subscriptions</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>subscriptions</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Subscription</span> <span class=n>subscription</span> <span class=o>=</span> <span class=n>subscriptions</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>subscription</span><span class=o>.</span><span class=na>subscriber</span> <span class=o>==</span> <span class=n>subscriber</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>subscription</span><span class=o>.</span><span class=na>active</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>subscriptions</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>i</span><span class=o>--;</span>
</span></span><span class=line><span class=cl>                <span class=n>size</span><span class=o>--;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>先通过 subscriber 订阅者对象从 <code>typesBySubscriber</code> 中获取订阅事件参数数组；然后以订阅事件参数为 key，从 <code>subscriptionsByEventType</code> 中获取到对应的 <code>Subscrition</code> 对象。</p><p>以上就是 EventBus 的注销过程了。</p><a href=#跨进程-eventbus><h2 id=跨进程-eventbus><span class=hanchor arialabel=Anchor># </span>跨进程 EventBus</h2></a><p>跨进程 EventBus 的难点在于如何将一个进程中的事件传递到另一个进程中，技术点还是离不来 IPC 的几种常用方式，这里比较实用的是 AIDL 方式。</p><p>下面先简单的说一下原理： 1. 弄一个主进程的 Service 作为消息中心，用来向各个进程转发事件 2. 主进程和子进程在初始化的时候都绑定到该 Service 上面，这样就得到了各进程向消息中心 Service 发送消息的通道 3. 在绑定到 Service 后，各个进程向 Service 注册本进程的消息转发器，这样消息中心 Service 就可以对各进程发送消息了，至此 C/S 之间双向的联系通道已经打通</p><p>下面分别考虑一下消息的传递，可以分为三种情况讨论。 1. 主进程向子进程的通信：获取主进程 Service 中各个进程（包括主进程自己）的消息转发器，依次转发消息 2. 子进程和主进程的通信：通过初始化绑定到 Service 时获取到的 Service 代理对象，向 Service 发送消息。Service 收到消息后，会向各个进程的消息转发器依次转发消息，这样主进程以及所有子进程都会收到消息 3. 子进程和子进程的通信：先发送到主进程，主进程会进行转发。</p><p>注意这里，主进程 Service 持有主进程以及所有子进程的消息转发器，这里不对主进程进行特别处理。此外，所有的事件都会由 Service 进行分发，Service 分发时会对主进程和所有子进程进行分发。</p><p>也就是说，如果子进程内部调用了跨进程 EventBus 进行事件分发的话，会在两次 IPC 之后再由改子进程内部的 EventBus 进行触发。这两次 IPC 是：子进程向主进程 Service 发出消息，主进程 Service 接收到消息后向所有进程进行分发。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/EventBus/clipboard_20230323_031638.png width=auto alt></p><a href=#简单实现><h3 id=简单实现><span class=hanchor arialabel=Anchor># </span>简单实现</h3></a><p>文件清单如下：</p><ol><li>服务端：IEventBusManager.aidl</li><li>客户端：IEventDispatcher.aidl</li><li>传输的事件：IPCEvent.java、IPCEvent.aidl</li><li>核心类：IPCEventBus.kt</li></ol><p><strong>src/main/aidl/xyz/yorek/eventbus/IEventBusManager.aidl</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// IEventBusManager.aidl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nn>xyz.yorek.eventbus</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>xyz.yorek.eventbus.IEventDispatcher</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>xyz.yorek.eventbus.IPCEvent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>IEventBusManager</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>register</span><span class=o>(</span><span class=n>IEventDispatcher</span> <span class=n>dispatcher</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>unregister</span><span class=o>(</span><span class=n>IEventDispatcher</span> <span class=n>dispatcher</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/** 向主进程发送Event */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>postToService</span><span class=o>(</span><span class=n>in</span> <span class=n>IPCEvent</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>src/main/aidl/xyz/yorek/eventbus/IEventDispatcher.aidl</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// IEventDispatcher.aidl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nn>xyz.yorek.eventbus</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>xyz.yorek.eventbus.IPCEvent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>IEventDispatcher</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** 接收其他进程发送过来的Event */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>dispatch</span><span class=o>(</span><span class=n>in</span> <span class=n>IPCEvent</span> <span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>src/main/aidl/xyz/yorek/eventbus/IPCEvent.aidl</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=o>//</span> <span class=nt>IPCEvent</span><span class=p>.</span><span class=nc>aidl</span>
</span></span><span class=line><span class=cl><span class=nt>package</span> <span class=nt>xyz</span><span class=p>.</span><span class=nc>yorek</span><span class=p>.</span><span class=nc>eventbus</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>parcelable</span> <span class=nt>IPCEvent</span><span class=o>;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>src/main/java/xyz/yorek/eventbus/IPCEvent.java</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>public</span> <span class=kr>class</span> <span class=nx>IPCEvent</span> <span class=kr>implements</span> <span class=nx>Parcelable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nx>int</span> <span class=nx>code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nb>String</span> <span class=nx>msg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nx>IPCEvent() {</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nx>IPCEvent</span><span class=p>(</span><span class=nx>int</span> <span class=nx>code</span><span class=p>,</span> <span class=nb>String</span> <span class=nx>msg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>code</span> <span class=o>=</span> <span class=nx>code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>msg</span> <span class=o>=</span> <span class=nx>msg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>protected</span> <span class=nx>IPCEvent</span><span class=p>(</span><span class=nx>Parcel</span> <span class=k>in</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>code</span> <span class=o>=</span> <span class=k>in</span><span class=p>.</span><span class=nx>readInt</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>msg</span> <span class=o>=</span> <span class=k>in</span><span class=p>.</span><span class=nx>readString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nb>String</span> <span class=nx>toString() {</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;IPCEvent{&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;code=&#34;</span> <span class=o>+</span> <span class=nx>code</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;, msg=&#39;&#34;</span> <span class=o>+</span> <span class=nx>msg</span> <span class=o>+</span> <span class=s1>&#39;\&#39;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=nx>int</span> <span class=nx>describeContents() {</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=k>void</span> <span class=nx>writeToParcel</span><span class=p>(</span><span class=nx>Parcel</span> <span class=nx>dest</span><span class=p>,</span> <span class=nx>int</span> <span class=nx>flags</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dest</span><span class=p>.</span><span class=nx>writeInt</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>code</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>dest</span><span class=p>.</span><span class=nx>writeString</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>public</span> <span class=kr>static</span> <span class=nx>final</span> <span class=nx>Creator</span><span class=p>&lt;</span><span class=nt>IPCEvent</span><span class=p>&gt;</span> <span class=nx>CREATOR</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Creator</span><span class=p>&lt;</span><span class=nt>IPCEvent</span><span class=p>&gt;()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kr>public</span> <span class=nx>IPCEvent</span> <span class=nx>createFromParcel</span><span class=p>(</span><span class=nx>Parcel</span> <span class=nx>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=nx>IPCEvent</span><span class=p>(</span><span class=nx>source</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kr>public</span> <span class=nx>IPCEvent</span><span class=p>[]</span> <span class=nx>newArray</span><span class=p>(</span><span class=nx>int</span> <span class=nx>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=nx>IPCEvent</span><span class=p>[</span><span class=nx>size</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>src/main/java/xyz/yorek/eventbus/IPCEventBus.kt</strong></p><p>内含一个内部类 <code>EventBusManagerService</code>，管理所有进程的事件转发器。</p><p>需要注意一下这里面的 <code>RemoteCallbackList</code> 的独特用法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>object</span> <span class=nc>IPCEventBus</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 本进程的事件分发器，服务端向本进程客户端发送数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>val</span> <span class=py>mEventDispatcher</span> <span class=p>=</span> <span class=k>object</span> <span class=err>: </span><span class=nc>IEventDispatcher</span><span class=p>.</span><span class=n>Stub</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>dispatch</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>post</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 本进程获取的服务端代理，可以向服务端注册事件分发器，还可以发送数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>var</span> <span class=py>mEventBusManagerService</span><span class=p>:</span> <span class=n>IEventBusManager</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>mServiceConnection</span> <span class=p>=</span> <span class=k>object</span> <span class=err>: </span><span class=nc>ServiceConnection</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onServiceDisconnected</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=n>ComponentName</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mEventBusManagerService</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onServiceConnected</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=n>ComponentName</span><span class=p>?,</span> <span class=n>service</span><span class=p>:</span> <span class=n>IBinder</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>service</span> <span class=o>?:</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=n>mEventBusManagerService</span> <span class=p>=</span> <span class=n>IEventBusManager</span><span class=p>.</span><span class=n>Stub</span><span class=p>.</span><span class=n>asInterface</span><span class=p>(</span><span class=n>service</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>register</span><span class=p>(</span><span class=n>mEventDispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 初始化方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>init</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Application</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>app</span> <span class=p>=</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>intent</span> <span class=p>=</span> <span class=n>Intent</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>EventBusManagerService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=p>.</span><span class=n>bindService</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span> <span class=n>mServiceConnection</span><span class=p>,</span> <span class=n>Context</span><span class=p>.</span><span class=n>BIND_AUTO_CREATE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 销毁方法，进程不需要时调用
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>destory</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>asBinder</span><span class=p>()</span><span class=o>?.</span><span class=n>isBinderAlive</span> <span class=o>==</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>unregister</span><span class=p>(</span><span class=n>mEventDispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>app</span><span class=p>.</span><span class=n>unbindService</span><span class=p>(</span><span class=n>mServiceConnection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>register</span><span class=p>(</span><span class=n>any</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>register</span><span class=p>(</span><span class=n>any</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>unregister</span><span class=p>(</span><span class=n>any</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>unregister</span><span class=p>(</span><span class=n>any</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向服务端发送数据，经过服务端转发到各个进程（包括主进程）
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>post</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>postToService</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>app</span><span class=p>:</span> <span class=n>Application</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 服务端
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>EventBusManagerService</span> <span class=p>:</span> <span class=n>Service</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 各个进程的事件分发器
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>private</span> <span class=k>val</span> <span class=py>mDispatchers</span> <span class=p>=</span> <span class=n>RemoteCallbackList</span><span class=p>&lt;</span><span class=n>IEventDispatcher</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 服务端实现
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>private</span> <span class=k>val</span> <span class=py>mEventBusManagerService</span> <span class=p>=</span> <span class=k>object</span> <span class=err>: </span><span class=nc>IEventBusManager</span><span class=p>.</span><span class=n>Stub</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>register</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>:</span> <span class=n>IEventDispatcher</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dispatcher</span> <span class=o>?:</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=n>mDispatchers</span><span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>unregister</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>:</span> <span class=n>IEventDispatcher</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dispatcher</span> <span class=o>?:</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=n>mDispatchers</span><span class=p>.</span><span class=n>unregister</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>postToService</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dispatchEvent</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onBind</span><span class=p>(</span><span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>?)</span> <span class=p>=</span> <span class=n>mEventBusManagerService</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 分发事件到各个进程
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>fun</span> <span class=nf>dispatchEvent</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>n</span> <span class=p>=</span> <span class=n>mDispatchers</span><span class=p>.</span><span class=n>beginBroadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=k>in</span> <span class=m>0</span> <span class=n>until</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>dispatcher</span> <span class=p>=</span> <span class=n>mDispatchers</span><span class=p>.</span><span class=n>getBroadcastItem</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>dispatcher</span><span class=p>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>mDispatchers</span><span class=p>.</span><span class=n>finishBroadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#使用示例><h3 id=使用示例><span class=hanchor arialabel=Anchor># </span>使用示例</h3></a><p>我们首先在 AndroidMenifest 中注册一下 <code>IPCEventBus$EventBusManagerService</code>；顺便注册一下三个在不同进程的 Activity，方便我们测试：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- 主进程的Activity --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>activity</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;.MainActivity&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>intent-filter</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>action</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;android.intent.action.VIEW&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>action</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;android.intent.action.MAIN&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>category</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;android.intent.category.LAUNCHER&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>intent-filter</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>activity</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- 子进程1的Activity --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>activity</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;.SecondActivity&#34;</span> <span class=na>android:process</span><span class=o>=</span><span class=s>&#34;:second&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- 子进程2的Activity --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>activity</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;.ThirdActivity&#34;</span> <span class=na>android:process</span><span class=o>=</span><span class=s>&#34;:third&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>service</span> <span class=na>android:name</span><span class=o>=</span><span class=s>&#34;xyz.yorek.eventbus.IPCEventBus$EventBusManagerService&#34;</span> <span class=p>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>上面三个 Activity 引用了同样的布局文件，拥有同样的代码。唯一的区别就是三者的 TAG 不一样，用来区分发出的消息。</p><p>下面是 MainActivity 的布局以及代码：</p><p><strong>src/main/res/layout/activity_main.xml</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;androidx.constraintlayout.widget.ConstraintLayout</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:app=</span><span class=s>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:tools=</span><span class=s>&#34;http://schemas.android.com/tools&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>tools:context=</span><span class=s>&#34;.MainActivity&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Button</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/btnPost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:text=</span><span class=s>&#34;post&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:onClick=</span><span class=s>&#34;post&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintBottom_toBottomOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintLeft_toLeftOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintRight_toRightOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toTopOf=</span><span class=s>&#34;parent&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Button</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/btnFirst&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:text=</span><span class=s>&#34;first&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:onClick=</span><span class=s>&#34;first&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/btnPost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toStartOf=</span><span class=s>&#34;@+id/btnSecond&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Button</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/btnSecond&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:text=</span><span class=s>&#34;second&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:onClick=</span><span class=s>&#34;second&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/btnPost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toEndOf=</span><span class=s>&#34;@id/btnFirst&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toStartOf=</span><span class=s>&#34;@+id/btnThird&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Button</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/btnThird&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:text=</span><span class=s>&#34;third&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:onClick=</span><span class=s>&#34;third&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/btnPost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toEndOf=</span><span class=s>&#34;@id/btnSecond&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;parent&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>app/src/main/java/xyz/yorek/eventbus/MainActivity.kt</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>const</span> <span class=k>val</span> <span class=py>TAG</span> <span class=p>=</span> <span class=s2>&#34;MainActivity&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MainActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>IPCEventBus</span><span class=p>.</span><span class=k>init</span><span class=p>(</span><span class=n>application</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_main</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Subscribe</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onEventReceived</span><span class=p>(</span><span class=n>any</span><span class=p>:</span> <span class=n>Any</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s2>&#34;receive message : </span><span class=si>$any</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>post</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>msg</span> <span class=p>=</span> <span class=s2>&#34;Hello World, from </span><span class=si>$TAG</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>post</span><span class=p>(</span><span class=n>IPCEvent</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=n>msg</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>first</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>MainActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>second</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>SecondActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>third</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>ThirdActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 MainActivity 中我们 post 一下消息，然后进入 SecondActivity 再次 post，进入 ThirdActivity 后最后一次 post。</p><p>各个进程日志如下（按照日志时间顺序）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-apache data-lang=apache><span class=line><span class=cl><span class=err>1569683305</span>.<span class=err>912</span> <span class=err>31157-31157/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : IPCEvent{code=1, msg=&#39;Hello World, from MainActivity&#39;}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>1569683307</span>.<span class=err>622</span> <span class=err>31157-31169/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569683307</span>.<span class=err>625</span> <span class=err>31093-31093/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: receive message : IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>1569683309</span>.<span class=err>245</span> <span class=err>31157-31169/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569683309</span>.<span class=err>245</span> <span class=err>31210-31210/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>third</span> E/ThirdActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569683309</span>.<span class=err>246</span> <span class=err>31093-31246/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span></code></pre></td></tr></table></div></div><p>从上面的日志来看，我们已经完成了跨进程 EventBus 的功能。</p><p>下面的日志是一份详细记载了各个事件的日志。从日志的中可以看出：本进程的某线程发出的事件会由同一个线程来触发；其他进程发出的事件，会由本进程 Binder 线程池里面的线程触发。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-apache data-lang=apache><span class=line><span class=cl><span class=err>1569683981</span>.<span class=err>405</span> <span class=err>31484-31484/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch begin : main
</span></span><span class=line><span class=cl><span class=err>1569683981</span>.<span class=err>405</span> <span class=err>31484-31484/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : main IPCEvent{code=1, msg=&#39;Hello World, from MainActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569683981</span>.<span class=err>406</span> <span class=err>31484-31484/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch end : main
</span></span><span class=line><span class=cl><span class=err>1569683981</span>.<span class=err>406</span> <span class=err>31484-31484/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: post message done : main
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>794</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch begin : Binder:31484_1
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>794</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : Binder:31484_1 IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>799</span> <span class=err>32016-32016/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: receive message : main IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>803</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch end : Binder:31484_1
</span></span><span class=line><span class=cl><span class=err>1569684013</span>.<span class=err>804</span> <span class=err>32016-32016/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: post message done : main
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>762</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch begin : Binder:31484_1
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>762</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/MainActivity: receive message : Binder:31484_1 IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>764</span> <span class=err>32063-32063/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>third</span> E/ThirdActivity: receive message : main IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>765</span> <span class=err>31484-31526/xyz</span>.<span class=err>yorek</span>.<span class=nb>eventbus</span> E/EventBusManagerService: dispatch end : Binder:31484_1
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>765</span> <span class=err>32016-32089/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>second</span> E/SecondActivity: receive message : Binder:32016_4 IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span class=line><span class=cl><span class=err>1569684035</span>.<span class=err>766</span> <span class=err>32063-32063/xyz</span>.<span class=err>yorek</span>.<span class=err>eventbus:</span><span class=nb>third</span> E/ThirdActivity: post message done : main
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>