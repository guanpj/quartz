<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Glide é«˜çº§ç”¨æ³• å›è°ƒä¸ç›‘å¬ Target æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä½¿ç”¨ Glide åœ¨ç•Œé¢ä¸ŠåŠ è½½å¹¶å±•ç¤ºä¸€å¼ å›¾ç‰‡åªéœ€è¦ä¸€è¡Œä»£ç ï¼š
1  Glide.with(this).load(url).into(imageView);   å°† ImageView çš„å®ä¾‹ä¼ å…¥åˆ° into() æ–¹æ³•å½“ä¸­ï¼ŒGlide å°†å›¾ç‰‡åŠ è½½å®Œæˆä¹‹åï¼Œå›¾ç‰‡å°±èƒ½æ˜¾ç¤ºåˆ° ImageView ä¸Šäº†ã€‚è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ¥çœ‹ä¸€ä¸‹ into() æ–¹æ³•çš„æºç ï¼š"><meta property="og:title" content><meta property="og:description" content="Glide é«˜çº§ç”¨æ³• å›è°ƒä¸ç›‘å¬ Target æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä½¿ç”¨ Glide åœ¨ç•Œé¢ä¸ŠåŠ è½½å¹¶å±•ç¤ºä¸€å¼ å›¾ç‰‡åªéœ€è¦ä¸€è¡Œä»£ç ï¼š
1  Glide.with(this).load(url).into(imageView);   å°† ImageView çš„å®ä¾‹ä¼ å…¥åˆ° into() æ–¹æ³•å½“ä¸­ï¼ŒGlide å°†å›¾ç‰‡åŠ è½½å®Œæˆä¹‹åï¼Œå›¾ç‰‡å°±èƒ½æ˜¾ç¤ºåˆ° ImageView ä¸Šäº†ã€‚è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ¥çœ‹ä¸€ä¸‹ into() æ–¹æ³•çš„æºç ï¼š"><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Glide é«˜çº§ç”¨æ³• å›è°ƒä¸ç›‘å¬ Target æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä½¿ç”¨ Glide åœ¨ç•Œé¢ä¸ŠåŠ è½½å¹¶å±•ç¤ºä¸€å¼ å›¾ç‰‡åªéœ€è¦ä¸€è¡Œä»£ç ï¼š
1  Glide.with(this).load(url).into(imageView);   å°† ImageView çš„å®ä¾‹ä¼ å…¥åˆ° into() æ–¹æ³•å½“ä¸­ï¼ŒGlide å°†å›¾ç‰‡åŠ è½½å®Œæˆä¹‹åï¼Œå›¾ç‰‡å°±èƒ½æ˜¾ç¤ºåˆ° ImageView ä¸Šäº†ã€‚è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ¥çœ‹ä¸€ä¸‹ into() æ–¹æ³•çš„æºç ï¼š"><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.0452046239b15cdfa822e3a8fa41b16d.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.696841b111fc7b3c76b3b6aa81166af4.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.ca52e7d9467e2885647d26447cb0e5e3.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown</p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#glide-é«˜çº§ç”¨æ³•>Glide é«˜çº§ç”¨æ³•</a></li><li><a href=#å›è°ƒä¸ç›‘å¬>å›è°ƒä¸ç›‘å¬</a><ol><li><a href=#target>Target</a></li><li><a href=#requestbuilder-é«˜çº§-api>RequestBuilder é«˜çº§ API</a><ol><li><a href=#preload>preload</a></li><li><a href=#submit>submit</a></li><li><a href=#downloadonly>downloadOnly</a></li><li><a href=#listeneraddlistener>listener/addListener</a></li></ol></li></ol></li><li><a href=#transform>Transform</a><ol><li><a href=#transform-è¡Œä¸ºåˆ†æ>Transform è¡Œä¸ºåˆ†æ</a><ol><li><a href=#åœºæ™¯è¿˜åŸ>åœºæ™¯è¿˜åŸ</a></li><li><a href=#ä»£ç åˆ†æ>ä»£ç åˆ†æ</a></li></ol></li><li><a href=#glide-è‡ªå¸¦çš„-transformation>Glide è‡ªå¸¦çš„ Transformation</a></li><li><a href=#è‡ªå®šä¹‰-bitmaptransformation>è‡ªå®šä¹‰ BitmapTransformation</a></li></ol></li><li><a href=#appglidemodule>AppGlideModule</a><ol><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a><ol><li><a href=#applyoptions>applyOptions</a><ol><li><a href=#strongå†…å­˜ç¼“å­˜memorycachestrong><strong>å†…å­˜ç¼“å­˜ï¼ˆMemoryCacheï¼‰</strong></a></li><li><a href=#strongbitmappoolstrong><strong>BitmapPool</strong></a></li><li><a href=#strongç£ç›˜ç¼“å­˜diskcachestrong><strong>ç£ç›˜ç¼“å­˜ï¼ˆDiskCacheï¼‰</strong></a></li><li><a href=#strongé»˜è®¤è¯·æ±‚é€‰é¡¹defaultrequestoptionsstrong><strong>é»˜è®¤è¯·æ±‚é€‰é¡¹ï¼ˆDefaultRequestOptionsï¼‰</strong></a></li><li><a href=#strongæœªæ•è·å¼‚å¸¸ç­–ç•¥-uncaughtthrowablestrategystrong><strong>æœªæ•è·å¼‚å¸¸ç­–ç•¥ (UncaughtThrowableStrategy)</strong></a></li><li><a href=#strongæ—¥å¿—çº§åˆ«loglevel-strong><strong>æ—¥å¿—çº§åˆ«ï¼ˆLogLevel ï¼‰</strong></a></li></ol></li><li><a href=#ismanifestparsingenabled>isManifestParsingEnabled</a></li><li><a href=#registercomponents>registerComponents</a></li></ol></li><li><a href=#åŸç†>åŸç†</a><ol><li><a href=#glide-åˆå§‹åŒ–æµç¨‹åˆ†æ>Glide åˆå§‹åŒ–æµç¨‹åˆ†æ</a></li><li><a href=#kapt-ç”Ÿæˆæ–‡ä»¶è¿‡ç¨‹åˆ†æ>kapt ç”Ÿæˆæ–‡ä»¶è¿‡ç¨‹åˆ†æ</a><ol><li><a href=#excludes>@Excludes</a></li><li><a href=#glideextension>@GlideExtension</a></li></ol></li></ol></li><li><a href=#å®æˆ˜åˆ†æ>å®æˆ˜åˆ†æ</a></li></ol></li></ol></nav></details></aside><a href=#glide-é«˜çº§ç”¨æ³•><h1 id=glide-é«˜çº§ç”¨æ³•><span class=hanchor arialabel=Anchor># </span>Glide é«˜çº§ç”¨æ³•</h1></a><a href=#å›è°ƒä¸ç›‘å¬><h1 id=å›è°ƒä¸ç›‘å¬><span class=hanchor arialabel=Anchor># </span>å›è°ƒä¸ç›‘å¬</h1></a><a href=#target><h2 id=target><span class=hanchor arialabel=Anchor># </span>Target</h2></a><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä½¿ç”¨ Glide åœ¨ç•Œé¢ä¸ŠåŠ è½½å¹¶å±•ç¤ºä¸€å¼ å›¾ç‰‡åªéœ€è¦ä¸€è¡Œä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=k>this</span><span class=o>).</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>).</span><span class=na>into</span><span class=o>(</span><span class=n>imageView</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>å°† ImageView çš„å®ä¾‹ä¼ å…¥åˆ° into() æ–¹æ³•å½“ä¸­ï¼ŒGlide å°†å›¾ç‰‡åŠ è½½å®Œæˆä¹‹åï¼Œå›¾ç‰‡å°±èƒ½æ˜¾ç¤ºåˆ° ImageView ä¸Šäº†ã€‚è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ¥çœ‹ä¸€ä¸‹ into() æ–¹æ³•çš„æºç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>into</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Util</span><span class=o>.</span><span class=na>assertMainThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span> <span class=o>=</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!</span><span class=n>requestOptions</span><span class=o>.</span><span class=na>isTransformationSet</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>isTransformationAllowed</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>view</span><span class=o>.</span><span class=na>getScaleType</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// into a different target, we don&#39;t retain the transformation applied based on the previous
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// View&#39;s scale type.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getScaleType</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_CROP</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterCrop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_INSIDE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterInside</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_CENTER</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_START</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_END</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalFitCenter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_XY</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterInside</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>MATRIX</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Do nothing.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>into</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>glideContext</span><span class=o>.</span><span class=na>buildImageViewTarget</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>transcodeClass</span><span class=o>),</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Executors</span><span class=o>.</span><span class=na>mainThreadExecutor</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åä¸€è¡Œä»£ç ä¼šè°ƒç”¨ glideContext.buildImageViewTarget() æ–¹æ³•æ„å»ºå‡ºä¸€ä¸ª Target å¯¹è±¡ï¼Œç„¶åå†æŠŠå®ƒä¼ å…¥åˆ°å¦ä¸€ä¸ªæ¥æ”¶ Target å‚æ•°çš„ into()æ–¹æ³•ä¸­ã€‚Target å¯¹è±¡åˆ™æ˜¯ç”¨æ¥æœ€ç»ˆå±•ç¤ºå›¾ç‰‡ç”¨çš„ï¼Œè·Ÿè¿›æ–¹æ³• glideContext.buildImageViewTargetï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>X</span><span class=o>&gt;</span> <span class=nf>buildImageViewTarget</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>imageView</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>imageViewTargetFactory</span><span class=o>.</span><span class=na>buildTarget</span><span class=o>(</span><span class=n>imageView</span><span class=o>,</span> <span class=n>transcodeClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»§ç»­è·Ÿè¿›ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ImageViewTargetFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=nf>buildTarget</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Bitmap</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>Z</span><span class=o>&gt;)</span> <span class=k>new</span> <span class=n>BitmapImageViewTarget</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Drawable</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>Z</span><span class=o>&gt;)</span> <span class=k>new</span> <span class=n>DrawableImageViewTarget</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Unhandled class: &#34;</span> <span class=o>+</span> <span class=n>clazz</span> <span class=o>+</span> <span class=s>&#34;, try .as*(Class).transcode(ResourceTranscoder)&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å›é¡¾ä¹‹å‰çš„åˆ†ææµç¨‹ï¼Œåœ¨ into(ImageView) è¿‡ç¨‹ä¸­ï¼Œä¼šå°† ImageView åŒ…è£…æˆä¸ºä¸€ä¸ª ViewTarget ç±»ã€‚å¦‚æœè°ƒç”¨è¿‡ asBitmap() æ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤å¤„ä¼šæ˜¯ BitmapImageViewTargetï¼Œå¦åˆ™éƒ½å°†ä¼šæ˜¯ DrawableImageViewTargetã€‚BitmapImageViewTarget å’Œ DrawableImageViewTarget é™¤äº† setResource æ–¹æ³•ä¸­è°ƒç”¨çš„è®¾ç½®å›¾ç‰‡çš„ API ä¸åŒå¤–ï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚</p><p>DrawableImageView çš„ç»§æ‰¿é“¾å¦‚ä¸‹ï¼šDrawableImageView -> ImageViewTarget -> ViewTarget -> BaseTarget -> Targetã€‚</p><ul><li>Target æ˜¯ä¸€ä¸ªç»§æ‰¿äº† LifecycleListener æ¥å£çš„æ¥å£ç±»ï¼Œè¯¥ç±»æä¾›äº†èµ„æºåŠ è½½è¿‡ç¨‹ä¸­çš„å›è°ƒæ“ä½œã€‚</li></ul><p>å…¸å‹çš„ç”Ÿå‘½å‘¨æœŸä¸º onLoadStarted -> onResourceReady/onLoadFailed -> onLoadClearedï¼Œä½†ä¸ä¿è¯æ‰€æœ‰çš„éƒ½æ˜¯è¿™æ ·ã€‚å¦‚æœèµ„æºåœ¨å†…å­˜ä¸­æˆ–è€…ç”±äº model ä¸º null è€ŒåŠ è½½å¤±è´¥ï¼ŒonLoadStarted ä¸ä¼šè¢«è°ƒç”¨ã€‚åŒæ ·ï¼Œå¦‚æœ target ä¸ä¼šæ¸…é™¤ï¼Œé‚£ä¹ˆ onLoadCleared æ–¹æ³•ä¹Ÿä¸ä¼šè¢«è°ƒç”¨ã€‚</p><ul><li>BaseTarget æ˜¯ä¸€ä¸ªå®ç°äº† Target æ¥å£çš„æŠ½è±¡ç±»ã€‚</li></ul><p>è¯¥ç±»å®ç°äº† setRequest(Request)ã€getRequest() ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•ç›¸å½“äºé€‚é…å™¨æ¨¡å¼çš„å®ç°ã€‚</p><ul><li>ViewTarget</li></ul><p>è¯¥ç±»è™½ç„¶ç»§æ‰¿äº† BaseTarget ç±»ï¼Œä½†å…¶é‡å†™äº† setRequest(Request)ã€getRequest() ä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¼šè°ƒç”¨ View.setTag æ–¹æ³•å°† Request å¯¹è±¡ä¼ å…¥ã€‚</p><p>In addition, <strong>for</strong> ViewTarget<strong>s only</strong>, you can pass in a new instance to each load or clear call and allow Glide to retrieve information about previous loads from the Views tags</p><p>This will <strong>not</strong> work unless your Target extends ViewTarget or implements setRequest() and getRequest() in a way that allows you to retrieve previous requests in new Target instances.</p><p><a href=http://bumptech.github.io/glide/doc/targets.html#cancellation-and-re-use rel=noopener>Cancellation and re-use</a></p><ul><li>ImageViewTarget</li></ul><p>è¯¥ç±»çš„ä½œç”¨å°±æ˜¯åœ¨åŠ è½½çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒä¸­ç»™ ImageView è®¾ç½®å¯¹åº”çš„èµ„æºã€‚ä½†ç”±äºåŠ è½½æˆåŠŸåè¿”å›çš„èµ„æºå¯èƒ½æ˜¯ Bitmap æˆ–è€… Drawableï¼Œæ‰€ä»¥è¿™ä¸ªä¸ç¡®å®šç±»å‹çš„åŠ è½½ç”± setResource æŠ½è±¡æ–¹æ³•å£°æ˜ï¼Œå¾…å­ç±» BitmapImageViewTarget å’Œ DrawableImageViewTarget å®ç°ã€‚</p><ul><li>DrawableImageViewTarget</li></ul><p>ç»§æ‰¿äº† ImageViewTarget ç±»ï¼Œå”¯ä¸€çš„ä½œç”¨å°±æ˜¯å®ç° setResource(Drawable) æ–¹æ³•ã€‚</p><p>åœ¨äº†è§£äº† DrawableImageViewTarget ä»¥åŠç›¸å…³çš„ç±»ä¹‹åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶ä»–çš„ Targetã€‚ä¸‹é¢æ˜¯ Glide v4 ä¸­å‡ºç°çš„æ‰€æœ‰çš„ Targetï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031827.png width=auto alt></p><p>è™½ç„¶ Target å¾ˆå¤šï¼Œä½†æ˜¯è‡ªå®šä¹‰åªéœ€è¦ç»§æ‰¿ CustomViewTarget æˆ–è€… CustomTarget å°±è¡Œäº†ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦ç»§æ‰¿ </strong>CustomViewTarget <strong>è€Œä¸æ˜¯ </strong>ViewTargetï¼Ÿ</p><p>ViewTarget å·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒäº†ï¼Œå»ºè®®æˆ‘ä»¬ä½¿ç”¨ CustomViewTargetã€‚è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœå­ç±»æ²¡æœ‰å®ç° ViewTarget.onLoadCleared æ–¹æ³•ï¼Œå°†ä¼šå¯¼è‡´è¢«å›æ”¶çš„ bitmap ä»ç„¶è¢« UI æ‰€å¼•ç”¨ï¼Œä»è€Œå¯¼è‡´å´©æºƒã€‚è€Œ CustomViewTarget.onLoadCleared æ–¹æ³•æ˜¯ final ç±»å‹çš„ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³• onResourceCleared å¼ºåˆ¶æˆ‘ä»¬å®ç°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸¤ä¸ªç±»åŸºæœ¬æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦ç»§æ‰¿ </strong>CustomTarget <strong>è€Œä¸æ˜¯ </strong>SimpleTargetï¼Ÿ</p><p>åŸå› åŒä¸Š</p><p>ä¸‹é¢ä¸¾ä¸€ä¸ªå®é™…ä¾‹å­ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦è·å–åˆ°åŠ è½½æˆåŠŸåçš„ Bitma p å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>asBitmap</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=k>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=k>object</span> <span class=err>: </span><span class=nc>CustomTarget</span><span class=p>&lt;</span><span class=n>Bitmap</span><span class=p>&gt;()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onResourceReady</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>resource</span><span class=p>:</span> <span class=n>Bitmap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>transition</span><span class=p>:</span> <span class=n>Transition</span><span class=p>&lt;</span><span class=k>in</span> <span class=n>Bitmap</span><span class=p>&gt;?</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ivFace</span><span class=p>.</span><span class=n>setImageBitmap</span><span class=p>(</span><span class=n>resource</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onLoadCleared</span><span class=p>(</span><span class=n>placeholder</span><span class=p>:</span> <span class=n>Drawable</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ivFace</span><span class=p>.</span><span class=n>setImageDrawable</span><span class=p>(</span><span class=n>placeholder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><a href=#requestbuilder-é«˜çº§-api><h2 id=requestbuilder-é«˜çº§-api><span class=hanchor arialabel=Anchor># </span>RequestBuilder é«˜çº§ API</h2></a><p>åœ¨äº†è§£äº† Target ä¹‹åï¼Œæˆ‘ä»¬å†çœ‹çœ‹ RequestBuilder ä¸­é«˜çº§ä¸€ç‚¹çš„ APIã€‚</p><p>ä¸‹é¢è¿™äº›éƒ½æ˜¯ Target çš„åº”ç”¨ï¼Œå†…éƒ¨è°ƒç”¨çš„æ˜¯<strong>ä¿®æ”¹è¿‡é…ç½®</strong>çš„ into/submit æ–¹æ³•ï¼Œä½† RequestBuilder.downloadOnly æ–¹æ³•å·²ç»è¢«åºŸå¼ƒï¼›å»ºè®®é‡‡ç”¨ RequestManager çš„ downloadOnly()æ–¹æ³•å’Œ into/submit æ–¹æ³•</p><p>æ­¤å¤–è¿˜æœ‰è¿˜éœ€è¦æ³¨æ„çš„ä¸€ä¸ª APIï¼šlistener/addListener</p><a href=#preload><h3 id=preload><span class=hanchor arialabel=Anchor># </span>preload</h3></a><p>ä½œç”¨ï¼šå°†èµ„æºé¢„åŠ è½½åˆ°ç¼“å­˜ä¸­</p><p>preload çš„é‡è½½æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * Preloads the resource into the cache using the given width and height.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * &lt;p&gt; Pre-loading is useful for making sure that resources you are going to to want in the near
</span></span></span><span class=line><span class=cl><span class=cm>  * future are available quickly. &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * @param width  The desired width in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span class=line><span class=cl><span class=cm>  *               overridden by
</span></span></span><span class=line><span class=cl><span class=cm>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)} if
</span></span></span><span class=line><span class=cl><span class=cm>  *               previously called.
</span></span></span><span class=line><span class=cl><span class=cm>  * @param height The desired height in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span class=line><span class=cl><span class=cm>  *               overridden by
</span></span></span><span class=line><span class=cl><span class=cm>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)}} if
</span></span></span><span class=line><span class=cl><span class=cm>  *               previously called).
</span></span></span><span class=line><span class=cl><span class=cm>  * @return A {@link Target} that can be used to cancel the load via
</span></span></span><span class=line><span class=cl><span class=cm>  * {@link RequestManager#clear(Target)}.
</span></span></span><span class=line><span class=cl><span class=cm>  * @see com.bumptech.glide.ListPreloader
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>preload</span><span class=o>(</span><span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>PreloadTarget</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span> <span class=o>=</span> <span class=n>PreloadTarget</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>requestManager</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>into</span><span class=o>(</span><span class=n>target</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * Preloads the resource into the cache using {@link Target#SIZE_ORIGINAL} as the target width and
</span></span></span><span class=line><span class=cl><span class=cm>  * height. Equivalent to calling {@link #preload(int, int)} with {@link Target#SIZE_ORIGINAL} as
</span></span></span><span class=line><span class=cl><span class=cm>  * the width and height.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * @return A {@link Target} that can be used to cancel the load via
</span></span></span><span class=line><span class=cl><span class=cm>  * {@link RequestManager#clear(Target)}
</span></span></span><span class=line><span class=cl><span class=cm>  * @see #preload(int, int)
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>preload</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>preload</span><span class=o>(</span><span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span><span class=o>,</span> <span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„ï¼Œåœ¨æ³¨é‡Šä¸­å‡ºç°äº†ä¸€ä¸ª ListPreload ç±»ï¼Œè¯¥ç±»æ˜¯åœ¨ ListView ä¸­åš item é¢„åŠ è½½çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œä½¿ç”¨æ–¹æ³•ä¸º AbsListView#setOnScrollListener(android.widget.AbsListView.OnScrollListener)ã€‚è¯¥ç±»ä»£ç å¾ˆç®€å•ï¼Œè¦ç‚¹å°±æ˜¯åœ¨æ»šåŠ¨æ—¶è®¡ç®—éœ€è¦é¢„å¤„ç†çš„ itemã€‚</p><p>è¿™ä¹ˆå¥½ç”¨ï¼Œé‚£æˆ‘è¦æ˜¯ RecyclerView æ€ä¹ˆåŠï¼ŸGlide ä¹Ÿæä¾›äº† RecyclerView çš„ç‰ˆæœ¬ï¼Œä¸è¿‡éœ€è¦æ·»åŠ æ–°çš„ä¾èµ– recyclerview-integrationï¼Œè¯¦æƒ…å¯ä»¥æŸ¥çœ‹æ–‡æ¡£
<a href=http://bumptech.github.io/glide/int/recyclerview.html rel=noopener>INTEGRATION LIBRARIES - RecyclerView</a>ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ preload çš„å®ç°ä¸­å…³é”®ç‚¹å°±åœ¨äº PreloadTarget ç±»ã€‚è¯¥ç±»å®ç°éå¸¸ç®€å•ï¼Œå°±æ˜¯åœ¨ onResourceReady å›è°ƒå‘ç”Ÿåï¼Œç»è¿‡ Handler ä¸­è½¬ï¼Œæœ€åç”±æ„é€ å‚æ•°ä¹‹ä¸€çš„ RequestManager å¯¹è±¡ clear æ‰ã€‚PreloadTarget å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * A one time use {@link com.bumptech.glide.request.target.Target} class that loads a resource into
</span></span></span><span class=line><span class=cl><span class=cm> * memory and then clears itself.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param &lt;Z&gt; The type of resource that will be loaded into memory.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>PreloadTarget</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>SimpleTarget</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MESSAGE_CLEAR</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>Looper</span><span class=o>.</span><span class=na>getMainLooper</span><span class=o>(),</span> <span class=k>new</span> <span class=n>Callback</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=n>Message</span> <span class=n>message</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>what</span> <span class=o>==</span> <span class=n>MESSAGE_CLEAR</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>((</span><span class=n>PreloadTarget</span><span class=o>&lt;?&gt;)</span> <span class=n>message</span><span class=o>.</span><span class=na>obj</span><span class=o>).</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>RequestManager</span> <span class=n>requestManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns a PreloadTarget.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * @param width  The width in pixels of the desired resource.
</span></span></span><span class=line><span class=cl><span class=cm>   * @param height The height in pixels of the desired resource.
</span></span></span><span class=line><span class=cl><span class=cm>   * @param &lt;Z&gt;    The type of the desired resource.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>PreloadTarget</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>obtain</span><span class=o>(</span><span class=n>RequestManager</span> <span class=n>requestManager</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>PreloadTarget</span><span class=o>&lt;&gt;(</span><span class=n>requestManager</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=nf>PreloadTarget</span><span class=o>(</span><span class=n>RequestManager</span> <span class=n>requestManager</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>requestManager</span> <span class=o>=</span> <span class=n>requestManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Z</span> <span class=n>resource</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=n>transition</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>HANDLER</span><span class=o>.</span><span class=na>obtainMessage</span><span class=o>(</span><span class=n>MESSAGE_CLEAR</span><span class=o>,</span> <span class=k>this</span><span class=o>).</span><span class=na>sendToTarget</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Synthetic</span> <span class=kt>void</span> <span class=nf>clear</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestManager</span><span class=o>.</span><span class=na>clear</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#submit><h3 id=submit><span class=hanchor arialabel=Anchor># </span>submit</h3></a><p>ä½œç”¨ï¼šè¿”å›ä¸€ä¸ª Future å¯¹è±¡ï¼Œå…¶ get() æ–¹æ³•ä¼šé˜»å¡ä½ï¼Œæ‰€ä»¥éœ€è¦åœ¨åå°çº¿ç¨‹ä¸­è°ƒç”¨</p><p>submit çš„ä¸¤ä¸ªé‡è½½æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * Returns a future that can be used to do a blocking get on a background thread.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * &lt;p&gt;This method defaults to {@link Target#SIZE_ORIGINAL} for the width and the height. However,
</span></span></span><span class=line><span class=cl><span class=cm>  * since the width and height will be overridden by values passed to {@link
</span></span></span><span class=line><span class=cl><span class=cm>  * RequestOptions#override(int, int)}, this method can be used whenever {@link RequestOptions}
</span></span></span><span class=line><span class=cl><span class=cm>  * with override values are applied, or whenever you want to retrieve the image in its original
</span></span></span><span class=line><span class=cl><span class=cm>  * size.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * @see #submit(int, int)
</span></span></span><span class=line><span class=cl><span class=cm>  * @see #into(Target)
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>FutureTarget</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>submit</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>submit</span><span class=o>(</span><span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span><span class=o>,</span> <span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * Returns a future that can be used to do a blocking get on a background thread.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * @param width  The desired width in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span class=line><span class=cl><span class=cm>  *               overridden by
</span></span></span><span class=line><span class=cl><span class=cm>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)} if
</span></span></span><span class=line><span class=cl><span class=cm>  *               previously called.
</span></span></span><span class=line><span class=cl><span class=cm>  * @param height The desired height in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span class=line><span class=cl><span class=cm>  *               overridden by
</span></span></span><span class=line><span class=cl><span class=cm>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)}} if
</span></span></span><span class=line><span class=cl><span class=cm>  *               previously called).
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>FutureTarget</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>submit</span><span class=o>(</span><span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>RequestFutureTarget</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RequestFutureTarget</span><span class=o>&lt;&gt;(</span><span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>into</span><span class=o>(</span><span class=n>target</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>Executors</span><span class=o>.</span><span class=na>directExecutor</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç”±äºæ–¹æ³•ä¼šç”Ÿæˆä¸€ä¸ª RequestFutureTarget å¯¹è±¡ï¼Œè€Œå…¶ getSize çš„å®ç°å°±æ˜¯æ„é€ å‚æ•°ã€‚æ‰€ä»¥ï¼Œæ­¤å¤„çš„å€¼ä¼šè¦†ç›–æ‰ RequestOptions è®¾ç½®çš„å€¼ã€‚</p><p>submit ä¹‹åç”Ÿæˆäº†ä¸€ä¸ª RequestFutureTarget å¯¹è±¡ï¼Œè°ƒç”¨è¯¥å¯¹è±¡çš„ get æ–¹æ³•å¯ä»¥åœ¨èµ„æºåŠ è½½æˆåŠŸåç«‹å³è·å¾—èµ„æºå¯¹è±¡ï¼Œåœ¨è·å¾—ä¹‹å‰ä¼šé˜»å¡ï¼Œæ‰€ä»¥ get æ–¹æ³•éœ€è¦åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p><p>RequestFutureTarget çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>FutureTarget</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>target</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>RequestManager</span> <span class=n>requestManager</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span> <span class=o>=</span> <span class=n>requestManager</span>
</span></span><span class=line><span class=cl>     <span class=o>.</span><span class=na>downloadOnly</span><span class=o>()</span>
</span></span><span class=line><span class=cl>     <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>model</span><span class=o>)</span>
</span></span><span class=line><span class=cl>     <span class=o>.</span><span class=na>submit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=n>downloadedFile</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ... do something with the file (usually throws IOException)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ExecutionException</span> <span class=o>|</span> <span class=n>InterruptedException</span> <span class=o>|</span> <span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ... bug reporting or recovery
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// make sure to cancel pending operations and free resources
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>target</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=na>cancel</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span> <span class=c1>// mayInterruptIfRunning
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#downloadonly><h3 id=downloadonly><span class=hanchor arialabel=Anchor># </span>downloadOnly</h3></a><p>ä½œç”¨ï¼šä¸‹è½½åŸå§‹çš„æ— ä¿®æ”¹çš„ data æ–‡ä»¶ã€‚</p><p>downloadOnly å†…éƒ¨è°ƒç”¨çš„æ˜¯ä¿®æ”¹è¿‡é…ç½®çš„ into/submit æ–¹æ³•ï¼Œä½† downloadOnly æ–¹æ³•å·²ç»è¢«åºŸå¼ƒï¼›å»ºè®®é‡‡ç”¨ RequestManager çš„ downloadOnly() æ–¹æ³•å’Œ into/submit æ–¹æ³•ã€‚</p><p>å®é™…ä¸Š RequestBuilder.downloadOnly æ–¹æ³•ä¸ RequestManager.downloadOnly()ã€RequestBuilder.into/submit æ–¹æ³•ç»„åˆæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p><p>ä¸¤å¤„ä»£ç å¦‚ä¸‹ï¼š</p><p><em>RequestBuilder.downloadOnly</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>downloadOnly</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>getDownloadOnlyRequest</span><span class=o>().</span><span class=na>into</span><span class=o>(</span><span class=n>target</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>FutureTarget</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>downloadOnly</span><span class=o>(</span><span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>getDownloadOnlyRequest</span><span class=o>().</span><span class=na>submit</span><span class=o>(</span><span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>getDownloadOnlyRequest</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestBuilder</span><span class=o>&lt;&gt;(</span><span class=n>File</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=k>this</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>DOWNLOAD_ONLY_OPTIONS</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><em>RequestManager.downloadOnlyã€RequestBuilder.into/submit</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=p>&lt;</span><span class=nt>Y</span> <span class=na>extends</span> <span class=na>Target</span><span class=err>&lt;</span><span class=na>TranscodeType</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>Y</span> <span class=nx>into</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Y</span> <span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>Executors</span><span class=p>.</span><span class=nx>mainThreadExecutor</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>FutureTarget</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>submit</span><span class=p>(</span><span class=nx>int</span> <span class=nx>width</span><span class=p>,</span> <span class=nx>int</span> <span class=nx>height</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>final</span> <span class=nx>RequestFutureTarget</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>target</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>RequestFutureTarget</span><span class=p>&lt;&gt;(</span><span class=nx>width</span><span class=p>,</span> <span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>target</span><span class=p>,</span> <span class=nx>Executors</span><span class=p>.</span><span class=nx>directExecutor</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>File</span><span class=p>&gt;</span> <span class=nx>downloadOnly() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kr>as</span><span class=p>(</span><span class=nx>File</span><span class=p>.</span><span class=kr>class</span><span class=p>).</span><span class=nx>apply</span><span class=p>(</span><span class=nx>DOWNLOAD_ONLY_OPTIONS</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ‰€ä»¥ï¼Œè¿™é‡Œçš„ DOWNLOAD_ONLY_OPTIONS æ‰æ˜¯ downloadOnly çš„ç²¾é«“ï¼Œæˆ‘ä»¬çœ‹çœ‹è¯¥å˜é‡çš„å€¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestOptions</span> <span class=n>DOWNLOAD_ONLY_OPTIONS</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>RequestOptions</span><span class=o>().</span><span class=na>diskCacheStrategy</span><span class=o>(</span><span class=n>DiskCacheStrategy</span><span class=o>.</span><span class=na>DATA</span><span class=o>).</span><span class=na>priority</span><span class=o>(</span><span class=n>Priority</span><span class=o>.</span><span class=na>LOW</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>skipMemoryCache</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>æœç„¶æ˜¯ä¸‹è½½çš„æ˜¯åŸå§‹çš„æ— ä¿®æ”¹çš„ data èµ„æºã€‚</p><a href=#listeneraddlistener><h3 id=listeneraddlistener><span class=hanchor arialabel=Anchor># </span>listener/addListener</h3></a><p>listener ä¸ addListener ä¸åŒä¹‹å¤„åœ¨äºï¼Œå‰è€…åªä¼šä¿ç•™å½“å‰çš„ Listenerï¼Œè€Œåè€…ä¼šä¿ç•™ä¹‹å‰çš„ Listenerã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;unchecked&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>listener</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>requestListener</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>requestListeners</span> <span class=p>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>addListener</span><span class=p>(</span><span class=n>requestListener</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>addListener</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>requestListener</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>requestListener</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>requestListeners</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=n>requestListeners</span> <span class=p>=</span> <span class=n>new</span> <span class=n>ArrayList</span><span class=p>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=n>requestListeners</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>requestListener</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™äº› listener ä¼šåœ¨èµ„æºè®°è½½å¤±è´¥æˆ–è€…æˆåŠŸçš„æ—¶å€™è¢«è°ƒç”¨ï¼ŒSingleRequest ä¸­å…³äº requestListeners çš„ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>R</span> <span class=n>result</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We must call isFirstReadyResource before setting status.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>boolean</span> <span class=n>isFirstResource</span> <span class=o>=</span> <span class=n>isFirstReadyResource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=o>.</span><span class=na>COMPLETE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=o>:</span> <span class=n>requestListeners</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>            <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>animation</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>animationFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>target</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>animation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>notifyLoadSuccess</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=o>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=o>,</span> <span class=kt>int</span> <span class=n>maxLogLevel</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>stateVerifier</span><span class=o>.</span><span class=na>throwIfRecycled</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>.</span><span class=na>setOrigin</span><span class=o>(</span><span class=n>requestOrigin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>loadStatus</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=o>.</span><span class=na>FAILED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//TODO: what if this is a thumbnail request?
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=o>:</span> <span class=n>requestListeners</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>            <span class=n>listener</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>isFirstReadyResource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>isFirstReadyResource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>setErrorPlaceholder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>notifyLoadFailed</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è°ƒç”¨é€»è¾‘æ˜¯è¿™æ ·ï¼šåœ¨ requestListeners é›†åˆã€targetListener ä¸­ä¾æ¬¡è°ƒç”¨å¯¹åº”çš„å›è°ƒï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªèƒ½å¤Ÿå¤„ç†çš„(è¿”å› true)ï¼Œåé¢çš„å°±ä¸å†è°ƒç”¨ã€‚</p><p>åŒæ—¶ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå›è°ƒè¿”å›äº† trueï¼Œé‚£ä¹ˆèµ„æºçš„å¯¹åº”æ–¹æ³•ä¼šè¢«æ‹¦æˆªï¼š</p><ol><li>å¯¹äº onResourceReady æ–¹æ³•æ¥è¯´ï¼ŒTarget çš„ onResourceReady æ–¹æ³•ä¸ä¼šè¢«å›è°ƒ</li><li>å¯¹äº onLoadFailed æ–¹æ³•æ¥è¯´ï¼ŒsetErrorPlaceholder è°ƒç”¨ä¸ä¼šè°ƒç”¨ï¼Œå³ä¸ä¼šæ˜¾ç¤ºä»»ä½•å¤±è´¥çš„å ä½ç¬¦</li></ol><a href=#transform><h1 id=transform><span class=hanchor arialabel=Anchor># </span>Transform</h1></a><a href=#transform-è¡Œä¸ºåˆ†æ><h2 id=transform-è¡Œä¸ºåˆ†æ><span class=hanchor arialabel=Anchor># </span>Transform è¡Œä¸ºåˆ†æ</h2></a><a href=#åœºæ™¯è¿˜åŸ><h3 id=åœºæ™¯è¿˜åŸ><span class=hanchor arialabel=Anchor># </span>åœºæ™¯è¿˜åŸ</h3></a><p>å¸ƒå±€æ–‡ä»¶ï¼šImageView å®½é«˜éƒ½æ˜¯ wrap_content</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>android.support.constraint.ConstraintLayout</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:android</span><span class=o>=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:app</span><span class=o>=</span><span class=s>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_width</span><span class=o>=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_height</span><span class=o>=</span><span class=s>&#34;match_parent&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id</span><span class=o>=</span><span class=s>&#34;@+id/ivGlide&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width</span><span class=o>=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height</span><span class=o>=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf</span><span class=o>=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toTopOf</span><span class=o>=</span><span class=s>&#34;parent&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>android.support.design.widget.FloatingActionButton</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id</span><span class=o>=</span><span class=s>&#34;@+id/fab&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width</span><span class=o>=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height</span><span class=o>=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_margin</span><span class=o>=</span><span class=s>&#34;24dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:src</span><span class=o>=</span><span class=s>&#34;@drawable/btn_camera&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf</span><span class=o>=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintBottom_toBottomOf</span><span class=o>=</span><span class=s>&#34;parent&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>android.support.constraint.ConstraintLayout</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»£ç ï¼šæµ‹è¯•çš„å¯é€‰é¡¹ä¸ºä»£ç ä¸­è¢«æ³¨é‡Šçš„ä¸¤è¡Œä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=k>import</span> <span class=nn>com.bumptech.glide.request.target.Target</span> <span class=k>as</span> <span class=n>GlideTarget</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GlideFragment</span> <span class=p>:</span> <span class=n>Fragment</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onViewCreated</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span> <span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onViewCreated</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>fab</span><span class=p>.</span><span class=n>setOnClickListener</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>load</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>//            .dontTransform()
</span></span></span><span class=line><span class=cl><span class=c1>//            .override(GlideTarget.SIZE_ORIGINAL, GlideTarget.SIZE_ORIGINAL)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 540*258  1080/(759-243)-(540/258)=0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>private</span> <span class=k>const</span> <span class=k>val</span> <span class=py>URL</span> <span class=p>=</span> <span class=s2>&#34;https://www.baidu.com/img/bd_logo1.png&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ•´ä¸ªä¾‹å­éå¸¸ç®€å•ï¼Œç‚¹å‡»ä¸€ä¸‹ FAB å°±ä¼šè°ƒç”¨ load æ–¹æ³•åŠ è½½ç½‘è·¯å›¾ç‰‡ã€‚æ³¨æ„è¿™é‡Œ ImageView çš„å®½é«˜éƒ½æ˜¯ wrap_contentã€‚</p><p>ä¸‹é¢ä»å·¦è‡³å³ 4 å¼ å›¾åˆ†åˆ«å¯¹åº”ä»¥ä¸‹é…ç½®å¼€å¯æ—¶çš„æ•ˆæœï¼ˆä¸‹é¢åˆ†ææ—¶ä¼šç§°ä¸ºä¾‹ 1ã€ä¾‹ 2ã€ä¾‹ 3ã€ä¾‹ 4ï¼‰ï¼š</p><ol><li>ç›´æ¥åŠ è½½</li><li>åªä½¿ç”¨ dontTransform</li><li>åªä½¿ç”¨ override</li><li>dontTransform å’Œ override åŒæ—¶</li></ol><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031837.png width=auto alt></p><p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œæ˜¾ç¤ºçš„å›¾ç‰‡ä¹Ÿæœ‰æ‰€å·®å¼‚ï¼ŒImageView çš„å®½é«˜æœ‰æ‰€å·®å¼‚ã€‚</p><p>å¦‚æœæ²¡æœ‰è°ƒç”¨ override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)ï¼ŒImageView å®½åº¦ä¼šæ˜¯ match_parent çš„æ•ˆæœï¼Œä¸”å¦‚æœ dontTransform()ï¼Œé‚£ä¹ˆé«˜åº¦ä¹Ÿæ˜¯ match_parent æ•ˆæœã€‚è°ƒç”¨äº† override ä¹‹åä¼šæ˜¾ç¤ºçš„å›¾ç‰‡çš„çœŸå®å°ºå¯¸ã€‚</p><p>å¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œåˆ°æºç ä¸­çœ‹çœ‹æ˜¯æ€ä¹ˆå›äº‹ã€‚</p><a href=#ä»£ç åˆ†æ><h3 id=ä»£ç åˆ†æ><span class=hanchor arialabel=Anchor># </span>ä»£ç åˆ†æ</h3></a><p>é¦–å…ˆ dontTransform() æ–¹æ³•å®ç°åœ¨ BaseRequestOptions æ–‡ä»¶ä¸­ï¼Œè¯¥æ–¹æ³•çš„æ„æ€å°±æ˜¯ä¸ä½¿ç”¨ä»»ä½• transformï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>T</span> <span class=nf>dontTransform</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isAutoCloneEnabled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clone</span><span class=o>().</span><span class=na>dontTransform</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>transformations</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>TRANSFORMATION</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>isTransformationRequired</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>TRANSFORMATION_REQUIRED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>isTransformationAllowed</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=o>|=</span> <span class=n>TRANSFORMATION_ALLOWED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>isScaleOnlyOrNoTransform</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé¦–å…ˆæ¸…ç©ºäº† transformationsï¼Œç„¶åè®¾ç½®äº†ä¸€äº›æ ‡å¿—ä½ã€‚è¿™äº›æ ‡å¿—ä½åé¢çœ‹åˆ°å†è¯´ã€‚ç„¶åæ˜¯ override æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„æ„æ€æ˜¯åªåŠ è½½æŒ‡å®šå®½é«˜çš„åƒç´ çš„å›¾ç‰‡ï¼Œæ–¹æ³•å®ç°åªæ˜¯ä¿å­˜äº†å‚æ•°ï¼Œå¾…åé¢ä½¿ç”¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>T</span> <span class=k>override</span><span class=p>(</span><span class=n>int</span> <span class=n>width</span><span class=p>,</span> <span class=n>int</span> <span class=n>height</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=k>override</span><span class=p>(</span><span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>overrideWidth</span> <span class=p>=</span> <span class=n>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>overrideHeight</span> <span class=p>=</span> <span class=n>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=p>|=</span> <span class=n>OVERRIDE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨é…ç½®å®Œå‚æ•°åï¼Œè°ƒç”¨ into æ–¹æ³•å¼€å§‹åŠ è½½å›¾ç‰‡ã€‚æ•´ä¸ªåŠ è½½æµç¨‹éå¸¸å†—é•¿ï¼Œè¯¦æƒ…è¯·çœ‹å‰é¢çš„åˆ†ææ–‡ç« ã€‚æ‰€ä»¥è¿™é‡ŒåªæŒ‘é€‰ç›¸å…³çš„ä»£ç ï¼Œå…¶ä»–çš„ä¼šä¸€ç¬”å¸¦è¿‡ã€‚</p><p>å…ˆæ˜¯ RequestBuilder.into(ImageView) çš„å®ç°ï¼Œè¯¥æ–¹æ³•ä¼šé»˜è®¤è¿›è¡Œä¸€äº› transform çš„é…ç½®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>into</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Util</span><span class=o>.</span><span class=na>assertMainThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span> <span class=o>=</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!</span><span class=n>requestOptions</span><span class=o>.</span><span class=na>isTransformationSet</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>isTransformationAllowed</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>view</span><span class=o>.</span><span class=na>getScaleType</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// into a different target, we don&#39;t retain the transformation applied based on the previous
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// View&#39;s scale type.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getScaleType</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_CROP</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterCrop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_INSIDE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterInside</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_CENTER</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_START</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_END</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalFitCenter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_XY</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterInside</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>MATRIX</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Do nothing.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>into</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>glideContext</span><span class=o>.</span><span class=na>buildImageViewTarget</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>transcodeClass</span><span class=o>),</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Executors</span><span class=o>.</span><span class=na>mainThreadExecutor</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ä¸Šé¢ä»£ç ç¬¬ 7 è¡Œçš„åˆ¤æ–­è¯­å¥ !requestOptions.isTransformationSet()ï¼Œåˆ¤æ–­çš„æ˜¯ fields æ˜¯å¦å«æœ‰æ ‡è®°ä½ TRANSFORMATIONã€‚</p><p>ç¬¬ 8 è¡Œåˆ¤æ–­è¯­å¥ requestOptions.isTransformationAllowed() åˆ¤æ–­çš„æ˜¯ isTransformationAllowedã€‚</p><p>å¯¹äºè¿™ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œå¦‚æœè°ƒç”¨äº† dontTransform() æ–¹æ³•ï¼ˆä¾‹ 2ã€ä¾‹ 4ï¼‰ï¼Œé‚£ä¹ˆæ˜¾ç„¶æ¡ä»¶ 1 æ»¡è¶³ï¼Œä½†æ˜¯æ¡ä»¶ 2 å°±ä¸æ»¡è¶³äº†ã€‚å¦åˆ™ï¼ˆä¾‹ 1ã€ä¾‹ 3ï¼‰ï¼Œè¿™ä¸¤ä¸ªæ¡ä»¶éƒ½æ˜¯æ»¡è¶³çš„ï¼Œä¹Ÿå°±æ„å‘³ç€ Glide ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„ transformã€‚é»˜è®¤çš„ transform ä¼šæ ¹æ® ImageView çš„ ScaleType æœ‰ä¸åŒçš„å–å€¼ã€‚</p><p>ScaleType ä¸é»˜è®¤çš„ transform ä¹‹é—´å…³ç³»å¦‚ä¸‹è¡¨ï¼š</p><p>åœ¨ ImageView.initImageView() æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤çš„ ScaleType ä¸º ScaleType.FIT_CENTERã€‚æ‰€ä»¥ï¼Œæ­¤æ—¶ Glide ä¼šé»˜è®¤è°ƒç”¨ optionalFitCenter() æ–¹æ³•ã€‚</p><p>æ³¨æ„ï¼ŒoptionalFitCenter() æ–¹æ³•ä¸é optional çš„ fitCenter() æ–¹æ³•çš„å·®åˆ«åœ¨äº isTransformationRequired å‚æ•°çš„å€¼ä¸åŒã€‚åœ¨æœ€å DecodeHelper.getTransformation(Class) æ–¹æ³•ä¸­ï¼Œå¦‚æœæ‰¾ä¸åˆ°å¯ç”¨çš„ transformï¼Œä¸” isTransformationRequired ä¸º trueï¼Œå°±ä¼šæŠ›å‡º IllegalArgumentExceptionã€‚é™¤æ­¤ä¹‹å¤–ä¸¤è€…æ²¡æœ‰åˆ«çš„å·®åˆ«ã€‚</p><p>optionalFitCenter() æ–¹æ³•ä¼šé’ˆå¯¹å››ç§ä¸åŒç±»å‹çš„æ•°æ®äº§ç”Ÿä¸åŒçš„ transformationï¼š</p><p>ç°åœ¨å¯ä»¥å¼€å§‹åŠ è½½å›¾ç‰‡äº†ï¼Œæœ€å¼€å§‹ä¼šè°ƒç”¨ SingleRequest.begin æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šåˆ¤æ–­éœ€è¦æ˜¾ç¤ºå¤šå¤§å°ºå¯¸çš„å›¾ç‰‡ã€‚å¦‚æœæŒ‡å®šäº† override(int, int)ï¼ˆä¾‹ 3ã€ä¾‹ 4ï¼‰ï¼Œé‚£ä¹ˆå°±æ— éœ€ ViewTarget å‚ä¸è®¡ç®—ï¼Œç›´æ¥è°ƒç”¨ onSizeReady(int, int) å¼€å§‹ä¸‹ä¸€æ­¥ï¼›å¦åˆ™ï¼ˆä¾‹ 1ã€ä¾‹ 2ï¼‰å°±è¦è®¡ç®—äº†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>begin</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>model</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isValidDimensions</span><span class=o>(</span><span class=n>overrideWidth</span><span class=o>,</span> <span class=n>overrideHeight</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>width</span> <span class=o>=</span> <span class=n>overrideWidth</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>height</span> <span class=o>=</span> <span class=n>overrideHeight</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=o>.</span><span class=na>RUNNING</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Cannot restart a running request&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=o>.</span><span class=na>COMPLETE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>onResourceReady</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>MEMORY_CACHE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Restarts for requests that are neither complete nor running can be treated as new requests
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// and can run again from the beginning.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=o>.</span><span class=na>WAITING_FOR_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isValidDimensions</span><span class=o>(</span><span class=n>overrideWidth</span><span class=o>,</span> <span class=n>overrideHeight</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>onSizeReady</span><span class=o>(</span><span class=n>overrideWidth</span><span class=o>,</span> <span class=n>overrideHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>((</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=o>.</span><span class=na>RUNNING</span> <span class=o>||</span> <span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=o>.</span><span class=na>WAITING_FOR_SIZE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>canNotifyStatusChanged</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=na>onLoadStarted</span><span class=o>(</span><span class=n>getPlaceholderDrawable</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ˜¾ç„¶ï¼Œé€ æˆç¤ºä¾‹ä¸­å›¾ç‰‡å°ºå¯¸å·®å¼‚çš„ä¸€ä¸ªåŸå› å°±æ˜¯è¿™ä¸ªç¬¬ 27 è¡Œçš„ target.getSize(this) æ–¹æ³•äº†ã€‚å¯¹åº”æ–¹æ³•çš„å®ç°åœ¨ ViewTarget ä¸­ï¼Œè¿™ä¸ªè¯·æ±‚ä¼šè½¬å‘ç»™å†…éƒ¨çš„ SizeDeterminer æ¥å®Œæˆã€‚çœ‹ä¸€ä¸‹ ViewTarget.SizeDeterminer ç±»ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>SizeDeterminer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>getSize</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>SizeReadyCallback</span> <span class=n>cb</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>currentWidth</span> <span class=o>=</span> <span class=n>getTargetWidth</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>currentHeight</span> <span class=o>=</span> <span class=n>getTargetHeight</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isViewStateAndSizeValid</span><span class=o>(</span><span class=n>currentWidth</span><span class=o>,</span> <span class=n>currentHeight</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cb</span><span class=o>.</span><span class=na>onSizeReady</span><span class=o>(</span><span class=n>currentWidth</span><span class=o>,</span> <span class=n>currentHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=nf>getTargetHeight</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>verticalPadding</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getPaddingTop</span><span class=o>()</span> <span class=o>+</span> <span class=n>view</span><span class=o>.</span><span class=na>getPaddingBottom</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LayoutParams</span> <span class=n>layoutParams</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>layoutParamSize</span> <span class=o>=</span> <span class=n>layoutParams</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>layoutParams</span><span class=o>.</span><span class=na>height</span> <span class=o>:</span> <span class=n>PENDING_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getTargetDimen</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span> <span class=n>layoutParamSize</span><span class=o>,</span> <span class=n>verticalPadding</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=nf>getTargetWidth</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>horizontalPadding</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getPaddingLeft</span><span class=o>()</span> <span class=o>+</span> <span class=n>view</span><span class=o>.</span><span class=na>getPaddingRight</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LayoutParams</span> <span class=n>layoutParams</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>layoutParamSize</span> <span class=o>=</span> <span class=n>layoutParams</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>layoutParams</span><span class=o>.</span><span class=na>width</span> <span class=o>:</span> <span class=n>PENDING_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getTargetDimen</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span> <span class=n>layoutParamSize</span><span class=o>,</span> <span class=n>horizontalPadding</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆåœ¨ç¬¬ 3ã€4 è¡Œè°ƒç”¨æ–¹æ³•è·å– Target çš„å®½é«˜ï¼Œç”±äºåœ¨æœ¬ä¾‹ä¸­å®½é«˜éƒ½æ˜¯ WRAP_CONTENTï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰å…¶ä»–çš„é™åˆ¶ï¼Œæ‰€ä»¥æœ€åè°ƒç”¨ getTargetDimen æ—¶ä¼ å…¥çš„å‚æ•°éƒ½æ˜¯ä¸€æ ·çš„ (viewSize=0, paramSize=WRAP_CONTENT=-2, paddingSize=0)ã€‚ç„¶åï¼Œçœ‹çœ‹ getTargetDimen æ–¹æ³•çš„å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>getTargetDimen</span><span class=o>(</span><span class=kt>int</span> <span class=n>viewSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>paramSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>paddingSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We consider the View state as valid if the View has non-null layout params and a non-zero
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// layout params width and height. This is imperfect. We&#39;re making an assumption that View
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// parents will obey their child&#39;s layout parameters, which isn&#39;t always the case.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>adjustedParamSize</span> <span class=o>=</span> <span class=n>paramSize</span> <span class=o>-</span> <span class=n>paddingSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>adjustedParamSize</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>adjustedParamSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Since we always prefer layout parameters with fixed sizes, even if waitForLayout is true,
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// we might as well ignore it and just return the layout parameters above if we have them.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Otherwise we should wait for a layout pass before checking the View&#39;s dimensions.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>waitForLayout</span> <span class=o>&amp;&amp;</span> <span class=n>view</span><span class=o>.</span><span class=na>isLayoutRequested</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>PENDING_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// We also consider the View state valid if the View has a non-zero width and height. This
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// means that the View has gone through at least one layout pass. It does not mean the Views
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// width and height are from the current layout pass. For example, if a View is re-used in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// RecyclerView or ListView, this width/height may be from an old position. In some cases
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// the dimensions of the View at the old position may be different than the dimensions of the
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// View in the new position because the LayoutManager/ViewParent can arbitrarily decide to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// change them. Nevertheless, in most cases this should be a reasonable choice.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>adjustedViewSize</span> <span class=o>=</span> <span class=n>viewSize</span> <span class=o>-</span> <span class=n>paddingSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>adjustedViewSize</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>adjustedViewSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Finally we consider the view valid if the layout parameter size is set to wrap_content.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// It&#39;s difficult for Glide to figure out what to do here. Although Target.SIZE_ORIGINAL is a
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// coherent choice, it&#39;s extremely dangerous because original images may be much too large to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// fit in memory or so large that only a couple can fit in memory, causing OOMs. If users want
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// the original image, they can always use .override(Target.SIZE_ORIGINAL). Since wrap_content
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// may never resolve to a real size unless we load something, we aim for a square whose length
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// is the largest screen size. That way we&#39;re loading something and that something has some
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// hope of being downsampled to a size that the device can support. We also log a warning that
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// tries to explain what Glide is doing and why some alternatives are preferable.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Since WRAP_CONTENT is sometimes used as a default layout parameter, we always wait for
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// layout to complete before using this fallback parameter (ConstraintLayout among others).
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!</span><span class=n>view</span><span class=o>.</span><span class=na>isLayoutRequested</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>paramSize</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>INFO</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>i</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Glide treats LayoutParams.WRAP_CONTENT as a request for an image the size of&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; this device&#39;s screen dimensions. If you want to load the original image and are&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; ok with the corresponding memory cost and OOMs (depending on the input size), use&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; .override(Target.SIZE_ORIGINAL). Otherwise, use LayoutParams.MATCH_PARENT, set&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; layout_width and layout_height to fixed dimension, or use .override() with fixed&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; dimensions.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getMaxDisplayLength</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If the layout parameters are &lt; padding, the view size is &lt; padding, or the layout
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// parameters are set to match_parent or wrap_content and no layout has occurred, we should
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// wait for layout and repeat.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>PENDING_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ getTargetDimen æ–¹æ³•ä¸­ä¼šé€šè¿‡å‚æ•°è®¡ç®— Target çš„å°ºå¯¸ï¼Œæ˜¾ç„¶è¿™é‡Œæœ€åä¼šè°ƒç”¨ getMaxDisplayLength(view.getContext()) æ¥è¿”å› View çš„å°ºå¯¸ã€‚è‡³äºä¸ºä»€ä¹ˆ wrap_content æ—¶ä¼šè¿™æ ·åšï¼Œåœ¨æ³¨é‡Šä¸­è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œä¸»è¦æ˜¯è€ƒè™‘åˆ°åŠ è½½çš„èµ„æºçš„ä¸ç¡®å®šæ€§ï¼Œä¸‡ä¸€æ˜¯ä¸€ä¸ªå¤§å›¾ç‰‡å°±ç›´æ¥ OOM äº†ã€‚è€Œä¸” Glide ä¼šæ‰“å°å‡º log å‘Šè¯‰æˆ‘ä»¬ä¸€äº›è§£å†³æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ»¡æ„è¿™ç§å¤„ç†æ–¹å¼ã€‚</p><p>getMaxDisplayLength(Context) ä¼šè¿”å› Display size å®½é«˜çš„è¾ƒå¤§è€…ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Use the maximum to avoid depending on the device&#39;s current orientation.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getMaxDisplayLength</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>maxDisplayLength</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>WindowManager</span> <span class=n>windowManager</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=o>(</span><span class=n>WindowManager</span><span class=o>)</span> <span class=n>context</span><span class=o>.</span><span class=na>getSystemService</span><span class=o>(</span><span class=n>Context</span><span class=o>.</span><span class=na>WINDOW_SERVICE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Display</span> <span class=n>display</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>windowManager</span><span class=o>).</span><span class=na>getDefaultDisplay</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Point</span> <span class=n>displayDimensions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Point</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>display</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>displayDimensions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>maxDisplayLength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>displayDimensions</span><span class=o>.</span><span class=na>x</span><span class=o>,</span> <span class=n>displayDimensions</span><span class=o>.</span><span class=na>y</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>maxDisplayLength</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ˜¾ç„¶ï¼Œåœ¨ç¤ºä¾‹ä¸­ï¼Œæœ€åè·å–åˆ°çš„å®½é«˜éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåœ¨ç«–å±çŠ¶æ€ä¸‹ä¼šæ˜¯ Display çš„é«˜ã€‚</p><p><strong>Display#getSize ä¸ Display#getRealSize çš„åŒºåˆ«ï¼Ÿ</strong></p><p>Display#getRealSize è¿”å›çš„æ˜¯å±å¹•çœŸå®çš„å°ºå¯¸ï¼›è€Œ Display#getSize è¿”å›çš„æ˜¯â€œå¯ç”¨â€çš„å±å¹•å°ºå¯¸ï¼Œå¸¸è§çš„æƒ…å†µæ˜¯ï¼Œæœ‰ NavigationBar å°±ä¼šç­‰äº RealSize å‡å» NavigationBar çš„é«˜åº¦ã€‚</p><p>è·å–åˆ°äº† Target çš„å°ºå¯¸ä¹‹åï¼Œä¼šè°ƒç”¨ isViewStateAndSizeValid æ–¹æ³•æ£€æŸ¥æ˜¯å¦ OKï¼šOK å°±è°ƒç”¨ SingleRequest.onSizeReady æ–¹æ³•è¿›å…¥ä¸‹ä¸€æ­¥äº†ï¼›å¦åˆ™ä¼šç»™ ViewTree æ·»åŠ  OnPreDrawListener ç›‘å¬å™¨ï¼Œåœ¨ onPreDraw æ–¹æ³•å›è°ƒä¸­å†æ¬¡è·å–ä¸€ä¸‹å°ºå¯¸ã€‚</p><p>åœ¨ç»è¿‡ä¸€ç³»åˆ—æ“ä½œï¼ŒåŠ è½½åˆ°åŸå§‹æ•°æ®ä¹‹åï¼Œä¼šç°åœ¨ DecodePath.decode ä¸­å¯¹åŸå§‹ data è¿›è¡Œ decodeï¼Œè¿™æ ·å°±å¾—åˆ°äº† Bitmapï¼Œä½†æ˜¯è¿‡ç¨‹ä¸­æ¶‰åŠåˆ° Bitmap å°ºå¯¸çš„æ“ä½œã€‚å…·ä½“ç»è¿‡ ByteBufferBitmapDecoder åˆ° Downsampler#decodeFromWrappedStreams æ–¹æ³•ä¸­ã€‚é‡Œé¢ç»å¤§å¤šæ•°éƒ½æ˜¯è®¡ç®—ï¼Œè¿™é‡Œæ‹¿ä¾‹ 1 æ¥æè¿°è®¡ç®—è¿‡ç¨‹ï¼š</p><ol><li>è·å– Bitmap çš„å®½é«˜ï¼šsourceWidth=540,sourceHeight=258ï¼›è·å– Target çš„å®½é«˜ï¼štargetWidth=targetHeight=1776</li><li>è°ƒç”¨ calculateScaling æ–¹æ³•è®¡ç®— inSampleSizeã€inTargetDensityã€inDensity ç­‰ä¸€ç³»åˆ—å‚æ•°ï¼Œè¿™é‡Œä¼šç”¨åˆ° DownsampleStrategy.FitCenter ç±»ï¼Œè¯¥å¯¹è±¡åœ¨å‰é¢ optionalFitCenter() è¿‡ç¨‹ä¿å­˜çš„ KV è¡¨æ ¼ä¸­æåˆ°è¿‡ã€‚å…¶ getScaleFactor æ–¹æ³•å®ç°å°±æ˜¯å– target å®½é«˜ / source å®½é«˜çš„è¾ƒå°è€…ï¼Œä¹Ÿå°±æ˜¯ 3.288889ï¼Œè¯¥å€¼ç”± inTargetDensity/inDensity ä¿å­˜ã€‚</li><li>æœ€åè®¡ç®— expectedWidth=round(540<em>3.288889)=1776ï¼ŒexpectedHeight=round(258</em>3.288889)=849ï¼Œå¹¶ä» BitmapPool ä¸­è·å–è¿™ä¹ˆä¸€ä¸ªå®½é«˜çš„ Bitmap è®¾ç½®ç»™ Options.inBitmap</li><li>å†æ¬¡è¿›è¡Œè§£ç ï¼Œè§£ç å®Œæ¯•åè·å¾—çš„å›¾ç‰‡å°±æ˜¯ 1776x849 å¤§å°çš„å›¾ç‰‡äº†ã€‚</li></ol><p>å¦‚æœæ˜¯ dontTransformï¼ˆä¾‹ 2ï¼‰ï¼ŒDownsampleStrategy ä¼šæ˜¯é»˜è®¤å€¼ DownsampleStrategy.CenterOutsideã€‚å…¶ getScaleFactor æ–¹æ³•å®ç°å°±æ˜¯å– target å®½é«˜ / source å®½é«˜çš„è¾ƒå¤§è€…ï¼Œä¹Ÿå°±æ˜¯ 6.883721ã€‚å› æ­¤æœ€åè§£ç å®Œæ¯•çš„å›¾ç‰‡å¤§å°ä¸º 3717x1776ã€‚</p><p>å¦‚æœæ˜¯ override è¿‡çš„ï¼ˆä¾‹ 3ã€ä¾‹ 4ï¼‰ï¼Œç”±äºä¸éœ€è¦ç¼©æ”¾ï¼Œæ‰€ä»¥è¿”å›çš„å°±æ˜¯åŸå§‹å¤§å°çš„å›¾ç‰‡ã€‚</p><p>åœ¨ decode å®Œæ¯•åï¼Œä¼šå›åˆ° DecodeJob.onResourceDecoded æ–¹æ³•ä¸­æ¥ç€è¿›è¡Œ transform æ“ä½œï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=o>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceSubClass</span> <span class=o>=</span> <span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;)</span> <span class=n>decoded</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>decoded</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>dataSource</span> <span class=o>!=</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getTransformation</span><span class=o>(</span><span class=n>resourceSubClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>transformed</span> <span class=o>=</span> <span class=n>appliedTransformation</span><span class=o>.</span><span class=na>transform</span><span class=o>(</span><span class=n>glideContext</span><span class=o>,</span> <span class=n>decoded</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨è¿™é‡Œé¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯ DataSource.RESOURCE_DISK_CACHEï¼Œå¦‚æœä¸æ˜¯æ‰éœ€è¦è¿›è¡Œ transformã€‚</p><p><strong>But, why?</strong> Glide ä¸­å¾ˆé‡è¦çš„æ¦‚å¿µâ€”â€”resource å’Œ dataï¼šå·®åˆ«åœ¨äº resource æ˜¯å·²ç» transform è¿‡äº†çš„ï¼Œå³ transform(data)=resourceã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬çŸ¥é“ resource å·²ç»ç»è¿‡ transform è¿‡äº†ï¼Œè‡ªç„¶å°±ä¸å†éœ€è¦ã€‚</p><p>å¯¹äºè°ƒç”¨è¿‡ dontTransform() æ–¹æ³•çš„ä¾‹å­ï¼ˆä¾‹ 2ã€ä¾‹ 4ï¼‰æ¥è¯´ï¼ŒdecodeHelper.getTransformation è¿”å›çš„æ˜¯ä¸€ä¸ª UnitTransformationï¼Œå…¶ transform æ²¡æœ‰å¹²ä»»ä½•æœ‰æ„ä¹‰çš„äº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸è¿›è¡Œ transformã€‚</p><p>å¯¹äºæ™®é€šçš„ Glide åŠ è½½è¯·æ±‚ï¼ˆä¾‹ 1ã€ä¾‹ 3ï¼‰æ¥è¯´ï¼Œä¸€ä¸ª URL å·²ç»ç»è¿‡ä¸€ç³»åˆ— Registry çš„å˜æ¢ï¼Œåˆ°è¿™é‡Œå°±å˜æˆ äº† Bitmap.classï¼Œæ‰€ä»¥åœ¨ç¬¬ 11 è¡Œè°ƒç”¨çš„æ˜¯ FitCenter().transform(Context, Resource<bitmap>, int, int )æ–¹æ³•ã€‚è€Œ FitCenter åˆæ˜¯ BitmapTransformation çš„å­ç±»ï¼Œæ‰€ä»¥å…ˆçœ‹çœ‹ BitmapTransformationï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>BitmapTransformation</span> <span class=kd>implements</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>final</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>transform</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>Util</span><span class=o>.</span><span class=na>isValidDimensions</span><span class=o>(</span><span class=n>outWidth</span><span class=o>,</span> <span class=n>outHeight</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Cannot apply transformation on width: &#34;</span> <span class=o>+</span> <span class=n>outWidth</span> <span class=o>+</span> <span class=s>&#34; or height: &#34;</span> <span class=o>+</span> <span class=n>outHeight</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; less than or equal to zero and not Target.SIZE_ORIGINAL&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>BitmapPool</span> <span class=n>bitmapPool</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>).</span><span class=na>getBitmapPool</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Bitmap</span> <span class=n>toTransform</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>targetWidth</span> <span class=o>=</span> <span class=n>outWidth</span> <span class=o>==</span> <span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span> <span class=o>?</span> <span class=n>toTransform</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>:</span> <span class=n>outWidth</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>targetHeight</span> <span class=o>=</span> <span class=n>outHeight</span> <span class=o>==</span> <span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span> <span class=o>?</span> <span class=n>toTransform</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()</span> <span class=o>:</span> <span class=n>outHeight</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Bitmap</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>transform</span><span class=o>(</span><span class=n>bitmapPool</span><span class=o>,</span> <span class=n>toTransform</span><span class=o>,</span> <span class=n>targetWidth</span><span class=o>,</span> <span class=n>targetHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>toTransform</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>transformed</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>BitmapResource</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>transformed</span><span class=o>,</span> <span class=n>bitmapPool</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kd>abstract</span> <span class=n>Bitmap</span> <span class=nf>transform</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>toTransform</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆåš sanity checkï¼Œç„¶åè·å– targetWidthã€targetHeightã€‚å¦‚æœæŒ‡å®šäº† override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)ï¼Œè¿™é‡Œä¼šæ˜¯å›¾ç‰‡çš„çœŸå®å°ºå¯¸ï¼Œå¦åˆ™å°±æ˜¯ Target çš„å°ºå¯¸äº†ã€‚</p><p>ç„¶åè°ƒç”¨æŠ½è±¡æ–¹æ³•è¿›è¡Œ transform æ“ä½œï¼Œå¹¶è¿”å› transform åçš„ç»“æœã€‚æ˜¾ç„¶ï¼Œtransform æŠ½è±¡æ–¹æ³•å°±æ˜¯å­ç±»éœ€è¦å®ç°çš„äº†ï¼Œæ‰€ä»¥çœ‹çœ‹ FitCenter çš„æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>FitCenter</span> <span class=kd>extends</span> <span class=n>BitmapTransformation</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ID</span> <span class=o>=</span> <span class=s>&#34;com.bumptech.glide.load.resource.bitmap.FitCenter&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>ID_BYTES</span> <span class=o>=</span> <span class=n>ID</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(</span><span class=n>CHARSET</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Bitmap</span> <span class=nf>transform</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>toTransform</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>TransformationUtils</span><span class=o>.</span><span class=na>fitCenter</span><span class=o>(</span><span class=n>pool</span><span class=o>,</span> <span class=n>toTransform</span><span class=o>,</span> <span class=n>outWidth</span><span class=o>,</span> <span class=n>outHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>o</span> <span class=k>instanceof</span> <span class=n>FitCenter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ID</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateDiskCacheKey</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>messageDigest</span><span class=o>.</span><span class=na>update</span><span class=o>(</span><span class=n>ID_BYTES</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ° FitCenter.transform æ–¹æ³•ç›´æ¥è°ƒç”¨äº† TransformationUtils çš„ fitCenter æ–¹æ³•ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹ equalsã€hashCodeã€updateDiskCacheKey æ–¹æ³•ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•è¦é‡å†™çš„åŸå› æ˜¯å› ä¸º transform ä¼šä½œä¸º key çš„ç»„æˆéƒ¨åˆ†ï¼Œå‚ä¸åˆ° key çš„æ¯”è¾ƒã€ç¼“å­˜è¯»å†™æ—¶ safeKey ç”Ÿæˆï¼Œå…·ä½“å†…å®¹å¯ä»¥å‚è€ƒä¹‹å‰åˆ†æçš„æ–‡ç« ã€‚</p><p>è‡³äº TransformationUtils ç±»ï¼Œè¯¥ç±»é‡Œé¢æœ‰å¾ˆå¤šå¤„ç†å›¾ç‰‡çš„é™æ€æ–¹æ³•ï¼Œå†…ç½®çš„å‡ ç§ BitmapTransformation éƒ½æ˜¯è°ƒç”¨è¯¥å·¥å…·ç±»é‡Œé¢å¯¹åº”çš„æ–¹æ³•æ¥å®Œæˆ transform åŠŸèƒ½çš„ã€‚è¿™é‡Œåªçœ‹ fitCenter æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Bitmap</span> <span class=nf>fitCenter</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>inBitmap</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>==</span> <span class=n>width</span> <span class=o>&amp;&amp;</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()</span> <span class=o>==</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;requested target size matches input, returning input&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inBitmap</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=kt>float</span> <span class=n>widthPercentage</span> <span class=o>=</span> <span class=n>width</span> <span class=o>/</span> <span class=o>(</span><span class=kt>float</span><span class=o>)</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=kt>float</span> <span class=n>heightPercentage</span> <span class=o>=</span> <span class=n>height</span> <span class=o>/</span> <span class=o>(</span><span class=kt>float</span><span class=o>)</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=kt>float</span> <span class=n>minPercentage</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>widthPercentage</span><span class=o>,</span> <span class=n>heightPercentage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Round here in case we&#39;ve decoded exactly the image we want, but take the floor below to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// avoid a line of garbage or blank pixels in images.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>targetWidth</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>round</span><span class=o>(</span><span class=n>minPercentage</span> <span class=o>*</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>targetHeight</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>round</span><span class=o>(</span><span class=n>minPercentage</span> <span class=o>*</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>==</span> <span class=n>targetWidth</span> <span class=o>&amp;&amp;</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()</span> <span class=o>==</span> <span class=n>targetHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;adjusted target size matches input, returning input&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inBitmap</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Take the floor of the target width/height, not round. If the matrix
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// passed into drawBitmap rounds differently, we want to slightly
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// overdraw, not underdraw, to avoid artifacts from bitmap reuse.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>targetWidth</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>minPercentage</span> <span class=o>*</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>targetHeight</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>minPercentage</span> <span class=o>*</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Bitmap</span><span class=o>.</span><span class=na>Config</span> <span class=n>config</span> <span class=o>=</span> <span class=n>getNonNullConfig</span><span class=o>(</span><span class=n>inBitmap</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Bitmap</span> <span class=n>toReuse</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>targetWidth</span><span class=o>,</span> <span class=n>targetHeight</span><span class=o>,</span> <span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// We don&#39;t add or remove alpha, so keep the alpha setting of the Bitmap we were given.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>TransformationUtils</span><span class=o>.</span><span class=na>setAlpha</span><span class=o>(</span><span class=n>inBitmap</span><span class=o>,</span> <span class=n>toReuse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;request: &#34;</span> <span class=o>+</span> <span class=n>width</span> <span class=o>+</span> <span class=s>&#34;x&#34;</span> <span class=o>+</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;toFit:   &#34;</span> <span class=o>+</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;x&#34;</span> <span class=o>+</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;toReuse: &#34;</span> <span class=o>+</span> <span class=n>toReuse</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;x&#34;</span> <span class=o>+</span> <span class=n>toReuse</span><span class=o>.</span><span class=na>getHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;minPct:   &#34;</span> <span class=o>+</span> <span class=n>minPercentage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Matrix</span> <span class=n>matrix</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Matrix</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>minPercentage</span><span class=o>,</span> <span class=n>minPercentage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>applyMatrix</span><span class=o>(</span><span class=n>inBitmap</span><span class=o>,</span> <span class=n>toReuse</span><span class=o>,</span> <span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>toReuse</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¯¥æ–¹æ³•æœ€å¼€å§‹ä¼šæ£€æŸ¥å°ºå¯¸æ˜¯å¦éœ€è¦è¿›è¡Œç¼©æ”¾ï¼Œå¯¹äº override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)ï¼ˆä¾‹ 3ï¼‰æ¥è¯´ï¼Œæ˜¾ç„¶æ˜¯ä¸éœ€è¦çš„ï¼Œæ‰€ä»¥å°±ç›´æ¥è¿”å›äº†ã€‚</p><p>å¦åˆ™ï¼Œå¯¹äºä¾‹ 1 æ¥è¯´ï¼Œéœ€è¦ç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç æ˜¾ç¤ºåˆé€‚çš„å›¾ç‰‡ã€‚ç”±äº Bitmap çš„å®½é«˜åœ¨ encode è¿‡ç¨‹ä¸­è®¡ç®—å‡ºæ¥äº†ï¼Œä¸º 1776x849ï¼Œè€Œä¼ å…¥çš„ widthã€height ä¸º 1776ï¼Œæ˜¾ç„¶ minPercentage ä¼šå– widthPercentageï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šæŒ‰ç…§å±å¹•çš„å®½åº¦è¿›è¡Œç¼©æ”¾ã€‚ä½† widthPercentage ä¸º 1ï¼Œæ‰€ä»¥å¯¼è‡´ç¬¬ 18 è¡Œçš„åˆ¤æ–­æ¡ä»¶ä¸º trueï¼Œå› æ­¤ç›´æ¥è¿”å›äº†å›¾ç‰‡ã€‚</p><p>åé¢å°±æ˜¯çº¯ç²¹çš„å±•ç¤ºé—®é¢˜äº†ï¼Œåœ¨ DrawableImageViewTarget.setResource æ–¹æ³•ä¸­ä¼šå°†ä¸Šé¢çš„å›¾ç‰‡è®¾ç½®åˆ° ImageView ä¸­ï¼Œæ­¤æ—¶ ImageView å®½é«˜éƒ½æ˜¯ 0ï¼Œresource çš„å®½é«˜ä¸º 1776x849ã€‚ä¸‹é¢æ€ä¹ˆæ˜¾ç¤ºå°±æ˜¯ ImageView å†³ å®šçš„äº†ã€‚</p><p>ä¸‹é¢å¯¹å››ä¸ªä¾‹å­åšä¸€ä¸ªå°ç»“ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031849.png width=auto alt></p><p>å„ä¾‹å­ä¹‹æ‰€ä»¥è¡¨ç°å„ä¸ä¸€æ ·ï¼Œå…¶åŸå› å°±åœ¨äº decode å‡ºæ¥çš„å›¾ç‰‡çš„å°ºå¯¸ä¸ä¸€è‡´ï¼Œè€Œä½¿ç”¨ wrap_content å®½é«˜çš„ ImageView åŠ è½½è¿™äº›å›¾ç‰‡ï¼Œå°±ä¼šé€ æˆè¿™äº›æ•ˆæœã€‚</p><a href=#glide-è‡ªå¸¦çš„-transformation><h2 id=glide-è‡ªå¸¦çš„-transformation><span class=hanchor arialabel=Anchor># </span>Glide è‡ªå¸¦çš„ Transformation</h2></a><p>åœ¨ä¸Šä¸€èŠ‚é‡åˆ°çš„ FitCenterã€CenterOutside è¿™ä¸¤ä¸ª BitmapTransformation éƒ½æ˜¯ Glide è‡ªå¸¦çš„ï¼Œé™¤äº†è¿™ä¸¤ä¸ªå¤–è¿˜æœ‰å…¶ä»–å››ä¸ªè‡ªå¸¦çš„ã€‚è¿™äº› BitmapTransformation çš„åç§°å’Œä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li>CenterInsideï¼šå¦‚æœå›¾ç‰‡çš„å°ºå°äºç­‰äº targetï¼Œå›¾ç‰‡ä¿æŒä¸å˜ï¼›å¦åˆ™ä¼šè°ƒç”¨ fitCenterã€‚</li><li>FitCenterï¼šç­‰æ¯”ç¼©æ”¾ï¼Œä½¿å¾—å›¾ç‰‡çš„ä¸€æ¡è¾¹å’Œ target ç›¸åŒï¼Œå¦å¤–ä¸€è¾¹å°äºç»™å®šçš„ targetã€‚</li><li>CenterCropï¼šé¦–å…ˆç¼©æ”¾å›¾ç‰‡ï¼Œä½¿å›¾ç‰‡çš„å®½å’Œç»™å®šçš„å®½ç›¸ç­‰ï¼Œä¸”å›¾ç‰‡çš„é«˜å¤§äºç»™å®šçš„é«˜ã€‚æˆ–è€…é«˜ç›¸ç­‰ï¼Œå›¾ç‰‡çš„å®½å¤§äºç»™å®šçš„å®½ã€‚ç„¶å cropï¼Œä½¿è¾ƒå¤§çš„ä¸€è¾¹çš„åƒç´ å’Œç»™å®šçš„ç›¸åŒã€‚è¿™ç§ç¼©æ”¾æœ€ç»ˆæ•ˆæœæ˜¾ç„¶ä¸æ˜¯ç­‰æ¯”ç¼©æ”¾ã€‚</li><li>Rotateï¼šæ—‹è½¬ Bitmap</li><li>RoundedCornersï¼šåœ†è§’ï¼Œå•ä½æ˜¯ pixel</li><li>CircleCropï¼šåœ†å½¢</li></ul><p>å‰é¢ä¸‰ä¸ªæˆ‘ä»¬éå¸¸ç†Ÿæ‚‰äº†ï¼Œå’Œ ImageView çš„ ScaleType æœ‰å¯¹åº”å…³ç³»ï¼Œæ‰€ä»¥ä¸‹é¢çš„ç¤ºä¾‹ç”¨æ¥æ¼”ç¤ºä¸€ä¸‹åé¢çš„ä¸‰ä¸ª Transformationã€‚</p><p>å¸ƒå±€æ–‡ä»¶å¾ˆç®€å•ï¼Œä¸€ä¸ªå‚ç…§çš„ ImageView + ä¸‰ä¸ªæ˜¾ç¤ºå¯¹åº”æ•ˆæœçš„ ImageView:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;android.support.constraint.ConstraintLayout</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:app=</span><span class=s>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;android.support.constraint.Guideline</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintGuide_percent=</span><span class=s>&#34;0.5&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:orientation=</span><span class=s>&#34;vertical&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/ivGlide1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;@id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toTopOf=</span><span class=s>&#34;parent&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/ivGlide2&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;@id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toTopOf=</span><span class=s>&#34;parent&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/ivGlide3&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;@id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/ivGlide1&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/ivGlide4&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;@id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/ivGlide2&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;android.support.design.widget.FloatingActionButton</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/fab&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_margin=</span><span class=s>&#34;24dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:src=</span><span class=s>&#34;@drawable/btn_camera&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintBottom_toBottomOf=</span><span class=s>&#34;parent&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/android.support.constraint.ConstraintLayout&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>æºæ–‡ä»¶ä¹Ÿæ¯”è¾ƒç®€å•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=c1>// private const val URL = &#34;http://cn.bing.com/az/hprichbg/rb/Dongdaemun_ZH-CN10736487148_1920x1080.jpg&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>transform</span><span class=p>(</span><span class=n>FitCenter</span><span class=p>(),</span> <span class=n>Rotate</span><span class=p>(</span><span class=m>180</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>transform</span><span class=p>(</span><span class=n>MultiTransformation</span><span class=p>(</span><span class=n>FitCenter</span><span class=p>(),</span> <span class=n>RoundedCorners</span><span class=p>(</span><span class=m>303</span> <span class=n>ushr</span> <span class=m>1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>transform</span><span class=p>(</span><span class=n>CircleCrop</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide4</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Rotateã€RoundedCornersã€CircleCrop æ•ˆæœå›¾å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031855.png width=auto alt></p><p>çœ‹å®Œå›¾åï¼Œè¿™ä¸‰ä¸ª Transformation çš„ç‰¹ç‚¹ä¸€ç›®äº†ç„¶äº†ã€‚æ³¨æ„ä¸Šé¢ç¬¬ 2ã€3 ä¸ªåŠ è½½æ—¶ï¼Œå› ä¸º ImageView é«˜åº¦ä¸º wrap_contentï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Š FitCenterï¼Œä½¿ Bitmap çš„å®½é«˜è¾¾åˆ°æˆ‘ä»¬çš„é¢„æœŸï¼ˆå›¾ç‰‡å®½é«˜ä¸º 1920<em>1080ï¼ŒImageView å®½åº¦ä¸º 540ï¼Œå› æ­¤é«˜åº¦ä¸º (540/1920</em>1080=303.75ï¼Œè½¬ä¸º int åä¸º 303)ï¼‰ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œåœ†è§’æˆ–åœ†å½¢å¤„ç†ã€‚</p><p>Glide ä½¿ç”¨ map ä¿å­˜ transformationï¼Œæ‰€ä»¥è°ƒç”¨å¤šä¸ª transform æ–¹æ³•ï¼Œåªæœ‰æœ€åä¸€ä¸ªæ‰ä¼šç”Ÿæ•ˆã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ä½¿ç”¨å¤šä¸ª transformationï¼Œå¯ä»¥ä½¿ç”¨ MultiTransformation ç±»æˆ–è€… transforms(Transformation<bitmap>&mldr;) ä»¥åŠ transform(Transformation<bitmap>&mldr;) æ–¹æ³•ã€‚</p><a href=#è‡ªå®šä¹‰-bitmaptransformation><h2 id=è‡ªå®šä¹‰-bitmaptransformation><span class=hanchor arialabel=Anchor># </span>è‡ªå®šä¹‰ BitmapTransformation</h2></a><p>å¦‚æœæˆ‘ä»¬æƒ³ transform Bitmapï¼Œç»§æ‰¿ BitmapTransformation æ˜¯æœ€å¥½çš„æ–¹å¼äº†ã€‚BitmapTransformation ä¸ºæˆ‘ä»¬å¤„ç†äº†ä¸€äº›åŸºç¡€çš„ä¸œè¥¿ï¼Œä¾‹å¦‚ï¼Œå¦‚æœ Transformation è¿”å›äº†ä¸€ä¸ªæ–°çš„ Bitmapï¼Œ BitmapTransformation å°†è´Ÿè´£æå–å’Œå›æ”¶åŸå§‹çš„ Bitmapã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>FillSpace</span> <span class=kd>extends</span> <span class=n>BitmapTransformation</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ID</span> <span class=o>=</span> <span class=s>&#34;com.bumptech.glide.transformations.FillSpace&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ID_BYTES</span> <span class=o>=</span> <span class=n>ID</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(</span><span class=n>STRING_CHARSET_NAME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Bitmap</span> <span class=nf>transform</span><span class=o>(</span><span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=n>Bitmap</span> <span class=n>toTransform</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>toTransform</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>==</span> <span class=n>outWidth</span> <span class=o>&amp;&amp;</span> <span class=n>toTransform</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()</span> <span class=o>==</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>toTransform</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Bitmap</span><span class=o>.</span><span class=na>createScaledBitmap</span><span class=o>(</span><span class=n>toTransform</span><span class=o>,</span> <span class=n>outWidth</span><span class=o>,</span> <span class=n>outHeight</span><span class=o>,</span> <span class=cm>/*filter=*/</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>o</span> <span class=k>instanceof</span> <span class=n>FillSpace</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>ID</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateDiskCacheKey</span><span class=o>(</span><span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>UnsupportedEncodingException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>messageDigest</span><span class=o>.</span><span class=na>update</span><span class=o>(</span><span class=n>ID_BYTES</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„ä¾‹å­è™½ç„¶ç®€å•ï¼Œä½†æ˜¯åŒ…å«äº†å¿…é¡»å®ç°çš„æ–¹æ³•ï¼š</p><ol><li>transform æ˜¯è¯¥ç±»å­˜åœ¨çš„æ„ä¹‰ï¼Œä½œç”¨ä¸è¨€è€Œå–»ã€‚</li><li>ç¬¬ä¸€ä¸ªå‚æ•° poolï¼Œè¿™ä¸ªæ˜¯ Glide ä¸­çš„ä¸€ä¸ª Bitmap ç¼“å­˜æ± ï¼Œç”¨äºå¯¹ Bitmap å¯¹è±¡è¿›è¡Œé‡ç”¨ï¼Œå¦åˆ™æ¯æ¬¡å›¾ç‰‡å˜æ¢éƒ½é‡æ–°åˆ›å»º Bitmap å¯¹è±¡å°†ä¼šéå¸¸æ¶ˆè€—å†…å­˜ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•° toTransformï¼Œè¿™ä¸ªæ˜¯åŸå§‹å›¾ç‰‡çš„ Bitmap å¯¹è±¡ï¼Œæˆ‘ä»¬å°±æ˜¯è¦å¯¹å®ƒæ¥è¿›è¡Œå›¾ç‰‡å˜æ¢ã€‚</li><li>ç¬¬ä¸‰å’Œç¬¬å››ä¸ªå‚æ•°æ¯”è¾ƒç®€å•ï¼Œåˆ†åˆ«ä»£è¡¨å›¾ç‰‡å˜æ¢åçš„å®½åº¦å’Œé«˜åº¦ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ override() æ–¹æ³•ä¸­ä¼ å…¥çš„å®½å’Œé«˜çš„å€¼äº†ã€‚</li><li>equalsã€hashCodeã€updateDiskCacheKey ä¸‰ä¸ªæ–¹æ³•å¿…é¡»å®ç°ï¼Œå› ä¸ºç£ç›˜ç¼“å­˜å’Œå†…å­˜ç¼“å­˜éƒ½éœ€è¦è¿™ä¸ªã€‚è¯¦æƒ…å¯ä»¥çœ‹ä¹‹å‰çš„åˆ†ææ–‡ç« ã€‚</li></ol><p>æ­¤å¤–ï¼Œå¦‚æœè‡ªå®šä¹‰çš„ BitmapTransformation æœ‰æ„é€ å‚æ•°ï¼Œé‚£ä¹ˆ equalsã€hashCodeã€updateDiskCacheKey ä¸‰ä¸ªæ–¹æ³•ä¹Ÿéœ€è¦å¯¹æ„é€ å‚æ•°åšå¤„ç†ã€‚æ¯”å¦‚ RoundedCornersï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>RoundedCorners</span> <span class=kd>extends</span> <span class=n>BitmapTransformation</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ID</span> <span class=o>=</span> <span class=s>&#34;com.bumptech.glide.load.resource.bitmap.RoundedCorners&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>ID_BYTES</span> <span class=o>=</span> <span class=n>ID</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(</span><span class=n>CHARSET</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>roundingRadius</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * @param roundingRadius the corner radius (in device-specific pixels).
</span></span></span><span class=line><span class=cl><span class=cm>   * @throws IllegalArgumentException if rounding radius is 0 or less.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>RoundedCorners</span><span class=o>(</span><span class=kt>int</span> <span class=n>roundingRadius</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkArgument</span><span class=o>(</span><span class=n>roundingRadius</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>,</span> <span class=s>&#34;roundingRadius must be greater than 0.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>roundingRadius</span> <span class=o>=</span> <span class=n>roundingRadius</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Bitmap</span> <span class=nf>transform</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>toTransform</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>TransformationUtils</span><span class=o>.</span><span class=na>roundedCorners</span><span class=o>(</span><span class=n>pool</span><span class=o>,</span> <span class=n>toTransform</span><span class=o>,</span> <span class=n>roundingRadius</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>o</span> <span class=k>instanceof</span> <span class=n>RoundedCorners</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>RoundedCorners</span> <span class=n>other</span> <span class=o>=</span> <span class=o>(</span><span class=n>RoundedCorners</span><span class=o>)</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>roundingRadius</span> <span class=o>==</span> <span class=n>other</span><span class=o>.</span><span class=na>roundingRadius</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Util</span><span class=o>.</span><span class=na>hashCode</span><span class=o>(</span><span class=n>ID</span><span class=o>.</span><span class=na>hashCode</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>Util</span><span class=o>.</span><span class=na>hashCode</span><span class=o>(</span><span class=n>roundingRadius</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateDiskCacheKey</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>messageDigest</span><span class=o>.</span><span class=na>update</span><span class=o>(</span><span class=n>ID_BYTES</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>byte</span><span class=o>[]</span> <span class=n>radiusData</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>4</span><span class=o>).</span><span class=na>putInt</span><span class=o>(</span><span class=n>roundingRadius</span><span class=o>).</span><span class=na>array</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>messageDigest</span><span class=o>.</span><span class=na>update</span><span class=o>(</span><span class=n>radiusData</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#appglidemodule><h1 id=appglidemodule><span class=hanchor arialabel=Anchor># </span>AppGlideModule</h1></a><p>Glide ä¹‹æ‰€ä»¥å¼ºå¤§ï¼Œå¦å¤–ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½å°±æ˜¯å¯ä»¥è‡ªå®šä¹‰æ¨¡å—ï¼Œè‡ªå®šä¹‰æ¨¡å—åŠŸèƒ½å¯ä»¥å°†æ›´æ”¹ Glide é…ç½®ï¼Œæ›¿æ¢ Glide ç»„ä»¶ç­‰æ“ä½œç‹¬ç«‹å‡ºæ¥ï¼Œä½¿å¾—æˆ‘ä»¬èƒ½è½»æ¾åœ°å¯¹ Glide çš„å„ç§é…ç½®è¿›è¡Œè‡ªå®šä¹‰ï¼Œå¹¶ä¸”åˆå’Œ Glide çš„å›¾ç‰‡åŠ è½½é€»è¾‘æ²¡æœ‰ä»»ä½•äº¤é›†ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§ä½è€¦åˆç¼–ç¨‹æ–¹å¼çš„ä½“ç°ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ›´æ”¹ Glide é»˜è®¤é…ç½®åº”è¯¥å…³æ³¨æ˜¯å¦ä¼šé€ æˆæ€§èƒ½å€’é€€ã€‚</p><a href=#ä½¿ç”¨><h2 id=ä½¿ç”¨><span class=hanchor arialabel=Anchor># </span>ä½¿ç”¨</h2></a><p>é¦–å…ˆï¼Œä½¿ç”¨ kapt å°† compiler å¼•å…¥åˆ°é¡¹ç›®ä¸­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>apply</span> <span class=nl>plugin:</span> <span class=s1>&#39;kotlin-kapt&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>implementation</span> <span class=s1>&#39;com.github.bumptech.glide:glide:4.12.0&#39;</span>
</span></span><span class=line><span class=cl>  <span class=n>kapt</span> <span class=s1>&#39;com.github.bumptech.glide:compiler:4.12.0&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¹¶ä¸”åœ¨ä½ çš„ <code>proguard.cfg</code> ä¸­ keep ä½ä½ çš„ AppGlideModule å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>-keep public class  extends com.bumptech.glide.module.AppGlideModule
</span></span><span class=line><span class=cl>-keep class com.bumptech.glide.GeneratedAppGlideModuleImpl
</span></span></code></pre></td></tr></table></div></div><p>æ¥ç€ï¼Œæ–°å»ºä¸€ä¸ªç±»ç»§æ‰¿è‡ª AppGlideModuleï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>isManifestParsingEnabled</span><span class=p>()</span> <span class=p>=</span> <span class=k>super</span><span class=p>.</span><span class=n>isManifestParsingEnabled</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸€å…±æœ‰ä¸‰ä¸ªæ–¹æ³•å¯ä»¥è¿›è¡Œé‡å†™ï¼Œå®ƒä»¬åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆå‘¢ï¼Ÿ</p><a href=#applyoptions><h3 id=applyoptions><span class=hanchor arialabel=Anchor># </span>applyOptions</h3></a><p>applyOptions æ–¹æ³•ä¸»è¦ç”¨äºæ›´æ”¹ Glide é»˜è®¤é…ç½®ï¼Œæ¯”å¦‚ä¿®æ”¹ç¡¬ç›˜ç¼“å­˜è·¯å¾„ã€è®¾ç½® Bitmap çš„è§£ç æ ¼å¼ã€è®¾ç½® LRUCahce å¤§å°ç”šè‡³ä½¿ç”¨è‡ªå®šä¹‰ LRUCahce å®ç°æˆ–è€…è‡ªå®šä¹‰ç£ç›˜ç¼“å­˜å®ç°ç­‰ã€‚ä¸‹é¢å°†ç½—åˆ—ä¸€äº›å¸¸ç”¨çš„é…ç½®é€‰é¡¹ã€‚</p><a href=#strongå†…å­˜ç¼“å­˜memorycachestrong><h4 id=strongå†…å­˜ç¼“å­˜memorycachestrong><span class=hanchor arialabel=Anchor># </span><strong>å†…å­˜ç¼“å­˜ï¼ˆMemoryCacheï¼‰</strong></h4></a><p>Glide ä½¿ç”¨ LruResourceCache ä½œä¸º MemoryCache æ¥å£çš„ä¸€ä¸ªé»˜è®¤å®ç°ï¼Œä½¿ç”¨å›ºå®šå¤§å°çš„å†…å­˜å’Œ LRU ç®—æ³•ã€‚LruResourceCache çš„å¤§å°ç”± Glide çš„ MemorySizeCalculator ç±»æ¥å†³å®šï¼Œè¿™ä¸ªç±»ä¸»è¦å…³æ³¨è®¾å¤‡çš„å†…å­˜ç±»å‹ï¼Œè®¾å¤‡ RAM å¤§å°ï¼Œä»¥åŠå±å¹•åˆ†è¾¨ç‡ã€‚</p><p>ä½¿ç”¨ applyOptions(Context, GlideBuilder) æ–¹æ³•é…ç½® MemorySizeCalculator å¯ä»¥è‡ªå®šä¹‰ MemoryCache çš„å¤§å°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>calculator</span> <span class=p>=</span> <span class=n>MemorySizeCalculator</span><span class=p>.</span><span class=n>Builder</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>setMemoryCacheScreens</span><span class=p>(</span><span class=m>2f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setMemoryCache</span><span class=p>(</span><span class=n>LruResourceCache</span><span class=p>(</span><span class=n>calculator</span><span class=p>.</span><span class=n>memoryCacheSize</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¹Ÿå¯ä»¥ç›´æ¥è¦†å†™ç¼“å­˜å¤§å°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>memoryCacheSizeBytes</span> <span class=p>=</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>20</span> <span class=c1>// 20mb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>setMemoryCache</span><span class=p>(</span><span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memoryCacheSizeBytes</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç”šè‡³å¯ä»¥æä¾›è‡ªå·±çš„ MemoryCache å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>override</span> <span class=n>fun</span> <span class=n>applyOptions</span><span class=o>(</span><span class=n>context</span><span class=k>:</span> <span class=kt>Context</span><span class=o>,</span> <span class=n>builder</span><span class=k>:</span> <span class=kt>GlideBuilder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=n>setMemoryCache</span><span class=o>(</span><span class=nc>YourAppMemoryCacheImpl</span><span class=o>())</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strongbitmappoolstrong><h4 id=strongbitmappoolstrong><span class=hanchor arialabel=Anchor># </span><strong>BitmapPool</strong></h4></a><p>Glide ä½¿ç”¨ LruBitmapPool ä½œä¸ºé»˜è®¤çš„ BitmapPool ã€‚LruBitmapPool æ˜¯ä¸€ä¸ªå†…å­˜ä¸­çš„å›ºå®šå¤§å°çš„ BitmapPoolï¼Œä½¿ç”¨ LRU ç®—æ³•æ¸…ç†ã€‚é»˜è®¤å¤§å°åŸºäºè®¾å¤‡çš„åˆ†è¾¨ç‡å’Œå¯†åº¦ï¼ŒåŒæ—¶ä¹Ÿè€ƒè™‘å†…å­˜ç±»å’Œ isLowRamDevice çš„è¿”å›å€¼ã€‚å…·ä½“çš„è®¡ç®—é€šè¿‡ Glide çš„ MemorySizeCalculator æ¥å®Œæˆï¼Œä¸ Glide çš„ MemoryCache çš„å¤§å°æ£€æµ‹æ–¹æ³•ç›¸ä¼¼ã€‚</p><p>å¯ä»¥åœ¨ AppGlideModule ä¸­å®šåˆ¶ BitmapPool çš„å°ºå¯¸ï¼Œä½¿ç”¨ applyOptions(Context, GlideBuilder) æ–¹æ³•å¹¶é…ç½® MemorySizeCalculator:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>calculator</span> <span class=p>=</span> <span class=n>MemorySizeCalculator</span><span class=p>.</span><span class=n>Builder</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>setBitmapPoolScreens</span><span class=p>(</span><span class=m>3f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setBitmapPool</span><span class=p>(</span><span class=n>LruBitmapPool</span><span class=p>(</span><span class=n>calculator</span><span class=p>.</span><span class=n>bitmapPoolSize</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¹Ÿå¯ä»¥ç›´æ¥å¤å†™è¿™ä¸ªæ± çš„å¤§å°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>bitmapPoolSizeBytes</span> <span class=p>=</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>30</span> <span class=c1>// 30mb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>setBitmapPool</span><span class=p>(</span><span class=n>LruBitmapPool</span><span class=p>(</span><span class=n>bitmapPoolSizeBytes</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“ç„¶ä¹Ÿå¯ä»¥æä¾› BitmapPool çš„å®Œå…¨è‡ªå®šä¹‰å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>override</span> <span class=n>fun</span> <span class=n>applyOptions</span><span class=o>(</span><span class=n>context</span><span class=k>:</span> <span class=kt>Context</span><span class=o>,</span> <span class=n>builder</span><span class=k>:</span> <span class=kt>GlideBuilder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=n>setBitmapPool</span><span class=o>(</span><span class=nc>YourAppBitmapPoolImpl</span><span class=o>())</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strongç£ç›˜ç¼“å­˜diskcachestrong><h4 id=strongç£ç›˜ç¼“å­˜diskcachestrong><span class=hanchor arialabel=Anchor># </span><strong>ç£ç›˜ç¼“å­˜ï¼ˆDiskCacheï¼‰</strong></h4></a><p>Glide ä½¿ç”¨ DiskLruCacheWrapper ä½œä¸ºé»˜è®¤çš„ ç£ç›˜ç¼“å­˜ ã€‚ DiskLruCacheWrapper æ˜¯ä¸€ä¸ªä½¿ç”¨ LRU ç®—æ³•çš„å›ºå®šå¤§å°çš„ç£ç›˜ç¼“å­˜ã€‚é»˜è®¤ç£ç›˜å¤§å°ä¸º 250 MB ï¼Œä½ç½®æ˜¯åœ¨åº”ç”¨çš„ç¼“å­˜æ–‡ä»¶å¤¹ä¸­çš„ä¸€ä¸ªç‰¹å®šç›®å½•ï¼ˆ<em>/data/data/{package}/cache/image_manager_disk_cache/</em>ï¼‰ ã€‚</p><p>å‡å¦‚ä½¿ç”¨ Glide å±•ç¤ºå›¾ç‰‡å†…å®¹æ˜¯å…¬å¼€çš„ï¼Œé‚£ä¹ˆåº”ç”¨å¯ä»¥å°†è¿™ä¸ªç¼“å­˜ä½ç½®æ”¹åˆ°å¤–éƒ¨å­˜å‚¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ— è®ºä½¿ç”¨å†…éƒ¨æˆ–å¤–éƒ¨ç£ç›˜ç¼“å­˜ï¼Œåº”ç”¨ç¨‹åºéƒ½å¯ä»¥æ”¹å˜ç£ç›˜ç¼“å­˜çš„å¤§å°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>diskCacheSizeBytes</span> <span class=p>=</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>100</span><span class=p>;</span>  <span class=c1>//100 MB
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=n>diskCacheSizeBytes</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿˜å¯ä»¥è‡ªå·±å‘½åå¤–å­˜æˆ–å†…å­˜ä¸Šçš„ç¼“å­˜æ–‡ä»¶å¤¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>diskCacheSizeBytes</span> <span class=p>=</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>100</span><span class=p>;</span>  <span class=c1>//100 MB
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>cacheFolderName</span><span class=p>,</span> <span class=n>diskCacheSizeBytes</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰ DiskCache æ¥å£çš„å®ç°ï¼Œå¹¶æä¾›è‡ªå·±çš„ DiskCache.Factory æ¥åˆ›å»ºç¼“å­˜ã€‚Glide ä½¿ç”¨ä¸€ä¸ªå·¥å‚æ¥å£æ¥åœ¨åå°çº¿ç¨‹ä¸­æ‰“å¼€ç£ç›˜ç¼“å­˜ ï¼Œè¿™æ ·æ–¹ä¾¿ç¼“å­˜åšè¯¸å¦‚æ£€æŸ¥è·¯å¾„å­˜åœ¨æ€§ç­‰çš„ IO æ“ä½œè€Œä¸ç”¨è§¦å‘ä¸¥æ ¼æ¨¡å¼ï¼ˆStrictModeï¼‰ ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>DiskCache</span><span class=p>.</span><span class=n>Factory</span> <span class=p>{</span> <span class=n>YourAppCustomDiskCache</span><span class=p>()</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strongé»˜è®¤è¯·æ±‚é€‰é¡¹defaultrequestoptionsstrong><h4 id=strongé»˜è®¤è¯·æ±‚é€‰é¡¹defaultrequestoptionsstrong><span class=hanchor arialabel=Anchor># </span><strong>é»˜è®¤è¯·æ±‚é€‰é¡¹ï¼ˆDefaultRequestOptionsï¼‰</strong></h4></a><p>è™½ç„¶ RequestOptions<strong> </strong>é€šå¸¸ç”±æ¯ä¸ªè¯·æ±‚å•ç‹¬æŒ‡å®šï¼Œä¹Ÿå¯ä»¥é€šè¿‡ AppGlideModule åº”ç”¨ä¸€ä¸ª RequestOptions çš„é›†åˆä»¥ä½œç”¨äºæ¯æ¬¡è¯·æ±‚ï¼Œæ¯”å¦‚è®¾ç½® Bitmap çš„è§£ç æ ¼å¼ä¸º RGB_565 (é»˜è®¤ä¸º ARGB_8888)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setDefaultRequestOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>RequestOptions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>format</span><span class=p>(</span><span class=n>DecodeFormat</span><span class=p>.</span><span class=n>PREFER_RGB_565</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>disallowHardwareConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸€æ—¦åˆ›å»ºäº†æ–°çš„è¯·æ±‚ï¼Œè¿™äº›é€‰é¡¹å°†é€šè¿‡ GlideBuilder ä¸­çš„ setDefaultRequestOptions è¢«åº”ç”¨ä¸Šã€‚å› æ­¤ï¼Œä»»ä½•å•ç‹¬è¯·æ±‚é‡Œåº”ç”¨çš„é€‰é¡¹å°†è¦†ç›– GlideBuilder é‡Œè®¾ç½®çš„å†²çªé€‰é¡¹ã€‚</p><p>ç±»ä¼¼åœ°ï¼ŒRequestManagers å…è®¸ä½ ä¸ºè¿™ä¸ªç‰¹å®šçš„ RequestManager å¯åŠ¨çš„æ‰€æœ‰åŠ è½½è¯·æ±‚è®¾ç½®é»˜è®¤çš„ RequestOptionsã€‚ å› ä¸ºæ¯ä¸ª Activity å’Œ Fragment éƒ½æ‹¥æœ‰è‡ªå·±çš„ RequestManagerï¼Œä½ å¯ä»¥ä½¿ç”¨ RequestManager çš„ applyDefaultRequestOptions æ–¹æ³•æ¥è®¾ç½®é»˜è®¤çš„ RequestOptionï¼Œå¹¶ä»…ä½œç”¨äºä¸€ä¸ªç‰¹å®šçš„ Activity æˆ– Fragmentï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=n>fragment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>applyDefaultRequestOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>RequestOptions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>format</span><span class=p>(</span><span class=n>DecodeFormat</span><span class=p>.</span><span class=n>PREFER_RGB_565</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>disallowHardwareConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>RequestManager è¿˜æœ‰ä¸€ä¸ª setDefaultRequestOptions æ–¹æ³•ï¼Œå¯ä»¥å®Œå…¨æ›¿æ¢æ‰ä¹‹å‰è®¾ç½®çš„ä»»æ„çš„é»˜è®¤ RequestOptionsï¼Œæ— è®ºå®ƒæ˜¯é€šè¿‡ AppGlideModule çš„ [GlideBuilder] è¿˜æ˜¯ RequestManagerã€‚ä½¿ç”¨ [setDefaultRequestOptions] è¦å°å¿ƒï¼Œå› ä¸ºå¾ˆå®¹æ˜“æ„å¤–è¦†ç›–æ‰å…¶ä»–åœ°æ–¹è®¾ç½®çš„é‡è¦é»˜è®¤é€‰é¡¹ã€‚ é€šå¸¸ applyDefaultRequestOptions æ›´å®‰å…¨ï¼Œä½¿ç”¨èµ·æ¥æ›´ç›´è§‚ã€‚</p><a href=#strongæœªæ•è·å¼‚å¸¸ç­–ç•¥-uncaughtthrowablestrategystrong><h4 id=strongæœªæ•è·å¼‚å¸¸ç­–ç•¥-uncaughtthrowablestrategystrong><span class=hanchor arialabel=Anchor># </span><strong>æœªæ•è·å¼‚å¸¸ç­–ç•¥ (UncaughtThrowableStrategy)</strong></h4></a><p>åœ¨åŠ è½½å›¾ç‰‡æ—¶å‡å¦‚å‘ç”Ÿäº†ä¸€ä¸ªå¼‚å¸¸ (ä¾‹å¦‚, OOM), Glide å°†ä¼šä½¿ç”¨ä¸€ä¸ª GlideExecutor.UncaughtThrowableStrategy ã€‚</p><p>é»˜è®¤ç­–ç•¥æ˜¯å°†å¼‚å¸¸æ‰“å°åˆ°è®¾å¤‡çš„ LogCat ä¸­ã€‚ è¿™ä¸ªç­–ç•¥ä» Glide 4.2.0 èµ·å°†å¯è¢«å®šåˆ¶ã€‚ ä½ å¯ä»¥ä¼ å…¥ä¸€ä¸ª DiskCacheExecutor å’Œ / æˆ–ä¸€ä¸ª SourceExecutorï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>myUncaughtThrowableStrategy</span> <span class=p>=</span> <span class=n>UncaughtThrowableStrategy</span><span class=p>.</span><span class=n>LOG</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCacheExecutor</span><span class=p>(</span><span class=n>GlideExecutor</span><span class=p>.</span><span class=n>newDiskCacheBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>setUncaughtThrowableStrategy</span> <span class=p>{</span> <span class=n>myUncaughtThrowableStrategy</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setSourceExecutor</span><span class=p>(</span><span class=n>GlideExecutor</span><span class=p>.</span><span class=n>newSourceBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>setUncaughtThrowableStrategy</span> <span class=p>{</span> <span class=n>myUncaughtThrowableStrategy</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strongæ—¥å¿—çº§åˆ«loglevel-strong><h4 id=strongæ—¥å¿—çº§åˆ«loglevel-strong><span class=hanchor arialabel=Anchor># </span><strong>æ—¥å¿—çº§åˆ«ï¼ˆLogLevel ï¼‰</strong></h4></a><p>å¯ä»¥ä½¿ç”¨ setLogLevel (ç»“åˆ Android çš„ Log å®šä¹‰çš„å€¼) æ¥è·å–æ ¼å¼åŒ–æ—¥å¿—çš„å­é›†ï¼ŒåŒ…æ‹¬è¯·æ±‚å¤±è´¥æ—¶çš„æ—¥å¿—è¡Œã€‚é€šå¸¸æ¥è¯´ Log.VERBOSE ç²’åº¦å¤ªç»†ï¼Œè€Œ Log.ERROR åˆä¼šè®©æ—¥å¿—æ›´è¶‹å‘é™é»˜ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setLogLevel</span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ‰€æœ‰çš„é…ç½®é€‰é¡¹å¦‚ä¸‹</p><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>setBitmapPool</td><td></td></tr><tr><td>setArrayPool</td><td></td></tr><tr><td>setMemoryCache</td><td></td></tr><tr><td>setDiskCache</td><td></td></tr><tr><td>setResizeExecutor</td><td></td></tr><tr><td>setSourceExecutor</td><td></td></tr><tr><td>setDiskCacheExecutor</td><td></td></tr><tr><td>setAnimationExecutor</td><td></td></tr><tr><td>setDefaultRequestOptions</td><td></td></tr><tr><td>setDefaultTransitionOptions</td><td></td></tr><tr><td>setMemorySizeCalculator</td><td></td></tr><tr><td>setConnectivityMonitorFactory</td><td></td></tr><tr><td>setLogLevel</td><td></td></tr><tr><td>setIsActiveResourceRetentionAllowed</td><td></td></tr><tr><td>addGlobalRequestListener</td><td></td></tr><tr><td>setLogRequestOrigins</td><td></td></tr><tr><td>setImageDecoderEnabledForBitmaps</td><td></td></tr></tbody></table><a href=#ismanifestparsingenabled><h3 id=ismanifestparsingenabled><span class=hanchor arialabel=Anchor># </span>isManifestParsingEnabled</h3></a><p>åœ¨ Glide v3 ä¸­ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—éœ€è¦åœ¨ AndroidManifest.xml æ–‡ä»¶ä¸­é€šè¿‡ meta-data è¿›è¡Œé…ç½®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;application</span>
</span></span><span class=line><span class=cl>    <span class=err>...</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;meta-data</span>
</span></span><span class=line><span class=cl>        <span class=na>android:name=</span><span class=s>&#34;xxx.xxx.MyGlideModule&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:value=</span><span class=s>&#34;GlideModule&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;activity</span> <span class=err>...</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/application&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>MyGlideModule ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyGlideModule</span> <span class=p>:</span> <span class=n>GlideModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸ºäº†ç»´æŒå¯¹ Glide v3 çš„ GlideModules çš„å‘åå…¼å®¹æ€§ï¼ŒGlide ä»ç„¶ä¼šè§£æåº”ç”¨ç¨‹åºå’Œæ‰€æœ‰è¢«åŒ…å«çš„åº“ä¸­çš„ AndroidManifest.xml æ–‡ä»¶ï¼Œå¹¶åŒ…å«åœ¨è¿™äº›æ¸…å•ä¸­åˆ—å‡ºçš„æ—§ GlideModules æ¨¡å—ç±»ã€‚</p><p>å¦‚æœä½ å·²ç»è¿ç§»åˆ° Glide v4 çš„ AppGlideModule å’Œ LibraryGlideModule ï¼Œä½ å¯ä»¥å®Œå…¨ç¦ç”¨æ¸…å•è§£æã€‚è¿™æ ·å¯ä»¥æ”¹å–„ Glide çš„åˆå§‹å¯åŠ¨æ—¶é—´ï¼Œå¹¶é¿å…å°è¯•è§£æå…ƒæ•°æ®æ—¶çš„ä¸€äº›æ½œåœ¨é—®é¢˜ã€‚è¦ç¦ç”¨æ¸…å•è§£æï¼Œå¯ä»¥åœ¨ AppGlideModule å®ç°ä¸­å¤å†™ isManifestParsingEnabled() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>isManifestParsingEnabled</span><span class=p>()</span> <span class=p>=</span> <span class=k>false</span>
</span></span></code></pre></td></tr></table></div></div><a href=#registercomponents><h3 id=registercomponents><span class=hanchor arialabel=Anchor># </span>registerComponents</h3></a><p>åº”ç”¨ç¨‹åºå’Œåº“éƒ½å¯ä»¥æ³¨å†Œå¾ˆå¤šç»„ä»¶æ¥æ‰©å±• Glide çš„åŠŸèƒ½ã€‚å¯ç”¨çš„ç»„ä»¶åŒ…æ‹¬ï¼š</p><ol><li>ModelLoader, ç”¨äºåŠ è½½è‡ªå®šä¹‰çš„ Model(Url, Uri,ä»»æ„çš„ POJO )å’Œ Data(InputStreams, FileDescriptors)ã€‚</li><li>ResourceDecoder, ç”¨äºå¯¹æ–°çš„ Resources(Drawables, Bitmaps)æˆ–æ–°çš„ Data ç±»å‹(InputStreams, FileDescriptors)è¿›è¡Œè§£ç ã€‚</li><li>Encoder, ç”¨äºå‘ Glide çš„ç£ç›˜ç¼“å­˜å†™ Data (InputStreams, FileDesciptors)ã€‚</li><li>ResourceTranscoderï¼Œç”¨äºåœ¨ä¸åŒçš„èµ„æºç±»å‹ä¹‹é—´åšè½¬æ¢ï¼Œä¾‹å¦‚ï¼Œä» BitmapResource è½¬æ¢ä¸º DrawableResource ã€‚</li><li>ResourceEncoderï¼Œç”¨äºå‘ Glide çš„ç£ç›˜ç¼“å­˜å†™ Resources(BitmapResource, DrawableResource)ã€‚</li></ol><p>ç»„ä»¶é€šè¿‡ Registry ç±»æ¥æ³¨å†Œã€‚ä¾‹å¦‚ï¼Œæ·»åŠ ä¸€ä¸ª ModelLoader ï¼Œä½¿å…¶èƒ½ä»è‡ªå®šä¹‰çš„ Model å¯¹è±¡ä¸­åˆ›å»ºä¸€ä¸ª InputStream ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=n>Photo</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span> <span class=n>Factory</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ä¸€ä¸ª GlideModule é‡Œå¯ä»¥æ³¨å†Œå¾ˆå¤šç»„ä»¶ã€‚ModelLoader å’Œ ResourceDecoder å¯¹äºåŒæ ·çš„å‚æ•°ç±»å‹è¿˜å¯ä»¥æœ‰å¤šç§å®ç°ã€‚</p><p>åœ¨å‰æ–‡çš„åˆ†æä¸­çŸ¥é“äº†ï¼ŒGlide åŠ è½½ç½‘ç»œå›¾ç‰‡é»˜è®¤ä½¿ç”¨çš„æ˜¯ HttpUrlConnectionï¼Œå¦‚æœæƒ³æŠŠè¿™ä¸ªä½ç½®çš„å®ç°æ›¿æ¢æˆ OkHttp3 æˆ–è€… Volley å®ç°å¯ä»¥å—ï¼Ÿæ˜¾ç„¶æ˜¯å¯ä»¥çš„ï¼Œè€Œä¸”å®˜æ–¹ä¹Ÿæä¾›äº†è¿™ä¸ªåŠŸèƒ½ï¼š</p><ul><li><a href=http://bumptech.github.io/glide/int/okhttp3.html rel=noopener>OkHttp3</a></li><li><a href=http://bumptech.github.io/glide/int/volley.html rel=noopener>Volley</a></li></ul><p>ä»¥ OkHttp3 ä¸ºä¾‹ï¼Œç”¨èµ·æ¥å¾ˆç®€å•ï¼Œåªéœ€è¦é›†æˆä¸€ä¸ª library å³å¯ï¼Œéå¸¸ç¬¦åˆ Glide çš„é£æ ¼ã€‚build.gradle çš„é…ç½®å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.github.bumptech.glide:okhttp3-integration:4.12.0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆæ‰¾åˆ°é‡Œé¢çš„ @GlideModule ä¿®é¥°çš„ç±»ï¼Œè€Œä¸”åº”è¯¥æ˜¯ä¸€ä¸ª LibraryGlideModule ç±»ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>final</span> <span class=k>class</span> <span class=nc>OkHttpLibraryGlideModule</span> <span class=k>extends</span> <span class=nc>LibraryGlideModule</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=n>public</span> <span class=n>void</span> <span class=n>registerComponents</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=nc>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=nc>Glide</span> <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=nc>Registry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=n>replace</span><span class=o>(</span><span class=nc>GlideUrl</span><span class=o>.</span><span class=n>class</span><span class=o>,</span> <span class=nc>InputStream</span><span class=o>.</span><span class=n>class</span><span class=o>,</span> <span class=k>new</span> <span class=nc>OkHttpUrlLoader</span><span class=o>.</span><span class=nc>Factory</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ­¤å¤–ï¼Œé‡Œé¢è¿˜å‘ç°äº†ä¸€ä¸ªå®ç°äº† com.bumptech.glide.module.GlideModule æ¥å£çš„åºŸå¼ƒç±» OkHttpGlideModuleï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>OkHttpGlideModule</span> <span class=kd>implements</span> <span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>applyOptions</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Do nothing.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerComponents</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span> <span class=n>Registry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=n>GlideUrl</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=o>.</span><span class=na>Factory</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„ Glide ç‰ˆæœ¬ä¸º 4.xï¼Œä½¿ç”¨äº†ä¸Šé¢çš„ OkHttpLibraryGlideModule å¹¶ä¸”æ— éœ€åœ¨ AndroidManifest.xml ä¸­é…ç½®ï¼Œè‡ªç„¶ä¹Ÿç”¨ä¸åˆ°è¿™ä¸ªç±»ã€‚</p><p>å›åˆ° OkHttpLibraryGlideModule ç±»ä¸­ï¼Œçœ‹çœ‹ registerComponents æ–¹æ³•çš„å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=n>GlideUrl</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>     <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=o>.</span><span class=na>Factory</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯¹äºæ­¤é¡¹ï¼ŒGlide çš„é»˜è®¤é…ç½®ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>GlideUrl</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>HttpGlideUrlLoader</span><span class=o>.</span><span class=na>Factory</span><span class=o>())</span>
</span></span></code></pre></td></tr></table></div></div><p>æ‰€ä»¥å¯ä»¥ç†è§£ä¸ºï¼ŒåŸæœ¬äº¤ç»™ HttpGlideUrlLoader.Factory() å¤„ç†çš„ä»»åŠ¡ä¼šäº¤ç»™ OkHttpUrlLoader.Factory() å¤„ç†ã€‚</p><p><strong>OkHttpUrlLoader</strong> æºç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>OkHttpUrlLoader</span> <span class=kd>implements</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>GlideUrl</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>client</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Public API.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>OkHttpUrlLoader</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>client</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>client</span> <span class=o>=</span> <span class=n>client</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>GlideUrl</span> <span class=n>url</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>LoadData</span><span class=o>&lt;</span><span class=n>InputStream</span><span class=o>&gt;</span> <span class=nf>buildLoadData</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>GlideUrl</span> <span class=n>model</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>LoadData</span><span class=o>&lt;&gt;(</span><span class=n>model</span><span class=o>,</span> <span class=k>new</span> <span class=n>OkHttpStreamFetcher</span><span class=o>(</span><span class=n>client</span><span class=o>,</span> <span class=n>model</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** The default factory for {@link OkHttpUrlLoader}s. */</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Public API.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Factory</span> <span class=kd>implements</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>GlideUrl</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>volatile</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>internalClient</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>client</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=nf>getInternalClient</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>internalClient</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=n>Factory</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=o>(</span><span class=n>internalClient</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>internalClient</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpClient</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>internalClient</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/** Constructor for a new Factory that runs requests using a static singleton client. */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Factory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>(</span><span class=n>getInternalClient</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Constructor for a new Factory that runs requests using given client.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param client this is typically an instance of {@code OkHttpClient}.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Factory</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>client</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>client</span> <span class=o>=</span> <span class=n>client</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>GlideUrl</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=nf>build</span><span class=o>(</span><span class=n>MultiModelLoaderFactory</span> <span class=n>multiFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=o>(</span><span class=n>client</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>teardown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Do nothing, this instance doesn&#39;t own the client.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒOkHttpUrlLoader.Factory çš„æ— å‚æ„é€ å™¨ä¼šä½¿ç”¨ DCL å•ä¾‹æ¨¡å¼åˆ›å»ºä¸€ä¸ª OkHttpClient() å¯¹è±¡ï¼Œå…¶ build æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª new OkHttpUrlLoader(client)ã€‚</p><p>OkHttpUrlLoader.buildLoadData æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª fetcher ä¸º <strong>OkHttpStreamFetcher</strong> çš„ LoadDataã€‚å½“éœ€è¦è¿›è¡ŒåŠ è½½çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ fetcher çš„ loadData æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Request</span><span class=o>.</span><span class=na>Builder</span> <span class=n>requestBuilder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Request</span><span class=o>.</span><span class=na>Builder</span><span class=o>().</span><span class=na>url</span><span class=o>(</span><span class=n>url</span><span class=o>.</span><span class=na>toStringUrl</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headerEntry</span> <span class=o>:</span> <span class=n>url</span><span class=o>.</span><span class=na>getHeaders</span><span class=o>().</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>headerEntry</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>requestBuilder</span><span class=o>.</span><span class=na>addHeader</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>headerEntry</span><span class=o>.</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>requestBuilder</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callback</span> <span class=o>=</span> <span class=n>callback</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>call</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=na>newCall</span><span class=o>(</span><span class=n>request</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFailure</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Call</span> <span class=n>call</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;OkHttp failed to obtain result&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResponse</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Call</span> <span class=n>call</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Response</span> <span class=n>response</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>responseBody</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=na>body</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>response</span><span class=o>.</span><span class=na>isSuccessful</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>contentLength</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>responseBody</span><span class=o>).</span><span class=na>contentLength</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>stream</span> <span class=o>=</span> <span class=n>ContentLengthInputStream</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>responseBody</span><span class=o>.</span><span class=na>byteStream</span><span class=o>(),</span> <span class=n>contentLength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>callback</span><span class=o>.</span><span class=na>onDataReady</span><span class=o>(</span><span class=n>stream</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>callback</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=n>response</span><span class=o>.</span><span class=na>message</span><span class=o>(),</span> <span class=n>response</span><span class=o>.</span><span class=na>code</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>OkHttpStreamFetcher çš„å®ç°æ¯” HttpUrlFetcher ç®€å•å¤šäº†ï¼Œè€Œä¸”çœ‹èµ·æ¥ä¹Ÿæ²¡æœ‰ä»€ä¹ˆéš¾åº¦ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨ App ç°æœ‰çš„ OkHttpClient è€Œä¸æ˜¯é»˜è®¤åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆ @Excludes æ‰ OkHttpLibraryGlideModuleï¼›ç„¶ååœ¨ replace çš„åŒæ—¶ï¼Œåœ¨ OkHttpUrlLoader.Factory(Call.Factory) æ„é€ æ—¶æ³¨å…¥ç°æœ‰çš„ OkHttpClientï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=nd>@Excludes</span><span class=p>(</span><span class=n>value</span> <span class=p>=</span> <span class=p>[</span><span class=n>OkHttpLibraryGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>,</span> <span class=n>MyLibraryGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>,</span> <span class=n>MyGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>okHttpClient</span> <span class=p>=</span> <span class=n>OkHttpClient</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>connectTimeout</span><span class=p>(</span><span class=m>10</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>readTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>writeTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>addNetworkInterceptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>HttpLoggingInterceptor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Log</span><span class=p>.</span><span class=n>i</span><span class=p>(</span><span class=s2>&#34;MyAppGlideModule&#34;</span><span class=p>,</span> <span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}.</span><span class=n>apply</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>level</span> <span class=p>=</span> <span class=n>HttpLoggingInterceptor</span><span class=p>.</span><span class=n>Level</span><span class=p>.</span><span class=n>BODY</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>).</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>registry</span><span class=p>.</span><span class=n>replace</span><span class=p>(</span><span class=n>GlideUrl</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>OkHttpUrlLoader</span><span class=p>.</span><span class=n>Factory</span><span class=p>(</span><span class=n>okHttpClient</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#åŸç†><h2 id=åŸç†><span class=hanchor arialabel=Anchor># </span>åŸç†</h2></a><a href=#glide-åˆå§‹åŒ–æµç¨‹åˆ†æ><h3 id=glide-åˆå§‹åŒ–æµç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>Glide åˆå§‹åŒ–æµç¨‹åˆ†æ</h3></a><p>ä¹‹å‰åœ¨åˆ†æ
<a href=https://ywue4d2ujm.feishu.cn/docs/doccnY69t6P4JXuanj2oz8GBp5g rel=noopener>Glide åŠ è½½æµç¨‹</a>çš„æ–‡ç« ä¸­å·²ç»çŸ¥é“ï¼Œwith æ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨åˆ° Glide.get(context) æ–¹æ³•ç”Ÿæˆå¹¶è¿”å›å…¨å±€ Glide å•ä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Glide</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœæœ‰é…ç½® @GlideModule æ³¨è§£çš„ Module
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// è¿™é‡Œä¼šåå°„æ„é€  kapt ç”Ÿæˆçš„ GeneratedAppGlideModuleImpl ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>getAnnotationGeneratedGlideModules</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>Glide</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>checkAndInitializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>annotationGeneratedModule</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@GuardedBy</span><span class=o>(</span><span class=s>&#34;Glide.class&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>checkAndInitializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>GeneratedAppGlideModule</span> <span class=n>generatedAppGlideModule</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isInitializing</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;You cannot call Glide.get() in registerComponents(), use the provided Glide instance instead&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>initializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>generatedAppGlideModule</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>initializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=k>new</span> <span class=n>GlideBuilder</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å¦‚æœ GeneratedAppGlideModuleImpl å­˜åœ¨ï¼Œä¸”å…è®¸è§£æ manifest æ–‡ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// åˆ™éå† manifest ä¸­çš„ meta-dataï¼Œè§£æå‡ºæ‰€æœ‰çš„ GlideModule ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>manifestModules</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>isManifestParsingEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>manifestModules</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ManifestParser</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>).</span><span class=na>parse</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ ¹æ® Impl çš„æ’é™¤åå•ï¼Œå‰”é™¤ manifest ä¸­çš„ GlideModule ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getExcludedModuleClasses</span><span class=o>().</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedModuleClasses</span> <span class=o>=</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getExcludedModuleClasses</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>iterator</span> <span class=o>=</span> <span class=n>manifestModules</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>iterator</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>current</span> <span class=o>=</span> <span class=n>iterator</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>excludedModuleClasses</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>current</span><span class=o>.</span><span class=na>getClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;AppGlideModule excludes manifest GlideModule: &#34;</span> <span class=o>+</span> <span class=n>current</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iterator</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>glideModule</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Discovered GlideModule from manifest: &#34;</span> <span class=o>+</span> <span class=n>glideModule</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å¦‚æœ Impl å­˜åœ¨ï¼Œé‚£ä¹ˆè®¾ç½®ä¸ºè¯¥ç±»çš„ RequestManagerFactoryï¼›å¦åˆ™è®¾ç½®ä¸º null
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>RequestManagerRetriever</span><span class=o>.</span><span class=na>RequestManagerFactory</span> <span class=n>factory</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getRequestManagerFactory</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>builder</span><span class=o>.</span><span class=na>setRequestManagerFactory</span><span class=o>(</span><span class=n>factory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ä¾æ¬¡è°ƒç”¨ manifest ä¸­ GlideModule ç±»çš„ applyOptions æ–¹æ³•ï¼Œå°†é…ç½®å†™åˆ° builder é‡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>module</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å†™å…¥ Impl çš„é…ç½®
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ä¹Ÿå°±æ˜¯è¯´ Impl é…ç½®çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œå¦‚æœæœ‰å†²çªçš„è¯
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è°ƒç”¨GlideBuilder.buildæ–¹æ³•åˆ›å»º Glide
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ä¾æ¬¡è°ƒç”¨ manifest ä¸­ GlideModule ç±»çš„ registerComponents æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// æ¥æ›¿æ¢ Glide çš„é»˜è®¤é…ç½®
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>module</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>glide</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>AbstractMethodError</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Attempting to register a Glide v3 module. If you see this, you or one of your&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; dependencies may be including Glide v3 even though you&#39;re using Glide v4.&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; You&#39;ll need to find and remove (or update) the offending dependency.&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; The v3 module name is: &#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=n>module</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>          <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è°ƒç”¨ Impl ä¸­æ›¿æ¢ Glide é…ç½®çš„æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>glide</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ³¨å†Œå†…å­˜ç®¡ç†çš„å›è°ƒï¼Œå› ä¸º Glide å®ç°äº† ComponentCallbacks2 æ¥å£
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>applicationContext</span><span class=o>.</span><span class=na>registerComponentCallbacks</span><span class=o>(</span><span class=n>glide</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ä¿å­˜ glide å®ä¾‹åˆ°é™æ€å˜é‡ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span><span class=o>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œé¦–å…ˆä¼šè°ƒç”¨ getAnnotationGeneratedGlideModules() æ–¹æ³•åå°„æ„é€ å‡ºæ³¨è§£å¤„ç†å™¨ç”Ÿæˆçš„ GeneratedAppGlideModuleImpl å¯¹è±¡ã€‚</p><p>æ¥ç€ï¼ŒGlide çš„åˆ›å»ºï¼ˆline 84ï¼‰å‘ç”Ÿåœ¨ applyOptions ä¹‹åï¼ŒregisterComponents ä¹‹å‰ã€‚ä¹Ÿå¥½ç†è§£ï¼Œå› ä¸º applyOptions æ˜¯æ›´æ”¹é…ç½®ï¼Œè‚¯å®šæ˜¯åˆå§‹åŒ–æ—¶å°±è¦ç¡®å®šçš„ï¼›è€Œ registerComponents é’ˆå¯¹çš„è¿è¡Œæ—¶çš„åŠŸèƒ½æ‰©å±•ï¼Œè€Œä¸”éœ€è¦è°ƒç”¨ Glide å¯¹è±¡çš„æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ Glide åˆ›å»ºä¹‹åè°ƒç”¨ã€‚</p><p>çœ‹çœ‹ GlideBuilder.build æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=n>Glide</span> <span class=nf>build</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>sourceExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sourceExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=o>.</span><span class=na>newSourceExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCacheExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=o>.</span><span class=na>newDiskCacheExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>animationExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>animationExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=o>.</span><span class=na>newAnimationExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>memorySizeCalculator</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memorySizeCalculator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MemorySizeCalculator</span><span class=o>.</span><span class=na>Builder</span><span class=o>(</span><span class=n>context</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>connectivityMonitorFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>connectivityMonitorFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultConnectivityMonitorFactory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>bitmapPool</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getBitmapPoolSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>bitmapPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruBitmapPool</span><span class=o>(</span><span class=n>size</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>bitmapPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BitmapPoolAdapter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>arrayPool</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruArrayPool</span><span class=o>(</span><span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getArrayPoolSizeInBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=o>(</span><span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getMemoryCacheSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>engine</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>engine</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Engine</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>memoryCache</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>diskCacheFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>diskCacheExecutor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>sourceExecutor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>GlideExecutor</span><span class=o>.</span><span class=na>newUnlimitedSourceExecutor</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>animationExecutor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>isActiveResourceRetentionAllowed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>defaultRequestListeners</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>defaultRequestListeners</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>defaultRequestListeners</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>unmodifiableList</span><span class=o>(</span><span class=n>defaultRequestListeners</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>GlideExperiments</span> <span class=n>experiments</span> <span class=o>=</span> <span class=n>glideExperimentsBuilder</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>RequestManagerRetriever</span> <span class=n>requestManagerRetriever</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>RequestManagerRetriever</span><span class=o>(</span><span class=n>requestManagerFactory</span><span class=o>,</span> <span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>engine</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>memoryCache</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>bitmapPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>arrayPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestManagerRetriever</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>connectivityMonitorFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>logLevel</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultRequestOptionsFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultTransitionOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultRequestListeners</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œbuild æ–¹æ³•åŸºæœ¬å¯¹æ¯ä¸€ä¸ªå‚æ•°éƒ½è¿›è¡Œäº† null åˆ¤æ–­ï¼Œå¦‚æœä¸º null åˆ™ä½¿ç”¨é»˜è®¤çš„å‚æ•°ã€‚é‚£ä¹ˆï¼Œè¿™äº›å‚æ•°ä»€ä¹ˆæ—¶å€™ä¸ä¸ºç©ºå‘¢ï¼Ÿå½“åœ¨ AppliesOptions æ¥å£çš„å®ç°ï¼ˆå³å‰é¢æ‰€è¯´çš„ applyOptions æ–¹æ³•ï¼‰ä¸­é€šè¿‡ä¼ å…¥å‚æ•° GlideBuilder è®¾ç½®åï¼Œè¿™é‡Œ build æ—¶å°±ä¸ä¼šä¸º null äº†ã€‚</p><p>æ¯”å¦‚ï¼Œå‰é¢ä¸¾ä¾‹çš„é€šè¿‡ GlideBuilder.setDiskCache æ¥å°† diskCacheFactory è®¾ç½®ä¸ºæˆ‘ä»¬æŒ‡å®šçš„å€¼ï¼Œä»è€Œå°†ç£ç›˜ç¼“å­˜ä½ç½®åˆ‡æ¢åˆ° externalCacheDir ä¸­ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#kapt-ç”Ÿæˆæ–‡ä»¶è¿‡ç¨‹åˆ†æ><h3 id=kapt-ç”Ÿæˆæ–‡ä»¶è¿‡ç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>kapt ç”Ÿæˆæ–‡ä»¶è¿‡ç¨‹åˆ†æ</h3></a><p>ä¸ºäº†æ›´å¥½åœ°ç†è§£ Glide ä¸­ annotation processor çš„ä½œç”¨ï¼Œè¿™é‡Œåˆ†åˆ«å®ç° AppGlideModuleã€LibraryGlideModule ä»¥åŠ GlideModule ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=nd>@Excludes</span><span class=p>(</span><span class=n>value</span> <span class=p>=</span> <span class=p>[</span><span class=n>MyGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyLibraryGlideModule</span> <span class=p>:</span> <span class=n>LibraryGlideModule</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyGlideModule</span> <span class=p>:</span> <span class=n>GlideModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ AndroidManifest æ–‡ä»¶ä¸­é…ç½®å¥½ MyGlideModule ä¹‹åï¼Œæˆ‘ä»¬å…ˆ rebuild ä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹ç”Ÿæˆçš„ GeneratedAppGlideModuleImpl æ–‡ä»¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=kd>class</span> <span class=nc>GeneratedAppGlideModuleImpl</span> <span class=kd>extends</span> <span class=n>GeneratedAppGlideModule</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>MyAppGlideModule</span> <span class=n>appGlideModule</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>GeneratedAppGlideModuleImpl</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>appGlideModule</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MyAppGlideModule</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=s>&#34;Glide&#34;</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=s>&#34;Glide&#34;</span><span class=o>,</span> <span class=s>&#34;Discovered AppGlideModule from annotation: com.me.guanpj.myapplication.MyAppGlideModule&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=s>&#34;Glide&#34;</span><span class=o>,</span> <span class=s>&#34;Discovered LibraryGlideModule from annotation: com.me.guanpj.myapplication.MyLibraryGlideModule&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>applyOptions</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>appGlideModule</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerComponents</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>Registry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>MyLibraryGlideModule</span><span class=o>().</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>appGlideModule</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isManifestParsingEnabled</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>appGlideModule</span><span class=o>.</span><span class=na>isManifestParsingEnabled</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getExcludedModuleClasses</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedClasses</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=n>excludedClasses</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>MyGlideModule</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>excludedClasses</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=n>GeneratedRequestManagerFactory</span> <span class=nf>getRequestManagerFactory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>GeneratedRequestManagerFactory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»£ç å¾ˆç®€å•ï¼Œå±äº AppGlideModule çš„ä¸‰ä¸ªæ–¹æ³•åŸºæœ¬éƒ½è°ƒç”¨äº† MyAppGlideModule çš„ä¸‰ä¸ªé…ç½®æ–¹æ³•ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæ¯ä¸ª LibraryGlideModule çš„ registerComponents æ–¹æ³•éƒ½ä¼šåœ¨ GeneratedAppGlideModuleImpl.registerComponents æ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚</p><p>å¦å¤–ï¼Œæˆ‘ä»¬å…³æ³¨ä¸€ä¸‹æœ€åä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯åŸºç±» GeneratedAppGlideModule é¢å¤–æä¾›äº†çš„ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>GeneratedAppGlideModule</span> <span class=kd>extends</span> <span class=n>AppGlideModule</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * This method can be removed when manifest parsing is no longer supported.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=kd>abstract</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getExcludedModuleClasses</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=n>RequestManagerRetriever</span><span class=o>.</span><span class=na>RequestManagerFactory</span> <span class=nf>getRequestManagerFactory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>getRequestManagerFactory åœ¨å­ç±»çš„å®ç°æ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯ return new GeneratedRequestManagerFactory()ã€‚</p><a href=#excludes><h4 id=excludes><span class=hanchor arialabel=Anchor># </span>@Excludes</h4></a><p>GeneratedAppGlideModuleImpl.getExcludedModuleClasses() çš„å®ç°ï¼Œä¸ @Excludes æ³¨è§£æœ‰å…³ï¼Œä½¿ç”¨è¯¥æ³¨è§£å¯ä»¥è®© Glide å¿½ç•¥æŒ‡å®šçš„ GlideModule æˆ– LibraryGlideModuleã€‚@Excludes æ³¨è§£åªèƒ½ç”¨åœ¨ AppGlideModules ä¸Šï¼Œä¸‹é¢çš„ä¾‹å­å°†ä¼šè®© Glide å¿½ç•¥æ‰ MyLibraryGlideModuleã€MyGlideModule çš„é…ç½®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=nd>@Excludes</span><span class=o>(</span><span class=n>value</span> <span class=k>=</span> <span class=o>[</span><span class=kt>MyLibraryGlideModule::class</span>, <span class=kt>MyGlideModule::class</span><span class=o>])</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=k>:</span> <span class=kt>AppGlideModule</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>æ­¤æ—¶ rebuild ä¹‹åï¼Œç”Ÿæˆçš„ GeneratedAppGlideModuleImpl æ–‡ä»¶çš„ç›¸å…³æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=k>void</span> <span class=nx>registerComponents</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Context</span> <span class=nx>context</span><span class=p>,</span> <span class=kd>@NonNull</span> <span class=nx>Glide</span> <span class=nx>glide</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@NonNull</span> <span class=nx>Registry</span> <span class=nx>registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ³¨æ„ï¼Œæ²¡æœ‰new MyLibraryGlideModule().registerComponents(context, glide, registry);äº†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>appGlideModule</span><span class=p>.</span><span class=nx>registerComponents</span><span class=p>(</span><span class=nx>context</span><span class=p>,</span> <span class=nx>glide</span><span class=p>,</span> <span class=nx>registry</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>Set</span><span class=p>&lt;</span><span class=nt>Class</span><span class=err>&lt;?</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>getExcludedModuleClasses() {</span>
</span></span><span class=line><span class=cl>    <span class=nx>Set</span><span class=p>&lt;</span><span class=nt>Class</span><span class=err>&lt;?</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>excludedClasses</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>HashSet</span><span class=p>&lt;</span><span class=nt>Class</span><span class=err>&lt;?</span><span class=p>&gt;</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>excludedClasses</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>com</span><span class=p>.</span><span class=nx>me</span><span class=p>.</span><span class=nx>guanpj</span><span class=p>.</span><span class=nx>myapplication</span><span class=p>.</span><span class=nx>MyGlideModule</span><span class=p>.</span><span class=kr>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>excludedClasses</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>com</span><span class=p>.</span><span class=nx>me</span><span class=p>.</span><span class=nx>guanpj</span><span class=p>.</span><span class=nx>myapplication</span><span class=p>.</span> <span class=nx>MyLibraryGlideModule</span><span class=p>.</span><span class=kr>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>excludedClasses</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶ååœ¨ Glide åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåœ¨æ–¹æ³•è¿”å›ç»“æœ set é‡Œé¢çš„ GlideModule å°†ä¼šä»é›†åˆä¸­ç§»é™¤ã€‚</p><a href=#glideextension><h4 id=glideextension><span class=hanchor arialabel=Anchor># </span>@GlideExtension</h4></a><p>@GlideExtension æ³¨è§£ä¿®é¥°çš„ç±»å¯ä»¥æ‰©å±• Glide çš„ APIã€‚è¯¥ç±»å¿…é¡»æ˜¯å·¥å…·ç±»çš„å½¢å¼ï¼Œé‡Œé¢çš„æ–¹æ³•å¿…é¡»éƒ½æ˜¯é™æ€çš„ï¼Œé™¤äº†ç§æœ‰çš„ç©ºå®ç°çš„æ„é€ å™¨ã€‚</p><p>Application å¯ä»¥å®ç°å¤šä¸ª @GlideExtension æ³¨è§£ç±»ï¼ŒLibrary ä¹Ÿå¯ä»¥å®ç°ä»»æ„æ•°é‡çš„ @GlideExtension æ³¨è§£ç±»ã€‚Glide åœ¨ç¼–è¯‘æ—¶ï¼Œä¸€æ—¦å‘ç°ä¸€ä¸ª AppGlideModuleï¼Œæ‰€æœ‰å¯ç”¨çš„ GlideExtension éƒ½ä¼šåˆå¹¶ï¼Œå¹¶ç”Ÿæˆå•ä¸ªçš„ API æ–‡ä»¶ã€‚ä»»ä½•å†²çªéƒ½ä¼šå¯¼è‡´ Glide æ³¨è§£ç”Ÿæˆå™¨çš„ç¼–è¯‘é”™è¯¯ã€‚</p><p>GlideExtension æ³¨è§£ç±»å¯ä»¥å®šä¹‰ä¸¤ç§æ‰©å±•æ–¹æ³•ï¼š</p><ol><li>@GlideOptionâ€”â€”ä¸º RequestOptions æ·»åŠ è‡ªå®šä¹‰çš„é…ç½®ï¼Œæ‰©å±• RequestOptions çš„é™æ€æ–¹æ³•ã€‚å¸¸è§ä½œç”¨æœ‰ï¼š</li><li>å®šä¹‰åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ç»å¸¸ä½¿ç”¨çš„ä¸€ç»„é€‰é¡¹</li><li>æ·»åŠ æ–°é€‰é¡¹ï¼Œé€šå¸¸ä¸ Glide çš„ com.bumptech.glide.load.Option ä¸€èµ·ä½¿ç”¨ã€‚</li><li>@GlideTypeâ€”â€”ä¸ºæ–°èµ„æºç±»å‹ï¼ˆGIFsã€SVG ç­‰ï¼‰æ·»åŠ æ”¯æŒï¼Œæ‰©å±• RequestManager çš„é™æ€æ–¹æ³•</li></ol><p>ä¸‹é¢çš„ç¤ºä¾‹æ¥è‡ªäºå®˜æ–¹æ–‡æ¡£ GlideExtension çš„ç¤ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideExtension</span>
</span></span><span class=line><span class=cl><span class=k>object</span> <span class=nc>MyAppExtension</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Size of mini thumb in pixels.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>const</span> <span class=k>val</span> <span class=py>MINI</span><span class=n>_THUMB_SIZE</span> <span class=p>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>DECODE</span><span class=n>_TYPE_GIF</span> <span class=p>=</span> <span class=n>RequestOptions</span><span class=p>.</span><span class=n>decodeTypeOf</span><span class=p>(</span><span class=n>GifDrawable</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>).</span><span class=n>lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GlideOption</span>
</span></span><span class=line><span class=cl>    <span class=nd>@JvmStatic</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>miniThumb</span><span class=p>(</span><span class=n>options</span><span class=p>:</span> <span class=n>BaseRequestOptions</span><span class=p>&lt;*&gt;):</span> <span class=n>BaseRequestOptions</span><span class=p>&lt;*&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>options</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>fitCenter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=k>override</span><span class=p>(</span><span class=n>MINI_THUMB_SIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GlideType</span><span class=p>(</span><span class=n>GifDrawable</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@JvmStatic</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>asGifTest</span><span class=p>(</span><span class=n>requestBuilder</span><span class=p>:</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>GifDrawable</span><span class=p>&gt;):</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>GifDrawable</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>requestBuilder</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>transition</span><span class=p>(</span><span class=n>DrawableTransitionOptions</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_GIF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œä¸º RequestOptions æ‰©å±•äº† miniThumb æ–¹æ³•ï¼Œä¸º RequestManager æ‰©å±•äº† asGifTest æ–¹æ³•ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>GlideApp</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>asGifTest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>miniThumb</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„è¿™é‡Œä½¿ç”¨çš„ä¸å†æ˜¯ Glideï¼Œè€Œæ˜¯ GlideAppã€‚GlideApp æ˜¯ä¸“é—¨ç”¨æ¥å¤„ç†è¿™ç§æ‰©å±• API çš„ã€‚</p><p>åœ¨ Glide åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šå°† GeneratedAppGlideModuleImpl.getRequestManagerFactory() æ–¹æ³•è¿”å›çš„ GeneratedRequestManagerFactory ä½œä¸º requestManagerFactory å‚æ•°ï¼Œè¿™æ ·åˆ›å»º RequestManager æ—¶éƒ½ä¼šè°ƒç”¨ GeneratedRequestManagerFactory.build æ–¹æ³•ç”Ÿæˆ GlideRequestsã€‚</p><p><strong>GlideRequests</strong> ç»§æ‰¿è‡³ RequestManagerï¼Œé‡Œé¢åŒ…å«äº† @GlideType æ³¨è§£ä¿®é¥°çš„ APIï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GlideRequests</span> <span class=kd>extends</span> <span class=n>RequestManager</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>GlideRequests</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                       <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>treeNode</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>glide</span><span class=o>,</span> <span class=n>lifecycle</span><span class=o>,</span> <span class=n>treeNode</span><span class=o>,</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * @see MyAppExtension#asGifTest(RequestBuilder)
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGifTest</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;)</span> <span class=n>MyAppExtension</span><span class=o>.</span><span class=na>asGifTest</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>as</span><span class=o>(</span><span class=n>GifDrawable</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>GlideRequestï¼ˆæ³¨æ„æ²¡æœ‰ sï¼‰</strong> åˆ™ç»§æ‰¿è‡³ RequestBuilderï¼ŒåŒ…å«äº† @GlideOption æä¾›çš„ APIï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=nc>GlideRequest</span><span class=o>&lt;</span><span class=nc>TranscodeType</span><span class=o>&gt;</span> <span class=k>extends</span> <span class=nc>RequestBuilder</span><span class=o>&lt;</span><span class=nc>TranscodeType</span><span class=o>&gt;</span> <span class=n>implements</span> <span class=nc>Cloneable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * @see MyAppExtension#miniThumb(BaseRequestOptions)
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=n>public</span> <span class=nc>GlideRequest</span><span class=o>&lt;</span><span class=nc>TranscodeType</span><span class=o>&gt;</span> <span class=n>miniThumb</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=nc>GlideRequest</span><span class=o>&lt;</span><span class=nc>TranscodeType</span><span class=o>&gt;)</span> <span class=nc>MyAppExtension</span><span class=o>.</span><span class=n>miniThumb</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ­¤å¤–ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨åˆ° RequestOptionsï¼Œè¦ä½¿ç”¨ Generated API ç”Ÿæˆçš„ GlideOptionsã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œå¦‚æœæƒ³ä½¿ç”¨ Generated APIï¼Œæ³¨æ„ä¸€ä¸‹ä¸‰ä¸ªç±»çš„å…³ç³»</p><ul><li>RequestManager -> GlideRequests</li><li>RequestBuilder -> GlideRequest</li><li>RequestOptions -> GlideOptions</li></ul><a href=#å®æˆ˜åˆ†æ><h2 id=å®æˆ˜åˆ†æ><span class=hanchor arialabel=Anchor># </span>å®æˆ˜åˆ†æ</h2></a></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>