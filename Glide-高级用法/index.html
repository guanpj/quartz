<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Glide 高级用法 回调与监听 Target 我们都知道，使用 Glide 在界面上加载并展示一张图片只需要一行代码：
1  Glide.with(this).load(url).into(imageView);   将 ImageView 的实例传入到 into() 方法当中，Glide 将图片加载完成之后，图片就能显示到 ImageView 上了。这是怎么实现的呢？来看一下 into() 方法的源码："><meta property="og:title" content><meta property="og:description" content="Glide 高级用法 回调与监听 Target 我们都知道，使用 Glide 在界面上加载并展示一张图片只需要一行代码：
1  Glide.with(this).load(url).into(imageView);   将 ImageView 的实例传入到 into() 方法当中，Glide 将图片加载完成之后，图片就能显示到 ImageView 上了。这是怎么实现的呢？来看一下 into() 方法的源码："><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Glide 高级用法 回调与监听 Target 我们都知道，使用 Glide 在界面上加载并展示一张图片只需要一行代码：
1  Glide.with(this).load(url).into(imageView);   将 ImageView 的实例传入到 into() 方法当中，Glide 将图片加载完成之后，图片就能显示到 ImageView 上了。这是怎么实现的呢？来看一下 into() 方法的源码："><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>🌻 guanpjの花园 🌵</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.0452046239b15cdfa822e3a8fa41b16d.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.696841b111fc7b3c76b3b6aa81166af4.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.ca52e7d9467e2885647d26447cb0e5e3.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown</p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#glide-高级用法>Glide 高级用法</a></li><li><a href=#回调与监听>回调与监听</a><ol><li><a href=#target>Target</a></li><li><a href=#requestbuilder-高级-api>RequestBuilder 高级 API</a><ol><li><a href=#preload>preload</a></li><li><a href=#submit>submit</a></li><li><a href=#downloadonly>downloadOnly</a></li><li><a href=#listeneraddlistener>listener/addListener</a></li></ol></li></ol></li><li><a href=#transform>Transform</a><ol><li><a href=#transform-行为分析>Transform 行为分析</a><ol><li><a href=#场景还原>场景还原</a></li><li><a href=#代码分析>代码分析</a></li></ol></li><li><a href=#glide-自带的-transformation>Glide 自带的 Transformation</a></li><li><a href=#自定义-bitmaptransformation>自定义 BitmapTransformation</a></li></ol></li><li><a href=#appglidemodule>AppGlideModule</a><ol><li><a href=#使用>使用</a><ol><li><a href=#applyoptions>applyOptions</a><ol><li><a href=#strong内存缓存memorycachestrong><strong>内存缓存（MemoryCache）</strong></a></li><li><a href=#strongbitmappoolstrong><strong>BitmapPool</strong></a></li><li><a href=#strong磁盘缓存diskcachestrong><strong>磁盘缓存（DiskCache）</strong></a></li><li><a href=#strong默认请求选项defaultrequestoptionsstrong><strong>默认请求选项（DefaultRequestOptions）</strong></a></li><li><a href=#strong未捕获异常策略-uncaughtthrowablestrategystrong><strong>未捕获异常策略 (UncaughtThrowableStrategy)</strong></a></li><li><a href=#strong日志级别loglevel-strong><strong>日志级别（LogLevel ）</strong></a></li></ol></li><li><a href=#ismanifestparsingenabled>isManifestParsingEnabled</a></li><li><a href=#registercomponents>registerComponents</a></li></ol></li><li><a href=#原理>原理</a><ol><li><a href=#glide-初始化流程分析>Glide 初始化流程分析</a></li><li><a href=#kapt-生成文件过程分析>kapt 生成文件过程分析</a><ol><li><a href=#excludes>@Excludes</a></li><li><a href=#glideextension>@GlideExtension</a></li></ol></li></ol></li><li><a href=#实战分析>实战分析</a></li></ol></li></ol></nav></details></aside><a href=#glide-高级用法><h1 id=glide-高级用法><span class=hanchor arialabel=Anchor># </span>Glide 高级用法</h1></a><a href=#回调与监听><h1 id=回调与监听><span class=hanchor arialabel=Anchor># </span>回调与监听</h1></a><a href=#target><h2 id=target><span class=hanchor arialabel=Anchor># </span>Target</h2></a><p>我们都知道，使用 Glide 在界面上加载并展示一张图片只需要一行代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=k>this</span><span class=o>).</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>).</span><span class=na>into</span><span class=o>(</span><span class=n>imageView</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>将 ImageView 的实例传入到 into() 方法当中，Glide 将图片加载完成之后，图片就能显示到 ImageView 上了。这是怎么实现的呢？来看一下 into() 方法的源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>into</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Util</span><span class=o>.</span><span class=na>assertMainThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span> <span class=o>=</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!</span><span class=n>requestOptions</span><span class=o>.</span><span class=na>isTransformationSet</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>isTransformationAllowed</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>view</span><span class=o>.</span><span class=na>getScaleType</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// into a different target, we don&#39;t retain the transformation applied based on the previous
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// View&#39;s scale type.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getScaleType</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_CROP</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterCrop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_INSIDE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterInside</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_CENTER</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_START</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_END</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalFitCenter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_XY</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterInside</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>MATRIX</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Do nothing.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>into</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>glideContext</span><span class=o>.</span><span class=na>buildImageViewTarget</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>transcodeClass</span><span class=o>),</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Executors</span><span class=o>.</span><span class=na>mainThreadExecutor</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，最后一行代码会调用 glideContext.buildImageViewTarget() 方法构建出一个 Target 对象，然后再把它传入到另一个接收 Target 参数的 into()方法中。Target 对象则是用来最终展示图片用的，跟进方法 glideContext.buildImageViewTarget：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>X</span><span class=o>&gt;</span> <span class=nf>buildImageViewTarget</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>imageView</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>imageViewTargetFactory</span><span class=o>.</span><span class=na>buildTarget</span><span class=o>(</span><span class=n>imageView</span><span class=o>,</span> <span class=n>transcodeClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>继续跟进：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ImageViewTargetFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=nf>buildTarget</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Bitmap</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>Z</span><span class=o>&gt;)</span> <span class=k>new</span> <span class=n>BitmapImageViewTarget</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Drawable</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>Z</span><span class=o>&gt;)</span> <span class=k>new</span> <span class=n>DrawableImageViewTarget</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Unhandled class: &#34;</span> <span class=o>+</span> <span class=n>clazz</span> <span class=o>+</span> <span class=s>&#34;, try .as*(Class).transcode(ResourceTranscoder)&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>回顾之前的分析流程，在 into(ImageView) 过程中，会将 ImageView 包装成为一个 ViewTarget 类。如果调用过 asBitmap() 方法，那么此处会是 BitmapImageViewTarget，否则都将会是 DrawableImageViewTarget。BitmapImageViewTarget 和 DrawableImageViewTarget 除了 setResource 方法中调用的设置图片的 API 不同外，没有任何区别。</p><p>DrawableImageView 的继承链如下：DrawableImageView -> ImageViewTarget -> ViewTarget -> BaseTarget -> Target。</p><ul><li>Target 是一个继承了 LifecycleListener 接口的接口类，该类提供了资源加载过程中的回调操作。</li></ul><p>典型的生命周期为 onLoadStarted -> onResourceReady/onLoadFailed -> onLoadCleared，但不保证所有的都是这样。如果资源在内存中或者由于 model 为 null 而加载失败，onLoadStarted 不会被调用。同样，如果 target 不会清除，那么 onLoadCleared 方法也不会被调用。</p><ul><li>BaseTarget 是一个实现了 Target 接口的抽象类。</li></ul><p>该类实现了 setRequest(Request)、getRequest() 两个方法，其他方法相当于适配器模式的实现。</p><ul><li>ViewTarget</li></ul><p>该类虽然继承了 BaseTarget 类，但其重写了 setRequest(Request)、getRequest() 两个方法，这两个方法会调用 View.setTag 方法将 Request 对象传入。</p><p>In addition, <strong>for</strong> ViewTarget<strong>s only</strong>, you can pass in a new instance to each load or clear call and allow Glide to retrieve information about previous loads from the Views tags</p><p>This will <strong>not</strong> work unless your Target extends ViewTarget or implements setRequest() and getRequest() in a way that allows you to retrieve previous requests in new Target instances.</p><p><a href=http://bumptech.github.io/glide/doc/targets.html#cancellation-and-re-use rel=noopener>Cancellation and re-use</a></p><ul><li>ImageViewTarget</li></ul><p>该类的作用就是在加载的生命周期回调中给 ImageView 设置对应的资源。但由于加载成功后返回的资源可能是 Bitmap 或者 Drawable，所以这个不确定类型的加载由 setResource 抽象方法声明，待子类 BitmapImageViewTarget 和 DrawableImageViewTarget 实现。</p><ul><li>DrawableImageViewTarget</li></ul><p>继承了 ImageViewTarget 类，唯一的作用就是实现 setResource(Drawable) 方法。</p><p>在了解了 DrawableImageViewTarget 以及相关的类之后，我们看一下其他的 Target。下面是 Glide v4 中出现的所有的 Target：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031827.png width=auto alt></p><p>虽然 Target 很多，但是自定义只需要继承 CustomViewTarget 或者 CustomTarget 就行了。</p><p><strong>为什么要继承 </strong>CustomViewTarget <strong>而不是 </strong>ViewTarget？</p><p>ViewTarget 已经被标记为废弃了，建议我们使用 CustomViewTarget。这是因为，如果子类没有实现 ViewTarget.onLoadCleared 方法，将会导致被回收的 bitmap 仍然被 UI 所引用，从而导致崩溃。而 CustomViewTarget.onLoadCleared 方法是 final 类型的，并且提供了一个抽象方法 onResourceCleared 强制我们实现。除此之外，两个类基本没有任何区别。</p><p><strong>为什么要继承 </strong>CustomTarget <strong>而不是 </strong>SimpleTarget？</p><p>原因同上</p><p>下面举一个实际例子，在某些场景下，此时我们需要获取到加载成功后的 Bitma p 对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>asBitmap</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=k>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=k>object</span> <span class=err>: </span><span class=nc>CustomTarget</span><span class=p>&lt;</span><span class=n>Bitmap</span><span class=p>&gt;()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onResourceReady</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>resource</span><span class=p>:</span> <span class=n>Bitmap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>transition</span><span class=p>:</span> <span class=n>Transition</span><span class=p>&lt;</span><span class=k>in</span> <span class=n>Bitmap</span><span class=p>&gt;?</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ivFace</span><span class=p>.</span><span class=n>setImageBitmap</span><span class=p>(</span><span class=n>resource</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onLoadCleared</span><span class=p>(</span><span class=n>placeholder</span><span class=p>:</span> <span class=n>Drawable</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ivFace</span><span class=p>.</span><span class=n>setImageDrawable</span><span class=p>(</span><span class=n>placeholder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><a href=#requestbuilder-高级-api><h2 id=requestbuilder-高级-api><span class=hanchor arialabel=Anchor># </span>RequestBuilder 高级 API</h2></a><p>在了解了 Target 之后，我们再看看 RequestBuilder 中高级一点的 API。</p><p>下面这些都是 Target 的应用，内部调用的是<strong>修改过配置</strong>的 into/submit 方法，但 RequestBuilder.downloadOnly 方法已经被废弃；建议采用 RequestManager 的 downloadOnly()方法和 into/submit 方法</p><p>此外还有还需要注意的一个 API：listener/addListener</p><a href=#preload><h3 id=preload><span class=hanchor arialabel=Anchor># </span>preload</h3></a><p>作用：将资源预加载到缓存中</p><p>preload 的重载方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * Preloads the resource into the cache using the given width and height.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * &lt;p&gt; Pre-loading is useful for making sure that resources you are going to to want in the near
</span></span></span><span class=line><span class=cl><span class=cm>  * future are available quickly. &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * @param width  The desired width in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span class=line><span class=cl><span class=cm>  *               overridden by
</span></span></span><span class=line><span class=cl><span class=cm>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)} if
</span></span></span><span class=line><span class=cl><span class=cm>  *               previously called.
</span></span></span><span class=line><span class=cl><span class=cm>  * @param height The desired height in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span class=line><span class=cl><span class=cm>  *               overridden by
</span></span></span><span class=line><span class=cl><span class=cm>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)}} if
</span></span></span><span class=line><span class=cl><span class=cm>  *               previously called).
</span></span></span><span class=line><span class=cl><span class=cm>  * @return A {@link Target} that can be used to cancel the load via
</span></span></span><span class=line><span class=cl><span class=cm>  * {@link RequestManager#clear(Target)}.
</span></span></span><span class=line><span class=cl><span class=cm>  * @see com.bumptech.glide.ListPreloader
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>preload</span><span class=o>(</span><span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>PreloadTarget</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span> <span class=o>=</span> <span class=n>PreloadTarget</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>requestManager</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>into</span><span class=o>(</span><span class=n>target</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * Preloads the resource into the cache using {@link Target#SIZE_ORIGINAL} as the target width and
</span></span></span><span class=line><span class=cl><span class=cm>  * height. Equivalent to calling {@link #preload(int, int)} with {@link Target#SIZE_ORIGINAL} as
</span></span></span><span class=line><span class=cl><span class=cm>  * the width and height.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * @return A {@link Target} that can be used to cancel the load via
</span></span></span><span class=line><span class=cl><span class=cm>  * {@link RequestManager#clear(Target)}
</span></span></span><span class=line><span class=cl><span class=cm>  * @see #preload(int, int)
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>preload</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>preload</span><span class=o>(</span><span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span><span class=o>,</span> <span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意，在注释中出现了一个 ListPreload 类，该类是在 ListView 中做 item 预加载的一个工具类，使用方法为 AbsListView#setOnScrollListener(android.widget.AbsListView.OnScrollListener)。该类代码很简单，要点就是在滚动时计算需要预处理的 item。</p><p>这么好用，那我要是 RecyclerView 怎么办？Glide 也提供了 RecyclerView 的版本，不过需要添加新的依赖 recyclerview-integration，详情可以查看文档
<a href=http://bumptech.github.io/glide/int/recyclerview.html rel=noopener>INTEGRATION LIBRARIES - RecyclerView</a>。</p><p>我们可以看到，在 preload 的实现中关键点就在于 PreloadTarget 类。该类实现非常简单，就是在 onResourceReady 回调发生后，经过 Handler 中转，最后由构造参数之一的 RequestManager 对象 clear 掉。PreloadTarget 实现代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * A one time use {@link com.bumptech.glide.request.target.Target} class that loads a resource into
</span></span></span><span class=line><span class=cl><span class=cm> * memory and then clears itself.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param &lt;Z&gt; The type of resource that will be loaded into memory.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>PreloadTarget</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>SimpleTarget</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MESSAGE_CLEAR</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>Looper</span><span class=o>.</span><span class=na>getMainLooper</span><span class=o>(),</span> <span class=k>new</span> <span class=n>Callback</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=n>Message</span> <span class=n>message</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>what</span> <span class=o>==</span> <span class=n>MESSAGE_CLEAR</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>((</span><span class=n>PreloadTarget</span><span class=o>&lt;?&gt;)</span> <span class=n>message</span><span class=o>.</span><span class=na>obj</span><span class=o>).</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>RequestManager</span> <span class=n>requestManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns a PreloadTarget.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * @param width  The width in pixels of the desired resource.
</span></span></span><span class=line><span class=cl><span class=cm>   * @param height The height in pixels of the desired resource.
</span></span></span><span class=line><span class=cl><span class=cm>   * @param &lt;Z&gt;    The type of the desired resource.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>PreloadTarget</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>obtain</span><span class=o>(</span><span class=n>RequestManager</span> <span class=n>requestManager</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>PreloadTarget</span><span class=o>&lt;&gt;(</span><span class=n>requestManager</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=nf>PreloadTarget</span><span class=o>(</span><span class=n>RequestManager</span> <span class=n>requestManager</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>requestManager</span> <span class=o>=</span> <span class=n>requestManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Z</span> <span class=n>resource</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=n>transition</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>HANDLER</span><span class=o>.</span><span class=na>obtainMessage</span><span class=o>(</span><span class=n>MESSAGE_CLEAR</span><span class=o>,</span> <span class=k>this</span><span class=o>).</span><span class=na>sendToTarget</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Synthetic</span> <span class=kt>void</span> <span class=nf>clear</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestManager</span><span class=o>.</span><span class=na>clear</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#submit><h3 id=submit><span class=hanchor arialabel=Anchor># </span>submit</h3></a><p>作用：返回一个 Future 对象，其 get() 方法会阻塞住，所以需要在后台线程中调用</p><p>submit 的两个重载方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * Returns a future that can be used to do a blocking get on a background thread.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * &lt;p&gt;This method defaults to {@link Target#SIZE_ORIGINAL} for the width and the height. However,
</span></span></span><span class=line><span class=cl><span class=cm>  * since the width and height will be overridden by values passed to {@link
</span></span></span><span class=line><span class=cl><span class=cm>  * RequestOptions#override(int, int)}, this method can be used whenever {@link RequestOptions}
</span></span></span><span class=line><span class=cl><span class=cm>  * with override values are applied, or whenever you want to retrieve the image in its original
</span></span></span><span class=line><span class=cl><span class=cm>  * size.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * @see #submit(int, int)
</span></span></span><span class=line><span class=cl><span class=cm>  * @see #into(Target)
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>FutureTarget</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>submit</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>submit</span><span class=o>(</span><span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span><span class=o>,</span> <span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * Returns a future that can be used to do a blocking get on a background thread.
</span></span></span><span class=line><span class=cl><span class=cm>  *
</span></span></span><span class=line><span class=cl><span class=cm>  * @param width  The desired width in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span class=line><span class=cl><span class=cm>  *               overridden by
</span></span></span><span class=line><span class=cl><span class=cm>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)} if
</span></span></span><span class=line><span class=cl><span class=cm>  *               previously called.
</span></span></span><span class=line><span class=cl><span class=cm>  * @param height The desired height in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span class=line><span class=cl><span class=cm>  *               overridden by
</span></span></span><span class=line><span class=cl><span class=cm>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)}} if
</span></span></span><span class=line><span class=cl><span class=cm>  *               previously called).
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>FutureTarget</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>submit</span><span class=o>(</span><span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>RequestFutureTarget</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RequestFutureTarget</span><span class=o>&lt;&gt;(</span><span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>into</span><span class=o>(</span><span class=n>target</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>Executors</span><span class=o>.</span><span class=na>directExecutor</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>由于方法会生成一个 RequestFutureTarget 对象，而其 getSize 的实现就是构造参数。所以，此处的值会覆盖掉 RequestOptions 设置的值。</p><p>submit 之后生成了一个 RequestFutureTarget 对象，调用该对象的 get 方法可以在资源加载成功后立即获得资源对象，在获得之前会阻塞，所以 get 方法需要在后台线程中执行，否则会报错。</p><p>RequestFutureTarget 的示例代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>FutureTarget</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>target</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>RequestManager</span> <span class=n>requestManager</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span> <span class=o>=</span> <span class=n>requestManager</span>
</span></span><span class=line><span class=cl>     <span class=o>.</span><span class=na>downloadOnly</span><span class=o>()</span>
</span></span><span class=line><span class=cl>     <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>model</span><span class=o>)</span>
</span></span><span class=line><span class=cl>     <span class=o>.</span><span class=na>submit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=n>downloadedFile</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ... do something with the file (usually throws IOException)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ExecutionException</span> <span class=o>|</span> <span class=n>InterruptedException</span> <span class=o>|</span> <span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ... bug reporting or recovery
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// make sure to cancel pending operations and free resources
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>target</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=na>cancel</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span> <span class=c1>// mayInterruptIfRunning
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#downloadonly><h3 id=downloadonly><span class=hanchor arialabel=Anchor># </span>downloadOnly</h3></a><p>作用：下载原始的无修改的 data 文件。</p><p>downloadOnly 内部调用的是修改过配置的 into/submit 方法，但 downloadOnly 方法已经被废弃；建议采用 RequestManager 的 downloadOnly() 方法和 into/submit 方法。</p><p>实际上 RequestBuilder.downloadOnly 方法与 RequestManager.downloadOnly()、RequestBuilder.into/submit 方法组合没有什么区别。</p><p>两处代码如下：</p><p><em>RequestBuilder.downloadOnly</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>downloadOnly</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>getDownloadOnlyRequest</span><span class=o>().</span><span class=na>into</span><span class=o>(</span><span class=n>target</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>FutureTarget</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>downloadOnly</span><span class=o>(</span><span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>getDownloadOnlyRequest</span><span class=o>().</span><span class=na>submit</span><span class=o>(</span><span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>getDownloadOnlyRequest</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestBuilder</span><span class=o>&lt;&gt;(</span><span class=n>File</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=k>this</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>DOWNLOAD_ONLY_OPTIONS</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><em>RequestManager.downloadOnly、RequestBuilder.into/submit</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=p>&lt;</span><span class=nt>Y</span> <span class=na>extends</span> <span class=na>Target</span><span class=err>&lt;</span><span class=na>TranscodeType</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>Y</span> <span class=nx>into</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Y</span> <span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>Executors</span><span class=p>.</span><span class=nx>mainThreadExecutor</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>FutureTarget</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>submit</span><span class=p>(</span><span class=nx>int</span> <span class=nx>width</span><span class=p>,</span> <span class=nx>int</span> <span class=nx>height</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>final</span> <span class=nx>RequestFutureTarget</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>target</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>RequestFutureTarget</span><span class=p>&lt;&gt;(</span><span class=nx>width</span><span class=p>,</span> <span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>target</span><span class=p>,</span> <span class=nx>Executors</span><span class=p>.</span><span class=nx>directExecutor</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>File</span><span class=p>&gt;</span> <span class=nx>downloadOnly() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kr>as</span><span class=p>(</span><span class=nx>File</span><span class=p>.</span><span class=kr>class</span><span class=p>).</span><span class=nx>apply</span><span class=p>(</span><span class=nx>DOWNLOAD_ONLY_OPTIONS</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>所以，这里的 DOWNLOAD_ONLY_OPTIONS 才是 downloadOnly 的精髓，我们看看该变量的值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestOptions</span> <span class=n>DOWNLOAD_ONLY_OPTIONS</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>RequestOptions</span><span class=o>().</span><span class=na>diskCacheStrategy</span><span class=o>(</span><span class=n>DiskCacheStrategy</span><span class=o>.</span><span class=na>DATA</span><span class=o>).</span><span class=na>priority</span><span class=o>(</span><span class=n>Priority</span><span class=o>.</span><span class=na>LOW</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>skipMemoryCache</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>果然是下载的是原始的无修改的 data 资源。</p><a href=#listeneraddlistener><h3 id=listeneraddlistener><span class=hanchor arialabel=Anchor># </span>listener/addListener</h3></a><p>listener 与 addListener 不同之处在于，前者只会保留当前的 Listener，而后者会保留之前的 Listener。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;unchecked&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>listener</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>requestListener</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>requestListeners</span> <span class=p>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>addListener</span><span class=p>(</span><span class=n>requestListener</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>addListener</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>requestListener</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>requestListener</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>requestListeners</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=n>requestListeners</span> <span class=p>=</span> <span class=n>new</span> <span class=n>ArrayList</span><span class=p>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=n>requestListeners</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>requestListener</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这些 listener 会在资源记载失败或者成功的时候被调用，SingleRequest 中关于 requestListeners 的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>R</span> <span class=n>result</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We must call isFirstReadyResource before setting status.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>boolean</span> <span class=n>isFirstResource</span> <span class=o>=</span> <span class=n>isFirstReadyResource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=o>.</span><span class=na>COMPLETE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=o>:</span> <span class=n>requestListeners</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>            <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>animation</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>animationFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>target</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>animation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>notifyLoadSuccess</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=o>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=o>,</span> <span class=kt>int</span> <span class=n>maxLogLevel</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>stateVerifier</span><span class=o>.</span><span class=na>throwIfRecycled</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>.</span><span class=na>setOrigin</span><span class=o>(</span><span class=n>requestOrigin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>loadStatus</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=o>.</span><span class=na>FAILED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//TODO: what if this is a thumbnail request?
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=o>:</span> <span class=n>requestListeners</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>            <span class=n>listener</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>isFirstReadyResource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>isFirstReadyResource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>setErrorPlaceholder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>notifyLoadFailed</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>调用逻辑是这样：在 requestListeners 集合、targetListener 中依次调用对应的回调，找到第一个能够处理的(返回 true)，后面的就不再调用。</p><p>同时，如果有一个回调返回了 true，那么资源的对应方法会被拦截：</p><ol><li>对于 onResourceReady 方法来说，Target 的 onResourceReady 方法不会被回调</li><li>对于 onLoadFailed 方法来说，setErrorPlaceholder 调用不会调用，即不会显示任何失败的占位符</li></ol><a href=#transform><h1 id=transform><span class=hanchor arialabel=Anchor># </span>Transform</h1></a><a href=#transform-行为分析><h2 id=transform-行为分析><span class=hanchor arialabel=Anchor># </span>Transform 行为分析</h2></a><a href=#场景还原><h3 id=场景还原><span class=hanchor arialabel=Anchor># </span>场景还原</h3></a><p>布局文件：ImageView 宽高都是 wrap_content</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>android.support.constraint.ConstraintLayout</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:android</span><span class=o>=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:app</span><span class=o>=</span><span class=s>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_width</span><span class=o>=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_height</span><span class=o>=</span><span class=s>&#34;match_parent&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id</span><span class=o>=</span><span class=s>&#34;@+id/ivGlide&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width</span><span class=o>=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height</span><span class=o>=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf</span><span class=o>=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toTopOf</span><span class=o>=</span><span class=s>&#34;parent&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>android.support.design.widget.FloatingActionButton</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id</span><span class=o>=</span><span class=s>&#34;@+id/fab&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width</span><span class=o>=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height</span><span class=o>=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_margin</span><span class=o>=</span><span class=s>&#34;24dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:src</span><span class=o>=</span><span class=s>&#34;@drawable/btn_camera&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf</span><span class=o>=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintBottom_toBottomOf</span><span class=o>=</span><span class=s>&#34;parent&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>android.support.constraint.ConstraintLayout</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>代码：测试的可选项为代码中被注释的两行代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=k>import</span> <span class=nn>com.bumptech.glide.request.target.Target</span> <span class=k>as</span> <span class=n>GlideTarget</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GlideFragment</span> <span class=p>:</span> <span class=n>Fragment</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onViewCreated</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span> <span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onViewCreated</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>fab</span><span class=p>.</span><span class=n>setOnClickListener</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>load</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>//            .dontTransform()
</span></span></span><span class=line><span class=cl><span class=c1>//            .override(GlideTarget.SIZE_ORIGINAL, GlideTarget.SIZE_ORIGINAL)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 540*258  1080/(759-243)-(540/258)=0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>private</span> <span class=k>const</span> <span class=k>val</span> <span class=py>URL</span> <span class=p>=</span> <span class=s2>&#34;https://www.baidu.com/img/bd_logo1.png&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>整个例子非常简单，点击一下 FAB 就会调用 load 方法加载网路图片。注意这里 ImageView 的宽高都是 wrap_content。</p><p>下面从左至右 4 张图分别对应以下配置开启时的效果（下面分析时会称为例 1、例 2、例 3、例 4）：</p><ol><li>直接加载</li><li>只使用 dontTransform</li><li>只使用 override</li><li>dontTransform 和 override 同时</li></ol><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031837.png width=auto alt></p><p>可以很明显的看到，显示的图片也有所差异，ImageView 的宽高有所差异。</p><p>如果没有调用 override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)，ImageView 宽度会是 match_parent 的效果，且如果 dontTransform()，那么高度也是 match_parent 效果。调用了 override 之后会显示的图片的真实尺寸。</p><p>带着这个问题，到源码中看看是怎么回事。</p><a href=#代码分析><h3 id=代码分析><span class=hanchor arialabel=Anchor># </span>代码分析</h3></a><p>首先 dontTransform() 方法实现在 BaseRequestOptions 文件中，该方法的意思就是不使用任何 transform：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>T</span> <span class=nf>dontTransform</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isAutoCloneEnabled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clone</span><span class=o>().</span><span class=na>dontTransform</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>transformations</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>TRANSFORMATION</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>isTransformationRequired</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>TRANSFORMATION_REQUIRED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>isTransformationAllowed</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=o>|=</span> <span class=n>TRANSFORMATION_ALLOWED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>isScaleOnlyOrNoTransform</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里首先清空了 transformations，然后设置了一些标志位。这些标志位后面看到再说。然后是 override 方法，该方法的意思是只加载指定宽高的像素的图片，方法实现只是保存了参数，待后面使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>T</span> <span class=k>override</span><span class=p>(</span><span class=n>int</span> <span class=n>width</span><span class=p>,</span> <span class=n>int</span> <span class=n>height</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=k>override</span><span class=p>(</span><span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>overrideWidth</span> <span class=p>=</span> <span class=n>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>overrideHeight</span> <span class=p>=</span> <span class=n>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=p>|=</span> <span class=n>OVERRIDE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在配置完参数后，调用 into 方法开始加载图片。整个加载流程非常冗长，详情请看前面的分析文章。所以这里只挑选相关的代码，其他的会一笔带过。</p><p>先是 RequestBuilder.into(ImageView) 的实现，该方法会默认进行一些 transform 的配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=o>,</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>into</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Util</span><span class=o>.</span><span class=na>assertMainThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span> <span class=o>=</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!</span><span class=n>requestOptions</span><span class=o>.</span><span class=na>isTransformationSet</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>isTransformationAllowed</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>view</span><span class=o>.</span><span class=na>getScaleType</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// into a different target, we don&#39;t retain the transformation applied based on the previous
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// View&#39;s scale type.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getScaleType</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_CROP</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterCrop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_INSIDE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterInside</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_CENTER</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_START</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_END</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalFitCenter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_XY</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=na>clone</span><span class=o>().</span><span class=na>optionalCenterInside</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>MATRIX</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Do nothing.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>into</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>glideContext</span><span class=o>.</span><span class=na>buildImageViewTarget</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>transcodeClass</span><span class=o>),</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Executors</span><span class=o>.</span><span class=na>mainThreadExecutor</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在上面代码第 7 行的判断语句 !requestOptions.isTransformationSet()，判断的是 fields 是否含有标记位 TRANSFORMATION。</p><p>第 8 行判断语句 requestOptions.isTransformationAllowed() 判断的是 isTransformationAllowed。</p><p>对于这两个判断条件，如果调用了 dontTransform() 方法（例 2、例 4），那么显然条件 1 满足，但是条件 2 就不满足了。否则（例 1、例 3），这两个条件都是满足的，也就意味着 Glide 会有一个默认的 transform。默认的 transform 会根据 ImageView 的 ScaleType 有不同的取值。</p><p>ScaleType 与默认的 transform 之间关系如下表：</p><p>在 ImageView.initImageView() 方法中可以看到，默认的 ScaleType 为 ScaleType.FIT_CENTER。所以，此时 Glide 会默认调用 optionalFitCenter() 方法。</p><p>注意，optionalFitCenter() 方法与非 optional 的 fitCenter() 方法的差别在于 isTransformationRequired 参数的值不同。在最后 DecodeHelper.getTransformation(Class) 方法中，如果找不到可用的 transform，且 isTransformationRequired 为 true，就会抛出 IllegalArgumentException。除此之外两者没有别的差别。</p><p>optionalFitCenter() 方法会针对四种不同类型的数据产生不同的 transformation：</p><p>现在可以开始加载图片了，最开始会调用 SingleRequest.begin 方法，在该方法中会判断需要显示多大尺寸的图片。如果指定了 override(int, int)（例 3、例 4），那么就无需 ViewTarget 参与计算，直接调用 onSizeReady(int, int) 开始下一步；否则（例 1、例 2）就要计算了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>begin</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>model</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isValidDimensions</span><span class=o>(</span><span class=n>overrideWidth</span><span class=o>,</span> <span class=n>overrideHeight</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>width</span> <span class=o>=</span> <span class=n>overrideWidth</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>height</span> <span class=o>=</span> <span class=n>overrideHeight</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=o>.</span><span class=na>RUNNING</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Cannot restart a running request&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=o>.</span><span class=na>COMPLETE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>onResourceReady</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>MEMORY_CACHE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Restarts for requests that are neither complete nor running can be treated as new requests
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// and can run again from the beginning.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=o>.</span><span class=na>WAITING_FOR_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isValidDimensions</span><span class=o>(</span><span class=n>overrideWidth</span><span class=o>,</span> <span class=n>overrideHeight</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>onSizeReady</span><span class=o>(</span><span class=n>overrideWidth</span><span class=o>,</span> <span class=n>overrideHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>((</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=o>.</span><span class=na>RUNNING</span> <span class=o>||</span> <span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=o>.</span><span class=na>WAITING_FOR_SIZE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>canNotifyStatusChanged</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=na>onLoadStarted</span><span class=o>(</span><span class=n>getPlaceholderDrawable</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>显然，造成示例中图片尺寸差异的一个原因就是这个第 27 行的 target.getSize(this) 方法了。对应方法的实现在 ViewTarget 中，这个请求会转发给内部的 SizeDeterminer 来完成。看一下 ViewTarget.SizeDeterminer 类：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>SizeDeterminer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>getSize</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>SizeReadyCallback</span> <span class=n>cb</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>currentWidth</span> <span class=o>=</span> <span class=n>getTargetWidth</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>currentHeight</span> <span class=o>=</span> <span class=n>getTargetHeight</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isViewStateAndSizeValid</span><span class=o>(</span><span class=n>currentWidth</span><span class=o>,</span> <span class=n>currentHeight</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cb</span><span class=o>.</span><span class=na>onSizeReady</span><span class=o>(</span><span class=n>currentWidth</span><span class=o>,</span> <span class=n>currentHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=nf>getTargetHeight</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>verticalPadding</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getPaddingTop</span><span class=o>()</span> <span class=o>+</span> <span class=n>view</span><span class=o>.</span><span class=na>getPaddingBottom</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LayoutParams</span> <span class=n>layoutParams</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>layoutParamSize</span> <span class=o>=</span> <span class=n>layoutParams</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>layoutParams</span><span class=o>.</span><span class=na>height</span> <span class=o>:</span> <span class=n>PENDING_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getTargetDimen</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span> <span class=n>layoutParamSize</span><span class=o>,</span> <span class=n>verticalPadding</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=nf>getTargetWidth</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>horizontalPadding</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getPaddingLeft</span><span class=o>()</span> <span class=o>+</span> <span class=n>view</span><span class=o>.</span><span class=na>getPaddingRight</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LayoutParams</span> <span class=n>layoutParams</span> <span class=o>=</span> <span class=n>view</span><span class=o>.</span><span class=na>getLayoutParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>layoutParamSize</span> <span class=o>=</span> <span class=n>layoutParams</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>layoutParams</span><span class=o>.</span><span class=na>width</span> <span class=o>:</span> <span class=n>PENDING_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getTargetDimen</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span> <span class=n>layoutParamSize</span><span class=o>,</span> <span class=n>horizontalPadding</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先在第 3、4 行调用方法获取 Target 的宽高，由于在本例中宽高都是 WRAP_CONTENT，而且也没有其他的限制，所以最后调用 getTargetDimen 时传入的参数都是一样的 (viewSize=0, paramSize=WRAP_CONTENT=-2, paddingSize=0)。然后，看看 getTargetDimen 方法的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>getTargetDimen</span><span class=o>(</span><span class=kt>int</span> <span class=n>viewSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>paramSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>paddingSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We consider the View state as valid if the View has non-null layout params and a non-zero
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// layout params width and height. This is imperfect. We&#39;re making an assumption that View
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// parents will obey their child&#39;s layout parameters, which isn&#39;t always the case.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>adjustedParamSize</span> <span class=o>=</span> <span class=n>paramSize</span> <span class=o>-</span> <span class=n>paddingSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>adjustedParamSize</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>adjustedParamSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Since we always prefer layout parameters with fixed sizes, even if waitForLayout is true,
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// we might as well ignore it and just return the layout parameters above if we have them.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Otherwise we should wait for a layout pass before checking the View&#39;s dimensions.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>waitForLayout</span> <span class=o>&amp;&amp;</span> <span class=n>view</span><span class=o>.</span><span class=na>isLayoutRequested</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>PENDING_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// We also consider the View state valid if the View has a non-zero width and height. This
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// means that the View has gone through at least one layout pass. It does not mean the Views
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// width and height are from the current layout pass. For example, if a View is re-used in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// RecyclerView or ListView, this width/height may be from an old position. In some cases
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// the dimensions of the View at the old position may be different than the dimensions of the
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// View in the new position because the LayoutManager/ViewParent can arbitrarily decide to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// change them. Nevertheless, in most cases this should be a reasonable choice.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>adjustedViewSize</span> <span class=o>=</span> <span class=n>viewSize</span> <span class=o>-</span> <span class=n>paddingSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>adjustedViewSize</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>adjustedViewSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Finally we consider the view valid if the layout parameter size is set to wrap_content.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// It&#39;s difficult for Glide to figure out what to do here. Although Target.SIZE_ORIGINAL is a
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// coherent choice, it&#39;s extremely dangerous because original images may be much too large to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// fit in memory or so large that only a couple can fit in memory, causing OOMs. If users want
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// the original image, they can always use .override(Target.SIZE_ORIGINAL). Since wrap_content
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// may never resolve to a real size unless we load something, we aim for a square whose length
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// is the largest screen size. That way we&#39;re loading something and that something has some
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// hope of being downsampled to a size that the device can support. We also log a warning that
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// tries to explain what Glide is doing and why some alternatives are preferable.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Since WRAP_CONTENT is sometimes used as a default layout parameter, we always wait for
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// layout to complete before using this fallback parameter (ConstraintLayout among others).
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!</span><span class=n>view</span><span class=o>.</span><span class=na>isLayoutRequested</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>paramSize</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=o>.</span><span class=na>WRAP_CONTENT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>INFO</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>i</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Glide treats LayoutParams.WRAP_CONTENT as a request for an image the size of&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; this device&#39;s screen dimensions. If you want to load the original image and are&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; ok with the corresponding memory cost and OOMs (depending on the input size), use&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; .override(Target.SIZE_ORIGINAL). Otherwise, use LayoutParams.MATCH_PARENT, set&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; layout_width and layout_height to fixed dimension, or use .override() with fixed&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; dimensions.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getMaxDisplayLength</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If the layout parameters are &lt; padding, the view size is &lt; padding, or the layout
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// parameters are set to match_parent or wrap_content and no layout has occurred, we should
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// wait for layout and repeat.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>PENDING_SIZE</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 getTargetDimen 方法中会通过参数计算 Target 的尺寸，显然这里最后会调用 getMaxDisplayLength(view.getContext()) 来返回 View 的尺寸。至于为什么 wrap_content 时会这样做，在注释中说的很清楚了，主要是考虑到加载的资源的不确定性，万一是一个大图片就直接 OOM 了。而且 Glide 会打印出 log 告诉我们一些解决方法，如果我们不满意这种处理方式。</p><p>getMaxDisplayLength(Context) 会返回 Display size 宽高的较大者：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Use the maximum to avoid depending on the device&#39;s current orientation.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getMaxDisplayLength</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>maxDisplayLength</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>WindowManager</span> <span class=n>windowManager</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=o>(</span><span class=n>WindowManager</span><span class=o>)</span> <span class=n>context</span><span class=o>.</span><span class=na>getSystemService</span><span class=o>(</span><span class=n>Context</span><span class=o>.</span><span class=na>WINDOW_SERVICE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Display</span> <span class=n>display</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>windowManager</span><span class=o>).</span><span class=na>getDefaultDisplay</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Point</span> <span class=n>displayDimensions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Point</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>display</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=n>displayDimensions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>maxDisplayLength</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>max</span><span class=o>(</span><span class=n>displayDimensions</span><span class=o>.</span><span class=na>x</span><span class=o>,</span> <span class=n>displayDimensions</span><span class=o>.</span><span class=na>y</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>maxDisplayLength</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>显然，在示例中，最后获取到的宽高都是一样的，在竖屏状态下会是 Display 的高。</p><p><strong>Display#getSize 与 Display#getRealSize 的区别？</strong></p><p>Display#getRealSize 返回的是屏幕真实的尺寸；而 Display#getSize 返回的是“可用”的屏幕尺寸，常见的情况是，有 NavigationBar 就会等于 RealSize 减去 NavigationBar 的高度。</p><p>获取到了 Target 的尺寸之后，会调用 isViewStateAndSizeValid 方法检查是否 OK：OK 就调用 SingleRequest.onSizeReady 方法进入下一步了；否则会给 ViewTree 添加 OnPreDrawListener 监听器，在 onPreDraw 方法回调中再次获取一下尺寸。</p><p>在经过一系列操作，加载到原始数据之后，会现在 DecodePath.decode 中对原始 data 进行 decode，这样就得到了 Bitmap，但是过程中涉及到 Bitmap 尺寸的操作。具体经过 ByteBufferBitmapDecoder 到 Downsampler#decodeFromWrappedStreams 方法中。里面绝大多数都是计算，这里拿例 1 来描述计算过程：</p><ol><li>获取 Bitmap 的宽高：sourceWidth=540,sourceHeight=258；获取 Target 的宽高：targetWidth=targetHeight=1776</li><li>调用 calculateScaling 方法计算 inSampleSize、inTargetDensity、inDensity 等一系列参数，这里会用到 DownsampleStrategy.FitCenter 类，该对象在前面 optionalFitCenter() 过程保存的 KV 表格中提到过。其 getScaleFactor 方法实现就是取 target 宽高 / source 宽高的较小者，也就是 3.288889，该值由 inTargetDensity/inDensity 保存。</li><li>最后计算 expectedWidth=round(540<em>3.288889)=1776，expectedHeight=round(258</em>3.288889)=849，并从 BitmapPool 中获取这么一个宽高的 Bitmap 设置给 Options.inBitmap</li><li>再次进行解码，解码完毕后获得的图片就是 1776x849 大小的图片了。</li></ol><p>如果是 dontTransform（例 2），DownsampleStrategy 会是默认值 DownsampleStrategy.CenterOutside。其 getScaleFactor 方法实现就是取 target 宽高 / source 宽高的较大者，也就是 6.883721。因此最后解码完毕的图片大小为 3717x1776。</p><p>如果是 override 过的（例 3、例 4），由于不需要缩放，所以返回的就是原始大小的图片。</p><p>在 decode 完毕后，会回到 DecodeJob.onResourceDecoded 方法中接着进行 transform 操作：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=o>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceSubClass</span> <span class=o>=</span> <span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;)</span> <span class=n>decoded</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>decoded</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>dataSource</span> <span class=o>!=</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getTransformation</span><span class=o>(</span><span class=n>resourceSubClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>transformed</span> <span class=o>=</span> <span class=n>appliedTransformation</span><span class=o>.</span><span class=na>transform</span><span class=o>(</span><span class=n>glideContext</span><span class=o>,</span> <span class=n>decoded</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在这里首先判断是不是 DataSource.RESOURCE_DISK_CACHE，如果不是才需要进行 transform。</p><p><strong>But, why?</strong> Glide 中很重要的概念——resource 和 data：差别在于 resource 是已经 transform 过了的，即 transform(data)=resource。所以，我们知道 resource 已经经过 transform 过了，自然就不再需要。</p><p>对于调用过 dontTransform() 方法的例子（例 2、例 4）来说，decodeHelper.getTransformation 返回的是一个 UnitTransformation，其 transform 没有干任何有意义的事情，也就是说不进行 transform。</p><p>对于普通的 Glide 加载请求（例 1、例 3）来说，一个 URL 已经经过一系列 Registry 的变换，到这里就变成 了 Bitmap.class，所以在第 11 行调用的是 FitCenter().transform(Context, Resource<bitmap>, int, int )方法。而 FitCenter 又是 BitmapTransformation 的子类，所以先看看 BitmapTransformation：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>BitmapTransformation</span> <span class=kd>implements</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>final</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>transform</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>Util</span><span class=o>.</span><span class=na>isValidDimensions</span><span class=o>(</span><span class=n>outWidth</span><span class=o>,</span> <span class=n>outHeight</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Cannot apply transformation on width: &#34;</span> <span class=o>+</span> <span class=n>outWidth</span> <span class=o>+</span> <span class=s>&#34; or height: &#34;</span> <span class=o>+</span> <span class=n>outHeight</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; less than or equal to zero and not Target.SIZE_ORIGINAL&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>BitmapPool</span> <span class=n>bitmapPool</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>).</span><span class=na>getBitmapPool</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Bitmap</span> <span class=n>toTransform</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>targetWidth</span> <span class=o>=</span> <span class=n>outWidth</span> <span class=o>==</span> <span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span> <span class=o>?</span> <span class=n>toTransform</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>:</span> <span class=n>outWidth</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>targetHeight</span> <span class=o>=</span> <span class=n>outHeight</span> <span class=o>==</span> <span class=n>Target</span><span class=o>.</span><span class=na>SIZE_ORIGINAL</span> <span class=o>?</span> <span class=n>toTransform</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()</span> <span class=o>:</span> <span class=n>outHeight</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Bitmap</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>transform</span><span class=o>(</span><span class=n>bitmapPool</span><span class=o>,</span> <span class=n>toTransform</span><span class=o>,</span> <span class=n>targetWidth</span><span class=o>,</span> <span class=n>targetHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>toTransform</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>transformed</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>BitmapResource</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>transformed</span><span class=o>,</span> <span class=n>bitmapPool</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kd>abstract</span> <span class=n>Bitmap</span> <span class=nf>transform</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>toTransform</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先做 sanity check，然后获取 targetWidth、targetHeight。如果指定了 override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)，这里会是图片的真实尺寸，否则就是 Target 的尺寸了。</p><p>然后调用抽象方法进行 transform 操作，并返回 transform 后的结果。显然，transform 抽象方法就是子类需要实现的了，所以看看 FitCenter 的方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>FitCenter</span> <span class=kd>extends</span> <span class=n>BitmapTransformation</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ID</span> <span class=o>=</span> <span class=s>&#34;com.bumptech.glide.load.resource.bitmap.FitCenter&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>ID_BYTES</span> <span class=o>=</span> <span class=n>ID</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(</span><span class=n>CHARSET</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Bitmap</span> <span class=nf>transform</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>toTransform</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>TransformationUtils</span><span class=o>.</span><span class=na>fitCenter</span><span class=o>(</span><span class=n>pool</span><span class=o>,</span> <span class=n>toTransform</span><span class=o>,</span> <span class=n>outWidth</span><span class=o>,</span> <span class=n>outHeight</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>o</span> <span class=k>instanceof</span> <span class=n>FitCenter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ID</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateDiskCacheKey</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>messageDigest</span><span class=o>.</span><span class=na>update</span><span class=o>(</span><span class=n>ID_BYTES</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到 FitCenter.transform 方法直接调用了 TransformationUtils 的 fitCenter 方法。除此之外，需要注意一下 equals、hashCode、updateDiskCacheKey 方法，这三个方法要重写的原因是因为 transform 会作为 key 的组成部分，参与到 key 的比较、缓存读写时 safeKey 生成，具体内容可以参考之前分析的文章。</p><p>至于 TransformationUtils 类，该类里面有很多处理图片的静态方法，内置的几种 BitmapTransformation 都是调用该工具类里面对应的方法来完成 transform 功能的。这里只看 fitCenter 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Bitmap</span> <span class=nf>fitCenter</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>inBitmap</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>==</span> <span class=n>width</span> <span class=o>&amp;&amp;</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()</span> <span class=o>==</span> <span class=n>height</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;requested target size matches input, returning input&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inBitmap</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=kt>float</span> <span class=n>widthPercentage</span> <span class=o>=</span> <span class=n>width</span> <span class=o>/</span> <span class=o>(</span><span class=kt>float</span><span class=o>)</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=kt>float</span> <span class=n>heightPercentage</span> <span class=o>=</span> <span class=n>height</span> <span class=o>/</span> <span class=o>(</span><span class=kt>float</span><span class=o>)</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=kt>float</span> <span class=n>minPercentage</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>widthPercentage</span><span class=o>,</span> <span class=n>heightPercentage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Round here in case we&#39;ve decoded exactly the image we want, but take the floor below to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// avoid a line of garbage or blank pixels in images.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>targetWidth</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>round</span><span class=o>(</span><span class=n>minPercentage</span> <span class=o>*</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>targetHeight</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>round</span><span class=o>(</span><span class=n>minPercentage</span> <span class=o>*</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>==</span> <span class=n>targetWidth</span> <span class=o>&amp;&amp;</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()</span> <span class=o>==</span> <span class=n>targetHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;adjusted target size matches input, returning input&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inBitmap</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Take the floor of the target width/height, not round. If the matrix
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// passed into drawBitmap rounds differently, we want to slightly
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// overdraw, not underdraw, to avoid artifacts from bitmap reuse.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>targetWidth</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>minPercentage</span> <span class=o>*</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>targetHeight</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=o>(</span><span class=n>minPercentage</span> <span class=o>*</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Bitmap</span><span class=o>.</span><span class=na>Config</span> <span class=n>config</span> <span class=o>=</span> <span class=n>getNonNullConfig</span><span class=o>(</span><span class=n>inBitmap</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Bitmap</span> <span class=n>toReuse</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>targetWidth</span><span class=o>,</span> <span class=n>targetHeight</span><span class=o>,</span> <span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// We don&#39;t add or remove alpha, so keep the alpha setting of the Bitmap we were given.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>TransformationUtils</span><span class=o>.</span><span class=na>setAlpha</span><span class=o>(</span><span class=n>inBitmap</span><span class=o>,</span> <span class=n>toReuse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;request: &#34;</span> <span class=o>+</span> <span class=n>width</span> <span class=o>+</span> <span class=s>&#34;x&#34;</span> <span class=o>+</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;toFit:   &#34;</span> <span class=o>+</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;x&#34;</span> <span class=o>+</span> <span class=n>inBitmap</span><span class=o>.</span><span class=na>getHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;toReuse: &#34;</span> <span class=o>+</span> <span class=n>toReuse</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;x&#34;</span> <span class=o>+</span> <span class=n>toReuse</span><span class=o>.</span><span class=na>getHeight</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;minPct:   &#34;</span> <span class=o>+</span> <span class=n>minPercentage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Matrix</span> <span class=n>matrix</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Matrix</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>matrix</span><span class=o>.</span><span class=na>setScale</span><span class=o>(</span><span class=n>minPercentage</span><span class=o>,</span> <span class=n>minPercentage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>applyMatrix</span><span class=o>(</span><span class=n>inBitmap</span><span class=o>,</span> <span class=n>toReuse</span><span class=o>,</span> <span class=n>matrix</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>toReuse</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>该方法最开始会检查尺寸是否需要进行缩放，对于 override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)（例 3）来说，显然是不需要的，所以就直接返回了。</p><p>否则，对于例 1 来说，需要继续执行后面的代码显示合适的图片。由于 Bitmap 的宽高在 encode 过程中计算出来了，为 1776x849，而传入的 width、height 为 1776，显然 minPercentage 会取 widthPercentage，也就意味着会按照屏幕的宽度进行缩放。但 widthPercentage 为 1，所以导致第 18 行的判断条件为 true，因此直接返回了图片。</p><p>后面就是纯粹的展示问题了，在 DrawableImageViewTarget.setResource 方法中会将上面的图片设置到 ImageView 中，此时 ImageView 宽高都是 0，resource 的宽高为 1776x849。下面怎么显示就是 ImageView 决 定的了。</p><p>下面对四个例子做一个小结：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031849.png width=auto alt></p><p>各例子之所以表现各不一样，其原因就在于 decode 出来的图片的尺寸不一致，而使用 wrap_content 宽高的 ImageView 加载这些图片，就会造成这些效果。</p><a href=#glide-自带的-transformation><h2 id=glide-自带的-transformation><span class=hanchor arialabel=Anchor># </span>Glide 自带的 Transformation</h2></a><p>在上一节遇到的 FitCenter、CenterOutside 这两个 BitmapTransformation 都是 Glide 自带的，除了这两个外还有其他四个自带的。这些 BitmapTransformation 的名称和作用如下：</p><ul><li>CenterInside：如果图片的尺小于等于 target，图片保持不变；否则会调用 fitCenter。</li><li>FitCenter：等比缩放，使得图片的一条边和 target 相同，另外一边小于给定的 target。</li><li>CenterCrop：首先缩放图片，使图片的宽和给定的宽相等，且图片的高大于给定的高。或者高相等，图片的宽大于给定的宽。然后 crop，使较大的一边的像素和给定的相同。这种缩放最终效果显然不是等比缩放。</li><li>Rotate：旋转 Bitmap</li><li>RoundedCorners：圆角，单位是 pixel</li><li>CircleCrop：圆形</li></ul><p>前面三个我们非常熟悉了，和 ImageView 的 ScaleType 有对应关系，所以下面的示例用来演示一下后面的三个 Transformation。</p><p>布局文件很简单，一个参照的 ImageView + 三个显示对应效果的 ImageView:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;android.support.constraint.ConstraintLayout</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:app=</span><span class=s>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;android.support.constraint.Guideline</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintGuide_percent=</span><span class=s>&#34;0.5&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:orientation=</span><span class=s>&#34;vertical&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/ivGlide1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;@id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toTopOf=</span><span class=s>&#34;parent&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/ivGlide2&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;@id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toTopOf=</span><span class=s>&#34;parent&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/ivGlide3&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;@id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/ivGlide1&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImageView</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/ivGlide4&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;@id/guideline&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/ivGlide2&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;android.support.design.widget.FloatingActionButton</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/fab&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_margin=</span><span class=s>&#34;24dp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:src=</span><span class=s>&#34;@drawable/btn_camera&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:layout_constraintBottom_toBottomOf=</span><span class=s>&#34;parent&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/android.support.constraint.ConstraintLayout&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>源文件也比较简单：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=c1>// private const val URL = &#34;http://cn.bing.com/az/hprichbg/rb/Dongdaemun_ZH-CN10736487148_1920x1080.jpg&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>transform</span><span class=p>(</span><span class=n>FitCenter</span><span class=p>(),</span> <span class=n>Rotate</span><span class=p>(</span><span class=m>180</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>transform</span><span class=p>(</span><span class=n>MultiTransformation</span><span class=p>(</span><span class=n>FitCenter</span><span class=p>(),</span> <span class=n>RoundedCorners</span><span class=p>(</span><span class=m>303</span> <span class=n>ushr</span> <span class=m>1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>transform</span><span class=p>(</span><span class=n>CircleCrop</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide4</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Rotate、RoundedCorners、CircleCrop 效果图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031855.png width=auto alt></p><p>看完图后，这三个 Transformation 的特点一目了然了。注意上面第 2、3 个加载时，因为 ImageView 高度为 wrap_content，所以需要加上 FitCenter，使 Bitmap 的宽高达到我们的预期（图片宽高为 1920<em>1080，ImageView 宽度为 540，因此高度为 (540/1920</em>1080=303.75，转为 int 后为 303)），然后在此基础上进行圆角或圆形处理。</p><p>Glide 使用 map 保存 transformation，所以调用多个 transform 方法，只有最后一个才会生效。如果我们想要使用多个 transformation，可以使用 MultiTransformation 类或者 transforms(Transformation<bitmap>&mldr;) 以及 transform(Transformation<bitmap>&mldr;) 方法。</p><a href=#自定义-bitmaptransformation><h2 id=自定义-bitmaptransformation><span class=hanchor arialabel=Anchor># </span>自定义 BitmapTransformation</h2></a><p>如果我们想 transform Bitmap，继承 BitmapTransformation 是最好的方式了。BitmapTransformation 为我们处理了一些基础的东西，例如，如果 Transformation 返回了一个新的 Bitmap， BitmapTransformation 将负责提取和回收原始的 Bitmap。</p><p>下面是一个简单的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>FillSpace</span> <span class=kd>extends</span> <span class=n>BitmapTransformation</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ID</span> <span class=o>=</span> <span class=s>&#34;com.bumptech.glide.transformations.FillSpace&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ID_BYTES</span> <span class=o>=</span> <span class=n>ID</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(</span><span class=n>STRING_CHARSET_NAME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Bitmap</span> <span class=nf>transform</span><span class=o>(</span><span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=n>Bitmap</span> <span class=n>toTransform</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>toTransform</span><span class=o>.</span><span class=na>getWidth</span><span class=o>()</span> <span class=o>==</span> <span class=n>outWidth</span> <span class=o>&amp;&amp;</span> <span class=n>toTransform</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()</span> <span class=o>==</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>toTransform</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Bitmap</span><span class=o>.</span><span class=na>createScaledBitmap</span><span class=o>(</span><span class=n>toTransform</span><span class=o>,</span> <span class=n>outWidth</span><span class=o>,</span> <span class=n>outHeight</span><span class=o>,</span> <span class=cm>/*filter=*/</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>o</span> <span class=k>instanceof</span> <span class=n>FillSpace</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>ID</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateDiskCacheKey</span><span class=o>(</span><span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>UnsupportedEncodingException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>messageDigest</span><span class=o>.</span><span class=na>update</span><span class=o>(</span><span class=n>ID_BYTES</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的例子虽然简单，但是包含了必须实现的方法：</p><ol><li>transform 是该类存在的意义，作用不言而喻。</li><li>第一个参数 pool，这个是 Glide 中的一个 Bitmap 缓存池，用于对 Bitmap 对象进行重用，否则每次图片变换都重新创建 Bitmap 对象将会非常消耗内存。</li><li>第二个参数 toTransform，这个是原始图片的 Bitmap 对象，我们就是要对它来进行图片变换。</li><li>第三和第四个参数比较简单，分别代表图片变换后的宽度和高度，其实也就是 override() 方法中传入的宽和高的值了。</li><li>equals、hashCode、updateDiskCacheKey 三个方法必须实现，因为磁盘缓存和内存缓存都需要这个。详情可以看之前的分析文章。</li></ol><p>此外，如果自定义的 BitmapTransformation 有构造参数，那么 equals、hashCode、updateDiskCacheKey 三个方法也需要对构造参数做处理。比如 RoundedCorners：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>RoundedCorners</span> <span class=kd>extends</span> <span class=n>BitmapTransformation</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ID</span> <span class=o>=</span> <span class=s>&#34;com.bumptech.glide.load.resource.bitmap.RoundedCorners&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>ID_BYTES</span> <span class=o>=</span> <span class=n>ID</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(</span><span class=n>CHARSET</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>roundingRadius</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * @param roundingRadius the corner radius (in device-specific pixels).
</span></span></span><span class=line><span class=cl><span class=cm>   * @throws IllegalArgumentException if rounding radius is 0 or less.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>RoundedCorners</span><span class=o>(</span><span class=kt>int</span> <span class=n>roundingRadius</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkArgument</span><span class=o>(</span><span class=n>roundingRadius</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>,</span> <span class=s>&#34;roundingRadius must be greater than 0.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>roundingRadius</span> <span class=o>=</span> <span class=n>roundingRadius</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Bitmap</span> <span class=nf>transform</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>BitmapPool</span> <span class=n>pool</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>toTransform</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outWidth</span><span class=o>,</span> <span class=kt>int</span> <span class=n>outHeight</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>TransformationUtils</span><span class=o>.</span><span class=na>roundedCorners</span><span class=o>(</span><span class=n>pool</span><span class=o>,</span> <span class=n>toTransform</span><span class=o>,</span> <span class=n>roundingRadius</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>o</span> <span class=k>instanceof</span> <span class=n>RoundedCorners</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>RoundedCorners</span> <span class=n>other</span> <span class=o>=</span> <span class=o>(</span><span class=n>RoundedCorners</span><span class=o>)</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>roundingRadius</span> <span class=o>==</span> <span class=n>other</span><span class=o>.</span><span class=na>roundingRadius</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Util</span><span class=o>.</span><span class=na>hashCode</span><span class=o>(</span><span class=n>ID</span><span class=o>.</span><span class=na>hashCode</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>Util</span><span class=o>.</span><span class=na>hashCode</span><span class=o>(</span><span class=n>roundingRadius</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateDiskCacheKey</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>messageDigest</span><span class=o>.</span><span class=na>update</span><span class=o>(</span><span class=n>ID_BYTES</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>byte</span><span class=o>[]</span> <span class=n>radiusData</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>4</span><span class=o>).</span><span class=na>putInt</span><span class=o>(</span><span class=n>roundingRadius</span><span class=o>).</span><span class=na>array</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>messageDigest</span><span class=o>.</span><span class=na>update</span><span class=o>(</span><span class=n>radiusData</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#appglidemodule><h1 id=appglidemodule><span class=hanchor arialabel=Anchor># </span>AppGlideModule</h1></a><p>Glide 之所以强大，另外一个重要的功能就是可以自定义模块，自定义模块功能可以将更改 Glide 配置，替换 Glide 组件等操作独立出来，使得我们能轻松地对 Glide 的各种配置进行自定义，并且又和 Glide 的图片加载逻辑没有任何交集，这也是一种低耦合编程方式的体现。</p><p>需要注意的是，更改 Glide 默认配置应该关注是否会造成性能倒退。</p><a href=#使用><h2 id=使用><span class=hanchor arialabel=Anchor># </span>使用</h2></a><p>首先，使用 kapt 将 compiler 引入到项目中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>apply</span> <span class=nl>plugin:</span> <span class=s1>&#39;kotlin-kapt&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>implementation</span> <span class=s1>&#39;com.github.bumptech.glide:glide:4.12.0&#39;</span>
</span></span><span class=line><span class=cl>  <span class=n>kapt</span> <span class=s1>&#39;com.github.bumptech.glide:compiler:4.12.0&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>并且在你的 <code>proguard.cfg</code> 中 keep 住你的 AppGlideModule 实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>-keep public class  extends com.bumptech.glide.module.AppGlideModule
</span></span><span class=line><span class=cl>-keep class com.bumptech.glide.GeneratedAppGlideModuleImpl
</span></span></code></pre></td></tr></table></div></div><p>接着，新建一个类继承自 AppGlideModule：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>isManifestParsingEnabled</span><span class=p>()</span> <span class=p>=</span> <span class=k>super</span><span class=p>.</span><span class=n>isManifestParsingEnabled</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，一共有三个方法可以进行重写，它们分别代表什么呢？</p><a href=#applyoptions><h3 id=applyoptions><span class=hanchor arialabel=Anchor># </span>applyOptions</h3></a><p>applyOptions 方法主要用于更改 Glide 默认配置，比如修改硬盘缓存路径、设置 Bitmap 的解码格式、设置 LRUCahce 大小甚至使用自定义 LRUCahce 实现或者自定义磁盘缓存实现等。下面将罗列一些常用的配置选项。</p><a href=#strong内存缓存memorycachestrong><h4 id=strong内存缓存memorycachestrong><span class=hanchor arialabel=Anchor># </span><strong>内存缓存（MemoryCache）</strong></h4></a><p>Glide 使用 LruResourceCache 作为 MemoryCache 接口的一个默认实现，使用固定大小的内存和 LRU 算法。LruResourceCache 的大小由 Glide 的 MemorySizeCalculator 类来决定，这个类主要关注设备的内存类型，设备 RAM 大小，以及屏幕分辨率。</p><p>使用 applyOptions(Context, GlideBuilder) 方法配置 MemorySizeCalculator 可以自定义 MemoryCache 的大小：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>calculator</span> <span class=p>=</span> <span class=n>MemorySizeCalculator</span><span class=p>.</span><span class=n>Builder</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>setMemoryCacheScreens</span><span class=p>(</span><span class=m>2f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setMemoryCache</span><span class=p>(</span><span class=n>LruResourceCache</span><span class=p>(</span><span class=n>calculator</span><span class=p>.</span><span class=n>memoryCacheSize</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>也可以直接覆写缓存大小：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>memoryCacheSizeBytes</span> <span class=p>=</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>20</span> <span class=c1>// 20mb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>setMemoryCache</span><span class=p>(</span><span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memoryCacheSizeBytes</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>甚至可以提供自己的 MemoryCache 实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>override</span> <span class=n>fun</span> <span class=n>applyOptions</span><span class=o>(</span><span class=n>context</span><span class=k>:</span> <span class=kt>Context</span><span class=o>,</span> <span class=n>builder</span><span class=k>:</span> <span class=kt>GlideBuilder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=n>setMemoryCache</span><span class=o>(</span><span class=nc>YourAppMemoryCacheImpl</span><span class=o>())</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strongbitmappoolstrong><h4 id=strongbitmappoolstrong><span class=hanchor arialabel=Anchor># </span><strong>BitmapPool</strong></h4></a><p>Glide 使用 LruBitmapPool 作为默认的 BitmapPool 。LruBitmapPool 是一个内存中的固定大小的 BitmapPool，使用 LRU 算法清理。默认大小基于设备的分辨率和密度，同时也考虑内存类和 isLowRamDevice 的返回值。具体的计算通过 Glide 的 MemorySizeCalculator 来完成，与 Glide 的 MemoryCache 的大小检测方法相似。</p><p>可以在 AppGlideModule 中定制 BitmapPool 的尺寸，使用 applyOptions(Context, GlideBuilder) 方法并配置 MemorySizeCalculator:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>calculator</span> <span class=p>=</span> <span class=n>MemorySizeCalculator</span><span class=p>.</span><span class=n>Builder</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>setBitmapPoolScreens</span><span class=p>(</span><span class=m>3f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setBitmapPool</span><span class=p>(</span><span class=n>LruBitmapPool</span><span class=p>(</span><span class=n>calculator</span><span class=p>.</span><span class=n>bitmapPoolSize</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>也可以直接复写这个池的大小：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>bitmapPoolSizeBytes</span> <span class=p>=</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>30</span> <span class=c1>// 30mb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>setBitmapPool</span><span class=p>(</span><span class=n>LruBitmapPool</span><span class=p>(</span><span class=n>bitmapPoolSizeBytes</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当然也可以提供 BitmapPool 的完全自定义实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>override</span> <span class=n>fun</span> <span class=n>applyOptions</span><span class=o>(</span><span class=n>context</span><span class=k>:</span> <span class=kt>Context</span><span class=o>,</span> <span class=n>builder</span><span class=k>:</span> <span class=kt>GlideBuilder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=n>setBitmapPool</span><span class=o>(</span><span class=nc>YourAppBitmapPoolImpl</span><span class=o>())</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong磁盘缓存diskcachestrong><h4 id=strong磁盘缓存diskcachestrong><span class=hanchor arialabel=Anchor># </span><strong>磁盘缓存（DiskCache）</strong></h4></a><p>Glide 使用 DiskLruCacheWrapper 作为默认的 磁盘缓存 。 DiskLruCacheWrapper 是一个使用 LRU 算法的固定大小的磁盘缓存。默认磁盘大小为 250 MB ，位置是在应用的缓存文件夹中的一个特定目录（<em>/data/data/{package}/cache/image_manager_disk_cache/</em>） 。</p><p>假如使用 Glide 展示图片内容是公开的，那么应用可以将这个缓存位置改到外部存储：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>无论使用内部或外部磁盘缓存，应用程序都可以改变磁盘缓存的大小：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>diskCacheSizeBytes</span> <span class=p>=</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>100</span><span class=p>;</span>  <span class=c1>//100 MB
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=n>diskCacheSizeBytes</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>还可以自己命名外存或内存上的缓存文件夹：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>diskCacheSizeBytes</span> <span class=p>=</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>1024</span> <span class=p>*</span> <span class=m>100</span><span class=p>;</span>  <span class=c1>//100 MB
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>cacheFolderName</span><span class=p>,</span> <span class=n>diskCacheSizeBytes</span><span class=p>.</span><span class=n>toLong</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此外，还可以自定义 DiskCache 接口的实现，并提供自己的 DiskCache.Factory 来创建缓存。Glide 使用一个工厂接口来在后台线程中打开磁盘缓存 ，这样方便缓存做诸如检查路径存在性等的 IO 操作而不用触发严格模式（StrictMode） 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>DiskCache</span><span class=p>.</span><span class=n>Factory</span> <span class=p>{</span> <span class=n>YourAppCustomDiskCache</span><span class=p>()</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong默认请求选项defaultrequestoptionsstrong><h4 id=strong默认请求选项defaultrequestoptionsstrong><span class=hanchor arialabel=Anchor># </span><strong>默认请求选项（DefaultRequestOptions）</strong></h4></a><p>虽然 RequestOptions<strong> </strong>通常由每个请求单独指定，也可以通过 AppGlideModule 应用一个 RequestOptions 的集合以作用于每次请求，比如设置 Bitmap 的解码格式为 RGB_565 (默认为 ARGB_8888)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setDefaultRequestOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>RequestOptions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>format</span><span class=p>(</span><span class=n>DecodeFormat</span><span class=p>.</span><span class=n>PREFER_RGB_565</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>disallowHardwareConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>一旦创建了新的请求，这些选项将通过 GlideBuilder 中的 setDefaultRequestOptions 被应用上。因此，任何单独请求里应用的选项将覆盖 GlideBuilder 里设置的冲突选项。</p><p>类似地，RequestManagers 允许你为这个特定的 RequestManager 启动的所有加载请求设置默认的 RequestOptions。 因为每个 Activity 和 Fragment 都拥有自己的 RequestManager，你可以使用 RequestManager 的 applyDefaultRequestOptions 方法来设置默认的 RequestOption，并仅作用于一个特定的 Activity 或 Fragment：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>Glide</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=n>fragment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>applyDefaultRequestOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>RequestOptions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>format</span><span class=p>(</span><span class=n>DecodeFormat</span><span class=p>.</span><span class=n>PREFER_RGB_565</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>disallowHardwareConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>RequestManager 还有一个 setDefaultRequestOptions 方法，可以完全替换掉之前设置的任意的默认 RequestOptions，无论它是通过 AppGlideModule 的 [GlideBuilder] 还是 RequestManager。使用 [setDefaultRequestOptions] 要小心，因为很容易意外覆盖掉其他地方设置的重要默认选项。 通常 applyDefaultRequestOptions 更安全，使用起来更直观。</p><a href=#strong未捕获异常策略-uncaughtthrowablestrategystrong><h4 id=strong未捕获异常策略-uncaughtthrowablestrategystrong><span class=hanchor arialabel=Anchor># </span><strong>未捕获异常策略 (UncaughtThrowableStrategy)</strong></h4></a><p>在加载图片时假如发生了一个异常 (例如, OOM), Glide 将会使用一个 GlideExecutor.UncaughtThrowableStrategy 。</p><p>默认策略是将异常打印到设备的 LogCat 中。 这个策略从 Glide 4.2.0 起将可被定制。 你可以传入一个 DiskCacheExecutor 和 / 或一个 SourceExecutor：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>myUncaughtThrowableStrategy</span> <span class=p>=</span> <span class=n>UncaughtThrowableStrategy</span><span class=p>.</span><span class=n>LOG</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCacheExecutor</span><span class=p>(</span><span class=n>GlideExecutor</span><span class=p>.</span><span class=n>newDiskCacheBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>setUncaughtThrowableStrategy</span> <span class=p>{</span> <span class=n>myUncaughtThrowableStrategy</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setSourceExecutor</span><span class=p>(</span><span class=n>GlideExecutor</span><span class=p>.</span><span class=n>newSourceBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>setUncaughtThrowableStrategy</span> <span class=p>{</span> <span class=n>myUncaughtThrowableStrategy</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong日志级别loglevel-strong><h4 id=strong日志级别loglevel-strong><span class=hanchor arialabel=Anchor># </span><strong>日志级别（LogLevel ）</strong></h4></a><p>可以使用 setLogLevel (结合 Android 的 Log 定义的值) 来获取格式化日志的子集，包括请求失败时的日志行。通常来说 Log.VERBOSE 粒度太细，而 Log.ERROR 又会让日志更趋向静默。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=p>.</span><span class=n>setLogLevel</span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>所有的配置选项如下</p><table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td>setBitmapPool</td><td></td></tr><tr><td>setArrayPool</td><td></td></tr><tr><td>setMemoryCache</td><td></td></tr><tr><td>setDiskCache</td><td></td></tr><tr><td>setResizeExecutor</td><td></td></tr><tr><td>setSourceExecutor</td><td></td></tr><tr><td>setDiskCacheExecutor</td><td></td></tr><tr><td>setAnimationExecutor</td><td></td></tr><tr><td>setDefaultRequestOptions</td><td></td></tr><tr><td>setDefaultTransitionOptions</td><td></td></tr><tr><td>setMemorySizeCalculator</td><td></td></tr><tr><td>setConnectivityMonitorFactory</td><td></td></tr><tr><td>setLogLevel</td><td></td></tr><tr><td>setIsActiveResourceRetentionAllowed</td><td></td></tr><tr><td>addGlobalRequestListener</td><td></td></tr><tr><td>setLogRequestOrigins</td><td></td></tr><tr><td>setImageDecoderEnabledForBitmaps</td><td></td></tr></tbody></table><a href=#ismanifestparsingenabled><h3 id=ismanifestparsingenabled><span class=hanchor arialabel=Anchor># </span>isManifestParsingEnabled</h3></a><p>在 Glide v3 中，使用自定义模块需要在 AndroidManifest.xml 文件中通过 meta-data 进行配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;application</span>
</span></span><span class=line><span class=cl>    <span class=err>...</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;meta-data</span>
</span></span><span class=line><span class=cl>        <span class=na>android:name=</span><span class=s>&#34;xxx.xxx.MyGlideModule&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:value=</span><span class=s>&#34;GlideModule&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;activity</span> <span class=err>...</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/application&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>MyGlideModule 代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyGlideModule</span> <span class=p>:</span> <span class=n>GlideModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>为了维持对 Glide v3 的 GlideModules 的向后兼容性，Glide 仍然会解析应用程序和所有被包含的库中的 AndroidManifest.xml 文件，并包含在这些清单中列出的旧 GlideModules 模块类。</p><p>如果你已经迁移到 Glide v4 的 AppGlideModule 和 LibraryGlideModule ，你可以完全禁用清单解析。这样可以改善 Glide 的初始启动时间，并避免尝试解析元数据时的一些潜在问题。要禁用清单解析，可以在 AppGlideModule 实现中复写 isManifestParsingEnabled() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>isManifestParsingEnabled</span><span class=p>()</span> <span class=p>=</span> <span class=k>false</span>
</span></span></code></pre></td></tr></table></div></div><a href=#registercomponents><h3 id=registercomponents><span class=hanchor arialabel=Anchor># </span>registerComponents</h3></a><p>应用程序和库都可以注册很多组件来扩展 Glide 的功能。可用的组件包括：</p><ol><li>ModelLoader, 用于加载自定义的 Model(Url, Uri,任意的 POJO )和 Data(InputStreams, FileDescriptors)。</li><li>ResourceDecoder, 用于对新的 Resources(Drawables, Bitmaps)或新的 Data 类型(InputStreams, FileDescriptors)进行解码。</li><li>Encoder, 用于向 Glide 的磁盘缓存写 Data (InputStreams, FileDesciptors)。</li><li>ResourceTranscoder，用于在不同的资源类型之间做转换，例如，从 BitmapResource 转换为 DrawableResource 。</li><li>ResourceEncoder，用于向 Glide 的磁盘缓存写 Resources(BitmapResource, DrawableResource)。</li></ol><p>组件通过 Registry 类来注册。例如，添加一个 ModelLoader ，使其能从自定义的 Model 对象中创建一个 InputStream ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=n>Photo</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span> <span class=n>Factory</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在一个 GlideModule 里可以注册很多组件。ModelLoader 和 ResourceDecoder 对于同样的参数类型还可以有多种实现。</p><p>在前文的分析中知道了，Glide 加载网络图片默认使用的是 HttpUrlConnection，如果想把这个位置的实现替换成 OkHttp3 或者 Volley 实现可以吗？显然是可以的，而且官方也提供了这个功能：</p><ul><li><a href=http://bumptech.github.io/glide/int/okhttp3.html rel=noopener>OkHttp3</a></li><li><a href=http://bumptech.github.io/glide/int/volley.html rel=noopener>Volley</a></li></ul><p>以 OkHttp3 为例，用起来很简单，只需要集成一个 library 即可，非常符合 Glide 的风格。build.gradle 的配置如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.github.bumptech.glide:okhttp3-integration:4.12.0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>首先找到里面的 @GlideModule 修饰的类，而且应该是一个 LibraryGlideModule 类：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>final</span> <span class=k>class</span> <span class=nc>OkHttpLibraryGlideModule</span> <span class=k>extends</span> <span class=nc>LibraryGlideModule</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=n>public</span> <span class=n>void</span> <span class=n>registerComponents</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=nc>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=nc>Glide</span> <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=nc>Registry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=n>replace</span><span class=o>(</span><span class=nc>GlideUrl</span><span class=o>.</span><span class=n>class</span><span class=o>,</span> <span class=nc>InputStream</span><span class=o>.</span><span class=n>class</span><span class=o>,</span> <span class=k>new</span> <span class=nc>OkHttpUrlLoader</span><span class=o>.</span><span class=nc>Factory</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此外，里面还发现了一个实现了 com.bumptech.glide.module.GlideModule 接口的废弃类 OkHttpGlideModule：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>OkHttpGlideModule</span> <span class=kd>implements</span> <span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>applyOptions</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Do nothing.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerComponents</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span> <span class=n>Registry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=n>GlideUrl</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=o>.</span><span class=na>Factory</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>由于我们使用的 Glide 版本为 4.x，使用了上面的 OkHttpLibraryGlideModule 并且无需在 AndroidManifest.xml 中配置，自然也用不到这个类。</p><p>回到 OkHttpLibraryGlideModule 类中，看看 registerComponents 方法的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=n>GlideUrl</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>     <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=o>.</span><span class=na>Factory</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>对于此项，Glide 的默认配置中有如下代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>GlideUrl</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>HttpGlideUrlLoader</span><span class=o>.</span><span class=na>Factory</span><span class=o>())</span>
</span></span></code></pre></td></tr></table></div></div><p>所以可以理解为，原本交给 HttpGlideUrlLoader.Factory() 处理的任务会交给 OkHttpUrlLoader.Factory() 处理。</p><p><strong>OkHttpUrlLoader</strong> 源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>OkHttpUrlLoader</span> <span class=kd>implements</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>GlideUrl</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>client</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Public API.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>OkHttpUrlLoader</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>client</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>client</span> <span class=o>=</span> <span class=n>client</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>GlideUrl</span> <span class=n>url</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>LoadData</span><span class=o>&lt;</span><span class=n>InputStream</span><span class=o>&gt;</span> <span class=nf>buildLoadData</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>GlideUrl</span> <span class=n>model</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>LoadData</span><span class=o>&lt;&gt;(</span><span class=n>model</span><span class=o>,</span> <span class=k>new</span> <span class=n>OkHttpStreamFetcher</span><span class=o>(</span><span class=n>client</span><span class=o>,</span> <span class=n>model</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** The default factory for {@link OkHttpUrlLoader}s. */</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Public API.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Factory</span> <span class=kd>implements</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>GlideUrl</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>volatile</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>internalClient</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>client</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=nf>getInternalClient</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>internalClient</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=n>Factory</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=o>(</span><span class=n>internalClient</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>internalClient</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpClient</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>internalClient</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/** Constructor for a new Factory that runs requests using a static singleton client. */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Factory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>(</span><span class=n>getInternalClient</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Constructor for a new Factory that runs requests using given client.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param client this is typically an instance of {@code OkHttpClient}.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Factory</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>client</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>client</span> <span class=o>=</span> <span class=n>client</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>GlideUrl</span><span class=o>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=nf>build</span><span class=o>(</span><span class=n>MultiModelLoaderFactory</span> <span class=n>multiFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=o>(</span><span class=n>client</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>teardown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Do nothing, this instance doesn&#39;t own the client.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，OkHttpUrlLoader.Factory 的无参构造器会使用 DCL 单例模式创建一个 OkHttpClient() 对象，其 build 方法会返回一个 new OkHttpUrlLoader(client)。</p><p>OkHttpUrlLoader.buildLoadData 方法会返回一个 fetcher 为 <strong>OkHttpStreamFetcher</strong> 的 LoadData。当需要进行加载的时候，会调用 fetcher 的 loadData 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Request</span><span class=o>.</span><span class=na>Builder</span> <span class=n>requestBuilder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Request</span><span class=o>.</span><span class=na>Builder</span><span class=o>().</span><span class=na>url</span><span class=o>(</span><span class=n>url</span><span class=o>.</span><span class=na>toStringUrl</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headerEntry</span> <span class=o>:</span> <span class=n>url</span><span class=o>.</span><span class=na>getHeaders</span><span class=o>().</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>headerEntry</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>requestBuilder</span><span class=o>.</span><span class=na>addHeader</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>headerEntry</span><span class=o>.</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>requestBuilder</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callback</span> <span class=o>=</span> <span class=n>callback</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>call</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=na>newCall</span><span class=o>(</span><span class=n>request</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFailure</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Call</span> <span class=n>call</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;OkHttp failed to obtain result&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResponse</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Call</span> <span class=n>call</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Response</span> <span class=n>response</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>responseBody</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=na>body</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>response</span><span class=o>.</span><span class=na>isSuccessful</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>contentLength</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>responseBody</span><span class=o>).</span><span class=na>contentLength</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>stream</span> <span class=o>=</span> <span class=n>ContentLengthInputStream</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>responseBody</span><span class=o>.</span><span class=na>byteStream</span><span class=o>(),</span> <span class=n>contentLength</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>callback</span><span class=o>.</span><span class=na>onDataReady</span><span class=o>(</span><span class=n>stream</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>callback</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=n>response</span><span class=o>.</span><span class=na>message</span><span class=o>(),</span> <span class=n>response</span><span class=o>.</span><span class=na>code</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>OkHttpStreamFetcher 的实现比 HttpUrlFetcher 简单多了，而且看起来也没有什么难度。</p><p>如果我们想使用 App 现有的 OkHttpClient 而不是默认创建一个新的，我们可以先 @Excludes 掉 OkHttpLibraryGlideModule；然后在 replace 的同时，在 OkHttpUrlLoader.Factory(Call.Factory) 构造时注入现有的 OkHttpClient：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=nd>@Excludes</span><span class=p>(</span><span class=n>value</span> <span class=p>=</span> <span class=p>[</span><span class=n>OkHttpLibraryGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>,</span> <span class=n>MyLibraryGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>,</span> <span class=n>MyGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>okHttpClient</span> <span class=p>=</span> <span class=n>OkHttpClient</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>connectTimeout</span><span class=p>(</span><span class=m>10</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>readTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>writeTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>addNetworkInterceptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>HttpLoggingInterceptor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Log</span><span class=p>.</span><span class=n>i</span><span class=p>(</span><span class=s2>&#34;MyAppGlideModule&#34;</span><span class=p>,</span> <span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}.</span><span class=n>apply</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>level</span> <span class=p>=</span> <span class=n>HttpLoggingInterceptor</span><span class=p>.</span><span class=n>Level</span><span class=p>.</span><span class=n>BODY</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>).</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>registry</span><span class=p>.</span><span class=n>replace</span><span class=p>(</span><span class=n>GlideUrl</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>OkHttpUrlLoader</span><span class=p>.</span><span class=n>Factory</span><span class=p>(</span><span class=n>okHttpClient</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#原理><h2 id=原理><span class=hanchor arialabel=Anchor># </span>原理</h2></a><a href=#glide-初始化流程分析><h3 id=glide-初始化流程分析><span class=hanchor arialabel=Anchor># </span>Glide 初始化流程分析</h3></a><p>之前在分析
<a href=https://ywue4d2ujm.feishu.cn/docs/doccnY69t6P4JXuanj2oz8GBp5g rel=noopener>Glide 加载流程</a>的文章中已经知道，with 方法调用过程中会调用到 Glide.get(context) 方法生成并返回全局 Glide 单例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Glide</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果有配置 @GlideModule 注解的 Module
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 这里会反射构造 kapt 生成的 GeneratedAppGlideModuleImpl 类
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>getAnnotationGeneratedGlideModules</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>Glide</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>checkAndInitializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>annotationGeneratedModule</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@GuardedBy</span><span class=o>(</span><span class=s>&#34;Glide.class&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>checkAndInitializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>GeneratedAppGlideModule</span> <span class=n>generatedAppGlideModule</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isInitializing</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;You cannot call Glide.get() in registerComponents(), use the provided Glide instance instead&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>initializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>generatedAppGlideModule</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>initializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=k>new</span> <span class=n>GlideBuilder</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果 GeneratedAppGlideModuleImpl 存在，且允许解析 manifest 文件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 则遍历 manifest 中的 meta-data，解析出所有的 GlideModule 类
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>manifestModules</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>isManifestParsingEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>manifestModules</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ManifestParser</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>).</span><span class=na>parse</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 根据 Impl 的排除名单，剔除 manifest 中的 GlideModule 类
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getExcludedModuleClasses</span><span class=o>().</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedModuleClasses</span> <span class=o>=</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getExcludedModuleClasses</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>iterator</span> <span class=o>=</span> <span class=n>manifestModules</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>iterator</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>current</span> <span class=o>=</span> <span class=n>iterator</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>excludedModuleClasses</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>current</span><span class=o>.</span><span class=na>getClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;AppGlideModule excludes manifest GlideModule: &#34;</span> <span class=o>+</span> <span class=n>current</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iterator</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>glideModule</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Discovered GlideModule from manifest: &#34;</span> <span class=o>+</span> <span class=n>glideModule</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果 Impl 存在，那么设置为该类的 RequestManagerFactory；否则设置为 null
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>RequestManagerRetriever</span><span class=o>.</span><span class=na>RequestManagerFactory</span> <span class=n>factory</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getRequestManagerFactory</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>builder</span><span class=o>.</span><span class=na>setRequestManagerFactory</span><span class=o>(</span><span class=n>factory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 依次调用 manifest 中 GlideModule 类的 applyOptions 方法，将配置写到 builder 里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>module</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 写入 Impl 的配置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 也就是说 Impl 配置的优先级更高，如果有冲突的话
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用GlideBuilder.build方法创建 Glide
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 依次调用 manifest 中 GlideModule 类的 registerComponents 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 来替换 Glide 的默认配置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>module</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>glide</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>AbstractMethodError</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Attempting to register a Glide v3 module. If you see this, you or one of your&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; dependencies may be including Glide v3 even though you&#39;re using Glide v4.&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; You&#39;ll need to find and remove (or update) the offending dependency.&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; The v3 module name is: &#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=n>module</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>          <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用 Impl 中替换 Glide 配置的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>glide</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 注册内存管理的回调，因为 Glide 实现了 ComponentCallbacks2 接口
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>applicationContext</span><span class=o>.</span><span class=na>registerComponentCallbacks</span><span class=o>(</span><span class=n>glide</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 保存 glide 实例到静态变量中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span><span class=o>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里首先会调用 getAnnotationGeneratedGlideModules() 方法反射构造出注解处理器生成的 GeneratedAppGlideModuleImpl 对象。</p><p>接着，Glide 的创建（line 84）发生在 applyOptions 之后，registerComponents 之前。也好理解，因为 applyOptions 是更改配置，肯定是初始化时就要确定的；而 registerComponents 针对的运行时的功能扩展，而且需要调用 Glide 对象的方法，所以在 Glide 创建之后调用。</p><p>看看 GlideBuilder.build 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=n>Glide</span> <span class=nf>build</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>sourceExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sourceExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=o>.</span><span class=na>newSourceExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCacheExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=o>.</span><span class=na>newDiskCacheExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>animationExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>animationExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=o>.</span><span class=na>newAnimationExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>memorySizeCalculator</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memorySizeCalculator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MemorySizeCalculator</span><span class=o>.</span><span class=na>Builder</span><span class=o>(</span><span class=n>context</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>connectivityMonitorFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>connectivityMonitorFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultConnectivityMonitorFactory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>bitmapPool</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getBitmapPoolSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>bitmapPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruBitmapPool</span><span class=o>(</span><span class=n>size</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>bitmapPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BitmapPoolAdapter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>arrayPool</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruArrayPool</span><span class=o>(</span><span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getArrayPoolSizeInBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=o>(</span><span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getMemoryCacheSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>engine</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>engine</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Engine</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>memoryCache</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>diskCacheFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>diskCacheExecutor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>sourceExecutor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>GlideExecutor</span><span class=o>.</span><span class=na>newUnlimitedSourceExecutor</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>animationExecutor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>isActiveResourceRetentionAllowed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>defaultRequestListeners</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>defaultRequestListeners</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>defaultRequestListeners</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>unmodifiableList</span><span class=o>(</span><span class=n>defaultRequestListeners</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>GlideExperiments</span> <span class=n>experiments</span> <span class=o>=</span> <span class=n>glideExperimentsBuilder</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>RequestManagerRetriever</span> <span class=n>requestManagerRetriever</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>RequestManagerRetriever</span><span class=o>(</span><span class=n>requestManagerFactory</span><span class=o>,</span> <span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>engine</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>memoryCache</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>bitmapPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>arrayPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestManagerRetriever</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>connectivityMonitorFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>logLevel</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultRequestOptionsFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultTransitionOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultRequestListeners</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，build 方法基本对每一个参数都进行了 null 判断，如果为 null 则使用默认的参数。那么，这些参数什么时候不为空呢？当在 AppliesOptions 接口的实现（即前面所说的 applyOptions 方法）中通过传入参数 GlideBuilder 设置后，这里 build 时就不会为 null 了。</p><p>比如，前面举例的通过 GlideBuilder.setDiskCache 来将 diskCacheFactory 设置为我们指定的值，从而将磁盘缓存位置切换到 externalCacheDir 中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#kapt-生成文件过程分析><h3 id=kapt-生成文件过程分析><span class=hanchor arialabel=Anchor># </span>kapt 生成文件过程分析</h3></a><p>为了更好地理解 Glide 中 annotation processor 的作用，这里分别实现 AppGlideModule、LibraryGlideModule 以及 GlideModule ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=nd>@Excludes</span><span class=p>(</span><span class=n>value</span> <span class=p>=</span> <span class=p>[</span><span class=n>MyGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyLibraryGlideModule</span> <span class=p>:</span> <span class=n>LibraryGlideModule</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyGlideModule</span> <span class=p>:</span> <span class=n>GlideModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 AndroidManifest 文件中配置好 MyGlideModule 之后，我们先 rebuild 一下，看一下生成的 GeneratedAppGlideModuleImpl 文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=kd>class</span> <span class=nc>GeneratedAppGlideModuleImpl</span> <span class=kd>extends</span> <span class=n>GeneratedAppGlideModule</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>MyAppGlideModule</span> <span class=n>appGlideModule</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>GeneratedAppGlideModuleImpl</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>appGlideModule</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MyAppGlideModule</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=s>&#34;Glide&#34;</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=s>&#34;Glide&#34;</span><span class=o>,</span> <span class=s>&#34;Discovered AppGlideModule from annotation: com.me.guanpj.myapplication.MyAppGlideModule&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=s>&#34;Glide&#34;</span><span class=o>,</span> <span class=s>&#34;Discovered LibraryGlideModule from annotation: com.me.guanpj.myapplication.MyLibraryGlideModule&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>applyOptions</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>appGlideModule</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerComponents</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>Registry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>MyLibraryGlideModule</span><span class=o>().</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>appGlideModule</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isManifestParsingEnabled</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>appGlideModule</span><span class=o>.</span><span class=na>isManifestParsingEnabled</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getExcludedModuleClasses</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedClasses</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=n>excludedClasses</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>me</span><span class=o>.</span><span class=na>guanpj</span><span class=o>.</span><span class=na>myapplication</span><span class=o>.</span><span class=na>MyGlideModule</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>excludedClasses</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=n>GeneratedRequestManagerFactory</span> <span class=nf>getRequestManagerFactory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>GeneratedRequestManagerFactory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>代码很简单，属于 AppGlideModule 的三个方法基本都调用了 MyAppGlideModule 的三个配置方法。在此基础上，每个 LibraryGlideModule 的 registerComponents 方法都会在 GeneratedAppGlideModuleImpl.registerComponents 方法中被调用。</p><p>另外，我们关注一下最后两个方法，这两个方法都是基类 GeneratedAppGlideModule 额外提供了的，代码如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>GeneratedAppGlideModule</span> <span class=kd>extends</span> <span class=n>AppGlideModule</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * This method can be removed when manifest parsing is no longer supported.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=kd>abstract</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getExcludedModuleClasses</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=n>RequestManagerRetriever</span><span class=o>.</span><span class=na>RequestManagerFactory</span> <span class=nf>getRequestManagerFactory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>getRequestManagerFactory 在子类的实现是固定的，就是 return new GeneratedRequestManagerFactory()。</p><a href=#excludes><h4 id=excludes><span class=hanchor arialabel=Anchor># </span>@Excludes</h4></a><p>GeneratedAppGlideModuleImpl.getExcludedModuleClasses() 的实现，与 @Excludes 注解有关，使用该注解可以让 Glide 忽略指定的 GlideModule 或 LibraryGlideModule。@Excludes 注解只能用在 AppGlideModules 上，下面的例子将会让 Glide 忽略掉 MyLibraryGlideModule、MyGlideModule 的配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=nd>@GlideModule</span>
</span></span><span class=line><span class=cl><span class=nd>@Excludes</span><span class=o>(</span><span class=n>value</span> <span class=k>=</span> <span class=o>[</span><span class=kt>MyLibraryGlideModule::class</span>, <span class=kt>MyGlideModule::class</span><span class=o>])</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=k>:</span> <span class=kt>AppGlideModule</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>此时 rebuild 之后，生成的 GeneratedAppGlideModuleImpl 文件的相关方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=k>void</span> <span class=nx>registerComponents</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Context</span> <span class=nx>context</span><span class=p>,</span> <span class=kd>@NonNull</span> <span class=nx>Glide</span> <span class=nx>glide</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@NonNull</span> <span class=nx>Registry</span> <span class=nx>registry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 注意，没有new MyLibraryGlideModule().registerComponents(context, glide, registry);了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>appGlideModule</span><span class=p>.</span><span class=nx>registerComponents</span><span class=p>(</span><span class=nx>context</span><span class=p>,</span> <span class=nx>glide</span><span class=p>,</span> <span class=nx>registry</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>Set</span><span class=p>&lt;</span><span class=nt>Class</span><span class=err>&lt;?</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>getExcludedModuleClasses() {</span>
</span></span><span class=line><span class=cl>    <span class=nx>Set</span><span class=p>&lt;</span><span class=nt>Class</span><span class=err>&lt;?</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>excludedClasses</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>HashSet</span><span class=p>&lt;</span><span class=nt>Class</span><span class=err>&lt;?</span><span class=p>&gt;</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>excludedClasses</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>com</span><span class=p>.</span><span class=nx>me</span><span class=p>.</span><span class=nx>guanpj</span><span class=p>.</span><span class=nx>myapplication</span><span class=p>.</span><span class=nx>MyGlideModule</span><span class=p>.</span><span class=kr>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>excludedClasses</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>com</span><span class=p>.</span><span class=nx>me</span><span class=p>.</span><span class=nx>guanpj</span><span class=p>.</span><span class=nx>myapplication</span><span class=p>.</span> <span class=nx>MyLibraryGlideModule</span><span class=p>.</span><span class=kr>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>excludedClasses</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后在 Glide 初始化的时候，在方法返回结果 set 里面的 GlideModule 将会从集合中移除。</p><a href=#glideextension><h4 id=glideextension><span class=hanchor arialabel=Anchor># </span>@GlideExtension</h4></a><p>@GlideExtension 注解修饰的类可以扩展 Glide 的 API。该类必须是工具类的形式，里面的方法必须都是静态的，除了私有的空实现的构造器。</p><p>Application 可以实现多个 @GlideExtension 注解类，Library 也可以实现任意数量的 @GlideExtension 注解类。Glide 在编译时，一旦发现一个 AppGlideModule，所有可用的 GlideExtension 都会合并，并生成单个的 API 文件。任何冲突都会导致 Glide 注解生成器的编译错误。</p><p>GlideExtension 注解类可以定义两种扩展方法：</p><ol><li>@GlideOption——为 RequestOptions 添加自定义的配置，扩展 RequestOptions 的静态方法。常见作用有：</li><li>定义在整个应用程序中经常使用的一组选项</li><li>添加新选项，通常与 Glide 的 com.bumptech.glide.load.Option 一起使用。</li><li>@GlideType——为新资源类型（GIFs、SVG 等）添加支持，扩展 RequestManager 的静态方法</li></ol><p>下面的示例来自于官方文档 GlideExtension 的示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GlideExtension</span>
</span></span><span class=line><span class=cl><span class=k>object</span> <span class=nc>MyAppExtension</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Size of mini thumb in pixels.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>const</span> <span class=k>val</span> <span class=py>MINI</span><span class=n>_THUMB_SIZE</span> <span class=p>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>DECODE</span><span class=n>_TYPE_GIF</span> <span class=p>=</span> <span class=n>RequestOptions</span><span class=p>.</span><span class=n>decodeTypeOf</span><span class=p>(</span><span class=n>GifDrawable</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>).</span><span class=n>lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GlideOption</span>
</span></span><span class=line><span class=cl>    <span class=nd>@JvmStatic</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>miniThumb</span><span class=p>(</span><span class=n>options</span><span class=p>:</span> <span class=n>BaseRequestOptions</span><span class=p>&lt;*&gt;):</span> <span class=n>BaseRequestOptions</span><span class=p>&lt;*&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>options</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>fitCenter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=k>override</span><span class=p>(</span><span class=n>MINI_THUMB_SIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GlideType</span><span class=p>(</span><span class=n>GifDrawable</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@JvmStatic</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>asGifTest</span><span class=p>(</span><span class=n>requestBuilder</span><span class=p>:</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>GifDrawable</span><span class=p>&gt;):</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>GifDrawable</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>requestBuilder</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>transition</span><span class=p>(</span><span class=n>DrawableTransitionOptions</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_GIF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里为 RequestOptions 扩展了 miniThumb 方法，为 RequestManager 扩展了 asGifTest 方法。所以我们可以这样使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>GlideApp</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>asGifTest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>miniThumb</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>注意这里使用的不再是 Glide，而是 GlideApp。GlideApp 是专门用来处理这种扩展 API 的。</p><p>在 Glide 初始化的时候，会将 GeneratedAppGlideModuleImpl.getRequestManagerFactory() 方法返回的 GeneratedRequestManagerFactory 作为 requestManagerFactory 参数，这样创建 RequestManager 时都会调用 GeneratedRequestManagerFactory.build 方法生成 GlideRequests。</p><p><strong>GlideRequests</strong> 继承至 RequestManager，里面包含了 @GlideType 注解修饰的 API：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GlideRequests</span> <span class=kd>extends</span> <span class=n>RequestManager</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>GlideRequests</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                       <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>treeNode</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>glide</span><span class=o>,</span> <span class=n>lifecycle</span><span class=o>,</span> <span class=n>treeNode</span><span class=o>,</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * @see MyAppExtension#asGifTest(RequestBuilder)
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGifTest</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;)</span> <span class=n>MyAppExtension</span><span class=o>.</span><span class=na>asGifTest</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>as</span><span class=o>(</span><span class=n>GifDrawable</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>GlideRequest（注意没有 s）</strong> 则继承至 RequestBuilder，包含了 @GlideOption 提供的 API：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=nc>GlideRequest</span><span class=o>&lt;</span><span class=nc>TranscodeType</span><span class=o>&gt;</span> <span class=k>extends</span> <span class=nc>RequestBuilder</span><span class=o>&lt;</span><span class=nc>TranscodeType</span><span class=o>&gt;</span> <span class=n>implements</span> <span class=nc>Cloneable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * @see MyAppExtension#miniThumb(BaseRequestOptions)
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=n>public</span> <span class=nc>GlideRequest</span><span class=o>&lt;</span><span class=nc>TranscodeType</span><span class=o>&gt;</span> <span class=n>miniThumb</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=nc>GlideRequest</span><span class=o>&lt;</span><span class=nc>TranscodeType</span><span class=o>&gt;)</span> <span class=nc>MyAppExtension</span><span class=o>.</span><span class=n>miniThumb</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此外，如果需要使用到 RequestOptions，要使用 Generated API 生成的 GlideOptions。</p><p>总的来说，如果想使用 Generated API，注意一下三个类的关系</p><ul><li>RequestManager -> GlideRequests</li><li>RequestBuilder -> GlideRequest</li><li>RequestOptions -> GlideOptions</li></ul><a href=#实战分析><h2 id=实战分析><span class=hanchor arialabel=Anchor># </span>实战分析</h2></a></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>