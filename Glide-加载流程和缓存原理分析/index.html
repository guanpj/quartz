<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="åŠ è½½æµç¨‹ Glide æœ€æ™®é€šçš„ç”¨æ³•å¦‚ä¸‹ï¼š
Glide.with(this).load(url).into(textView);
ä»¥é¦–æ¬¡åŠ è½½ url æŒ‡å‘çš„èµ„æºåˆ° textView å¯¹è±¡ä¸ºä¾‹ï¼Œç”±äºä»£ç å®åœ¨å¤ªè¿‡å†—é•¿ï¼Œä¸‹é¢ç”¨æµç¨‹å›¾çš„æ–¹å¼è¡¨ç¤ºå„ä¸ªç¯èŠ‚çš„æ‰§è¡Œé¡ºåºã€‚
with with æµç¨‹çš„ä¸»è¦èŒè´£ï¼š
 åˆ›å»º RequestManager å¯¹è±¡ åˆå§‹åŒ–å„å¼å„æ ·çš„é…ç½®ä¿¡æ¯ï¼ˆç¼“å­˜ã€è¯·æ±‚çº¿ç¨‹æ± ã€å›¾ç‰‡å¤§å°å’Œæ ¼å¼ç­‰ç­‰ï¼‰ä»¥åŠ Glide å•ä¾‹å¯¹è±¡ã€‚ å°† Glide è¯·æ±‚å’Œ application/Activity/SupportFragment/Fragment çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ä¸€èµ·ï¼Œä»è€Œå®ç°è‡ªåŠ¨æ‰§è¡Œè¯·æ±‚ï¼Œæš‚åœæ“ä½œã€‚   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  public class Glide implements ComponentCallbacks2 { ."><meta property="og:title" content="Glide åŠ è½½æµç¨‹å’Œç¼“å­˜åŸç†åˆ†æ"><meta property="og:description" content="åŠ è½½æµç¨‹ Glide æœ€æ™®é€šçš„ç”¨æ³•å¦‚ä¸‹ï¼š
Glide.with(this).load(url).into(textView);
ä»¥é¦–æ¬¡åŠ è½½ url æŒ‡å‘çš„èµ„æºåˆ° textView å¯¹è±¡ä¸ºä¾‹ï¼Œç”±äºä»£ç å®åœ¨å¤ªè¿‡å†—é•¿ï¼Œä¸‹é¢ç”¨æµç¨‹å›¾çš„æ–¹å¼è¡¨ç¤ºå„ä¸ªç¯èŠ‚çš„æ‰§è¡Œé¡ºåºã€‚
with with æµç¨‹çš„ä¸»è¦èŒè´£ï¼š
 åˆ›å»º RequestManager å¯¹è±¡ åˆå§‹åŒ–å„å¼å„æ ·çš„é…ç½®ä¿¡æ¯ï¼ˆç¼“å­˜ã€è¯·æ±‚çº¿ç¨‹æ± ã€å›¾ç‰‡å¤§å°å’Œæ ¼å¼ç­‰ç­‰ï¼‰ä»¥åŠ Glide å•ä¾‹å¯¹è±¡ã€‚ å°† Glide è¯·æ±‚å’Œ application/Activity/SupportFragment/Fragment çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ä¸€èµ·ï¼Œä»è€Œå®ç°è‡ªåŠ¨æ‰§è¡Œè¯·æ±‚ï¼Œæš‚åœæ“ä½œã€‚   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  public class Glide implements ComponentCallbacks2 { ."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Glide åŠ è½½æµç¨‹å’Œç¼“å­˜åŸç†åˆ†æ"><meta name=twitter:description content="åŠ è½½æµç¨‹ Glide æœ€æ™®é€šçš„ç”¨æ³•å¦‚ä¸‹ï¼š
Glide.with(this).load(url).into(textView);
ä»¥é¦–æ¬¡åŠ è½½ url æŒ‡å‘çš„èµ„æºåˆ° textView å¯¹è±¡ä¸ºä¾‹ï¼Œç”±äºä»£ç å®åœ¨å¤ªè¿‡å†—é•¿ï¼Œä¸‹é¢ç”¨æµç¨‹å›¾çš„æ–¹å¼è¡¨ç¤ºå„ä¸ªç¯èŠ‚çš„æ‰§è¡Œé¡ºåºã€‚
with with æµç¨‹çš„ä¸»è¦èŒè´£ï¼š
 åˆ›å»º RequestManager å¯¹è±¡ åˆå§‹åŒ–å„å¼å„æ ·çš„é…ç½®ä¿¡æ¯ï¼ˆç¼“å­˜ã€è¯·æ±‚çº¿ç¨‹æ± ã€å›¾ç‰‡å¤§å°å’Œæ ¼å¼ç­‰ç­‰ï¼‰ä»¥åŠ Glide å•ä¾‹å¯¹è±¡ã€‚ å°† Glide è¯·æ±‚å’Œ application/Activity/SupportFragment/Fragment çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ä¸€èµ·ï¼Œä»è€Œå®ç°è‡ªåŠ¨æ‰§è¡Œè¯·æ±‚ï¼Œæš‚åœæ“ä½œã€‚   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  public class Glide implements ComponentCallbacks2 { ."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>Glide åŠ è½½æµç¨‹å’Œç¼“å­˜åŸç†åˆ†æ</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.0452046239b15cdfa822e3a8fa41b16d.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.cf6439e057b2800c40a018b5e420d51c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.3a9d406d6640c34b72da2343af85f983.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Glide åŠ è½½æµç¨‹å’Œç¼“å­˜åŸç†åˆ†æ</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/Glide/>Glide</a></li><li><a href=https://www.guanpj.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>æºç è§£æ</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#strongåŠ è½½æµç¨‹strong><strong>åŠ è½½æµç¨‹</strong></a><ol><li><a href=#with>with</a><ol><li><a href=#getretrievercontext>getRetriever(Context)</a></li><li><a href=#requestmanagerretrieverget>RequestManagerRetriever.get</a></li><li><a href=#å°ç»“>å°ç»“</a></li></ol></li><li><a href=#strongloadstrong><strong>load</strong></a><ol><li><a href=#requestmanagerasxx>RequestManager.asXx</a></li><li><a href=#requestbuilderload>RequestBuilder.load</a></li><li><a href=#å°ç»“-1>å°ç»“</a></li></ol></li><li><a href=#into>into</a></li><li><a href=#strongæ•´ä½“æµç¨‹strong><strong>æ•´ä½“æµç¨‹</strong></a></li></ol></li><li><a href=#strongç¼“å­˜strong><strong>ç¼“å­˜</strong></a><ol><li><a href=#glide-ç¼“å­˜æœºåˆ¶>Glide ç¼“å­˜æœºåˆ¶</a></li><li><a href=#strongé…ç½®ç¼“å­˜strong><strong>é…ç½®ç¼“å­˜</strong></a><ol><li><a href=#ç£ç›˜ç¼“å­˜ç­–ç•¥>ç£ç›˜ç¼“å­˜ç­–ç•¥</a></li><li><a href=#ä»…ä»ç¼“å­˜åŠ è½½å›¾ç‰‡>ä»…ä»ç¼“å­˜åŠ è½½å›¾ç‰‡</a></li><li><a href=#è·³è¿‡ç¼“å­˜>è·³è¿‡ç¼“å­˜</a></li></ol></li><li><a href=#æ´»åŠ¨èµ„æº-activeresource>æ´»åŠ¨èµ„æº ActiveResource</a></li><li><a href=#å†…å­˜ç¼“å­˜-memorycache>å†…å­˜ç¼“å­˜ MemoryCache</a></li><li><a href=#strongç£ç›˜ç¼“å­˜-diskcachestrong><strong>ç£ç›˜ç¼“å­˜ DiskCache</strong></a></li><li><a href=#ç¼“å­˜æµç¨‹>ç¼“å­˜æµç¨‹</a><ol><li><a href=#enginekey>EngineKey</a></li><li><a href=#å†…å­˜ç¼“å­˜>å†…å­˜ç¼“å­˜</a><ol><li><a href=#activeresource-å’Œ-memorycache>ActiveResource å’Œ MemoryCache</a></li></ol></li><li><a href=#ç£ç›˜ç¼“å­˜>ç£ç›˜ç¼“å­˜</a><ol><li><a href=#decocejob>DecoceJob</a></li><li><a href=#resourcecachekey-å’Œ-datacachekey>ResourceCacheKey å’Œ DataCacheKey</a></li><li><a href=#resourcecachegenerator>ResourceCacheGenerator</a></li><li><a href=#datacachegenerator>DataCacheGenerator</a></li><li><a href=#sourcegenerator>SourceGenerator</a></li><li><a href=#decodejobfetcherreadycallback>DecodeJob.FetcherReadyCallback</a></li></ol></li></ol></li></ol></li><li><a href=#é¢è¯•é¢˜>é¢è¯•é¢˜</a></li></ol></nav></details></aside><a href=#strongåŠ è½½æµç¨‹strong><h1 id=strongåŠ è½½æµç¨‹strong><span class=hanchor arialabel=Anchor># </span><strong>åŠ è½½æµç¨‹</strong></h1></a><p>Glide æœ€æ™®é€šçš„ç”¨æ³•å¦‚ä¸‹ï¼š</p><p>Glide.with(this).load(url).into(textView);</p><p>ä»¥é¦–æ¬¡åŠ è½½ url æŒ‡å‘çš„èµ„æºåˆ° textView å¯¹è±¡ä¸ºä¾‹ï¼Œç”±äºä»£ç å®åœ¨å¤ªè¿‡å†—é•¿ï¼Œä¸‹é¢ç”¨æµç¨‹å›¾çš„æ–¹å¼è¡¨ç¤ºå„ä¸ªç¯èŠ‚çš„æ‰§è¡Œé¡ºåºã€‚</p><a href=#with><h2 id=with><span class=hanchor arialabel=Anchor># </span>with</h2></a><p>with æµç¨‹çš„ä¸»è¦èŒè´£ï¼š</p><ul><li>åˆ›å»º RequestManager å¯¹è±¡</li><li>åˆå§‹åŒ–å„å¼å„æ ·çš„é…ç½®ä¿¡æ¯ï¼ˆç¼“å­˜ã€è¯·æ±‚çº¿ç¨‹æ± ã€å›¾ç‰‡å¤§å°å’Œæ ¼å¼ç­‰ç­‰ï¼‰ä»¥åŠ Glide å•ä¾‹å¯¹è±¡ã€‚</li><li>å°† Glide è¯·æ±‚å’Œ application/Activity/SupportFragment/Fragment çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ä¸€èµ·<strong>ï¼Œä»è€Œå®ç°è‡ªåŠ¨æ‰§è¡Œè¯·æ±‚ï¼Œæš‚åœæ“ä½œ</strong>ã€‚</li></ul><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034132.png width=auto alt></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Glide</span> <span class=kd>implements</span> <span class=n>ComponentCallbacks2</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>context</span><span class=o>).</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Activity</span> <span class=n>activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>activity</span><span class=o>).</span><span class=na>get</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>FragmentActivity</span> <span class=n>activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>activity</span><span class=o>).</span><span class=na>get</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Fragment</span> <span class=n>fragment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>()).</span><span class=na>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>android</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>Fragment</span> <span class=n>fragment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>()).</span><span class=na>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>()).</span><span class=na>get</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¯ä¸ªé‡è½½æ–¹æ³•å†…éƒ¨éƒ½é¦–å…ˆè°ƒç”¨ getRetriever(@Nullable Context context) æ–¹æ³•è·å–ä¸€ä¸ª RequestManagerRetriever å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶ get æ–¹æ³•æ¥è¿”å› RequestManagerã€‚</p><p>ä¼ å…¥ getRetriever çš„å‚æ•°éƒ½æ˜¯ Contextï¼Œè€Œ RequestManagerRetriever.get æ–¹æ³•ä¼ å…¥çš„å‚æ•°å„ä¸ç›¸åŒï¼Œæ‰€ä»¥ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®šè‚¯å®šå‘ç”Ÿåœ¨ get æ–¹æ³•ä¸­ã€‚æŠŠ Glide.with æ–¹æ³•é‡Œé¢çš„ä»£ç åˆ†æˆä¸¤éƒ¨åˆ†æ¥åˆ†æã€‚</p><a href=#getretrievercontext><h3 id=getretrievercontext><span class=hanchor arialabel=Anchor># </span>getRetriever(Context)</h3></a><p>getRetriever(Context) æ–¹æ³•ä¼šæ ¹æ® @GlideModule æ³¨è§£çš„ç±»ä»¥åŠ AndroidManifest.xml æ–‡ä»¶ä¸­ meta-data é…ç½®çš„ GlideModule æ¥åˆ›å»ºä¸€ä¸ª Glide å®ä¾‹ï¼Œç„¶åè¿”å›è¯¥å®ä¾‹çš„ RequestManagerRetrieverã€‚</p><p>é¦–å…ˆä» getRetriever(Context) å¼€å§‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>RequestManagerRetriever</span> <span class=nf>getRetriever</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Context could be null for other reasons (ie the user passes in null), but in practice it will
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// only occur due to errors with the Fragment lifecycle.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=s>&#34;You cannot start a load on a not yet attached View or a Fragment where getActivity() &#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;returns null (which usually occurs when getActivity() is called before the Fragment &#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;is attached or after the Fragment is destroyed).&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>).</span><span class=na>getRequestManagerRetriever</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Glide</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœæœ‰é…ç½® @GlideModule æ³¨è§£çš„ Module
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ä¹‹ç±»ä¼šåå°„æ„é€  kapt ç”Ÿæˆçš„ GeneratedAppGlideModuleImpl ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>getAnnotationGeneratedGlideModules</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>Glide</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>checkAndInitializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>annotationGeneratedModule</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>checkAndInitializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// In the thread running initGlide(), one or more classes may call Glide.get(context).
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Without this check, those calls could trigger infinite recursion.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>isInitializing</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;You cannot call Glide.get() in registerComponents(),&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=s>&#34; use the provided Glide instance instead&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>initializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>initializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=k>new</span> <span class=n>GlideBuilder</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å¦‚æœ GeneratedAppGlideModuleImpl å­˜åœ¨ï¼Œä¸”å…è®¸è§£æ manifest æ–‡ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// åˆ™éå† manifest ä¸­çš„ meta-dataï¼Œè§£æå‡ºæ‰€æœ‰çš„ GlideModule ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>manifestModules</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>isManifestParsingEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>manifestModules</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ManifestParser</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>).</span><span class=na>parse</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ ¹æ® Impl çš„æ’é™¤åå•ï¼Œå‰”é™¤ manifest ä¸­çš„ GlideModule ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getExcludedModuleClasses</span><span class=o>().</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedModuleClasses</span> <span class=o>=</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getExcludedModuleClasses</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>iterator</span> <span class=o>=</span> <span class=n>manifestModules</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>iterator</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>current</span> <span class=o>=</span> <span class=n>iterator</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>excludedModuleClasses</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>current</span><span class=o>.</span><span class=na>getClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;AppGlideModule excludes manifest GlideModule: &#34;</span> <span class=o>+</span> <span class=n>current</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iterator</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>glideModule</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Discovered GlideModule from manifest: &#34;</span> <span class=o>+</span> <span class=n>glideModule</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å¦‚æœ Impl å­˜åœ¨ï¼Œé‚£ä¹ˆè®¾ç½®ä¸ºè¯¥ç±»çš„ RequestManagerFactoryï¼›å¦åˆ™è®¾ç½®ä¸º null
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>RequestManagerRetriever</span><span class=o>.</span><span class=na>RequestManagerFactory</span> <span class=n>factory</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getRequestManagerFactory</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>builder</span><span class=o>.</span><span class=na>setRequestManagerFactory</span><span class=o>(</span><span class=n>factory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ä¾æ¬¡è°ƒç”¨ manifest ä¸­ GlideModule ç±»çš„ applyOptions æ–¹æ³•ï¼Œå°†é…ç½®å†™åˆ° builder é‡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>module</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å†™å…¥ Impl çš„é…ç½®
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ä¹Ÿå°±æ˜¯è¯´ Impl é…ç½®çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œå¦‚æœæœ‰å†²çªçš„è¯
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è°ƒç”¨GlideBuilder.buildæ–¹æ³•åˆ›å»º Glide
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ä¾æ¬¡è°ƒç”¨ manifest ä¸­ GlideModule ç±»çš„ registerComponents æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// æ¥æ›¿æ¢ Glide çš„é»˜è®¤é…ç½®
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>module</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>glide</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>AbstractMethodError</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Attempting to register a Glide v3 module. If you see this, you or one of your&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; dependencies may be including Glide v3 even though you&#39;re using Glide v4.&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; You&#39;ll need to find and remove (or update) the offending dependency.&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; The v3 module name is: &#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=n>module</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>          <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è°ƒç”¨ Impl ä¸­æ›¿æ¢ Glide é…ç½®çš„æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>glide</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ³¨å†Œå†…å­˜ç®¡ç†çš„å›è°ƒï¼Œå› ä¸º Glide å®ç°äº† ComponentCallbacks2 æ¥å£
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>applicationContext</span><span class=o>.</span><span class=na>registerComponentCallbacks</span><span class=o>(</span><span class=n>glide</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ä¿å­˜ glide å®ä¾‹åˆ°é™æ€å˜é‡ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span><span class=o>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœæ²¡æœ‰åœ¨ AndroidManifest å’Œ @GlideModule æ³¨è§£ä¸­è¿›è¡Œè¿‡é…ç½®ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥ç®€åŒ–ä¸ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è°ƒç”¨ GlideBuilder.build æ–¹æ³•åˆ›å»º Glide
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ³¨å†Œå†…å­˜ç®¡ç†çš„å›è°ƒï¼Œå› ä¸º Glide å®ç°äº† ComponentCallbacks2 æ¥å£
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>applicationContext</span><span class=o>.</span><span class=na>registerComponentCallbacks</span><span class=o>(</span><span class=n>glide</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ä¿å­˜ glide å®ä¾‹åˆ°é™æ€å˜é‡ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span><span class=o>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>çœ‹ä¸€ä¸‹ GlideBuilder.build æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=n>Glide</span> <span class=nf>build</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>GlideExperiments</span> <span class=n>experiments</span> <span class=o>=</span> <span class=n>glideExperimentsBuilder</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>RequestManagerRetriever</span> <span class=n>requestManagerRetriever</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>RequestManagerRetriever</span><span class=o>(</span><span class=n>requestManagerFactory</span><span class=o>,</span> <span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>engine</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>memoryCache</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>bitmapPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>arrayPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestManagerRetriever</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>connectivityMonitorFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>logLevel</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultRequestOptionsFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultTransitionOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultRequestListeners</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œç›´æ¥è°ƒç”¨äº† RequestManagerRetriever æ„é€ å™¨ï¼Œä¸”ä¼ å…¥å‚æ•°å®é™…ä¸Šä¸º nullï¼Œåœ¨ RequestManagerRetriever çš„æ„é€ å™¨æ–¹æ³•ä¸­ä¼šä¸ºæ­¤åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ DEFAULT_FACTORYï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RequestManagerRetriever</span> <span class=kd>implements</span> <span class=n>Handler</span><span class=o>.</span><span class=na>Callback</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>handler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>RequestManagerFactory</span> <span class=n>factory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>RequestManagerRetriever</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@Nullable</span> <span class=n>RequestManagerFactory</span> <span class=n>factory</span><span class=o>,</span> <span class=n>GlideExperiments</span> <span class=n>experiments</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>factory</span> <span class=o>:</span> <span class=n>DEFAULT_FACTORY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>Looper</span><span class=o>.</span><span class=na>getMainLooper</span><span class=o>(),</span> <span class=k>this</span> <span class=cm>/* Callback */</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>frameWaiter</span> <span class=o>=</span> <span class=n>buildFrameWaiter</span><span class=o>(</span><span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Used internally to create {@link RequestManager}s.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>RequestManagerFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=n>RequestManager</span> <span class=nf>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>requestManagerTreeNode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestManagerFactory</span> <span class=n>DEFAULT_FACTORY</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RequestManagerFactory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>build</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>requestManagerTreeNode</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>RequestManager</span><span class=o>(</span><span class=n>glide</span><span class=o>,</span> <span class=n>lifecycle</span><span class=o>,</span> <span class=n>requestManagerTreeNode</span><span class=o>,</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>};</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç›®å‰ä¸ºæ­¢ï¼ŒGlide <strong>å•ä¾‹å·²ç»è¢«åˆ›å»ºå‡ºæ¥äº†</strong>ï¼Œå…¶ RequestManagerRetriever ä¼šä½œä¸º getRetriever(Context) çš„è¿”å›å€¼è¿”å›ã€‚</p><p>æ¥ä¸‹æ¥å›åˆ° Glide.with æ–¹æ³•ä¸­ï¼Œæ¥ç€æ‰§è¡Œçš„æ˜¯ RequestManagerRetriever.get æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ ¹æ®å…¥å‚æ˜¯å¯¹ç”Ÿå‘½å‘¨æœŸå¯æ„Ÿçš„ã€‚</p><a href=#requestmanagerretrieverget><h3 id=requestmanagerretrieverget><span class=hanchor arialabel=Anchor># </span>RequestManagerRetriever.get</h3></a><p>RequestManagerRetriever.get æ–¹æ³•ä¸ Glide.with ä¸€æ ·ï¼Œä¹Ÿæœ‰å¾ˆå¤šé‡è½½æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>RequestManager</span> <span class=nf>getApplicationManager</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Either an application context or we&#39;re on a background thread.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>applicationManager</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>applicationManager</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Normally pause/resume is taken care of by the fragment we add to the fragment or
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// activity. However, in this case since the manager attached to the application will not
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// receive lifecycle events, we must force the manager to start resumed using
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// ApplicationLifecycle.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>applicationManager</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>factory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>applicationManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;You cannot start a load on a null Context&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnMainThread</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>Application</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>get</span><span class=o>((</span><span class=n>FragmentActivity</span><span class=o>)</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>Activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>get</span><span class=o>((</span><span class=n>Activity</span><span class=o>)</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>ContextWrapper</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Only unwrap a ContextWrapper if the baseContext has a non-null application context.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Context#createPackageContext may return a Context without an Application instance,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// in which case a ContextWrapper may be used to attach one.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>&amp;&amp;</span> <span class=o>((</span><span class=n>ContextWrapper</span><span class=o>)</span> <span class=n>context</span><span class=o>).</span><span class=na>getBaseContext</span><span class=o>().</span><span class=na>getApplicationContext</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>get</span><span class=o>(((</span><span class=n>ContextWrapper</span><span class=o>)</span> <span class=n>context</span><span class=o>).</span><span class=na>getBaseContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>getApplicationManager</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>FragmentActivity</span> <span class=n>activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnBackgroundThread</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>activity</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>assertNotDestroyed</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>frameWaiter</span><span class=o>.</span><span class=na>registerSelf</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=o>.</span><span class=na>getSupportFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>supportFragmentGet</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>fm</span><span class=o>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=o>,</span> <span class=n>isActivityVisible</span><span class=o>(</span><span class=n>activity</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Fragment</span> <span class=n>fragment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>fragment</span><span class=o>.</span><span class=na>getContext</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>      <span class=s>&#34;You cannot start a load on a fragment before it is attached or after it is destroyed&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnBackgroundThread</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// In some unusual cases, it&#39;s possible to have a Fragment not hosted by an activity. There&#39;s
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// not all that much we can do here. Most apps will be started with a standard activity. If
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// we manage not to register the first frame waiter for a while, the consequences are not
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// catastrophic, we&#39;ll just use some extra memory.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>frameWaiter</span><span class=o>.</span><span class=na>registerSelf</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>fragment</span><span class=o>.</span><span class=na>getChildFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>supportFragmentGet</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getContext</span><span class=o>(),</span> <span class=n>fm</span><span class=o>,</span> <span class=n>fragment</span><span class=o>,</span> <span class=n>fragment</span><span class=o>.</span><span class=na>isVisible</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Activity</span> <span class=n>activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnBackgroundThread</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>activity</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>activity</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>((</span><span class=n>FragmentActivity</span><span class=o>)</span> <span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>assertNotDestroyed</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>frameWaiter</span><span class=o>.</span><span class=na>registerSelf</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>android</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=o>.</span><span class=na>getFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fragmentGet</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>fm</span><span class=o>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=o>,</span> <span class=n>isActivityVisible</span><span class=o>(</span><span class=n>activity</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnBackgroundThread</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>(),</span> <span class=s>&#34;Unable to obtain a request manager for a view without a Context&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Activity</span> <span class=n>activity</span> <span class=o>=</span> <span class=n>findActivity</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=c1>// The view might be somewhere else, like a service.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>activity</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Support Fragments.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Although the user might have non-support Fragments attached to FragmentActivity, searching
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// for non-support Fragments is so expensive pre O and that should be rare enough that we
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// prefer to just fall back to the Activity directly.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>activity</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Fragment</span> <span class=n>fragment</span> <span class=o>=</span> <span class=n>findSupportFragment</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=o>(</span><span class=n>FragmentActivity</span><span class=o>)</span> <span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fragment</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span> <span class=o>:</span> <span class=n>get</span><span class=o>((</span><span class=n>FragmentActivity</span><span class=o>)</span> <span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Standard Fragments.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>android</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>Fragment</span> <span class=n>fragment</span> <span class=o>=</span> <span class=n>findFragment</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>fragment</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨è¿™äº› get æ–¹æ³•ä¸­ï¼Œ<strong>é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯åå°çº¿ç¨‹</strong>ï¼Œå¦‚æœæ˜¯åå°çº¿ç¨‹é‚£ä¹ˆå°±ä¼šè°ƒç”¨ getApplicationManager æ–¹æ³•è¿”å›ä¸€ä¸ª RequestManagerï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>applicationManager</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>factory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>ç”±äºæ­¤å¤„ factory æ˜¯ DEFAULT_FACTORYï¼Œæ‰€ä»¥ RequestManager å°±æ˜¯ä¸‹é¢çš„å€¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RequestManager</span><span class=o>(</span><span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯åå°çº¿ç¨‹</strong>ï¼Œget(View) å’Œ get(Context) ä¼šæ ¹æ®æƒ…å†µè°ƒç”¨ get(Fragment) æˆ– get(FragmentActivity)ã€‚å…¶ä¸­ get(View) ä¸ºäº†æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ Fragment æˆ– Fallback Activityï¼Œå†…éƒ¨æ“ä½œæ¯”è¾ƒå¤šï¼Œå¼€é”€æ¯”è¾ƒå¤§ï¼Œä¸è¦è½»æ˜“ä½¿ç”¨ã€‚</p><p>get(Fragment) å’Œ get(FragmentActivity) æ–¹æ³•éƒ½ä¼šè°ƒç”¨ supportFragmentGet æ–¹æ³•ï¼Œåªæ˜¯ä¼ å…¥å‚æ•°ä¸åŒï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// FragmentActivity activity
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=o>.</span><span class=na>getSupportFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>supportFragmentGet</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>fm</span><span class=o>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=o>,</span> <span class=n>isActivityVisible</span><span class=o>(</span><span class=n>activity</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Fragment fragment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>fragment</span><span class=o>.</span><span class=na>getChildFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>supportFragmentGet</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>(),</span> <span class=n>fm</span><span class=o>,</span> <span class=n>fragment</span><span class=o>,</span> <span class=n>fragment</span><span class=o>.</span><span class=na>isVisible</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>Glide ä¼šä½¿ç”¨ä¸€ä¸ªåŠ è½½ç›®æ ‡æ‰€åœ¨çš„å®¿ä¸» Activity æˆ– Fragment çš„å­ Fragment æ¥å®‰å…¨ä¿å­˜ä¸€ä¸ª RequestManagerï¼Œè€Œ RequestManager è¢« Glide ç”¨æ¥å¼€å§‹ã€åœæ­¢ã€ç®¡ç† Glide è¯·æ±‚ã€‚</p><p>è€Œ supportFragmentGet å°±æ˜¯åˆ›å»º / è·å–è¿™ä¸ª SupportRequestManagerFragmentï¼Œå¹¶è¿”å›å…¶æŒæœ‰çš„ RequestManager çš„æ–¹æ³•ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>RequestManager</span> <span class=nf>supportFragmentGet</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>FragmentManager</span> <span class=n>fm</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>Fragment</span> <span class=n>parentHint</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isParentVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è·å–ä¸€ä¸ªSupportRequestManagerFragment
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>SupportRequestManagerFragment</span> <span class=n>current</span> <span class=o>=</span> <span class=n>getSupportRequestManagerFragment</span><span class=o>(</span><span class=n>fm</span><span class=o>,</span> <span class=n>parentHint</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è·å–é‡Œé¢çš„RequestManagerå¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>RequestManager</span> <span class=n>requestManager</span> <span class=o>=</span> <span class=n>current</span><span class=o>.</span><span class=na>getRequestManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è‹¥æ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>requestManager</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>requestManager</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>factory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>glide</span><span class=o>,</span> <span class=n>current</span><span class=o>.</span><span class=na>getGlideLifecycle</span><span class=o>(),</span> <span class=n>current</span><span class=o>.</span><span class=na>getRequestManagerTreeNode</span><span class=o>(),</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// This is a bit of hack, we&#39;re going to start the RequestManager, but not the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// corresponding Lifecycle. It&#39;s safe to start the RequestManager, but starting the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Lifecycle might trigger memory leaks. See b/154405040
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>isParentVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>requestManager</span><span class=o>.</span><span class=na>onStart</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è®¾ç½®åˆ°SupportRequestManagerFragmenté‡Œé¢ï¼Œä¸‹æ¬¡å°±ä¸éœ€è¦åˆ›å»ºäº†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>current</span><span class=o>.</span><span class=na>setRequestManager</span><span class=o>(</span><span class=n>requestManager</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>requestManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// çœ‹çœ‹Fragmentæ€ä¹ˆæ‰èƒ½é«˜æ•ˆ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>SupportRequestManagerFragment</span> <span class=nf>getSupportRequestManagerFragment</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>FragmentManager</span> <span class=n>fm</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Fragment</span> <span class=n>parentHint</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å·²ç»æ·»åŠ è¿‡äº†ï¼Œå¯ä»¥ç›´æ¥è¿”å›
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>SupportRequestManagerFragment</span> <span class=n>current</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=o>(</span><span class=n>SupportRequestManagerFragment</span><span class=o>)</span> <span class=n>fm</span><span class=o>.</span><span class=na>findFragmentByTag</span><span class=o>(</span><span class=n>FRAGMENT_TAG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä»mapä¸­è·å–ï¼Œå–åˆ°ä¹Ÿå¯ä»¥è¿”å›äº†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>current</span> <span class=o>=</span> <span class=n>pendingSupportRequestManagerFragments</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>fm</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªï¼Œæ­¤æ—¶lifecycleé»˜è®¤ä¸ºActivityFragmentLifecycle
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>current</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SupportRequestManagerFragment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>// å¯¹äºfragmentæ¥è¯´ï¼Œæ­¤æ–¹æ³•ä¼šä»¥Activityä¸ºhoståˆ›å»ºå¦å¤–ä¸€ä¸ª
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// SupportRequestManagerFragmentä½œä¸ºrootRequestManagerFragment
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// å¹¶ä¼šå°†currentåŠ å…¥åˆ°rootRequestManagerFragmentçš„
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// childRequestManagerFragmentsä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// åœ¨RequestManageré€’å½’ç®¡ç†è¯·æ±‚æ—¶ä¼šä½¿ç”¨åˆ°
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>current</span><span class=o>.</span><span class=na>setParentFragmentHint</span><span class=o>(</span><span class=n>parentHint</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// å°†åˆšåˆ›å»ºçš„fragmentç¼“å­˜è¿›mapèµ·æ¥
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>pendingSupportRequestManagerFragments</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>fm</span><span class=o>,</span> <span class=n>current</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// å°†fragmentæ·»åŠ åˆ°é¡µé¢ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>fm</span><span class=o>.</span><span class=na>beginTransaction</span><span class=o>().</span><span class=na>add</span><span class=o>(</span><span class=n>current</span><span class=o>,</span> <span class=n>FRAGMENT_TAG</span><span class=o>).</span><span class=na>commitAllowingStateLoss</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>// ä»¥fmä¸ºkeyä»pendingSupportRequestManagerFragmentsä¸­åˆ é™¤
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>handler</span><span class=o>.</span><span class=na>obtainMessage</span><span class=o>(</span><span class=n>ID_REMOVE_SUPPORT_FRAGMENT_MANAGER</span><span class=o>,</span> <span class=n>fm</span><span class=o>).</span><span class=na>sendToTarget</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>current</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ä¸Šé¢çš„ supportFragmentGet æ–¹æ³•ä¸­ï¼ŒæˆåŠŸåˆ›å»ºäº†ä¸€ä¸ª RequestManager å¯¹è±¡ï¼Œç”±äº factory æ˜¯ DEFAULT_FACTORYï¼Œæ‰€ä»¥å°±æ˜¯ä¸‹é¢çš„å€¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RequestManager</span><span class=o>(</span><span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=n>current</span><span class=o>.</span><span class=na>getGlideLifecycle</span><span class=o>(),</span>          <span class=c1>// ActivityFragmentLifecycle()
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>current</span><span class=o>.</span><span class=na>getRequestManagerTreeNode</span><span class=o>(),</span>  <span class=c1>// SupportFragmentRequestManagerTreeNode()
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>context</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ä¸Šä¸€æ­¥ä¸­ Glide å•ä¾‹å®Œæˆäº†åˆå§‹åŒ–ï¼Œè¿™ä¸€æ­¥ä¸­æˆåŠŸçš„åˆ›å»ºå¹¶è¿”å›äº†ä¸€ä¸ª RequestManagerã€‚Glide.with å·²ç»åˆ†æå®Œæ¯•ã€‚</p><a href=#å°ç»“><h3 id=å°ç»“><span class=hanchor arialabel=Anchor># </span>å°ç»“</h3></a><p>with() æ–¹æ³•æ˜¯ä¸ºå¾—åˆ°ä¸€ä¸ª RequestManager å¯¹è±¡ï¼Œä»è€Œå°† Glide åŠ è½½å›¾ç‰‡å‘¨æœŸä¸ Activity å’Œ Fragment è¿›è¡Œç»‘å®šï¼Œè¿›è€Œç®¡ç† Glide åŠ è½½å›¾ç‰‡å‘¨æœŸã€‚</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034143.png width=auto alt></p><a href=#strongloadstrong><h2 id=strongloadstrong><span class=hanchor arialabel=Anchor># </span><strong>load</strong></h2></a><p>ç”±äº .with() è¿”å›çš„æ˜¯ä¸€ä¸ª RequestManager å¯¹è±¡ï¼Œæ‰€ä»¥ç¬¬ 2 æ­¥ä¸­è°ƒç”¨çš„æ˜¯ RequestManager</p><p>ç±»çš„ load() æ–¹æ³•ã€‚è€Œ load() æ–¹æ³•è¿”å›çš„æ˜¯ RequestBuilder å¯¹è±¡ã€‚RequestBuilder å’Œ RequestOptions éƒ½æ´¾ç”Ÿè‡ªæŠ½è±¡ç±» BaseRequestOptionsï¼Œå®ƒä»¬çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034149.png width=auto alt></p><p>çœ‹ä¸€ä¸‹ RequestManager çš„ä¸€äº›æ–¹æ³•ï¼Œé¦–å…ˆçœ‹ load çš„ä¸€äº›é‡è½½æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Bitmap</span> <span class=n>bitmap</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>bitmap</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>drawable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>drawable</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>string</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>string</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Uri</span> <span class=n>uri</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>uri</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>File</span> <span class=n>file</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>file</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@RawRes</span> <span class=nd>@DrawableRes</span> <span class=nd>@Nullable</span> <span class=n>Integer</span> <span class=n>resourceId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>resourceId</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>URL</span> <span class=n>url</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>model</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>model</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>model</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>model</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨æ‰€æœ‰çš„ RequestManager.load æ–¹æ³•ä¸­éƒ½ä¼šå…ˆè°ƒç”¨ asDrawable() æ–¹æ³•å¾—åˆ°ä¸€ä¸ª RequestBuilder å¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨ RequestBuilder.load æ–¹æ³•ã€‚</p><a href=#requestmanagerasxx><h3 id=requestmanagerasxx><span class=hanchor arialabel=Anchor># </span>RequestManager.asXx</h3></a><p>asDrawable æ–¹æ³•åŒå…¶ä»– as æ–¹æ³•ï¼ˆasGifã€asBitmapã€asFileï¼‰ä¸€æ ·ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨ RequestManager.as æ–¹æ³•ç”Ÿæˆä¸€ä¸ª <code>RequestBuilder&lt;ResourceType></code> å¯¹è±¡ï¼Œç„¶åå„ä¸ª as æ–¹æ³•ä¼šé™„åŠ ä¸€äº›ä¸åŒçš„ optionsï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>asBitmap</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>Bitmap</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>DECODE_TYPE_BITMAP</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGif</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>GifDrawable</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>DECODE_TYPE_GIF</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>asDrawable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>Drawable</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>asFile</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>File</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>skipMemoryCacheOf</span><span class=o>(</span><span class=kc>true</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>as</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestBuilder</span><span class=o>&lt;&gt;(</span><span class=n>glide</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>resourceClass</span><span class=o>,</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ RequestBuilder çš„æ„é€ å™¨æ–¹æ³•æ–¹æ³•ä¸­å°† Drawable.class è¿™æ ·çš„å…¥å‚ä¿å­˜åˆ°äº† transcodeClass å˜é‡ä¸­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@SuppressLint</span><span class=p>(</span><span class=s2>&#34;CheckResult&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;PMD.ConstructorCallsOverridableMethod&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>protected</span> <span class=n>RequestBuilder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>RequestManager</span> <span class=n>requestManager</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>transcodeClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>glide</span> <span class=p>=</span> <span class=n>glide</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>requestManager</span> <span class=p>=</span> <span class=n>requestManager</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>transcodeClass</span> <span class=p>=</span> <span class=n>transcodeClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>context</span> <span class=p>=</span> <span class=n>context</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>transitionOptions</span> <span class=p>=</span> <span class=n>requestManager</span><span class=p>.</span><span class=n>getDefaultTransitionOptions</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>glideContext</span> <span class=p>=</span> <span class=n>glide</span><span class=p>.</span><span class=n>getGlideContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>initRequestListeners</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=n>getDefaultRequestListeners</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=n>apply</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=n>getDefaultRequestOptions</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åå›åˆ°ä¹‹å‰çš„ asGif æ–¹æ³•ä¸­ï¼Œçœ‹çœ‹ apply(DECODE_TYPE_BITMAP) å¹²äº†äº›ä»€ä¹ˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// RequestManager
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestOptions</span> <span class=n>DECODE_TYPE_GIF</span> 
</span></span><span class=line><span class=cl>        <span class=o>=</span> <span class=n>RequestOptions</span><span class=o>.</span><span class=na>decodeTypeOf</span><span class=o>(</span><span class=n>GifDrawable</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGif</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>GifDrawable</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>DECODE_TYPE_GIF</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// RequestOptions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestOptions</span> <span class=nf>decodeTypeOf</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestOptions</span><span class=o>().</span><span class=na>decode</span><span class=o>(</span><span class=n>resourceClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// BaseRequestOptions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>T</span> <span class=nf>decode</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isAutoCloneEnabled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clone</span><span class=o>().</span><span class=na>decode</span><span class=o>(</span><span class=n>resourceClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>resourceClass</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>resourceClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=o>|=</span> <span class=n>RESOURCE_CLASS</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>T</span> <span class=nf>apply</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isAutoCloneEnabled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clone</span><span class=o>().</span><span class=na>apply</span><span class=o>(</span><span class=n>o</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>other</span> <span class=o>=</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isSet</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>fields</span><span class=o>,</span> <span class=n>RESOURCE_CLASS</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resourceClass</span> <span class=o>=</span> <span class=n>other</span><span class=o>.</span><span class=na>resourceClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// RequestBuilder
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>apply</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>requestOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>requestOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸éš¾å‘ç°ï¼Œapply(DECODE_TYPE_BITMAP) å°±æ˜¯å°† BaseRequestOptions.resourceClass è®¾ç½®ä¸ºäº† GifDrawable.classï¼›å¯¹äº asBitmap() æ¥è¯´ï¼ŒresourceClass ä¸º Bitmap.classï¼›è€Œå¯¹äº asDrawable() å’Œ asFile() æ¥è¯´ï¼ŒresourceClass æ²¡æœ‰è¿›è¡Œè¿‡è®¾ç½®ï¼Œæ‰€ä»¥ä¸ºé»˜è®¤å€¼ Object.classã€‚</p><p>ç°åœ¨ RequestBuilder å·²ç»ç”± as ç³»åˆ—æ–¹æ³•ç”Ÿæˆï¼Œç°åœ¨æ¥ç€ä¼šè°ƒç”¨ RequestBuilder.load æ–¹æ³•</p><a href=#requestbuilderload><h3 id=requestbuilderload><span class=hanchor arialabel=Anchor># </span>RequestBuilder.load</h3></a><p>RequestManager.load æ–¹æ³•éƒ½ä¼šè°ƒç”¨å¯¹åº”çš„ RequestBuilder.load é‡è½½æ–¹æ³•ï¼›RequestBuilder.load çš„å„ä¸ªæ–¹æ³•åŸºæœ¬ä¸Šéƒ½ä¼šç›´æ¥è½¬å‘ç»™ loadGeneric æ–¹æ³•ï¼Œåªæœ‰å°‘æ•°çš„æ–¹æ³•æ‰ä¼š apply é¢å¤–çš„ optionsã€‚</p><p>loadGeneric æ–¹æ³•ä¹Ÿåªæ˜¯ä¿å­˜ä¸€ä¸‹å‚æ•°è€Œå·²ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;unchecked&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nb>Object</span> <span class=nx>model</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>model</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>Bitmap</span> <span class=nx>bitmap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>bitmap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>diskCacheStrategyOf</span><span class=p>(</span><span class=nx>DiskCacheStrategy</span><span class=p>.</span><span class=nx>NONE</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>Drawable</span> <span class=nx>drawable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>drawable</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>diskCacheStrategyOf</span><span class=p>(</span><span class=nx>DiskCacheStrategy</span><span class=p>.</span><span class=nx>NONE</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>Uri</span> <span class=nx>uri</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>uri</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>File</span> <span class=nx>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@RawRes</span> <span class=kd>@DrawableRes</span> <span class=kd>@Nullable</span> <span class=nx>Integer</span> <span class=nx>resourceId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>resourceId</span><span class=p>).</span><span class=nx>apply</span><span class=p>(</span><span class=nx>signatureOf</span><span class=p>(</span><span class=nx>ApplicationVersionSignature</span><span class=p>.</span><span class=nx>obtain</span><span class=p>(</span><span class=nx>context</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>URL</span> <span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>byte</span><span class=p>[]</span> <span class=nx>model</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>model</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>result</span><span class=p>.</span><span class=nx>isDiskCacheStrategySet</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>result</span> <span class=o>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>diskCacheStrategyOf</span><span class=p>(</span><span class=nx>DiskCacheStrategy</span><span class=p>.</span><span class=nx>NONE</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>result</span><span class=p>.</span><span class=nx>isSkipMemoryCacheSet</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>result</span> <span class=o>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>skipMemoryCacheOf</span><span class=p>(</span><span class=kc>true</span> <span class=cm>/*skipMemoryCache*/</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>private</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nb>Object</span> <span class=nx>model</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=nx>model</span> <span class=o>=</span> <span class=nx>model</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>isModelSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚ä¸Šé¢æœ€åçš„æ–¹æ³• loadGenericï¼Œè¿™é‡Œåªæ˜¯å°†å‚æ•°ä¿å­˜åœ¨ model ä¸­å¹¶è®¾ç½® isModelSet=true å°±å®Œäº†ï¼Œ</p><a href=#å°ç»“-1><h3 id=å°ç»“-1><span class=hanchor arialabel=Anchor># </span>å°ç»“</h3></a><p>load æµç¨‹ä¸»è¦ç»™ GlideRequestï¼ˆRequestManagerï¼‰è®¾ç½®äº†è¦è¯·æ±‚çš„ modeï¼ˆurlï¼‰ï¼Œå¹¶å°† isModelSet å˜é‡è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºå·²è®¾ç½®çš„çŠ¶æ€ï¼Œæœ€åè¿”å› RequestBuilderã€‚</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034156.png width=auto alt></p><a href=#into><h2 id=into><span class=hanchor arialabel=Anchor># </span>into</h2></a><p>RequestBuilder.into æœ‰å››ä¸ªé‡è½½æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½è°ƒç”¨äº†å‚æ•°æœ€å¤šçš„ä¸€ä¸ªï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=p>&lt;</span><span class=nt>Y</span> <span class=na>extends</span> <span class=na>Target</span><span class=err>&lt;</span><span class=na>TranscodeType</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>Y</span> <span class=nx>into</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Y</span> <span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>Executors</span><span class=p>.</span><span class=nx>mainThreadExecutor</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@Synthetic</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>Y</span> <span class=na>extends</span> <span class=na>Target</span><span class=err>&lt;</span><span class=na>TranscodeType</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>Y</span> <span class=nx>into</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@NonNull</span> <span class=nx>Y</span> <span class=nx>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Nullable</span> <span class=nx>RequestListener</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Executor</span> <span class=nx>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>targetListener</span><span class=p>,</span> <span class=cm>/*options=*/</span> <span class=k>this</span><span class=p>,</span> <span class=nx>callbackExecutor</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>private</span> <span class=p>&lt;</span><span class=nt>Y</span> <span class=na>extends</span> <span class=na>Target</span><span class=err>&lt;</span><span class=na>TranscodeType</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>Y</span> <span class=nx>into</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@NonNull</span> <span class=nx>Y</span> <span class=nx>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Nullable</span> <span class=nx>RequestListener</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Executor</span> <span class=nx>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Preconditions</span><span class=p>.</span><span class=nx>checkNotNull</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isModelSet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nx>IllegalArgumentException</span><span class=p>(</span><span class=s2>&#34;You must call #load() before calling #into()&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Request</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>buildRequest</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>targetListener</span><span class=p>,</span> <span class=nx>options</span><span class=p>,</span> <span class=nx>callbackExecutor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Request</span> <span class=nx>previous</span> <span class=o>=</span> <span class=nx>target</span><span class=p>.</span><span class=nx>getRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>isEquivalentTo</span><span class=p>(</span><span class=nx>previous</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isSkipMemoryCacheWithCompletePreviousRequest</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span> <span class=nx>previous</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If the request is completed, beginning again will ensure the result is re-delivered,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// triggering RequestListeners and Targets. If the request is failed, beginning again will
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// restart the request, giving it another chance to complete. If the request is already
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// running, we can let it continue running without interruption.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>Preconditions</span><span class=p>.</span><span class=nx>checkNotNull</span><span class=p>(</span><span class=nx>previous</span><span class=p>).</span><span class=nx>isRunning</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Use the previous request rather than the new one to allow for optimizations like skipping
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// that are done in the individual Request.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>previous</span><span class=p>.</span><span class=nx>begin</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>requestManager</span><span class=p>.</span><span class=nx>clear</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>target</span><span class=p>.</span><span class=nx>setRequest</span><span class=p>(</span><span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>requestManager</span><span class=p>.</span><span class=nx>track</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// æœ€å¸¸ç”¨çš„ä¸€ä¸ªé‡è½½
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>ViewTarget</span><span class=p>&lt;</span><span class=nt>ImageView</span><span class=err>,</span> <span class=na>TranscodeType</span><span class=p>&gt;</span> <span class=nx>into</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>ImageView</span> <span class=nx>view</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Util</span><span class=p>.</span><span class=nx>assertMainThread</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>Preconditions</span><span class=p>.</span><span class=nx>checkNotNull</span><span class=p>(</span><span class=nx>view</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=nx>requestOptions</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è‹¥æ²¡æœ‰æŒ‡å®štransformï¼ŒisTransformationSet()ä¸ºfalse
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// isTransformationAllowed()ä¸€èˆ¬ä¸ºtrueï¼Œé™¤éä¸»åŠ¨è°ƒç”¨äº†dontTransform()æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>requestOptions</span><span class=p>.</span><span class=nx>isTransformationSet</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>isTransformationAllowed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=nx>view</span><span class=p>.</span><span class=nx>getScaleType</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// into a different target, we don&#39;t retain the transformation applied based on the previous
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// View&#39;s scale type.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// æ ¹æ®ImageViewçš„ScaleTypeè®¾ç½®ä¸åŒçš„down sampleå’Œtransformé€‰é¡¹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=p>(</span><span class=nx>view</span><span class=p>.</span><span class=nx>getScaleType</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>CENTER_CROP</span>:
</span></span><span class=line><span class=cl>        <span class=kt>requestOptions</span> <span class=o>=</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>clone</span><span class=p>().</span><span class=nx>optionalCenterCrop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>CENTER_INSIDE</span>:
</span></span><span class=line><span class=cl>        <span class=kt>requestOptions</span> <span class=o>=</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>clone</span><span class=p>().</span><span class=nx>optionalCenterInside</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>FIT_CENTER</span><span class=o>:</span> <span class=c1>// é»˜è®¤å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>case</span> <span class=nx>FIT_START</span>:
</span></span><span class=line><span class=cl>      <span class=kt>case</span> <span class=nx>FIT_END</span>:
</span></span><span class=line><span class=cl>        <span class=kt>requestOptions</span> <span class=o>=</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>clone</span><span class=p>().</span><span class=nx>optionalFitCenter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>FIT_XY</span>:
</span></span><span class=line><span class=cl>        <span class=kt>requestOptions</span> <span class=o>=</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>clone</span><span class=p>().</span><span class=nx>optionalCenterInside</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>CENTER</span>:
</span></span><span class=line><span class=cl>      <span class=kt>case</span> <span class=nx>MATRIX</span>:
</span></span><span class=line><span class=cl>      <span class=kt>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Do nothing.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// è°ƒç”¨ä¸Šé¢çš„é‡è½½æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>glideContext</span><span class=p>.</span><span class=nx>buildImageViewTarget</span><span class=p>(</span><span class=nx>view</span><span class=p>,</span> <span class=nx>transcodeClass</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>requestOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>Executors</span><span class=p>.</span><span class=nx>mainThreadExecutor</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034202.png width=auto alt></p><a href=#strongæ•´ä½“æµç¨‹strong><h2 id=strongæ•´ä½“æµç¨‹strong><span class=hanchor arialabel=Anchor># </span><strong>æ•´ä½“æµç¨‹</strong></h2></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034206.png width=auto alt></p><a href=#strongç¼“å­˜strong><h1 id=strongç¼“å­˜strong><span class=hanchor arialabel=Anchor># </span><strong>ç¼“å­˜</strong></h1></a><a href=#glide-ç¼“å­˜æœºåˆ¶><h2 id=glide-ç¼“å­˜æœºåˆ¶><span class=hanchor arialabel=Anchor># </span>Glide ç¼“å­˜æœºåˆ¶</h2></a><p>Glide ä¹‹æ‰€ä»¥è¢«å¹¿æ³›ä½¿ç”¨çš„ä¸€ä¸ªé‡è¦åŸå› å°±æ˜¯å®ƒå¼ºå¤§çš„ç¼“å­˜æœºåˆ¶ã€‚åœ¨ Glide å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œåœ¨
<a href=https://muyangmin.github.io/glide-docs-cn/doc/caching.html rel=noopener>ç¼“å­˜éƒ¨åˆ†</a> æœ‰å¦‚ä¸‹æè¿°ï¼š</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒGlide ä¼šåœ¨å¼€å§‹ä¸€ä¸ªæ–°çš„å›¾ç‰‡è¯·æ±‚ä¹‹å‰æ£€æŸ¥ä»¥ä¸‹å¤šçº§çš„ç¼“å­˜ï¼š</p><p>1ã€æ´»åŠ¨èµ„æº (Active Resources) - ç°åœ¨æ˜¯å¦æœ‰å¦ä¸€ä¸ª View æ­£åœ¨å±•ç¤ºè¿™å¼ å›¾ç‰‡ï¼Ÿ</p><p>2ã€å†…å­˜ç¼“å­˜ (Memory Cache) - è¯¥å›¾ç‰‡æ˜¯å¦æœ€è¿‘è¢«åŠ è½½è¿‡å¹¶ä»å­˜åœ¨äºå†…å­˜ä¸­ï¼Ÿ</p><p>3ã€èµ„æºç±»å‹ï¼ˆResourceï¼‰ - è¯¥å›¾ç‰‡æ˜¯å¦ä¹‹å‰æ›¾è¢«è§£ç ã€è½¬æ¢å¹¶å†™å…¥è¿‡ç£ç›˜ç¼“å­˜ï¼Ÿ</p><p>4ã€æ•°æ®æ¥æº (Data) - æ„å»ºè¿™ä¸ªå›¾ç‰‡çš„èµ„æºæ˜¯å¦ä¹‹å‰æ›¾è¢«å†™å…¥è¿‡æ–‡ä»¶ç¼“å­˜ï¼Ÿ</p><p>å‰ä¸¤æ­¥æ£€æŸ¥å›¾ç‰‡æ˜¯å¦åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›å›¾ç‰‡ã€‚åä¸¤æ­¥åˆ™æ£€æŸ¥å›¾ç‰‡æ˜¯å¦åœ¨ç£ç›˜ä¸Šï¼Œä»¥ä¾¿å¿«é€Ÿä½†å¼‚æ­¥åœ°è¿”å›å›¾ç‰‡ã€‚</p><p>å¦‚æœå››ä¸ªæ­¥éª¤éƒ½æœªèƒ½æ‰¾åˆ°å›¾ç‰‡ï¼Œåˆ™ Glide ä¼šè¿”å›åˆ°åŸå§‹èµ„æºä»¥å–å›æ•°æ®ï¼ˆåŸå§‹æ–‡ä»¶ï¼ŒUri, Url ç­‰ï¼‰ã€‚</p><p>Glide ç¼“å­˜æœºåˆ¶çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034424.png width=auto alt></p><p>Glide çš„ memory cache å’Œ disk cache åœ¨ Glide åˆ›å»ºçš„æ—¶å€™å°±ç¡®å®šäº†ã€‚ä»£ç åœ¨ GlideBuilder.build(Context) æ–¹æ³•é‡Œé¢ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=n>Glide</span> <span class=nf>build</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=o>(</span><span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getMemoryCacheSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>engine</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>engine</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Engine</span><span class=o>(</span><span class=n>memoryCache</span><span class=o>,</span> <span class=n>diskCacheFactory</span><span class=o>,</span> <span class=o>...);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>engine</span><span class=o>,</span> <span class=n>memoryCache</span><span class=o>,</span> <span class=o>...);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœæ²¡æœ‰åœ¨ä»»ä½• GlideModule ä¸­è¿›è¡Œè‡ªå®šä¹‰çš„è¯ï¼ŒmemoryCache å’Œ diskCacheFactory ä¼šä½¿ç”¨ä¸€ä¸ªé»˜è®¤å€¼ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä½¿ç”¨è¿™ä¸ªé»˜è®¤å€¼å»å®ç°ç¼“å­˜å°±å¯ä»¥äº†ã€‚</p><a href=#strongé…ç½®ç¼“å­˜strong><h2 id=strongé…ç½®ç¼“å­˜strong><span class=hanchor arialabel=Anchor># </span><strong>é…ç½®ç¼“å­˜</strong></h2></a><a href=#ç£ç›˜ç¼“å­˜ç­–ç•¥><h3 id=ç£ç›˜ç¼“å­˜ç­–ç•¥><span class=hanchor arialabel=Anchor># </span>ç£ç›˜ç¼“å­˜ç­–ç•¥</h3></a><p>DiskCacheStrategyÂ å¯è¢«Â diskCacheStrategy()Â æ–¹æ³•åº”ç”¨åˆ°æ¯ä¸€ä¸ªå•ç‹¬çš„è¯·æ±‚ã€‚ ç›®å‰æ”¯æŒçš„ç­–ç•¥å…è®¸ä½ é˜»æ­¢åŠ è½½è¿‡ç¨‹ä½¿ç”¨æˆ–å†™å…¥ç£ç›˜ç¼“å­˜ï¼Œé€‰æ‹©æ€§åœ°ä»…ç¼“å­˜æ— ä¿®æ”¹çš„åŸç”Ÿæ•°æ®ï¼Œæˆ–ä»…ç¼“å­˜å˜æ¢è¿‡çš„ç¼©ç•¥å›¾ï¼Œæˆ–æ˜¯å…¼è€Œæœ‰ä¹‹ã€‚ç£ç›˜ç¼“å­˜ä¸€å…±æœ‰ä»¥ä¸‹å‡ ç§ç­–ç•¥ï¼š</p><ul><li>DiskCacheStrategy.AUTOMATICï¼šå°è¯•å¯¹æœ¬åœ°å’Œè¿œç¨‹å›¾ç‰‡ä½¿ç”¨æœ€ä½³çš„ç­–ç•¥ï¼Œå®ƒæ˜¯é»˜è®¤ä½¿ç”¨çš„ç­–ç•¥ã€‚å½“åŠ è½½è¿œç¨‹æ•°æ®ï¼ˆæ¯”å¦‚ä» URL ä¸‹è½½ï¼‰æ—¶ï¼Œä»…ä¼šå­˜å‚¨æœªè¢«åŠ è½½è¿‡ç¨‹ä¿®æ”¹è¿‡ï¼ˆæ¯”å¦‚å˜æ¢ï¼‰çš„åŸå§‹æ•°æ®ã€‚å¯¹äºæœ¬åœ°æ•°æ®ï¼Œåˆ™ä¼šä»…å­˜å‚¨å˜æ¢è¿‡çš„ç¼©ç•¥å›¾ï¼Œå› ä¸ºå³ä½¿éœ€è¦å†æ¬¡ç”Ÿæˆå¦ä¸€ä¸ªå°ºå¯¸æˆ–ç±»å‹çš„å›¾ç‰‡ï¼Œå–å›åŸå§‹æ•°æ®ä¹Ÿå¾ˆå®¹æ˜“ã€‚</li><li>DiskCacheStrategy.NONEï¼š è¡¨ç¤ºä¸ç¼“å­˜ä»»ä½•å†…å®¹ã€‚</li><li>DiskCacheStrategy.DATAï¼š è¡¨ç¤ºåªç¼“å­˜åŸå§‹å›¾ç‰‡ã€‚</li><li>DiskCacheStrategy.RESOURCEï¼š è¡¨ç¤ºåªç¼“å­˜è½¬æ¢è¿‡åçš„å›¾ç‰‡ã€‚</li><li>DiskCacheStrategy.ALL ï¼š è¡¨ç¤ºæ—¢ç¼“å­˜åŸå§‹å›¾ç‰‡ï¼Œä¹Ÿç¼“å­˜è½¬æ¢è¿‡åçš„å›¾ç‰‡ã€‚</li></ul><p><strong>æŒ‡å®šÂ DiskCacheStrategyÂ :</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>diskCacheStrategy</span><span class=o>(</span><span class=n>DiskCacheStrategy</span><span class=o>.</span><span class=na>ALL</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>imageView</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#ä»…ä»ç¼“å­˜åŠ è½½å›¾ç‰‡><h3 id=ä»…ä»ç¼“å­˜åŠ è½½å›¾ç‰‡><span class=hanchor arialabel=Anchor># </span>ä»…ä»ç¼“å­˜åŠ è½½å›¾ç‰‡</h3></a><p>æŸäº›æƒ…å½¢ä¸‹ï¼Œå¯èƒ½å¸Œæœ›åªè¦å›¾ç‰‡ä¸åœ¨ç¼“å­˜ä¸­åˆ™åŠ è½½ç›´æ¥å¤±è´¥ï¼ˆæ¯”å¦‚çœæµé‡æ¨¡å¼ï¼Ÿï¼‰ã€‚å¦‚æœè¦è¾¾åˆ°è¿™ç§æ•ˆæœï¼Œå¯ä»¥åœ¨å•ä¸ªè¯·æ±‚çš„åŸºç¡€ä¸Šä½¿ç”¨Â onlyRetrieveFromCacheÂ æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onlyRetrieveFromCache</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>imageView</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ—¶å¦‚æœå›¾ç‰‡åœ¨å†…å­˜ç¼“å­˜æˆ–åœ¨ç£ç›˜ç¼“å­˜ä¸­ï¼Œå®ƒä¼šè¢«å±•ç¤ºå‡ºæ¥ã€‚å¦åˆ™åªè¦è¿™ä¸ªé€‰é¡¹è¢«è®¾ç½®ä¸º true ï¼Œè¿™æ¬¡åŠ è½½ä¼šè§†åŒå¤±è´¥ã€‚</p><a href=#è·³è¿‡ç¼“å­˜><h3 id=è·³è¿‡ç¼“å­˜><span class=hanchor arialabel=Anchor># </span>è·³è¿‡ç¼“å­˜</h3></a><p>å¦‚æœä½ æƒ³ç¡®ä¿ä¸€ä¸ªç‰¹å®šçš„è¯·æ±‚è·³è¿‡ç£ç›˜å’Œ/æˆ–å†…å­˜ç¼“å­˜ï¼ˆ<em>æ¯”å¦‚ï¼Œå›¾ç‰‡éªŒè¯ç </em>ï¼‰ï¼ŒGlide ä¹Ÿæä¾›äº†ä¸€äº›æ›¿ä»£æ–¹æ¡ˆã€‚</p><p>ä»…è·³è¿‡å†…å­˜ç¼“å­˜ï¼Œè¯·ä½¿ç”¨Â skipMemoryCache()Â :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>skipMemoryCache</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»…è·³è¿‡ç£ç›˜ç¼“å­˜ï¼Œè¯·ä½¿ç”¨Â DiskCacheStrategy.NONEÂ :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>diskCacheStrategy</span><span class=o>(</span><span class=n>DiskCacheStrategy</span><span class=o>.</span><span class=na>NONE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸¤ä¸ªé€‰é¡¹å¯ä»¥åŒæ—¶ä½¿ç”¨:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>diskCacheStrategy</span><span class=o>(</span><span class=n>DiskCacheStrategy</span><span class=o>.</span><span class=na>NONE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>skipMemoryCache</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è™½ç„¶æä¾›äº†è¿™äº›é€‰é¡¹è·³è¿‡ç¼“å­˜ï¼Œä½†ä¸å»ºè®®è¿™ä¹ˆåšã€‚å› ä¸ºä»ç¼“å­˜ä¸­åŠ è½½ä¸€ä¸ªå›¾ç‰‡ï¼Œè¦æ¯”æ‹‰å– - è§£ç  - è½¬æ¢æˆä¸€å¼ æ–°å›¾ç‰‡çš„å®Œæ•´æµç¨‹å¿«å¾—å¤šã€‚</p><a href=#æ´»åŠ¨èµ„æº-activeresource><h2 id=æ´»åŠ¨èµ„æº-activeresource><span class=hanchor arialabel=Anchor># </span>æ´»åŠ¨èµ„æº ActiveResource</h2></a><p>ActiveResources åœ¨ Engine çš„æ„é€ å™¨ä¸­è¢«åˆ›å»ºï¼Œå®ƒçš„æºç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kd>class</span> <span class=nc>ActiveResources</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Executor</span> <span class=n>monitorClearedResourcesExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>ResourceWeakReference</span><span class=o>&gt;</span> <span class=n>activeEngineResources</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ReferenceQueue</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>resourceReferenceQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReferenceQueue</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ResourceListener</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>isShutdown</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>DequeuedResourceCallback</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ActiveResources</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>isActiveResourceRetentionAllowed</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>concurrent</span><span class=o>.</span><span class=na>Executors</span><span class=o>.</span><span class=na>newSingleThreadExecutor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>ThreadFactory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>              <span class=kd>public</span> <span class=n>Thread</span> <span class=nf>newThread</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>Runnable</span> <span class=n>r</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                      <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                      <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>Process</span><span class=o>.</span><span class=na>setThreadPriority</span><span class=o>(</span><span class=n>Process</span><span class=o>.</span><span class=na>THREAD_PRIORITY_BACKGROUND</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>r</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                      <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>},</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;glide-active-resources&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ActiveResources</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>,</span> <span class=n>Executor</span> <span class=n>monitorClearedResourcesExecutor</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>isActiveResourceRetentionAllowed</span> <span class=o>=</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>monitorClearedResourcesExecutor</span> <span class=o>=</span> <span class=n>monitorClearedResourcesExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>monitorClearedResourcesExecutor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cleanReferenceQueue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setListener</span><span class=o>(</span><span class=n>ResourceListener</span> <span class=n>listener</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>listener</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>listener</span> <span class=o>=</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>activate</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span> <span class=n>toPut</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ResourceWeakReference</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span><span class=o>,</span> <span class=n>resource</span><span class=o>,</span> <span class=n>resourceReferenceQueue</span><span class=o>,</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span> <span class=n>removed</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>toPut</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>removed</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>removed</span><span class=o>.</span><span class=na>reset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>deactivate</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span> <span class=n>removed</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>removed</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>removed</span><span class=o>.</span><span class=na>reset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>get</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span> <span class=n>activeRef</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>activeRef</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>activeRef</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>active</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cleanupActiveReference</span><span class=o>(</span><span class=n>activeRef</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>active</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>cleanupActiveReference</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ResourceWeakReference</span> <span class=n>ref</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>ref</span><span class=o>.</span><span class=na>isCacheable</span> <span class=o>||</span> <span class=n>ref</span><span class=o>.</span><span class=na>resource</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>newResource</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EngineResource</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>ref</span><span class=o>.</span><span class=na>resource</span><span class=o>,</span> <span class=cm>/*isMemoryCacheable=*/</span> <span class=kc>true</span><span class=o>,</span> <span class=cm>/*isRecyclable=*/</span> <span class=kc>false</span><span class=o>,</span> <span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>,</span> <span class=n>listener</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReleased</span><span class=o>(</span><span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>,</span> <span class=n>newResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>cleanReferenceQueue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(!</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ResourceWeakReference</span> <span class=n>ref</span> <span class=o>=</span> <span class=o>(</span><span class=n>ResourceWeakReference</span><span class=o>)</span> <span class=n>resourceReferenceQueue</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>cleanupActiveReference</span><span class=o>(</span><span class=n>ref</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>DequeuedResourceCallback</span> <span class=n>current</span> <span class=o>=</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>current</span><span class=o>.</span><span class=na>onResourceDequeued</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setDequeuedResourceCallback</span><span class=o>(</span><span class=n>DequeuedResourceCallback</span> <span class=n>cb</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>interface</span> <span class=nc>DequeuedResourceCallback</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>onResourceDequeued</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>shutdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>isShutdown</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>monitorClearedResourcesExecutor</span> <span class=k>instanceof</span> <span class=n>ExecutorService</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ExecutorService</span> <span class=n>service</span> <span class=o>=</span> <span class=o>(</span><span class=n>ExecutorService</span><span class=o>)</span> <span class=n>monitorClearedResourcesExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>Executors</span><span class=o>.</span><span class=na>shutdownAndAwaitTermination</span><span class=o>(</span><span class=n>service</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ResourceWeakReference</span> <span class=kd>extends</span> <span class=n>WeakReference</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isCacheable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>referent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ReferenceQueue</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>queue</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>super</span><span class=o>(</span><span class=n>referent</span><span class=o>,</span> <span class=n>queue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>resource</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>referent</span><span class=o>.</span><span class=na>isMemoryCacheable</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>isActiveResourceRetentionAllowed</span>
</span></span><span class=line><span class=cl>              <span class=o>?</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>referent</span><span class=o>.</span><span class=na>getResource</span><span class=o>())</span>
</span></span><span class=line><span class=cl>              <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>isCacheable</span> <span class=o>=</span> <span class=n>referent</span><span class=o>.</span><span class=na>isMemoryCacheable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>reset</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>resource</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…ˆæ¥çœ‹ ResourceWeakReferenceï¼Œ<code>extends WeakReference&lt;EngineResource&lt;?>></code> è¡¨ç¤ºå®ƒç»§æ‰¿è‡ª WeakReference å¹¶ä¸”ç”¨äºä¿å­˜ EngineResource ç±»å‹çš„å¼•ç”¨ï¼Œæ­¤å¤–æ·»åŠ äº†ä¸€ä¸ª reset æ–¹æ³•ç”¨æ¥æ¸…ç†èµ„æºã€‚</p><p>æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº† super(referent, queue)ï¼Œè¿™æ ·å¦‚æœ referent æŒ‡å‘çš„å¯¹è±¡å°†è¦è¢« GC çš„æ—¶å€™ï¼Œreferent å°±ä¼šè¢«æ”¾å…¥ queue ä¸­ã€‚</p><p>ActiveResources åˆå§‹åŒ–æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªåä¸ºâ€œglide-active-resourcesâ€çš„ BACKGROUND çš„çº¿ç¨‹ï¼Œåœ¨è¯¥çº¿ç¨‹ä¸­ä¼šè°ƒç”¨ cleanReferenceQueue() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>cleanReferenceQueue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(!</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//remove æ–¹æ³•ä¼šå‘ç”Ÿé˜»å¡
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ResourceWeakReference</span> <span class=n>ref</span> <span class=o>=</span> <span class=o>(</span><span class=n>ResourceWeakReference</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>resourceReferenceQueue</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//æ¸…é™¤èµ„æº
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>cleanupActiveReference</span><span class=o>(</span><span class=n>ref</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>DequeuedResourceCallback</span> <span class=n>current</span> <span class=o>=</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>current</span><span class=o>.</span><span class=na>onResourceDequeued</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è€Œ resourceReferenceQueue.remove() æ–¹æ³•ä¼šä¸€ç›´å°è¯•ä» queue ä¸­è·å–å°†è¦è¢« GC çš„ EngineResourceã€‚å½“å‘ç”Ÿ GC æ—¶ï¼Œå¦‚æœ EngineResource åª ResourceWeakReference å¯¹è±¡æŒæœ‰ï¼ŒResourceWeakReference å¯¹è±¡å°±ä¼šè¢«æ’å…¥åˆ° queue ä¸­ï¼Œè¿™æ—¶åœ¨ remove() æ–¹æ³•å°±èƒ½è·å–åˆ°ä¸€ä¸ª ResourceWeakReference å¯¹è±¡ï¼ˆè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å‹ï¼‰ã€‚</p><p>ç„¶åè°ƒç”¨ cleanupActiveReference æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>cleanupActiveReference</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ResourceWeakReference</span> <span class=n>ref</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//ä»é›†åˆä¸­ç§»é™¤
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>ref</span><span class=o>.</span><span class=na>isCacheable</span> <span class=o>||</span> <span class=n>ref</span><span class=o>.</span><span class=na>resource</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>newResource</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EngineResource</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>ref</span><span class=o>.</span><span class=na>resource</span><span class=o>,</span> <span class=cm>/*isMemoryCacheable=*/</span> <span class=kc>true</span><span class=o>,</span> <span class=cm>/*isRecyclable=*/</span> <span class=kc>false</span><span class=o>,</span> <span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>,</span> <span class=n>listener</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å°†è¢« GC çš„ EngineResource å›è°ƒç»™ listener
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReleased</span><span class=o>(</span><span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>,</span> <span class=n>newResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆä¼šå°†è¯¥å¯¹è±¡ä»é›†åˆä¸­ç§»é™¤ï¼Œç„¶åå†å°† ResourceWeakReference å¯¹è±¡ä¸­çš„èµ„æºå–å‡ºå¹¶å›è°ƒç»™ listenerï¼Œè¿™ä¸ª listener çš„å”¯ä¸€å®ç°åœ¨ Engine ç±»ä¸­ï¼Œåé¢è¿˜ä¼šæœ‰åœ°æ–¹è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œæš‚æ—¶ä¸è¿›è¡Œåˆ†æã€‚</p><p>è¯¥æ–¹æ³•é™¤äº†åœ¨æ­¤æ—¶è¢«è°ƒç”¨å¤–ï¼Œè¿˜åœ¨ ActiveResources.get(key) æ–¹æ³•ä¸­ä¹Ÿå¯èƒ½ä¼šå› ä¸ºè·å–åˆ°çš„ resource ä¸º null è€Œè¢«è°ƒç”¨ã€‚</p><a href=#å†…å­˜ç¼“å­˜-memorycache><h2 id=å†…å­˜ç¼“å­˜-memorycache><span class=hanchor arialabel=Anchor># </span>å†…å­˜ç¼“å­˜ MemoryCache</h2></a><p>MemoryCache å‘ç”Ÿå­˜å–æ“ä½œæ˜¯åœ¨ Engine ä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹åˆ° MemoryCache è¿˜è¢«æ”¾å…¥äº† Glide å®ä¾‹ä¸­ã€‚è¿™æ˜¯å› ä¸º Glide å®ç°äº† ComponentCallbacks2 æ¥å£ï¼Œåœ¨ Glide åˆ›å»ºå®Œæˆåï¼Œå®ä¾‹å°±æ³¨å†Œäº†è¯¥æ¥å£ã€‚è¿™æ ·åœ¨å†…å­˜ç´§å¼ çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡å›è°ƒ onTrimMemory æ–¹æ³•é€šçŸ¥é‡Šæ”¾å†…å­˜ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onTrimMemory</span><span class=o>(</span><span class=kt>int</span> <span class=n>level</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>trimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>trimMemory</span><span class=o>(</span><span class=kt>int</span> <span class=n>level</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Engine asserts this anyway when removing resources, fail faster and consistently
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Util</span><span class=o>.</span><span class=na>assertMainThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Request managers need to be trimmed before the caches and pools, in order for the latter to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// have the most benefit.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>synchronized</span> <span class=o>(</span><span class=n>managers</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>RequestManager</span> <span class=n>manager</span> <span class=o>:</span> <span class=n>managers</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>manager</span><span class=o>.</span><span class=na>onTrimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// memory cache needs to be trimmed before bitmap pool to trim re-pooled Bitmaps too. See #687.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>memoryCache</span><span class=o>.</span><span class=na>trimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>bitmapPool</span><span class=o>.</span><span class=na>trimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayPool</span><span class=o>.</span><span class=na>trimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å‰é¢æåˆ°è¿‡ï¼ŒGlide åˆå§‹åŒ–çš„æ—¶å€™å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡å†…å­˜ç¼“å­˜æ–¹æ¡ˆï¼Œåˆ™ä¼šé‡‡ç”¨é»˜è®¤å®ç°æ–¹æ¡ˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=o>(</span><span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getMemoryCacheSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>LruResourceCache ç»§æ‰¿è‡ª LruCache ç±»å¹¶å®ç°äº† MemoryCache æ¥å£ï¼ŒLruCache ä½¿ç”¨ LRUï¼ˆleast recently usedï¼Œå³æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•å®ç°çš„å†…å­˜æ·˜æ±°ç®—æ³•ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å½“ç¼“å­˜å¯¹è±¡çš„æ•°é‡è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œä¼šä¼˜å…ˆåˆ é™¤é‚£äº›è¿‘æœŸæœ€å°‘ä½¿ç”¨çš„ç¼“å­˜å¯¹è±¡ã€‚</p><p>LruCache å®šä¹‰äº† LRU ç›¸å…³çš„æ“ä½œï¼Œè€Œ MemoryCache å®šä¹‰çš„æ˜¯å†…å­˜ç¼“å­˜ç›¸å…³çš„æ“ä½œã€‚LruResourceCache æºç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LruResourceCache</span> <span class=kd>extends</span> <span class=n>LruCache</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>Resource</span><span class=o>&lt;?&gt;&gt;</span> <span class=kd>implements</span> <span class=n>MemoryCache</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ResourceRemovedListener</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Constructor for LruResourceCache.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * @param size The maximum size in bytes the in memory cache can use.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>LruResourceCache</span><span class=o>(</span><span class=kt>long</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>size</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setResourceRemovedListener</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ResourceRemovedListener</span> <span class=n>listener</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>listener</span> <span class=o>=</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onItemEvicted</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>listener</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>item</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>listener</span><span class=o>.</span><span class=na>onResourceRemoved</span><span class=o>(</span><span class=n>item</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>item</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>item</span><span class=o>.</span><span class=na>getSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>trimMemory</span><span class=o>(</span><span class=kt>int</span> <span class=n>level</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>level</span> <span class=o>&gt;=</span> <span class=n>android</span><span class=o>.</span><span class=na>content</span><span class=o>.</span><span class=na>ComponentCallbacks2</span><span class=o>.</span><span class=na>TRIM_MEMORY_BACKGROUND</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Entering list of cached background apps
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Evict our entire bitmap cache
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>clearMemory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>level</span> <span class=o>&gt;=</span> <span class=n>android</span><span class=o>.</span><span class=na>content</span><span class=o>.</span><span class=na>ComponentCallbacks2</span><span class=o>.</span><span class=na>TRIM_MEMORY_UI_HIDDEN</span>
</span></span><span class=line><span class=cl>        <span class=o>||</span> <span class=n>level</span> <span class=o>==</span> <span class=n>android</span><span class=o>.</span><span class=na>content</span><span class=o>.</span><span class=na>ComponentCallbacks2</span><span class=o>.</span><span class=na>TRIM_MEMORY_RUNNING_CRITICAL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// The app&#39;s UI is no longer visible, or app is in the foreground but system is running
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// critically low on memory
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Evict oldest half of our bitmap cache
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>trimToSize</span><span class=o>(</span><span class=n>getMaxSize</span><span class=o>()</span> <span class=o>/</span> <span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>LruCache</span> <span class=n>çš„æºç å¦‚ä¸‹</span><span class=err>ï¼š</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LruCache</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Y</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;&gt;</span> <span class=n>cache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;(</span><span class=n>100</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>75f</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>initialMaxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>long</span> <span class=n>currentSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>LruCache</span><span class=o>(</span><span class=kt>long</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>initialMaxSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>maxSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>setSizeMultiplier</span><span class=o>(</span><span class=kt>float</span> <span class=n>multiplier</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>multiplier</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Multiplier must be &gt;= 0&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>maxSize</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>round</span><span class=o>(</span><span class=n>initialMaxSize</span> <span class=o>*</span> <span class=n>multiplier</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>evict</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Y</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kd>synchronized</span> <span class=kt>int</span> <span class=nf>getCount</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cache</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onItemEvicted</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Y</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// optional override
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>long</span> <span class=nf>getMaxSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>long</span> <span class=nf>getCurrentSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>currentSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>boolean</span> <span class=nf>contains</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cache</span><span class=o>.</span><span class=na>containsKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>Y</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>entry</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>entry</span><span class=o>.</span><span class=na>value</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>Y</span> <span class=nf>put</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Y</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>itemSize</span> <span class=o>=</span> <span class=n>getSize</span><span class=o>(</span><span class=n>item</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>itemSize</span> <span class=o>&gt;=</span> <span class=n>maxSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>onItemEvicted</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>item</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>item</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>currentSize</span> <span class=o>+=</span> <span class=n>itemSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>old</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>item</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>&lt;&gt;(</span><span class=n>item</span><span class=o>,</span> <span class=n>itemSize</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>old</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>currentSize</span> <span class=o>-=</span> <span class=n>old</span><span class=o>.</span><span class=na>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>old</span><span class=o>.</span><span class=na>value</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>item</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>onItemEvicted</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>old</span><span class=o>.</span><span class=na>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>evict</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>old</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>old</span><span class=o>.</span><span class=na>value</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>Y</span> <span class=nf>remove</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>entry</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>currentSize</span> <span class=o>-=</span> <span class=n>entry</span><span class=o>.</span><span class=na>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>entry</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>clearMemory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>trimToSize</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>trimToSize</span><span class=o>(</span><span class=kt>long</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;&gt;</span> <span class=n>last</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;&gt;&gt;</span> <span class=n>cacheIterator</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>currentSize</span> <span class=o>&gt;</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//ä»å¤´å¼€å§‹éå†
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>cacheIterator</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>entrySet</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>//ç¬¬ä¸€ä¸ªå…ƒç´ 
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>last</span> <span class=o>=</span> <span class=n>cacheIterator</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>toRemove</span> <span class=o>=</span> <span class=n>last</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>currentSize</span> <span class=o>-=</span> <span class=n>toRemove</span><span class=o>.</span><span class=na>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>T</span> <span class=n>key</span> <span class=o>=</span> <span class=n>last</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>cacheIterator</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>onItemEvicted</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>toRemove</span><span class=o>.</span><span class=na>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>void</span> <span class=nf>evict</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>trimToSize</span><span class=o>(</span><span class=n>maxSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Y</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>(</span><span class=n>Y</span> <span class=n>value</span><span class=o>,</span> <span class=kt>int</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>size</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>LruCache å†…éƒ¨æŒæœ‰ä¸€ä¸ª LinkedHashMap çš„å˜é‡ cache ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;&gt;</span> <span class=n>cache</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;(</span><span class=n>100</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>75f</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“ç¬¬ä¸‰ä¸ªå‚æ•° accessOrder ä¸º true æ—¶ï¼Œè¡¨ç¤ºæŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼Œæ¯æ¬¡è°ƒç”¨ LinkedHashMap çš„ get(key) æˆ– getOrDefault(key, defaultValue) æ–¹æ³•éƒ½ä¼šè§¦å‘ afterNodeAccess(Object) æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¼šå°†å¯¹åº”çš„ node ç§»åŠ¨åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚ä¹Ÿå°±æ˜¯è¯´ LinkedHashMap æœ«å°¾çš„æ•°æ®æ˜¯æœ€è¿‘æœ€å¤šä½¿ç”¨çš„ã€‚</p><p>è€Œ LruCache æ¸…é™¤å†…å­˜æ—¶éƒ½ä¼šè°ƒç”¨ trimToSize(size) æ–¹æ³•æ—¶ï¼Œä¼šä»å¤´åˆ°å°¾è¿›è¡Œæ¸…ç†ï¼Œå³æ¸…ç†æ‰æœ€å°‘ä½¿ç”¨çš„å…ƒç´ ã€‚</p><p>LinkedHashMap ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LinkedHashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>LinkedHashMap</span><span class=o>(</span><span class=kt>int</span> <span class=n>initialCapacity</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>loadFactor</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>accessOrder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>initialCapacity</span><span class=o>,</span> <span class=n>loadFactor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>accessOrder</span> <span class=o>=</span> <span class=n>accessOrder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>V</span> <span class=nf>get</span><span class=o>(</span><span class=n>Object</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>getNode</span><span class=o>(</span><span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>),</span> <span class=n>key</span><span class=o>))</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>accessOrder</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>afterNodeAccess</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>V</span> <span class=nf>getOrDefault</span><span class=o>(</span><span class=n>Object</span> <span class=n>key</span><span class=o>,</span> <span class=n>V</span> <span class=n>defaultValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>getNode</span><span class=o>(</span><span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>),</span> <span class=n>key</span><span class=o>))</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>           <span class=k>return</span> <span class=n>defaultValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=o>(</span><span class=n>accessOrder</span><span class=o>)</span>
</span></span><span class=line><span class=cl>           <span class=n>afterNodeAccess</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>       <span class=k>return</span> <span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>afterNodeAccess</span><span class=o>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// move node to last
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>last</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>accessOrder</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>last</span> <span class=o>=</span> <span class=n>tail</span><span class=o>)</span> <span class=o>!=</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>p</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=o>(</span><span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;)</span><span class=n>e</span><span class=o>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>before</span><span class=o>,</span> <span class=n>a</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>after</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=na>after</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>b</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=n>head</span> <span class=o>=</span> <span class=n>a</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>b</span><span class=o>.</span><span class=na>after</span> <span class=o>=</span> <span class=n>a</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=n>a</span><span class=o>.</span><span class=na>before</span> <span class=o>=</span> <span class=n>b</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>last</span> <span class=o>=</span> <span class=n>b</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>last</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=n>head</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>.</span><span class=na>before</span> <span class=o>=</span> <span class=n>last</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>last</span><span class=o>.</span><span class=na>after</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>tail</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>++</span><span class=n>modCount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strongç£ç›˜ç¼“å­˜-diskcachestrong><h2 id=strongç£ç›˜ç¼“å­˜-diskcachestrong><span class=hanchor arialabel=Anchor># </span><strong>ç£ç›˜ç¼“å­˜ DiskCache</strong></h2></a><p>Glide åˆå§‹åŒ–æ—¶ï¼Œå¦‚æœ disCacheFactory å¦‚æœæ²¡æœ‰è¢«æŒ‡å®šï¼Œåˆ™ä¼šä½¿ç”¨ä¸€ä¸ªé»˜è®¤å€¼ï¼Œè€Œè¿™ä¸ª InternalCacheDiskCacheFactory å°±æ˜¯å®ç°ç£ç›˜ç¼“å­˜çš„å…¥å£ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>InternalCacheDiskCacheFactory æºç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>InternalCacheDiskCacheFactory</span> <span class=kd>extends</span> <span class=n>DiskLruCacheFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span><span class=o>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span><span class=o>.</span><span class=na>DEFAULT_DISK_CACHE_SIZE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span><span class=o>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=o>,</span> <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheName</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>CacheDirectoryGetter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>File</span> <span class=n>cacheDirectory</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getCacheDir</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>cacheDirectory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>cacheDirectory</span><span class=o>,</span> <span class=n>diskCacheName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cacheDirectory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>},</span>
</span></span><span class=line><span class=cl>        <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®ƒçš„çˆ¶ç±» DiskLruCacheFactory å’Œ DiskCache ç±»æºç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DiskLruCacheFactory</span> <span class=kd>implements</span> <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CacheDirectoryGetter</span> <span class=n>cacheDirectoryGetter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Interface called out of UI thread to get the cache folder. */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>CacheDirectoryGetter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>DiskLruCacheFactory</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheFolder</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>CacheDirectoryGetter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>diskCacheFolder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>},</span>
</span></span><span class=line><span class=cl>        <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>DiskLruCacheFactory</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheFolder</span><span class=o>,</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheName</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>CacheDirectoryGetter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>diskCacheFolder</span><span class=o>,</span> <span class=n>diskCacheName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>},</span>
</span></span><span class=line><span class=cl>        <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>DiskLruCacheFactory</span><span class=o>(</span><span class=n>CacheDirectoryGetter</span> <span class=n>cacheDirectoryGetter</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>diskCacheSize</span> <span class=o>=</span> <span class=n>diskCacheSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>cacheDirectoryGetter</span> <span class=o>=</span> <span class=n>cacheDirectoryGetter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DiskCache</span> <span class=nf>build</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>File</span> <span class=n>cacheDir</span> <span class=o>=</span> <span class=n>cacheDirectoryGetter</span><span class=o>.</span><span class=na>getCacheDirectory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>cacheDir</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>cacheDir</span><span class=o>.</span><span class=na>isDirectory</span><span class=o>()</span> <span class=o>||</span> <span class=n>cacheDir</span><span class=o>.</span><span class=na>mkdirs</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>DiskLruCacheWrapper</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>cacheDir</span><span class=o>,</span> <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>DiskCache</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/** An interface for lazily creating a disk cache. */</span>
</span></span><span class=line><span class=cl>  <span class=kd>interface</span> <span class=nc>Factory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** 250 MB of cache. */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>DEFAULT_DISK_CACHE_SIZE</span> <span class=o>=</span> <span class=n>250</span> <span class=o>*</span> <span class=n>1024</span> <span class=o>*</span> <span class=n>1024</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>DEFAULT_DISK_CACHE_DIR</span> <span class=o>=</span> <span class=s>&#34;image_manager_disk_cache&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** Returns a new disk cache, or {@code null} if no disk cache could be created. */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>    <span class=n>DiskCache</span> <span class=nf>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/** An interface to actually write data to a key in the disk cache. */</span>
</span></span><span class=line><span class=cl>  <span class=kd>interface</span> <span class=nc>Writer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=nf>write</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>File</span> <span class=n>file</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=nf>get</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>put</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>Writer</span> <span class=n>writer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>delete</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DiskLruCacheFactory.build() æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª DiskLruCacheWrapper ç±»çš„å®ä¾‹ã€‚å›æº¯åˆ°å‰é¢ InternalCacheDiskCacheFactory çš„åˆ›å»ºæµç¨‹å¯çŸ¥ï¼Œé»˜è®¤åˆ›å»ºçš„ DiskLruCacheWrapper ä¼ å…¥çš„ diskCacheSize ä¸º 250M å¹¶ä¸” cacheDir ä¸º <em>/data/data/{package}/cache/image_manager_disk_cache/ </em>ï¼Œåˆ†åˆ«å¯¹åº”ç¼“å­˜å¤§å°å’Œç›®å½•ã€‚</p><p>æ¥ä¸‹æ¥æŸ¥çœ‹ DiskLruCacheWrapper æºç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DiskLruCacheWrapper</span> <span class=kd>implements</span> <span class=n>DiskCache</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TAG</span> <span class=o>=</span> <span class=s>&#34;DiskLruCacheWrapper&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>APP_VERSION</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>VALUE_COUNT</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=n>DiskLruCacheWrapper</span> <span class=n>wrapper</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SafeKeyGenerator</span> <span class=n>safeKeyGenerator</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>File</span> <span class=n>directory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DiskCacheWriteLocker</span> <span class=n>writeLocker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DiskCacheWriteLocker</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>DiskLruCache</span> <span class=n>diskLruCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=n>DiskCache</span> <span class=nf>create</span><span class=o>(</span><span class=n>File</span> <span class=n>directory</span><span class=o>,</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>DiskLruCacheWrapper</span><span class=o>(</span><span class=n>directory</span><span class=o>,</span> <span class=n>maxSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>({</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>,</span> <span class=s>&#34;DeprecatedIsStillUsed&#34;</span><span class=o>})</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=nf>DiskLruCacheWrapper</span><span class=o>(</span><span class=n>File</span> <span class=n>directory</span><span class=o>,</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>directory</span> <span class=o>=</span> <span class=n>directory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>maxSize</span> <span class=o>=</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>safeKeyGenerator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SafeKeyGenerator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>synchronized</span> <span class=n>DiskLruCache</span> <span class=nf>getDiskCache</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>diskLruCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>diskLruCache</span> <span class=o>=</span> <span class=n>DiskLruCache</span><span class=o>.</span><span class=na>open</span><span class=o>(</span><span class=n>directory</span><span class=o>,</span> <span class=n>APP_VERSION</span><span class=o>,</span> <span class=n>VALUE_COUNT</span><span class=o>,</span> <span class=n>maxSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>diskLruCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>File</span> <span class=nf>get</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=o>.</span><span class=na>getSafeKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Get: Obtained: &#34;</span> <span class=o>+</span> <span class=n>safeKey</span> <span class=o>+</span> <span class=s>&#34; for for Key: &#34;</span> <span class=o>+</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>File</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>DiskLruCache</span><span class=o>.</span><span class=na>Value</span> <span class=n>value</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>value</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=na>getFile</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to get from disk cache&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>put</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>Writer</span> <span class=n>writer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=o>.</span><span class=na>getSafeKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>writeLocker</span><span class=o>.</span><span class=na>acquire</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Put: Obtained: &#34;</span> <span class=o>+</span> <span class=n>safeKey</span> <span class=o>+</span> <span class=s>&#34; for for Key: &#34;</span> <span class=o>+</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DiskLruCache</span> <span class=n>diskCache</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Value</span> <span class=n>current</span> <span class=o>=</span> <span class=n>diskCache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>DiskLruCache</span><span class=o>.</span><span class=na>Editor</span> <span class=n>editor</span> <span class=o>=</span> <span class=n>diskCache</span><span class=o>.</span><span class=na>edit</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>editor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Had two simultaneous puts for: &#34;</span> <span class=o>+</span> <span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>File</span> <span class=n>file</span> <span class=o>=</span> <span class=n>editor</span><span class=o>.</span><span class=na>getFile</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=o>(</span><span class=n>writer</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>file</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>editor</span><span class=o>.</span><span class=na>commit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>editor</span><span class=o>.</span><span class=na>abortUnlessCommitted</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to put to disk cache&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>writeLocker</span><span class=o>.</span><span class=na>release</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>delete</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=o>.</span><span class=na>getSafeKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>getDiskCache</span><span class=o>().</span><span class=na>remove</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to delete from disk cache&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>clear</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>getDiskCache</span><span class=o>().</span><span class=na>delete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to clear disk cache or disk cache cleared externally&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>resetDiskCache</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>resetDiskCache</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskLruCache</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¯¥ç±»ä¸»è¦æä¾›äº†ä¸€ä¸ªç”Ÿæˆ Key çš„ SafeKeyGenerator å¯¹è±¡ä»¥åŠå†™é” DiskCacheWriteLockerã€‚ä»ç±»åæ¥çœ‹è¿™æ˜¯ä¸€ä¸ªåŒ…è£…ç±»ï¼Œåœ¨ä»£ç ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„ get å’Œ put æ–¹æ³•æœ€ç»ˆéƒ½æ˜¯é€šè¿‡ DiskLruCache å¯¹è±¡å»å®ç°çš„ã€‚</p><p>å‰é¢æåˆ°è¿‡ï¼ŒdisCacheFactory å¯¹è±¡ä¼šè¢«ä½œä¸ºå‚æ•°å‚ä¸ Engine çš„æ„é€ ï¼Œåœ¨ Engine çš„æ„é€ æ–¹æ³•ä¸­ä¼šè¢«åŒ…è£…æˆä¸ºä¸€ä¸ª LazyDiskCacheProviderï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Engine</span><span class=o>(</span><span class=n>MemoryCache</span> <span class=n>cache</span><span class=o>,</span> <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span> <span class=n>diskCacheFactory</span><span class=o>,</span> <span class=o>...)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>cache</span> <span class=o>=</span> <span class=n>cache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>diskCacheProvider</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LazyDiskCacheProvider</span><span class=o>(</span><span class=n>diskCacheFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>LazyDiskCacheProvider</span> <span class=n>æºç å¦‚ä¸‹</span><span class=err>ï¼š</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>LazyDiskCacheProvider</span> <span class=kd>implements</span> <span class=n>DecodeJob</span><span class=o>.</span><span class=na>DiskCacheProvider</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span> <span class=n>factory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>DiskCache</span> <span class=n>diskCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>LazyDiskCacheProvider</span><span class=o>(</span><span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span> <span class=n>factory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@VisibleForTesting</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>clearDiskCacheIfCreated</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCache</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DiskCache</span> <span class=nf>getDiskCache</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>diskCache</span> <span class=o>=</span> <span class=n>factory</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>diskCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DiskCacheAdapter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>diskCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>getDiskCache() æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šé€šè¿‡ DCL çš„æ–¹å¼è¿›è€Œè°ƒç”¨ factory çš„ build( ) æ–¹æ³•è¿”å›ä¸€ä¸ª DiskCache ä½œä¸ºå•ä¾‹ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯ Glide ç¼“å­˜çš„ä»‹ç»ï¼Œå‰é¢åŠ è½½æµç¨‹çš„åˆ†æåªæ˜¯åœ¨é¦–æ¬¡åŠ è½½å›¾ç‰‡çš„æ—¶å€™çš„æµç¨‹ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°ç¼“å­˜çš„æ¦‚å¿µï¼Œå› æ­¤æ¥ä¸‹æ¥ç»§ç»­åœ¨ä»¥ä¸Š into æµç¨‹ä¸­é‡ç‚¹åˆ†æç¼“å­˜éƒ¨åˆ†çš„æºç ã€‚</p><a href=#ç¼“å­˜æµç¨‹><h2 id=ç¼“å­˜æµç¨‹><span class=hanchor arialabel=Anchor># </span>ç¼“å­˜æµç¨‹</h2></a><a href=#enginekey><h3 id=enginekey><span class=hanchor arialabel=Anchor># </span>EngineKey</h3></a><p>ä»ä¹‹å‰çš„åˆ†æä¸­å¯çŸ¥ï¼Œæ•´ä¸ªåŠ è½½çš„è¿‡ç¨‹ä½“ç°åœ¨ Engine.load æ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•æ³¨é‡Šå’Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>LoadStatus</span> <span class=nf>load</span><span class=o>(...)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>VERBOSE_IS_LOGGABLE</span> <span class=o>?</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>()</span> <span class=o>:</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>EngineKey</span> <span class=n>key</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>keyFactory</span><span class=o>.</span><span class=na>buildKey</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>model</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>signature</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>height</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>transformations</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>resourceClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>transcodeClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>memoryResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memoryResource</span> <span class=o>=</span> <span class=n>loadFromMemory</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>isMemoryCacheable</span><span class=o>,</span> <span class=n>startTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>memoryResource</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//æ²¡æœ‰è·å–åˆ°æ´»åŠ¨èµ„æºå’Œ MemoryCacheï¼Œåˆ™å¯åŠ¨ Job
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=n>waitForExistingOrStartNewJob</span><span class=o>(...);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Avoid calling back while holding the engine lock, doing so makes it easier for callers to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// deadlock.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>cb</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>memoryResource</span><span class=o>,</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>MEMORY_CACHE</span><span class=o>,</span> <span class=cm>/* isLoadedFromAlternateCacheKey= */</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromMemory</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>EngineKey</span> <span class=n>key</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=o>,</span> <span class=kt>long</span> <span class=n>startTime</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!</span><span class=n>isMemoryCacheable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>loadFromActiveResources</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Loaded resource from active resources&#34;</span><span class=o>,</span> <span class=n>startTime</span><span class=o>,</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>active</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>loadFromCache</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Loaded resource from cache&#34;</span><span class=o>,</span> <span class=n>startTime</span><span class=o>,</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cached</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromActiveResources</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>activeResources</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>active</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>active</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromCache</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>getEngineResourceFromCache</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cached</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>activeResources</span><span class=o>.</span><span class=na>activate</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>cached</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>cached</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>getEngineResourceFromCache</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=k>instanceof</span> <span class=n>EngineResource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Save an object allocation if we&#39;ve cached an EngineResource (the typical case).
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>result</span> <span class=o>=</span> <span class=o>(</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;)</span> <span class=n>cached</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EngineResource</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>cached</span><span class=o>,</span> <span class=cm>/*isMemoryCacheable=*/</span> <span class=kc>true</span><span class=o>,</span> <span class=cm>/*isRecyclable=*/</span> <span class=kc>true</span><span class=o>,</span> <span class=n>key</span><span class=o>,</span> <span class=cm>/*listener=*/</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»æ³¨é‡Šå’Œä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆä¼šæ ¹æ® key å°è¯•ä» loadFromActiveResources() æ–¹æ³•ä¸­è·å– ActiveResourceï¼Œå¦‚æœèƒ½å¤Ÿè·å–åˆ°åˆ™ç›´æ¥è¿”å›ï¼›å¦åˆ™ä» loadFromCache() æ–¹æ³•ä¸­è·å– memory cacheï¼›å¦‚æœä»ç„¶æ²¡æœ‰è·å–åˆ°ï¼Œæœ€åå°±äº¤ç»™äº† Job ä»ç½‘ç»œä¸­è·å–èµ„æºã€‚æ²¡æœ‰æ„å¤–çš„è¯ï¼Œç£ç›˜ç¼“å­˜ä¹Ÿæ˜¯ç”± Job å®Œæˆçš„ã€‚</p><p>åªè¦æ˜¯ç¼“å­˜ï¼Œå°±æœ‰ get å’Œ put æ“ä½œï¼Œä¹Ÿå°±ç¦»ä¸å¼€ Keyï¼Œæ‰€ä»¥å…ˆçœ‹çœ‹ä» ActiveResource å’Œ MemoryCache ä¸­å–ç¼“å­˜æ—¶çš„ Keyâ€”â€”EngineKey çš„ç»„æˆå‚æ•°ï¼š</p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>model</td><td>load çš„å‚æ•°ã€‚å¦‚ï¼šFileã€Urlã€Url ç­‰ã€‚å¦‚æœä½¿ç”¨è‡ªå®šä¹‰çš„ model, å®ƒéœ€è¦æ­£ç¡®åœ°å®ç° hashCode() å’Œ equals()</td></tr><tr><td>signature</td><td>BaseRequestOptions çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤ä¼šæ˜¯ EmptySignature.obtain()<br>åœ¨åŠ è½½æœ¬åœ° resource èµ„æºæ—¶ä¼šå˜æˆ ApplicationVersionSignature.obtain(context)</td></tr><tr><td>width<br>height</td><td>å¦‚æœæ²¡æœ‰æŒ‡å®š override(int size)ï¼Œåˆ™ä¸º view çš„ size</td></tr><tr><td>transformations</td><td>é»˜è®¤ä¼šåŸºäº ImageView çš„ scaleType è®¾ç½®å¯¹åº”çš„å››ä¸ª Transformationï¼›<br>å¦‚æœæŒ‡å®šäº† transformï¼Œé‚£ä¹ˆå°±åŸºäºè¯¥å€¼è¿›è¡Œè®¾ç½®ï¼›<br>è¯¦è§ BaseRequestOptions.transform(Transformation, boolean)</td></tr><tr><td>resourceClass</td><td>è§£ç åçš„èµ„æºï¼Œå¦‚æœæ²¡æœ‰ asBitmapã€asGifï¼Œä¸€èˆ¬ä¼šæ˜¯ Object</td></tr><tr><td>transcodeClass</td><td>æœ€ç»ˆè¦è½¬æ¢æˆçš„æ•°æ®ç±»å‹ï¼Œæ ¹æ® as æ–¹æ³•ç¡®å®šï¼ŒåŠ è½½æœ¬åœ° res æˆ–è€…ç½‘ç»œ URLï¼Œéƒ½ä¼šè°ƒç”¨ asDrawableï¼Œæ‰€ä»¥ä¸º Drawable</td></tr><tr><td>options</td><td>å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡ transformï¼Œæ­¤å¤„ä¼šæ ¹æ® ImageView çš„ scaleType é»˜è®¤æŒ‡å®šä¸€ä¸ª KV</td></tr></tbody></table><p>å†æ¥çœ‹ EngineKey çš„å†…éƒ¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>EngineKey</span> <span class=kd>implements</span> <span class=n>Key</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>o</span> <span class=k>instanceof</span> <span class=n>EngineKey</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>EngineKey</span> <span class=n>other</span> <span class=o>=</span> <span class=o>(</span><span class=n>EngineKey</span><span class=o>)</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>model</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>model</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>signature</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>signature</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>height</span> <span class=o>==</span> <span class=n>other</span><span class=o>.</span><span class=na>height</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>width</span> <span class=o>==</span> <span class=n>other</span><span class=o>.</span><span class=na>width</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>transformations</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>transformations</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>resourceClass</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>resourceClass</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>transcodeClass</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>transcodeClass</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>options</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>hashCode</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>signature</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>width</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>height</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>transformations</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>resourceClass</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>transcodeClass</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>options</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashCode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„ equals å’Œ hashCode æ–¹æ³•éƒ½æ˜¯æ ‡å‡†çš„å†™æ³•ï¼Œæ‰€æœ‰æˆå‘˜å˜é‡éƒ½å‚ä¸äº†åˆ¤æ–­å’Œè¿ç®—ã€‚å› æ­¤åœ¨å¤šæ¬¡åŠ è½½åŒä¸€ä¸ª model çš„è¿‡ç¨‹ä¸­ï¼Œå³ä½¿æœ‰ç¨è®¸æ”¹åŠ¨ï¼ˆæ¯”å¦‚ View å®½é«˜ã€æ˜¯å¦ç»è¿‡å˜æ¢ç­‰ï¼‰ï¼Œéƒ½ä¼šå¯¼è‡´æ²¡æœ‰è·å–å†…å­˜ç¼“å­˜å¤±è´¥ã€‚</p><a href=#å†…å­˜ç¼“å­˜><h3 id=å†…å­˜ç¼“å­˜><span class=hanchor arialabel=Anchor># </span>å†…å­˜ç¼“å­˜</h3></a><a href=#activeresource-å’Œ-memorycache><h4 id=activeresource-å’Œ-memorycache><span class=hanchor arialabel=Anchor># </span>ActiveResource å’Œ MemoryCache</h4></a><p>ActiveResource çš„ Value ä¸º ResourceWeakReferenceï¼Œå®ƒæ˜¯ EngineResource çš„åŒ…è£…ç±»ï¼› MemoryCache åˆ™æ˜¯ç›´æ¥ä¿å­˜ EngineResource å¯¹è±¡ã€‚çœ‹çœ‹ EngineResource çš„å†…å®¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>EngineResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isRecyclable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceListener</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=n>acquired</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>boolean</span> <span class=n>isRecycled</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>interface</span> <span class=nc>ResourceListener</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>toWrap</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>isRecyclable</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Key</span> <span class=n>key</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>ResourceListener</span> <span class=n>listener</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resource</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>toWrap</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>isMemoryCacheable</span> <span class=o>=</span> <span class=n>isMemoryCacheable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>isRecyclable</span> <span class=o>=</span> <span class=n>isRecyclable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>listener</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>listener</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>getResource</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=nf>isMemoryCacheable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>isMemoryCacheable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>getResourceClass</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>resource</span><span class=o>.</span><span class=na>getResourceClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Z</span> <span class=nf>get</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>resource</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>resource</span><span class=o>.</span><span class=na>getSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>recycle</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>acquired</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot recycle a resource while it is still acquired&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isRecycled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot recycle a resource that has already been recycled&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>isRecycled</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isRecyclable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>resource</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>acquire</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isRecycled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot acquire a recycled resource&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>acquired</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>release</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>release</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>acquired</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot release a recycled or not yet acquired resource&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(--</span><span class=n>acquired</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>release</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>release</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReleased</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œacquire() æ–¹æ³•å†…éƒ¨ä¼šå¯¹ä¸€ä¸ªæ•´å‹å˜é‡ acquired è¿›è¡Œè‡ªå¢æ“ä½œï¼Œè¿™ä¸ªå˜é‡è¡¨ç¤ºè¯¥èµ„æºè¢«å¼•ç”¨çš„æ¬¡æ•°ï¼Œå½“å®ƒå¤§äº 0 çš„æ—¶å€™è¡¨ç¤ºå›¾ç‰‡æ­£åœ¨ä½¿ç”¨ä¸­ã€‚ç›¸åº”åœ°ï¼Œåœ¨ release() æ–¹æ³•å†…éƒ¨ä¼š acquired è¿›è¡Œè‡ªå‡ï¼Œå¹¶ä¸”å½“å˜é‡ä¸º 0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ²¡æœ‰è¢«ä»»ä½•åœ°æ–¹å¼•ç”¨ï¼Œè¿™æ—¶ä¼šè°ƒç”¨ listener.onResourceReleased(key, this) é€šçŸ¥ç›‘å¬å™¨èµ„æºå·²è¢«é‡Šæ”¾ï¼Œä»è€Œè¿›è¡Œåç»­æ“ä½œã€‚</p><p>acquire() å’Œ release() æ–¹æ³•åœ¨ä¸€èˆ¬æƒ…å†µä¸‹å¤–éƒ¨æ˜¯ä¸èƒ½ä¸»åŠ¨è°ƒç”¨çš„ï¼Œåªæœ‰ Glide æ¡†æ¶ä¼šåœ¨åˆé€‚çš„æ—¶æœºä¸‹ä¼šè°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p><p>å‰é¢ä»‹ç»æ´»åŠ¨èµ„æºçš„æ—¶å€™å·²ç»æåˆ°è¿‡ï¼ŒEngineResource.ResourceListener å”¯ä¸€å®ç°ç±»ä¸º Engineï¼Œæ¥çœ‹å®ƒçš„å®ç°å†…å®¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=o>(</span><span class=n>Key</span> <span class=n>cacheKey</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//ä» ActiveResource ä¸­åˆ é™¤
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>activeResources</span><span class=o>.</span><span class=na>deactivate</span><span class=o>(</span><span class=n>cacheKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>isMemoryCacheable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å¦‚æœå¼€å¯äº†ç¼“å­˜åˆ™æ”¾å…¥ MemoryCacheÂ 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cache</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>cacheKey</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resourceRecycler</span><span class=o>.</span><span class=na>recycle</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=cm>/*forceNextFrame=*/</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆä¼šå°†ç¼“å­˜å›¾ç‰‡ä»æ´»åŠ¨èµ„æºä¸­ç§»é™¤ï¼Œç„¶åå†å°†å®ƒå­˜å…¥ MemoryCache ä¸­ã€‚å›åˆ°åˆšåˆšåˆ†æçš„ Engine.load æ–¹æ³•ä¸­ï¼Œå†çœ‹ä¸€æ¬¡è·å– ActiveResource å’Œ MemoryCache çš„æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromActiveResources</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>activeResources</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>active</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>active</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromCache</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//ä» MemoryCache ä¸­ç§»é™¤
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>getEngineResourceFromCache</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cached</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//æ”¾å…¥ ActiveResourceÂ ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>activeResources</span><span class=o>.</span><span class=na>activate</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>cached</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>cached</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é™¤äº†ä»æ ¹æ® Key è·å–åˆ° EngineResource ä¹‹å¤–ï¼Œä¸­é—´è¿˜è°ƒç”¨äº† active.acquire() æ–¹æ³•ã€‚åªè¦å‘½ä¸­äº†ç¼“å­˜ï¼Œé‚£ä¹ˆè¯¥èµ„æºçš„å¼•ç”¨è®¡æ•°å°±ä¼šåŠ ä¸€ã€‚è€Œä¸”ï¼Œå¦‚æœå‘½ä¸­çš„æ˜¯ MemoryCacheï¼Œé‚£ä¹ˆæ­¤èµ„æºä¼šè¢«ç§»åŠ¨åˆ° ActiveResource ä¸­ã€‚</p><p>ç»“åˆåˆšæ‰çš„åˆ†æè¿‡ç¨‹å¯çŸ¥ï¼ŒEngineResource åœ¨ ActiveResource å’Œ MemoryCache ä¸­æ˜¯äº’æ–¥å­˜åœ¨çš„ã€‚æ­£åœ¨ä½¿ç”¨ä¸­çš„å›¾ç‰‡ä½¿ç”¨å¼±å¼•ç”¨ï¼ˆActiveResourceï¼‰æ¥è¿›è¡Œç¼“å­˜ï¼Œä¸åœ¨ä½¿ç”¨ä¸­å’Œè¢« GC å›æ”¶çš„å›¾ç‰‡ä½¿ç”¨ LruCahceï¼ˆMemoryCacheï¼‰ æ¥è¿›è¡Œç¼“å­˜ã€‚</p><a href=#ç£ç›˜ç¼“å­˜><h3 id=ç£ç›˜ç¼“å­˜><span class=hanchor arialabel=Anchor># </span>ç£ç›˜ç¼“å­˜</h3></a><a href=#decocejob><h4 id=decocejob><span class=hanchor arialabel=Anchor># </span>DecoceJob</h4></a><p>å›åˆ° Engine.load() æ–¹æ³•ä¸­ï¼Œå¦‚æœæ˜¯é¦–æ¬¡åŠ è½½èµ„æºï¼Œé‚£ä¹ˆ ActiveResouce å’Œ MemoryCache ä¸­å¿…ç„¶æ²¡æœ‰ç¼“å­˜ä¸‹æ¥ï¼Œæ¥ç€ä¼šèµ° waitForExistingOrStartNewJob() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>LoadStatus</span> <span class=nf>waitForExistingOrStartNewJob</span><span class=o>(...)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>engineJob</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>engineJobFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>key</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>isMemoryCacheable</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>useUnlimitedSourceExecutorPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>useAnimationPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>onlyRetrieveFromCache</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>decodeJobFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(...);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>jobs</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>engineJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>engineJob</span><span class=o>.</span><span class=na>addCallback</span><span class=o>(</span><span class=n>cb</span><span class=o>,</span> <span class=n>callbackExecutor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>engineJob</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=n>decodeJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Started new load&#34;</span><span class=o>,</span> <span class=n>startTime</span><span class=o>,</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=o>(</span><span class=n>cb</span><span class=o>,</span> <span class=n>engineJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DecoceJob å®ç°äº† Runnable æ¥å£ï¼Œç„¶åä¼šè¢« EngineJob.start() æ–¹æ³•æäº¤åˆ°å¯¹åº”çš„çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œï¼ŒæŸ¥çœ‹ DecoceJob.run() æ–¹æ³•çš„è°ƒç”¨æ ˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>.</span>    
</span></span><span class=line><span class=cl>    <span class=n>runWrapped</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>.</span>    
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runWrapped</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=o>(</span><span class=n>runReason</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>INITIALIZE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=o>(</span><span class=n>Stage</span><span class=o>.</span><span class=na>INITIALIZE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>SWITCH_TO_SOURCE_SERVICE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>DECODE_DATA</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>decodeFromRetrievedData</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Unrecognized run reason: &#34;</span> <span class=o>+</span> <span class=n>runReason</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Stage</span> <span class=nf>getNextStage</span><span class=o>(</span><span class=n>Stage</span> <span class=n>current</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=o>(</span><span class=n>current</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>INITIALIZE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=o>.</span><span class=na>decodeCachedResource</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>Stage</span><span class=o>.</span><span class=na>RESOURCE_CACHE</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=n>getNextStage</span><span class=o>(</span><span class=n>Stage</span><span class=o>.</span><span class=na>RESOURCE_CACHE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=o>.</span><span class=na>decodeCachedData</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>Stage</span><span class=o>.</span><span class=na>DATA_CACHE</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=n>getNextStage</span><span class=o>(</span><span class=n>Stage</span><span class=o>.</span><span class=na>DATA_CACHE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Skip loading from source if the user opted to only retrieve the resource from cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=n>onlyRetrieveFromCache</span> <span class=o>?</span> <span class=n>Stage</span><span class=o>.</span><span class=na>FINISHED</span> <span class=o>:</span> <span class=n>Stage</span><span class=o>.</span><span class=na>SOURCE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>SOURCE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>FINISHED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Stage</span><span class=o>.</span><span class=na>FINISHED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Unrecognized stage: &#34;</span> <span class=o>+</span> <span class=n>current</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>DataFetcherGenerator</span> <span class=nf>getNextGenerator</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=o>(</span><span class=n>stage</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>ResourceCacheGenerator</span><span class=o>(</span><span class=n>decodeHelper</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=o>(</span><span class=n>decodeHelper</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>SOURCE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>SourceGenerator</span><span class=o>(</span><span class=n>decodeHelper</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>FINISHED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Unrecognized stage: &#34;</span> <span class=o>+</span> <span class=n>stage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runGenerators</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>currentThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>startFetchTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>isStarted</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=o>(!</span><span class=n>isCancelled</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>currentGenerator</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=o>!(</span><span class=n>isStarted</span> <span class=o>=</span> <span class=n>currentGenerator</span><span class=o>.</span><span class=na>startNext</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=o>(</span><span class=n>stage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=o>.</span><span class=na>SOURCE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>reschedule</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We&#39;ve run out of stages and generators, give up.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>((</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=o>.</span><span class=na>FINISHED</span> <span class=o>||</span> <span class=n>isCancelled</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isStarted</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>notifyFailed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Otherwise a generator started a new load and we expect to be called back in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// onDataFetcherReady.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DecoceJob.run() ä¸­ä¸»è¦è°ƒç”¨äº† runWrapped() æ–¹æ³•ã€‚åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œé¦–æ¬¡åŠ è½½æ—¶ runReason ä¸ºåˆå§‹åŒ–å³ RunReason.INITIALIZE çŠ¶æ€ ï¼Œåˆ diskCacheStrategy é»˜è®¤ä¸º DiskCacheStrategy.AUTOMATICï¼Œä¸”æ²¡æœ‰è®¾ç½®è¿‡ onlyRetrieveFromCache(true)ã€‚æ‰€ä»¥ï¼Œ decode data çš„çŠ¶æ€ä¾æ¬¡ä¸º INITIALIZEÂ ->Â RESOURCE_CACHEÂ ->Â DATA_CACHEÂ ->Â SOURCEÂ ->Â FINISHEDã€‚å¯¹åº”çš„ DataFectcherGenerator çš„ list ä¾æ¬¡ä¸º ResourceCacheGeneratorÂ ->Â DataCacheGeneratorÂ ->Â SourceGeneratorã€‚</p><p>åœ¨ runGenerators() æ–¹æ³•ä¸­ä¼šä¾æ¬¡è°ƒç”¨å„ä¸ªçŠ¶æ€ç”Ÿæˆçš„ DataFetcherGenerator çš„ startNext() æ–¹æ³•å°è¯• fetch æ•°æ®ï¼Œç›´åˆ°æœ‰æŸä¸ªçŠ¶æ€çš„ DataFetcherGenerator.startNext() æ–¹æ³•å¯ä»¥èƒœä»»ã€‚è‹¥çŠ¶æ€æŠµè¾¾åˆ°äº† Stage.FINISHED æˆ– Job è¢«å–æ¶ˆï¼Œä¸”æ‰€æœ‰çŠ¶æ€çš„ DataFetcherGenerator.startNext() éƒ½æ— æ³•æ»¡è¶³æ¡ä»¶ï¼Œåˆ™è°ƒç”¨ SingleRequest.onLoadFailed() è¿›è¡Œé”™è¯¯å¤„ç†ã€‚</p><p>è¿™é‡Œæ€»å…±æœ‰ä¸‰ä¸ª DataFetcherGeneratorï¼Œä¾æ¬¡æ˜¯ï¼š</p><ol><li><strong>ResourceCacheGenerator</strong>ï¼šè·å–é‡‡æ ·åã€transformed åèµ„æºæ–‡ä»¶çš„ç¼“å­˜æ–‡ä»¶</li><li><strong>DataCacheGenerator</strong>ï¼šè·å–åŸå§‹çš„æ²¡æœ‰ä¿®æ”¹è¿‡çš„èµ„æºæ–‡ä»¶çš„ç¼“å­˜æ–‡ä»¶</li><li><strong>SourceGenerator</strong>ï¼šè·å–åŸå§‹æºæ•°æ®ï¼Œå³ä»ç½‘ç»œä¸‹è½½æˆ–è€…ä»æœ¬åœ°èµ„æºä¸­åŠ è½½</li></ol><a href=#resourcecachekey-å’Œ-datacachekey><h4 id=resourcecachekey-å’Œ-datacachekey><span class=hanchor arialabel=Anchor># </span>ResourceCacheKey å’Œ DataCacheKey</h4></a><p>çœ‹ä»¥çœ‹åˆ°ï¼ŒResourceCacheGenerator å’Œ DataCacheGenerator åˆ†åˆ«å¯¹åº” Resource å’Œ Data ç±»å‹çš„ç¼“å­˜æ•°æ®ï¼Œéƒ½å±äºç£ç›˜ç¼“å­˜çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆè¿™ä¸¤ç§æ•°æ®çš„å­˜å–è§„åˆ™æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><p>å…ˆçœ‹çœ‹ ResourceCacheGenerator ä¸­æŸ¥æ‰¾ç¼“å­˜æ—¶ key çš„ç»„æˆéƒ¨åˆ†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>currentKey</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getArrayPool</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>sourceId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getSignature</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>transformation</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>resourceClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>å®ƒçš„å„ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>helper.getArrayPool()</td><td>GlideBuilder.build æ—¶åˆå§‹åŒ–ï¼Œé»˜è®¤ä¸º LruArrayPoolï¼›ä½†ä¸å‚ä¸ key çš„ equals æ–¹æ³•</td></tr><tr><td>sourceId</td><td>å¦‚æœè¯·æ±‚çš„æ˜¯ URLï¼Œé‚£ä¹ˆæ­¤å¤„ä¼šæ˜¯ä¸€ä¸ª GlideUrl</td></tr><tr><td>helper.getSignature()</td><td>BaseRequestOptions çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤ä¼šæ˜¯ EmptySignature.obtain()<br>åœ¨åŠ è½½æœ¬åœ° resource èµ„æºæ—¶ä¼šå˜æˆ ApplicationVersionSignature.obtain(context)</td></tr><tr><td>helper.getWidth()<br>helper.getHeight()</td><td>å¦‚æœæ²¡æœ‰æŒ‡å®š override(int size)ï¼Œé‚£ä¹ˆå°†å¾—åˆ° view çš„ size</td></tr><tr><td>transformation</td><td>é»˜è®¤ä¼šæ ¹æ® ImageView çš„ scaleType è®¾ç½®å¯¹åº”çš„ BitmapTransformationï¼›<br>å¦‚æœæŒ‡å®šäº† transformï¼Œé‚£å°±æ˜¯æŒ‡å®šçš„å€¼</td></tr><tr><td>resourceClass</td><td>å¯ä»¥è¢«ç¼–ç æˆçš„èµ„æºç±»å‹ï¼Œæ¯”å¦‚ BitmapDrawable ç­‰</td></tr><tr><td>helper.getOptions()</td><td>å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡ transformï¼Œæ­¤å¤„ä¼šæ ¹æ® ImageView çš„ scaleType é»˜è®¤æŒ‡å®šä¸€ä¸ª KV</td></tr></tbody></table><p>åœ¨ ResourceCacheKey ä¸­ï¼ŒarrayPool å¹¶æ²¡æœ‰å‚ä¸ equals æ–¹æ³•ï¼Œæ‰€ä»¥åˆ¤æ–­ä¸¤ä¸ª ResourceCacheKey æ˜¯å¦ç›¸ç­‰åªéœ€è¦å…¶ä»– 7 ä¸ªå‚æ•°ã€‚</p><p>ç„¶åçœ‹çœ‹ DataCacheGenerator ä¸­ Key çš„ç»„æˆéƒ¨åˆ†ï¼š</p><p>Key originalKey = new DataCacheKey(sourceId, helper.getSignature());</p><p>å®ƒçš„å„ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>sourceId</td><td>å¦‚æœè¯·æ±‚çš„æ˜¯ URLï¼Œé‚£ä¹ˆæ­¤å¤„ä¼šæ˜¯ä¸€ä¸ª GlideUrl</td></tr><tr><td>helper.getSignature()</td><td>BaseRequestOptions çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤ä¼šæ˜¯ EmptySignature.obtain()<br>åœ¨åŠ è½½æœ¬åœ° resource èµ„æºæ—¶ä¼šå˜æˆ ApplicationVersionSignature.obtain(context)</td></tr></tbody></table><p>åœ¨ DataCacheKey ä¸­ï¼Œä»…æœ‰çš„ä¸¤ä¸ªå˜é‡éƒ½å‚ä¸äº† equals æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªå˜é‡å°±æ˜¯ä¸Šé¢ ResourceCacheKey ä¸­çš„ä¸¤ä¸ªå˜é‡ã€‚</p><p>æ˜¾ç„¶ï¼ŒData Cache å°±æ˜¯æ¯”è¾ƒåŸå§‹çš„æ•°æ®æ„æˆçš„ç¼“å­˜ï¼Œè€Œ Resource Cache æ˜¯è¢«è§£ç ã€è½¬æ¢åçš„ Data Cacheï¼Œä¸å‰é¢çš„åˆ†æå‘¼åº”èµ·æ¥äº†ã€‚</p><a href=#resourcecachegenerator><h4 id=resourcecachegenerator><span class=hanchor arialabel=Anchor># </span>ResourceCacheGenerator</h4></a><p>å…ˆæ¥çœ‹ ResourceCacheGenerator çš„ startNext() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=o>...</span>
</span></span><span class=line><span class=cl> <span class=k>while</span> <span class=o>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span>
</span></span><span class=line><span class=cl>   <span class=n>currentKey</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>       <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=o>(</span><span class=c1>// NOPMD AvoidInstantiatingObjectsInLoops
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=n>helper</span><span class=o>.</span><span class=na>getArrayPool</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>           <span class=n>sourceId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=n>helper</span><span class=o>.</span><span class=na>getSignature</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>           <span class=n>helper</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>           <span class=n>helper</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>           <span class=n>transformation</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=n>resourceClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span><span class=line><span class=cl>   <span class=c1>//æ ¹æ® ResourceCacheKey è·å–ç¼“å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getDiskCache</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>currentKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=c1>//å¦‚æœæ‰¾åˆ°äº†ç¼“å­˜æ–‡ä»¶ï¼Œé‚£ä¹ˆå¾ªç¯æ¡ä»¶åˆ™ä¼šä¸º falseï¼Œä¹Ÿå°±é€€å‡ºå¾ªç¯äº†
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=o>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>     <span class=n>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>     <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getModelLoaders</span><span class=o>(</span><span class=n>cacheFile</span><span class=o>);</span>
</span></span><span class=line><span class=cl>     <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=c1>// å¦‚æœæ‰¾åˆ°äº†ï¼ŒhasNextModelLoader() æ–¹æ³•åˆ™ä¼šä¸º trueï¼Œå¯ä»¥æ‰§è¡Œå¾ªç¯
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜æ–‡ä»¶ï¼Œåˆ™ä¸ä¼šè¿›å…¥å¾ªç¯ï¼Œä¼šç›´æ¥è¿”å› false
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl> <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl> <span class=k>while</span> <span class=o>(!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>modelLoaderIndex</span><span class=o>++);</span>
</span></span><span class=line><span class=cl>   <span class=c1>// åœ¨å¾ªç¯ä¸­ä¼šä¾æ¬¡åˆ¤æ–­æŸä¸ª ModelLoader èƒ½ä¸èƒ½åŠ è½½æ­¤æ–‡ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>loadData</span> <span class=o>=</span> <span class=n>modelLoader</span><span class=o>.</span><span class=na>buildLoadData</span><span class=o>(</span><span class=n>cacheFile</span><span class=o>,</span>
</span></span><span class=line><span class=cl>       <span class=n>helper</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span> <span class=n>helper</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span> <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=o>.</span><span class=na>hasLoadPath</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>     <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>     <span class=c1>// å¦‚æœæŸä¸ª ModelLoader å¯ä»¥ï¼Œé‚£ä¹ˆå°±è°ƒç”¨å…¶ fetcher è¿›è¡ŒåŠ è½½æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=c1>// åŠ è½½æˆåŠŸæˆ–å¤±è´¥ä¼šé€šçŸ¥è‡ªèº«
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>loadData</span><span class=o>(</span><span class=n>helper</span><span class=o>.</span><span class=na>getPriority</span><span class=o>(),</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=n>started</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è·å–ç¼“å­˜çš„é‚£è¡Œä»£ç  helper.getDiskCache().get(currentKey) å°†ä¼šè°ƒç”¨åˆ° DiskLruCacheWrapper.get æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>File</span> <span class=nf>get</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//ç”Ÿæˆä¸€ä¸ª String ç±»å‹çš„ SafeKey
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=o>.</span><span class=na>getSafeKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Get: Obtained: &#34;</span> <span class=o>+</span> <span class=n>safeKey</span> <span class=o>+</span> <span class=s>&#34; for for Key: &#34;</span> <span class=o>+</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//çœŸæ­£å»è·å–ç£ç›˜æ–‡ä»¶ç¼“å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>DiskLruCache</span><span class=o>.</span><span class=na>Value</span> <span class=n>value</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>value</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=na>getFile</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to get from disk cache&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆä¼šä½¿ç”¨ Key æ˜ å°„æˆä¸€ä¸ª String ç±»å‹çš„ safeKeyï¼Œæ¥ç€æ ¹æ®è¿™ä¸ª safeKey ä» DiskCache ä¸­è·å–ç¼“å­˜ã€‚</p><p>å›åˆ° ResourceCacheGenerator ä¸­ï¼Œå¦‚æœç¡®å®æœ‰ç¼“å­˜ï¼Œé‚£ä¹ˆä¼šåŠ è½½è¯¥ç¼“å­˜æ–‡ä»¶ã€‚å¯¹äº URL æ¥è¯´ï¼Œè°ƒç”¨äº† ByteBufferFetcher è¿›è¡Œç¼“å­˜æ–‡ä»¶çš„åŠ è½½ï¼ŒåŠ è½½æˆåŠŸäº†è¿”å›äº†ä¸€ä¸ª ByteBufferï¼Œå¹¶è°ƒç”¨äº† callback ä¹Ÿ å°±æ˜¯ ResourceCacheGenerator çš„ onDataReady æ–¹æ³•ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=o>(</span><span class=n>Object</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>cb</span><span class=o>.</span><span class=na>onDataFetcherReady</span><span class=o>(</span><span class=n>sourceKey</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>,</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>currentKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶å ResourceCacheGenerator åˆä¼šå›è°ƒ DecodeJob çš„ onDataFetcherReady æ–¹æ³•è¿›è¡Œåç»­çš„è§£ç æ“ä½œã€‚</p><p>å¦‚æœæ²¡æœ‰åœ¨ ResourceCacheGenerator ä¸­è¢« fetchï¼Œåˆ™ä¼šå›è°ƒ onLoadFailed() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>cb</span><span class=o>.</span><span class=na>onDataFetcherFailed</span><span class=o>(</span><span class=n>currentKey</span><span class=o>,</span> <span class=n>e</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>,</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åé¢ DataCacheGenerator å’Œ SourceGenerator çš„æˆåŠŸå›è°ƒéƒ½ä¼šåˆ°è¿™é‡Œæ¥ã€‚</p><p>æ¥ç€å›è°ƒåˆ° DecodeJob ä¸­ç»§ç»­æ‰§è¡Œ runGenerators() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherFailed</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Key</span> <span class=n>attemptedKey</span><span class=o>,</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>fetcher</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=s>&#34;Fetching data failed&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>exception</span><span class=o>.</span><span class=na>setLoggingDetails</span><span class=o>(</span><span class=n>attemptedKey</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>throwables</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>exception</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=o>.</span><span class=na>SWITCH_TO_SOURCE_SERVICE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>reschedule</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#datacachegenerator><h4 id=datacachegenerator><span class=hanchor arialabel=Anchor># </span>DataCacheGenerator</h4></a><p>DecodeJob.runGenerators æ–¹æ³•ä¸­ï¼Œç»§ç»­æ‰§è¡Œ while å¾ªç¯å°†ä¼šè°ƒç”¨ DataCacheGenerator çš„ startNext() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=o>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sourceIdIndex</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>sourceIdIndex</span> <span class=o>&gt;=</span> <span class=n>cacheKeys</span><span class=o>.</span><span class=na>size</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Key</span> <span class=n>sourceId</span> <span class=o>=</span> <span class=n>cacheKeys</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>sourceIdIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// PMD.AvoidInstantiatingObjectsInLoops The loop iterates a limited number of times
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// and the actions it performs are much more expensive than a single allocation.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;PMD.AvoidInstantiatingObjectsInLoops&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Key</span> <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=o>(</span><span class=n>sourceId</span><span class=o>,</span> <span class=n>helper</span><span class=o>.</span><span class=na>getSignature</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getDiskCache</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>originalKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getModelLoaders</span><span class=o>(</span><span class=n>cacheFile</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=o>(!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>modelLoaderIndex</span><span class=o>++);</span>
</span></span><span class=line><span class=cl>    <span class=n>loadData</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>modelLoader</span><span class=o>.</span><span class=na>buildLoadData</span><span class=o>(</span><span class=n>cacheFile</span><span class=o>,</span> <span class=n>helper</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span> <span class=n>helper</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=o>.</span><span class=na>hasLoadPath</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>loadData</span><span class=o>(</span><span class=n>helper</span><span class=o>.</span><span class=na>getPriority</span><span class=o>(),</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>started</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>hasNextModelLoader</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>modelLoaderIndex</span> <span class=o>&lt;</span> <span class=n>modelLoaders</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿‡ç¨‹å’Œ ResourceCacheGenerator ç›¸ä¼¼ï¼Œç”±äºè·å–çš„æ˜¯åŸå§‹çš„æºæ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œçš„ key çš„ç»„æˆéå¸¸ç®€å•ã€‚</p><a href=#sourcegenerator><h4 id=sourcegenerator><span class=hanchor arialabel=Anchor># </span>SourceGenerator</h4></a><p>ç”±äºæ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œæœ¬åœ°ç¼“å­˜æ–‡ä»¶è‚¯å®šæ˜¯æ²¡æœ‰çš„ï¼Œæ¥ç€ä¼šè°ƒç”¨ SourceGenerator çš„ startNext() æ–¹æ³•ä»ç½‘ç»œæˆ–è€…æœ¬åœ°èµ„æºä¸­åŠ è½½ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>loadDataListIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// é¦–æ¬¡è¿è¡Œ dataToCache ä¸º null
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cacheData</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// é¦–æ¬¡è¿è¡Œ sourceCacheGenerator ä¸º null
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=o>.</span><span class=na>startNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>sourceCacheGenerator</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å‡†å¤‡åŠ è½½æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è¿™é‡Œç›´æ¥è°ƒç”¨äº† DecodeHelper.getLoadData() æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// è¯¥æ–¹æ³•åœ¨å‰é¢åœ¨ ResourceCacheGenerator ä¸­è¢«è°ƒç”¨è¿‡ï¼Œä¸”è¢«ç¼“å­˜äº†ä¸‹æ¥
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>while</span> <span class=o>(!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>loadData</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getLoadData</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>loadDataListIndex</span><span class=o>++);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>helper</span><span class=o>.</span><span class=na>getDiskCacheStrategy</span><span class=o>().</span><span class=na>isDataCacheable</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataSource</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>||</span> <span class=n>helper</span><span class=o>.</span><span class=na>hasLoadPath</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>())))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>//è°ƒç”¨ MultiFetcher.loadDataï¼Œç„¶åç”¨ this æ¥æ”¶å›è°ƒ
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>loadData</span><span class=o>(</span><span class=n>helper</span><span class=o>.</span><span class=na>getPriority</span><span class=o>(),</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>started</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>hasNextModelLoader</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>loadDataListIndex</span> <span class=o>&lt;</span> <span class=n>helper</span><span class=o>.</span><span class=na>getLoadData</span><span class=o>().</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>helper.getLoadData() çš„å€¼åœ¨ ResourceCacheGenerator ä¸­å°±å·²ç»è¢«è·å–å¹¶ç¼“å­˜ä¸‹æ¥äº†ï¼Œè¿™æ˜¯ä¸€ä¸ª MultiModelLoader å¯¹è±¡ç”Ÿæˆçš„ LoadData å¯¹è±¡ï¼ŒLoadData å¯¹è±¡é‡Œé¢æœ‰ä¸¤ä¸ª fetcherã€‚</p><p>åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼Œä¼šéå† LoadData listï¼Œæ‰¾å‡ºç¬¦åˆæ¡ä»¶çš„ LoadDataï¼Œç„¶åè°ƒç”¨ loadData.fetcher.loadData åŠ è½½æ•°æ®ã€‚</p><p>åœ¨ loadData ä¸ä¸ºç©ºçš„å‰æä¸‹ï¼Œä¼šåˆ¤æ–­ Glide çš„ç¼“å­˜ç­–ç•¥æ˜¯å¦å¯ä»¥ç¼“å­˜æ­¤æ•°æ®æºï¼Œæˆ–è€…æ˜¯å¦æœ‰åŠ è½½è·¯å¾„ã€‚é»˜è®¤æƒ…å†µä¸‹ Glide çš„ç¼“å­˜ç­–ç•¥æ˜¯ DiskCacheStrategy.AUTOMATICï¼Œå®ƒçš„ isDataCacheable å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDataCacheable</span><span class=o>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//DataSource.REMOTE ä»£è¡¨ç½‘ç»œèµ„æº
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>REMOTE</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å†çœ‹ä¸‹ loadData.fetcher.getDataSource()ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;,</span> <span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>getDataSource</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//fetchers æ•°ç»„ä¿å­˜çš„ä¸¤ä¸ª DataFetcher éƒ½æ˜¯ HttpUrlFetcher
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>fetchers</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>0</span><span class=o>).</span><span class=na>getDataSource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HttpUrlFetcher</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>InputStream</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>getDataSource</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>REMOTE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ˜¾ç„¶ï¼ŒGlide çš„ç¼“å­˜ç­–ç•¥æ˜¯å¯ä»¥ç¼“å­˜æ­¤æ•°æ®æºçš„ï¼Œæ‰€ä»¥ä¼šè¿›è¡Œæ•°æ®åŠ è½½ã€‚æ¥ç€çœ‹çœ‹ MultiFetcher.loadData æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;,</span> <span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>fetchers</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=n>currentIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Priority</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callback</span> <span class=o>=</span> <span class=n>callback</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>exceptions</span> <span class=o>=</span> <span class=n>throwableListPool</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>fetchers</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>currentIndex</span><span class=o>).</span><span class=na>loadData</span><span class=o>(</span><span class=n>priority</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If a race occurred where we cancelled the fetcher in cancel() and then called loadData here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// immediately after, make sure that we cancel the newly started fetcher. We don&#39;t bother
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// checking cancelled before loadData because it&#39;s not required for correctness and would
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// require an unlikely race to be useful.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>isCancelled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Data</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>callback</span><span class=o>.</span><span class=na>onDataReady</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>startNextOrFail</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>exceptions</span><span class=o>).</span><span class=na>add</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>startNextOrFail</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>void</span> <span class=nf>startNextOrFail</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isCancelled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>currentIndex</span> <span class=o>&lt;</span> <span class=n>fetchers</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>currentIndex</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>      <span class=n>loadData</span><span class=o>(</span><span class=n>priority</span><span class=o>,</span> <span class=n>callback</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>exceptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>callback</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=s>&#34;Fetch failed&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>exceptions</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé¢ä¸¤ä¸ª DataFetcher éƒ½æ˜¯å‚æ•°ç›¸åŒçš„ HttpUrlFetcher å®ä¾‹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹é‡Œé¢å¦‚ä½•ä»ç½‘ç»œåŠ è½½å›¾ç‰‡çš„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//è·å– InputStream 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>InputStream</span> <span class=n>result</span> <span class=o>=</span> <span class=n>loadDataWithRedirects</span><span class=o>(</span><span class=n>glideUrl</span><span class=o>.</span><span class=na>toURL</span><span class=o>(),</span> <span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>glideUrl</span><span class=o>.</span><span class=na>getHeaders</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å°†ç»“æœå›è°ƒç»™ MultiFetcher
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>callback</span><span class=o>.</span><span class=na>onDataReady</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Failed to load data for url&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Finished http url fetcher fetch in &#34;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getElapsedMillis</span><span class=o>(</span><span class=n>startTime</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå°†è¯·æ±‚æ“ä½œæ”¾åˆ°äº† loadDataWithRedirects() æ–¹æ³•ä¸­ï¼Œç„¶åå°†è¯·æ±‚ç»“æœé€šè¿‡å›è°ƒè¿”å›ä¸Šä¸€å±‚ä¹Ÿå°±æ˜¯ MultiFetcher.onDataReady() ä¸­ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>InputStream</span> <span class=nf>loadDataWithRedirects</span><span class=o>(</span><span class=n>URL</span> <span class=n>url</span><span class=o>,</span> <span class=kt>int</span> <span class=n>redirects</span><span class=o>,</span> <span class=n>URL</span> <span class=n>lastUrl</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headers</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ£€æŸ¥é‡å®šå‘æ¬¡æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>redirects</span> <span class=o>&gt;=</span> <span class=n>MAXIMUM_REDIRECTS</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=s>&#34;Too many (&gt; &#34;</span> <span class=o>+</span> <span class=n>MAXIMUM_REDIRECTS</span> <span class=o>+</span> <span class=s>&#34;) redirects!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Comparing the URLs using .equals performs additional network I/O and is generally broken.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// See http://michaelscharf.blogspot.com/2006/11/javaneturlequals-and-hashcode-make.html.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// æ£€æŸ¥æ˜¯ä¸æ˜¯é‡å®šå‘åˆ°è‡ªèº«äº†
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=o>(</span><span class=n>lastUrl</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>url</span><span class=o>.</span><span class=na>toURI</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>lastUrl</span><span class=o>.</span><span class=na>toURI</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=s>&#34;In re-direct loop&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>URISyntaxException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Do nothing, this is best effort.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// connectionFactoryé»˜è®¤æ˜¯DefaultHttpUrlConnectionFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// å…¶buildæ–¹æ³•å°±æ˜¯è°ƒç”¨äº†url.openConnection()
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>urlConnection</span> <span class=o>=</span> <span class=n>connectionFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>url</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headerEntry</span> <span class=o>:</span> <span class=n>headers</span><span class=o>.</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>urlConnection</span><span class=o>.</span><span class=na>addRequestProperty</span><span class=o>(</span><span class=n>headerEntry</span><span class=o>.</span><span class=na>getKey</span><span class=o>(),</span> <span class=n>headerEntry</span><span class=o>.</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setConnectTimeout</span><span class=o>(</span><span class=n>timeout</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setReadTimeout</span><span class=o>(</span><span class=n>timeout</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setUseCaches</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setDoInput</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Stop the urlConnection instance of HttpUrlConnection from following redirects so that
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// redirects will be handled by recursive calls to this method, loadDataWithRedirects.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ç¦æ­¢HttpUrlConnectionè‡ªåŠ¨é‡å®šå‘ï¼Œé‡å®šå‘åŠŸèƒ½ç”±æœ¬æ–¹æ³•è‡ªå·±å®ç°
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setInstanceFollowRedirects</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Connect explicitly to avoid errors in decoders if connection fails.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>connect</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Set the stream so that it&#39;s closed in cleanup to avoid resource leaks. See #2352.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>stream</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isCancelled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=kt>int</span> <span class=n>statusCode</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=na>getResponseCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isHttpOk</span><span class=o>(</span><span class=n>statusCode</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// statusCode=2xxï¼Œè¯·æ±‚æˆåŠŸ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>getStreamForSuccessfulRequest</span><span class=o>(</span><span class=n>urlConnection</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>isHttpRedirect</span><span class=o>(</span><span class=n>statusCode</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// statusCode=3xxï¼Œéœ€è¦é‡å®šå‘
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>String</span> <span class=n>redirectUrlString</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=na>getHeaderField</span><span class=o>(</span><span class=s>&#34;Location&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>TextUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>redirectUrlString</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=s>&#34;Received empty or null redirect url&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>URL</span> <span class=n>redirectUrl</span> <span class=o>=</span> <span class=k>new</span> <span class=n>URL</span><span class=o>(</span><span class=n>url</span><span class=o>,</span> <span class=n>redirectUrlString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Closing the stream specifically is required to avoid leaking ResponseBodys in addition
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// to disconnecting the url connection below. See #2352.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>loadDataWithRedirects</span><span class=o>(</span><span class=n>redirectUrl</span><span class=o>,</span> <span class=n>redirects</span> <span class=o>+</span> <span class=n>1</span><span class=o>,</span> <span class=n>url</span><span class=o>,</span> <span class=n>headers</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>statusCode</span> <span class=o>==</span> <span class=n>INVALID_STATUS_CODE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -1 è¡¨ç¤ºä¸æ˜¯HTTPå“åº”
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=n>statusCode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å…¶ä»–HTTPé”™è¯¯
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=n>urlConnection</span><span class=o>.</span><span class=na>getResponseMessage</span><span class=o>(),</span> <span class=n>statusCode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åˆ°è¿™ä¸€æ­¥å·²ç»è·å¾—ç½‘ç»œå›¾ç‰‡çš„ InputStream äº†ï¼Œè¯¥èµ„æºä¼šé€šè¿‡å›è°ƒç»è¿‡ MultiFetcher ç„¶åå†æ¬¡å›è°ƒåˆ° SourceGenerator ä¸­ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=o>(</span><span class=n>Object</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getDiskCacheStrategy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>diskCacheStrategy</span><span class=o>.</span><span class=na>isDataCacheable</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataSource</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=n>data</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// reschedule to get back onto Glide&#39;s thread.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cb</span><span class=o>.</span><span class=na>reschedule</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cb</span><span class=o>.</span><span class=na>onDataFetcherReady</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>sourceKey</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataSource</span><span class=o>(),</span> <span class=n>originalKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>cb</span><span class=o>.</span><span class=na>onDataFetcherFailed</span><span class=o>(</span><span class=n>originalKey</span><span class=o>,</span> <span class=n>e</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataSource</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>onLoadFailed() æ–¹æ³•å¾ˆç®€å•ï¼Œç›´æ¥å›è°ƒ DecodeJob.onDataFetcherFailed æ–¹æ³•ã€‚onDataReady() æ–¹æ³•ä¼šé¦–å…ˆåˆ¤ data èƒ½ä¸èƒ½ç¼“å­˜ï¼Œè‹¥èƒ½ç¼“å­˜åˆ™ç¼“å­˜èµ·æ¥ï¼Œç„¶åè°ƒç”¨ DataCacheGenerator è¿›è¡ŒåŠ è½½ç¼“å­˜ï¼›è‹¥ä¸èƒ½ç¼“å­˜ï¼Œåˆ™ç›´æ¥å›è°ƒ DecodeJob.onDataFetcherReady() æ–¹æ³•é€šçŸ¥å¤–ç•Œ data å·²ç»å‡†å¤‡å¥½äº†ã€‚</p><p>è·å– DiskCacheStrategy å¹¶åˆ¤æ–­èƒ½ä¸èƒ½è¢«ç¼“å­˜çš„é€»è¾‘åœ¨ SourceGenerator.startNext() ä¸­å‡ºç°è¿‡ï¼Œä¹‹ç±»æ˜¾ç„¶æ˜¯å¯ä»¥çš„ã€‚ç„¶åå°† data ä¿å­˜åˆ° dataToCacheï¼Œå¹¶è°ƒç”¨ cb.reschedule()ã€‚</p><p>cb.reschedule() çš„ä½œç”¨å°±æ˜¯å°† DecodeJob æäº¤åˆ° Glide çš„ source çº¿ç¨‹æ± ä¸­ã€‚ç„¶åæ‰§è¡Œ DecodeJob.run() æ–¹æ³•ï¼Œç»è¿‡ runWrapped()ã€Â runGenerators() æ–¹æ³•åï¼Œåˆå›åˆ°äº† SourceGenerator.startNext() æ–¹æ³•ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//é¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®å¾…ç¼“å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cacheData</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>//åˆšåˆšæ„å»ºäº†ä¸€ä¸ª DataCacheGeneratorï¼Œè¿™é‡Œä¸ä¸ºç©º
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//è°ƒç”¨ startNext() åè¿”å› true
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=o>.</span><span class=na>startNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>cacheData</span><span class=o>(</span><span class=n>Object</span> <span class=n>dataToCache</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Encoder</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>encoder</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getSourceEncoder</span><span class=o>(</span><span class=n>dataToCache</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>DataCacheWriter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>writer</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;(</span><span class=n>encoder</span><span class=o>,</span> <span class=n>dataToCache</span><span class=o>,</span> <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>sourceKey</span><span class=o>,</span> <span class=n>helper</span><span class=o>.</span><span class=na>getSignature</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>//ç¼“å­˜ data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>helper</span><span class=o>.</span><span class=na>getDiskCache</span><span class=o>().</span><span class=na>put</span><span class=o>(</span><span class=n>originalKey</span><span class=o>,</span> <span class=n>writer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Finished encoding source to cache&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;, key: &#34;</span> <span class=o>+</span> <span class=n>originalKey</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;, data: &#34;</span> <span class=o>+</span> <span class=n>dataToCache</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;, encoder: &#34;</span> <span class=o>+</span> <span class=n>encoder</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;, duration: &#34;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getElapsedMillis</span><span class=o>(</span><span class=n>startTime</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//æ„å»ºä¸€ä¸ª DataCacheGeneratorï¼Œä¼ å…¥ this ä½œä¸ºå›è°ƒ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>sourceCacheGenerator</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=o>(</span><span class=n>Collections</span><span class=o>.</span><span class=na>singletonList</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>sourceKey</span><span class=o>),</span> <span class=n>helper</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ startNext() æ–¹æ³•çš„å¼€å¤´ï¼Œä¼šåˆ¤æ–­ dataToCache æ˜¯å¦ä¸ºç©ºï¼Œæ­¤æ—¶æ˜¾ç„¶ä¸ä¸ºç©ºï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ cacheData(Object) æ–¹æ³•è¿›è¡Œ data çš„ç¼“å­˜å¤„ç†ã€‚ç¼“å­˜å®Œæ¯•åï¼Œä¼šä¸ºè¯¥ç¼“å­˜æ–‡ä»¶ç”Ÿæˆä¸€ä¸ª SourceCacheGeneratorã€‚ç„¶ååœ¨ startNext() æ–¹æ³•ä¸­ä¼šç›´æ¥è°ƒç”¨è¯¥å˜é‡è¿›è¡ŒåŠ è½½ã€‚</p><p>ç”±äºåœ¨æ„é€  DataCacheGenerator æ—¶ï¼ŒæŒ‡å®šäº† FetcherReadyCallback ä¸º thisï¼Œæ‰€ä»¥è¿™æ—¶ DataCacheGenerator åŠ è½½ç»“æœä¼šç”± SourceGenerator è½¬å‘ç»™ DecodeJobã€‚</p><a href=#decodejobfetcherreadycallback><h4 id=decodejobfetcherreadycallback><span class=hanchor arialabel=Anchor># </span>DecodeJob.FetcherReadyCallback</h4></a><p>å…ˆçœ‹ä¸€ä¸‹ fetch å¤±è´¥æ—¶å¹²äº†ä»€ä¹ˆï¼ŒDecodeJob.onDataFetcherFailed() æ–¹æ³•çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherFailed</span><span class=o>(</span><span class=n>Key</span> <span class=n>attemptedKey</span><span class=o>,</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>fetcher</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=s>&#34;Fetching data failed&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>exception</span><span class=o>.</span><span class=na>setLoggingDetails</span><span class=o>(</span><span class=n>attemptedKey</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>throwables</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>exception</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=o>.</span><span class=na>SWITCH_TO_SOURCE_SERVICE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>reschedule</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ˜¾ç„¶ï¼Œå¦‚æœ fetch å¤±è´¥äº†ï¼Œå¦‚æœä¸åœ¨ source çº¿ç¨‹ä¸­å°±ä¼šå›è°ƒ EnginJob çš„ reschedule() æ–¹æ³•åˆ‡æ¢åˆ° source çº¿ç¨‹ï¼Œç„¶åé‡æ–°è°ƒç”¨ runGenerators() æ–¹æ³•å°è¯•ä½¿ç”¨ä¸‹ä¸€ä¸ª DataFetcherGenerator è¿›è¡ŒåŠ è½½ï¼Œä¸€ç›´åˆ°æ²¡æœ‰ä¸€ä¸ªå¯ä»¥åŠ è½½ï¼Œè¿™æ—¶ä¼šè°ƒç”¨ notifyFailed() æ–¹æ³•ï¼Œæ­£å¼å®£å‘ŠåŠ è½½å¤±è´¥ã€‚</p><p>ç„¶åå†çœ‹æˆåŠŸçš„æ—¶å€™å›è°ƒçš„ onDataFetcherReady() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherReady</span><span class=o>(</span><span class=n>Key</span> <span class=n>sourceKey</span><span class=o>,</span> <span class=n>Object</span> <span class=n>data</span><span class=o>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>Key</span> <span class=n>attemptedKey</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentSourceKey</span> <span class=o>=</span> <span class=n>sourceKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentData</span> <span class=o>=</span> <span class=n>data</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentFetcher</span> <span class=o>=</span> <span class=n>fetcher</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentDataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentAttemptingKey</span> <span class=o>=</span> <span class=n>attemptedKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸º currentThread
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=o>.</span><span class=na>DECODE_DATA</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å¦‚æœä¸æ˜¯ï¼Œåˆ™è®© EngineJob é‡æ–°è°ƒåº¦ï¼Œæœ€åä¹Ÿä¼šè°ƒç”¨ decodeFromRetrievedData
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>callback</span><span class=o>.</span><span class=na>reschedule</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>GlideTrace</span><span class=o>.</span><span class=na>beginSection</span><span class=o>(</span><span class=s>&#34;DecodeJob.decodeFromRetrievedData&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>decodeFromRetrievedData</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>GlideTrace</span><span class=o>.</span><span class=na>endSection</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆä¼šä¿å­˜ä¼ å…¥çš„å‚æ•°ï¼Œç„¶åç¡®è®¤æ‰§è¡Œçº¿ç¨‹åè°ƒç”¨ decodeFromRetrievedData() æ–¹æ³•è¿›è¡Œè§£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>decodeFromRetrievedData</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Retrieved data&#34;</span><span class=o>,</span> <span class=n>startFetchTime</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;data: &#34;</span> <span class=o>+</span> <span class=n>currentData</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=s>&#34;, cache key: &#34;</span> <span class=o>+</span> <span class=n>currentSourceKey</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=s>&#34;, fetcher: &#34;</span> <span class=o>+</span> <span class=n>currentFetcher</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resource</span> <span class=o>=</span> <span class=n>decodeFromData</span><span class=o>(</span><span class=n>currentFetcher</span><span class=o>,</span> <span class=n>currentData</span><span class=o>,</span> <span class=n>currentDataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>setLoggingDetails</span><span class=o>(</span><span class=n>currentAttemptingKey</span><span class=o>,</span> <span class=n>currentDataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>throwables</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>notifyEncodeAndRelease</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=n>currentDataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…ˆè°ƒç”¨ decodeFromData() æ–¹æ³•è¿›è¡Œè§£ç ï¼Œç„¶åè°ƒç”¨ notifyEncodeAndRelease() æ–¹æ³•è¿›è¡Œç¼“å­˜ï¼ŒåŒæ—¶ä¹Ÿä¼šé€šçŸ¥ EngineJob èµ„æºå·²ç»å‡†å¤‡å¥½äº†ã€‚</p><p>decodeFromData() æ–¹æ³•è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>decodeFromData</span><span class=o>(</span><span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=o>,</span> <span class=n>Data</span> <span class=n>data</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>data</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>decodeFromFetcher</span><span class=o>(</span><span class=n>data</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Decoded result &#34;</span> <span class=o>+</span> <span class=n>result</span><span class=o>,</span> <span class=n>startTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fetcher</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>decodeFromFetcher</span><span class=o>(</span><span class=n>Data</span> <span class=n>data</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>,</span> <span class=o>?,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getLoadPath</span><span class=o>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;)</span> <span class=n>data</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>runLoadPath</span><span class=o>(</span><span class=n>data</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>path</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>,</span> <span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>runLoadPath</span><span class=o>(</span><span class=n>Data</span> <span class=n>data</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>,</span> <span class=n>ResourceType</span><span class=o>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=n>getOptionsWithHardwareConfig</span><span class=o>(</span><span class=n>dataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span> <span class=o>=</span> <span class=n>glideContext</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>().</span><span class=na>getRewinder</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ResourceType in DecodeCallback below is required for compilation to work with gradle.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>path</span><span class=o>.</span><span class=na>load</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>rewinder</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=k>new</span> <span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;(</span><span class=n>dataSource</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>rewinder</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>path.load(..., new DecodeCallback&lt;ResourceType>(dataSource))</code> è¿™è¡Œä»£ç ä¸­ï¼Œæœ€åä¼ å…¥äº†ä¸€ä¸ª DecodeCallback å›è°ƒï¼Œè¯¥ç±»çš„å›è°ƒæ–¹æ³•ä¼šå›è°ƒç»™ DecodeJob å¯¹åº”çš„æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DecodePath</span><span class=o>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl>  <span class=n>DecodeCallback</span><span class=o>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>dataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>DecodeJob</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>onResourceDecoded</span><span class=o>(</span><span class=n>dataSource</span><span class=o>,</span> <span class=n>decoded</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åæ¥çœ‹ä¸€ä¸‹ LoadPath.load() æ–¹æ³•çš„å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=n>DecodePath</span><span class=o>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decodeCallback</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>throwables</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>listPool</span><span class=o>.</span><span class=na>acquire</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>loadWithExceptionList</span><span class=o>(</span><span class=n>rewinder</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>decodeCallback</span><span class=o>,</span> <span class=n>throwables</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listPool</span><span class=o>.</span><span class=na>release</span><span class=o>(</span><span class=n>throwables</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>loadWithExceptionList</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=n>DecodePath</span><span class=o>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decodeCallback</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>decodePaths</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>,</span> <span class=n>ResourceType</span><span class=o>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span> <span class=n>decodePaths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>path</span><span class=o>.</span><span class=na>decode</span><span class=o>(</span><span class=n>rewinder</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>decodeCallback</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exceptions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=n>failureMessage</span><span class=o>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>exceptions</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯¹äºæ¯æ¡ DecodePathï¼Œéƒ½è°ƒç”¨å…¶ decode() æ–¹æ³•ï¼Œç›´åˆ°æœ‰ä¸€ä¸ª DecodePath å¯ä»¥ decode å‡ºèµ„æºã€‚ç»§ç»­çœ‹çœ‹ DecodePath.decode() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>decode</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>,</span> <span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decoded</span> <span class=o>=</span> <span class=n>decodeResource</span><span class=o>(</span><span class=n>rewinder</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>callback</span><span class=o>.</span><span class=na>onResourceDecoded</span><span class=o>(</span><span class=n>decoded</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>transcoder</span><span class=o>.</span><span class=na>transcode</span><span class=o>(</span><span class=n>transformed</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>ä½¿ç”¨ ResourceDecoder List è¿›è¡Œ decodeï¼Œå°†åŸå§‹æ•°æ®è§£ç æˆåŸå§‹å›¾ç‰‡</li><li>å°† decoded çš„èµ„æºè¿›è¡Œ transform</li><li>å°† transformed çš„èµ„æºè¿›è¡Œ transcode</li></ol><p>é¦–å…ˆæ˜¯ decodeResource() çš„è¿‡ç¨‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>decodeResource</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>listPool</span><span class=o>.</span><span class=na>acquire</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decodeResourceWithList</span><span class=o>(</span><span class=n>rewinder</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>exceptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listPool</span><span class=o>.</span><span class=na>release</span><span class=o>(</span><span class=n>exceptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>decodeResourceWithList</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>decoders</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//decoders åªæœ‰ä¸€æ¡ï¼Œå°±æ˜¯ ByteBufferBitmapDecoder
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>,</span> <span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decoder</span> <span class=o>=</span> <span class=n>decoders</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//rewinder è‡ªç„¶æ˜¯ ByteBufferRewind
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>//data ä¸º ByteBuffer
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>DataType</span> <span class=n>data</span> <span class=o>=</span> <span class=n>rewinder</span><span class=o>.</span><span class=na>rewindAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>//ByteBufferBitmapDecoder å†…éƒ¨ä¼šè°ƒç”¨ Downsampler çš„ hanldes æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// å®ƒå¯¹ä»»æ„çš„ InputStream å’Œ ByteBuffer éƒ½è¿”å› true
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=o>(</span><span class=n>decoder</span><span class=o>.</span><span class=na>handles</span><span class=o>(</span><span class=n>data</span><span class=o>,</span> <span class=n>options</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//è°ƒç”¨ ByteBuffer.position(0) å¤ä½
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>data</span> <span class=o>=</span> <span class=n>rewinder</span><span class=o>.</span><span class=na>rewindAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//å¼€å§‹è§£ç 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>result</span> <span class=o>=</span> <span class=n>decoder</span><span class=o>.</span><span class=na>decode</span><span class=o>(</span><span class=n>data</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Some decoders throw unexpectedly. If they do, we shouldn&#39;t fail the entire load path, but
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// instead log and continue. See #2406 for an example.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=o>|</span> <span class=n>RuntimeException</span> <span class=o>|</span> <span class=n>OutOfMemoryError</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Failed to decode data for &#34;</span> <span class=o>+</span> <span class=n>decoder</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>exceptions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=n>failureMessage</span><span class=o>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>exceptions</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>ByteBufferBitmapDecoder</span><span class=o>.</span><span class=na>decode</span><span class=o>()</span> <span class=n>æ–¹æ³•</span><span class=err>ï¼š</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>decode</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ByteBuffer</span> <span class=n>source</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>InputStream</span> <span class=n>is</span> <span class=o>=</span> <span class=n>ByteBufferUtil</span><span class=o>.</span><span class=na>toStream</span><span class=o>(</span><span class=n>source</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>downsampler</span><span class=o>.</span><span class=na>decode</span><span class=o>(</span><span class=n>is</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…ˆå°† ByteBuffer è½¬æ¢æˆ InputStreamï¼Œç„¶åè°ƒç”¨ Downsampler.decode() æ–¹æ³•è¿›è¡Œè§£ç ã€‚</p><p>è¿™é‡Œæ‰§è¡Œå®Œæ¯•ï¼Œä¼šå°† decode å‡ºæ¥çš„ Bitmap åŒ…è£…æˆä¸ºä¸€ä¸ª BitmapResource å¯¹è±¡ã€‚ç„¶åå°±ä¸€ç›´å¾€ä¸Šè¿”å›ï¼Œè¿”å›åˆ° DecodePath.decode æ–¹æ³•ä¸­ã€‚æ¥ä¸‹æ¥æ‰§è¡Œç¬¬äºŒè¡Œï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>callback</span><span class=o>.</span><span class=na>onResourceDecoded</span><span class=o>(</span><span class=n>decoded</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„ callback åœ¨å‰é¢æåˆ°è¿‡ï¼Œè¿™ä¼šè°ƒç”¨ <code>DecodeJob.onResourceDecoded(DataSource, Resource&lt;Z>)</code> æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=o>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceSubClass</span> <span class=o>=</span> <span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;)</span> <span class=n>decoded</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>getClass</span><span class=o>();</span><span class=c1>// Bitmap.class
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>decoded</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//dataSourceä¸ºDATA_DISK_CACHEï¼Œæ‰€ä»¥æ»¡è¶³æ¡ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>dataSource</span> <span class=o>!=</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Bitmap.classå¯¹åº”çš„æ­£æ˜¯FitCenter()
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getTransformation</span><span class=o>(</span><span class=n>resourceSubClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å¯¹decodedèµ„æºè¿›è¡Œtransform
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>transformed</span> <span class=o>=</span> <span class=n>appliedTransformation</span><span class=o>.</span><span class=na>transform</span><span class=o>(</span><span class=n>glideContext</span><span class=o>,</span> <span class=n>decoded</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//TODO: Make this the responsibility of the Transformation.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!</span><span class=n>decoded</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>transformed</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>decoded</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>EncodeStrategy</span> <span class=n>encodeStrategy</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//Bitmapæœ‰æ³¨å†Œå¯¹åº”çš„BitmapEncoderï¼Œæ‰€ä»¥æ˜¯availableçš„
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>decodeHelper</span><span class=o>.</span><span class=na>isResourceEncoderAvailable</span><span class=o>(</span><span class=n>transformed</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//encoderå°±æ˜¯BitmapEncoder
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>encoder</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getResultEncoder</span><span class=o>(</span><span class=n>transformed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//encodeStrategyä¸ºEncodeStrategy.TRANSFORMED
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>encoder</span><span class=o>.</span><span class=na>getEncodeStrategy</span><span class=o>(</span><span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>EncodeStrategy</span><span class=o>.</span><span class=na>NONE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>transformed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//isSourceKeyæ˜¾ç„¶ä¸ºtrueï¼Œæ‰€ä»¥isFromAlternateCacheKeyä¸ºfalseï¼Œæ‰€ä»¥å°±è¿”å›äº†
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>boolean</span> <span class=n>isFromAlternateCacheKey</span> <span class=o>=</span> <span class=o>!</span><span class=n>decodeHelper</span><span class=o>.</span><span class=na>isSourceKey</span><span class=o>(</span><span class=n>currentSourceKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//diskCacheStrategyä¸ºAUTOMATICï¼Œè¯¥æ–¹æ³•è¿”å›false
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheStrategy</span><span class=o>.</span><span class=na>isResourceCacheable</span><span class=o>(</span><span class=n>isFromAlternateCacheKey</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>encodeStrategy</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>encoder</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>Registry</span><span class=o>.</span><span class=na>NoResultEncoderAvailableException</span><span class=o>(</span><span class=n>transformed</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>encodeStrategy</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>SOURCE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=o>(</span><span class=n>currentSourceKey</span><span class=o>,</span> <span class=n>signature</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>TRANSFORMED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getArrayPool</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>currentSourceKey</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>signature</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>height</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>appliedTransformation</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resourceSubClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Unknown strategy: &#34;</span> <span class=o>+</span> <span class=n>encodeStrategy</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>lockedResult</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>transformed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>deferredEncodeManager</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>encoder</span><span class=o>,</span> <span class=n>lockedResult</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResult</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“ dataSource != DataSource.RESOURCE_DISK_CACHE æ—¶ä¼šè¿›è¡Œ transformï¼Œè¿™æ˜¯å› ä¸º resource cache è‚¯å®šå·²ç»ç»å†è¿‡ transform äº†ï¼Œæ‰€ä»¥å°±ä¸ç”¨é‡æ–°æ¥ä¸€éäº†ã€‚</p><p>ç„¶åå°±å›åˆ° DecodePath.decode æ–¹æ³•çš„ç¬¬ä¸‰è¡Œäº†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>return</span> <span class=n>transcoder</span><span class=o>.</span><span class=na>transcode</span><span class=o>(</span><span class=n>transformed</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„ transcoder å°±æ˜¯ BitmapDrawableTranscoderï¼Œè¯¥æ–¹æ³•è¿”å›äº†ä¸€ä¸ª LazyBitmapDrawableResourceã€‚</p><p>è‡³æ­¤ï¼Œresource å·²ç» decode å®Œæ¯•ã€‚ä¸‹é¢ä¸€ç›´è¿”å›åˆ° DecodeJob.decodeFromRetrievedData() æ–¹æ³•ä¸­ã€‚ä¸‹é¢ä¼šè°ƒç”¨ notifyEncodeAndRelease() æ–¹æ³•å®Œæˆåé¢çš„äº‹å®œã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>notifyEncodeAndRelease</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// resourceæ˜¯BitmapResourceç±»å‹ï¼Œå®ç°äº†Initializableæ¥å£
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Initializable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// initializeæ–¹æ³•è°ƒç”¨äº†bitmap.prepareToDraw()
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>((</span><span class=n>Initializable</span><span class=o>)</span> <span class=n>resource</span><span class=o>).</span><span class=na>initialize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>lockedResource</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>deferredEncodeManager</span><span class=o>.</span><span class=na>hasResourceToEncode</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>lockedResource</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// é€šçŸ¥å›è°ƒï¼Œèµ„æºå·²ç»å°±ç»ª
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>notifyComplete</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>stage</span> <span class=o>=</span> <span class=n>Stage</span><span class=o>.</span><span class=na>ENCODE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>deferredEncodeManager</span><span class=o>.</span><span class=na>hasResourceToEncode</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>deferredEncodeManager</span><span class=o>.</span><span class=na>encode</span><span class=o>(</span><span class=n>diskCacheProvider</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// lockedResourceä¸ºnull, skip
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>lockedResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>lockedResource</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Call onEncodeComplete outside the finally block so that it&#39;s not called if the encode process
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// throws.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// è¿›è¡Œæ¸…ç†å·¥ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>onEncodeComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é‡ç‚¹åœ¨äº notifyComplete() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ callback.onResourceReady(resource, dataSource) å°†ç»“æœä¼ é€’ç»™å›è°ƒï¼Œè¿™é‡Œçš„å›è°ƒæ˜¯ EngineJobï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>dataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>notifyCallbacksOfResult</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>notifyCallbacksOfResult</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ResourceCallbacksAndExecutors</span> <span class=n>copy</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Key</span> <span class=n>localKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>localResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>stateVerifier</span><span class=o>.</span><span class=na>throwIfRecycled</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isCancelled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// TODO: Seems like we might as well put this in the memory cache instead of just recycling
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// it since we&#39;ve gotten this far...
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>resource</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>cbs</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Received a resource without any callbacks to notify&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>hasResource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Already have resource&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// engineResourceFactoryé»˜è®¤ä¸ºEngineResourceFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// å…¶buildæ–¹æ³•å°±æ˜¯newä¸€ä¸ªå¯¹åº”çš„èµ„æº
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// new EngineResource&lt;&gt;(resource, isMemoryCacheable, /*isRecyclable=*/ true)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>engineResource</span> <span class=o>=</span> <span class=n>engineResourceFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=n>isCacheable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// a lock here so that any newly added callback that executes before the next locked section
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// below can&#39;t recycle the resource before we call the callbacks.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>hasResource</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>copy</span> <span class=o>=</span> <span class=n>cbs</span><span class=o>.</span><span class=na>copy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>incrementPendingCallbacks</span><span class=o>(</span><span class=n>copy</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>localKey</span> <span class=o>=</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>localResource</span> <span class=o>=</span> <span class=n>engineResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// listenerå°±æ˜¯Engineï¼Œè¯¥æ–¹æ³•ä¼šå°†èµ„æºä¿å­˜åˆ°activeResourcesä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>listener</span><span class=o>.</span><span class=na>onEngineJobComplete</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>localKey</span><span class=o>,</span> <span class=n>localResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// è¿™é‡Œçš„ResourceCallbackAndExecutorå°±æ˜¯æˆ‘åˆ›å»ºEngineJobå’ŒDecodeJob
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// å¹¶åœ¨æ‰§è¡ŒDecodeJobä¹‹å‰æ·»åŠ çš„å›è°ƒ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// entry.executorå°±æ˜¯Glide.with.load.intoä¸­å‡ºç°çš„Executors.mainThreadExecutor()
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// entry.cbå°±æ˜¯SingleRequest
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=kd>final</span> <span class=n>ResourceCallbackAndExecutor</span> <span class=n>entry</span> <span class=o>:</span> <span class=n>copy</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>entry</span><span class=o>.</span><span class=na>executor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>CallResourceReady</span><span class=o>(</span><span class=n>entry</span><span class=o>.</span><span class=na>cb</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>decrementPendingCallbacks</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>listener.onEngineJobComplete() çš„ä»£ç å¾ˆç®€å•ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onEngineJobComplete</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>engineJob</span><span class=o>,</span> <span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// A null resource indicates that the load failed, usually due to an exception.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resource</span><span class=o>.</span><span class=na>setResourceListener</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>isCacheable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>activeResources</span><span class=o>.</span><span class=na>activate</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>jobs</span><span class=o>.</span><span class=na>removeIfCurrent</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>engineJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=o>(</span><span class=n>Key</span> <span class=n>cacheKey</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>activeResources</span><span class=o>.</span><span class=na>deactivate</span><span class=o>(</span><span class=n>cacheKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>isCacheable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cache</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>cacheKey</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resourceRecycler</span><span class=o>.</span><span class=na>recycle</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆä¼šè®¾ç½®èµ„æºçš„å›è°ƒä¸ºè‡ªå·±ï¼Œè¿™æ ·åœ¨èµ„æºé‡Šæ”¾æ—¶ä¼šé€šçŸ¥è‡ªå·±çš„å›è°ƒæ–¹æ³•ï¼Œå°†èµ„æºä» active çŠ¶æ€å˜ä¸º cache çŠ¶æ€ï¼Œå¦‚ onResourceReleased() æ–¹æ³•ï¼›ç„¶åå°†èµ„æºæ”¾å…¥ activeResources ä¸­ï¼Œèµ„æºå˜ä¸º active çŠ¶æ€ï¼›æœ€åå°† engineJob ä» Jobs ä¸­ç§»é™¤ã€‚</p><p>ç„¶åçœ‹ä¸‹ entry.executor.execute(new CallResourceReady(entry.cb)) æ–¹æ³•çš„å®ç°ï¼Œå…³æ³¨ç‚¹åœ¨ CallResourceReady ä¸Šé¢ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>class</span> <span class=nc>CallResourceReady</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceCallback</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>CallResourceReady</span><span class=o>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>synchronized</span> <span class=o>(</span><span class=n>EngineJob</span><span class=o>.</span><span class=na>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>cbs</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>cb</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Acquire for this particular callback.
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>engineResource</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=n>callCallbackOnResourceReady</span><span class=o>(</span><span class=n>cb</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=n>removeCallback</span><span class=o>(</span><span class=n>cb</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>decrementPendingCallbacks</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆè°ƒç”¨ callCallbackOnResourceReady(cb) è°ƒç”¨ callbackï¼Œç„¶åè°ƒç”¨ removeCallback(cb) ç§»é™¤ callbackã€‚çœ‹çœ‹ callCallbackOnResourceReady(cb)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>callCallbackOnResourceReady</span><span class=o>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// This is overly broad, some Glide code is actually called here, but it&#39;s much
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// simpler to encapsulate here than to do so at the actual call point in the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Request implementation.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cb</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>engineResource</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isLoadedFromAlternateCacheKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>CallbackException</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå°±è°ƒç”¨äº† cb.onResourceReady()ï¼Œè¿™é‡Œè¯´åˆ°è¿‡ entry.cb å°±æ˜¯ SingleRequestã€‚æ‰€ä»¥ç»§ç»­çœ‹çœ‹ SingleRequest.onResourceReady() æ–¹æ³•:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>onResourceReady</span><span class=o>((</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;)</span> <span class=n>resource</span><span class=o>,</span> <span class=o>(</span><span class=n>R</span><span class=o>)</span> <span class=n>received</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>R</span> <span class=n>result</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We must call isFirstReadyResource before setting status.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ç”±äºrequestCoordinatorä¸ºnullï¼Œæ‰€ä»¥è¿”å›true
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>boolean</span> <span class=n>isFirstResource</span> <span class=o>=</span> <span class=n>isFirstReadyResource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å°†statusçŠ¶æ€è®¾ç½®ä¸ºCOMPLETE
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=o>.</span><span class=na>COMPLETE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>glideContext</span><span class=o>.</span><span class=na>getLogLevel</span><span class=o>()</span> <span class=o>&lt;=</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>GLIDE_TAG</span><span class=o>,</span> <span class=s>&#34;Finished loading &#34;</span> <span class=o>+</span> <span class=n>result</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getSimpleName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; from &#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=n>dataSource</span> <span class=o>+</span> <span class=s>&#34; for &#34;</span> <span class=o>+</span> <span class=n>model</span> <span class=o>+</span> <span class=s>&#34; with size [&#34;</span> <span class=o>+</span> <span class=n>width</span> <span class=o>+</span> <span class=s>&#34;x&#34;</span> <span class=o>+</span> <span class=n>height</span> <span class=o>+</span> <span class=s>&#34;] in &#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getElapsedMillis</span><span class=o>(</span><span class=n>startTime</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34; ms&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>// å°è¯•è°ƒç”¨å„ä¸ªlistenerçš„onResourceReadyå›è°ƒè¿›è¡Œå¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=o>:</span> <span class=n>requestListeners</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>            <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœæ²¡æœ‰ä¸€ä¸ªå›è°ƒèƒ½å¤Ÿå¤„ç†ï¼Œé‚£ä¹ˆè‡ªå·±å¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// animationFactoryé»˜è®¤ä¸ºNoTransition.getFactory()ï¼Œç”Ÿæˆçš„animationä¸ºNO_ANIMATION
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>animation</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>animationFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// targetä¸ºDrawableImageViewTarget
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>target</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>animation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// é€šçŸ¥requestCoordinator
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>notifyLoadSuccess</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶å¤„ç†è¿‡ç¨‹å’Œ onLoadFailed() æ–¹æ³•éå¸¸ç±»ä¼¼ã€‚</p><p>DrawableImageViewTarget çš„åŸºç±» ImageViewTarget å®ç°äº†æ­¤æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ImageViewTarget.java
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Z</span> <span class=n>resource</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=n>transition</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// NO_ANIMATION.transitionè¿”å›falseï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨setResourceInternalæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>transition</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>transition</span><span class=o>.</span><span class=na>transition</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=k>this</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>setResourceInternal</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>maybeUpdateAnimatable</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>setResourceInternal</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Order matters here. Set the resource first to make sure that the Drawable has a valid and
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// non-null Callback before starting it.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// å…ˆè®¾ç½®å›¾ç‰‡
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>setResource</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ç„¶åå¦‚æœæ˜¯åŠ¨ç”»ï¼Œä¼šæ‰§è¡ŒåŠ¨ç”»
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>maybeUpdateAnimatable</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>maybeUpdateAnimatable</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// BitmapDrawableæ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªAnimatableå¯¹è±¡ï¼Œæ‰€ä»¥èµ°elseåˆ†æ”¯
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Animatable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>animatable</span> <span class=o>=</span> <span class=o>(</span><span class=n>Animatable</span><span class=o>)</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>animatable</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>animatable</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DrawableImageViewTarget
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>setResource</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>view</span><span class=o>.</span><span class=na>setImageDrawable</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>OKï¼Œè‡³æ­¤ç½‘ç»œå›¾ç‰‡å·²ç»é€šè¿‡ view.setImageDrawable(resource) åŠ è½½å®Œæ¯•ã€‚</p><p>æœ€åï¼Œå›åˆ° DecodeJob.notifyEncodeAndRelease() æ–¹æ³•ï¼ŒnotifyComplete() è¢«è°ƒç”¨åï¼Œä¼šåˆ¤æ–­ deferredEncodeManager.hasResourceToEncode()ï¼Œå¦‚æœä¸º true åˆ™ä¼šè°ƒç”¨ deferredEncodeManager.encode() æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>DeferredEncodeManager</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Key</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>toEncode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl>  <span class=n>DeferredEncodeManager</span><span class=o>()</span> <span class=o>{</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// We just need the encoder and resource type to match, which this will enforce.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>init</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=o>,</span> <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>toEncode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>encoder</span> <span class=o>=</span> <span class=o>(</span><span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;)</span> <span class=n>encoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>toEncode</span> <span class=o>=</span> <span class=o>(</span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;)</span> <span class=n>toEncode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>encode</span><span class=o>(</span><span class=n>DiskCacheProvider</span> <span class=n>diskCacheProvider</span><span class=o>,</span> <span class=n>Options</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>GlideTrace</span><span class=o>.</span><span class=na>beginSection</span><span class=o>(</span><span class=s>&#34;DecodeJob.encode&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>diskCacheProvider</span><span class=o>.</span><span class=na>getDiskCache</span><span class=o>().</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;(</span><span class=n>encoder</span><span class=o>,</span> <span class=n>toEncode</span><span class=o>,</span> <span class=n>options</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>toEncode</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>GlideTrace</span><span class=o>.</span><span class=na>endSection</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=nf>hasResourceToEncode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>toEncode</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>clear</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>toEncode</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DiskLruCacheWrapper åœ¨å†™å…¥çš„æ—¶å€™ä¼šä½¿ç”¨åˆ°å†™é” DiskCacheWriteLockerï¼Œé”å¯¹è±¡ç”±å¯¹è±¡æ± åˆ›å»ºï¼Œå†™é” WriteLock å®ç°æ˜¯ä¸€ä¸ªé‡å…¥é” ReentrantLockï¼Œè¯¥é”é»˜è®¤æ˜¯ä¸€ä¸ªä¸å…¬å¹³é”ã€‚</p><p>åœ¨ç¼“å­˜å†™å…¥å‰ï¼Œä¼šåˆ¤æ–­ key å¯¹åº”çš„ value å­˜ä¸å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™æ”¾å¼ƒå†™å…¥ã€‚ç¼“å­˜çš„çœŸæ­£å†™å…¥ä¼šç”± DataCacheWriter äº¤ç»™ ByteBufferEncoder å’Œ StreamEncoder ä¸¤ä¸ªå…·ä½“ç±»æ¥å†™å…¥ï¼Œå‰è€…è´Ÿè´£å°† ByteBuffe å†™å…¥åˆ°æ–‡ä»¶ï¼Œåè€…è´Ÿè´£å°† InputStream å†™å…¥åˆ°æ–‡ä»¶ã€‚</p><p>è‡³æ­¤ï¼Œç£ç›˜ç¼“å­˜çš„è¯»å†™éƒ½å·²ç»å®Œæ¯•ï¼Œå‰©ä¸‹çš„å°±æ˜¯å†…å­˜ç¼“å­˜çš„ä¸¤ä¸ªå±‚æ¬¡äº†ã€‚å›åˆ° DecodeJob.notifyEncodeAndRelease æ–¹æ³•ä¸­ï¼Œç»è¿‡ notifyCompleteã€EngineJob.onResourceReadyã€notifyCallbacksOfResult æ–¹æ³•ä¸­ã€‚</p><p>åœ¨è¯¥æ–¹æ³•ä¸­ä¸€æ–¹é¢ä¼šå°†åŸå§‹çš„ resource åŒ…è£…æˆä¸€ä¸ª EngineResourceï¼Œç„¶åé€šè¿‡å›è°ƒä¼ ç»™ Engine.onEngineJobComplete()ï¼Œåœ¨è¿™é‡Œä¼šå°†èµ„æºä¿æŒåœ¨ ActiveResource ä¸­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onEngineJobComplete</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>engineJob</span><span class=o>,</span> <span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// A null resource indicates that the load failed, usually due to an exception.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resource</span><span class=o>.</span><span class=na>setResourceListener</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>isCacheable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>activeResources</span><span class=o>.</span><span class=na>activate</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>jobs</span><span class=o>.</span><span class=na>removeIfCurrent</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>engineJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦ä¸€æ–¹é¢ä¼šä½¿ç”¨ Executors.mainThreadExecutor() è°ƒç”¨ SingleRequest.onResourceReady() å›è°ƒè¿›è¡Œèµ„æºçš„æ˜¾ç¤ºã€‚</p><p>åœ¨è§¦å‘å›è°ƒå‰åå„æœ‰ä¸€ä¸ªåœ°æ–¹ä¼šå¯¹ engineResource è¿›è¡Œ acquire() å’Œ release() æ“ä½œã€‚è¯¥è¿‡ç¨‹å‘ç”Ÿåœ¨ notifyCallbacksOfResult() æ–¹æ³•çš„ incrementPendingCallbacks()ã€decrementPendingCallbacks() è°ƒç”¨ä¸­ã€‚è¿™ä¸€é¡¿æ“ä½œä¸‹æ¥ï¼ŒengineResource çš„å¼•ç”¨è®¡æ•°åº”è¯¥æ˜¯ 1ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>notifyCallbacksOfResult</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ResourceCallbacksAndExecutors</span> <span class=n>copy</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Key</span> <span class=n>localKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>localResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>engineResource</span> <span class=o>=</span> <span class=n>engineResourceFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=n>isCacheable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// a lock here so that any newly added callback that executes before the next locked section
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// below can&#39;t recycle the resource before we call the callbacks.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>hasResource</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>copy</span> <span class=o>=</span> <span class=n>cbs</span><span class=o>.</span><span class=na>copy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>incrementPendingCallbacks</span><span class=o>(</span><span class=n>copy</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>localKey</span> <span class=o>=</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>localResource</span> <span class=o>=</span> <span class=n>engineResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>listener</span><span class=o>.</span><span class=na>onEngineJobComplete</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>localKey</span><span class=o>,</span> <span class=n>localResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kd>final</span> <span class=n>ResourceCallbackAndExecutor</span> <span class=n>entry</span> <span class=o>:</span> <span class=n>copy</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>entry</span><span class=o>.</span><span class=na>executor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>CallResourceReady</span><span class=o>(</span><span class=n>entry</span><span class=o>.</span><span class=na>cb</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>decrementPendingCallbacks</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>incrementPendingCallbacks</span><span class=o>(</span><span class=kt>int</span> <span class=n>count</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>pendingCallbacks</span><span class=o>.</span><span class=na>getAndAdd</span><span class=o>(</span><span class=n>count</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=n>engineResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>engineResource</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>decrementPendingCallbacks</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>decremented</span> <span class=o>=</span> <span class=n>pendingCallbacks</span><span class=o>.</span><span class=na>decrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>decremented</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>engineResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>engineResource</span><span class=o>.</span><span class=na>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>engineResource çš„å¼•ç”¨è®¡æ•°ä¼šåœ¨ RequestManager.onDestory() æ–¹æ³•ä¸­ç»è¿‡ clear()ã€untrackOrDelegate()ã€untrack()ã€RequestTracker.clearRemoveAndRecycle()ã€clearRemoveAndMaybeRecycle() æ–¹æ³•ï¼Œè°ƒç”¨ SingleRequest.clear() æ–¹æ³•ç»è¿‡ releaseResource()ã€Engine.release()ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚è¿™æ ·å¼•ç”¨è®¡æ•°å°±ä¸º 0 äº†ã€‚</p><p>å‰é¢åœ¨çœ‹ EngineResource çš„ä»£ç æ—¶æˆ‘ä»¬çŸ¥é“ï¼Œä¸€æ—¦å¼•ç”¨è®¡æ•°ä¸º 0ï¼Œå°±ä¼šé€šçŸ¥ Engine å°†æ­¤èµ„æºä» active çŠ¶æ€å˜æˆ memory cache çŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬å†æ¬¡åŠ è½½èµ„æºæ—¶å¯ä»¥ä» memory cache ä¸­åŠ è½½ï¼Œé‚£ä¹ˆèµ„æºåˆä¼šä» memory cache çŠ¶æ€å˜æˆ active çŠ¶æ€ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨èµ„æºç¬¬ä¸€æ¬¡æ˜¾ç¤ºåï¼Œæˆ‘ä»¬å…³é—­é¡µé¢ï¼Œèµ„æºä¼šç”± active å˜æˆ memory cacheï¼›ç„¶åæˆ‘ä»¬å†æ¬¡è¿›å…¥é¡µé¢ï¼ŒåŠ è½½æ—¶ä¼šå‘½ä¸­ memory cacheï¼Œä»è€Œåˆå˜æˆ active çŠ¶æ€ã€‚</p><p>æœ¬ç«  Glide ç¼“å­˜æœºåˆ¶çš„æºç å†…å®¹åˆ°æ­¤ä¸ºæ­¢äº†ï¼Œç°åœ¨çœ‹çœ‹æ–‡ç« æœ€å¼€å§‹çš„æµç¨‹å›¾ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸€ç‚¹ç‚¹ç†Ÿæ‚‰çš„å‘³é“ã€‚</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034514.png width=auto alt></p><p>DecodeJob.onDataFetcherReady è¯¥æ–¹æ³•å®Œæˆä¸¤ä¸ªäº‹æƒ…ï¼š</p><ol><li>å°†æ¯”è¾ƒåŸå§‹çš„ data æ•°æ®è½¬å˜ä¸ºå¯ä»¥ä¾› ImageView æ˜¾ç¤ºçš„ resource æ•°æ®</li><li>å°† resource æ•°æ®æ˜¾ç¤ºå‡ºæ¥</li></ol><p>åœ¨è¿‡ç¨‹ 1 ä¸­ï¼Œå°†åŸå§‹ data encode æˆ resource æ•°æ®åï¼Œä¼šè°ƒç”¨ DecodeJob.onResourceDecoded å¯¹ resource æ•°æ®è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€‚DecodeJob.onResourceDecoded é¦–å…ˆä¼šå¯¹ resource è¿›è¡Œ transformï¼Œç„¶åå¯èƒ½ä¼šè¿›è¡Œç£ç›˜ç¼“å­˜ã€‚</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034509.png width=auto alt></p><a href=#é¢è¯•é¢˜><h1 id=é¢è¯•é¢˜><span class=hanchor arialabel=Anchor># </span>é¢è¯•é¢˜</h1></a><p>å†…å­˜ç¼“å­˜åˆ†ä¸¤ä¸ªåŸå› ï¼š</p><p>1ã€æ´»åŠ¨ç¼“å­˜ä¸»è¦æ˜¯å½“å‰æ­£åœ¨ä½¿ç”¨çš„å›¾ç‰‡èµ„æºã€‚å›¾ç‰‡èµ„æºå­˜æ”¾åœ¨å¼±å¼•ç”¨ä¸­ã€‚ä¸‹é¢æ˜¯åªç”¨æ´»åŠ¨ç¼“å­˜çš„ç¼ºç‚¹</p><p>åœºæ™¯ï¼šä¸Šä¸‹æ»‘åŠ¨åˆ—è¡¨ï¼Œå›¾ç‰‡ä¼šä¸æ–­åˆ›å»ºï¼Œå½“ GC æ¥ä¸´æ—¶å€™ï¼Œä¼šå°†å½“å‰ä¸ä½¿ç”¨çš„å›¾ç‰‡èµ„æºè¿›è¡Œå›æ”¶ï¼Œç”±äºå­˜æ”¾åœ¨å¼±å¼•ç”¨ä¸­ã€‚è¿™æ ·å°±ä¼šå¯¼è‡´ä¸‹æ¬¡æ»‘åŠ¨å›æ¥è¿˜éœ€è¦åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><p>2ã€Lru ç¼“å­˜ä¸»è¦å­˜æ”¾ï¼šæœ€è¿‘è¢«åŠ è½½è¿‡çš„èµ„æºã€‚ä¸‹é¢æ˜¯åªç”¨ Lru çš„ç¼ºç‚¹</p><p>åœºæ™¯ï¼šæ»‘åŠ¨åˆ—è¡¨å¤´éƒ¨å¤´åƒä¸åŠ¨ï¼Œåˆ—è¡¨ä¸æ–­æ»‘åŠ¨ï¼Œç”±äº Lru çš„æœºåˆ¶ç¼“å­˜åˆ°è¾¾ä¸€å®šå¤§å°ï¼Œå¯èƒ½ä¼šå°†å¤´éƒ¨å›¾ç‰‡èµ„æºå›æ”¶ã€‚</p><p>3ã€é…åˆä½¿ç”¨ï¼Œä¸¤è€…äº’æ–¥å­˜åœ¨ã€‚å½“èµ„æºæ­£åœ¨ä½¿ç”¨çš„æ—¶å€™æ”¾åœ¨æ´»åŠ¨ç¼“å­˜ä¸­ï¼Œå½“ä¸ä½¿ç”¨çš„æ—¶å€™æ”¾åœ¨ Lru ä¸­ï¼ˆå¼•ç”¨ä¸º 0 çš„æ—¶å€™ï¼‰ã€‚so,ä¸¤è€…ç»“åˆæ€§èƒ½æœ€ä½³</p><p>ç£ç›˜ç¼“å­˜åˆ†ä¸¤ä¸ªåŸå› ï¼š
1ã€èµ„æºç¼“å­˜ä¸»è¦æ˜¯å˜æ¢åçš„èµ„æº
2ã€åŸå§‹ç¼“å­˜æ˜¯åŸå§‹çš„èµ„æºæ–‡ä»¶</p><p>åœºæ™¯ï¼šåŒä¸€å¼ å›¾ç‰‡ï¼Œå…ˆåœ¨ 100<em>100 çš„ view ä¸Šæ˜¾ç¤ºï¼Œç„¶ååœ¨ 200</em>200 çš„ view ä¸Šæ˜¾ç¤ºã€‚
åˆ†æï¼šå¦‚æœä¸ç¼“å­˜å˜æ¢åçš„å›¾ï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½éœ€è¦å˜æ¢ã€‚å¦‚æœä¸ç¼“å­˜åŸå›¾ï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½éœ€è¦é‡æ–°ç½‘ç»œä¸‹è½½åŸå›¾</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>