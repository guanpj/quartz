<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="加载流程 Glide 最普通的用法如下：
Glide.with(this).load(url).into(textView);
以首次加载 url 指向的资源到 textView 对象为例，由于代码实在太过冗长，下面用流程图的方式表示各个环节的执行顺序。
with with 流程的主要职责：
 创建 RequestManager 对象 初始化各式各样的配置信息（缓存、请求线程池、图片大小和格式等等）以及 Glide 单例对象。 将 Glide 请求和 application/Activity/SupportFragment/Fragment 的生命周期绑定在一起，从而实现自动执行请求，暂停操作。   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  public class Glide implements ComponentCallbacks2 { ."><meta property="og:title" content="Glide 加载流程和缓存原理分析"><meta property="og:description" content="加载流程 Glide 最普通的用法如下：
Glide.with(this).load(url).into(textView);
以首次加载 url 指向的资源到 textView 对象为例，由于代码实在太过冗长，下面用流程图的方式表示各个环节的执行顺序。
with with 流程的主要职责：
 创建 RequestManager 对象 初始化各式各样的配置信息（缓存、请求线程池、图片大小和格式等等）以及 Glide 单例对象。 将 Glide 请求和 application/Activity/SupportFragment/Fragment 的生命周期绑定在一起，从而实现自动执行请求，暂停操作。   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  public class Glide implements ComponentCallbacks2 { ."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Glide 加载流程和缓存原理分析"><meta name=twitter:description content="加载流程 Glide 最普通的用法如下：
Glide.with(this).load(url).into(textView);
以首次加载 url 指向的资源到 textView 对象为例，由于代码实在太过冗长，下面用流程图的方式表示各个环节的执行顺序。
with with 流程的主要职责：
 创建 RequestManager 对象 初始化各式各样的配置信息（缓存、请求线程池、图片大小和格式等等）以及 Glide 单例对象。 将 Glide 请求和 application/Activity/SupportFragment/Fragment 的生命周期绑定在一起，从而实现自动执行请求，暂停操作。   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  public class Glide implements ComponentCallbacks2 { ."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>Glide 加载流程和缓存原理分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.0452046239b15cdfa822e3a8fa41b16d.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.cf6439e057b2800c40a018b5e420d51c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.3a9d406d6640c34b72da2343af85f983.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Glide 加载流程和缓存原理分析</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/Glide/>Glide</a></li><li><a href=https://www.guanpj.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>源码解析</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#strong加载流程strong><strong>加载流程</strong></a><ol><li><a href=#with>with</a><ol><li><a href=#getretrievercontext>getRetriever(Context)</a></li><li><a href=#requestmanagerretrieverget>RequestManagerRetriever.get</a></li><li><a href=#小结>小结</a></li></ol></li><li><a href=#strongloadstrong><strong>load</strong></a><ol><li><a href=#requestmanagerasxx>RequestManager.asXx</a></li><li><a href=#requestbuilderload>RequestBuilder.load</a></li><li><a href=#小结-1>小结</a></li></ol></li><li><a href=#into>into</a></li><li><a href=#strong整体流程strong><strong>整体流程</strong></a></li></ol></li><li><a href=#strong缓存strong><strong>缓存</strong></a><ol><li><a href=#glide-缓存机制>Glide 缓存机制</a></li><li><a href=#strong配置缓存strong><strong>配置缓存</strong></a><ol><li><a href=#磁盘缓存策略>磁盘缓存策略</a></li><li><a href=#仅从缓存加载图片>仅从缓存加载图片</a></li><li><a href=#跳过缓存>跳过缓存</a></li></ol></li><li><a href=#活动资源-activeresource>活动资源 ActiveResource</a></li><li><a href=#内存缓存-memorycache>内存缓存 MemoryCache</a></li><li><a href=#strong磁盘缓存-diskcachestrong><strong>磁盘缓存 DiskCache</strong></a></li><li><a href=#缓存流程>缓存流程</a><ol><li><a href=#enginekey>EngineKey</a></li><li><a href=#内存缓存>内存缓存</a><ol><li><a href=#activeresource-和-memorycache>ActiveResource 和 MemoryCache</a></li></ol></li><li><a href=#磁盘缓存>磁盘缓存</a><ol><li><a href=#decocejob>DecoceJob</a></li><li><a href=#resourcecachekey-和-datacachekey>ResourceCacheKey 和 DataCacheKey</a></li><li><a href=#resourcecachegenerator>ResourceCacheGenerator</a></li><li><a href=#datacachegenerator>DataCacheGenerator</a></li><li><a href=#sourcegenerator>SourceGenerator</a></li><li><a href=#decodejobfetcherreadycallback>DecodeJob.FetcherReadyCallback</a></li></ol></li></ol></li></ol></li><li><a href=#面试题>面试题</a></li></ol></nav></details></aside><a href=#strong加载流程strong><h1 id=strong加载流程strong><span class=hanchor arialabel=Anchor># </span><strong>加载流程</strong></h1></a><p>Glide 最普通的用法如下：</p><p>Glide.with(this).load(url).into(textView);</p><p>以首次加载 url 指向的资源到 textView 对象为例，由于代码实在太过冗长，下面用流程图的方式表示各个环节的执行顺序。</p><a href=#with><h2 id=with><span class=hanchor arialabel=Anchor># </span>with</h2></a><p>with 流程的主要职责：</p><ul><li>创建 RequestManager 对象</li><li>初始化各式各样的配置信息（缓存、请求线程池、图片大小和格式等等）以及 Glide 单例对象。</li><li>将 Glide 请求和 application/Activity/SupportFragment/Fragment 的生命周期绑定在一起<strong>，从而实现自动执行请求，暂停操作</strong>。</li></ul><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034132.png width=auto alt></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Glide</span> <span class=kd>implements</span> <span class=n>ComponentCallbacks2</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>context</span><span class=o>).</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Activity</span> <span class=n>activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>activity</span><span class=o>).</span><span class=na>get</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>FragmentActivity</span> <span class=n>activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>activity</span><span class=o>).</span><span class=na>get</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Fragment</span> <span class=n>fragment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>()).</span><span class=na>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>android</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>Fragment</span> <span class=n>fragment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>()).</span><span class=na>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getRetriever</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>()).</span><span class=na>get</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>每个重载方法内部都首先调用 getRetriever(@Nullable Context context) 方法获取一个 RequestManagerRetriever 对象，然后调用其 get 方法来返回 RequestManager。</p><p>传入 getRetriever 的参数都是 Context，而 RequestManagerRetriever.get 方法传入的参数各不相同，所以生命周期的绑定肯定发生在 get 方法中。把 Glide.with 方法里面的代码分成两部分来分析。</p><a href=#getretrievercontext><h3 id=getretrievercontext><span class=hanchor arialabel=Anchor># </span>getRetriever(Context)</h3></a><p>getRetriever(Context) 方法会根据 @GlideModule 注解的类以及 AndroidManifest.xml 文件中 meta-data 配置的 GlideModule 来创建一个 Glide 实例，然后返回该实例的 RequestManagerRetriever。</p><p>首先从 getRetriever(Context) 开始：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>RequestManagerRetriever</span> <span class=nf>getRetriever</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Context could be null for other reasons (ie the user passes in null), but in practice it will
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// only occur due to errors with the Fragment lifecycle.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=s>&#34;You cannot start a load on a not yet attached View or a Fragment where getActivity() &#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;returns null (which usually occurs when getActivity() is called before the Fragment &#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;is attached or after the Fragment is destroyed).&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>).</span><span class=na>getRequestManagerRetriever</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Glide</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果有配置 @GlideModule 注解的 Module
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 之类会反射构造 kapt 生成的 GeneratedAppGlideModuleImpl 类
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>getAnnotationGeneratedGlideModules</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>Glide</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>checkAndInitializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>annotationGeneratedModule</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>checkAndInitializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// In the thread running initGlide(), one or more classes may call Glide.get(context).
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Without this check, those calls could trigger infinite recursion.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>isInitializing</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;You cannot call Glide.get() in registerComponents(),&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=s>&#34; use the provided Glide instance instead&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>initializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>initializeGlide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=k>new</span> <span class=n>GlideBuilder</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果 GeneratedAppGlideModuleImpl 存在，且允许解析 manifest 文件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 则遍历 manifest 中的 meta-data，解析出所有的 GlideModule 类
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>manifestModules</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>isManifestParsingEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>manifestModules</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ManifestParser</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>).</span><span class=na>parse</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 根据 Impl 的排除名单，剔除 manifest 中的 GlideModule 类
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getExcludedModuleClasses</span><span class=o>().</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedModuleClasses</span> <span class=o>=</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getExcludedModuleClasses</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>iterator</span> <span class=o>=</span> <span class=n>manifestModules</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>iterator</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>current</span> <span class=o>=</span> <span class=n>iterator</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>excludedModuleClasses</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>current</span><span class=o>.</span><span class=na>getClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;AppGlideModule excludes manifest GlideModule: &#34;</span> <span class=o>+</span> <span class=n>current</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iterator</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>glideModule</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Discovered GlideModule from manifest: &#34;</span> <span class=o>+</span> <span class=n>glideModule</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果 Impl 存在，那么设置为该类的 RequestManagerFactory；否则设置为 null
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>RequestManagerRetriever</span><span class=o>.</span><span class=na>RequestManagerFactory</span> <span class=n>factory</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>getRequestManagerFactory</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>builder</span><span class=o>.</span><span class=na>setRequestManagerFactory</span><span class=o>(</span><span class=n>factory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 依次调用 manifest 中 GlideModule 类的 applyOptions 方法，将配置写到 builder 里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>module</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 写入 Impl 的配置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 也就是说 Impl 配置的优先级更高，如果有冲突的话
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>applyOptions</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用GlideBuilder.build方法创建 Glide
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 依次调用 manifest 中 GlideModule 类的 registerComponents 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 来替换 Glide 的默认配置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>bumptech</span><span class=o>.</span><span class=na>glide</span><span class=o>.</span><span class=na>module</span><span class=o>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=o>:</span> <span class=n>manifestModules</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>module</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>glide</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>AbstractMethodError</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Attempting to register a Glide v3 module. If you see this, you or one of your&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; dependencies may be including Glide v3 even though you&#39;re using Glide v4.&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; You&#39;ll need to find and remove (or update) the offending dependency.&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; The v3 module name is: &#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=n>module</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>          <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用 Impl 中替换 Glide 配置的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>annotationGeneratedModule</span><span class=o>.</span><span class=na>registerComponents</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>glide</span><span class=o>,</span> <span class=n>glide</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 注册内存管理的回调，因为 Glide 实现了 ComponentCallbacks2 接口
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>applicationContext</span><span class=o>.</span><span class=na>registerComponentCallbacks</span><span class=o>(</span><span class=n>glide</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 保存 glide 实例到静态变量中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span><span class=o>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果没有在 AndroidManifest 和 @GlideModule 注解中进行过配置，上面的代码可以简化为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用 GlideBuilder.build 方法创建 Glide
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 注册内存管理的回调，因为 Glide 实现了 ComponentCallbacks2 接口
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>applicationContext</span><span class=o>.</span><span class=na>registerComponentCallbacks</span><span class=o>(</span><span class=n>glide</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 保存 glide 实例到静态变量中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Glide</span><span class=o>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>看一下 GlideBuilder.build 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=n>Glide</span> <span class=nf>build</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>GlideExperiments</span> <span class=n>experiments</span> <span class=o>=</span> <span class=n>glideExperimentsBuilder</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>RequestManagerRetriever</span> <span class=n>requestManagerRetriever</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>RequestManagerRetriever</span><span class=o>(</span><span class=n>requestManagerFactory</span><span class=o>,</span> <span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>engine</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>memoryCache</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>bitmapPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>arrayPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestManagerRetriever</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>connectivityMonitorFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>logLevel</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultRequestOptionsFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultTransitionOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>defaultRequestListeners</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里直接调用了 RequestManagerRetriever 构造器，且传入参数实际上为 null，在 RequestManagerRetriever 的构造器方法中会为此创建一个默认的 DEFAULT_FACTORY：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RequestManagerRetriever</span> <span class=kd>implements</span> <span class=n>Handler</span><span class=o>.</span><span class=na>Callback</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>handler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>RequestManagerFactory</span> <span class=n>factory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>RequestManagerRetriever</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@Nullable</span> <span class=n>RequestManagerFactory</span> <span class=n>factory</span><span class=o>,</span> <span class=n>GlideExperiments</span> <span class=n>experiments</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>factory</span> <span class=o>:</span> <span class=n>DEFAULT_FACTORY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>Looper</span><span class=o>.</span><span class=na>getMainLooper</span><span class=o>(),</span> <span class=k>this</span> <span class=cm>/* Callback */</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>frameWaiter</span> <span class=o>=</span> <span class=n>buildFrameWaiter</span><span class=o>(</span><span class=n>experiments</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Used internally to create {@link RequestManager}s.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>RequestManagerFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=n>RequestManager</span> <span class=nf>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>requestManagerTreeNode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestManagerFactory</span> <span class=n>DEFAULT_FACTORY</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RequestManagerFactory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>build</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>requestManagerTreeNode</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>RequestManager</span><span class=o>(</span><span class=n>glide</span><span class=o>,</span> <span class=n>lifecycle</span><span class=o>,</span> <span class=n>requestManagerTreeNode</span><span class=o>,</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>};</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>目前为止，Glide <strong>单例已经被创建出来了</strong>，其 RequestManagerRetriever 会作为 getRetriever(Context) 的返回值返回。</p><p>接下来回到 Glide.with 方法中，接着执行的是 RequestManagerRetriever.get 方法，该方法根据入参是对生命周期可感的。</p><a href=#requestmanagerretrieverget><h3 id=requestmanagerretrieverget><span class=hanchor arialabel=Anchor># </span>RequestManagerRetriever.get</h3></a><p>RequestManagerRetriever.get 方法与 Glide.with 一样，也有很多重载方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>RequestManager</span> <span class=nf>getApplicationManager</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Either an application context or we&#39;re on a background thread.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>applicationManager</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>applicationManager</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Normally pause/resume is taken care of by the fragment we add to the fragment or
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// activity. However, in this case since the manager attached to the application will not
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// receive lifecycle events, we must force the manager to start resumed using
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// ApplicationLifecycle.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>applicationManager</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>factory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>applicationManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;You cannot start a load on a null Context&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnMainThread</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>Application</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>get</span><span class=o>((</span><span class=n>FragmentActivity</span><span class=o>)</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>Activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>get</span><span class=o>((</span><span class=n>Activity</span><span class=o>)</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>ContextWrapper</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Only unwrap a ContextWrapper if the baseContext has a non-null application context.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Context#createPackageContext may return a Context without an Application instance,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// in which case a ContextWrapper may be used to attach one.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>&amp;&amp;</span> <span class=o>((</span><span class=n>ContextWrapper</span><span class=o>)</span> <span class=n>context</span><span class=o>).</span><span class=na>getBaseContext</span><span class=o>().</span><span class=na>getApplicationContext</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>get</span><span class=o>(((</span><span class=n>ContextWrapper</span><span class=o>)</span> <span class=n>context</span><span class=o>).</span><span class=na>getBaseContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>getApplicationManager</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>FragmentActivity</span> <span class=n>activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnBackgroundThread</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>activity</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>assertNotDestroyed</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>frameWaiter</span><span class=o>.</span><span class=na>registerSelf</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=o>.</span><span class=na>getSupportFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>supportFragmentGet</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>fm</span><span class=o>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=o>,</span> <span class=n>isActivityVisible</span><span class=o>(</span><span class=n>activity</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Fragment</span> <span class=n>fragment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>fragment</span><span class=o>.</span><span class=na>getContext</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>      <span class=s>&#34;You cannot start a load on a fragment before it is attached or after it is destroyed&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnBackgroundThread</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// In some unusual cases, it&#39;s possible to have a Fragment not hosted by an activity. There&#39;s
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// not all that much we can do here. Most apps will be started with a standard activity. If
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// we manage not to register the first frame waiter for a while, the consequences are not
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// catastrophic, we&#39;ll just use some extra memory.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>frameWaiter</span><span class=o>.</span><span class=na>registerSelf</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>fragment</span><span class=o>.</span><span class=na>getChildFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>supportFragmentGet</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getContext</span><span class=o>(),</span> <span class=n>fm</span><span class=o>,</span> <span class=n>fragment</span><span class=o>,</span> <span class=n>fragment</span><span class=o>.</span><span class=na>isVisible</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Activity</span> <span class=n>activity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnBackgroundThread</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>activity</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>activity</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>((</span><span class=n>FragmentActivity</span><span class=o>)</span> <span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>assertNotDestroyed</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>frameWaiter</span><span class=o>.</span><span class=na>registerSelf</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>android</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=o>.</span><span class=na>getFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fragmentGet</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>fm</span><span class=o>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=o>,</span> <span class=n>isActivityVisible</span><span class=o>(</span><span class=n>activity</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Util</span><span class=o>.</span><span class=na>isOnBackgroundThread</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>(),</span> <span class=s>&#34;Unable to obtain a request manager for a view without a Context&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Activity</span> <span class=n>activity</span> <span class=o>=</span> <span class=n>findActivity</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=c1>// The view might be somewhere else, like a service.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>activity</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>view</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Support Fragments.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Although the user might have non-support Fragments attached to FragmentActivity, searching
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// for non-support Fragments is so expensive pre O and that should be rare enough that we
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// prefer to just fall back to the Activity directly.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>activity</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Fragment</span> <span class=n>fragment</span> <span class=o>=</span> <span class=n>findSupportFragment</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=o>(</span><span class=n>FragmentActivity</span><span class=o>)</span> <span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fragment</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span> <span class=o>:</span> <span class=n>get</span><span class=o>((</span><span class=n>FragmentActivity</span><span class=o>)</span> <span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Standard Fragments.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>android</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>Fragment</span> <span class=n>fragment</span> <span class=o>=</span> <span class=n>findFragment</span><span class=o>(</span><span class=n>view</span><span class=o>,</span> <span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>fragment</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>get</span><span class=o>(</span><span class=n>fragment</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在这些 get 方法中，<strong>首先判断当前线程是不是后台线程</strong>，如果是后台线程那么就会调用 getApplicationManager 方法返回一个 RequestManager：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>applicationManager</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>factory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>由于此处 factory 是 DEFAULT_FACTORY，所以 RequestManager 就是下面的值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RequestManager</span><span class=o>(</span><span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>如果当前线程不是后台线程</strong>，get(View) 和 get(Context) 会根据情况调用 get(Fragment) 或 get(FragmentActivity)。其中 get(View) 为了找到一个合适的 Fragment 或 Fallback Activity，内部操作比较多，开销比较大，不要轻易使用。</p><p>get(Fragment) 和 get(FragmentActivity) 方法都会调用 supportFragmentGet 方法，只是传入参数不同：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// FragmentActivity activity
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=o>.</span><span class=na>getSupportFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>supportFragmentGet</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>fm</span><span class=o>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=o>,</span> <span class=n>isActivityVisible</span><span class=o>(</span><span class=n>activity</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Fragment fragment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>fragment</span><span class=o>.</span><span class=na>getChildFragmentManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>supportFragmentGet</span><span class=o>(</span><span class=n>fragment</span><span class=o>.</span><span class=na>getActivity</span><span class=o>(),</span> <span class=n>fm</span><span class=o>,</span> <span class=n>fragment</span><span class=o>,</span> <span class=n>fragment</span><span class=o>.</span><span class=na>isVisible</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>Glide 会使用一个加载目标所在的宿主 Activity 或 Fragment 的子 Fragment 来安全保存一个 RequestManager，而 RequestManager 被 Glide 用来开始、停止、管理 Glide 请求。</p><p>而 supportFragmentGet 就是创建 / 获取这个 SupportRequestManagerFragment，并返回其持有的 RequestManager 的方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>RequestManager</span> <span class=nf>supportFragmentGet</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>FragmentManager</span> <span class=n>fm</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>Fragment</span> <span class=n>parentHint</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isParentVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取一个SupportRequestManagerFragment
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>SupportRequestManagerFragment</span> <span class=n>current</span> <span class=o>=</span> <span class=n>getSupportRequestManagerFragment</span><span class=o>(</span><span class=n>fm</span><span class=o>,</span> <span class=n>parentHint</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取里面的RequestManager对象
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>RequestManager</span> <span class=n>requestManager</span> <span class=o>=</span> <span class=n>current</span><span class=o>.</span><span class=na>getRequestManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 若没有，则创建一个
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>requestManager</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>requestManager</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>factory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>glide</span><span class=o>,</span> <span class=n>current</span><span class=o>.</span><span class=na>getGlideLifecycle</span><span class=o>(),</span> <span class=n>current</span><span class=o>.</span><span class=na>getRequestManagerTreeNode</span><span class=o>(),</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// This is a bit of hack, we&#39;re going to start the RequestManager, but not the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// corresponding Lifecycle. It&#39;s safe to start the RequestManager, but starting the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Lifecycle might trigger memory leaks. See b/154405040
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>isParentVisible</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>requestManager</span><span class=o>.</span><span class=na>onStart</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置到SupportRequestManagerFragment里面，下次就不需要创建了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>current</span><span class=o>.</span><span class=na>setRequestManager</span><span class=o>(</span><span class=n>requestManager</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>requestManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 看看Fragment怎么才能高效
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>SupportRequestManagerFragment</span> <span class=nf>getSupportRequestManagerFragment</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>FragmentManager</span> <span class=n>fm</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Fragment</span> <span class=n>parentHint</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 已经添加过了，可以直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>SupportRequestManagerFragment</span> <span class=n>current</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=o>(</span><span class=n>SupportRequestManagerFragment</span><span class=o>)</span> <span class=n>fm</span><span class=o>.</span><span class=na>findFragmentByTag</span><span class=o>(</span><span class=n>FRAGMENT_TAG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 从map中获取，取到也可以返回了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>current</span> <span class=o>=</span> <span class=n>pendingSupportRequestManagerFragments</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>fm</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 都没有，那么就创建一个，此时lifecycle默认为ActivityFragmentLifecycle
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>current</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SupportRequestManagerFragment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 对于fragment来说，此方法会以Activity为host创建另外一个
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// SupportRequestManagerFragment作为rootRequestManagerFragment
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 并会将current加入到rootRequestManagerFragment的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// childRequestManagerFragments中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 在RequestManager递归管理请求时会使用到
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>current</span><span class=o>.</span><span class=na>setParentFragmentHint</span><span class=o>(</span><span class=n>parentHint</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 将刚创建的fragment缓存进map起来
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>pendingSupportRequestManagerFragments</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>fm</span><span class=o>,</span> <span class=n>current</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 将fragment添加到页面中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>fm</span><span class=o>.</span><span class=na>beginTransaction</span><span class=o>().</span><span class=na>add</span><span class=o>(</span><span class=n>current</span><span class=o>,</span> <span class=n>FRAGMENT_TAG</span><span class=o>).</span><span class=na>commitAllowingStateLoss</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 以fm为key从pendingSupportRequestManagerFragments中删除
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>handler</span><span class=o>.</span><span class=na>obtainMessage</span><span class=o>(</span><span class=n>ID_REMOVE_SUPPORT_FRAGMENT_MANAGER</span><span class=o>,</span> <span class=n>fm</span><span class=o>).</span><span class=na>sendToTarget</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>current</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在上面的 supportFragmentGet 方法中，成功创建了一个 RequestManager 对象，由于 factory 是 DEFAULT_FACTORY，所以就是下面的值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RequestManager</span><span class=o>(</span><span class=n>glide</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=n>current</span><span class=o>.</span><span class=na>getGlideLifecycle</span><span class=o>(),</span>          <span class=c1>// ActivityFragmentLifecycle()
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>current</span><span class=o>.</span><span class=na>getRequestManagerTreeNode</span><span class=o>(),</span>  <span class=c1>// SupportFragmentRequestManagerTreeNode()
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>context</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>在上一步中 Glide 单例完成了初始化，这一步中成功的创建并返回了一个 RequestManager。Glide.with 已经分析完毕。</p><a href=#小结><h3 id=小结><span class=hanchor arialabel=Anchor># </span>小结</h3></a><p>with() 方法是为得到一个 RequestManager 对象，从而将 Glide 加载图片周期与 Activity 和 Fragment 进行绑定，进而管理 Glide 加载图片周期。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034143.png width=auto alt></p><a href=#strongloadstrong><h2 id=strongloadstrong><span class=hanchor arialabel=Anchor># </span><strong>load</strong></h2></a><p>由于 .with() 返回的是一个 RequestManager 对象，所以第 2 步中调用的是 RequestManager</p><p>类的 load() 方法。而 load() 方法返回的是 RequestBuilder 对象。RequestBuilder 和 RequestOptions 都派生自抽象类 BaseRequestOptions，它们的继承关系如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034149.png width=auto alt></p><p>看一下 RequestManager 的一些方法，首先看 load 的一些重载方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Bitmap</span> <span class=n>bitmap</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>bitmap</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>drawable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>drawable</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>string</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>string</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Uri</span> <span class=n>uri</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>uri</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>File</span> <span class=n>file</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>file</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@RawRes</span> <span class=nd>@DrawableRes</span> <span class=nd>@Nullable</span> <span class=n>Integer</span> <span class=n>resourceId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>resourceId</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>URL</span> <span class=n>url</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>model</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>model</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>model</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>asDrawable</span><span class=o>().</span><span class=na>load</span><span class=o>(</span><span class=n>model</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在所有的 RequestManager.load 方法中都会先调用 asDrawable() 方法得到一个 RequestBuilder 对象，然后再调用 RequestBuilder.load 方法。</p><a href=#requestmanagerasxx><h3 id=requestmanagerasxx><span class=hanchor arialabel=Anchor># </span>RequestManager.asXx</h3></a><p>asDrawable 方法同其他 as 方法（asGif、asBitmap、asFile）一样，都会先调用 RequestManager.as 方法生成一个 <code>RequestBuilder&lt;ResourceType></code> 对象，然后各个 as 方法会附加一些不同的 options：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>asBitmap</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>Bitmap</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>DECODE_TYPE_BITMAP</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGif</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>GifDrawable</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>DECODE_TYPE_GIF</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>asDrawable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>Drawable</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>asFile</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>File</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>skipMemoryCacheOf</span><span class=o>(</span><span class=kc>true</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>as</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestBuilder</span><span class=o>&lt;&gt;(</span><span class=n>glide</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>resourceClass</span><span class=o>,</span> <span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 RequestBuilder 的构造器方法方法中将 Drawable.class 这样的入参保存到了 transcodeClass 变量中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@SuppressLint</span><span class=p>(</span><span class=s2>&#34;CheckResult&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;PMD.ConstructorCallsOverridableMethod&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>protected</span> <span class=n>RequestBuilder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>RequestManager</span> <span class=n>requestManager</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=p>&lt;</span><span class=n>TranscodeType</span><span class=p>&gt;</span> <span class=n>transcodeClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>glide</span> <span class=p>=</span> <span class=n>glide</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>requestManager</span> <span class=p>=</span> <span class=n>requestManager</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>transcodeClass</span> <span class=p>=</span> <span class=n>transcodeClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>context</span> <span class=p>=</span> <span class=n>context</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>transitionOptions</span> <span class=p>=</span> <span class=n>requestManager</span><span class=p>.</span><span class=n>getDefaultTransitionOptions</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>glideContext</span> <span class=p>=</span> <span class=n>glide</span><span class=p>.</span><span class=n>getGlideContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>initRequestListeners</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=n>getDefaultRequestListeners</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=n>apply</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=n>getDefaultRequestOptions</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后回到之前的 asGif 方法中，看看 apply(DECODE_TYPE_BITMAP) 干了些什么：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// RequestManager
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestOptions</span> <span class=n>DECODE_TYPE_GIF</span> 
</span></span><span class=line><span class=cl>        <span class=o>=</span> <span class=n>RequestOptions</span><span class=o>.</span><span class=na>decodeTypeOf</span><span class=o>(</span><span class=n>GifDrawable</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGif</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>as</span><span class=o>(</span><span class=n>GifDrawable</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=n>DECODE_TYPE_GIF</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// RequestOptions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestOptions</span> <span class=nf>decodeTypeOf</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestOptions</span><span class=o>().</span><span class=na>decode</span><span class=o>(</span><span class=n>resourceClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// BaseRequestOptions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>T</span> <span class=nf>decode</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isAutoCloneEnabled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clone</span><span class=o>().</span><span class=na>decode</span><span class=o>(</span><span class=n>resourceClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>resourceClass</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>resourceClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span> <span class=o>|=</span> <span class=n>RESOURCE_CLASS</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>T</span> <span class=nf>apply</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isAutoCloneEnabled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clone</span><span class=o>().</span><span class=na>apply</span><span class=o>(</span><span class=n>o</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>other</span> <span class=o>=</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isSet</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>fields</span><span class=o>,</span> <span class=n>RESOURCE_CLASS</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resourceClass</span> <span class=o>=</span> <span class=n>other</span><span class=o>.</span><span class=na>resourceClass</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// RequestBuilder
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=nd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>apply</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>requestOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>requestOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>不难发现，apply(DECODE_TYPE_BITMAP) 就是将 BaseRequestOptions.resourceClass 设置为了 GifDrawable.class；对于 asBitmap() 来说，resourceClass 为 Bitmap.class；而对于 asDrawable() 和 asFile() 来说，resourceClass 没有进行过设置，所以为默认值 Object.class。</p><p>现在 RequestBuilder 已经由 as 系列方法生成，现在接着会调用 RequestBuilder.load 方法</p><a href=#requestbuilderload><h3 id=requestbuilderload><span class=hanchor arialabel=Anchor># </span>RequestBuilder.load</h3></a><p>RequestManager.load 方法都会调用对应的 RequestBuilder.load 重载方法；RequestBuilder.load 的各个方法基本上都会直接转发给 loadGeneric 方法，只有少数的方法才会 apply 额外的 options。</p><p>loadGeneric 方法也只是保存一下参数而已：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;unchecked&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nb>Object</span> <span class=nx>model</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>model</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>Bitmap</span> <span class=nx>bitmap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>bitmap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>diskCacheStrategyOf</span><span class=p>(</span><span class=nx>DiskCacheStrategy</span><span class=p>.</span><span class=nx>NONE</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>Drawable</span> <span class=nx>drawable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>drawable</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>diskCacheStrategyOf</span><span class=p>(</span><span class=nx>DiskCacheStrategy</span><span class=p>.</span><span class=nx>NONE</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>Uri</span> <span class=nx>uri</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>uri</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>File</span> <span class=nx>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@RawRes</span> <span class=kd>@DrawableRes</span> <span class=kd>@Nullable</span> <span class=nx>Integer</span> <span class=nx>resourceId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>resourceId</span><span class=p>).</span><span class=nx>apply</span><span class=p>(</span><span class=nx>signatureOf</span><span class=p>(</span><span class=nx>ApplicationVersionSignature</span><span class=p>.</span><span class=nx>obtain</span><span class=p>(</span><span class=nx>context</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Deprecated</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>URL</span> <span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@CheckResult</span>
</span></span><span class=line><span class=cl><span class=kd>@Override</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>load</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nx>byte</span><span class=p>[]</span> <span class=nx>model</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=nx>model</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>result</span><span class=p>.</span><span class=nx>isDiskCacheStrategySet</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>result</span> <span class=o>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>diskCacheStrategyOf</span><span class=p>(</span><span class=nx>DiskCacheStrategy</span><span class=p>.</span><span class=nx>NONE</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>result</span><span class=p>.</span><span class=nx>isSkipMemoryCacheSet</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>result</span> <span class=o>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>skipMemoryCacheOf</span><span class=p>(</span><span class=kc>true</span> <span class=cm>/*skipMemoryCache*/</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>private</span> <span class=nx>RequestBuilder</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>loadGeneric</span><span class=p>(</span><span class=kd>@Nullable</span> <span class=nb>Object</span> <span class=nx>model</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=nx>model</span> <span class=o>=</span> <span class=nx>model</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>isModelSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如上面最后的方法 loadGeneric，这里只是将参数保存在 model 中并设置 isModelSet=true 就完了，</p><a href=#小结-1><h3 id=小结-1><span class=hanchor arialabel=Anchor># </span>小结</h3></a><p>load 流程主要给 GlideRequest（RequestManager）设置了要请求的 mode（url），并将 isModelSet 变量设置为 true，表示已设置的状态，最后返回 RequestBuilder。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034156.png width=auto alt></p><a href=#into><h2 id=into><span class=hanchor arialabel=Anchor># </span>into</h2></a><p>RequestBuilder.into 有四个重载方法，最终都调用了参数最多的一个：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=p>&lt;</span><span class=nt>Y</span> <span class=na>extends</span> <span class=na>Target</span><span class=err>&lt;</span><span class=na>TranscodeType</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>Y</span> <span class=nx>into</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>Y</span> <span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>Executors</span><span class=p>.</span><span class=nx>mainThreadExecutor</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>@Synthetic</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>Y</span> <span class=na>extends</span> <span class=na>Target</span><span class=err>&lt;</span><span class=na>TranscodeType</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>Y</span> <span class=nx>into</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@NonNull</span> <span class=nx>Y</span> <span class=nx>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Nullable</span> <span class=nx>RequestListener</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Executor</span> <span class=nx>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>targetListener</span><span class=p>,</span> <span class=cm>/*options=*/</span> <span class=k>this</span><span class=p>,</span> <span class=nx>callbackExecutor</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>private</span> <span class=p>&lt;</span><span class=nt>Y</span> <span class=na>extends</span> <span class=na>Target</span><span class=err>&lt;</span><span class=na>TranscodeType</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=nx>Y</span> <span class=nx>into</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@NonNull</span> <span class=nx>Y</span> <span class=nx>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Nullable</span> <span class=nx>RequestListener</span><span class=p>&lt;</span><span class=nt>TranscodeType</span><span class=p>&gt;</span> <span class=nx>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Executor</span> <span class=nx>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Preconditions</span><span class=p>.</span><span class=nx>checkNotNull</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isModelSet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nx>IllegalArgumentException</span><span class=p>(</span><span class=s2>&#34;You must call #load() before calling #into()&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Request</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>buildRequest</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>targetListener</span><span class=p>,</span> <span class=nx>options</span><span class=p>,</span> <span class=nx>callbackExecutor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Request</span> <span class=nx>previous</span> <span class=o>=</span> <span class=nx>target</span><span class=p>.</span><span class=nx>getRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>isEquivalentTo</span><span class=p>(</span><span class=nx>previous</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isSkipMemoryCacheWithCompletePreviousRequest</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span> <span class=nx>previous</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If the request is completed, beginning again will ensure the result is re-delivered,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// triggering RequestListeners and Targets. If the request is failed, beginning again will
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// restart the request, giving it another chance to complete. If the request is already
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// running, we can let it continue running without interruption.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>Preconditions</span><span class=p>.</span><span class=nx>checkNotNull</span><span class=p>(</span><span class=nx>previous</span><span class=p>).</span><span class=nx>isRunning</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Use the previous request rather than the new one to allow for optimizations like skipping
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// that are done in the individual Request.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>previous</span><span class=p>.</span><span class=nx>begin</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>requestManager</span><span class=p>.</span><span class=nx>clear</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>target</span><span class=p>.</span><span class=nx>setRequest</span><span class=p>(</span><span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>requestManager</span><span class=p>.</span><span class=nx>track</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 最常用的一个重载
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kr>public</span> <span class=nx>ViewTarget</span><span class=p>&lt;</span><span class=nt>ImageView</span><span class=err>,</span> <span class=na>TranscodeType</span><span class=p>&gt;</span> <span class=nx>into</span><span class=p>(</span><span class=kd>@NonNull</span> <span class=nx>ImageView</span> <span class=nx>view</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Util</span><span class=p>.</span><span class=nx>assertMainThread</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>Preconditions</span><span class=p>.</span><span class=nx>checkNotNull</span><span class=p>(</span><span class=nx>view</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=nx>requestOptions</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 若没有指定transform，isTransformationSet()为false
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// isTransformationAllowed()一般为true，除非主动调用了dontTransform()方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>requestOptions</span><span class=p>.</span><span class=nx>isTransformationSet</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>isTransformationAllowed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=nx>view</span><span class=p>.</span><span class=nx>getScaleType</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// into a different target, we don&#39;t retain the transformation applied based on the previous
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// View&#39;s scale type.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 根据ImageView的ScaleType设置不同的down sample和transform选项
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=p>(</span><span class=nx>view</span><span class=p>.</span><span class=nx>getScaleType</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>CENTER_CROP</span>:
</span></span><span class=line><span class=cl>        <span class=kt>requestOptions</span> <span class=o>=</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>clone</span><span class=p>().</span><span class=nx>optionalCenterCrop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>CENTER_INSIDE</span>:
</span></span><span class=line><span class=cl>        <span class=kt>requestOptions</span> <span class=o>=</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>clone</span><span class=p>().</span><span class=nx>optionalCenterInside</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>FIT_CENTER</span><span class=o>:</span> <span class=c1>// 默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>case</span> <span class=nx>FIT_START</span>:
</span></span><span class=line><span class=cl>      <span class=kt>case</span> <span class=nx>FIT_END</span>:
</span></span><span class=line><span class=cl>        <span class=kt>requestOptions</span> <span class=o>=</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>clone</span><span class=p>().</span><span class=nx>optionalFitCenter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>FIT_XY</span>:
</span></span><span class=line><span class=cl>        <span class=kt>requestOptions</span> <span class=o>=</span> <span class=nx>requestOptions</span><span class=p>.</span><span class=nx>clone</span><span class=p>().</span><span class=nx>optionalCenterInside</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>CENTER</span>:
</span></span><span class=line><span class=cl>      <span class=kt>case</span> <span class=nx>MATRIX</span>:
</span></span><span class=line><span class=cl>      <span class=kt>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Do nothing.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用上面的重载方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>into</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>glideContext</span><span class=p>.</span><span class=nx>buildImageViewTarget</span><span class=p>(</span><span class=nx>view</span><span class=p>,</span> <span class=nx>transcodeClass</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>requestOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>Executors</span><span class=p>.</span><span class=nx>mainThreadExecutor</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034202.png width=auto alt></p><a href=#strong整体流程strong><h2 id=strong整体流程strong><span class=hanchor arialabel=Anchor># </span><strong>整体流程</strong></h2></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034206.png width=auto alt></p><a href=#strong缓存strong><h1 id=strong缓存strong><span class=hanchor arialabel=Anchor># </span><strong>缓存</strong></h1></a><a href=#glide-缓存机制><h2 id=glide-缓存机制><span class=hanchor arialabel=Anchor># </span>Glide 缓存机制</h2></a><p>Glide 之所以被广泛使用的一个重要原因就是它强大的缓存机制。在 Glide 官方文档中，在
<a href=https://muyangmin.github.io/glide-docs-cn/doc/caching.html rel=noopener>缓存部分</a> 有如下描述：</p><p>默认情况下，Glide 会在开始一个新的图片请求之前检查以下多级的缓存：</p><p>1、活动资源 (Active Resources) - 现在是否有另一个 View 正在展示这张图片？</p><p>2、内存缓存 (Memory Cache) - 该图片是否最近被加载过并仍存在于内存中？</p><p>3、资源类型（Resource） - 该图片是否之前曾被解码、转换并写入过磁盘缓存？</p><p>4、数据来源 (Data) - 构建这个图片的资源是否之前曾被写入过文件缓存？</p><p>前两步检查图片是否在内存中，如果是则直接返回图片。后两步则检查图片是否在磁盘上，以便快速但异步地返回图片。</p><p>如果四个步骤都未能找到图片，则 Glide 会返回到原始资源以取回数据（原始文件，Uri, Url 等）。</p><p>Glide 缓存机制的流程图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034424.png width=auto alt></p><p>Glide 的 memory cache 和 disk cache 在 Glide 创建的时候就确定了。代码在 GlideBuilder.build(Context) 方法里面：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=n>Glide</span> <span class=nf>build</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=o>(</span><span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getMemoryCacheSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>engine</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>engine</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Engine</span><span class=o>(</span><span class=n>memoryCache</span><span class=o>,</span> <span class=n>diskCacheFactory</span><span class=o>,</span> <span class=o>...);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>engine</span><span class=o>,</span> <span class=n>memoryCache</span><span class=o>,</span> <span class=o>...);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果没有在任何 GlideModule 中进行自定义的话，memoryCache 和 diskCacheFactory 会使用一个默认值，大部分情况下使用这个默认值去实现缓存就可以了。</p><a href=#strong配置缓存strong><h2 id=strong配置缓存strong><span class=hanchor arialabel=Anchor># </span><strong>配置缓存</strong></h2></a><a href=#磁盘缓存策略><h3 id=磁盘缓存策略><span class=hanchor arialabel=Anchor># </span>磁盘缓存策略</h3></a><p>DiskCacheStrategy 可被 diskCacheStrategy() 方法应用到每一个单独的请求。 目前支持的策略允许你阻止加载过程使用或写入磁盘缓存，选择性地仅缓存无修改的原生数据，或仅缓存变换过的缩略图，或是兼而有之。磁盘缓存一共有以下几种策略：</p><ul><li>DiskCacheStrategy.AUTOMATIC：尝试对本地和远程图片使用最佳的策略，它是默认使用的策略。当加载远程数据（比如从 URL 下载）时，仅会存储未被加载过程修改过（比如变换）的原始数据。对于本地数据，则会仅存储变换过的缩略图，因为即使需要再次生成另一个尺寸或类型的图片，取回原始数据也很容易。</li><li>DiskCacheStrategy.NONE： 表示不缓存任何内容。</li><li>DiskCacheStrategy.DATA： 表示只缓存原始图片。</li><li>DiskCacheStrategy.RESOURCE： 表示只缓存转换过后的图片。</li><li>DiskCacheStrategy.ALL ： 表示既缓存原始图片，也缓存转换过后的图片。</li></ul><p><strong>指定 DiskCacheStrategy :</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>diskCacheStrategy</span><span class=o>(</span><span class=n>DiskCacheStrategy</span><span class=o>.</span><span class=na>ALL</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>imageView</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#仅从缓存加载图片><h3 id=仅从缓存加载图片><span class=hanchor arialabel=Anchor># </span>仅从缓存加载图片</h3></a><p>某些情形下，可能希望只要图片不在缓存中则加载直接失败（比如省流量模式？）。如果要达到这种效果，可以在单个请求的基础上使用 onlyRetrieveFromCache 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onlyRetrieveFromCache</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>imageView</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这时如果图片在内存缓存或在磁盘缓存中，它会被展示出来。否则只要这个选项被设置为 true ，这次加载会视同失败。</p><a href=#跳过缓存><h3 id=跳过缓存><span class=hanchor arialabel=Anchor># </span>跳过缓存</h3></a><p>如果你想确保一个特定的请求跳过磁盘和/或内存缓存（<em>比如，图片验证码</em>），Glide 也提供了一些替代方案。</p><p>仅跳过内存缓存，请使用 skipMemoryCache() :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>skipMemoryCache</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>仅跳过磁盘缓存，请使用 DiskCacheStrategy.NONE :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>diskCacheStrategy</span><span class=o>(</span><span class=n>DiskCacheStrategy</span><span class=o>.</span><span class=na>NONE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这两个选项可以同时使用:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Glide</span><span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>fragment</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>url</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>diskCacheStrategy</span><span class=o>(</span><span class=n>DiskCacheStrategy</span><span class=o>.</span><span class=na>NONE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>skipMemoryCache</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>into</span><span class=o>(</span><span class=n>view</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>虽然提供了这些选项跳过缓存，但不建议这么做。因为从缓存中加载一个图片，要比拉取 - 解码 - 转换成一张新图片的完整流程快得多。</p><a href=#活动资源-activeresource><h2 id=活动资源-activeresource><span class=hanchor arialabel=Anchor># </span>活动资源 ActiveResource</h2></a><p>ActiveResources 在 Engine 的构造器中被创建，它的源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kd>class</span> <span class=nc>ActiveResources</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Executor</span> <span class=n>monitorClearedResourcesExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>ResourceWeakReference</span><span class=o>&gt;</span> <span class=n>activeEngineResources</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ReferenceQueue</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>resourceReferenceQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReferenceQueue</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ResourceListener</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>isShutdown</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>DequeuedResourceCallback</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ActiveResources</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>isActiveResourceRetentionAllowed</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>concurrent</span><span class=o>.</span><span class=na>Executors</span><span class=o>.</span><span class=na>newSingleThreadExecutor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>ThreadFactory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>              <span class=kd>public</span> <span class=n>Thread</span> <span class=nf>newThread</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>Runnable</span> <span class=n>r</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                      <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                      <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>Process</span><span class=o>.</span><span class=na>setThreadPriority</span><span class=o>(</span><span class=n>Process</span><span class=o>.</span><span class=na>THREAD_PRIORITY_BACKGROUND</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>r</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                      <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>},</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;glide-active-resources&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ActiveResources</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>,</span> <span class=n>Executor</span> <span class=n>monitorClearedResourcesExecutor</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>isActiveResourceRetentionAllowed</span> <span class=o>=</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>monitorClearedResourcesExecutor</span> <span class=o>=</span> <span class=n>monitorClearedResourcesExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>monitorClearedResourcesExecutor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cleanReferenceQueue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setListener</span><span class=o>(</span><span class=n>ResourceListener</span> <span class=n>listener</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>listener</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>listener</span> <span class=o>=</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>activate</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span> <span class=n>toPut</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ResourceWeakReference</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span><span class=o>,</span> <span class=n>resource</span><span class=o>,</span> <span class=n>resourceReferenceQueue</span><span class=o>,</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span> <span class=n>removed</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>toPut</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>removed</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>removed</span><span class=o>.</span><span class=na>reset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>deactivate</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span> <span class=n>removed</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>removed</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>removed</span><span class=o>.</span><span class=na>reset</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>get</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span> <span class=n>activeRef</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>activeRef</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>activeRef</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>active</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cleanupActiveReference</span><span class=o>(</span><span class=n>activeRef</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>active</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>cleanupActiveReference</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ResourceWeakReference</span> <span class=n>ref</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>ref</span><span class=o>.</span><span class=na>isCacheable</span> <span class=o>||</span> <span class=n>ref</span><span class=o>.</span><span class=na>resource</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>newResource</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EngineResource</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>ref</span><span class=o>.</span><span class=na>resource</span><span class=o>,</span> <span class=cm>/*isMemoryCacheable=*/</span> <span class=kc>true</span><span class=o>,</span> <span class=cm>/*isRecyclable=*/</span> <span class=kc>false</span><span class=o>,</span> <span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>,</span> <span class=n>listener</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReleased</span><span class=o>(</span><span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>,</span> <span class=n>newResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>cleanReferenceQueue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(!</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ResourceWeakReference</span> <span class=n>ref</span> <span class=o>=</span> <span class=o>(</span><span class=n>ResourceWeakReference</span><span class=o>)</span> <span class=n>resourceReferenceQueue</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>cleanupActiveReference</span><span class=o>(</span><span class=n>ref</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>DequeuedResourceCallback</span> <span class=n>current</span> <span class=o>=</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>current</span><span class=o>.</span><span class=na>onResourceDequeued</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setDequeuedResourceCallback</span><span class=o>(</span><span class=n>DequeuedResourceCallback</span> <span class=n>cb</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>interface</span> <span class=nc>DequeuedResourceCallback</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>onResourceDequeued</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>shutdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>isShutdown</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>monitorClearedResourcesExecutor</span> <span class=k>instanceof</span> <span class=n>ExecutorService</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ExecutorService</span> <span class=n>service</span> <span class=o>=</span> <span class=o>(</span><span class=n>ExecutorService</span><span class=o>)</span> <span class=n>monitorClearedResourcesExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>Executors</span><span class=o>.</span><span class=na>shutdownAndAwaitTermination</span><span class=o>(</span><span class=n>service</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ResourceWeakReference</span> <span class=kd>extends</span> <span class=n>WeakReference</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isCacheable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ResourceWeakReference</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>referent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ReferenceQueue</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>queue</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>super</span><span class=o>(</span><span class=n>referent</span><span class=o>,</span> <span class=n>queue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>resource</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>referent</span><span class=o>.</span><span class=na>isMemoryCacheable</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>isActiveResourceRetentionAllowed</span>
</span></span><span class=line><span class=cl>              <span class=o>?</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>referent</span><span class=o>.</span><span class=na>getResource</span><span class=o>())</span>
</span></span><span class=line><span class=cl>              <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>isCacheable</span> <span class=o>=</span> <span class=n>referent</span><span class=o>.</span><span class=na>isMemoryCacheable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>reset</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>resource</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>先来看 ResourceWeakReference，<code>extends WeakReference&lt;EngineResource&lt;?>></code> 表示它继承自 WeakReference 并且用于保存 EngineResource 类型的引用，此外添加了一个 reset 方法用来清理资源。</p><p>构造方法中调用了 super(referent, queue)，这样如果 referent 指向的对象将要被 GC 的时候，referent 就会被放入 queue 中。</p><p>ActiveResources 初始化时，会启动一个名为“glide-active-resources”的 BACKGROUND 的线程，在该线程中会调用 cleanReferenceQueue() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>cleanReferenceQueue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(!</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//remove 方法会发生阻塞
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ResourceWeakReference</span> <span class=n>ref</span> <span class=o>=</span> <span class=o>(</span><span class=n>ResourceWeakReference</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>resourceReferenceQueue</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//清除资源
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>cleanupActiveReference</span><span class=o>(</span><span class=n>ref</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>DequeuedResourceCallback</span> <span class=n>current</span> <span class=o>=</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>current</span><span class=o>.</span><span class=na>onResourceDequeued</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>而 resourceReferenceQueue.remove() 方法会一直尝试从 queue 中获取将要被 GC 的 EngineResource。当发生 GC 时，如果 EngineResource 只 ResourceWeakReference 对象持有，ResourceWeakReference 对象就会被插入到 queue 中，这时在 remove() 方法就能获取到一个 ResourceWeakReference 对象（这是一个典型的生产者 - 消费者模型）。</p><p>然后调用 cleanupActiveReference 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>cleanupActiveReference</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ResourceWeakReference</span> <span class=n>ref</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//从集合中移除
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>activeEngineResources</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>ref</span><span class=o>.</span><span class=na>isCacheable</span> <span class=o>||</span> <span class=n>ref</span><span class=o>.</span><span class=na>resource</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>newResource</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EngineResource</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>ref</span><span class=o>.</span><span class=na>resource</span><span class=o>,</span> <span class=cm>/*isMemoryCacheable=*/</span> <span class=kc>true</span><span class=o>,</span> <span class=cm>/*isRecyclable=*/</span> <span class=kc>false</span><span class=o>,</span> <span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>,</span> <span class=n>listener</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//将被 GC 的 EngineResource 回调给 listener
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReleased</span><span class=o>(</span><span class=n>ref</span><span class=o>.</span><span class=na>key</span><span class=o>,</span> <span class=n>newResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先会将该对象从集合中移除，然后再将 ResourceWeakReference 对象中的资源取出并回调给 listener，这个 listener 的唯一实现在 Engine 类中，后面还会有地方调用这个方法，这里暂时不进行分析。</p><p>该方法除了在此时被调用外，还在 ActiveResources.get(key) 方法中也可能会因为获取到的 resource 为 null 而被调用。</p><a href=#内存缓存-memorycache><h2 id=内存缓存-memorycache><span class=hanchor arialabel=Anchor># </span>内存缓存 MemoryCache</h2></a><p>MemoryCache 发生存取操作是在 Engine 中，但是我们看到 MemoryCache 还被放入了 Glide 实例中。这是因为 Glide 实现了 ComponentCallbacks2 接口，在 Glide 创建完成后，实例就注册了该接口。这样在内存紧张的时候，可以通过回调 onTrimMemory 方法通知释放内存。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onTrimMemory</span><span class=o>(</span><span class=kt>int</span> <span class=n>level</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>trimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>trimMemory</span><span class=o>(</span><span class=kt>int</span> <span class=n>level</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Engine asserts this anyway when removing resources, fail faster and consistently
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Util</span><span class=o>.</span><span class=na>assertMainThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Request managers need to be trimmed before the caches and pools, in order for the latter to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// have the most benefit.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>synchronized</span> <span class=o>(</span><span class=n>managers</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>RequestManager</span> <span class=n>manager</span> <span class=o>:</span> <span class=n>managers</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>manager</span><span class=o>.</span><span class=na>onTrimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// memory cache needs to be trimmed before bitmap pool to trim re-pooled Bitmaps too. See #687.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>memoryCache</span><span class=o>.</span><span class=na>trimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>bitmapPool</span><span class=o>.</span><span class=na>trimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayPool</span><span class=o>.</span><span class=na>trimMemory</span><span class=o>(</span><span class=n>level</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>前面提到过，Glide 初始化的时候如果没有设置过内存缓存方案，则会采用默认实现方案：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=o>(</span><span class=n>memorySizeCalculator</span><span class=o>.</span><span class=na>getMemoryCacheSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>LruResourceCache 继承自 LruCache 类并实现了 MemoryCache 接口，LruCache 使用 LRU（least recently used，即最近最少使用）算法实现的内存淘汰算法，它的核心思想是当缓存对象的数量达到阈值时，会优先删除那些近期最少使用的缓存对象。</p><p>LruCache 定义了 LRU 相关的操作，而 MemoryCache 定义的是内存缓存相关的操作。LruResourceCache 源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LruResourceCache</span> <span class=kd>extends</span> <span class=n>LruCache</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>Resource</span><span class=o>&lt;?&gt;&gt;</span> <span class=kd>implements</span> <span class=n>MemoryCache</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ResourceRemovedListener</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Constructor for LruResourceCache.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * @param size The maximum size in bytes the in memory cache can use.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>LruResourceCache</span><span class=o>(</span><span class=kt>long</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>size</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setResourceRemovedListener</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ResourceRemovedListener</span> <span class=n>listener</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>listener</span> <span class=o>=</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onItemEvicted</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>listener</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>item</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>listener</span><span class=o>.</span><span class=na>onResourceRemoved</span><span class=o>(</span><span class=n>item</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>item</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>getSize</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>item</span><span class=o>.</span><span class=na>getSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>trimMemory</span><span class=o>(</span><span class=kt>int</span> <span class=n>level</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>level</span> <span class=o>&gt;=</span> <span class=n>android</span><span class=o>.</span><span class=na>content</span><span class=o>.</span><span class=na>ComponentCallbacks2</span><span class=o>.</span><span class=na>TRIM_MEMORY_BACKGROUND</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Entering list of cached background apps
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Evict our entire bitmap cache
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>clearMemory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>level</span> <span class=o>&gt;=</span> <span class=n>android</span><span class=o>.</span><span class=na>content</span><span class=o>.</span><span class=na>ComponentCallbacks2</span><span class=o>.</span><span class=na>TRIM_MEMORY_UI_HIDDEN</span>
</span></span><span class=line><span class=cl>        <span class=o>||</span> <span class=n>level</span> <span class=o>==</span> <span class=n>android</span><span class=o>.</span><span class=na>content</span><span class=o>.</span><span class=na>ComponentCallbacks2</span><span class=o>.</span><span class=na>TRIM_MEMORY_RUNNING_CRITICAL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// The app&#39;s UI is no longer visible, or app is in the foreground but system is running
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// critically low on memory
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Evict oldest half of our bitmap cache
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>trimToSize</span><span class=o>(</span><span class=n>getMaxSize</span><span class=o>()</span> <span class=o>/</span> <span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>LruCache</span> <span class=n>的源码如下</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LruCache</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Y</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;&gt;</span> <span class=n>cache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;(</span><span class=n>100</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>75f</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>initialMaxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>long</span> <span class=n>currentSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>LruCache</span><span class=o>(</span><span class=kt>long</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>initialMaxSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>maxSize</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>setSizeMultiplier</span><span class=o>(</span><span class=kt>float</span> <span class=n>multiplier</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>multiplier</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Multiplier must be &gt;= 0&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>maxSize</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=na>round</span><span class=o>(</span><span class=n>initialMaxSize</span> <span class=o>*</span> <span class=n>multiplier</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>evict</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Y</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kd>synchronized</span> <span class=kt>int</span> <span class=nf>getCount</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cache</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onItemEvicted</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Y</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// optional override
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>long</span> <span class=nf>getMaxSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>long</span> <span class=nf>getCurrentSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>currentSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>boolean</span> <span class=nf>contains</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cache</span><span class=o>.</span><span class=na>containsKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>Y</span> <span class=nf>get</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>entry</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>entry</span><span class=o>.</span><span class=na>value</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>Y</span> <span class=nf>put</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Y</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>itemSize</span> <span class=o>=</span> <span class=n>getSize</span><span class=o>(</span><span class=n>item</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>itemSize</span> <span class=o>&gt;=</span> <span class=n>maxSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>onItemEvicted</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>item</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>item</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>currentSize</span> <span class=o>+=</span> <span class=n>itemSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>old</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>item</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>&lt;&gt;(</span><span class=n>item</span><span class=o>,</span> <span class=n>itemSize</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>old</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>currentSize</span> <span class=o>-=</span> <span class=n>old</span><span class=o>.</span><span class=na>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>old</span><span class=o>.</span><span class=na>value</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>item</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>onItemEvicted</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>old</span><span class=o>.</span><span class=na>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>evict</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>old</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>old</span><span class=o>.</span><span class=na>value</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>Y</span> <span class=nf>remove</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>entry</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>currentSize</span> <span class=o>-=</span> <span class=n>entry</span><span class=o>.</span><span class=na>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>entry</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>clearMemory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>trimToSize</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>trimToSize</span><span class=o>(</span><span class=kt>long</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;&gt;</span> <span class=n>last</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;&gt;&gt;</span> <span class=n>cacheIterator</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>currentSize</span> <span class=o>&gt;</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//从头开始遍历
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>cacheIterator</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>entrySet</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>//第一个元素
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>last</span> <span class=o>=</span> <span class=n>cacheIterator</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>toRemove</span> <span class=o>=</span> <span class=n>last</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>currentSize</span> <span class=o>-=</span> <span class=n>toRemove</span><span class=o>.</span><span class=na>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>T</span> <span class=n>key</span> <span class=o>=</span> <span class=n>last</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>cacheIterator</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>onItemEvicted</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>toRemove</span><span class=o>.</span><span class=na>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>void</span> <span class=nf>evict</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>trimToSize</span><span class=o>(</span><span class=n>maxSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Y</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>(</span><span class=n>Y</span> <span class=n>value</span><span class=o>,</span> <span class=kt>int</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>size</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>LruCache 内部持有一个 LinkedHashMap 的变量 cache ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>T</span><span class=o>,</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;&gt;</span> <span class=n>cache</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;(</span><span class=n>100</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>75f</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>当第三个参数 accessOrder 为 true 时，表示按照访问顺序排序，每次调用 LinkedHashMap 的 get(key) 或 getOrDefault(key, defaultValue) 方法都会触发 afterNodeAccess(Object) 方法，此方法会将对应的 node 移动到链表的末尾。也就是说 LinkedHashMap 末尾的数据是最近最多使用的。</p><p>而 LruCache 清除内存时都会调用 trimToSize(size) 方法时，会从头到尾进行清理，即清理掉最少使用的元素。</p><p>LinkedHashMap 主要代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LinkedHashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>LinkedHashMap</span><span class=o>(</span><span class=kt>int</span> <span class=n>initialCapacity</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>loadFactor</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>accessOrder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>initialCapacity</span><span class=o>,</span> <span class=n>loadFactor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>accessOrder</span> <span class=o>=</span> <span class=n>accessOrder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>V</span> <span class=nf>get</span><span class=o>(</span><span class=n>Object</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>getNode</span><span class=o>(</span><span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>),</span> <span class=n>key</span><span class=o>))</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>accessOrder</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>afterNodeAccess</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>V</span> <span class=nf>getOrDefault</span><span class=o>(</span><span class=n>Object</span> <span class=n>key</span><span class=o>,</span> <span class=n>V</span> <span class=n>defaultValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>getNode</span><span class=o>(</span><span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>),</span> <span class=n>key</span><span class=o>))</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>           <span class=k>return</span> <span class=n>defaultValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=o>(</span><span class=n>accessOrder</span><span class=o>)</span>
</span></span><span class=line><span class=cl>           <span class=n>afterNodeAccess</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>       <span class=k>return</span> <span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>afterNodeAccess</span><span class=o>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// move node to last
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>last</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>accessOrder</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>last</span> <span class=o>=</span> <span class=n>tail</span><span class=o>)</span> <span class=o>!=</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>p</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=o>(</span><span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;)</span><span class=n>e</span><span class=o>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>before</span><span class=o>,</span> <span class=n>a</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>after</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=na>after</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>b</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=n>head</span> <span class=o>=</span> <span class=n>a</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>b</span><span class=o>.</span><span class=na>after</span> <span class=o>=</span> <span class=n>a</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=n>a</span><span class=o>.</span><span class=na>before</span> <span class=o>=</span> <span class=n>b</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>last</span> <span class=o>=</span> <span class=n>b</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>last</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=n>head</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>.</span><span class=na>before</span> <span class=o>=</span> <span class=n>last</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>last</span><span class=o>.</span><span class=na>after</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>tail</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>++</span><span class=n>modCount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong磁盘缓存-diskcachestrong><h2 id=strong磁盘缓存-diskcachestrong><span class=hanchor arialabel=Anchor># </span><strong>磁盘缓存 DiskCache</strong></h2></a><p>Glide 初始化时，如果 disCacheFactory 如果没有被指定，则会使用一个默认值，而这个 InternalCacheDiskCacheFactory 就是实现磁盘缓存的入口。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>InternalCacheDiskCacheFactory 源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>InternalCacheDiskCacheFactory</span> <span class=kd>extends</span> <span class=n>DiskLruCacheFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span><span class=o>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span><span class=o>.</span><span class=na>DEFAULT_DISK_CACHE_SIZE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span><span class=o>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=o>,</span> <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheName</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>CacheDirectoryGetter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>File</span> <span class=n>cacheDirectory</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getCacheDir</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>cacheDirectory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>cacheDirectory</span><span class=o>,</span> <span class=n>diskCacheName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cacheDirectory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>},</span>
</span></span><span class=line><span class=cl>        <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>它的父类 DiskLruCacheFactory 和 DiskCache 类源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DiskLruCacheFactory</span> <span class=kd>implements</span> <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CacheDirectoryGetter</span> <span class=n>cacheDirectoryGetter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Interface called out of UI thread to get the cache folder. */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>CacheDirectoryGetter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>DiskLruCacheFactory</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheFolder</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>CacheDirectoryGetter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>diskCacheFolder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>},</span>
</span></span><span class=line><span class=cl>        <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>DiskLruCacheFactory</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheFolder</span><span class=o>,</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheName</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>CacheDirectoryGetter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>diskCacheFolder</span><span class=o>,</span> <span class=n>diskCacheName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>},</span>
</span></span><span class=line><span class=cl>        <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>DiskLruCacheFactory</span><span class=o>(</span><span class=n>CacheDirectoryGetter</span> <span class=n>cacheDirectoryGetter</span><span class=o>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>diskCacheSize</span> <span class=o>=</span> <span class=n>diskCacheSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>cacheDirectoryGetter</span> <span class=o>=</span> <span class=n>cacheDirectoryGetter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DiskCache</span> <span class=nf>build</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>File</span> <span class=n>cacheDir</span> <span class=o>=</span> <span class=n>cacheDirectoryGetter</span><span class=o>.</span><span class=na>getCacheDirectory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>cacheDir</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>cacheDir</span><span class=o>.</span><span class=na>isDirectory</span><span class=o>()</span> <span class=o>||</span> <span class=n>cacheDir</span><span class=o>.</span><span class=na>mkdirs</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>DiskLruCacheWrapper</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>cacheDir</span><span class=o>,</span> <span class=n>diskCacheSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>DiskCache</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/** An interface for lazily creating a disk cache. */</span>
</span></span><span class=line><span class=cl>  <span class=kd>interface</span> <span class=nc>Factory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** 250 MB of cache. */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>DEFAULT_DISK_CACHE_SIZE</span> <span class=o>=</span> <span class=n>250</span> <span class=o>*</span> <span class=n>1024</span> <span class=o>*</span> <span class=n>1024</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>DEFAULT_DISK_CACHE_DIR</span> <span class=o>=</span> <span class=s>&#34;image_manager_disk_cache&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** Returns a new disk cache, or {@code null} if no disk cache could be created. */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>    <span class=n>DiskCache</span> <span class=nf>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/** An interface to actually write data to a key in the disk cache. */</span>
</span></span><span class=line><span class=cl>  <span class=kd>interface</span> <span class=nc>Writer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=nf>write</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>File</span> <span class=n>file</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=nf>get</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>put</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>Writer</span> <span class=n>writer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>delete</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DiskLruCacheFactory.build() 方法会返回一个 DiskLruCacheWrapper 类的实例。回溯到前面 InternalCacheDiskCacheFactory 的创建流程可知，默认创建的 DiskLruCacheWrapper 传入的 diskCacheSize 为 250M 并且 cacheDir 为 <em>/data/data/{package}/cache/image_manager_disk_cache/ </em>，分别对应缓存大小和目录。</p><p>接下来查看 DiskLruCacheWrapper 源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DiskLruCacheWrapper</span> <span class=kd>implements</span> <span class=n>DiskCache</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TAG</span> <span class=o>=</span> <span class=s>&#34;DiskLruCacheWrapper&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>APP_VERSION</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>VALUE_COUNT</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=n>DiskLruCacheWrapper</span> <span class=n>wrapper</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SafeKeyGenerator</span> <span class=n>safeKeyGenerator</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>File</span> <span class=n>directory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DiskCacheWriteLocker</span> <span class=n>writeLocker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DiskCacheWriteLocker</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>DiskLruCache</span> <span class=n>diskLruCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=n>DiskCache</span> <span class=nf>create</span><span class=o>(</span><span class=n>File</span> <span class=n>directory</span><span class=o>,</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>DiskLruCacheWrapper</span><span class=o>(</span><span class=n>directory</span><span class=o>,</span> <span class=n>maxSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>({</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>,</span> <span class=s>&#34;DeprecatedIsStillUsed&#34;</span><span class=o>})</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=nf>DiskLruCacheWrapper</span><span class=o>(</span><span class=n>File</span> <span class=n>directory</span><span class=o>,</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>directory</span> <span class=o>=</span> <span class=n>directory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>maxSize</span> <span class=o>=</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>safeKeyGenerator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SafeKeyGenerator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>synchronized</span> <span class=n>DiskLruCache</span> <span class=nf>getDiskCache</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>diskLruCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>diskLruCache</span> <span class=o>=</span> <span class=n>DiskLruCache</span><span class=o>.</span><span class=na>open</span><span class=o>(</span><span class=n>directory</span><span class=o>,</span> <span class=n>APP_VERSION</span><span class=o>,</span> <span class=n>VALUE_COUNT</span><span class=o>,</span> <span class=n>maxSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>diskLruCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>File</span> <span class=nf>get</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=o>.</span><span class=na>getSafeKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Get: Obtained: &#34;</span> <span class=o>+</span> <span class=n>safeKey</span> <span class=o>+</span> <span class=s>&#34; for for Key: &#34;</span> <span class=o>+</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>File</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>final</span> <span class=n>DiskLruCache</span><span class=o>.</span><span class=na>Value</span> <span class=n>value</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>value</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=na>getFile</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to get from disk cache&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>put</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>Writer</span> <span class=n>writer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=o>.</span><span class=na>getSafeKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>writeLocker</span><span class=o>.</span><span class=na>acquire</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Put: Obtained: &#34;</span> <span class=o>+</span> <span class=n>safeKey</span> <span class=o>+</span> <span class=s>&#34; for for Key: &#34;</span> <span class=o>+</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DiskLruCache</span> <span class=n>diskCache</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Value</span> <span class=n>current</span> <span class=o>=</span> <span class=n>diskCache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>DiskLruCache</span><span class=o>.</span><span class=na>Editor</span> <span class=n>editor</span> <span class=o>=</span> <span class=n>diskCache</span><span class=o>.</span><span class=na>edit</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>editor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Had two simultaneous puts for: &#34;</span> <span class=o>+</span> <span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>File</span> <span class=n>file</span> <span class=o>=</span> <span class=n>editor</span><span class=o>.</span><span class=na>getFile</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=o>(</span><span class=n>writer</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>file</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>editor</span><span class=o>.</span><span class=na>commit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>editor</span><span class=o>.</span><span class=na>abortUnlessCommitted</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to put to disk cache&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>writeLocker</span><span class=o>.</span><span class=na>release</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>delete</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=o>.</span><span class=na>getSafeKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>getDiskCache</span><span class=o>().</span><span class=na>remove</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to delete from disk cache&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>clear</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>getDiskCache</span><span class=o>().</span><span class=na>delete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to clear disk cache or disk cache cleared externally&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>resetDiskCache</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>resetDiskCache</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>diskLruCache</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>该类主要提供了一个生成 Key 的 SafeKeyGenerator 对象以及写锁 DiskCacheWriteLocker。从类名来看这是一个包装类，在代码中也可以看到，它的 get 和 put 方法最终都是通过 DiskLruCache 对象去实现的。</p><p>前面提到过，disCacheFactory 对象会被作为参数参与 Engine 的构造，在 Engine 的构造方法中会被包装成为一个 LazyDiskCacheProvider：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Engine</span><span class=o>(</span><span class=n>MemoryCache</span> <span class=n>cache</span><span class=o>,</span> <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span> <span class=n>diskCacheFactory</span><span class=o>,</span> <span class=o>...)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>cache</span> <span class=o>=</span> <span class=n>cache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>diskCacheProvider</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LazyDiskCacheProvider</span><span class=o>(</span><span class=n>diskCacheFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>LazyDiskCacheProvider</span> <span class=n>源码如下</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>LazyDiskCacheProvider</span> <span class=kd>implements</span> <span class=n>DecodeJob</span><span class=o>.</span><span class=na>DiskCacheProvider</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span> <span class=n>factory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>DiskCache</span> <span class=n>diskCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>LazyDiskCacheProvider</span><span class=o>(</span><span class=n>DiskCache</span><span class=o>.</span><span class=na>Factory</span> <span class=n>factory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@VisibleForTesting</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>clearDiskCacheIfCreated</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>diskCache</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DiskCache</span> <span class=nf>getDiskCache</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>diskCache</span> <span class=o>=</span> <span class=n>factory</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>diskCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DiskCacheAdapter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>diskCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>getDiskCache() 方法被调用时，会通过 DCL 的方式进而调用 factory 的 build( ) 方法返回一个 DiskCache 作为单例。</p><p>以上就是 Glide 缓存的介绍，前面加载流程的分析只是在首次加载图片的时候的流程，并没有涉及到缓存的概念，因此接下来继续在以上 into 流程中重点分析缓存部分的源码。</p><a href=#缓存流程><h2 id=缓存流程><span class=hanchor arialabel=Anchor># </span>缓存流程</h2></a><a href=#enginekey><h3 id=enginekey><span class=hanchor arialabel=Anchor># </span>EngineKey</h3></a><p>从之前的分析中可知，整个加载的过程体现在 Engine.load 方法中，该方法注释和代码片段如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>LoadStatus</span> <span class=nf>load</span><span class=o>(...)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>VERBOSE_IS_LOGGABLE</span> <span class=o>?</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>()</span> <span class=o>:</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>EngineKey</span> <span class=n>key</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>keyFactory</span><span class=o>.</span><span class=na>buildKey</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>model</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>signature</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>height</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>transformations</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>resourceClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>transcodeClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>memoryResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memoryResource</span> <span class=o>=</span> <span class=n>loadFromMemory</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>isMemoryCacheable</span><span class=o>,</span> <span class=n>startTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>memoryResource</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//没有获取到活动资源和 MemoryCache，则启动 Job
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=n>waitForExistingOrStartNewJob</span><span class=o>(...);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Avoid calling back while holding the engine lock, doing so makes it easier for callers to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// deadlock.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>cb</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>memoryResource</span><span class=o>,</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>MEMORY_CACHE</span><span class=o>,</span> <span class=cm>/* isLoadedFromAlternateCacheKey= */</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromMemory</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>EngineKey</span> <span class=n>key</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=o>,</span> <span class=kt>long</span> <span class=n>startTime</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!</span><span class=n>isMemoryCacheable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>loadFromActiveResources</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Loaded resource from active resources&#34;</span><span class=o>,</span> <span class=n>startTime</span><span class=o>,</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>active</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>loadFromCache</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Loaded resource from cache&#34;</span><span class=o>,</span> <span class=n>startTime</span><span class=o>,</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cached</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromActiveResources</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>activeResources</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>active</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>active</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromCache</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>getEngineResourceFromCache</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cached</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>activeResources</span><span class=o>.</span><span class=na>activate</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>cached</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>cached</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>getEngineResourceFromCache</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=k>instanceof</span> <span class=n>EngineResource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Save an object allocation if we&#39;ve cached an EngineResource (the typical case).
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>result</span> <span class=o>=</span> <span class=o>(</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;)</span> <span class=n>cached</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>EngineResource</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>cached</span><span class=o>,</span> <span class=cm>/*isMemoryCacheable=*/</span> <span class=kc>true</span><span class=o>,</span> <span class=cm>/*isRecyclable=*/</span> <span class=kc>true</span><span class=o>,</span> <span class=n>key</span><span class=o>,</span> <span class=cm>/*listener=*/</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从注释和代码中可以看出，首先会根据 key 尝试从 loadFromActiveResources() 方法中获取 ActiveResource，如果能够获取到则直接返回；否则从 loadFromCache() 方法中获取 memory cache；如果仍然没有获取到，最后就交给了 Job 从网络中获取资源。没有意外的话，磁盘缓存也是由 Job 完成的。</p><p>只要是缓存，就有 get 和 put 操作，也就离不开 Key，所以先看看从 ActiveResource 和 MemoryCache 中取缓存时的 Key——EngineKey 的组成参数：</p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>model</td><td>load 的参数。如：File、Url、Url 等。如果使用自定义的 model, 它需要正确地实现 hashCode() 和 equals()</td></tr><tr><td>signature</td><td>BaseRequestOptions 的成员变量，默认会是 EmptySignature.obtain()<br>在加载本地 resource 资源时会变成 ApplicationVersionSignature.obtain(context)</td></tr><tr><td>width<br>height</td><td>如果没有指定 override(int size)，则为 view 的 size</td></tr><tr><td>transformations</td><td>默认会基于 ImageView 的 scaleType 设置对应的四个 Transformation；<br>如果指定了 transform，那么就基于该值进行设置；<br>详见 BaseRequestOptions.transform(Transformation, boolean)</td></tr><tr><td>resourceClass</td><td>解码后的资源，如果没有 asBitmap、asGif，一般会是 Object</td></tr><tr><td>transcodeClass</td><td>最终要转换成的数据类型，根据 as 方法确定，加载本地 res 或者网络 URL，都会调用 asDrawable，所以为 Drawable</td></tr><tr><td>options</td><td>如果没有设置过 transform，此处会根据 ImageView 的 scaleType 默认指定一个 KV</td></tr></tbody></table><p>再来看 EngineKey 的内部：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>EngineKey</span> <span class=kd>implements</span> <span class=n>Key</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>o</span> <span class=k>instanceof</span> <span class=n>EngineKey</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>EngineKey</span> <span class=n>other</span> <span class=o>=</span> <span class=o>(</span><span class=n>EngineKey</span><span class=o>)</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>model</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>model</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>signature</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>signature</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>height</span> <span class=o>==</span> <span class=n>other</span><span class=o>.</span><span class=na>height</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>width</span> <span class=o>==</span> <span class=n>other</span><span class=o>.</span><span class=na>width</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>transformations</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>transformations</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>resourceClass</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>resourceClass</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>transcodeClass</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>transcodeClass</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>options</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>hashCode</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>signature</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>width</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>height</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>transformations</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>resourceClass</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>transcodeClass</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>hashCode</span> <span class=o>=</span> <span class=n>31</span> <span class=o>*</span> <span class=n>hashCode</span> <span class=o>+</span> <span class=n>options</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashCode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，它的 equals 和 hashCode 方法都是标准的写法，所有成员变量都参与了判断和运算。因此在多次加载同一个 model 的过程中，即使有稍许改动（比如 View 宽高、是否经过变换等），都会导致没有获取内存缓存失败。</p><a href=#内存缓存><h3 id=内存缓存><span class=hanchor arialabel=Anchor># </span>内存缓存</h3></a><a href=#activeresource-和-memorycache><h4 id=activeresource-和-memorycache><span class=hanchor arialabel=Anchor># </span>ActiveResource 和 MemoryCache</h4></a><p>ActiveResource 的 Value 为 ResourceWeakReference，它是 EngineResource 的包装类； MemoryCache 则是直接保存 EngineResource 对象。看看 EngineResource 的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>EngineResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isRecyclable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceListener</span> <span class=n>listener</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=n>acquired</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>boolean</span> <span class=n>isRecycled</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>interface</span> <span class=nc>ResourceListener</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>toWrap</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>isRecyclable</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Key</span> <span class=n>key</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>ResourceListener</span> <span class=n>listener</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resource</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>toWrap</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>isMemoryCacheable</span> <span class=o>=</span> <span class=n>isMemoryCacheable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>isRecyclable</span> <span class=o>=</span> <span class=n>isRecyclable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>listener</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>listener</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>getResource</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=nf>isMemoryCacheable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>isMemoryCacheable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>getResourceClass</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>resource</span><span class=o>.</span><span class=na>getResourceClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Z</span> <span class=nf>get</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>resource</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>resource</span><span class=o>.</span><span class=na>getSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>recycle</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>acquired</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot recycle a resource while it is still acquired&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isRecycled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot recycle a resource that has already been recycled&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>isRecycled</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isRecyclable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>resource</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>acquire</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isRecycled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot acquire a recycled resource&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>acquired</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>release</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>release</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>acquired</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot release a recycled or not yet acquired resource&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(--</span><span class=n>acquired</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>release</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>release</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReleased</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，acquire() 方法内部会对一个整型变量 acquired 进行自增操作，这个变量表示该资源被引用的次数，当它大于 0 的时候表示图片正在使用中。相应地，在 release() 方法内部会 acquired 进行自减，并且当变量为 0 的时候，表示没有被任何地方引用，这时会调用 listener.onResourceReleased(key, this) 通知监听器资源已被释放，从而进行后续操作。</p><p>acquire() 和 release() 方法在一般情况下外部是不能主动调用的，只有 Glide 框架会在合适的时机下会调用这两个方法。</p><p>前面介绍活动资源的时候已经提到过，EngineResource.ResourceListener 唯一实现类为 Engine，来看它的实现内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=o>(</span><span class=n>Key</span> <span class=n>cacheKey</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//从 ActiveResource 中删除
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>activeResources</span><span class=o>.</span><span class=na>deactivate</span><span class=o>(</span><span class=n>cacheKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>isMemoryCacheable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//如果开启了缓存则放入 MemoryCache 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cache</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>cacheKey</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resourceRecycler</span><span class=o>.</span><span class=na>recycle</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=cm>/*forceNextFrame=*/</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先会将缓存图片从活动资源中移除，然后再将它存入 MemoryCache 中。回到刚刚分析的 Engine.load 方法中，再看一次获取 ActiveResource 和 MemoryCache 的方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromActiveResources</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>activeResources</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>active</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>active</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromCache</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//从 MemoryCache 中移除
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>getEngineResourceFromCache</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cached</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//放入 ActiveResource 中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>activeResources</span><span class=o>.</span><span class=na>activate</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>cached</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>cached</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>除了从根据 Key 获取到 EngineResource 之外，中间还调用了 active.acquire() 方法。只要命中了缓存，那么该资源的引用计数就会加一。而且，如果命中的是 MemoryCache，那么此资源会被移动到 ActiveResource 中。</p><p>结合刚才的分析过程可知，EngineResource 在 ActiveResource 和 MemoryCache 中是互斥存在的。正在使用中的图片使用弱引用（ActiveResource）来进行缓存，不在使用中和被 GC 回收的图片使用 LruCahce（MemoryCache） 来进行缓存。</p><a href=#磁盘缓存><h3 id=磁盘缓存><span class=hanchor arialabel=Anchor># </span>磁盘缓存</h3></a><a href=#decocejob><h4 id=decocejob><span class=hanchor arialabel=Anchor># </span>DecoceJob</h4></a><p>回到 Engine.load() 方法中，如果是首次加载资源，那么 ActiveResouce 和 MemoryCache 中必然没有缓存下来，接着会走 waitForExistingOrStartNewJob() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>LoadStatus</span> <span class=nf>waitForExistingOrStartNewJob</span><span class=o>(...)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>engineJob</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>engineJobFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>key</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>isMemoryCacheable</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>useUnlimitedSourceExecutorPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>useAnimationPool</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>onlyRetrieveFromCache</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>decodeJobFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(...);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>jobs</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>engineJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>engineJob</span><span class=o>.</span><span class=na>addCallback</span><span class=o>(</span><span class=n>cb</span><span class=o>,</span> <span class=n>callbackExecutor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>engineJob</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=n>decodeJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Started new load&#34;</span><span class=o>,</span> <span class=n>startTime</span><span class=o>,</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=o>(</span><span class=n>cb</span><span class=o>,</span> <span class=n>engineJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DecoceJob 实现了 Runnable 接口，然后会被 EngineJob.start() 方法提交到对应的线程池中去执行，查看 DecoceJob.run() 方法的调用栈：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>.</span>    
</span></span><span class=line><span class=cl>    <span class=n>runWrapped</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>.</span>    
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runWrapped</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=o>(</span><span class=n>runReason</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>INITIALIZE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=o>(</span><span class=n>Stage</span><span class=o>.</span><span class=na>INITIALIZE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>SWITCH_TO_SOURCE_SERVICE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>DECODE_DATA</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>decodeFromRetrievedData</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Unrecognized run reason: &#34;</span> <span class=o>+</span> <span class=n>runReason</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Stage</span> <span class=nf>getNextStage</span><span class=o>(</span><span class=n>Stage</span> <span class=n>current</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=o>(</span><span class=n>current</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>INITIALIZE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=o>.</span><span class=na>decodeCachedResource</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>Stage</span><span class=o>.</span><span class=na>RESOURCE_CACHE</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=n>getNextStage</span><span class=o>(</span><span class=n>Stage</span><span class=o>.</span><span class=na>RESOURCE_CACHE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=o>.</span><span class=na>decodeCachedData</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>Stage</span><span class=o>.</span><span class=na>DATA_CACHE</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=n>getNextStage</span><span class=o>(</span><span class=n>Stage</span><span class=o>.</span><span class=na>DATA_CACHE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Skip loading from source if the user opted to only retrieve the resource from cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=n>onlyRetrieveFromCache</span> <span class=o>?</span> <span class=n>Stage</span><span class=o>.</span><span class=na>FINISHED</span> <span class=o>:</span> <span class=n>Stage</span><span class=o>.</span><span class=na>SOURCE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>SOURCE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>FINISHED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Stage</span><span class=o>.</span><span class=na>FINISHED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Unrecognized stage: &#34;</span> <span class=o>+</span> <span class=n>current</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>DataFetcherGenerator</span> <span class=nf>getNextGenerator</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=o>(</span><span class=n>stage</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>ResourceCacheGenerator</span><span class=o>(</span><span class=n>decodeHelper</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=o>(</span><span class=n>decodeHelper</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>SOURCE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>SourceGenerator</span><span class=o>(</span><span class=n>decodeHelper</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>FINISHED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Unrecognized stage: &#34;</span> <span class=o>+</span> <span class=n>stage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runGenerators</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>currentThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>startFetchTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>isStarted</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=o>(!</span><span class=n>isCancelled</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>currentGenerator</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=o>!(</span><span class=n>isStarted</span> <span class=o>=</span> <span class=n>currentGenerator</span><span class=o>.</span><span class=na>startNext</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=o>(</span><span class=n>stage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=o>.</span><span class=na>SOURCE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>reschedule</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We&#39;ve run out of stages and generators, give up.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>((</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=o>.</span><span class=na>FINISHED</span> <span class=o>||</span> <span class=n>isCancelled</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isStarted</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>notifyFailed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Otherwise a generator started a new load and we expect to be called back in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// onDataFetcherReady.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DecoceJob.run() 中主要调用了 runWrapped() 方法。在此方法中，首次加载时 runReason 为初始化即 RunReason.INITIALIZE 状态 ，又 diskCacheStrategy 默认为 DiskCacheStrategy.AUTOMATIC，且没有设置过 onlyRetrieveFromCache(true)。所以， decode data 的状态依次为 INITIALIZE -> RESOURCE_CACHE -> DATA_CACHE -> SOURCE -> FINISHED。对应的 DataFectcherGenerator 的 list 依次为 ResourceCacheGenerator -> DataCacheGenerator -> SourceGenerator。</p><p>在 runGenerators() 方法中会依次调用各个状态生成的 DataFetcherGenerator 的 startNext() 方法尝试 fetch 数据，直到有某个状态的 DataFetcherGenerator.startNext() 方法可以胜任。若状态抵达到了 Stage.FINISHED 或 Job 被取消，且所有状态的 DataFetcherGenerator.startNext() 都无法满足条件，则调用 SingleRequest.onLoadFailed() 进行错误处理。</p><p>这里总共有三个 DataFetcherGenerator，依次是：</p><ol><li><strong>ResourceCacheGenerator</strong>：获取采样后、transformed 后资源文件的缓存文件</li><li><strong>DataCacheGenerator</strong>：获取原始的没有修改过的资源文件的缓存文件</li><li><strong>SourceGenerator</strong>：获取原始源数据，即从网络下载或者从本地资源中加载</li></ol><a href=#resourcecachekey-和-datacachekey><h4 id=resourcecachekey-和-datacachekey><span class=hanchor arialabel=Anchor># </span>ResourceCacheKey 和 DataCacheKey</h4></a><p>看以看到，ResourceCacheGenerator 和 DataCacheGenerator 分别对应 Resource 和 Data 类型的缓存数据，都属于磁盘缓存的一部分，那么这两种数据的存取规则有什么区别呢？</p><p>先看看 ResourceCacheGenerator 中查找缓存时 key 的组成部分：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>currentKey</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getArrayPool</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>sourceId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getSignature</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>transformation</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>resourceClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>它的各个参数含义如下：</p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>helper.getArrayPool()</td><td>GlideBuilder.build 时初始化，默认为 LruArrayPool；但不参与 key 的 equals 方法</td></tr><tr><td>sourceId</td><td>如果请求的是 URL，那么此处会是一个 GlideUrl</td></tr><tr><td>helper.getSignature()</td><td>BaseRequestOptions 的成员变量，默认会是 EmptySignature.obtain()<br>在加载本地 resource 资源时会变成 ApplicationVersionSignature.obtain(context)</td></tr><tr><td>helper.getWidth()<br>helper.getHeight()</td><td>如果没有指定 override(int size)，那么将得到 view 的 size</td></tr><tr><td>transformation</td><td>默认会根据 ImageView 的 scaleType 设置对应的 BitmapTransformation；<br>如果指定了 transform，那就是指定的值</td></tr><tr><td>resourceClass</td><td>可以被编码成的资源类型，比如 BitmapDrawable 等</td></tr><tr><td>helper.getOptions()</td><td>如果没有设置过 transform，此处会根据 ImageView 的 scaleType 默认指定一个 KV</td></tr></tbody></table><p>在 ResourceCacheKey 中，arrayPool 并没有参与 equals 方法，所以判断两个 ResourceCacheKey 是否相等只需要其他 7 个参数。</p><p>然后看看 DataCacheGenerator 中 Key 的组成部分：</p><p>Key originalKey = new DataCacheKey(sourceId, helper.getSignature());</p><p>它的各个参数含义如下：</p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>sourceId</td><td>如果请求的是 URL，那么此处会是一个 GlideUrl</td></tr><tr><td>helper.getSignature()</td><td>BaseRequestOptions 的成员变量，默认会是 EmptySignature.obtain()<br>在加载本地 resource 资源时会变成 ApplicationVersionSignature.obtain(context)</td></tr></tbody></table><p>在 DataCacheKey 中，仅有的两个变量都参与了 equals 方法。这两个变量就是上面 ResourceCacheKey 中的两个变量。</p><p>显然，Data Cache 就是比较原始的数据构成的缓存，而 Resource Cache 是被解码、转换后的 Data Cache，与前面的分析呼应起来了。</p><a href=#resourcecachegenerator><h4 id=resourcecachegenerator><span class=hanchor arialabel=Anchor># </span>ResourceCacheGenerator</h4></a><p>先来看 ResourceCacheGenerator 的 startNext() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=o>...</span>
</span></span><span class=line><span class=cl> <span class=k>while</span> <span class=o>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span>
</span></span><span class=line><span class=cl>   <span class=n>currentKey</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>       <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=o>(</span><span class=c1>// NOPMD AvoidInstantiatingObjectsInLoops
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=n>helper</span><span class=o>.</span><span class=na>getArrayPool</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>           <span class=n>sourceId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=n>helper</span><span class=o>.</span><span class=na>getSignature</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>           <span class=n>helper</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>           <span class=n>helper</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>           <span class=n>transformation</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=n>resourceClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span><span class=line><span class=cl>   <span class=c1>//根据 ResourceCacheKey 获取缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getDiskCache</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>currentKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=c1>//如果找到了缓存文件，那么循环条件则会为 false，也就退出循环了
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=o>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>     <span class=n>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>     <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getModelLoaders</span><span class=o>(</span><span class=n>cacheFile</span><span class=o>);</span>
</span></span><span class=line><span class=cl>     <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=c1>// 如果找到了，hasNextModelLoader() 方法则会为 true，可以执行循环
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// 没有找到缓存文件，则不会进入循环，会直接返回 false
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl> <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl> <span class=k>while</span> <span class=o>(!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>modelLoaderIndex</span><span class=o>++);</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 在循环中会依次判断某个 ModelLoader 能不能加载此文件
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>loadData</span> <span class=o>=</span> <span class=n>modelLoader</span><span class=o>.</span><span class=na>buildLoadData</span><span class=o>(</span><span class=n>cacheFile</span><span class=o>,</span>
</span></span><span class=line><span class=cl>       <span class=n>helper</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span> <span class=n>helper</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span> <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=o>.</span><span class=na>hasLoadPath</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>     <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>     <span class=c1>// 如果某个 ModelLoader 可以，那么就调用其 fetcher 进行加载数据
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=c1>// 加载成功或失败会通知自身
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>loadData</span><span class=o>(</span><span class=n>helper</span><span class=o>.</span><span class=na>getPriority</span><span class=o>(),</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=n>started</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>获取缓存的那行代码 helper.getDiskCache().get(currentKey) 将会调用到 DiskLruCacheWrapper.get 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>File</span> <span class=nf>get</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//生成一个 String 类型的 SafeKey
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=o>.</span><span class=na>getSafeKey</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Get: Obtained: &#34;</span> <span class=o>+</span> <span class=n>safeKey</span> <span class=o>+</span> <span class=s>&#34; for for Key: &#34;</span> <span class=o>+</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//真正去获取磁盘文件缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>DiskLruCache</span><span class=o>.</span><span class=na>Value</span> <span class=n>value</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>safeKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>value</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=na>getFile</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>WARN</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Unable to get from disk cache&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先会使用 Key 映射成一个 String 类型的 safeKey，接着根据这个 safeKey 从 DiskCache 中获取缓存。</p><p>回到 ResourceCacheGenerator 中，如果确实有缓存，那么会加载该缓存文件。对于 URL 来说，调用了 ByteBufferFetcher 进行缓存文件的加载，加载成功了返回了一个 ByteBuffer，并调用了 callback 也 就是 ResourceCacheGenerator 的 onDataReady 方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=o>(</span><span class=n>Object</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>cb</span><span class=o>.</span><span class=na>onDataFetcherReady</span><span class=o>(</span><span class=n>sourceKey</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>,</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>currentKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后 ResourceCacheGenerator 又会回调 DecodeJob 的 onDataFetcherReady 方法进行后续的解码操作。</p><p>如果没有在 ResourceCacheGenerator 中被 fetch，则会回调 onLoadFailed() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>cb</span><span class=o>.</span><span class=na>onDataFetcherFailed</span><span class=o>(</span><span class=n>currentKey</span><span class=o>,</span> <span class=n>e</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>,</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>后面 DataCacheGenerator 和 SourceGenerator 的成功回调都会到这里来。</p><p>接着回调到 DecodeJob 中继续执行 runGenerators() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherFailed</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Key</span> <span class=n>attemptedKey</span><span class=o>,</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>fetcher</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=s>&#34;Fetching data failed&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>exception</span><span class=o>.</span><span class=na>setLoggingDetails</span><span class=o>(</span><span class=n>attemptedKey</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>throwables</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>exception</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=o>.</span><span class=na>SWITCH_TO_SOURCE_SERVICE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>reschedule</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#datacachegenerator><h4 id=datacachegenerator><span class=hanchor arialabel=Anchor># </span>DataCacheGenerator</h4></a><p>DecodeJob.runGenerators 方法中，继续执行 while 循环将会调用 DataCacheGenerator 的 startNext() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=o>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sourceIdIndex</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>sourceIdIndex</span> <span class=o>&gt;=</span> <span class=n>cacheKeys</span><span class=o>.</span><span class=na>size</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Key</span> <span class=n>sourceId</span> <span class=o>=</span> <span class=n>cacheKeys</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>sourceIdIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// PMD.AvoidInstantiatingObjectsInLoops The loop iterates a limited number of times
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// and the actions it performs are much more expensive than a single allocation.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;PMD.AvoidInstantiatingObjectsInLoops&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Key</span> <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=o>(</span><span class=n>sourceId</span><span class=o>,</span> <span class=n>helper</span><span class=o>.</span><span class=na>getSignature</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getDiskCache</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>originalKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getModelLoaders</span><span class=o>(</span><span class=n>cacheFile</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=o>(!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>modelLoaderIndex</span><span class=o>++);</span>
</span></span><span class=line><span class=cl>    <span class=n>loadData</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>modelLoader</span><span class=o>.</span><span class=na>buildLoadData</span><span class=o>(</span><span class=n>cacheFile</span><span class=o>,</span> <span class=n>helper</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span> <span class=n>helper</span><span class=o>.</span><span class=na>getHeight</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=o>.</span><span class=na>hasLoadPath</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>loadData</span><span class=o>(</span><span class=n>helper</span><span class=o>.</span><span class=na>getPriority</span><span class=o>(),</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>started</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>hasNextModelLoader</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>modelLoaderIndex</span> <span class=o>&lt;</span> <span class=n>modelLoaders</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>过程和 ResourceCacheGenerator 相似，由于获取的是原始的源数据，所以这里的 key 的组成非常简单。</p><a href=#sourcegenerator><h4 id=sourcegenerator><span class=hanchor arialabel=Anchor># </span>SourceGenerator</h4></a><p>由于是第一次加载，本地缓存文件肯定是没有的，接着会调用 SourceGenerator 的 startNext() 方法从网络或者本地资源中加载。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>loadDataListIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 首次运行 dataToCache 为 null
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cacheData</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 首次运行 sourceCacheGenerator 为 null
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=o>.</span><span class=na>startNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>sourceCacheGenerator</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 准备加载数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 这里直接调用了 DecodeHelper.getLoadData() 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 该方法在前面在 ResourceCacheGenerator 中被调用过，且被缓存了下来
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>while</span> <span class=o>(!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>loadData</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getLoadData</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>loadDataListIndex</span><span class=o>++);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>helper</span><span class=o>.</span><span class=na>getDiskCacheStrategy</span><span class=o>().</span><span class=na>isDataCacheable</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataSource</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>||</span> <span class=n>helper</span><span class=o>.</span><span class=na>hasLoadPath</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>())))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>//调用 MultiFetcher.loadData，然后用 this 接收回调
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>loadData</span><span class=o>(</span><span class=n>helper</span><span class=o>.</span><span class=na>getPriority</span><span class=o>(),</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>started</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>hasNextModelLoader</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>loadDataListIndex</span> <span class=o>&lt;</span> <span class=n>helper</span><span class=o>.</span><span class=na>getLoadData</span><span class=o>().</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>helper.getLoadData() 的值在 ResourceCacheGenerator 中就已经被获取并缓存下来了，这是一个 MultiModelLoader 对象生成的 LoadData 对象，LoadData 对象里面有两个 fetcher。</p><p>在上面的方法中，会遍历 LoadData list，找出符合条件的 LoadData，然后调用 loadData.fetcher.loadData 加载数据。</p><p>在 loadData 不为空的前提下，会判断 Glide 的缓存策略是否可以缓存此数据源，或者是否有加载路径。默认情况下 Glide 的缓存策略是 DiskCacheStrategy.AUTOMATIC，它的 isDataCacheable 实现如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDataCacheable</span><span class=o>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//DataSource.REMOTE 代表网络资源
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>REMOTE</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>再看下 loadData.fetcher.getDataSource()：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;,</span> <span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>getDataSource</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//fetchers 数组保存的两个 DataFetcher 都是 HttpUrlFetcher
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>fetchers</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>0</span><span class=o>).</span><span class=na>getDataSource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HttpUrlFetcher</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>InputStream</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>getDataSource</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>REMOTE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>显然，Glide 的缓存策略是可以缓存此数据源的，所以会进行数据加载。接着看看 MultiFetcher.loadData 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;,</span> <span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>fetchers</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=n>currentIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Priority</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>priority</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callback</span> <span class=o>=</span> <span class=n>callback</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>exceptions</span> <span class=o>=</span> <span class=n>throwableListPool</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>fetchers</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>currentIndex</span><span class=o>).</span><span class=na>loadData</span><span class=o>(</span><span class=n>priority</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If a race occurred where we cancelled the fetcher in cancel() and then called loadData here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// immediately after, make sure that we cancel the newly started fetcher. We don&#39;t bother
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// checking cancelled before loadData because it&#39;s not required for correctness and would
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// require an unlikely race to be useful.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>isCancelled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Data</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>callback</span><span class=o>.</span><span class=na>onDataReady</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>startNextOrFail</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>exceptions</span><span class=o>).</span><span class=na>add</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>startNextOrFail</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>void</span> <span class=nf>startNextOrFail</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isCancelled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>currentIndex</span> <span class=o>&lt;</span> <span class=n>fetchers</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>currentIndex</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>      <span class=n>loadData</span><span class=o>(</span><span class=n>priority</span><span class=o>,</span> <span class=n>callback</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>exceptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>callback</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=s>&#34;Fetch failed&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>exceptions</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里面两个 DataFetcher 都是参数相同的 HttpUrlFetcher 实例，我们直接看里面如何从网络加载图片的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//获取 InputStream 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>InputStream</span> <span class=n>result</span> <span class=o>=</span> <span class=n>loadDataWithRedirects</span><span class=o>(</span><span class=n>glideUrl</span><span class=o>.</span><span class=na>toURL</span><span class=o>(),</span> <span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>glideUrl</span><span class=o>.</span><span class=na>getHeaders</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>//将结果回调给 MultiFetcher
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>callback</span><span class=o>.</span><span class=na>onDataReady</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Failed to load data for url&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>onLoadFailed</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Finished http url fetcher fetch in &#34;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getElapsedMillis</span><span class=o>(</span><span class=n>startTime</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里将请求操作放到了 loadDataWithRedirects() 方法中，然后将请求结果通过回调返回上一层也就是 MultiFetcher.onDataReady() 中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>InputStream</span> <span class=nf>loadDataWithRedirects</span><span class=o>(</span><span class=n>URL</span> <span class=n>url</span><span class=o>,</span> <span class=kt>int</span> <span class=n>redirects</span><span class=o>,</span> <span class=n>URL</span> <span class=n>lastUrl</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headers</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 检查重定向次数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>redirects</span> <span class=o>&gt;=</span> <span class=n>MAXIMUM_REDIRECTS</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=s>&#34;Too many (&gt; &#34;</span> <span class=o>+</span> <span class=n>MAXIMUM_REDIRECTS</span> <span class=o>+</span> <span class=s>&#34;) redirects!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Comparing the URLs using .equals performs additional network I/O and is generally broken.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// See http://michaelscharf.blogspot.com/2006/11/javaneturlequals-and-hashcode-make.html.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 检查是不是重定向到自身了
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=o>(</span><span class=n>lastUrl</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>url</span><span class=o>.</span><span class=na>toURI</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>lastUrl</span><span class=o>.</span><span class=na>toURI</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=s>&#34;In re-direct loop&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>URISyntaxException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Do nothing, this is best effort.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// connectionFactory默认是DefaultHttpUrlConnectionFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 其build方法就是调用了url.openConnection()
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>urlConnection</span> <span class=o>=</span> <span class=n>connectionFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>url</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headerEntry</span> <span class=o>:</span> <span class=n>headers</span><span class=o>.</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>urlConnection</span><span class=o>.</span><span class=na>addRequestProperty</span><span class=o>(</span><span class=n>headerEntry</span><span class=o>.</span><span class=na>getKey</span><span class=o>(),</span> <span class=n>headerEntry</span><span class=o>.</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setConnectTimeout</span><span class=o>(</span><span class=n>timeout</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setReadTimeout</span><span class=o>(</span><span class=n>timeout</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setUseCaches</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setDoInput</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Stop the urlConnection instance of HttpUrlConnection from following redirects so that
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// redirects will be handled by recursive calls to this method, loadDataWithRedirects.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 禁止HttpUrlConnection自动重定向，重定向功能由本方法自己实现
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>setInstanceFollowRedirects</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Connect explicitly to avoid errors in decoders if connection fails.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>urlConnection</span><span class=o>.</span><span class=na>connect</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Set the stream so that it&#39;s closed in cleanup to avoid resource leaks. See #2352.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>stream</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isCancelled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=kt>int</span> <span class=n>statusCode</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=na>getResponseCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isHttpOk</span><span class=o>(</span><span class=n>statusCode</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// statusCode=2xx，请求成功
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>getStreamForSuccessfulRequest</span><span class=o>(</span><span class=n>urlConnection</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>isHttpRedirect</span><span class=o>(</span><span class=n>statusCode</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// statusCode=3xx，需要重定向
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>String</span> <span class=n>redirectUrlString</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=na>getHeaderField</span><span class=o>(</span><span class=s>&#34;Location&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>TextUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>redirectUrlString</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=s>&#34;Received empty or null redirect url&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>URL</span> <span class=n>redirectUrl</span> <span class=o>=</span> <span class=k>new</span> <span class=n>URL</span><span class=o>(</span><span class=n>url</span><span class=o>,</span> <span class=n>redirectUrlString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Closing the stream specifically is required to avoid leaking ResponseBodys in addition
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// to disconnecting the url connection below. See #2352.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>loadDataWithRedirects</span><span class=o>(</span><span class=n>redirectUrl</span><span class=o>,</span> <span class=n>redirects</span> <span class=o>+</span> <span class=n>1</span><span class=o>,</span> <span class=n>url</span><span class=o>,</span> <span class=n>headers</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>statusCode</span> <span class=o>==</span> <span class=n>INVALID_STATUS_CODE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -1 表示不是HTTP响应
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=n>statusCode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 其他HTTP错误
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=o>(</span><span class=n>urlConnection</span><span class=o>.</span><span class=na>getResponseMessage</span><span class=o>(),</span> <span class=n>statusCode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>到这一步已经获得网络图片的 InputStream 了，该资源会通过回调经过 MultiFetcher 然后再次回调到 SourceGenerator 中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=o>(</span><span class=n>Object</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getDiskCacheStrategy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>diskCacheStrategy</span><span class=o>.</span><span class=na>isDataCacheable</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataSource</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=n>data</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// reschedule to get back onto Glide&#39;s thread.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cb</span><span class=o>.</span><span class=na>reschedule</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cb</span><span class=o>.</span><span class=na>onDataFetcherReady</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>sourceKey</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataSource</span><span class=o>(),</span> <span class=n>originalKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>cb</span><span class=o>.</span><span class=na>onDataFetcherFailed</span><span class=o>(</span><span class=n>originalKey</span><span class=o>,</span> <span class=n>e</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>,</span> <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>getDataSource</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>onLoadFailed() 方法很简单，直接回调 DecodeJob.onDataFetcherFailed 方法。onDataReady() 方法会首先判 data 能不能缓存，若能缓存则缓存起来，然后调用 DataCacheGenerator 进行加载缓存；若不能缓存，则直接回调 DecodeJob.onDataFetcherReady() 方法通知外界 data 已经准备好了。</p><p>获取 DiskCacheStrategy 并判断能不能被缓存的逻辑在 SourceGenerator.startNext() 中出现过，之类显然是可以的。然后将 data 保存到 dataToCache，并调用 cb.reschedule()。</p><p>cb.reschedule() 的作用就是将 DecodeJob 提交到 Glide 的 source 线程池中。然后执行 DecodeJob.run() 方法，经过 runWrapped()、 runGenerators() 方法后，又回到了 SourceGenerator.startNext() 方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//首先判断是否有数据待缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cacheData</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>//刚刚构建了一个 DataCacheGenerator，这里不为空
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//调用 startNext() 后返回 true
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=o>.</span><span class=na>startNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>cacheData</span><span class=o>(</span><span class=n>Object</span> <span class=n>dataToCache</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Encoder</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>encoder</span> <span class=o>=</span> <span class=n>helper</span><span class=o>.</span><span class=na>getSourceEncoder</span><span class=o>(</span><span class=n>dataToCache</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>DataCacheWriter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>writer</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;(</span><span class=n>encoder</span><span class=o>,</span> <span class=n>dataToCache</span><span class=o>,</span> <span class=n>helper</span><span class=o>.</span><span class=na>getOptions</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>sourceKey</span><span class=o>,</span> <span class=n>helper</span><span class=o>.</span><span class=na>getSignature</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>//缓存 data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>helper</span><span class=o>.</span><span class=na>getDiskCache</span><span class=o>().</span><span class=na>put</span><span class=o>(</span><span class=n>originalKey</span><span class=o>,</span> <span class=n>writer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Finished encoding source to cache&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;, key: &#34;</span> <span class=o>+</span> <span class=n>originalKey</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;, data: &#34;</span> <span class=o>+</span> <span class=n>dataToCache</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;, encoder: &#34;</span> <span class=o>+</span> <span class=n>encoder</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34;, duration: &#34;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getElapsedMillis</span><span class=o>(</span><span class=n>startTime</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>loadData</span><span class=o>.</span><span class=na>fetcher</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//构建一个 DataCacheGenerator，传入 this 作为回调
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>sourceCacheGenerator</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=o>(</span><span class=n>Collections</span><span class=o>.</span><span class=na>singletonList</span><span class=o>(</span><span class=n>loadData</span><span class=o>.</span><span class=na>sourceKey</span><span class=o>),</span> <span class=n>helper</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 startNext() 方法的开头，会判断 dataToCache 是否为空，此时显然不为空，所以会调用 cacheData(Object) 方法进行 data 的缓存处理。缓存完毕后，会为该缓存文件生成一个 SourceCacheGenerator。然后在 startNext() 方法中会直接调用该变量进行加载。</p><p>由于在构造 DataCacheGenerator 时，指定了 FetcherReadyCallback 为 this，所以这时 DataCacheGenerator 加载结果会由 SourceGenerator 转发给 DecodeJob。</p><a href=#decodejobfetcherreadycallback><h4 id=decodejobfetcherreadycallback><span class=hanchor arialabel=Anchor># </span>DecodeJob.FetcherReadyCallback</h4></a><p>先看一下 fetch 失败时干了什么，DecodeJob.onDataFetcherFailed() 方法的实现代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherFailed</span><span class=o>(</span><span class=n>Key</span> <span class=n>attemptedKey</span><span class=o>,</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>fetcher</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=s>&#34;Fetching data failed&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>exception</span><span class=o>.</span><span class=na>setLoggingDetails</span><span class=o>(</span><span class=n>attemptedKey</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>fetcher</span><span class=o>.</span><span class=na>getDataClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>throwables</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>exception</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=o>.</span><span class=na>SWITCH_TO_SOURCE_SERVICE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>reschedule</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>显然，如果 fetch 失败了，如果不在 source 线程中就会回调 EnginJob 的 reschedule() 方法切换到 source 线程，然后重新调用 runGenerators() 方法尝试使用下一个 DataFetcherGenerator 进行加载，一直到没有一个可以加载，这时会调用 notifyFailed() 方法，正式宣告加载失败。</p><p>然后再看成功的时候回调的 onDataFetcherReady() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherReady</span><span class=o>(</span><span class=n>Key</span> <span class=n>sourceKey</span><span class=o>,</span> <span class=n>Object</span> <span class=n>data</span><span class=o>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>Key</span> <span class=n>attemptedKey</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentSourceKey</span> <span class=o>=</span> <span class=n>sourceKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentData</span> <span class=o>=</span> <span class=n>data</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentFetcher</span> <span class=o>=</span> <span class=n>fetcher</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentDataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>currentAttemptingKey</span> <span class=o>=</span> <span class=n>attemptedKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//判断当前线程是否为 currentThread
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=o>.</span><span class=na>DECODE_DATA</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//如果不是，则让 EngineJob 重新调度，最后也会调用 decodeFromRetrievedData
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>callback</span><span class=o>.</span><span class=na>reschedule</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>GlideTrace</span><span class=o>.</span><span class=na>beginSection</span><span class=o>(</span><span class=s>&#34;DecodeJob.decodeFromRetrievedData&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>decodeFromRetrievedData</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>GlideTrace</span><span class=o>.</span><span class=na>endSection</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先会保存传入的参数，然后确认执行线程后调用 decodeFromRetrievedData() 方法进行解码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>decodeFromRetrievedData</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Retrieved data&#34;</span><span class=o>,</span> <span class=n>startFetchTime</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;data: &#34;</span> <span class=o>+</span> <span class=n>currentData</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=s>&#34;, cache key: &#34;</span> <span class=o>+</span> <span class=n>currentSourceKey</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=s>&#34;, fetcher: &#34;</span> <span class=o>+</span> <span class=n>currentFetcher</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resource</span> <span class=o>=</span> <span class=n>decodeFromData</span><span class=o>(</span><span class=n>currentFetcher</span><span class=o>,</span> <span class=n>currentData</span><span class=o>,</span> <span class=n>currentDataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>setLoggingDetails</span><span class=o>(</span><span class=n>currentAttemptingKey</span><span class=o>,</span> <span class=n>currentDataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>throwables</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>notifyEncodeAndRelease</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=n>currentDataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runGenerators</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>先调用 decodeFromData() 方法进行解码，然后调用 notifyEncodeAndRelease() 方法进行缓存，同时也会通知 EngineJob 资源已经准备好了。</p><p>decodeFromData() 方法调用栈如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>decodeFromData</span><span class=o>(</span><span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=o>,</span> <span class=n>Data</span> <span class=n>data</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>data</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getLogTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>decodeFromFetcher</span><span class=o>(</span><span class=n>data</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=o>(</span><span class=s>&#34;Decoded result &#34;</span> <span class=o>+</span> <span class=n>result</span><span class=o>,</span> <span class=n>startTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fetcher</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>decodeFromFetcher</span><span class=o>(</span><span class=n>Data</span> <span class=n>data</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>,</span> <span class=o>?,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getLoadPath</span><span class=o>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;)</span> <span class=n>data</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>runLoadPath</span><span class=o>(</span><span class=n>data</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>path</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>,</span> <span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>runLoadPath</span><span class=o>(</span><span class=n>Data</span> <span class=n>data</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>,</span> <span class=n>ResourceType</span><span class=o>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=n>getOptionsWithHardwareConfig</span><span class=o>(</span><span class=n>dataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span> <span class=o>=</span> <span class=n>glideContext</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>().</span><span class=na>getRewinder</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ResourceType in DecodeCallback below is required for compilation to work with gradle.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>path</span><span class=o>.</span><span class=na>load</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>rewinder</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=k>new</span> <span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;(</span><span class=n>dataSource</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>rewinder</span><span class=o>.</span><span class=na>cleanup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>path.load(..., new DecodeCallback&lt;ResourceType>(dataSource))</code> 这行代码中，最后传入了一个 DecodeCallback 回调，该类的回调方法会回调给 DecodeJob 对应的方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DecodePath</span><span class=o>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl>  <span class=n>DecodeCallback</span><span class=o>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>dataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>DecodeJob</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>onResourceDecoded</span><span class=o>(</span><span class=n>dataSource</span><span class=o>,</span> <span class=n>decoded</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后来看一下 LoadPath.load() 方法的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>load</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=n>DecodePath</span><span class=o>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decodeCallback</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>throwables</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>listPool</span><span class=o>.</span><span class=na>acquire</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>loadWithExceptionList</span><span class=o>(</span><span class=n>rewinder</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>decodeCallback</span><span class=o>,</span> <span class=n>throwables</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listPool</span><span class=o>.</span><span class=na>release</span><span class=o>(</span><span class=n>throwables</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>loadWithExceptionList</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=n>DecodePath</span><span class=o>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decodeCallback</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>decodePaths</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>,</span> <span class=n>ResourceType</span><span class=o>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span> <span class=n>decodePaths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>path</span><span class=o>.</span><span class=na>decode</span><span class=o>(</span><span class=n>rewinder</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>decodeCallback</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exceptions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=n>failureMessage</span><span class=o>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>exceptions</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于每条 DecodePath，都调用其 decode() 方法，直到有一个 DecodePath 可以 decode 出资源。继续看看 DecodePath.decode() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>decode</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>,</span> <span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decoded</span> <span class=o>=</span> <span class=n>decodeResource</span><span class=o>(</span><span class=n>rewinder</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>callback</span><span class=o>.</span><span class=na>onResourceDecoded</span><span class=o>(</span><span class=n>decoded</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>transcoder</span><span class=o>.</span><span class=na>transcode</span><span class=o>(</span><span class=n>transformed</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里有三个步骤：</p><ol><li>使用 ResourceDecoder List 进行 decode，将原始数据解码成原始图片</li><li>将 decoded 的资源进行 transform</li><li>将 transformed 的资源进行 transcode</li></ol><p>首先是 decodeResource() 的过程：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>decodeResource</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>listPool</span><span class=o>.</span><span class=na>acquire</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decodeResourceWithList</span><span class=o>(</span><span class=n>rewinder</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>exceptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listPool</span><span class=o>.</span><span class=na>release</span><span class=o>(</span><span class=n>exceptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>decodeResourceWithList</span><span class=o>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span><span class=o>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>decoders</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//decoders 只有一条，就是 ByteBufferBitmapDecoder
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>,</span> <span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decoder</span> <span class=o>=</span> <span class=n>decoders</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//rewinder 自然是 ByteBufferRewind
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>//data 为 ByteBuffer
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>DataType</span> <span class=n>data</span> <span class=o>=</span> <span class=n>rewinder</span><span class=o>.</span><span class=na>rewindAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>//ByteBufferBitmapDecoder 内部会调用 Downsampler 的 hanldes 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 它对任意的 InputStream 和 ByteBuffer 都返回 true
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=o>(</span><span class=n>decoder</span><span class=o>.</span><span class=na>handles</span><span class=o>(</span><span class=n>data</span><span class=o>,</span> <span class=n>options</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//调用 ByteBuffer.position(0) 复位
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>data</span> <span class=o>=</span> <span class=n>rewinder</span><span class=o>.</span><span class=na>rewindAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//开始解码
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>result</span> <span class=o>=</span> <span class=n>decoder</span><span class=o>.</span><span class=na>decode</span><span class=o>(</span><span class=n>data</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Some decoders throw unexpectedly. If they do, we shouldn&#39;t fail the entire load path, but
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// instead log and continue. See #2406 for an example.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=o>|</span> <span class=n>RuntimeException</span> <span class=o>|</span> <span class=n>OutOfMemoryError</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>isLoggable</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=n>Log</span><span class=o>.</span><span class=na>VERBOSE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Failed to decode data for &#34;</span> <span class=o>+</span> <span class=n>decoder</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>exceptions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>GlideException</span><span class=o>(</span><span class=n>failureMessage</span><span class=o>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>exceptions</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>ByteBufferBitmapDecoder</span><span class=o>.</span><span class=na>decode</span><span class=o>()</span> <span class=n>方法</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>decode</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>ByteBuffer</span> <span class=n>source</span><span class=o>,</span> <span class=kt>int</span> <span class=n>width</span><span class=o>,</span> <span class=kt>int</span> <span class=n>height</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>InputStream</span> <span class=n>is</span> <span class=o>=</span> <span class=n>ByteBufferUtil</span><span class=o>.</span><span class=na>toStream</span><span class=o>(</span><span class=n>source</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>downsampler</span><span class=o>.</span><span class=na>decode</span><span class=o>(</span><span class=n>is</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>先将 ByteBuffer 转换成 InputStream，然后调用 Downsampler.decode() 方法进行解码。</p><p>这里执行完毕，会将 decode 出来的 Bitmap 包装成为一个 BitmapResource 对象。然后就一直往上返回，返回到 DecodePath.decode 方法中。接下来执行第二行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>callback</span><span class=o>.</span><span class=na>onResourceDecoded</span><span class=o>(</span><span class=n>decoded</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的 callback 在前面提到过，这会调用 <code>DecodeJob.onResourceDecoded(DataSource, Resource&lt;Z>)</code> 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl><span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=o>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceSubClass</span> <span class=o>=</span> <span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;)</span> <span class=n>decoded</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>getClass</span><span class=o>();</span><span class=c1>// Bitmap.class
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>decoded</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//dataSource为DATA_DISK_CACHE，所以满足条件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>dataSource</span> <span class=o>!=</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Bitmap.class对应的正是FitCenter()
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getTransformation</span><span class=o>(</span><span class=n>resourceSubClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//对decoded资源进行transform
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>transformed</span> <span class=o>=</span> <span class=n>appliedTransformation</span><span class=o>.</span><span class=na>transform</span><span class=o>(</span><span class=n>glideContext</span><span class=o>,</span> <span class=n>decoded</span><span class=o>,</span> <span class=n>width</span><span class=o>,</span> <span class=n>height</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//TODO: Make this the responsibility of the Transformation.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!</span><span class=n>decoded</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>transformed</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>decoded</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>EncodeStrategy</span> <span class=n>encodeStrategy</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//Bitmap有注册对应的BitmapEncoder，所以是available的
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>decodeHelper</span><span class=o>.</span><span class=na>isResourceEncoderAvailable</span><span class=o>(</span><span class=n>transformed</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//encoder就是BitmapEncoder
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>encoder</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getResultEncoder</span><span class=o>(</span><span class=n>transformed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//encodeStrategy为EncodeStrategy.TRANSFORMED
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>encoder</span><span class=o>.</span><span class=na>getEncodeStrategy</span><span class=o>(</span><span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>EncodeStrategy</span><span class=o>.</span><span class=na>NONE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>transformed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//isSourceKey显然为true，所以isFromAlternateCacheKey为false，所以就返回了
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>boolean</span> <span class=n>isFromAlternateCacheKey</span> <span class=o>=</span> <span class=o>!</span><span class=n>decodeHelper</span><span class=o>.</span><span class=na>isSourceKey</span><span class=o>(</span><span class=n>currentSourceKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//diskCacheStrategy为AUTOMATIC，该方法返回false
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>diskCacheStrategy</span><span class=o>.</span><span class=na>isResourceCacheable</span><span class=o>(</span><span class=n>isFromAlternateCacheKey</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>encodeStrategy</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>encoder</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>Registry</span><span class=o>.</span><span class=na>NoResultEncoderAvailableException</span><span class=o>(</span><span class=n>transformed</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>encodeStrategy</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>SOURCE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=o>(</span><span class=n>currentSourceKey</span><span class=o>,</span> <span class=n>signature</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>TRANSFORMED</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>decodeHelper</span><span class=o>.</span><span class=na>getArrayPool</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>currentSourceKey</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>signature</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>width</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>height</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>appliedTransformation</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resourceSubClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Unknown strategy: &#34;</span> <span class=o>+</span> <span class=n>encodeStrategy</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>lockedResult</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>transformed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>deferredEncodeManager</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>encoder</span><span class=o>,</span> <span class=n>lockedResult</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResult</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当 dataSource != DataSource.RESOURCE_DISK_CACHE 时会进行 transform，这是因为 resource cache 肯定已经经历过 transform 了，所以就不用重新来一遍了。</p><p>然后就回到 DecodePath.decode 方法的第三行了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>return</span> <span class=n>transcoder</span><span class=o>.</span><span class=na>transcode</span><span class=o>(</span><span class=n>transformed</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的 transcoder 就是 BitmapDrawableTranscoder，该方法返回了一个 LazyBitmapDrawableResource。</p><p>至此，resource 已经 decode 完毕。下面一直返回到 DecodeJob.decodeFromRetrievedData() 方法中。下面会调用 notifyEncodeAndRelease() 方法完成后面的事宜。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>notifyEncodeAndRelease</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// resource是BitmapResource类型，实现了Initializable接口
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Initializable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// initialize方法调用了bitmap.prepareToDraw()
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>((</span><span class=n>Initializable</span><span class=o>)</span> <span class=n>resource</span><span class=o>).</span><span class=na>initialize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>lockedResource</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>deferredEncodeManager</span><span class=o>.</span><span class=na>hasResourceToEncode</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>lockedResource</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=o>.</span><span class=na>obtain</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 通知回调，资源已经就绪
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>notifyComplete</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>stage</span> <span class=o>=</span> <span class=n>Stage</span><span class=o>.</span><span class=na>ENCODE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>deferredEncodeManager</span><span class=o>.</span><span class=na>hasResourceToEncode</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>deferredEncodeManager</span><span class=o>.</span><span class=na>encode</span><span class=o>(</span><span class=n>diskCacheProvider</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// lockedResource为null, skip
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>lockedResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>lockedResource</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Call onEncodeComplete outside the finally block so that it&#39;s not called if the encode process
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// throws.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 进行清理工作
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>onEncodeComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>重点在于 notifyComplete() 方法，该方法内部会调用 callback.onResourceReady(resource, dataSource) 将结果传递给回调，这里的回调是 EngineJob：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>dataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>notifyCallbacksOfResult</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>notifyCallbacksOfResult</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ResourceCallbacksAndExecutors</span> <span class=n>copy</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Key</span> <span class=n>localKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>localResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>stateVerifier</span><span class=o>.</span><span class=na>throwIfRecycled</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>isCancelled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// TODO: Seems like we might as well put this in the memory cache instead of just recycling
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// it since we&#39;ve gotten this far...
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>resource</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>cbs</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Received a resource without any callbacks to notify&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>hasResource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Already have resource&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// engineResourceFactory默认为EngineResourceFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 其build方法就是new一个对应的资源
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// new EngineResource&lt;&gt;(resource, isMemoryCacheable, /*isRecyclable=*/ true)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>engineResource</span> <span class=o>=</span> <span class=n>engineResourceFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=n>isCacheable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// a lock here so that any newly added callback that executes before the next locked section
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// below can&#39;t recycle the resource before we call the callbacks.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>hasResource</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>copy</span> <span class=o>=</span> <span class=n>cbs</span><span class=o>.</span><span class=na>copy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>incrementPendingCallbacks</span><span class=o>(</span><span class=n>copy</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>localKey</span> <span class=o>=</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>localResource</span> <span class=o>=</span> <span class=n>engineResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// listener就是Engine，该方法会将资源保存到activeResources中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>listener</span><span class=o>.</span><span class=na>onEngineJobComplete</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>localKey</span><span class=o>,</span> <span class=n>localResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 这里的ResourceCallbackAndExecutor就是我创建EngineJob和DecodeJob
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 并在执行DecodeJob之前添加的回调
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// entry.executor就是Glide.with.load.into中出现的Executors.mainThreadExecutor()
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// entry.cb就是SingleRequest
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=kd>final</span> <span class=n>ResourceCallbackAndExecutor</span> <span class=n>entry</span> <span class=o>:</span> <span class=n>copy</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>entry</span><span class=o>.</span><span class=na>executor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>CallResourceReady</span><span class=o>(</span><span class=n>entry</span><span class=o>.</span><span class=na>cb</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>decrementPendingCallbacks</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>listener.onEngineJobComplete() 的代码很简单。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onEngineJobComplete</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>engineJob</span><span class=o>,</span> <span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// A null resource indicates that the load failed, usually due to an exception.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resource</span><span class=o>.</span><span class=na>setResourceListener</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>isCacheable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>activeResources</span><span class=o>.</span><span class=na>activate</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>jobs</span><span class=o>.</span><span class=na>removeIfCurrent</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>engineJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=o>(</span><span class=n>Key</span> <span class=n>cacheKey</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>activeResources</span><span class=o>.</span><span class=na>deactivate</span><span class=o>(</span><span class=n>cacheKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>isCacheable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cache</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>cacheKey</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resourceRecycler</span><span class=o>.</span><span class=na>recycle</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先会设置资源的回调为自己，这样在资源释放时会通知自己的回调方法，将资源从 active 状态变为 cache 状态，如 onResourceReleased() 方法；然后将资源放入 activeResources 中，资源变为 active 状态；最后将 engineJob 从 Jobs 中移除。</p><p>然后看下 entry.executor.execute(new CallResourceReady(entry.cb)) 方法的实现，关注点在 CallResourceReady 上面：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>class</span> <span class=nc>CallResourceReady</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceCallback</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>CallResourceReady</span><span class=o>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>synchronized</span> <span class=o>(</span><span class=n>EngineJob</span><span class=o>.</span><span class=na>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>cbs</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>cb</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Acquire for this particular callback.
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>engineResource</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=n>callCallbackOnResourceReady</span><span class=o>(</span><span class=n>cb</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=n>removeCallback</span><span class=o>(</span><span class=n>cb</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>decrementPendingCallbacks</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先调用 callCallbackOnResourceReady(cb) 调用 callback，然后调用 removeCallback(cb) 移除 callback。看看 callCallbackOnResourceReady(cb)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>callCallbackOnResourceReady</span><span class=o>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// This is overly broad, some Glide code is actually called here, but it&#39;s much
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// simpler to encapsulate here than to do so at the actual call point in the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Request implementation.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cb</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>engineResource</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isLoadedFromAlternateCacheKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>CallbackException</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里就调用了 cb.onResourceReady()，这里说到过 entry.cb 就是 SingleRequest。所以继续看看 SingleRequest.onResourceReady() 方法:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>onResourceReady</span><span class=o>((</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;)</span> <span class=n>resource</span><span class=o>,</span> <span class=o>(</span><span class=n>R</span><span class=o>)</span> <span class=n>received</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=o>,</span> <span class=n>R</span> <span class=n>result</span><span class=o>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We must call isFirstReadyResource before setting status.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 由于requestCoordinator为null，所以返回true
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>boolean</span> <span class=n>isFirstResource</span> <span class=o>=</span> <span class=n>isFirstReadyResource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将status状态设置为COMPLETE
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=o>.</span><span class=na>COMPLETE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>glideContext</span><span class=o>.</span><span class=na>getLogLevel</span><span class=o>()</span> <span class=o>&lt;=</span> <span class=n>Log</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>GLIDE_TAG</span><span class=o>,</span> <span class=s>&#34;Finished loading &#34;</span> <span class=o>+</span> <span class=n>result</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getSimpleName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; from &#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=n>dataSource</span> <span class=o>+</span> <span class=s>&#34; for &#34;</span> <span class=o>+</span> <span class=n>model</span> <span class=o>+</span> <span class=s>&#34; with size [&#34;</span> <span class=o>+</span> <span class=n>width</span> <span class=o>+</span> <span class=s>&#34;x&#34;</span> <span class=o>+</span> <span class=n>height</span> <span class=o>+</span> <span class=s>&#34;] in &#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=n>LogTime</span><span class=o>.</span><span class=na>getElapsedMillis</span><span class=o>(</span><span class=n>startTime</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34; ms&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>// 尝试调用各个listener的onResourceReady回调进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=o>:</span> <span class=n>requestListeners</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>            <span class=n>listener</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>model</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果没有一个回调能够处理，那么自己处理
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// animationFactory默认为NoTransition.getFactory()，生成的animation为NO_ANIMATION
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>animation</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>animationFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>dataSource</span><span class=o>,</span> <span class=n>isFirstResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// target为DrawableImageViewTarget
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>target</span><span class=o>.</span><span class=na>onResourceReady</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>animation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 通知requestCoordinator
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>notifyLoadSuccess</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其处理过程和 onLoadFailed() 方法非常类似。</p><p>DrawableImageViewTarget 的基类 ImageViewTarget 实现了此方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ImageViewTarget.java
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=o>(</span><span class=nd>@NonNull</span> <span class=n>Z</span> <span class=n>resource</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=n>transition</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// NO_ANIMATION.transition返回false，所以直接调用setResourceInternal方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>transition</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>transition</span><span class=o>.</span><span class=na>transition</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=k>this</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>setResourceInternal</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>maybeUpdateAnimatable</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>setResourceInternal</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Order matters here. Set the resource first to make sure that the Drawable has a valid and
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// non-null Callback before starting it.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 先设置图片
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>setResource</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 然后如果是动画，会执行动画
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>maybeUpdateAnimatable</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>maybeUpdateAnimatable</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// BitmapDrawable显然不是一个Animatable对象，所以走else分支
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Animatable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>animatable</span> <span class=o>=</span> <span class=o>(</span><span class=n>Animatable</span><span class=o>)</span> <span class=n>resource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>animatable</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>animatable</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DrawableImageViewTarget
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>setResource</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>view</span><span class=o>.</span><span class=na>setImageDrawable</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>OK，至此网络图片已经通过 view.setImageDrawable(resource) 加载完毕。</p><p>最后，回到 DecodeJob.notifyEncodeAndRelease() 方法，notifyComplete() 被调用后，会判断 deferredEncodeManager.hasResourceToEncode()，如果为 true 则会调用 deferredEncodeManager.encode() 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>DeferredEncodeManager</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Key</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>toEncode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl>  <span class=n>DeferredEncodeManager</span><span class=o>()</span> <span class=o>{</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// We just need the encoder and resource type to match, which this will enforce.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>init</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=o>,</span> <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>toEncode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>encoder</span> <span class=o>=</span> <span class=o>(</span><span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;)</span> <span class=n>encoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>toEncode</span> <span class=o>=</span> <span class=o>(</span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;)</span> <span class=n>toEncode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>encode</span><span class=o>(</span><span class=n>DiskCacheProvider</span> <span class=n>diskCacheProvider</span><span class=o>,</span> <span class=n>Options</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>GlideTrace</span><span class=o>.</span><span class=na>beginSection</span><span class=o>(</span><span class=s>&#34;DecodeJob.encode&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>diskCacheProvider</span><span class=o>.</span><span class=na>getDiskCache</span><span class=o>().</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;(</span><span class=n>encoder</span><span class=o>,</span> <span class=n>toEncode</span><span class=o>,</span> <span class=n>options</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>toEncode</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>GlideTrace</span><span class=o>.</span><span class=na>endSection</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=nf>hasResourceToEncode</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>toEncode</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>clear</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>toEncode</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DiskLruCacheWrapper 在写入的时候会使用到写锁 DiskCacheWriteLocker，锁对象由对象池创建，写锁 WriteLock 实现是一个重入锁 ReentrantLock，该锁默认是一个不公平锁。</p><p>在缓存写入前，会判断 key 对应的 value 存不存在，若存在则放弃写入。缓存的真正写入会由 DataCacheWriter 交给 ByteBufferEncoder 和 StreamEncoder 两个具体类来写入，前者负责将 ByteBuffe 写入到文件，后者负责将 InputStream 写入到文件。</p><p>至此，磁盘缓存的读写都已经完毕，剩下的就是内存缓存的两个层次了。回到 DecodeJob.notifyEncodeAndRelease 方法中，经过 notifyComplete、EngineJob.onResourceReady、notifyCallbacksOfResult 方法中。</p><p>在该方法中一方面会将原始的 resource 包装成一个 EngineResource，然后通过回调传给 Engine.onEngineJobComplete()，在这里会将资源保持在 ActiveResource 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onEngineJobComplete</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>engineJob</span><span class=o>,</span> <span class=n>Key</span> <span class=n>key</span><span class=o>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// A null resource indicates that the load failed, usually due to an exception.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>resource</span><span class=o>.</span><span class=na>setResourceListener</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>isCacheable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>activeResources</span><span class=o>.</span><span class=na>activate</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>jobs</span><span class=o>.</span><span class=na>removeIfCurrent</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>engineJob</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>另一方面会使用 Executors.mainThreadExecutor() 调用 SingleRequest.onResourceReady() 回调进行资源的显示。</p><p>在触发回调前后各有一个地方会对 engineResource 进行 acquire() 和 release() 操作。该过程发生在 notifyCallbacksOfResult() 方法的 incrementPendingCallbacks()、decrementPendingCallbacks() 调用中。这一顿操作下来，engineResource 的引用计数应该是 1：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Synthetic</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>notifyCallbacksOfResult</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ResourceCallbacksAndExecutors</span> <span class=n>copy</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Key</span> <span class=n>localKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>localResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>engineResource</span> <span class=o>=</span> <span class=n>engineResourceFactory</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>resource</span><span class=o>,</span> <span class=n>isCacheable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// a lock here so that any newly added callback that executes before the next locked section
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// below can&#39;t recycle the resource before we call the callbacks.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>hasResource</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>copy</span> <span class=o>=</span> <span class=n>cbs</span><span class=o>.</span><span class=na>copy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>incrementPendingCallbacks</span><span class=o>(</span><span class=n>copy</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>localKey</span> <span class=o>=</span> <span class=n>key</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>localResource</span> <span class=o>=</span> <span class=n>engineResource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>listener</span><span class=o>.</span><span class=na>onEngineJobComplete</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>localKey</span><span class=o>,</span> <span class=n>localResource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kd>final</span> <span class=n>ResourceCallbackAndExecutor</span> <span class=n>entry</span> <span class=o>:</span> <span class=n>copy</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>entry</span><span class=o>.</span><span class=na>executor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>CallResourceReady</span><span class=o>(</span><span class=n>entry</span><span class=o>.</span><span class=na>cb</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>decrementPendingCallbacks</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>incrementPendingCallbacks</span><span class=o>(</span><span class=kt>int</span> <span class=n>count</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>pendingCallbacks</span><span class=o>.</span><span class=na>getAndAdd</span><span class=o>(</span><span class=n>count</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=n>engineResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>engineResource</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>decrementPendingCallbacks</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>decremented</span> <span class=o>=</span> <span class=n>pendingCallbacks</span><span class=o>.</span><span class=na>decrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>decremented</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>engineResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>engineResource</span><span class=o>.</span><span class=na>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>engineResource 的引用计数会在 RequestManager.onDestory() 方法中经过 clear()、untrackOrDelegate()、untrack()、RequestTracker.clearRemoveAndRecycle()、clearRemoveAndMaybeRecycle() 方法，调用 SingleRequest.clear() 方法经过 releaseResource()、Engine.release()，进行释放。这样引用计数就为 0 了。</p><p>前面在看 EngineResource 的代码时我们知道，一旦引用计数为 0，就会通知 Engine 将此资源从 active 状态变成 memory cache 状态。如果我们再次加载资源时可以从 memory cache 中加载，那么资源又会从 memory cache 状态变成 active 状态。</p><p>也就是说，在资源第一次显示后，我们关闭页面，资源会由 active 变成 memory cache；然后我们再次进入页面，加载时会命中 memory cache，从而又变成 active 状态。</p><p>本章 Glide 缓存机制的源码内容到此为止了，现在看看文章最开始的流程图，是不是有一点点熟悉的味道。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034514.png width=auto alt></p><p>DecodeJob.onDataFetcherReady 该方法完成两个事情：</p><ol><li>将比较原始的 data 数据转变为可以供 ImageView 显示的 resource 数据</li><li>将 resource 数据显示出来</li></ol><p>在过程 1 中，将原始 data encode 成 resource 数据后，会调用 DecodeJob.onResourceDecoded 对 resource 数据进行进一步的处理。DecodeJob.onResourceDecoded 首先会对 resource 进行 transform，然后可能会进行磁盘缓存。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034509.png width=auto alt></p><a href=#面试题><h1 id=面试题><span class=hanchor arialabel=Anchor># </span>面试题</h1></a><p>内存缓存分两个原因：</p><p>1、活动缓存主要是当前正在使用的图片资源。图片资源存放在弱引用中。下面是只用活动缓存的缺点</p><p>场景：上下滑动列表，图片会不断创建，当 GC 来临时候，会将当前不使用的图片资源进行回收，由于存放在弱引用中。这样就会导致下次滑动回来还需要加载到内存中。</p><p>2、Lru 缓存主要存放：最近被加载过的资源。下面是只用 Lru 的缺点</p><p>场景：滑动列表头部头像不动，列表不断滑动，由于 Lru 的机制缓存到达一定大小，可能会将头部图片资源回收。</p><p>3、配合使用，两者互斥存在。当资源正在使用的时候放在活动缓存中，当不使用的时候放在 Lru 中（引用为 0 的时候）。so,两者结合性能最佳</p><p>磁盘缓存分两个原因：
1、资源缓存主要是变换后的资源
2、原始缓存是原始的资源文件</p><p>场景：同一张图片，先在 100<em>100 的 view 上显示，然后在 200</em>200 的 view 上显示。
分析：如果不缓存变换后的图，那么每次都需要变换。如果不缓存原图，那么每次都需要重新网络下载原图</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>