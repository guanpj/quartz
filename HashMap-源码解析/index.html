<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="前言 HashMap 是 Java 中最常用 K-V 容器，使用哈希值来确定元素存储的位置，HashMap 对 Entry 进行了扩展（Node），使其形成以链表或者树的形式存储在 HashMap 的容器里。
在 Java 8 之前和之后，HashMap 的实现有较大的不同，因此对于 put 流程、扩容机制等主要过程分析将会采用两个版本进行对比。
成员变量 HashMap 成员变量和构造方法声明如下（Java 7 和 8 大致相同，以下为 Java 8 版本）："><meta property="og:title" content="HashMap 源码解析"><meta property="og:description" content="前言 HashMap 是 Java 中最常用 K-V 容器，使用哈希值来确定元素存储的位置，HashMap 对 Entry 进行了扩展（Node），使其形成以链表或者树的形式存储在 HashMap 的容器里。
在 Java 8 之前和之后，HashMap 的实现有较大的不同，因此对于 put 流程、扩容机制等主要过程分析将会采用两个版本进行对比。
成员变量 HashMap 成员变量和构造方法声明如下（Java 7 和 8 大致相同，以下为 Java 8 版本）："><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="HashMap 源码解析"><meta name=twitter:description content="前言 HashMap 是 Java 中最常用 K-V 容器，使用哈希值来确定元素存储的位置，HashMap 对 Entry 进行了扩展（Node），使其形成以链表或者树的形式存储在 HashMap 的容器里。
在 Java 8 之前和之后，HashMap 的实现有较大的不同，因此对于 put 流程、扩容机制等主要过程分析将会采用两个版本进行对比。
成员变量 HashMap 成员变量和构造方法声明如下（Java 7 和 8 大致相同，以下为 Java 8 版本）："><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>HashMap 源码解析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.0452046239b15cdfa822e3a8fa41b16d.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.cf6439e057b2800c40a018b5e420d51c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.096017a54b289f29dbbc214dcf7d122d.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>HashMap 源码解析</h1><p class=meta>Last updated
Mar 22, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/HashMap/>Hash map</a></li><li><a href=https://www.guanpj.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>源码解析</a></li><li><a href=https://www.guanpj.top/tags/Java/>Java</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#前言>前言</a></li><li><a href=#成员变量>成员变量</a></li><li><a href=#数据结构>数据结构</a></li><li><a href=#put-流程分析>put 流程分析</a><ol><li><a href=#java-7-put-流程>Java 7 put 流程</a><ol><li><a href=#代码分析>代码分析</a></li><li><a href=#流程图示>流程图示</a></li></ol></li><li><a href=#java-8-put-流程>Java 8 put 流程</a><ol><li><a href=#代码分析-1>代码分析</a><ol><li><a href=#流程图示-1>流程图示</a></li></ol></li></ol></li></ol></li><li><a href=#hash-计算与元素位置确定>hash 计算与元素位置确定</a><ol><li><a href=#java-7>Java 7</a></li><li><a href=#java-8>Java 8</a></li></ol></li><li><a href=#扩容流程>扩容流程</a><ol><li><a href=#java-7-扩容流程>Java 7 扩容流程</a><ol><li><a href=#代码分析-2>代码分析</a></li><li><a href=#扩容流程在多线程环境下的隐患>扩容流程在多线程环境下的隐患</a></li></ol></li><li><a href=#java-8-扩容流程>Java 8 扩容流程</a><ol><li><a href=#代码分析-3>代码分析</a></li></ol></li><li><a href=#扩容流程对比>扩容流程对比</a></li></ol></li><li><a href=#get-流程分析>get 流程分析</a><ol><li><a href=#java-7-1>Java 7</a></li><li><a href=#java-8-1>Java 8</a></li></ol></li><li><a href=#面试题>面试题</a><ol><li><a href=#为什么-hashmap-数组长度为-2-的幂次方>为什么 HashMap 数组长度为 2 的幂次方？</a></li><li><a href=#hash-冲突有哪些解决方法hashmap-是怎样解决的>hash 冲突有哪些解决方法？HashMap 是怎样解决的？</a></li><li><a href=#hashmap-会造成哪些安全问题怎么解决>HashMap 会造成哪些安全问题？怎么解决？</a></li><li><a href=#使用对象作为-hashmap-的-key-应该注意什么>使用对象作为 HashMap 的 key 应该注意什么？</a></li></ol></li></ol></nav></details></aside><a href=#前言><h1 id=前言><span class=hanchor arialabel=Anchor># </span>前言</h1></a><p>HashMap 是 Java 中最常用 K-V 容器，使用哈希值来确定元素存储的位置，HashMap 对 Entry 进行了扩展（Node），使其形成以链表或者树的形式存储在 HashMap 的容器里。</p><p>在 Java 8 之前和之后，HashMap 的实现有较大的不同，因此对于 put 流程、扩容机制等主要过程分析将会采用两个版本进行对比。</p><a href=#成员变量><h1 id=成员变量><span class=hanchor arialabel=Anchor># </span>成员变量</h1></a><p>HashMap 成员变量和构造方法声明如下（Java 7 和 8 大致相同，以下为 Java 8 版本）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>AbstractMap</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>implements</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;,</span> <span class=n>Cloneable</span><span class=o>,</span> <span class=n>Serializable</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始容量 16  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>DEFAULT_INITIAL_CAPACITY</span> <span class=o>=</span> <span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>4</span><span class=o>;</span> <span class=c1>// aka 16  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 最大容量，该数组最大值为2^31一次方。  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MAXIMUM_CAPACITY</span> <span class=o>=</span> <span class=n>1</span> <span class=o>&lt;&lt;</span> <span class=n>30</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 默认的加载因子，如果构造的时候不传则为 0.75  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>float</span> <span class=n>DEFAULT_LOAD_FACTOR</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=na>75f</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// @1.8：数组某个位置下的 node 链表转化为红黑树对该链表的最小长度要求  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>TREEIFY_THRESHOLD</span> <span class=o>=</span> <span class=n>8</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// @1.8：当一个反树化的阈值，当这个 node 长度减少到该值就会从树转化成链表  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>UNTREEIFY_THRESHOLD</span> <span class=o>=</span> <span class=n>6</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// @1.8：数组某个位置下的 node 链表转化为红黑树对元素个数的最小要求  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MIN_TREEIFY_CAPACITY</span> <span class=o>=</span> <span class=n>64</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 具体存放数据的数组  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>transient</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[]</span> <span class=n>table</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// entrySet，一个存放 k-v 缓冲区  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>transient</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;&gt;</span> <span class=n>entrySet</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 存放键值对的个数。  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>transient</span> <span class=kt>int</span> <span class=n>size</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 记录更改 map 结构次数(添加、删除、扩容？)  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>transient</span> <span class=kt>int</span> <span class=n>modCount</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 临界值，当实际大小(容量*填充因子)超过临界值时，会进行扩容  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>threshold</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 填充因子  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>float</span> <span class=n>loadFactor</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 指定初始容量  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=nf>HashMap</span><span class=o>(</span><span class=kt>int</span> <span class=n>initialCapacity</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>(</span><span class=n>initialCapacity</span><span class=o>,</span> <span class=n>DEFAULT_LOAD_FACTOR</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 默认构造函数  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=nf>HashMap</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 默认 threshold 在首次 put 时才复制，Java 7 则是调用  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// this(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR)  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=o>.</span><span class=na>loadFactor</span> <span class=o>=</span> <span class=n>DEFAULT_LOAD_FACTOR</span><span class=o>;</span>   
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 包含另一个 Map  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=nf>HashMap</span><span class=o>(</span><span class=n>Map</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>K</span><span class=o>,</span> <span class=o>?</span> <span class=kd>extends</span> <span class=n>V</span><span class=o>&gt;</span> <span class=n>m</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>loadFactor</span> <span class=o>=</span> <span class=n>DEFAULT_LOAD_FACTOR</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=n>putMapEntries</span><span class=o>(</span><span class=n>m</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 指定初始容量和填充因子  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=nf>HashMap</span><span class=o>(</span><span class=kt>int</span> <span class=n>initialCapacity</span><span class=o>,</span> <span class=kt>float</span> <span class=n>loadFactor</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>initialCapacity</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=c1>// 容量不能为负数  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Illegal initial capacity: &#34;</span> <span class=o>+</span> <span class=n>initialCapacity</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// 当容量大于 2^31 就取最大值 1&lt;&lt;30;   
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>initialCapacity</span> <span class=o>&gt;</span> <span class=n>MAXIMUM_CAPACITY</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=n>initialCapacity</span> <span class=o>=</span> <span class=n>MAXIMUM_CAPACITY</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>loadFactor</span> <span class=o>&lt;=</span> <span class=n>0</span> <span class=o>||</span> <span class=n>Float</span><span class=o>.</span><span class=na>isNaN</span><span class=o>(</span><span class=n>loadFactor</span><span class=o>))</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Illegal load factor: &#34;</span>                <span class=o>+</span> <span class=n>loadFactor</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>loadFactor</span> <span class=o>=</span> <span class=n>loadFactor</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// tableSizeFor 保证了数组长度一定是 2 的幂次方，是大于等于    initialCapacity 最接近的值。  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 这里使用 threshold 暂时保存计算后的 initialCapacity 值  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=o>.</span><span class=na>threshold</span> <span class=o>=</span> <span class=n>tableSizeFor</span><span class=o>(</span><span class=n>initialCapacity</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>...</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><a href=#数据结构><h1 id=数据结构><span class=hanchor arialabel=Anchor># </span>数据结构</h1></a><p>Java 7 采用数组 + 链表方式进行存储，元素类型为 Entry：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>K</span> <span class=n>key</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>V</span> <span class=n>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>next</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>hash</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><p>元素的存储结构如下：<br><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_035018.png width=auto alt>
Java 8 开始，采用数组 + 链表 + 红黑树方式进行存储，元素类型为 Node 和 TreeNode：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>class</span> <span class=nc>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>hash</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>K</span> <span class=n>key</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>V</span> <span class=n>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>next</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>LinkedHashMap</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>parent</span><span class=o>;</span>  <span class=c1>// red-black tree links  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>    <span class=n>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>left</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>right</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>prev</span><span class=o>;</span>    <span class=c1>// needed to unlink next upon deletion  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>red</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><p>元素的存储结构如下：
<img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_041741.png width=auto alt></p><a href=#put-流程分析><h1 id=put-流程分析><span class=hanchor arialabel=Anchor># </span>put 流程分析</h1></a><a href=#java-7-put-流程><h2 id=java-7-put-流程><span class=hanchor arialabel=Anchor># </span>Java 7 put 流程</h2></a><a href=#代码分析><h3 id=代码分析><span class=hanchor arialabel=Anchor># </span>代码分析</h3></a><p>Java 7 put 流程主要方法源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>V</span> <span class=nf>put</span><span class=o>(</span><span class=n>K</span> <span class=n>key</span><span class=o>,</span> <span class=n>V</span> <span class=n>value</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>table</span> <span class=o>==</span> <span class=n>EMPTY_TABLE</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 初始化 table  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>inflateTable</span><span class=o>(</span><span class=n>threshold</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>key</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 在 table[0] 处插入 key 为 null 元素并返回  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>putForNullKey</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 先进行一次 hash 计算     
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>hash</span> <span class=o>=</span> <span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 根据 hash 值计算 table 下标  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>indexFor</span><span class=o>(</span><span class=n>hash</span><span class=o>,</span> <span class=n>table</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 遍历 table[i] 处的链表  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span> <span class=o>=</span> <span class=n>table</span><span class=o>[</span><span class=n>i</span><span class=o>];</span> <span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span> <span class=n>e</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>next</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>k</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// hash 一样且 key 相等或者 equals 方法返回 true 才进行替换  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>hash</span> <span class=o>==</span> <span class=n>hash</span> <span class=o>&amp;&amp;</span> <span class=o>((</span><span class=n>k</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>key</span><span class=o>)</span> <span class=o>==</span> <span class=n>key</span> <span class=o>||</span> <span class=n>key</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>k</span><span class=o>)))</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>V</span> <span class=n>oldValue</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>recordAccess</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>oldValue</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 出循环意味着 table[i] 这条链表没有此元素  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 更新 modCount  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>modCount</span><span class=o>++;</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 插入新元素  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>addEntry</span><span class=o>(</span><span class=n>hash</span><span class=o>,</span> <span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=n>i</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>inflateTable</span><span class=o>(</span><span class=kt>int</span> <span class=n>toSize</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 获取大于  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>capacity</span> <span class=o>=</span> <span class=n>roundUpToPowerOf2</span><span class=o>(</span><span class=n>toSize</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 重新计算阈值  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>threshold</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>capacity</span> <span class=o>*</span> <span class=n>loadFactor</span><span class=o>,</span>   
</span></span><span class=line><span class=cl>            <span class=n>MAXIMUM_CAPACITY</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 创建数组  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>table</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>[</span><span class=n>capacity</span><span class=o>];</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 根据配置判断是否初始化 hashSeed  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>initHashSeedAsNeeded</span><span class=o>(</span><span class=n>capacity</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>V</span> <span class=nf>putForNullKey</span><span class=o>(</span><span class=n>V</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 最多循环一次，因为这个位置最多只有一个元素  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span> <span class=o>=</span> <span class=n>table</span><span class=o>[</span><span class=n>0</span><span class=o>];</span> <span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span> <span class=n>e</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>next</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// key 为 null 直接替换  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>key</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>V</span> <span class=n>oldValue</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>recordAccess</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>oldValue</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 更新 modCount  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>modCount</span><span class=o>++;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 在 table[0] 处插入元素  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>addEntry</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addEntry</span><span class=o>(</span><span class=kt>int</span> <span class=n>hash</span><span class=o>,</span> <span class=n>K</span> <span class=n>key</span><span class=o>,</span> <span class=n>V</span> <span class=n>value</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bucketIndex</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 元素数量达到临界值且 table[bucketIndex] 位置不为空才进行扩容  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>((</span><span class=n>size</span> <span class=o>&gt;=</span> <span class=n>threshold</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=kc>null</span> <span class=o>!=</span> <span class=n>table</span><span class=o>[</span><span class=n>bucketIndex</span><span class=o>]))</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 两倍容量  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>resize</span><span class=o>(</span><span class=n>2</span> <span class=o>*</span> <span class=n>table</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// 重新计算 hash  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>hash</span> <span class=o>=</span> <span class=o>(</span><span class=kc>null</span> <span class=o>!=</span> <span class=n>key</span><span class=o>)</span> <span class=o>?</span> <span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>)</span> <span class=o>:</span> <span class=n>0</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// 重新确定数组下标  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>bucketIndex</span> <span class=o>=</span> <span class=n>indexFor</span><span class=o>(</span><span class=n>hash</span><span class=o>,</span> <span class=n>table</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建并插入新元素  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>createEntry</span><span class=o>(</span><span class=n>hash</span><span class=o>,</span> <span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=n>bucketIndex</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// 在链表头部插入新元素  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>createEntry</span><span class=o>(</span><span class=kt>int</span> <span class=n>hash</span><span class=o>,</span> <span class=n>K</span> <span class=n>key</span><span class=o>,</span> <span class=n>V</span> <span class=n>value</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bucketIndex</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 保存原头结点  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span> <span class=o>=</span> <span class=n>table</span><span class=o>[</span><span class=n>bucketIndex</span><span class=o>];</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 创建新元素、把 next 指向头节点，并替换原来 bucketIndex 位置的链表  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>table</span><span class=o>[</span><span class=n>bucketIndex</span><span class=o>]</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>&lt;&gt;(</span><span class=n>hash</span><span class=o>,</span> <span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 元素数量++  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>size</span><span class=o>++</span><span class=err>；</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><a href=#流程图示><h3 id=流程图示><span class=hanchor arialabel=Anchor># </span>流程图示</h3></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_040358.png width=auto alt></p><a href=#java-8-put-流程><h2 id=java-8-put-流程><span class=hanchor arialabel=Anchor># </span>Java 8 put 流程</h2></a><a href=#代码分析-1><h3 id=代码分析-1><span class=hanchor arialabel=Anchor># </span>代码分析</h3></a><p>Java 8 put 流程主要方法源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>V</span> <span class=nf>put</span><span class=o>(</span><span class=n>K</span> <span class=n>key</span><span class=o>,</span> <span class=n>V</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>      <span class=c1>// onlyIfAbsent 默认为 false，即元素存在时进行替换  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>putVal</span><span class=o>(</span><span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>),</span> <span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=n>V</span> <span class=nf>putVal</span><span class=o>(</span><span class=kt>int</span> <span class=n>hash</span><span class=o>,</span> <span class=n>K</span> <span class=n>key</span><span class=o>,</span> <span class=n>V</span> <span class=n>value</span><span class=o>,</span>   
</span></span><span class=line><span class=cl>          <span class=kt>boolean</span> <span class=n>onlyIfAbsent</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>evict</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[]</span> <span class=n>tab</span><span class=o>;</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>p</span><span class=o>;</span> <span class=kt>int</span> <span class=n>n</span><span class=o>,</span> <span class=n>i</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// table 未初始化或者长度为 0，进行扩容  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>((</span><span class=n>tab</span> <span class=o>=</span> <span class=n>table</span><span class=o>)</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>(</span><span class=n>n</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>=</span> <span class=o>(</span><span class=n>tab</span> <span class=o>=</span> <span class=n>resize</span><span class=o>()).</span><span class=na>length</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// (n - 1) &amp; hash 确定元素存放位置，位置为空则直接放入该位置  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>((</span><span class=n>p</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>i</span> <span class=o>=</span> <span class=o>(</span><span class=n>n</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>&amp;</span> <span class=n>hash</span><span class=o>])</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>        <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>newNode</span><span class=o>(</span><span class=n>hash</span><span class=o>,</span> <span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 数组对应位置已经存在元素  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>;</span> <span class=n>K</span> <span class=n>k</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// 比较数组中第一个元素  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>p</span><span class=o>.</span><span class=na>hash</span> <span class=o>==</span> <span class=n>hash</span> <span class=o>&amp;&amp;</span>  
</span></span><span class=line><span class=cl>            <span class=o>((</span><span class=n>k</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>key</span><span class=o>)</span> <span class=o>==</span> <span class=n>key</span> <span class=o>||</span> <span class=o>(</span><span class=n>key</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>key</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>k</span><span class=o>))))</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                <span class=c1>// 将第一个元素赋值给 e  
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>e</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 是否为红黑树结点  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>p</span> <span class=k>instanceof</span> <span class=n>TreeNode</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>            <span class=c1>// 放入树中  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>e</span> <span class=o>=</span> <span class=o>((</span><span class=n>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;)</span><span class=n>p</span><span class=o>).</span><span class=na>putTreeVal</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>tab</span><span class=o>,</span>   
</span></span><span class=line><span class=cl>                        <span class=n>hash</span><span class=o>,</span> <span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 链表结点  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=c1>// 遍历链表  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>binCount</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=o>;</span> <span class=o>++</span><span class=n>binCount</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=c1>// 到达链表的尾部，说明没有找到相等的 key  
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>next</span><span class=o>)</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                    <span class=c1>// 在尾部插入新结点  
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>p</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>newNode</span><span class=o>(</span><span class=n>hash</span><span class=o>,</span> <span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                    <span class=c1>// 判断结点数量是否达到阈值(TREEIFY_THRESHOLD 默认为 8)  
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>binCount</span> <span class=o>&gt;=</span> <span class=n>TREEIFY_THRESHOLD</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                        <span class=c1>// 根据数组长度决定是否树化  
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>treeifyBin</span><span class=o>(</span><span class=n>tab</span><span class=o>,</span> <span class=n>hash</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                    <span class=c1>// 跳出循环  
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>break</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                <span class=c1>// 判断链表中结点的 key 值是否与插入的 key 相等  
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>hash</span> <span class=o>==</span> <span class=n>hash</span> <span class=o>&amp;&amp;</span>  
</span></span><span class=line><span class=cl>                    <span class=o>((</span><span class=n>k</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>key</span><span class=o>)</span> <span class=o>==</span> <span class=n>key</span> <span class=o>||</span>   
</span></span><span class=line><span class=cl>                          <span class=o>(</span><span class=n>key</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>key</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>k</span><span class=o>))))</span>  
</span></span><span class=line><span class=cl>                    <span class=c1>// key 相等，跳出循环，此时 e 就是目标结点  
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>break</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                <span class=c1>// 与前面的 e = p.next 组合遍历链表  
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>p</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// 找到 key 值相等的目标结点  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=n>V</span> <span class=n>oldValue</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=c1>// onlyIfAbsent 为 false 或者目标接点值为 null  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(!</span><span class=n>onlyIfAbsent</span> <span class=o>||</span> <span class=n>oldValue</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                <span class=c1>//用新值替换旧值  
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>e</span><span class=o>.</span><span class=na>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=c1>// 空实现，用于访问后回调给子类，如 LinkedHashMap  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>afterNodeAccess</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=c1>// 返回旧值  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=n>oldValue</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 结构修改，更新 modCount  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>++</span><span class=n>modCount</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 实际大小大于阈值则扩容  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(++</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>threshold</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>        <span class=n>resize</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 插入后回调  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>afterNodeInsertion</span><span class=o>(</span><span class=n>evict</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><a href=#流程图示-1><h4 id=流程图示-1><span class=hanchor arialabel=Anchor># </span>流程图示</h4></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_040522.png width=auto alt></p><a href=#hash-计算与元素位置确定><h1 id=hash-计算与元素位置确定><span class=hanchor arialabel=Anchor># </span>hash 计算与元素位置确定</h1></a><a href=#java-7><h2 id=java-7><span class=hanchor arialabel=Anchor># </span>Java 7</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>hash</span> <span class=o>=</span> <span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>indexFor</span><span class=o>(</span><span class=n>hash</span><span class=o>,</span> <span class=n>table</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=kt>int</span> <span class=nf>hash</span><span class=o>(</span><span class=n>Object</span> <span class=n>k</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 默认为 0，初始化方法见后文  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=n>hashSeed</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 如果 hashSeed 不为零且 key 是 String 类型  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>0</span> <span class=o>!=</span> <span class=n>h</span> <span class=o>&amp;&amp;</span> <span class=n>k</span> <span class=k>instanceof</span> <span class=n>String</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 返回特定 hash 值  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>sun</span><span class=o>.</span><span class=na>misc</span><span class=o>.</span><span class=na>Hashing</span><span class=o>.</span><span class=na>stringHash32</span><span class=o>((</span><span class=n>String</span><span class=o>)</span> <span class=n>k</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>^=</span> <span class=n>k</span><span class=o>.</span><span class=na>hashCode</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 多次异或  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>h</span> <span class=o>^=</span> <span class=o>(</span><span class=n>h</span> <span class=o>&gt;&gt;&gt;</span> <span class=n>20</span><span class=o>)</span> <span class=o>^</span> <span class=o>(</span><span class=n>h</span> <span class=o>&gt;&gt;&gt;</span> <span class=n>12</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>h</span> <span class=o>^</span> <span class=o>(</span><span class=n>h</span> <span class=o>&gt;&gt;&gt;</span> <span class=n>7</span><span class=o>)</span> <span class=o>^</span> <span class=o>(</span><span class=n>h</span> <span class=o>&gt;&gt;&gt;</span> <span class=n>4</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>static</span> <span class=kt>int</span> <span class=nf>indexFor</span><span class=o>(</span><span class=kt>int</span> <span class=n>h</span><span class=o>,</span> <span class=kt>int</span> <span class=n>length</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// assert Integer.bitCount(length) == 1 : &#34;length must be a non-zero power of 2&#34;;  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>h</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>length</span><span class=o>-</span><span class=n>1</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><a href=#java-8><h2 id=java-8><span class=hanchor arialabel=Anchor># </span>Java 8</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>V</span> <span class=nf>put</span><span class=o>(</span><span class=n>K</span> <span class=n>key</span><span class=o>,</span> <span class=n>V</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>putVal</span><span class=o>(</span><span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>),</span> <span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>hash</span><span class=o>(</span><span class=n>Object</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>h</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 让高 16 位和低 16 位异或  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>(</span><span class=n>key</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>?</span> <span class=n>0</span> <span class=o>:</span> <span class=o>(</span><span class=n>h</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=na>hashCode</span><span class=o>())</span> <span class=o>^</span> <span class=o>(</span><span class=n>h</span> <span class=o>&gt;&gt;&gt;</span> <span class=n>16</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>index</span> <span class=o>=</span> <span class=o>(</span><span class=n>n</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>&amp;</span> <span class=n>hash</span><span class=o>]</span><span class=err>；</span>  
</span></span></code></pre></td></tr></table></div></div><a href=#扩容流程><h1 id=扩容流程><span class=hanchor arialabel=Anchor># </span>扩容流程</h1></a><p>扩容过程涉及到 rehash、复制数据等操作，非常消耗性能。</p><p>和扩容相关的全局变量及其含义：</p><table><thead><tr><th>全局变量   </th><th>含义                                                                                                                                                                                                                                                                                                                                                                                                      </th></tr></thead><tbody><tr><td>capacity   </td><td>table 的容量大小，默认为 16。需要注意的是 capacity 必须保证为 2 的 n 次方。                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td>size       </td><td>存放键值对数量。                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td>threshold  </td><td>size 的临界值，当 size 大于等于 threshold 就必须进行扩容操作。threshold = (int) (capacity * loadFactor)                                                                                                                                                                                                                                                                                                   </td></tr><tr><td>loadFactor</td><td>填充因子，table 能够使用的比例。loadFactor 能够控制数组存放数据的疏密程度，loadFactor 越趋近于 1，那么数组中存放的数据(entry)也就越多，也就越密，也就是会让链表的长度增加，loadFactor 越小，也就是趋近于 0，数组中存放的数据(entry)也就越少，也就越稀疏。<br>loadFactor 太大导致查找元素效率低，太小导致数组的利用率低，存放的数据会很分散。loadFactor 的默认值为 0.75f 是官方给出的一个比较好的临界值。</td></tr></tbody></table><a href=#java-7-扩容流程><h2 id=java-7-扩容流程><span class=hanchor arialabel=Anchor># </span>Java 7 扩容流程</h2></a><a href=#代码分析-2><h3 id=代码分析-2><span class=hanchor arialabel=Anchor># </span>代码分析</h3></a><p>Java 7 的 resize 方法相关代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>resize</span><span class=o>(</span><span class=kt>int</span> <span class=n>newCapacity</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>[]</span> <span class=n>oldTable</span> <span class=o>=</span> <span class=n>table</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 记录旧容量  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>oldCapacity</span> <span class=o>=</span> <span class=n>oldTable</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 如果容量已达到上限，则扩容阈值设置成不可能达到的最大值，即后续不再扩容  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>oldCapacity</span> <span class=o>==</span> <span class=n>MAXIMUM_CAPACITY</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>threshold</span> <span class=o>=</span> <span class=n>Integer</span><span class=o>.</span><span class=na>MAX_VALUE</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 根据新容量创建出新数组  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Entry</span><span class=o>[]</span> <span class=n>newTable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>[</span><span class=n>newCapacity</span><span class=o>];</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 将旧数组的节点转移到新数组  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>transfer</span><span class=o>(</span><span class=n>newTable</span><span class=o>,</span> <span class=n>initHashSeedAsNeeded</span><span class=o>(</span><span class=n>newCapacity</span><span class=o>));</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 新旧易主  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>table</span> <span class=o>=</span> <span class=n>newTable</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 根据新容量重新确定新阈值  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>threshold</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span><span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>newCapacity</span> <span class=o>*</span> <span class=n>loadFactor</span><span class=o>,</span> <span class=n>MAXIMUM_CAPACITY</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// 从配置中获取是否启用备用 hash，用于减少字符串 hash 冲突  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>initHashSeedAsNeeded</span><span class=o>(</span><span class=kt>int</span> <span class=n>capacity</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 是否已经启用备用 hash  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>currentAltHashing</span> <span class=o>=</span> <span class=n>hashSeed</span> <span class=o>!=</span> <span class=n>0</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 虚拟机已经启动且数组容量大于 ALTERNATIVE_HASHING_THRESHOLD  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>useAltHashing</span> <span class=o>=</span> <span class=n>sun</span><span class=o>.</span><span class=na>misc</span><span class=o>.</span><span class=na>VM</span><span class=o>.</span><span class=na>isBooted</span><span class=o>()</span> <span class=o>&amp;&amp;</span>  
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>capacity</span> <span class=o>&gt;=</span> <span class=n>Holder</span><span class=o>.</span><span class=na>ALTERNATIVE_HASHING_THRESHOLD</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 异或操作判断是否切换  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>switching</span> <span class=o>=</span> <span class=n>currentAltHashing</span> <span class=o>^</span> <span class=n>useAltHashing</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>switching</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// useAltHashing 为 true 则 hashSeed 初始化为也给随机 hash 值  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>hashSeed</span> <span class=o>=</span> <span class=n>useAltHashing</span>  
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=n>sun</span><span class=o>.</span><span class=na>misc</span><span class=o>.</span><span class=na>Hashing</span><span class=o>.</span><span class=na>randomHashSeed</span><span class=o>(</span><span class=k>this</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>            <span class=o>:</span> <span class=n>0</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>switching</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>transfer</span><span class=o>(</span><span class=n>Entry</span><span class=o>[]</span> <span class=n>newTable</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>rehash</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>newCapacity</span> <span class=o>=</span> <span class=n>newTable</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 遍历旧数组  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span> <span class=o>:</span> <span class=n>table</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 遍历数组上的链表  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span><span class=o>(</span><span class=kc>null</span> <span class=o>!=</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=c1>// 记录下一个位置  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>next</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=c1>// 判断是否重新计算 hash 值  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>rehash</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>hash</span> <span class=o>=</span> <span class=kc>null</span> <span class=o>==</span> <span class=n>e</span><span class=o>.</span><span class=na>key</span> <span class=o>?</span> <span class=n>0</span> <span class=o>:</span> <span class=n>hash</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>key</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=c1>// 根据新容量重新计算位置  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>indexFor</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>hash</span><span class=o>,</span> <span class=n>newCapacity</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=c1>// 按旧链表的正序遍历链表、在新链表的头部依次插入  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 因此扩容后可能出现逆序  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>e</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>newTable</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=n>newTable</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=n>e</span> <span class=o>=</span> <span class=n>next</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><a href=#扩容流程在多线程环境下的隐患><h3 id=扩容流程在多线程环境下的隐患><span class=hanchor arialabel=Anchor># </span>扩容流程在多线程环境下的隐患</h3></a><p>在 resize 扩容过程中，在将旧数组上的数据转移到新数组上时，转移数据操作是按旧链表的正序遍历链表、在新链表的头部依次插入的。在多线程的环境下，由于这些操作不具有原子性和内存可见性，转移数据、扩容后，容易出现环形链表的情况。</p><a href=#java-8-扩容流程><h2 id=java-8-扩容流程><span class=hanchor arialabel=Anchor># </span>Java 8 扩容流程</h2></a><a href=#代码分析-3><h3 id=代码分析-3><span class=hanchor arialabel=Anchor># </span>代码分析</h3></a><p>Java 8 中的 resize 和 treeifyBin 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>treeifyBin</span><span class=o>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[]</span> <span class=n>tab</span><span class=o>,</span> <span class=kt>int</span> <span class=n>hash</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span><span class=o>,</span> <span class=n>index</span><span class=o>;</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 如果数组为空或者数组长度小于 64，则进行扩容  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>tab</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>(</span><span class=n>n</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>)</span> <span class=o>&lt;</span> <span class=n>MIN_TREEIFY_CAPACITY</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>        <span class=n>resize</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 根据 hash 获取数组下标，该位置有值再进行树化  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>index</span> <span class=o>=</span> <span class=o>(</span><span class=n>n</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>&amp;</span> <span class=n>hash</span><span class=o>])</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>hd</span> <span class=o>=</span> <span class=kc>null</span><span class=o>,</span> <span class=n>tl</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 遍历链表  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>do</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=c1>// Node 节点转换成 TreeNode 节点  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>p</span> <span class=o>=</span> <span class=n>replacementTreeNode</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>tl</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>                <span class=n>hd</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>.</span><span class=na>prev</span> <span class=o>=</span> <span class=n>tl</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                <span class=n>tl</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=n>tl</span> <span class=o>=</span> <span class=n>p</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>while</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>next</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>((</span><span class=n>tab</span><span class=o>[</span><span class=n>index</span><span class=o>]</span> <span class=o>=</span> <span class=n>hd</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>            <span class=n>hd</span><span class=o>.</span><span class=na>treeify</span><span class=o>(</span><span class=n>tab</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[]</span> <span class=nf>resize</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[]</span> <span class=n>oldTab</span> <span class=o>=</span> <span class=n>table</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>oldCap</span> <span class=o>=</span> <span class=o>(</span><span class=n>oldTab</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>?</span> <span class=n>0</span> <span class=o>:</span> <span class=n>oldTab</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>oldThr</span> <span class=o>=</span> <span class=n>threshold</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>newCap</span><span class=o>,</span> <span class=n>newThr</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>oldCap</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 超过最大值后续不再扩容  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>oldCap</span> <span class=o>&gt;=</span> <span class=n>MAXIMUM_CAPACITY</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>threshold</span> <span class=o>=</span> <span class=n>Integer</span><span class=o>.</span><span class=na>MAX_VALUE</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>oldTab</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// 否则扩充为原来的2倍  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>newCap</span> <span class=o>=</span> <span class=n>oldCap</span> <span class=o>&lt;&lt;</span> <span class=n>1</span><span class=o>)</span> <span class=o>&lt;</span> <span class=n>MAXIMUM_CAPACITY</span> <span class=o>&amp;&amp;</span> <span class=n>oldCap</span> <span class=o>&gt;=</span> <span class=n>DEFAULT_INITIAL_CAPACITY</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>            <span class=n>newThr</span> <span class=o>=</span> <span class=n>oldThr</span> <span class=o>&lt;&lt;</span> <span class=n>1</span><span class=o>;</span> <span class=c1>// double threshold  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>oldThr</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=c1>// initial capacity was placed in threshold  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>newCap</span> <span class=o>=</span> <span class=n>oldThr</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// signifies using defaults  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>newCap</span> <span class=o>=</span> <span class=n>DEFAULT_INITIAL_CAPACITY</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=n>newThr</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)(</span><span class=n>DEFAULT_LOAD_FACTOR</span> <span class=o>*</span> <span class=n>DEFAULT_INITIAL_CAPACITY</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 计算新的 resize 上限  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>newThr</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=kt>float</span> <span class=n>ft</span> <span class=o>=</span> <span class=o>(</span><span class=kt>float</span><span class=o>)</span><span class=n>newCap</span> <span class=o>*</span> <span class=n>loadFactor</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=n>newThr</span> <span class=o>=</span> <span class=o>(</span><span class=n>newCap</span> <span class=o>&lt;</span> <span class=n>MAXIMUM_CAPACITY</span> <span class=o>&amp;&amp;</span> <span class=n>ft</span> <span class=o>&lt;</span> <span class=o>(</span><span class=kt>float</span><span class=o>)</span><span class=n>MAXIMUM_CAPACITY</span> <span class=o>?</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span><span class=n>ft</span> <span class=o>:</span> <span class=n>Integer</span><span class=o>.</span><span class=na>MAX_VALUE</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>threshold</span> <span class=o>=</span> <span class=n>newThr</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=nd>@SuppressWarnings</span><span class=o>({</span><span class=s>&#34;rawtypes&#34;</span><span class=o>,</span><span class=s>&#34;unchecked&#34;</span><span class=o>})</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[]</span> <span class=n>newTab</span> <span class=o>=</span> <span class=o>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[])</span><span class=k>new</span> <span class=n>Node</span><span class=o>[</span><span class=n>newCap</span><span class=o>];</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>table</span> <span class=o>=</span> <span class=n>newTab</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>oldTab</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 旧数组迁移至新数组  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>oldCap</span><span class=o>;</span> <span class=o>++</span><span class=n>j</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>oldTab</span><span class=o>[</span><span class=n>j</span><span class=o>])</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>oldTab</span><span class=o>[</span><span class=n>j</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>next</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>                    <span class=n>newTab</span><span class=o>[</span><span class=n>e</span><span class=o>.</span><span class=na>hash</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>newCap</span> <span class=o>-</span> <span class=n>1</span><span class=o>)]</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=k>instanceof</span> <span class=n>TreeNode</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>                    <span class=o>((</span><span class=n>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;)</span><span class=n>e</span><span class=o>).</span><span class=na>split</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>newTab</span><span class=o>,</span> <span class=n>j</span><span class=o>,</span> <span class=n>oldCap</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>loHead</span> <span class=o>=</span> <span class=kc>null</span><span class=o>,</span> <span class=n>loTail</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>hiHead</span> <span class=o>=</span> <span class=kc>null</span><span class=o>,</span> <span class=n>hiTail</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>next</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                    <span class=k>do</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                        <span class=n>next</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                        <span class=c1>// 原索引  
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=o>((</span><span class=n>e</span><span class=o>.</span><span class=na>hash</span> <span class=o>&amp;</span> <span class=n>oldCap</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=o>(</span><span class=n>loTail</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>                                <span class=n>loHead</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                            <span class=k>else</span>  
</span></span><span class=line><span class=cl>                                <span class=n>loTail</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                            <span class=n>loTail</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                        <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                        <span class=c1>// 原索引+oldCap  
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>else</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=o>(</span><span class=n>hiTail</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>                                <span class=n>hiHead</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                            <span class=k>else</span>  
</span></span><span class=line><span class=cl>                                <span class=n>hiTail</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                            <span class=n>hiTail</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                        <span class=o>}</span>  
</span></span><span class=line><span class=cl>                    <span class=o>}</span> <span class=k>while</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>next</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                    <span class=c1>// 原索引元素放到新数组中  
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>loTail</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                        <span class=n>loTail</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                        <span class=n>newTab</span><span class=o>[</span><span class=n>j</span><span class=o>]</span> <span class=o>=</span> <span class=n>loHead</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                    <span class=c1>// 原索引 +oldCap 元素放到新数组中  
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>hiTail</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                        <span class=n>hiTail</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                        <span class=n>newTab</span><span class=o>[</span><span class=n>j</span> <span class=o>+</span> <span class=n>oldCap</span><span class=o>]</span> <span class=o>=</span> <span class=n>hiHead</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>                    <span class=o>}</span>  
</span></span><span class=line><span class=cl>                <span class=o>}</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>newTab</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><p>resize 方法中的前半段，关于 newCap 和 newThr 的计算过程，简化后如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>oldCap</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 嵌套条件分支  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>oldCap</span> <span class=o>&gt;=</span> <span class=n>MAXIMUM_CAPACITY</span><span class=o>)</span> <span class=o>{...}</span>  
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>newCap</span> <span class=o>=</span> <span class=n>oldCap</span> <span class=o>&lt;&lt;</span> <span class=n>1</span><span class=o>)</span> <span class=o>&lt;</span> <span class=n>MAXIMUM_CAPACITY</span> <span class=o>&amp;&amp;</span>  
</span></span><span class=line><span class=cl>                 <span class=n>oldCap</span> <span class=o>&gt;=</span> <span class=n>DEFAULT_INITIAL_CAPACITY</span><span class=o>)</span> <span class=o>{...}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>   
</span></span><span class=line><span class=cl><span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>oldThr</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{...}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=k>else</span> <span class=o>{...}</span>  
</span></span></code></pre></td></tr></table></div></div><p>这些判断分别对应以下几种条件：</p><table><thead><tr><th>条件                       </th><th>覆盖情况                            </th><th>备注                                                                                                                         </th></tr></thead><tbody><tr><td>oldCap > 0                 </td><td>桶数组 table 已经被初始化           </td><td>                                                                                                                              </td></tr><tr><td>oldThr > 0                 </td><td>threshold > 0，且桶数组未被初始化   </td><td>调用 HashMap(int) 和 HashMap(int, float) 构造方法时会产生这种情况，此种情况下 newCap = oldThr，newThr 在第二个条件分支中算出</td></tr><tr><td>oldCap <mark>0 && oldThr</mark> 0</td><td>桶数组未被初始化，且 threshold 为 0</td><td>调用 HashMap() 构造方法会产生这种情况。                                                                                      </td></tr></tbody></table><p>oldCap > 0 时表示 table 数组已经被初始化过，这时需要再次计算容量和阈值：</p><table><thead><tr><th>条件                        </th><th>覆盖情况                                      </th><th>备注                                                      </th></tr></thead><tbody><tr><td>oldCap >= 230               </td><td>桶数组容量大于或等于最大桶容量 230            </td><td>后续不再扩容                                              </td></tr><tr><td>newCap &lt; 230 && oldCap > 16</td><td>新桶数组容量小于最大值，且旧桶数组容量大于 16</td><td>该种情况下新阈值 newThr = oldThr &#171; 1，移位可能会导致溢出</td></tr></tbody></table><p>resize 方法后续过程中可以看出，Java 8 转移数据操作是按旧链表的正序遍历链表、在新链表的尾部依次插入的，所以不会出现链表 逆序、倒置的情况，故不容易出现环形链表的情况。但仍然还是线程不安全，因为没有加同步锁保护。</p><a href=#扩容流程对比><h2 id=扩容流程对比><span class=hanchor arialabel=Anchor># </span>扩容流程对比</h2></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_040805.png width=auto alt></p><a href=#get-流程分析><h1 id=get-流程分析><span class=hanchor arialabel=Anchor># </span>get 流程分析</h1></a><a href=#java-7-1><h2 id=java-7-1><span class=hanchor arialabel=Anchor># </span>Java 7</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>V</span> <span class=nf>get</span><span class=o>(</span><span class=n>Object</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>key</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getForNullKey</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>=</span> <span class=n>getEntry</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span> <span class=o>==</span> <span class=n>entry</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=n>entry</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>V</span> <span class=nf>getForNullKey</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>size</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 下标为 0 处获取 key 为 null 的元素  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span> <span class=o>=</span> <span class=n>table</span><span class=o>[</span><span class=n>0</span><span class=o>];</span> <span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span> <span class=n>e</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>next</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>key</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=nf>getEntry</span><span class=o>(</span><span class=n>Object</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>size</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>hash</span> <span class=o>=</span> <span class=o>(</span><span class=n>key</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>?</span> <span class=n>0</span> <span class=o>:</span> <span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span> <span class=o>=</span> <span class=n>table</span><span class=o>[</span><span class=n>indexFor</span><span class=o>(</span><span class=n>hash</span><span class=o>,</span> <span class=n>table</span><span class=o>.</span><span class=na>length</span><span class=o>)];</span>  
</span></span><span class=line><span class=cl>             <span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span> <span class=n>e</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>next</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>k</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>hash</span> <span class=o>==</span> <span class=n>hash</span> <span class=o>&amp;&amp;</span>  
</span></span><span class=line><span class=cl>            <span class=o>((</span><span class=n>k</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>key</span><span class=o>)</span> <span class=o>==</span> <span class=n>key</span> <span class=o>||</span> <span class=o>(</span><span class=n>key</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>key</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>k</span><span class=o>))))</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><a href=#java-8-1><h2 id=java-8-1><span class=hanchor arialabel=Anchor># </span>Java 8</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>V</span> <span class=nf>get</span><span class=o>(</span><span class=n>Object</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=n>e</span> <span class=o>=</span> <span class=n>getNode</span><span class=o>(</span><span class=n>hash</span><span class=o>(</span><span class=n>key</span><span class=o>),</span> <span class=n>key</span><span class=o>))</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=nf>getNode</span><span class=o>(</span><span class=kt>int</span> <span class=n>hash</span><span class=o>,</span> <span class=n>Object</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;[]</span> <span class=n>tab</span><span class=o>;</span> <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>first</span><span class=o>,</span> <span class=n>e</span><span class=o>;</span> <span class=kt>int</span> <span class=n>n</span><span class=o>;</span> <span class=n>K</span> <span class=n>k</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span><span class=n>tab</span> <span class=o>=</span> <span class=n>table</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>n</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>)</span> <span class=o>&gt;</span> <span class=n>0</span> <span class=o>&amp;&amp;</span>  
</span></span><span class=line><span class=cl>        <span class=o>(</span><span class=n>first</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[(</span><span class=n>n</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>&amp;</span> <span class=n>hash</span><span class=o>])</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 先判断 tab[index] 中的第一个元素  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>first</span><span class=o>.</span><span class=na>hash</span> <span class=o>==</span> <span class=n>hash</span> <span class=o>&amp;&amp;</span> <span class=c1>// always check first node  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>((</span><span class=n>k</span> <span class=o>=</span> <span class=n>first</span><span class=o>.</span><span class=na>key</span><span class=o>)</span> <span class=o>==</span> <span class=n>key</span> <span class=o>||</span> <span class=o>(</span><span class=n>key</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>key</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>k</span><span class=o>))))</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>first</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>first</span><span class=o>.</span><span class=na>next</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=c1>// 结点为红黑树则使用 TreeNode 的方法获取  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>first</span> <span class=k>instanceof</span> <span class=n>TreeNode</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=o>((</span><span class=n>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span><span class=n>V</span><span class=o>&gt;)</span><span class=n>first</span><span class=o>).</span><span class=na>getTreeNode</span><span class=o>(</span><span class=n>hash</span><span class=o>,</span> <span class=n>key</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=k>do</span> <span class=o>{</span> <span class=c1>//否则遍历链表  
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>hash</span> <span class=o>==</span> <span class=n>hash</span> <span class=o>&amp;&amp;</span>  
</span></span><span class=line><span class=cl>                    <span class=o>((</span><span class=n>k</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>key</span><span class=o>)</span> <span class=o>==</span> <span class=n>key</span> <span class=o>||</span> <span class=o>(</span><span class=n>key</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>key</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>k</span><span class=o>))))</span>  
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>e</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>while</span> <span class=o>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>next</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div><p>遍历方式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>map</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;()</span> <span class=o>{{</span>  
</span></span><span class=line><span class=cl>    <span class=n>put</span><span class=o>(</span><span class=s>&#34;a&#34;</span><span class=o>,</span> <span class=n>10</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>put</span><span class=o>(</span><span class=s>&#34;b&#34;</span><span class=o>,</span> <span class=n>20</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}};</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// 方式一：迭代 entrySet  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>:</span> <span class=n>map</span><span class=o>.</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>value</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 方式二：单独迭代 keySet 或 values  
</span></span></span><span class=line><span class=cl><span class=c1>// 迭代键  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>key</span> <span class=o>:</span> <span class=n>map</span><span class=o>.</span><span class=na>keySet</span><span class=o>())</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Key = &#34;</span> <span class=o>+</span> <span class=n>key</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// 迭代值  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=o>(</span><span class=n>Integer</span> <span class=n>value</span> <span class=o>:</span> <span class=n>map</span><span class=o>.</span><span class=na>values</span><span class=o>())</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Value = &#34;</span> <span class=o>+</span> <span class=n>value</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 方式三：使用 iterator  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span>         
</span></span><span class=line><span class=cl>          <span class=n>map</span><span class=o>.</span><span class=na>entrySet</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=o>(</span><span class=n>entries</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>value</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 方式四：Lambda 表达式  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>map</span><span class=o>.</span><span class=na>forEach</span><span class=o>((</span><span class=n>k</span><span class=o>,</span> <span class=n>v</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;key: &#34;</span> <span class=o>+</span> <span class=n>k</span> <span class=o>+</span> <span class=s>&#34; value:&#34;</span> <span class=o>+</span> <span class=n>v</span><span class=o>));</span>  
</span></span></code></pre></td></tr></table></div></div><a href=#面试题><h1 id=面试题><span class=hanchor arialabel=Anchor># </span>面试题</h1></a><a href=#为什么-hashmap-数组长度为-2-的幂次方><h2 id=为什么-hashmap-数组长度为-2-的幂次方><span class=hanchor arialabel=Anchor># </span>为什么 HashMap 数组长度为 2 的幂次方？</h2></a><p>如果数组中 hash 冲突太过频繁，某些位置的元素形成过长的链表，就会导致数据存取效率过低，因此要使元素均匀地分布在数组中，hash 碰撞就不能太频繁。而 hash 值范围为 -2147483648 到 2147483647，如果用如此长的数组来进行存放加上合理 hash 映射确实可以使 hash 碰撞降到很低的水平，但这明显是不现实的。</p><p>因此这个 hash 值是不能直接使用的，首先需要进行二次 hash 使得结果更加随机，这时理论上可以使用 hash % length 得到一个不小于数组长度 length 的 index 值，这样不但能避免产生数组越界，并且可以使元素均匀分布，事实上很多 hash 算法都是采用该方法。但是在计算机中，% 取模运算比位 & 运算的效率要低得多，而当 length 为 2 的幂次方时，hash % length 刚好等于 hash & (length - 1) ，从而能够将 % 运算转换成 & 运算，更加快速地得到 index 值。</p><p>因此采用 2 的幂次方作为数组的长度的好处是：使元素均匀分部以降低 hash 冲突的基础上，大大加快了计算元素所在数组位置的速度。</p><a href=#hash-冲突有哪些解决方法hashmap-是怎样解决的><h2 id=hash-冲突有哪些解决方法hashmap-是怎样解决的><span class=hanchor arialabel=Anchor># </span>hash 冲突有哪些解决方法？HashMap 是怎样解决的？</h2></a><p>1. 二次 hash，通过高 16 位与低 16 位异或运算，使得结果更加随机；<br>2. 拉链地址法，将 hash 值相同的元素串成一个链表或者转为红黑树。</p><a href=#hashmap-会造成哪些安全问题怎么解决><h2 id=hashmap-会造成哪些安全问题怎么解决><span class=hanchor arialabel=Anchor># </span>HashMap 会造成哪些安全问题？怎么解决？</h2></a><p>如前面文章所述，在 Java 7 中，HashMap 在扩容的时候是通过遍历旧数组，然后在新数组中使用头插法进行转移元素的。这在单线程环境中是没有问题的，但是到了多线程环境下，由于 JMM 的特性，会以一定的概率形成环形链表的情况。在 Java 8 中这个问题通过使用尾插法得到解决，但是多线程下很多操作仍然会导致线程安全问题，比如多个线程 put 后某些元素丢失等。因此多线程环境下要保证线程安全，可以使用 ConcurentHashMap 代替 HashMap。</p><a href=#使用对象作为-hashmap-的-key-应该注意什么><h2 id=使用对象作为-hashmap-的-key-应该注意什么><span class=hanchor arialabel=Anchor># </span>使用对象作为 HashMap 的 key 应该注意什么？</h2></a><p>应当重写对象的 hashCode() 和 equals() 方法。如前面代码所示，HashMap 在 put 一个元素的时候，会调用此元素的 key 值的 hashCode 方法确定元素存放位置，并且会调用 hashCode 和 equals 方法判断元素是否相等。因此如果没有重写这两个方法，或者方法重写的时候没有遵守规则，HashMap 通过 put 存入一组元素后，再通过此元素的 key 值去 get 对象的时候就有可能出现跟预期结果不一致的情况。</p><p>在重写 equals 方法的时候，需要遵守下面的通用约定：</p><p>- <strong>自反性</strong>：对于任何非空引用 x，x.equals(x) 必须返回 true；<br>- <strong>对称性</strong>：对于任何非空引用 x 和 y，如果且仅当 y.equals(x) 返回 true 时 x.equals(y) 必须返回 true；<br>- <strong>传递性</strong>：对于任何非空引用 x、y、z，如果 x.equals(y) 返回 true，y.equals(z) 返回 true，则 x.equals(z) 必须返回 true；<br>- <strong>一致性</strong>：对于任何非空引用 x 和 y，如果在 equals 比较中使用的信息没有修改，则 x.equals(y) 的多次调用必须始终返回 true 或始终返回 false；<br>- <strong>非空性</strong>：对于任何非空引用 x，x.equals(null) 必须返回 false。</p><p><strong>重写 hashCode 方法的大致方式（非强制）：</strong></p><p>1. 把某个非零常数值，比如说 31（最好是素数，考虑到 HashMap 源码中的异或操作），保存在一个叫 result 的 int 类型的变量中。<br>2. 对于对象中每一个关键域 f（值 equals 方法中考虑的每一个域），完成以下步骤：<br>3. 为该域计算 int 类型的散列码 c:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. 如果该域是 boolean 类型，则计算 (f?0:1)  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>2. 如果该域是 byte、char、short 或者 int 类型，则计算 (int)f  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>3. 如果该域是 float 类型，则计算 Float.floatToIntBits(f)  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>4. 如果该域是 long 类型，则计算 (int)(f ^ (f&gt;&gt;&gt;32))  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>5. 如果该域是double类型，则计算 Double.doubleToLongBits(f) 得到一个 long 类型的值，然后按照步骤 4，对该 long 型值计算散列值  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>6. 如果该域是一个对象引用，并且该类的 equals 方法通过递归调用 equals 的方式来比较这个域，则同样对这个对象递归调用 hashCode 方法。  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>7. 如果该域是一个数组，则把每一个元素当做单独的域来处理。也就是说，递归地应用上述规则，对每个重要的元素计算一个散列码，然后根据步骤下面的做法把这些散列值组合起来。  
</span></span></code></pre></td></tr></table></div></div><p>2. 按照下面的公式，把步骤 1 中计算得到的散列码 c 组合到 result 中：result = 31 x result+c。<br>3. 返回 result。<br>4. 写完 hashCode 方法之后，确认是否相等的实例具有相等的散列码。如果不是的话，找出原因，并修改。</p><p>样例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Student</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>age</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Grades</span> <span class=n>grades</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Student</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=kt>int</span> <span class=n>age</span><span class=o>,</span> <span class=n>Grades</span> <span class=n>grades</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>age</span> <span class=o>=</span> <span class=n>age</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>grades</span> <span class=o>=</span> <span class=n>grades</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>hashCode</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>prime</span> <span class=o>=</span> <span class=n>31</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>prime</span> <span class=o>*</span> <span class=n>result</span> <span class=o>+</span> <span class=n>age</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>prime</span> <span class=o>*</span> <span class=n>result</span> <span class=o>+</span>  
</span></span><span class=line><span class=cl>                <span class=o>((</span><span class=n>name</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>?</span> <span class=n>0</span> <span class=o>:</span> <span class=n>name</span><span class=o>.</span><span class=na>hashCode</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>prime</span> <span class=o>*</span> <span class=n>result</span> <span class=o>+</span>  
</span></span><span class=line><span class=cl>                <span class=o>(</span><span class=n>grades</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>0</span> <span class=o>:</span> <span class=n>grades</span><span class=o>.</span><span class=na>hashCode</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>equals</span><span class=o>(</span><span class=n>Object</span> <span class=n>obj</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=k>this</span> <span class=o>==</span> <span class=n>obj</span><span class=o>)</span> <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>obj</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>getClass</span><span class=o>()</span> <span class=o>!=</span> <span class=n>obj</span><span class=o>.</span><span class=na>getClass</span><span class=o>())</span> <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=n>Student</span> <span class=n>other</span> <span class=o>=</span> <span class=o>(</span><span class=n>Student</span><span class=o>)</span> <span class=n>obj</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>age</span> <span class=o>!=</span> <span class=n>other</span><span class=o>.</span><span class=na>age</span><span class=o>)</span> <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>name</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=o>!</span><span class=n>name</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>name</span><span class=o>)</span> <span class=o>:</span>   
</span></span><span class=line><span class=cl>              <span class=n>other</span><span class=o>.</span><span class=na>name</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>grades</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=o>!</span><span class=n>grades</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>other</span><span class=o>.</span><span class=na>grades</span><span class=o>)</span> <span class=o>:</span>           
</span></span><span class=line><span class=cl>              <span class=n>other</span><span class=o>.</span><span class=na>grades</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>