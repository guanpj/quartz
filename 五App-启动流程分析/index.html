<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="åœ¨æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç«  Android ç³»ç»Ÿå¯åŠ¨æµç¨‹åˆ†æä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†ç³»ç»Ÿåœ¨å¼€æœºä»¥åçš„ä¸€ç³»åˆ—è¡Œä¸ºï¼Œå…¶ä¸­æœ€åä¸€é˜¶æ®µ AMS(ActivityManagerService) ä¼šå¯åŠ¨ Launcher æ¥å±•ç¤ºæˆ‘ä»¬æ‰‹æœºä¸­æ‰€æœ‰å·²å®‰è£…çš„åº”ç”¨å›¾æ ‡ï¼Œç‚¹å‡»å›¾æ ‡åç›¸åº”çš„åº”ç”¨ç¨‹åºå°†ä¼šè¢«ç³»ç»Ÿå¯åŠ¨è¿è¡Œå¹¶å±•ç¤ºåœ¨æˆ‘ä»¬é¢å‰ï¼Œé‚£ä¹ˆï¼Œç‚¹å‡»äº†å›¾æ ‡ä¹‹åç³»ç»Ÿé“ç†åšäº†å“ªäº›å·¥ä½œå‘¢ï¼Ÿåº”ç”¨è¿›ç¨‹æ˜¯æ€ä¹ˆè¢«å¯åŠ¨çš„å‘¢ï¼ŸActivity çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°è°ƒç”¨çš„å‘¢ï¼Ÿæœ¬æ–‡å°†ç»§ç»­åŸºäº Android Nougat çš„ frameworks å±‚æºç çš„è§£ç­”è¿™äº›é—®é¢˜ã€‚
é˜…è¯»å»ºè®®ï¼š
å¦‚æœä½ æ˜¯é¦–æ¬¡é˜…è¯»è¿™ä¸ªè¿‡ç¨‹çš„æºç ï¼Œå»ºè®®ä½ å¿½ç•¥ä¸€äº›ç»†ææœ«èŠ‚çš„ä»£ç ï¼Œå…ˆæŠ“ä¸»å¹²ä»£ç ï¼Œä»æ•´ä½“ä¸Šç†è§£ä»£ç çš„æ‰§è¡Œæµç¨‹ï¼ˆå³ä¸‹è§’æ–‡ç« ç›®å½•è§†å›¾ä¸­å¯ä»¥ç‚¹å‡»è·³è½¬åˆ°ç›¸åº”ç« èŠ‚ï¼‰ï¼Œå¦åˆ™å°†ä¼šè¢«ç»†èŠ‚çš„ä»£ç æ‰°ä¹±æ€è·¯ã€‚æœ€åå¯ä»¥å›å¤´å¤šçœ‹å‡ éï¼Œè¿™æ—¶å€™å¦‚æœæœ‰éœ€è¦å¯ä»¥è¿½è¸ªä¸€äº›æå¹²ä»£ç ï¼Œåšåˆ°èä¼šè´¯é€šã€‚
1. Launcher â€”â€” AMS 1.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ 1."><meta property="og:title" content="äº”ã€App å¯åŠ¨æµç¨‹åˆ†æ"><meta property="og:description" content="åœ¨æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç«  Android ç³»ç»Ÿå¯åŠ¨æµç¨‹åˆ†æä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†ç³»ç»Ÿåœ¨å¼€æœºä»¥åçš„ä¸€ç³»åˆ—è¡Œä¸ºï¼Œå…¶ä¸­æœ€åä¸€é˜¶æ®µ AMS(ActivityManagerService) ä¼šå¯åŠ¨ Launcher æ¥å±•ç¤ºæˆ‘ä»¬æ‰‹æœºä¸­æ‰€æœ‰å·²å®‰è£…çš„åº”ç”¨å›¾æ ‡ï¼Œç‚¹å‡»å›¾æ ‡åç›¸åº”çš„åº”ç”¨ç¨‹åºå°†ä¼šè¢«ç³»ç»Ÿå¯åŠ¨è¿è¡Œå¹¶å±•ç¤ºåœ¨æˆ‘ä»¬é¢å‰ï¼Œé‚£ä¹ˆï¼Œç‚¹å‡»äº†å›¾æ ‡ä¹‹åç³»ç»Ÿé“ç†åšäº†å“ªäº›å·¥ä½œå‘¢ï¼Ÿåº”ç”¨è¿›ç¨‹æ˜¯æ€ä¹ˆè¢«å¯åŠ¨çš„å‘¢ï¼ŸActivity çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°è°ƒç”¨çš„å‘¢ï¼Ÿæœ¬æ–‡å°†ç»§ç»­åŸºäº Android Nougat çš„ frameworks å±‚æºç çš„è§£ç­”è¿™äº›é—®é¢˜ã€‚
é˜…è¯»å»ºè®®ï¼š
å¦‚æœä½ æ˜¯é¦–æ¬¡é˜…è¯»è¿™ä¸ªè¿‡ç¨‹çš„æºç ï¼Œå»ºè®®ä½ å¿½ç•¥ä¸€äº›ç»†ææœ«èŠ‚çš„ä»£ç ï¼Œå…ˆæŠ“ä¸»å¹²ä»£ç ï¼Œä»æ•´ä½“ä¸Šç†è§£ä»£ç çš„æ‰§è¡Œæµç¨‹ï¼ˆå³ä¸‹è§’æ–‡ç« ç›®å½•è§†å›¾ä¸­å¯ä»¥ç‚¹å‡»è·³è½¬åˆ°ç›¸åº”ç« èŠ‚ï¼‰ï¼Œå¦åˆ™å°†ä¼šè¢«ç»†èŠ‚çš„ä»£ç æ‰°ä¹±æ€è·¯ã€‚æœ€åå¯ä»¥å›å¤´å¤šçœ‹å‡ éï¼Œè¿™æ—¶å€™å¦‚æœæœ‰éœ€è¦å¯ä»¥è¿½è¸ªä¸€äº›æå¹²ä»£ç ï¼Œåšåˆ°èä¼šè´¯é€šã€‚
1. Launcher â€”â€” AMS 1.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ 1."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="äº”ã€App å¯åŠ¨æµç¨‹åˆ†æ"><meta name=twitter:description content="åœ¨æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç«  Android ç³»ç»Ÿå¯åŠ¨æµç¨‹åˆ†æä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†ç³»ç»Ÿåœ¨å¼€æœºä»¥åçš„ä¸€ç³»åˆ—è¡Œä¸ºï¼Œå…¶ä¸­æœ€åä¸€é˜¶æ®µ AMS(ActivityManagerService) ä¼šå¯åŠ¨ Launcher æ¥å±•ç¤ºæˆ‘ä»¬æ‰‹æœºä¸­æ‰€æœ‰å·²å®‰è£…çš„åº”ç”¨å›¾æ ‡ï¼Œç‚¹å‡»å›¾æ ‡åç›¸åº”çš„åº”ç”¨ç¨‹åºå°†ä¼šè¢«ç³»ç»Ÿå¯åŠ¨è¿è¡Œå¹¶å±•ç¤ºåœ¨æˆ‘ä»¬é¢å‰ï¼Œé‚£ä¹ˆï¼Œç‚¹å‡»äº†å›¾æ ‡ä¹‹åç³»ç»Ÿé“ç†åšäº†å“ªäº›å·¥ä½œå‘¢ï¼Ÿåº”ç”¨è¿›ç¨‹æ˜¯æ€ä¹ˆè¢«å¯åŠ¨çš„å‘¢ï¼ŸActivity çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°è°ƒç”¨çš„å‘¢ï¼Ÿæœ¬æ–‡å°†ç»§ç»­åŸºäº Android Nougat çš„ frameworks å±‚æºç çš„è§£ç­”è¿™äº›é—®é¢˜ã€‚
é˜…è¯»å»ºè®®ï¼š
å¦‚æœä½ æ˜¯é¦–æ¬¡é˜…è¯»è¿™ä¸ªè¿‡ç¨‹çš„æºç ï¼Œå»ºè®®ä½ å¿½ç•¥ä¸€äº›ç»†ææœ«èŠ‚çš„ä»£ç ï¼Œå…ˆæŠ“ä¸»å¹²ä»£ç ï¼Œä»æ•´ä½“ä¸Šç†è§£ä»£ç çš„æ‰§è¡Œæµç¨‹ï¼ˆå³ä¸‹è§’æ–‡ç« ç›®å½•è§†å›¾ä¸­å¯ä»¥ç‚¹å‡»è·³è½¬åˆ°ç›¸åº”ç« èŠ‚ï¼‰ï¼Œå¦åˆ™å°†ä¼šè¢«ç»†èŠ‚çš„ä»£ç æ‰°ä¹±æ€è·¯ã€‚æœ€åå¯ä»¥å›å¤´å¤šçœ‹å‡ éï¼Œè¿™æ—¶å€™å¦‚æœæœ‰éœ€è¦å¯ä»¥è¿½è¸ªä¸€äº›æå¹²ä»£ç ï¼Œåšåˆ°èä¼šè´¯é€šã€‚
1. Launcher â€”â€” AMS 1.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ 1."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>äº”ã€App å¯åŠ¨æµç¨‹åˆ†æ</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.4c3ebbd971971c16df2dee22b7632aef.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.7fe6218ad14878dfbc3737ff901810c4.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.c07b772b30c71ceeb1916b92ce09a6f9.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><div class=row><div class=col-md-3 id=toc><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#1-launcher--ams>1. Launcher â€”â€” AMS</a><ol><li><a href=#11-è°ƒç”¨è¿‡ç¨‹åˆ†æ>1.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ</a><ol><li><a href=#111-launcheronclick>1.1.1 Launcher.onClick</a></li><li><a href=#112-launcheronclickappshortcut>1.1.2 Launcher.onClickAppShortcut</a></li><li><a href=#113-launcherstartactivity>1.1.3 Launcher.startActivity</a></li><li><a href=#114-activitystartactivity>1.1.4 Activity.startActivity</a></li><li><a href=#115-activitystartactivityforresult>1.1.5 Activity.startActivityForResult</a></li><li><a href=#116-instrumentationexecstartactivity>1.1.6 Instrumentation.execStartActivity</a></li><li><a href=#117-activitymanagerproxystartactivity>1.1.7 ActivityManagerProxy.startActivity</a></li><li><a href=#118-activitymanagerservicestartactivity>1.1.8 ActivityManagerService.startActivity</a></li></ol></li><li><a href=#12-å°ç»“>1.2 å°ç»“</a></li></ol></li><li><a href=#2-ams--zygote>2. AMS â€”â€” zygote</a><ol><li><a href=#21-è°ƒç”¨è¿‡ç¨‹åˆ†æ>2.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ</a><ol><li><a href=#211-activitymanagerservicestartactivityasuser>2.1.1 ActivityManagerService.startActivityAsUser</a></li><li><a href=#212-activitystarterstartactivitymaywait>2.1.2 ActivityStarter.startActivityMayWait</a></li><li><a href=#213-activitystarterstartactivitylocked>2.1.3 ActivityStarter.startActivityLocked</a></li><li><a href=#214-activitystarterdopendingactivitylauncheslocked>2.1.4 ActivityStarter.doPendingActivityLaunchesLocked</a></li><li><a href=#215-activitystarterstartactivityunchecked>2.1.5 ActivityStarter.startActivityUnchecked</a></li><li><a href=#216-activitystacksupervisorresumefocusedstacktopactivitylocked>2.1.6 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</a></li><li><a href=#217-activitystackresumetopactivityuncheckedlocked>2.1.7 ActivityStack.resumeTopActivityUncheckedLocked</a></li><li><a href=#218-activitystackresumetopactivityinnerlocked>2.1.8 ActivityStack.resumeTopActivityInnerLocked</a></li><li><a href=#219-activitystacksupervisorstartspecificactivitylocked>2.1.9 ActivityStackSupervisor.startSpecificActivityLocked</a></li><li><a href=#2110-activitymanagerservicestartprocesslocked>2.1.10 ActivityManagerService.startProcessLocked</a></li><li><a href=#2111-activitymanagerservicestartprocesslocked>2.1.11 ActivityManagerService.startProcessLocked</a></li><li><a href=#2112-activitymanagerservicestartprocesslocked>2.1.12 ActivityManagerService.startProcessLocked</a></li><li><a href=#2113-processstart>2.1.13 Process.start</a></li><li><a href=#2114-processstartviazygote>2.1.14 Process.startViaZygote</a></li><li><a href=#2115-processzygotesendargsandgetresultprocessopenzygotesocketifneeded>2.1.15 Process.zygoteSendArgsAndGetResultã€Process.openZygoteSocketIfNeeded</a></li></ol></li><li><a href=#22-å°ç»“>2.2 å°ç»“</a></li></ol></li><li><a href=#3-zygote--activitythread>3. zygote â€”â€” ActivityThread</a><ol><li><a href=#31-è°ƒç”¨è¿‡ç¨‹åˆ†æ>3.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ</a><ol><li><a href=#311-zygoteinitmain>3.1.1 ZygoteInit.main</a></li><li><a href=#312-zygoteinitrunselectloop>3.1.2 ZygoteInit.runSelectLoop</a></li><li><a href=#313-zygoteconnectionrunonce>3.1.3 ZygoteConnection.runOnce</a></li><li><a href=#314-zygoteconnectionhandlechildproc>3.1.4 ZygoteConnection.handleChildProc</a></li><li><a href=#315-runtimeinitzygoteinit>3.1.5 RuntimeInit.zygoteInit</a></li><li><a href=#316-runtimeinitapplicationinit>3.1.6 RuntimeInit.applicationInit</a></li><li><a href=#317-runtimeinitinvokestaticmain>3.1.7 RuntimeInit.invokeStaticMain</a></li><li><a href=#318-methodandargscallerrun>3.1.8 MethodAndArgsCaller.run</a></li><li><a href=#319-activitythread-main>3.1.9 ActivityThread .main</a></li></ol></li><li><a href=#32-å°ç»“>3.2 å°ç»“</a></li></ol></li><li><a href=#4-activitythread--activity>4. ActivityThread â€”â€” Activity</a><ol><li><a href=#41-è°ƒç”¨è¿‡ç¨‹åˆ†æ>4.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ</a><ol><li><a href=#411-activitythreadattach>4.1.1 ActivityThread.attach</a></li><li><a href=#412-activitymanagerproxyattachapplication>4.1.2 ActivityManagerProxy.attachApplication</a></li><li><a href=#413-activitymanagernativeontransact>4.1.3 ActivityManagerNative.onTransact</a></li><li><a href=#414-activitymanagerserviceattachapplication>4.1.4 ActivityManagerService.attachApplication</a></li><li><a href=#415-activitymanagerserviceattachapplicationlocked>4.1.5 ActivityManagerService.attachApplicationLocked</a><ol><li><a href=#strong4151-activitythreadjavaapplicationthreadbindapplicationstrong><strong>4.1.5.1 ActivityThread.java::ApplicationThread.bindApplication</strong></a></li><li><a href=#strong4152-activitystacksupervisorattachapplicationlockedstrong><strong>4.1.5.2 ActivityStackSupervisor.attachApplicationLocked</strong></a><ol><li><a href=#strong41521-activitystacksupervisorrealstartactivitylockedstrong><strong>4.1.5.2.1 ActivityStackSupervisor.realStartActivityLocked</strong></a></li><li><a href=#strong41522-applicationthreadschedulelaunchactivitystrong><strong>4.1.5.2.2 ApplicationThread.scheduleLaunchActivity</strong></a></li><li><a href=#strong41523-activitythreadhandlelaunchactivitystrong><strong>4.1.5.2.3 ActivityThread.handleLaunchActivity</strong></a></li><li><a href=#strong41424-applicationthreadperformlaunchactivitystrong><strong>4.1.4.2.4 ApplicationThread.performLaunchActivity</strong></a></li><li><a href=#strong41525-instrumentationcallactivityoncreatestrong><strong>4.1.5.2.5 Instrumentation.callActivityOnCreate</strong></a></li><li><a href=#strong41526-activityperformcreatestrong><strong>4.1.5.2.6 Activity.performCreate</strong></a></li></ol></li></ol></li></ol></li><li><a href=#42-å°ç»“>4.2 å°ç»“</a></li></ol></li><li><a href=#5-æ€»ç»“>5. æ€»ç»“</a></li></ol></nav></details></aside></div><div class=col-md-9><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>äº”ã€App å¯åŠ¨æµç¨‹åˆ†æ</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/zygote/>Zygote</a></li><li><a href=https://www.guanpj.top/tags/AMS/>Ams</a></li><li><a href=https://www.guanpj.top/tags/ActivityThread/>Activity thread</a></li><li><a href=https://www.guanpj.top/tags/Framework/>Framework</a></li></ul><p>åœ¨æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« 
<a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>Android ç³»ç»Ÿå¯åŠ¨æµç¨‹åˆ†æ</a>ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†ç³»ç»Ÿåœ¨å¼€æœºä»¥åçš„ä¸€ç³»åˆ—è¡Œä¸ºï¼Œå…¶ä¸­æœ€åä¸€é˜¶æ®µ AMS(ActivityManagerService) ä¼šå¯åŠ¨ Launcher æ¥å±•ç¤ºæˆ‘ä»¬æ‰‹æœºä¸­æ‰€æœ‰å·²å®‰è£…çš„åº”ç”¨å›¾æ ‡ï¼Œç‚¹å‡»å›¾æ ‡åç›¸åº”çš„åº”ç”¨ç¨‹åºå°†ä¼šè¢«ç³»ç»Ÿå¯åŠ¨è¿è¡Œå¹¶å±•ç¤ºåœ¨æˆ‘ä»¬é¢å‰ï¼Œé‚£ä¹ˆï¼Œç‚¹å‡»äº†å›¾æ ‡ä¹‹åç³»ç»Ÿé“ç†åšäº†å“ªäº›å·¥ä½œå‘¢ï¼Ÿåº”ç”¨è¿›ç¨‹æ˜¯æ€ä¹ˆè¢«å¯åŠ¨çš„å‘¢ï¼ŸActivity çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°è°ƒç”¨çš„å‘¢ï¼Ÿæœ¬æ–‡å°†ç»§ç»­åŸºäº Android Nougat çš„ frameworks å±‚æºç çš„è§£ç­”è¿™äº›é—®é¢˜ã€‚</p><p><strong>é˜…è¯»å»ºè®®ï¼š</strong></p><p>å¦‚æœä½ æ˜¯é¦–æ¬¡é˜…è¯»è¿™ä¸ªè¿‡ç¨‹çš„æºç ï¼Œå»ºè®®ä½ å¿½ç•¥ä¸€äº›ç»†ææœ«èŠ‚çš„ä»£ç ï¼Œå…ˆæŠ“ä¸»å¹²ä»£ç ï¼Œä»æ•´ä½“ä¸Šç†è§£ä»£ç çš„æ‰§è¡Œæµç¨‹ï¼ˆå³ä¸‹è§’æ–‡ç« ç›®å½•è§†å›¾ä¸­å¯ä»¥ç‚¹å‡»è·³è½¬åˆ°ç›¸åº”ç« èŠ‚ï¼‰ï¼Œå¦åˆ™å°†ä¼šè¢«ç»†èŠ‚çš„ä»£ç æ‰°ä¹±æ€è·¯ã€‚æœ€åå¯ä»¥å›å¤´å¤šçœ‹å‡ éï¼Œè¿™æ—¶å€™å¦‚æœæœ‰éœ€è¦å¯ä»¥è¿½è¸ªä¸€äº›æå¹²ä»£ç ï¼Œåšåˆ°èä¼šè´¯é€šã€‚</p><a href=#1-launcher--ams><h1 id=1-launcher--ams><span class=hanchor arialabel=Anchor># </span>1. Launcher â€”â€” AMS</h1></a><a href=#11-è°ƒç”¨è¿‡ç¨‹åˆ†æ><h2 id=11-è°ƒç”¨è¿‡ç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>1.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ</h2></a><a href=#111-launcheronclick><h3 id=111-launcheronclick><span class=hanchor arialabel=Anchor># </span>1.1.1 Launcher.onClick</h3></a><p>åœ¨ Launcher app çš„ä¸» Activity â€”â€” Launcher.java ä¸­ï¼ŒApp å›¾æ ‡çš„ç‚¹å‡»äº‹ä»¶æœ€ç»ˆä¼šå›è°ƒ Launcher.java ä¸­çš„ onClick æ–¹æ³•ï¼Œ</p><p>[packages/apps/Launcher3/src/com/android/launcher3/Launcher.java](
<a href=https://android.googlesource.com/platform/packages/apps/Launcher3/ rel=noopener>https://android.googlesource.com/platform/packages/apps/Launcher3/</a> /nougat-release/src/com/android/launcher3/Launcher.java?autodive=0/)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=o>(</span><span class=n>View</span> <span class=n>v</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>v</span><span class=o>.</span><span class=na>getTag</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>ShortcutInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ä»å¿«æ·æ–¹å¼å›¾æ ‡å¯åŠ¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>onClickAppShortcut</span><span class=o>(</span><span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>FolderInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ–‡ä»¶å¤¹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>v</span> <span class=k>instanceof</span> <span class=n>FolderIcon</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>           <span class=n>onClickFolderIcon</span><span class=o>(</span><span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>v</span> <span class=o>==</span> <span class=n>mAllAppsButton</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// â€œæ‰€æœ‰åº”ç”¨â€æŒ‰é’®
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>onClickAllAppsButton</span><span class=o>(</span><span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>AppInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ä»â€œæ‰€æœ‰åº”ç”¨â€ä¸­å¯åŠ¨çš„åº”ç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startAppShortcutOrInfoActivity</span><span class=o>(</span><span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>LauncherAppWidgetInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç»„ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>v</span> <span class=k>instanceof</span> <span class=n>PendingAppWidgetHostView</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>onClickPendingWidget</span><span class=o>((</span><span class=n>PendingAppWidgetHostView</span><span class=o>)</span> <span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#112-launcheronclickappshortcut><h3 id=112-launcheronclickappshortcut><span class=hanchor arialabel=Anchor># </span>1.1.2 Launcher.onClickAppShortcut</h3></a><p>å¦‚æœæ˜¯å¿«æ·æ–¹å¼å›¾æ ‡ï¼Œåˆ™è°ƒç”¨ onClickAppShortcut æ–¹æ³•è¿›è€Œè°ƒç”¨ startAppShortcutOrInfoActivity æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Thunk</span> <span class=kt>void</span> <span class=nf>startAppShortcutOrInfoActivity</span><span class=o>(</span><span class=n>View</span> <span class=n>v</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>v</span><span class=o>.</span><span class=na>getTag</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ShortcutInfo</span> <span class=n>shortcut</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>ShortcutInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>shortcut</span> <span class=o>=</span> <span class=o>(</span><span class=n>ShortcutInfo</span><span class=o>)</span> <span class=n>tag</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å»é™¤å¯¹åº”çš„ Intent å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>intent</span> <span class=o>=</span> <span class=n>shortcut</span><span class=o>.</span><span class=na>intent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span><span class=o>[]</span> <span class=n>pos</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>int</span><span class=o>[</span><span class=n>2</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span><span class=o>.</span><span class=na>getLocationOnScreen</span><span class=o>(</span><span class=n>pos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=na>setSourceBounds</span><span class=o>(</span><span class=k>new</span> <span class=n>Rect</span><span class=o>(</span><span class=n>pos</span><span class=o>[</span><span class=n>0</span><span class=o>],</span> <span class=n>pos</span><span class=o>[</span><span class=n>1</span><span class=o>],</span>
</span></span><span class=line><span class=cl>                <span class=n>pos</span><span class=o>[</span><span class=n>0</span><span class=o>]</span> <span class=o>+</span> <span class=n>v</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span> <span class=n>pos</span><span class=o>[</span><span class=n>1</span><span class=o>]</span> <span class=o>+</span> <span class=n>v</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>AppInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>shortcut</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span> <span class=o>=</span> <span class=o>((</span><span class=n>AppInfo</span><span class=o>)</span> <span class=n>tag</span><span class=o>).</span><span class=na>intent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Input must be a Shortcut or AppInfo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒç”¨ startActivitySafely æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>success</span> <span class=o>=</span> <span class=n>startActivitySafely</span><span class=o>(</span><span class=n>v</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>tag</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mStats</span><span class=o>.</span><span class=na>recordLaunch</span><span class=o>(</span><span class=n>v</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>shortcut</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>success</span> <span class=o>&amp;&amp;</span> <span class=n>v</span> <span class=k>instanceof</span> <span class=n>BubbleTextView</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mWaitingForResume</span> <span class=o>=</span> <span class=o>(</span><span class=n>BubbleTextView</span><span class=o>)</span> <span class=n>v</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mWaitingForResume</span><span class=o>.</span><span class=na>setStayPressed</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#113-launcherstartactivity><h3 id=113-launcherstartactivity><span class=hanchor arialabel=Anchor># </span>1.1.3 Launcher.startActivity</h3></a><p>è·å–ç›¸åº” App çš„ Intent ä¿¡æ¯ä¹‹åï¼Œè°ƒç”¨ startActivity æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>View</span> <span class=n>v</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>Object</span> <span class=n>tag</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¯åŠ¨æ–°çš„ä»»åŠ¡æ ˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>intent</span><span class=o>.</span><span class=na>addFlags</span><span class=o>(</span><span class=n>Intent</span><span class=o>.</span><span class=na>FLAG_ACTIVITY_NEW_TASK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>user</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>user</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>UserHandleCompat</span><span class=o>.</span><span class=na>myUserHandle</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>StrictMode</span><span class=o>.</span><span class=na>VmPolicy</span> <span class=n>oldPolicy</span> <span class=o>=</span> <span class=n>StrictMode</span><span class=o>.</span><span class=na>getVmPolicy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>            
</span></span><span class=line><span class=cl>                <span class=n>StrictMode</span><span class=o>.</span><span class=na>setVmPolicy</span><span class=o>(</span><span class=k>new</span> <span class=n>StrictMode</span><span class=o>.</span><span class=na>VmPolicy</span><span class=o>.</span><span class=na>Builder</span><span class=o>().</span><span class=na>detectAll</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>penaltyLog</span><span class=o>().</span><span class=na>build</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è°ƒç”¨ Activity çš„ startActivity æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>startActivity</span><span class=o>(</span><span class=n>intent</span><span class=o>,</span> <span class=n>optsBundle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>StrictMode</span><span class=o>.</span><span class=na>setVmPolicy</span><span class=o>(</span><span class=n>oldPolicy</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>launcherApps</span><span class=o>.</span><span class=na>startActivityForProfile</span><span class=o>(</span><span class=n>intent</span><span class=o>.</span><span class=na>getComponent</span><span class=o>(),</span> <span class=n>user</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>intent</span><span class=o>.</span><span class=na>getSourceBounds</span><span class=o>(),</span> <span class=n>optsBundle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SecurityException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>      
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#114-activitystartactivity><h3 id=114-activitystartactivity><span class=hanchor arialabel=Anchor># </span>1.1.4 Activity.startActivity</h3></a><p>è¿™é‡Œæœ€ç»ˆè°ƒç”¨äº† Activity ä¸­çš„ startActivity æ–¹æ³•ï¼Œå¹¶ä¸”è®¾ç½® Flag ä¸º FLAG_ACTIVITY_NEW_TASKã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œå·²ç»è·Ÿå¯åŠ¨æ™®é€šçš„ Activity æµç¨‹æ±‡åˆèµ·æ¥äº†ï¼Œç»§ç»­å¾€ä¸‹åˆ†æã€‚</p><p>[frameworks/base/core/java/android/app/Activity.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/Activity.java)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ç¬¬äºŒä¸ªå‚æ•°ä¸º -1 è¡¨ç¤ºä¸éœ€è¦å›è°ƒ onActivityResult æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>options</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivityForResult</span><span class=o>(</span><span class=n>intent</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Note we want to go through this call for compatibility with
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// applications that may have overridden the method.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startActivityForResult</span><span class=o>(</span><span class=n>intent</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#115-activitystartactivityforresult><h3 id=115-activitystartactivityforresult><span class=hanchor arialabel=Anchor># </span>1.1.5 Activity.startActivityForResult</h3></a><p>è°ƒç”¨ Activity çš„ startActivityForResult æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>startActivityForResult</span><span class=o>(</span><span class=nd>@RequiresPermission</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=nd>@Nullable</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mParent æ˜¯å½“å‰ Activity çš„çˆ¶ç±»ï¼Œæ­¤æ—¶æ¡ä»¶æˆç«‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>mParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ Instrumentation çš„ execStartActivity æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Instrumentation</span><span class=o>.</span><span class=na>ActivityResult</span> <span class=n>ar</span> <span class=o>=</span> <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>execStartActivity</span><span class=o>(</span><span class=k>this</span><span class=o>,</span>
</span></span><span class=line><span class=cl>               <span class=n>mMainThread</span><span class=o>.</span><span class=na>getApplicationThread</span><span class=o>(),</span> <span class=n>mToken</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#116-instrumentationexecstartactivity><h3 id=116-instrumentationexecstartactivity><span class=hanchor arialabel=Anchor># </span>1.1.6 Instrumentation.execStartActivity</h3></a><p>[frameworks/base/core/java/android/app/Instrumentation.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/Instrumentation.java)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>ActivityResult</span> <span class=nf>execStartActivity</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Context</span> <span class=n>who</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>contextThread</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span> <span class=n>Activity</span> <span class=n>target</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=na>migrateExtraStreamToClipData</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=na>prepareToLeaveProcess</span><span class=o>(</span><span class=n>who</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è·å– AMS çš„ä»£ç†å¯¹è±¡å¹¶è°ƒç”¨å…¶ startActivity æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>startActivity</span><span class=o>(</span><span class=n>whoThread</span><span class=o>,</span> <span class=n>who</span><span class=o>.</span><span class=na>getBasePackageName</span><span class=o>(),</span> <span class=n>intent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>intent</span><span class=o>.</span><span class=na>resolveTypeIfNeeded</span><span class=o>(</span><span class=n>who</span><span class=o>.</span><span class=na>getContentResolver</span><span class=o>()),</span>
</span></span><span class=line><span class=cl>                    <span class=n>token</span><span class=o>,</span> <span class=n>target</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>target</span><span class=o>.</span><span class=na>mEmbeddedID</span> <span class=o>:</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>requestCode</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>checkStartActivityResult</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>intent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Failure from system&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#117-activitymanagerproxystartactivity><h3 id=117-activitymanagerproxystartactivity><span class=hanchor arialabel=Anchor># </span>1.1.7 ActivityManagerProxy.startActivity</h3></a><p>ä»¥ä¸Šè¿‡ç¨‹æ˜¯åœ¨ Launcher App æ‰€åœ¨çš„è¿›ç¨‹ä¸­å‘ç”Ÿçš„ï¼Œåœ¨æˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç« 
<a href=https://guanpj.cn/2017/08/13/Android-Binder-Apply/ rel=noopener>å€ŸåŠ© AIDL ç†è§£ Android Binder æœºåˆ¶â€”â€”AIDL çš„ä½¿ç”¨å’ŒåŸç†åˆ†æ</a>ä¸­æˆ‘ä»¬åˆ†æäº† AIDL çš„å®ç°è¿‡ç¨‹ï¼Œç”±äºè¿œç¨‹ Service è·Ÿä½¿ç”¨ Service çš„ Activity ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå› æ­¤ä»–ä»¬ä¹‹é—´äº¤äº’éœ€è¦é€šè¿‡ Binder IPC æœºåˆ¶çš„æ”¯æŒï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ Client é¦–å…ˆè·å–åˆ° Server ç«¯çš„ä»£ç†å¯¹è±¡ï¼Œåœ¨ Client çœ‹æ¥ Server ä»£ç†å¯¹è±¡åŒæ ·å…·æœ‰ Server æœ¬åœ°å¯¹è±¡æ‰¿è¯ºçš„èƒ½åŠ›ï¼Œå› æ­¤ Client å¯ä»¥è°ƒç”¨ Server ä»£ç†å¯¹è±¡è·Ÿ Sever æœ¬åœ°å¯¹è±¡è¿›è¡Œæ•°æ®äº¤äº’ï¼ŒBinder é©±åŠ¨ä½œä¸ºæ¡¥æ¢åœ¨ä»–ä»¬ä¸­é—´èµ·åˆ°ä¸­é—´äººçš„ä½œç”¨ã€‚</p><p>åŒæ ·ï¼Œåœ¨
<a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>Android ç³»ç»Ÿå¯åŠ¨æµç¨‹åˆ†æ</a>ä¸­æˆ‘ä»¬äº†è§£åˆ°ï¼ŒAMS æ˜¯è¿è¡Œåœ¨ system_server çº¿ç¨‹ä¸­çš„ï¼Œè¿™æ—¶ AMS å°±ç›¸å½“äº AIDL ä¸­çš„è¿œç¨‹ Serviceï¼ŒApp è¿›ç¨‹è¦ä¸ AMS äº¤äº’ï¼Œéœ€è¦é€šè¿‡ AMS çš„ä»£ç†å¯¹è±¡ AMP(ActivityManagerProxy) æ¥å®Œæˆï¼Œæ¥çœ‹ ActivityManagerNative.getDefault() æ‹¿åˆ°çš„æ˜¯ä»€ä¹ˆï¼š
[frameworks/base/core/java/android/app/ActivityManagerNative.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/ActivityManagerNative.java)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>public</span> <span class=n>IActivityManager</span> <span class=nf>getDefault</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>gDefault</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>getDefault æ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityManager</span><span class=o>&gt;</span> <span class=n>gDefault</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityManager</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>IActivityManager</span> <span class=nf>create</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å‘ ServiceManager æŸ¥è¯¢ä¸€ä¸ª key ä¸º &#34;activity&#34; çš„å¼•ç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>IBinder</span> <span class=n>b</span> <span class=o>=</span> <span class=n>ServiceManager</span><span class=o>.</span><span class=na>getService</span><span class=o>(</span><span class=s>&#34;activity&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=kc>false</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=s>&#34;ActivityManager&#34;</span><span class=o>,</span> <span class=s>&#34;default service binder = &#34;</span> <span class=o>+</span> <span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>IActivityManager</span> <span class=n>am</span> <span class=o>=</span> <span class=n>asInterface</span><span class=o>(</span><span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=kc>false</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=s>&#34;ActivityManager&#34;</span><span class=o>,</span> <span class=s>&#34;default service = &#34;</span> <span class=o>+</span> <span class=n>am</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>am</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span></code></pre></td></tr></table></div></div><p>åŒæ ·ï¼Œåœ¨æ–‡ç« 
<a href=https://guanpj.cn/2017/08/10/Android-Binder-Principle-Analyze/ rel=noopener>å€ŸåŠ© AIDL ç†è§£ Android Binder æœºåˆ¶â€”â€”Binder æ¥é¾™å»è„‰</a>ä¸­ä¹Ÿè®²åˆ°è¿‡ï¼š</p><blockquote><p>ServiceManager æ˜¯ Binder IPC é€šä¿¡è¿‡ç¨‹çš„æ ¸å¿ƒï¼Œæ˜¯ä¸Šä¸‹æ–‡çš„ç®¡ç†è€…ï¼ŒBinder æœåŠ¡ç«¯å¿…é¡»å…ˆå‘ ServerManager æ³¨å†Œæ‰èƒ½å¤Ÿä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼ŒBinder å®¢æˆ·ç«¯åœ¨ä¸æœåŠ¡ç«¯é€šä¿¡ä¹‹å‰éœ€è¦ä» ServerManager ä¸­æŸ¥æ‰¾å¹¶è·å– Binder æœåŠ¡ç«¯çš„å¼•ç”¨ã€‚</p></blockquote><p>è¿™é‡Œé€šè¿‡ &ldquo;activity&rdquo; è¿™ä¸ªåå­—å‘ ServiceManager æŸ¥è¯¢ AMS çš„å¼•ç”¨ï¼Œè·å– AMS çš„å¼•ç”¨åï¼Œè°ƒç”¨ asInterface æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>public</span> <span class=n>IActivityManager</span> <span class=nf>asInterface</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>obj</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>obj</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ® descriptor æŸ¥è¯¢ obj æ˜¯å¦ä¸º Binder æœ¬åœ°å¯¹è±¡ï¼Œå…·ä½“è¿‡ç¨‹è¯·çœ‹å‰æ–‡ä¸­æåˆ°çš„æ–‡ç« 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>IActivityManager</span> <span class=n>in</span> <span class=o>=</span> <span class=o>(</span><span class=n>IActivityManager</span><span class=o>)</span><span class=n>obj</span><span class=o>.</span><span class=na>queryLocalInterface</span><span class=o>(</span><span class=n>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>in</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>in</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœ obj ä¸æ˜¯ Binder æœ¬åœ°å¯¹è±¡ï¼Œåˆ™å°†å…¶åŒ…è£…æˆä»£ç†å¯¹è±¡å¹¶è¿”å›
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=n>ActivityManagerProxy</span><span class=o>(</span><span class=n>obj</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å› ä¸º AMS ä¸ Launcher App ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œè¿™é‡Œè¿”å›çš„ IBinder å¯¹è±¡æ˜¯ä¸€ä¸ª Binder ä»£ç†å¯¹è±¡ï¼Œå› æ­¤è¿™ç±»å°†å…¶åŒ…è£…æˆ AMP(ActivityManagerProxy) å¯¹è±¡å¹¶è¿”å›ï¼ŒAMP æ˜¯ AMN(ActivityManagerNative) çš„å†…éƒ¨ç±»ï¼ŒæŸ¥çœ‹ AMP ç±» ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ActivityManagerProxy</span> <span class=kd>implements</span> <span class=n>IActivityManager</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>ActivityManagerProxy</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>remote</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mRemote</span> <span class=o>=</span> <span class=n>remote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>IBinder</span> <span class=nf>asBinder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨å·ä¸º START_ACTIVITY_TRANSACTION
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>START_ACTIVITY_TRANSACTION</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>reply</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>ComponentName</span> <span class=nf>startService</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>service</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=kt>int</span> <span class=n>userId</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>START_SERVICE_TRANSACTION</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ComponentName</span> <span class=n>res</span> <span class=o>=</span> <span class=n>ComponentName</span><span class=o>.</span><span class=na>readFromParcel</span><span class=o>(</span><span class=n>reply</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒAMP é‡Œé¢å°†å®¢æˆ·ç«¯çš„è¯·æ±‚é€šè¿‡ mRemote.transact è¿›è¡Œè½¬å‘ï¼ŒmRemote å¯¹è±¡æ­£æ˜¯ Binder é©±åŠ¨è¿”å›æ¥çš„ Binder Proxy å¯¹è±¡ï¼Œé€šè¿‡ Binder Proxyï¼ŒBinder é©±åŠ¨æœ€ç»ˆå°†è°ƒç”¨å¤„äº Binder Server ç«¯ AMN ä¸­çš„ onTransact æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTransact</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ®æ–¹æ³•è°ƒç”¨å· code å†³å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=o>(</span><span class=n>code</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>START_ACTIVITY_TRANSACTION</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ startActivity æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>startActivity</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resultTo</span><span class=o>,</span> <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>START_SERVICE_TRANSACTION</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>ComponentName</span> <span class=n>cn</span> <span class=o>=</span> <span class=n>startService</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>service</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>userId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>ComponentName</span><span class=o>.</span><span class=na>writeToParcel</span><span class=o>(</span><span class=n>cn</span><span class=o>,</span> <span class=n>reply</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>AMN æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒçš„ startActivity ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°åœ¨ ActivityManagerService.java ä¸­ã€‚</p><a href=#118-activitymanagerservicestartactivity><h3 id=118-activitymanagerservicestartactivity><span class=hanchor arialabel=Anchor># </span>1.1.8 ActivityManagerService.startActivity</h3></a><p>[frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityManagerService.java)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ActivityManagerService</span> <span class=kd>extends</span> <span class=n>ActivityManagerNative</span>
</span></span><span class=line><span class=cl>        <span class=kd>implements</span> <span class=n>Watchdog</span><span class=o>.</span><span class=na>Monitor</span><span class=o>,</span> <span class=n>BatteryStatsImpl</span><span class=o>.</span><span class=na>BatteryCallback</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                   <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                   <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>bOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>startActivityAsUser</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>resultTo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>bOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>UserHandle</span><span class=o>.</span><span class=na>getCallingUserId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#12-å°ç»“><h2 id=12-å°ç»“><span class=hanchor arialabel=Anchor># </span>1.2 å°ç»“</h2></a><p>ä» Launcher App åˆ° AMS çš„è°ƒç”¨è¿‡ç¨‹ä¸­ä½¿ç”¨äº† Binder IPC æœºåˆ¶ï¼Œå¦‚æœä½ å·²ç»çœ‹äº†ä¸Šé¢æåˆ°çš„æˆ‘ä¹‹å‰å†™çš„ä¸¤ç¯‡æ–‡ç« â€”â€”
<a href=https://guanpj.cn/2017/08/10/Android-Binder-Principle-Analyze/ rel=noopener>å€ŸåŠ© AIDL ç†è§£ Android Binder æœºåˆ¶â€”â€”Binder æ¥é¾™å»è„‰</a>å’Œ
<a href=https://guanpj.cn/2017/08/13/Android-Binder-Apply/ rel=noopener>å€ŸåŠ© AIDL ç†è§£ Android Binder æœºåˆ¶â€”â€”AIDL çš„ä½¿ç”¨å’ŒåŸç†åˆ†æ</a>ï¼Œå¹¶ä¸”è¿è¡Œäº†æ–‡ç« ä¸­ä½¿ç”¨åˆ°çš„
<a href=https://github.com/guanpj/BinderDemo rel=noopener>Demo</a>ï¼Œä½ åº”è¯¥å¯ä»¥å‘ç°ï¼Œç›¸å¯¹äº AIDL çš„è°ƒç”¨è¿‡ç¨‹ï¼Œè°ƒç”¨æ–¹ Launcher App ç›¸å½“äº AIDL è¿‡ç¨‹ä¸­çš„ Activity æ‰€åœ¨çš„ Appï¼Œå……å½“ Clinent çš„è§’è‰²ï¼›AMS ç›¸å½“äºè¿œç¨‹ Service çš„è§’è‰²ï¼Œå……å½“ Server ç«¯è§’è‰²ï¼Œä»–ä»¬çš„è°ƒç”¨è¿‡ç¨‹æ€»ä½“ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>ä» Launcher App åˆ° AMS çš„æ—¶åºå›¾å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045438.png width=auto alt></p><a href=#2-ams--zygote><h1 id=2-ams--zygote><span class=hanchor arialabel=Anchor># </span>2. AMS â€”â€” zygote</h1></a><a href=#21-è°ƒç”¨è¿‡ç¨‹åˆ†æ><h2 id=21-è°ƒç”¨è¿‡ç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>2.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ</h2></a><a href=#211-activitymanagerservicestartactivityasuser><h3 id=211-activitymanagerservicestartactivityasuser><span class=hanchor arialabel=Anchor># </span>2.1.1 ActivityManagerService.startActivityAsUser</h3></a><p>æ¥ç€ä» AMS çš„ startActivityAsUser æ–¹æ³•å¼€å§‹åˆ†æï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>startActivityAsUser</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>bOptions</span><span class=o>,</span> <span class=kt>int</span> <span class=n>userId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enforceNotIsolatedCaller</span><span class=o>(</span><span class=s>&#34;startActivity&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>userId</span> <span class=o>=</span> <span class=n>mUserController</span><span class=o>.</span><span class=na>handleIncomingUser</span><span class=o>(</span><span class=n>Binder</span><span class=o>.</span><span class=na>getCallingPid</span><span class=o>(),</span> <span class=n>Binder</span><span class=o>.</span><span class=na>getCallingUid</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>userId</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=n>ALLOW_FULL_ONLY</span><span class=o>,</span> <span class=s>&#34;startActivity&#34;</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO: Switch to user app stacks here.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// è°ƒç”¨ ActivityStarter çš„ startActivityMayWait æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>mActivityStarter</span><span class=o>.</span><span class=na>startActivityMayWait</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>resolvedType</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>profilerInfo</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>bOptions</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=n>userId</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#212-activitystarterstartactivitymaywait><h3 id=212-activitystarterstartactivitymaywait><span class=hanchor arialabel=Anchor># </span>2.1.2 ActivityStarter.startActivityMayWait</h3></a><p>ç»§ç»­è·Ÿè¿› [frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStarter.java)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>int</span> <span class=nf>startActivityMayWait</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=kt>int</span> <span class=n>callingUid</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IVoiceInteractionSession</span> <span class=n>voiceSession</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span> <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>IActivityManager</span><span class=o>.</span><span class=na>WaitResult</span> <span class=n>outResult</span><span class=o>,</span> <span class=n>Configuration</span> <span class=n>config</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Bundle</span> <span class=n>bOptions</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>ignoreTargetSecurity</span><span class=o>,</span> <span class=kt>int</span> <span class=n>userId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IActivityContainer</span> <span class=n>iContainer</span><span class=o>,</span> <span class=n>TaskRecord</span> <span class=n>inTask</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span>
</span></span><span class=line><span class=cl>   <span class=kd>synchronized</span> <span class=o>(</span><span class=n>mService</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ startActivityLocked æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=n>startActivityLocked</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>ephemeralIntent</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>aInfo</span><span class=o>,</span> <span class=n>rInfo</span><span class=o>,</span> <span class=n>voiceSession</span><span class=o>,</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resultTo</span><span class=o>,</span> <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>callingPid</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>callingUid</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>realCallingPid</span><span class=o>,</span> <span class=n>realCallingUid</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>options</span><span class=o>,</span> <span class=n>ignoreTargetSecurity</span><span class=o>,</span> <span class=n>componentSpecified</span><span class=o>,</span> <span class=n>outRecord</span><span class=o>,</span> <span class=n>container</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>inTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#213-activitystarterstartactivitylocked><h3 id=213-activitystarterstartactivitylocked><span class=hanchor arialabel=Anchor># </span>2.1.3 ActivityStarter.startActivityLocked</h3></a><p>æŸ¥çœ‹ startActivityLocked æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>int</span> <span class=nf>startActivityLocked</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>ephemeralIntent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>ActivityInfo</span> <span class=n>aInfo</span><span class=o>,</span> <span class=n>ResolveInfo</span> <span class=n>rInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IVoiceInteractionSession</span> <span class=n>voiceSession</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span> <span class=kt>int</span> <span class=n>callingPid</span><span class=o>,</span> <span class=kt>int</span> <span class=n>callingUid</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=kt>int</span> <span class=n>realCallingPid</span><span class=o>,</span> <span class=kt>int</span> <span class=n>realCallingUid</span><span class=o>,</span> <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>ignoreTargetSecurity</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>componentSpecified</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ActivityRecord</span><span class=o>[]</span> <span class=n>outActivity</span><span class=o>,</span> <span class=n>ActivityStackSupervisor</span><span class=o>.</span><span class=na>ActivityContainer</span> <span class=n>container</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>TaskRecord</span> <span class=n>inTask</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒç”¨ doPendingActivityLaunchesLocked æ–¹æ³•ï¼Œä¼ å…¥ false å‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>doPendingActivityLaunchesLocked</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>err</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#214-activitystarterdopendingactivitylauncheslocked><h3 id=214-activitystarterdopendingactivitylauncheslocked><span class=hanchor arialabel=Anchor># </span>2.1.4 ActivityStarter.doPendingActivityLaunchesLocked</h3></a><p>æŸ¥çœ‹ doPendingActivityLaunchesLocked æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>doPendingActivityLaunchesLocked</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>doResume</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(!</span><span class=n>mPendingActivityLaunches</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>PendingActivityLaunch</span> <span class=n>pal</span> <span class=o>=</span> <span class=n>mPendingActivityLaunches</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>resume</span> <span class=o>=</span> <span class=n>doResume</span> <span class=o>&amp;&amp;</span> <span class=n>mPendingActivityLaunches</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è°ƒç”¨ startActivityUnchecked æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>startActivityUnchecked</span><span class=o>(</span><span class=n>pal</span><span class=o>.</span><span class=na>r</span><span class=o>,</span> <span class=n>pal</span><span class=o>.</span><span class=na>sourceRecord</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>pal</span><span class=o>.</span><span class=na>startFlags</span><span class=o>,</span> <span class=n>resume</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>postStartActivityUncheckedProcessing</span><span class=o>(</span><span class=n>pal</span><span class=o>.</span><span class=na>r</span><span class=o>,</span> <span class=n>result</span><span class=o>,</span> <span class=n>mSupervisor</span><span class=o>.</span><span class=na>mFocusedStack</span><span class=o>.</span><span class=na>mStackId</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>mSourceRecord</span><span class=o>,</span> <span class=n>mTargetStack</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Slog</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Exception during pending activity launch pal=&#34;</span> <span class=o>+</span> <span class=n>pal</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pal</span><span class=o>.</span><span class=na>sendErrorResult</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#215-activitystarterstartactivityunchecked><h3 id=215-activitystarterstartactivityunchecked><span class=hanchor arialabel=Anchor># </span>2.1.5 ActivityStarter.startActivityUnchecked</h3></a><p>æŸ¥çœ‹ startActivityUnchecked æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>startActivityUnchecked</span><span class=o>(</span><span class=kd>final</span> <span class=n>ActivityRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>ActivityRecord</span> <span class=n>sourceRecord</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IVoiceInteractionSession</span> <span class=n>voiceSession</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>doResume</span><span class=o>,</span> <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>,</span> <span class=n>TaskRecord</span> <span class=n>inTask</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒç”¨ ActivityStackSupervisor çš„ resumeFocusedStackTopActivityLocked æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mSupervisor</span><span class=o>.</span><span class=na>resumeFocusedStackTopActivityLocked</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=o>...</span> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>START_SUCCESS</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#216-activitystacksupervisorresumefocusedstacktopactivitylocked><h3 id=216-activitystacksupervisorresumefocusedstacktopactivitylocked><span class=hanchor arialabel=Anchor># </span>2.1.6 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</h3></a><p>[frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStackSupervisor.java)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>resumeFocusedStackTopActivityLocked</span><span class=o>(</span><span class=n>ActivityStack</span> <span class=n>targetStack</span><span class=o>,</span> <span class=n>ActivityRecord</span> <span class=n>target</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ActivityOptions</span> <span class=n>targetOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>targetStack</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>isFocusedStack</span><span class=o>(</span><span class=n>targetStack</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>targetStack</span><span class=o>.</span><span class=na>resumeTopActivityUncheckedLocked</span><span class=o>(</span><span class=n>target</span><span class=o>,</span> <span class=n>targetOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ActivityRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=n>mFocusedStack</span><span class=o>.</span><span class=na>topRunningActivityLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>r</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span> <span class=o>!=</span> <span class=n>RESUMED</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ ActivityStack çš„ resumeTopActivityUncheckedLocked æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mFocusedStack</span><span class=o>.</span><span class=na>resumeTopActivityUncheckedLocked</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#217-activitystackresumetopactivityuncheckedlocked><h3 id=217-activitystackresumetopactivityuncheckedlocked><span class=hanchor arialabel=Anchor># </span>2.1.7 ActivityStack.resumeTopActivityUncheckedLocked</h3></a><p>æŸ¥çœ‹ [ActivityStack](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStack.java) çš„ resumeTopActivityUncheckedLocked æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>resumeTopActivityUncheckedLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>prev</span><span class=o>,</span> <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ resumeTopActivityInnerLocked æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>result</span> <span class=o>=</span> <span class=n>resumeTopActivityInnerLocked</span><span class=o>(</span><span class=n>prev</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>inResumeTopActivity</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#218-activitystackresumetopactivityinnerlocked><h3 id=218-activitystackresumetopactivityinnerlocked><span class=hanchor arialabel=Anchor># </span>2.1.8 ActivityStack.resumeTopActivityInnerLocked</h3></a><p>æŸ¥çœ‹ resumeTopActivityInnerLocked æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>resumeTopActivityInnerLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>prev</span><span class=o>,</span> <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ActivityRecord</span> <span class=n>next</span> <span class=o>=</span> <span class=n>topRunningActivityLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>next</span><span class=o>.</span><span class=na>app</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>next</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>thread</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>DEBUG_STATES</span><span class=o>)</span> <span class=n>Slog</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG_STATES</span><span class=o>,</span> <span class=s>&#34;resumeTopActivityLocked: Restarting &#34;</span> <span class=o>+</span> <span class=n>next</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ ActivityStackSupervisor çš„ startSpecificActivityLocked æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>startSpecificActivityLocked</span><span class=o>(</span><span class=n>next</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>DEBUG_STACK</span><span class=o>)</span> <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>validateTopActivitiesLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#219-activitystacksupervisorstartspecificactivitylocked><h3 id=219-activitystacksupervisorstartspecificactivitylocked><span class=hanchor arialabel=Anchor># </span>2.1.9 ActivityStackSupervisor.startSpecificActivityLocked</h3></a><p>å›åˆ° ActivityStackSupervisor çš„ startSpecificActivityLocked æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>startSpecificActivityLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>r</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>andResume</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>checkConfig</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å½“å‰ Activity é™„å±çš„ Application
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ProcessRecord</span> <span class=n>app</span> <span class=o>=</span> <span class=n>mService</span><span class=o>.</span><span class=na>getProcessRecordLocked</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>processName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>.</span><span class=na>uid</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=na>task</span><span class=o>.</span><span class=na>stack</span><span class=o>.</span><span class=na>setLaunchTime</span><span class=o>(</span><span class=n>r</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœ Application å·²ç»è¿è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>app</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>app</span><span class=o>.</span><span class=na>thread</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span><span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>flags</span><span class=o>&amp;</span><span class=n>ActivityInfo</span><span class=o>.</span><span class=na>FLAG_MULTIPROCESS</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span>
</span></span><span class=line><span class=cl>                    <span class=o>||</span> <span class=o>!</span><span class=s>&#34;android&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>packageName</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>addPackage</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>packageName</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>.</span><span class=na>versionCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>mService</span><span class=o>.</span><span class=na>mProcessStats</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>realStartActivityLocked</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>app</span><span class=o>,</span> <span class=n>andResume</span><span class=o>,</span> <span class=n>checkConfig</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Slog</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Exception when starting activity &#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>.</span><span class=na>getComponent</span><span class=o>().</span><span class=na>flattenToShortString</span><span class=o>(),</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¯åŠ¨æ–°è¿›ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mService</span><span class=o>.</span><span class=na>startProcessLocked</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>processName</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;activity&#34;</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>.</span><span class=na>getComponent</span><span class=o>(),</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆï¼Œåœ¨æ–¹æ³•ä¸­è·å–äº†å½“å‰ Activity é™„å±çš„ Applicationï¼Œå¦‚æœå·²ç»åœ¨è¿è¡Œäº†ï¼Œè¯´æ˜è¿™ä¸ª App æ˜¯å·²ç»è¢«å¯åŠ¨è¿‡äº†çš„ï¼Œè¿™æ—¶å€™è°ƒç”¨ <strong>realStartActivityLocked</strong> æ–¹æ³•å°±å¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥çš„æµç¨‹äº†ï¼ŒåŒä¸€ä¸ª App ä¸­ä¸åŒ Activity çš„ç›¸äº’å¯åŠ¨å°±æ˜¯èµ°çš„è¿™ä¸ªæµç¨‹ã€‚å½“ Application æ²¡æœ‰è¿è¡Œçš„æ—¶å€™ï¼Œå°±éœ€è¦è°ƒç”¨ AMS çš„ startProcessLocked æ–¹æ³•å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å»æ‰¿è½½å®ƒç„¶åå®Œæˆåç»­çš„å·¥ä½œï¼Œé¡ºä¾¿é“ºå«ä¸€ä¸‹ï¼Œå½“æ–°è¿›ç¨‹è¢«å¯åŠ¨å®Œæˆåè¿˜ä¼šè°ƒç”¨å›åˆ°è¿™ä¸ªæ–¹æ³•ï¼ŒæŸ¥çœ‹ AMS çš„ startProcessLocked æ–¹æ³•ï¼š</p><a href=#2110-activitymanagerservicestartprocesslocked><h3 id=2110-activitymanagerservicestartprocesslocked><span class=hanchor arialabel=Anchor># </span>2.1.10 ActivityManagerService.startProcessLocked</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=n>ProcessRecord</span> <span class=nf>startProcessLocked</span><span class=o>(</span><span class=n>String</span> <span class=n>processName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ApplicationInfo</span> <span class=n>info</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>knownToBeDead</span><span class=o>,</span> <span class=kt>int</span> <span class=n>intentFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>hostingType</span><span class=o>,</span> <span class=n>ComponentName</span> <span class=n>hostingName</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>allowWhileBooting</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>isolated</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>keepIfLarge</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>startProcessLocked</span><span class=o>(</span><span class=n>processName</span><span class=o>,</span> <span class=n>info</span><span class=o>,</span> <span class=n>knownToBeDead</span><span class=o>,</span> <span class=n>intentFlags</span><span class=o>,</span> <span class=n>hostingType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>hostingName</span><span class=o>,</span> <span class=n>allowWhileBooting</span><span class=o>,</span> <span class=n>isolated</span><span class=o>,</span> <span class=n>0</span> <span class=cm>/* isolatedUid */</span><span class=o>,</span> <span class=n>keepIfLarge</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kc>null</span> <span class=cm>/* ABI override */</span><span class=o>,</span> <span class=kc>null</span> <span class=cm>/* entryPoint */</span><span class=o>,</span> <span class=kc>null</span> <span class=cm>/* entryPointArgs */</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kc>null</span> <span class=cm>/* crashHandler */</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2111-activitymanagerservicestartprocesslocked><h3 id=2111-activitymanagerservicestartprocesslocked><span class=hanchor arialabel=Anchor># </span>2.1.11 ActivityManagerService.startProcessLocked</h3></a><p>è°ƒç”¨ startProcessLocked æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=n>ProcessRecord</span> <span class=nf>startProcessLocked</span><span class=o>(</span><span class=n>String</span> <span class=n>processName</span><span class=o>,</span> <span class=n>ApplicationInfo</span> <span class=n>info</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>knownToBeDead</span><span class=o>,</span> <span class=kt>int</span> <span class=n>intentFlags</span><span class=o>,</span> <span class=n>String</span> <span class=n>hostingType</span><span class=o>,</span> <span class=n>ComponentName</span> <span class=n>hostingName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>allowWhileBooting</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isolated</span><span class=o>,</span> <span class=kt>int</span> <span class=n>isolatedUid</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>keepIfLarge</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>abiOverride</span><span class=o>,</span> <span class=n>String</span> <span class=n>entryPoint</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>entryPointArgs</span><span class=o>,</span> <span class=n>Runnable</span> <span class=n>crashHandler</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>startProcessLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>hostingType</span><span class=o>,</span> <span class=n>hostingNameStr</span><span class=o>,</span> <span class=n>abiOverride</span><span class=o>,</span> <span class=n>entryPoint</span><span class=o>,</span> <span class=n>entryPointArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>checkTime</span><span class=o>(</span><span class=n>startTime</span><span class=o>,</span> <span class=s>&#34;startProcess: done starting proc!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=n>app</span><span class=o>.</span><span class=na>pid</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>?</span> <span class=n>app</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2112-activitymanagerservicestartprocesslocked><h3 id=2112-activitymanagerservicestartprocesslocked><span class=hanchor arialabel=Anchor># </span>2.1.12 ActivityManagerService.startProcessLocked</h3></a><p>è°ƒç”¨ startProcessLocked çš„é‡è½½æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>startProcessLocked</span><span class=o>(</span><span class=n>ProcessRecord</span> <span class=n>app</span><span class=o>,</span> <span class=n>String</span> <span class=n>hostingType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>hostingNameStr</span><span class=o>,</span> <span class=n>String</span> <span class=n>abiOverride</span><span class=o>,</span> <span class=n>String</span> <span class=n>entryPoint</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>entryPointArgs</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ Process çš„ start æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Process</span><span class=o>.</span><span class=na>ProcessStartResult</span> <span class=n>startResult</span> <span class=o>=</span> <span class=n>Process</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=n>entryPoint</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>processName</span><span class=o>,</span> <span class=n>uid</span><span class=o>,</span> <span class=n>uid</span><span class=o>,</span> <span class=n>gids</span><span class=o>,</span> <span class=n>debugFlags</span><span class=o>,</span> <span class=n>mountExternal</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>targetSdkVersion</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>seinfo</span><span class=o>,</span> <span class=n>requiredAbi</span><span class=o>,</span> <span class=n>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>dataDir</span><span class=o>,</span> <span class=n>entryPointArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2113-processstart><h3 id=2113-processstart><span class=hanchor arialabel=Anchor># </span>2.1.13 Process.start</h3></a><p>[frameworks/base/services/core/java/android/os/Process.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/os/Process.java)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>ProcessStartResult</span> <span class=nf>start</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span> <span class=n>processClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kd>final</span> <span class=n>String</span> <span class=n>niceName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>uid</span><span class=o>,</span> <span class=kt>int</span> <span class=n>gid</span><span class=o>,</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>debugFlags</span><span class=o>,</span> <span class=kt>int</span> <span class=n>mountExternal</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>seInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>abi</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>appDataDir</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span><span class=o>[]</span> <span class=n>zygoteArgs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ startViaZygote æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>startViaZygote</span><span class=o>(</span><span class=n>processClass</span><span class=o>,</span> <span class=n>niceName</span><span class=o>,</span> <span class=n>uid</span><span class=o>,</span> <span class=n>gid</span><span class=o>,</span> <span class=n>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>debugFlags</span><span class=o>,</span> <span class=n>mountExternal</span><span class=o>,</span> <span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>seInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>abi</span><span class=o>,</span> <span class=n>instructionSet</span><span class=o>,</span> <span class=n>appDataDir</span><span class=o>,</span> <span class=n>zygoteArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ZygoteStartFailedEx</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>LOG_TAG</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;Starting VM process through Zygote failed&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;Starting VM process through Zygote failed&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2114-processstartviazygote><h3 id=2114-processstartviazygote><span class=hanchor arialabel=Anchor># </span>2.1.14 Process.startViaZygote</h3></a><p>æŸ¥çœ‹ startViaZygote æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>ProcessStartResult</span> <span class=nf>startViaZygote</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span> <span class=n>processClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kd>final</span> <span class=n>String</span> <span class=n>niceName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kd>final</span> <span class=kt>int</span> <span class=n>uid</span><span class=o>,</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>gid</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kd>final</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>debugFlags</span><span class=o>,</span> <span class=kt>int</span> <span class=n>mountExternal</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>seInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>abi</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>appDataDir</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span><span class=o>[]</span> <span class=n>extraArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                <span class=kd>throws</span> <span class=n>ZygoteStartFailedEx</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span><span class=o>(</span><span class=n>Process</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ zygoteSendArgsAndGetResult æ–¹æ³•ï¼Œä¼ å…¥ openZygoteSocketIfNeeded çš„è¿”å›å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>zygoteSendArgsAndGetResult</span><span class=o>(</span><span class=n>openZygoteSocketIfNeeded</span><span class=o>(</span><span class=n>abi</span><span class=o>),</span> <span class=n>argsForZygote</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2115-processzygotesendargsandgetresultprocessopenzygotesocketifneeded><h3 id=2115-processzygotesendargsandgetresultprocessopenzygotesocketifneeded><span class=hanchor arialabel=Anchor># </span>2.1.15 Process.zygoteSendArgsAndGetResultã€Process.openZygoteSocketIfNeeded</h3></a><p>æŸ¥çœ‹ zygoteSendArgsAndGetResult æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>ProcessStartResult</span> <span class=nf>zygoteSendArgsAndGetResult</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ZygoteState</span> <span class=n>zygoteState</span><span class=o>,</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>ZygoteStartFailedEx</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>BufferedWriter</span> <span class=n>writer</span> <span class=o>=</span> <span class=n>zygoteState</span><span class=o>.</span><span class=na>writer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>DataInputStream</span> <span class=n>inputStream</span> <span class=o>=</span> <span class=n>zygoteState</span><span class=o>.</span><span class=na>inputStream</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>Integer</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>args</span><span class=o>.</span><span class=na>size</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=na>newLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sz</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>arg</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>writer</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>arg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>writer</span><span class=o>.</span><span class=na>newLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=na>flush</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Should there be a timeout on this?
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ProcessStartResult</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ProcessStartResult</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// ç­‰å¾… socket æœåŠ¡ç«¯ï¼ˆå³zygoteï¼‰è¿”å›æ–°åˆ›å»ºçš„è¿›ç¨‹pid;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>result</span><span class=o>.</span><span class=na>pid</span> <span class=o>=</span> <span class=n>inputStream</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=na>usingWrapper</span> <span class=o>=</span> <span class=n>inputStream</span><span class=o>.</span><span class=na>readBoolean</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>pid</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=s>&#34;fork() failed&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>zygoteState</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ zygoteSendArgsAndGetResult ä¸­ç­‰å¾… Socket æœåŠ¡ç«¯ï¼Œä¹Ÿå°±æ˜¯ zygote è¿›ç¨‹è¿”å›åˆ›å»ºæ–°è¿›ç¨‹çš„ç»“æœï¼Œè¿™é‡Œ zygoteState å‚æ•°æ˜¯ç”± openZygoteSocketIfNeeded æ–¹æ³•è¿”å›çš„ï¼ŒopenZygoteSocketIfNeeded æ–¹æ³•åˆ™è´Ÿè´£æ ¹æ® abi å‘ Zygote è¿›ç¨‹å‘èµ·è¿æ¥è¯·æ±‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>ZygoteState</span> <span class=nf>openZygoteSocketIfNeeded</span><span class=o>(</span><span class=n>String</span> <span class=n>abi</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ZygoteStartFailedEx</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>primaryZygoteState</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>primaryZygoteState</span><span class=o>.</span><span class=na>isClosed</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å‘ä¸»zygoteå‘èµ·connect()æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>primaryZygoteState</span> <span class=o>=</span> <span class=n>ZygoteState</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=n>ZYGOTE_SOCKET</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ioe</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=s>&#34;Error connecting to primary zygote&#34;</span><span class=o>,</span> <span class=n>ioe</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>primaryZygoteState</span><span class=o>.</span><span class=na>matches</span><span class=o>(</span><span class=n>abi</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>primaryZygoteState</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>secondaryZygoteState</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>secondaryZygoteState</span><span class=o>.</span><span class=na>isClosed</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å½“ä¸»zygoteæ²¡èƒ½åŒ¹é…æˆåŠŸï¼Œåˆ™é‡‡ç”¨ç¬¬äºŒä¸ªzygoteï¼Œå‘èµ·connect()æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>secondaryZygoteState</span> <span class=o>=</span> <span class=n>ZygoteState</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=n>SECONDARY_ZYGOTE_SOCKET</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ioe</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=s>&#34;Error connecting to secondary zygote&#34;</span><span class=o>,</span> <span class=n>ioe</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>secondaryZygoteState</span><span class=o>.</span><span class=na>matches</span><span class=o>(</span><span class=n>abi</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>secondaryZygoteState</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=s>&#34;Unsupported zygote ABI: &#34;</span> <span class=o>+</span> <span class=n>abi</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#22-å°ç»“><h2 id=22-å°ç»“><span class=hanchor arialabel=Anchor># </span>2.2 å°ç»“</h2></a><p>å¦‚æœæ˜¯ä»æ¡Œé¢æ–°å¯åŠ¨ä¸€ä¸ª App ä¸­çš„ Activityï¼Œæ­¤æ—¶æ˜¯æ²¡æœ‰è¿›ç¨‹å»æ‰¿è½½è¿™ä¸ª App çš„ï¼Œå› æ­¤éœ€è¦é€šè¿‡ AMS å‘ zygote ç»§æ‰¿å‘èµ·è¯·æ±‚å»å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼ŒAMS è¿è¡Œåœ¨ system_server è¿›ç¨‹ä¸­ï¼Œå®ƒé€šè¿‡ Socket å‘ zygote å‘èµ· fock è¿›ç¨‹çš„è¯·æ±‚ï¼Œä» AMS å¼€å§‹çš„è°ƒç”¨æ—¶åºå›¾å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045449.png width=auto alt></p><a href=#3-zygote--activitythread><h1 id=3-zygote--activitythread><span class=hanchor arialabel=Anchor># </span>3. zygote â€”â€” ActivityThread</h1></a><a href=#31-è°ƒç”¨è¿‡ç¨‹åˆ†æ><h2 id=31-è°ƒç”¨è¿‡ç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>3.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ</h2></a><a href=#311-zygoteinitmain><h3 id=311-zygoteinitmain><span class=hanchor arialabel=Anchor># </span>3.1.1 ZygoteInit.main</h3></a><p>åœ¨
<a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>Android ç³»ç»Ÿå¯åŠ¨æµç¨‹åˆ†æ</a> æ–‡ä¸­æåˆ°è¿‡ zygote è¿›ç¨‹çš„å…¶ä¸­ä¸€é¡¹ä»»åŠ¡å°±æ˜¯ï¼š</p><blockquote><p>è°ƒç”¨ registerZygoteSocket() å‡½æ•°å»ºç«‹ Socket é€šé“ï¼Œä½¿ zygote è¿›ç¨‹æˆä¸º Socket æœåŠ¡ç«¯ï¼Œå¹¶é€šè¿‡ runSelectLoop() å‡½æ•°ç­‰å¾… ActivityManagerService å‘é€è¯·æ±‚åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</p></blockquote><p>zygote ç»ˆäºè¦å†æ¬¡ä¸Šåœºäº†ï¼æ¥ä¸‹æ¥ä» ZygoteInit.java çš„ main æ–¹æ³•å¼€å§‹å›é¡¾ä¸€ä¸‹ zygote è¿›ç¨‹çš„å·¥ä½œï¼š</p><p>[frameworks/base/core/java/com/android/internal/os/ZygoteInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteInit.java)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span> <span class=n>argv</span><span class=o>[])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>runSelectLoop</span><span class=o>(</span><span class=n>abiList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>....</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>MethodAndArgsCaller</span> <span class=n>caller</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>caller</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#312-zygoteinitrunselectloop><h3 id=312-zygoteinitrunselectloop><span class=hanchor arialabel=Anchor># </span>3.1.2 ZygoteInit.runSelectLoop</h3></a><p>æŸ¥çœ‹ runSelectLoop æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>runSelectLoop</span><span class=o>(</span><span class=n>String</span> <span class=n>abiList</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¾ªç¯è¯»å–çŠ¶æ€
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>pollFds</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>;</span> <span class=o>--</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è¯»å–çš„çŠ¶æ€ä¸æ˜¯å®¢æˆ·ç«¯è¿æ¥æˆ–è€…æ•°æ®è¯·æ±‚æ—¶ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>((</span><span class=n>pollFds</span><span class=o>[</span><span class=n>i</span><span class=o>].</span><span class=na>revents</span> <span class=o>&amp;</span> <span class=n>POLLIN</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span><span class=c1>// i = 0 è¡¨ç¤ºè·Ÿå®¢æˆ·ç«¯ Socket è¿æ¥ä¸Šäº†
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>ZygoteConnection</span> <span class=n>newPeer</span> <span class=o>=</span> <span class=n>acceptCommandPeer</span><span class=o>(</span><span class=n>abiList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>peers</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>newPeer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>fds</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>newPeer</span><span class=o>.</span><span class=na>getFileDesciptor</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span><span class=c1>// i &gt; 0 è¡¨ç¤ºæ¥æ”¶åˆ°å®¢æˆ·ç«¯ Socket å‘é€è¿‡æ¥çš„è¯·æ±‚
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// runOnce æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kt>boolean</span> <span class=n>done</span> <span class=o>=</span> <span class=n>peers</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>runOnce</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>done</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>peers</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>fds</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#313-zygoteconnectionrunonce><h3 id=313-zygoteconnectionrunonce><span class=hanchor arialabel=Anchor># </span>3.1.3 ZygoteConnection.runOnce</h3></a><p>æŸ¥çœ‹ [frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteConnection.java) çš„ runOnce æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>runOnce</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>args</span><span class=o>[];</span>
</span></span><span class=line><span class=cl>    <span class=n>Arguments</span> <span class=n>parsedArgs</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FileDescriptor</span><span class=o>[]</span> <span class=n>descriptors</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è¯»å– socket å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„å‚æ•°åˆ—è¡¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>args</span> <span class=o>=</span> <span class=n>readArgumentList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>descriptors</span> <span class=o>=</span> <span class=n>mSocket</span><span class=o>.</span><span class=na>getAncillaryFileDescriptors</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// EOF reached.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>closeSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å°† socket å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œè§£ææˆ Arguments å¯¹è±¡æ ¼å¼
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>parsedArgs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Arguments</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åŒæ ·è°ƒç”¨ Zygote.java çš„ forkAndSpecialize æ–¹æ³• fock å‡ºå­è¿›ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pid</span> <span class=o>=</span> <span class=n>Zygote</span><span class=o>.</span><span class=na>forkAndSpecialize</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>uid</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>gid</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>debugFlags</span><span class=o>,</span> <span class=n>rlimits</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>mountExternal</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>seInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span><span class=o>,</span> <span class=n>fdsToClose</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>appDataDir</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>pid</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å­è¿›ç¨‹æ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>serverPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverPipeFd</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è¿›å…¥å­è¿›ç¨‹æµç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>handleChildProc</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>,</span> <span class=n>descriptors</span><span class=o>,</span> <span class=n>childPipeFd</span><span class=o>,</span> <span class=n>newStderr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// çˆ¶è¿›ç¨‹æ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>childPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>childPipeFd</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>handleParentProc</span><span class=o>(</span><span class=n>pid</span><span class=o>,</span> <span class=n>descriptors</span><span class=o>,</span> <span class=n>serverPipeFd</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>childPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>serverPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#314-zygoteconnectionhandlechildproc><h3 id=314-zygoteconnectionhandlechildproc><span class=hanchor arialabel=Anchor># </span>3.1.4 ZygoteConnection.handleChildProc</h3></a><p>é¦–å…ˆè§£æ Socket å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„å‚æ•°ï¼Œ[Zygote.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/Zygote.java) çš„ forkAndSpecialize è¿”å›çš„ pid == 0 çš„æ—¶å€™è¡¨ç¤ºæ­¤æ—¶åœ¨ fock å‡ºæ¥çš„å­è¿›ç¨‹ä¸­æ‰§è¡Œï¼Œç»§ç»­è°ƒç”¨ handleChildProc æ–¹æ³•ï¼Œå¹¶å°†å‚æ•°ç»§ç»­å±‚å±‚ä¼ é€’ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleChildProc</span><span class=o>(</span><span class=n>Arguments</span> <span class=n>parsedArgs</span><span class=o>,</span> <span class=n>FileDescriptor</span><span class=o>[]</span> 
</span></span><span class=line><span class=cl>    <span class=n>descriptors</span><span class=o>,</span> <span class=n>FileDescriptor</span> <span class=n>pipeFd</span><span class=o>,</span> <span class=n>PrintStream</span> <span class=n>newStderr</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*ç”±äº fock å‡ºæ¥çš„ system_server è¿›ç¨‹ä¼šå¤åˆ¶ zygote è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå› æ­¤å®ƒä¹Ÿå¾—åˆ°äº† zygote
</span></span></span><span class=line><span class=cl><span class=cm>    è¿›ç¨‹ä¸­çš„ Socketï¼Œè¿™ä¸ª Socket å¯¹å®ƒæ¥è¯´å¹¶æ— ç”¨å¤„ï¼Œè¿™é‡Œå°†å…¶å…³é—­ 
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>    <span class=n>closeSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è®¾ç½®è¿›ç¨‹å
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Process</span><span class=o>.</span><span class=na>setArgV0</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>invokeWith</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ RuntimeInit çš„ zygoteInit æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>RuntimeInit</span><span class=o>.</span><span class=na>zygoteInit</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>targetSdkVersion</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>remainingArgs</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#315-runtimeinitzygoteinit><h3 id=315-runtimeinitzygoteinit><span class=hanchor arialabel=Anchor># </span>3.1.5 RuntimeInit.zygoteInit</h3></a><p>æŸ¥çœ‹ [frameworks/base/core/java/com/android/internal/os/RuntimeInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/RuntimeInit.java) çš„ zygoteInit æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>zygoteInit</span><span class=o>(</span><span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>DEBUG</span><span class=o>)</span> <span class=n>Slog</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;RuntimeInit: Starting application from zygote&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>,</span> <span class=s>&#34;RuntimeInit&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é‡å®šå‘ log è¾“å‡º
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>redirectLogStreams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆå§‹åŒ–ä¸€äº›é€šç”¨çš„è®¾ç½®
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>commonInit</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     *é€šè¿‡ Native å±‚ä¸­ AndroidRuntime.cpp çš„ JNI æ–¹æ³•æœ€ç»ˆè°ƒç”¨ app_main.cpp çš„ 
</span></span></span><span class=line><span class=cl><span class=cm>     *onZygoteInit æ–¹æ³•å¯åŠ¨ Binder çº¿ç¨‹æ± ï¼Œ ä½¿ system_server è¿›ç¨‹å¯ä»¥ä½¿ç”¨ Binder  *ä¸å…¶ä»–è¿›ç¨‹é€šä¿¡
</span></span></span><span class=line><span class=cl><span class=cm>     **/</span>
</span></span><span class=line><span class=cl>    <span class=n>nativeZygoteInit</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>    <span class=n>applicationInit</span><span class=o>(</span><span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>argv</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#316-runtimeinitapplicationinit><h3 id=316-runtimeinitapplicationinit><span class=hanchor arialabel=Anchor># </span>3.1.6 RuntimeInit.applicationInit</h3></a><p>ç»§ç»­è°ƒç”¨ applicationInit æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>applicationInit</span><span class=o>(</span><span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>,</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æå–å‡ºå‚æ•°é‡Œé¢çš„è¦å¯åŠ¨çš„ç±»çš„åå­—
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>invokeStaticMain</span><span class=o>(</span><span class=n>args</span><span class=o>.</span><span class=na>startClass</span><span class=o>,</span> <span class=n>args</span><span class=o>.</span><span class=na>startArgs</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#317-runtimeinitinvokestaticmain><h3 id=317-runtimeinitinvokestaticmain><span class=hanchor arialabel=Anchor># </span>3.1.7 RuntimeInit.invokeStaticMain</h3></a><p>ä¸»è¦è°ƒç”¨äº† invokeStaticMain æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>invokeStaticMain</span><span class=o>(</span><span class=n>String</span> <span class=n>className</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>,</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span>
</span></span><span class=line><span class=cl>         <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>cl</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/** className ä¸ºé€šè¿‡ Socket å®¢æˆ·ç«¯ï¼ˆAMSï¼‰ä¼ é€’è¿‡æ¥çš„ä¸€ç³»åˆ—å‚æ•°ä¸­çš„å…¶ä¸­ä¸€ä¸ªï¼Œè¿™é‡Œè·å–åˆ°çš„å€¼ä¸ºä¼ &#34;com.android.app.ActivityThread&#34;ï¼Œç„¶åé€šè¿‡åå°„å¾—åˆ° ActivityThread ç±» **/</span>
</span></span><span class=line><span class=cl>        <span class=n>cl</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>className</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ClassNotFoundException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Missing class when invoking static main &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Method</span> <span class=n>m</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ‰¾åˆ° ActivityThread ç±»çš„ main æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>m</span> <span class=o>=</span> <span class=n>cl</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(</span><span class=s>&#34;main&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>Class</span><span class=o>[]</span> <span class=o>{</span> <span class=n>String</span><span class=o>[].</span><span class=na>class</span> <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchMethodException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Missing static main on &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SecurityException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Problem getting static main on &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>modifiers</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span> <span class=o>(</span><span class=n>Modifier</span><span class=o>.</span><span class=na>isStatic</span><span class=o>(</span><span class=n>modifiers</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>isPublic</span><span class=o>(</span><span class=n>modifiers</span><span class=o>)))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Main method is not public and static on &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** å°† main æ–¹æ³•åŒ…è£…åœ¨ ZygoteInit.MethodAndArgsCaller ç±»ä¸­å¹¶ä½œä¸ºå¼‚å¸¸æŠ›å‡º
</span></span></span><span class=line><span class=cl><span class=cm>    æ•è·å¼‚å¸¸çš„åœ°æ–¹åœ¨ä¸Šä¸€å°èŠ‚ä¸­ ZygoteInit.java çš„ main æ–¹æ³• **/</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span><span class=o>(</span><span class=n>m</span><span class=o>,</span> <span class=n>argv</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#318-methodandargscallerrun><h3 id=318-methodandargscallerrun><span class=hanchor arialabel=Anchor># </span>3.1.8 MethodAndArgsCaller.run</h3></a><p>å›åˆ° ZygoteInit çš„ main æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span> <span class=n>argv</span><span class=o>[])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>MethodAndArgsCaller</span> <span class=n>caller</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ¥æ”¶åˆ° caller å¯¹è±¡åè°ƒç”¨å®ƒçš„ run æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>caller</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Zygote died with exception&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è·Ÿ system_server è¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹ä¸€æ ·ï¼Œè¿™é‡ŒåŒæ ·é€šè¿‡æŠ›å‡ºå¼‚å¸¸çš„æ–¹å¼æ¥æ¸…ç©ºè°ƒç”¨ ActivityThread.main ä¹‹å‰çš„æ–¹æ³•æ ˆå¸§ã€‚</p><p>ZygoteInit çš„ MethodAndArgsCaller ç±»æ˜¯ä¸€ä¸ª Exception ç±»ï¼ŒåŒæ—¶ä¹Ÿå®ç°äº† Runnable æ¥å£ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MethodAndArgsCaller</span> <span class=kd>extends</span> <span class=n>Exception</span>
</span></span><span class=line><span class=cl>        <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Method</span> <span class=n>mMethod</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>mArgs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>MethodAndArgsCaller</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mMethod</span> <span class=o>=</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mArgs</span> <span class=o>=</span> <span class=n>args</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è°ƒç”¨ä¼ é€’è¿‡æ¥çš„ mMethod
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mMethod</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[]</span> <span class=o>{</span> <span class=n>mArgs</span> <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IllegalAccessException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InvocationTargetException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#319-activitythread-main><h3 id=319-activitythread-main><span class=hanchor arialabel=Anchor># </span>3.1.9 ActivityThread .main</h3></a><p>æœ€åé€šè¿‡åå°„è°ƒç”¨åˆ° ActivityThread çš„ main æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Environment</span><span class=o>.</span><span class=na>initForCurrentUser</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Process</span><span class=o>.</span><span class=na>setArgV0</span><span class=o>(</span><span class=s>&#34;&lt;pre-initialized&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆ›å»ºä¸»çº¿ç¨‹ Looper
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Looper</span><span class=o>.</span><span class=na>prepareMainLooper</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ActivityThread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ActivityThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// attach åˆ°ç³»ç»Ÿè¿›ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>thread</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>sMainThreadHandler</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sMainThreadHandler</span> <span class=o>=</span> <span class=n>thread</span><span class=o>.</span><span class=na>getHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸»çº¿ç¨‹è¿›å…¥è½®è¯¢çŠ¶æ€
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Looper</span><span class=o>.</span><span class=na>loop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æŠ›å‡ºå¼‚å¸¸è¯´æ˜è½®è¯¢å‡ºç°é—®é¢˜
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Main thread loop unexpectedly exited&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#32-å°ç»“><h2 id=32-å°ç»“><span class=hanchor arialabel=Anchor># </span>3.2 å°ç»“</h2></a><p>zygote è¿›ç¨‹ä½œä¸º Socket æœåŠ¡ç«¯åœ¨æ¥æ”¶åˆ°ä½œä¸ºå®¢æˆ·ç«¯çš„ AMS å‘é€è¿‡æ¥çš„è¯·æ±‚å’Œå‚æ•°ä¹‹åï¼Œfock å‡ºæ–°çš„è¿›ç¨‹å¹¶æ ¹æ®å„ç§å‚æ•°è¿›ç¨‹äº†åˆå§‹åŒ–çš„å·¥ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹å’Œ zygote å¯åŠ¨ system_server è¿›ç¨‹çš„è¿‡ç¨‹å¦‚å‡ºä¸€è¾™ï¼Œæ—¶åºå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045452.png width=auto alt></p><a href=#4-activitythread--activity><h1 id=4-activitythread--activity><span class=hanchor arialabel=Anchor># </span>4. ActivityThread â€”â€” Activity</h1></a><a href=#41-è°ƒç”¨è¿‡ç¨‹åˆ†æ><h2 id=41-è°ƒç”¨è¿‡ç¨‹åˆ†æ><span class=hanchor arialabel=Anchor># </span>4.1 è°ƒç”¨è¿‡ç¨‹åˆ†æ</h2></a><a href=#411-activitythreadattach><h3 id=411-activitythreadattach><span class=hanchor arialabel=Anchor># </span>4.1.1 ActivityThread.attach</h3></a><p>ä¸Šä¸€å°èŠ‚çš„æœ€åï¼ŒActivityThread çš„ main é€šè¿‡åå°„è¢«è¿è¡Œèµ·æ¥äº†ï¼Œæ¥ç€ä¼šè°ƒç”¨ ActivityThread çš„ attach æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>attach</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>system</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>mSystemThread</span> <span class=o>=</span> <span class=n>system</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>system</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è·å– ActivityManagerProxy å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>final</span> <span class=n>IActivityManager</span> <span class=n>mgr</span> <span class=o>=</span> <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// é€šè¿‡ Binder è°ƒç”¨ AMS çš„ attachApplication æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mgr</span><span class=o>.</span><span class=na>attachApplication</span><span class=o>(</span><span class=n>mAppThread</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>ex</span><span class=o>.</span><span class=na>rethrowFromSystemServer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œï¼Œæˆ‘ä»¬å†ä¸€æ¬¡é€šè¿‡ Binder IPC æœºåˆ¶è·Ÿ AMS é€šä¿¡ï¼Œé€šä¿¡æ¨¡å‹è·Ÿå‰é¢ Launcher App è°ƒç”¨ AMS çš„ startActivity æ–¹æ³•ä¸€æ ·ï¼ŒgetDefault è¿‡ç¨‹ä¸é‡å¤åˆ†æï¼Œè¿™æ¬¡æ˜¯è°ƒç”¨äº† AMS çš„ attachApplication æ–¹æ³•ï¼Œæ³¨æ„è¿™é‡Œå°† ApplicationThead ç±»å‹çš„ mAppThread å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’äº†è¿‡å»ï¼ŒApplicationThead æ˜¯ ActivityThread çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œåé¢æˆ‘ä»¬ä¼šè®²åˆ°ï¼Œå…ˆæŸ¥çœ‹ AMP çš„ attachApplication æ–¹æ³•ï¼š</p><a href=#412-activitymanagerproxyattachapplication><h3 id=412-activitymanagerproxyattachapplication><span class=hanchor arialabel=Anchor># </span>4.1.2 ActivityManagerProxy.attachApplication</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>attachApplication</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>app</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒç”¨ asBinder æ–¹æ³•ä½¿å…¶èƒ½å¤Ÿè·¨è¿›ç¨‹ä¼ è¾“
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>data</span><span class=o>.</span><span class=na>writeStrongBinder</span><span class=o>(</span><span class=n>app</span><span class=o>.</span><span class=na>asBinder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é€šè¿‡ transact æ–¹æ³•å°†æ•°æ®äº¤ç»™ Binder é©±åŠ¨
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>ATTACH_APPLICATION_TRANSACTION</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span> 
</span></span><span class=line><span class=cl>    <span class=n>reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#413-activitymanagernativeontransact><h3 id=413-activitymanagernativeontransact><span class=hanchor arialabel=Anchor># </span>4.1.3 ActivityManagerNative.onTransact</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTransact</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>code</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>ATTACH_APPLICATION_TRANSACTION</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>.</span><span class=na>enforceInterface</span><span class=o>(</span><span class=n>IActivityManager</span><span class=o>.</span><span class=na>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è·å– ApplicationThread çš„ä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯ ApplicationThreadNative(ATN)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// çš„å†…éƒ¨ç±»ï¼šApplicationThreadProxy(ATP) å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>IApplicationThread</span> <span class=n>app</span> <span class=o>=</span> <span class=n>ApplicationThreadNative</span><span class=o>.</span><span class=na>asInterface</span><span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>readStrongBinder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>app</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// å§”æ‰˜ç»™ AMS æ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>attachApplication</span><span class=o>(</span><span class=n>app</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>asInterface å°† ActivityThread å¯¹è±¡è½¬æ¢æˆäº† [ApplicationThreadNative(ATN)](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/ActivityManagerNative.java) çš„ Binder ä»£ç†å¯¹è±¡ ApplicationThreadProxy(ATP)ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ ç»™ attachApplication æ–¹æ³•ï¼Œå…¶ä¸­ ATP æ˜¯ ATN çš„å†…éƒ¨ç±»ã€‚</p><a href=#414-activitymanagerserviceattachapplication><h3 id=414-activitymanagerserviceattachapplication><span class=hanchor arialabel=Anchor># </span>4.1.4 ActivityManagerService.attachApplication</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>attachApplication</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>thread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>callingPid</span> <span class=o>=</span> <span class=n>Binder</span><span class=o>.</span><span class=na>getCallingPid</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>long</span> <span class=n>origId</span> <span class=o>=</span> <span class=n>Binder</span><span class=o>.</span><span class=na>clearCallingIdentity</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>attachApplicationLocked</span><span class=o>(</span><span class=n>thread</span><span class=o>,</span> <span class=n>callingPid</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Binder</span><span class=o>.</span><span class=na>restoreCallingIdentity</span><span class=o>(</span><span class=n>origId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#415-activitymanagerserviceattachapplicationlocked><h3 id=415-activitymanagerserviceattachapplicationlocked><span class=hanchor arialabel=Anchor># </span>4.1.5 ActivityManagerService.attachApplicationLocked</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>attachApplicationLocked</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>thread</span><span class=o>,</span> <span class=kt>int</span> <span class=n>pid</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ProcessRecord</span> <span class=n>app</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç»‘å®šæ­»äº¡é€šçŸ¥
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>AppDeathRecipient</span> <span class=n>adr</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AppDeathRecipient</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>pid</span><span class=o>,</span> <span class=n>thread</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>asBinder</span><span class=o>().</span><span class=na>linkToDeath</span><span class=o>(</span><span class=n>adr</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>deathRecipient</span> <span class=o>=</span> <span class=n>adr</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>resetPackageList</span><span class=o>(</span><span class=n>mProcessStats</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¦‚æœ system_server è¿›ç¨‹æ­»äº¡åˆ™é‡æ–°å¯åŠ¨è¿›ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startProcessLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=s>&#34;link fail&#34;</span><span class=o>,</span> <span class=n>processName</span><span class=o>);</span> 
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è·å–åº”ç”¨appInfo
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ApplicationInfo</span> <span class=n>appInfo</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationInfo</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>                <span class=o>?</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationInfo</span> <span class=o>:</span> <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç»‘å®šåº”ç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>thread</span><span class=o>.</span><span class=na>bindApplication</span><span class=o>(</span><span class=n>processName</span><span class=o>,</span> <span class=n>appInfo</span><span class=o>,</span> <span class=n>providers</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationArguments</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationWatcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>instrumentationUiAutomationConnection</span><span class=o>,</span> <span class=n>testMode</span><span class=o>,</span> <span class=n>enableOpenGlTrace</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>isRestrictedBackupMode</span> <span class=o>||</span> <span class=o>!</span><span class=n>normalMode</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>persistent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>mConfiguration</span><span class=o>),</span> <span class=n>app</span><span class=o>.</span><span class=na>compat</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>getCommonServicesLocked</span><span class=o>(</span><span class=n>app</span><span class=o>.</span><span class=na>isolated</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=n>mCoreSettingsObserver</span><span class=o>.</span><span class=na>getCoreSettingsLocked</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>resetPackageList</span><span class=o>(</span><span class=n>mProcessStats</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>unlinkDeathRecipient</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// bindApplication å¤±è´¥ä¹Ÿè¦é‡å¯è¿›ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startProcessLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=s>&#34;bind fail&#34;</span><span class=o>,</span> <span class=n>processName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœæ˜¯ Activity: æ£€æŸ¥æœ€é¡¶å±‚å¯è§çš„Activityæ˜¯å¦ç­‰å¾…åœ¨è¯¥è¿›ç¨‹ä¸­è¿è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>normalMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>attachApplicationLocked</span><span class=o>(</span><span class=n>app</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>didSomething</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>badApp</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœæ˜¯ Service: å¯»æ‰¾æ‰€æœ‰éœ€è¦åœ¨è¯¥è¿›ç¨‹ä¸­è¿è¡Œçš„æœåŠ¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>badApp</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>didSomething</span> <span class=o>|=</span> <span class=n>mServices</span><span class=o>.</span><span class=na>attachApplicationLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>processName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>badApp</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœæ˜¯ BroadcastReceiver: æ£€æŸ¥æ˜¯å¦åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­æœ‰ä¸‹ä¸€ä¸ªå¹¿æ’­æ¥æ”¶è€…
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>badApp</span> <span class=o>&amp;&amp;</span> <span class=n>isPendingBroadcastProcessLocked</span><span class=o>(</span><span class=n>pid</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>didSomething</span> <span class=o>|=</span> <span class=n>sendPendingBroadcastsLocked</span><span class=o>(</span><span class=n>app</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>badApp</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥æ˜¯å¦åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­æœ‰ä¸‹ä¸€ä¸ª backup ä»£ç†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>badApp</span> <span class=o>&amp;&amp;</span> <span class=n>mBackupTarget</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mBackupTarget</span><span class=o>.</span><span class=na>appInfo</span><span class=o>.</span><span class=na>uid</span> <span class=o>==</span> <span class=n>app</span><span class=o>.</span><span class=na>uid</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ensurePackageDexOpt</span><span class=o>(</span><span class=n>mBackupTarget</span><span class=o>.</span><span class=na>appInfo</span><span class=o>.</span><span class=na>packageName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>thread</span><span class=o>.</span><span class=na>scheduleCreateBackupAgent</span><span class=o>(</span><span class=n>mBackupTarget</span><span class=o>.</span><span class=na>appInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>compatibilityInfoForPackageLocked</span><span class=o>(</span><span class=n>mBackupTarget</span><span class=o>.</span><span class=na>appInfo</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>mBackupTarget</span><span class=o>.</span><span class=na>backupMode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>badApp</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>badApp</span><span class=o>)</span> <span class=o>{</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// æ€æ‰ badApp
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>app</span><span class=o>.</span><span class=na>kill</span><span class=o>(</span><span class=s>&#34;error during init&#34;</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>handleAppDiedLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>didSomething</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ›´æ–° adj(ç»„ä»¶çš„æƒå€¼)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>updateOomAdjLocked</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆï¼Œé€šè¿‡ ATP ä½¿ç”¨ Binder å‘ ATN å‘èµ· bindApplication è¯·æ±‚ï¼Œç„¶åé€šè¿‡ normalMode å­—æ®µåˆ¤æ–­æ˜¯å¦ä¸º Activityï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œ ActivityStackSupervisor çš„ attachApplicationLocked æ–¹æ³•ã€‚</p><a href=#strong4151-activitythreadjavaapplicationthreadbindapplicationstrong><h4 id=strong4151-activitythreadjavaapplicationthreadbindapplicationstrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.1 ActivityThread.java::ApplicationThread.bindApplication</strong></h4></a><p>thread å¯¹è±¡ç±»å‹æ˜¯ ATPï¼Œé€šè¿‡ Binder é©±åŠ¨è°ƒåˆ°äº† ATN çš„æ–¹æ³•ï¼ŒATN æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒçš„å®ç°éƒ½å§”æ‰˜ç»™äº† ApplicationThread(è¿™è·Ÿ AMS è·Ÿ AMN çš„å…³ç³»ä¸€æ ·)ï¼ŒApplicationThread ä½œä¸º ActivityThread çš„å†…éƒ¨ç±»å­˜åœ¨ï¼Œå®ƒçš„ binderApplication æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>[ActivityThread.java::ApplicationThread](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/ActivityThread.java)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>bindApplication</span><span class=o>(</span><span class=n>String</span> <span class=n>processName</span><span class=o>,</span> <span class=n>ApplicationInfo</span> <span class=n>appInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>ProviderInfo</span><span class=o>&gt;</span> <span class=n>providers</span><span class=o>,</span> <span class=n>ComponentName</span> <span class=n>instrumentationName</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Bundle</span> <span class=n>instrumentationArgs</span><span class=o>,</span> <span class=n>IInstrumentationWatcher</span> <span class=n>instrumentationWatcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>IUiAutomationConnection</span> <span class=n>instrumentationUiConnection</span><span class=o>,</span> <span class=kt>int</span> <span class=n>debugMode</span><span class=o>,</span> <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>    <span class=n>enableOpenGlTrace</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isRestrictedBackupMode</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>persistent</span><span class=o>,</span> <span class=n>Configuration</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>,</span> <span class=n>CompatibilityInfo</span> <span class=n>compatInfo</span><span class=o>,</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>IBinder</span><span class=o>&gt;</span> <span class=n>services</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>coreSettings</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>services</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å°†servicesç¼“å­˜èµ·æ¥, å‡å°‘binderæ£€ç´¢æœåŠ¡çš„æ¬¡æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ServiceManager</span><span class=o>.</span><span class=na>initServiceCache</span><span class=o>(</span><span class=n>services</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å‘é€æ¶ˆæ¯ H.BIND_APPLICATION ç»™ Handler å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sendMessage</span><span class=o>(</span><span class=n>H</span><span class=o>.</span><span class=na>BIND_APPLICATION</span><span class=o>,</span> <span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>H æ˜¯ ActivityThread ä¸­çš„ä¸€ä¸ª Handler å¯¹è±¡ï¼Œç”¨äºå¤„ç†å‘é€è¿‡æ¥çš„å„ç§æ¶ˆæ¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>class</span> <span class=nc>H</span> <span class=kd>extends</span> <span class=n>Handler</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>BIND_APPLICATION</span>        <span class=o>=</span> <span class=n>110</span><span class=o>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>BIND_APPLICATION</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>,</span> <span class=s>&#34;bindApplication&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>AppBindData</span> <span class=n>data</span> <span class=o>=</span> <span class=o>(</span><span class=n>AppBindData</span><span class=o>)</span><span class=n>msg</span><span class=o>.</span><span class=na>obj</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>handleBindApplication</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è°ƒç”¨äº† handleBindApplication æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleBindApplication</span><span class=o>(</span><span class=n>AppBindData</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å– LoadedApk å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>data</span><span class=o>.</span><span class=na>info</span> <span class=o>=</span> <span class=n>getPackageInfoNoCheck</span><span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>appInfo</span><span class=o>,</span> <span class=n>data</span><span class=o>.</span><span class=na>compatInfo</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆ›å»º ContextImpl ä¸Šä¸‹æ–‡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>ContextImpl</span> <span class=n>appContext</span> <span class=o>=</span> <span class=n>ContextImpl</span><span class=o>.</span><span class=na>createAppContext</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>data</span><span class=o>.</span><span class=na>info</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆ›å»º Instrumentation å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>instrumentationName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mInstrumentation</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Instrumentation</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ LoadedApk çš„ makeApplication æ–¹æ³•åˆ›å»º Application
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Application</span> <span class=n>app</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>makeApplication</span><span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>restrictedBackupMode</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mInitialApplication</span> <span class=o>=</span> <span class=n>app</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>onCreate</span><span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>instrumentationArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è°ƒç”¨ Application.onCreate æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callApplicationOnCreate</span><span class=o>(</span><span class=n>app</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>StrictMode</span><span class=o>.</span><span class=na>setThreadPolicy</span><span class=o>(</span><span class=n>savedPolicy</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong4152-activitystacksupervisorattachapplicationlockedstrong><h4 id=strong4152-activitystacksupervisorattachapplicationlockedstrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2 ActivityStackSupervisor.attachApplicationLocked</strong></h4></a><p>åœ¨ <strong>4.1.4</strong> å°èŠ‚ä¸­é€šè¿‡ Binder å‘ ActivityThread å‘èµ· bindApplication è¯·æ±‚åï¼Œä¼šæ ¹æ®å¯åŠ¨ç»„ä»¶çš„ç±»å‹å»åšç›¸åº”çš„å¤„ç†ï¼Œå¦‚æœæ˜¯ Acitivityï¼Œåˆ™ä¼šè°ƒç”¨ ActivityStackSupervisor çš„ attachApplicationLocked æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>attachApplicationLocked</span><span class=o>(</span><span class=n>ProcessRecord</span> <span class=n>app</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>String</span> <span class=n>processName</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=na>processName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>didSomething</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>displayNdx</span> <span class=o>=</span> <span class=n>mActivityDisplays</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>;</span> <span class=n>displayNdx</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>;</span> <span class=o>--</span><span class=n>displayNdx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ActivityStack</span><span class=o>&gt;</span> <span class=n>stacks</span> <span class=o>=</span> <span class=n>mActivityDisplays</span><span class=o>.</span><span class=na>valueAt</span><span class=o>(</span><span class=n>displayNdx</span><span class=o>).</span><span class=na>mStacks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>stackNdx</span> <span class=o>=</span> <span class=n>stacks</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>;</span> <span class=n>stackNdx</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>;</span> <span class=o>--</span><span class=n>stackNdx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>ActivityStack</span> <span class=n>stack</span> <span class=o>=</span> <span class=n>stacks</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>stackNdx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(!</span><span class=n>isFrontStack</span><span class=o>(</span><span class=n>stack</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è·å–å‰å°stackä¸­æ ˆé¡¶ç¬¬ä¸€ä¸ªé finishing çŠ¶æ€çš„ Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ActivityRecord</span> <span class=n>hr</span> <span class=o>=</span> <span class=n>stack</span><span class=o>.</span><span class=na>topRunningActivityLocked</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>hr</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>hr</span><span class=o>.</span><span class=na>app</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>app</span><span class=o>.</span><span class=na>uid</span> <span class=o>==</span> <span class=n>hr</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>.</span><span class=na>uid</span> <span class=o>&amp;&amp;</span> <span class=n>processName</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>hr</span><span class=o>.</span><span class=na>processName</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// çœŸæ­£çš„å¯åŠ¨ Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>realStartActivityLocked</span><span class=o>(</span><span class=n>hr</span><span class=o>,</span> <span class=n>app</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>true</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>didSomething</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>didSomething</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong41521-activitystacksupervisorrealstartactivitylockedstrong><h5 id=strong41521-activitystacksupervisorrealstartactivitylockedstrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.1 ActivityStackSupervisor.realStartActivityLocked</strong></h5></a><p>å‰é¢ <strong>2.1.8 ActivityStackSupervisor.startSpecificActivityLocked</strong> å°èŠ‚ä¸­åˆ†æè¿‡ï¼Œå¦‚æœå½“å‰ Activity ä¾é™„çš„ Application å·²ç»è¢«å¯åŠ¨ï¼Œåˆ™è°ƒç”¨ realStartActivityLocked æ–¹æ³•ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼Œå†åˆ›å»ºæ–°çš„è¿›ç¨‹ä¹‹åï¼Œä¸¤ä¸ªæµç¨‹çš„åœ¨è¿™é‡Œåˆå¹¶èµ·æ¥äº†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>realStartActivityLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>ProcessRecord</span> <span class=n>app</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>andResume</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>checkConfig</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ActivityStack</span> <span class=n>stack</span> <span class=o>=</span> <span class=n>task</span><span class=o>.</span><span class=na>stack</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>forceProcessStateUpTo</span><span class=o>(</span><span class=n>mService</span><span class=o>.</span><span class=na>mTopProcessState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// é€šè¿‡ Binder è°ƒç”¨ ApplicationThread çš„ scheduleLaunchActivity æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>app</span><span class=o>.</span><span class=na>thread</span><span class=o>.</span><span class=na>scheduleLaunchActivity</span><span class=o>(</span><span class=k>new</span> <span class=n>Intent</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>),</span> <span class=n>r</span><span class=o>.</span><span class=na>appToken</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>identityHashCode</span><span class=o>(</span><span class=n>r</span><span class=o>),</span> <span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>,</span> <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>mService</span><span class=o>.</span><span class=na>mConfiguration</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>stack</span><span class=o>.</span><span class=na>mOverrideConfig</span><span class=o>),</span> <span class=n>r</span><span class=o>.</span><span class=na>compat</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>launchedFromPackage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>task</span><span class=o>.</span><span class=na>voiceInteractor</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>repProcState</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>icicle</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>persistentState</span><span class=o>,</span> <span class=n>results</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>newIntents</span><span class=o>,</span> <span class=o>!</span><span class=n>andResume</span><span class=o>,</span> <span class=n>mService</span><span class=o>.</span><span class=na>isNextTransitionForward</span><span class=o>(),</span> <span class=n>profilerInfo</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>launchFailed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ç¬¬äºŒæ¬¡å¯åŠ¨å¤±è´¥ï¼Œåˆ™ç»“æŸè¯¥ Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mService</span><span class=o>.</span><span class=na>appDiedLocked</span><span class=o>(</span><span class=n>app</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>stack</span><span class=o>.</span><span class=na>requestFinishActivityLocked</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>appToken</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;2nd-crash&#34;</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç¬¬ä¸€ä¸ªå¯åŠ¨å¤±è´¥ï¼Œåˆ™é‡å¯è¿›ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>app</span><span class=o>.</span><span class=na>activities</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>r</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œæœ‰ä¸€æ¬¡ä½¿ç”¨ Binder è°ƒç”¨ ApplicationThread çš„ scheduleLaunchActivity æ–¹æ³•ã€‚</p><a href=#strong41522-applicationthreadschedulelaunchactivitystrong><h5 id=strong41522-applicationthreadschedulelaunchactivitystrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.2 ApplicationThread.scheduleLaunchActivity</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>scheduleLaunchActivity</span><span class=o>(</span><span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span> <span class=kt>int</span> <span class=n>ident</span><span class=o>,</span> <span class=n>ActivityInfo</span> 
</span></span><span class=line><span class=cl>        <span class=n>info</span><span class=o>,</span> <span class=n>Configuration</span> <span class=n>curConfig</span><span class=o>,</span> <span class=n>Configuration</span> <span class=n>overrideConfig</span><span class=o>,</span> <span class=n>CompatibilityInfo</span> 
</span></span><span class=line><span class=cl>        <span class=n>compatInfo</span><span class=o>,</span> <span class=n>String</span> <span class=n>referrer</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span> <span class=kt>int</span> <span class=n>procState</span><span class=o>,</span> <span class=n>Bundle</span> 
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=o>,</span> <span class=n>PersistableBundle</span> <span class=n>persistentState</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ResultInfo</span><span class=o>&gt;</span> <span class=n>pendingResults</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>ReferrerIntent</span><span class=o>&gt;</span> <span class=n>pendingNewIntents</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>notResumed</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isForward</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>updateProcessState</span><span class=o>(</span><span class=n>procState</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ActivityClientRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ActivityClientRecord</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>sendMessage</span><span class=o>(</span><span class=n>H</span><span class=o>.</span><span class=na>LAUNCH_ACTIVITY</span><span class=o>,</span> <span class=n>r</span><span class=o>);</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢æåˆ°è¿‡ï¼ŒH æ˜¯ ActivityThread ä¸­ä¸€ä¸ª Handler ç±»ï¼Œå®ƒæ¥æ”¶åˆ° LAUNCH_ACTIVITY æ¶ˆæ¯åä¼šè°ƒç”¨ handleLaunchActivity æ–¹æ³•ã€‚</p><a href=#strong41523-activitythreadhandlelaunchactivitystrong><h5 id=strong41523-activitythreadhandlelaunchactivitystrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.3 ActivityThread.handleLaunchActivity</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleLaunchActivity</span><span class=o>(</span><span class=n>ActivityClientRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>customIntent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆå§‹åŒ– WMS
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WindowManagerGlobal</span><span class=o>.</span><span class=na>initialize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰§è¡Œ performLaunchActivity æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Activity</span> <span class=n>a</span> <span class=o>=</span> <span class=n>performLaunchActivity</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>customIntent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=na>createdConfig</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>mConfiguration</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Bundle</span> <span class=n>oldState</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ‰§è¡Œ handleResumeActivity æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ onStart å’Œ onResume æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>handleResumeActivity</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>isForward</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>startsNotResumed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>startsNotResumed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mCalled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callActivityOnPause</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>paused</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åœæ­¢è¯¥ Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>finishActivity</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong41424-applicationthreadperformlaunchactivitystrong><h5 id=strong41424-applicationthreadperformlaunchactivitystrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.4.2.4 ApplicationThread.performLaunchActivity</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>Activity</span> <span class=nf>performLaunchActivity</span><span class=o>(</span><span class=n>ActivityClientRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>customIntent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Activity</span> <span class=n>activity</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassLoader</span> <span class=n>cl</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>packageInfo</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Instrumentation ä¸­ä½¿ç”¨åå°„åˆ›å»º Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>activity</span> <span class=o>=</span> <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>newActivity</span><span class=o>(</span><span class=n>cl</span><span class=o>,</span> <span class=n>component</span><span class=o>.</span><span class=na>getClassName</span><span class=o>(),</span> <span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åˆ›å»º Application å¯¹è±¡å¹¶è°ƒç”¨ Application çš„ onCreate æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Application</span> <span class=n>app</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>packageInfo</span><span class=o>.</span><span class=na>makeApplication</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=n>mInstrumentation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>activity</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=n>Window</span> <span class=n>window</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>mPendingRemoveWindow</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>mPreserveWindow</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>window</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>mPendingRemoveWindow</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=na>mPendingRemoveWindow</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=na>mPendingRemoveWindowManager</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// attach åˆ° Window ä¸Š
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>activity</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=n>appContext</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>getInstrumentation</span><span class=o>(),</span> <span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>r</span><span class=o>.</span><span class=na>ident</span><span class=o>,</span> <span class=n>app</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>activityInfo</span><span class=o>,</span> <span class=n>title</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>parent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>r</span><span class=o>.</span><span class=na>embeddedID</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>lastNonConfigurationInstances</span><span class=o>,</span> <span class=n>config</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>r</span><span class=o>.</span><span class=na>referrer</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>voiceInteractor</span><span class=o>,</span> <span class=n>window</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>customIntent</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>activity</span><span class=o>.</span><span class=na>mIntent</span> <span class=o>=</span> <span class=n>customIntent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>lastNonConfigurationInstances</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>activity</span><span class=o>.</span><span class=na>mStartedActivity</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>theme</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activityInfo</span><span class=o>.</span><span class=na>getThemeResource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>theme</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è®¾ç½®ä¸»é¢˜
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>activity</span><span class=o>.</span><span class=na>setTheme</span><span class=o>(</span><span class=n>theme</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>activity</span><span class=o>.</span><span class=na>mCalled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>isPersistable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// é‡æ–°åˆ›å»ºçš„ Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callActivityOnCreate</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>persistentState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// ç¬¬ä¸€æ¬¡åˆ›å»ºçš„ Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callActivityOnCreate</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>  <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>activity</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong41525-instrumentationcallactivityoncreatestrong><h5 id=strong41525-instrumentationcallactivityoncreatestrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.5 Instrumentation.callActivityOnCreate</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>callActivityOnCreate</span><span class=o>(</span><span class=n>Activity</span> <span class=n>activity</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>icicle</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>PersistableBundle</span> <span class=n>persistentState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>prePerformCreate</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒç”¨ Activity çš„ performCreate æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>activity</span><span class=o>.</span><span class=na>performCreate</span><span class=o>(</span><span class=n>icicle</span><span class=o>,</span> <span class=n>persistentState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>postPerformCreate</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong41526-activityperformcreatestrong><h5 id=strong41526-activityperformcreatestrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.6 Activity.performCreate</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>performCreate</span><span class=o>(</span><span class=n>Bundle</span> <span class=n>icicle</span><span class=o>,</span> <span class=n>PersistableBundle</span> <span class=n>persistentState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>restoreHasCurrentPermissionRequest</span><span class=o>(</span><span class=n>icicle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>onCreate</span><span class=o>(</span><span class=n>icicle</span><span class=o>,</span> <span class=n>persistentState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mActivityTransitionState</span><span class=o>.</span><span class=na>readState</span><span class=o>(</span><span class=n>icicle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>performCreateCommon</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»ˆäºï¼ŒonCreate æ–¹æ³•è¢«è°ƒç”¨äº†ï¼ï¼ï¼</p><a href=#42-å°ç»“><h2 id=42-å°ç»“><span class=hanchor arialabel=Anchor># </span>4.2 å°ç»“</h2></a><p>ä» ActivityThread åˆ°æœ€ç»ˆ Activity è¢«åˆ›å»ºåŠç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨ï¼Œæ ¸å¿ƒè¿‡ç¨‹æ¶‰åŠåˆ°äº†ä¸‰æ¬¡ Binder IPC è¿‡ç¨‹ï¼Œåˆ†åˆ«æ˜¯ï¼šActivityThread è°ƒç”¨ AMS çš„ attachApplication æ–¹æ³•ã€AMS è°ƒç”¨ ApplicationThread çš„ bindApplication æ–¹æ³•ã€ASS è°ƒç”¨ Application çš„ attachApplicationLocked æ–¹æ³•ï¼Œæ•´ä¸ªè¿‡ç¨‹çš„æ—¶åºå›¾å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045420.png width=auto alt></p><a href=#5-æ€»ç»“><h1 id=5-æ€»ç»“><span class=hanchor arialabel=Anchor># </span>5. æ€»ç»“</h1></a><p>çºµè§‚æ•´ä¸ªè¿‡ç¨‹ï¼Œä» Launcher åˆ° AMSã€ä» AMS å†åˆ° Zygoteã€å†ä» Zygote åˆ° ActivityThreadï¼Œæœ€ååœ¨ ActivitThread ä¸­å±‚å±‚è°ƒç”¨åˆ° Activity çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä¸­é—´æ¶‰åŠåˆ°äº†æ— æ•°çš„ç»†èŠ‚ï¼Œä½†æ€»ä½“ä¸Šè„‰ç»œè¿˜æ˜¯éå¸¸æ¸…æ™°çš„ï¼Œå„ä¸ª Android ç‰ˆæœ¬çš„ Framework å±‚ä»£ç å¯ä»¥æŸäº›è¿‡ç¨‹çš„å®ç°ä¸å¤ªä¸€æ ·ï¼Œä½†æ˜¯æ•´ä¸ªè°ƒç”¨æµç¨‹å¤§ä½“ä¸Šä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œå€Ÿç”¨
<a href=http://gityuan.com/android/ rel=noopener>Gityuan</a> å¤§ç¥çš„ä¸€å¼ å›¾ä½œä¸ºç»“å°¾ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045430.png width=auto alt></p><p><strong>ç³»åˆ—æ–‡ç« </strong></p><p><a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>æŒ‰ä¸‹ç”µæºé”®åç«Ÿç„¶å‘ç”Ÿäº†è¿™ä¸€å¹• â€”â€” Android ç³»ç»Ÿå¯åŠ¨æµç¨‹åˆ†æ</a></p><p><a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App ç«Ÿç„¶æ˜¯è¿™æ ·è·‘èµ·æ¥çš„ â€”â€” Android App/Activity å¯åŠ¨æµç¨‹åˆ†æ</a>ï¼ˆæœ¬æ–‡ï¼‰</p><p><a href=https://guanpj.cn/2017/11/09/Android-View-Workflow/ rel=noopener>å±å¹•ä¸Šå†…å®¹ç©¶ç«Ÿæ˜¯æ€æ ·ç”»å‡ºæ¥çš„ â€”â€” Android View å·¥ä½œåŸç†è¯¦è§£</a></p><p><strong>å‚è€ƒæ–‡ç« </strong></p><p><a href=http://gityuan.com/2016/03/12/start-activity/ rel=noopener>startActivity å¯åŠ¨è¿‡ç¨‹åˆ†æ</a></p><p><a href=http://liuwangshu.cn/framework/component/1-activity-start-1.html rel=noopener>Android æ·±å…¥å››å¤§ç»„ä»¶ï¼ˆä¸€ï¼‰åº”ç”¨ç¨‹åºå¯åŠ¨è¿‡ç¨‹ï¼ˆå‰ç¯‡ï¼‰</a></p><blockquote><p>å¦‚æœä½ å¯¹æ–‡ç« å†…å®¹æœ‰ç–‘é—®æˆ–è€…æœ‰ä¸åŒçš„æ„è§ï¼Œæ¬¢è¿ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€åŒæ¢è®¨ã€‚</p></blockquote></article><hr><div class=page-end id=footer><div class=fixed-right><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></div></div></body></html>