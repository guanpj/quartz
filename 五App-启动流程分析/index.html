<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="在我的上一篇文章 Android 系统启动流程分析中，我们分析了系统在开机以后的一系列行为，其中最后一阶段 AMS(ActivityManagerService) 会启动 Launcher 来展示我们手机中所有已安装的应用图标，点击图标后相应的应用程序将会被系统启动运行并展示在我们面前，那么，点击了图标之后系统道理做了哪些工作呢？应用进程是怎么被启动的呢？Activity 的生命周期是什么时候被谁调用的呢？本文将继续基于 Android Nougat 的 frameworks 层源码的解答这些问题。
阅读建议：
如果你是首次阅读这个过程的源码，建议你忽略一些细枝末节的代码，先抓主干代码，从整体上理解代码的执行流程（右下角文章目录视图中可以点击跳转到相应章节），否则将会被细节的代码扰乱思路。最后可以回头多看几遍，这时候如果有需要可以追踪一些枝干代码，做到融会贯通。
1. Launcher —— AMS 1.1 调用过程分析 1."><meta property="og:title" content="五、App 启动流程分析"><meta property="og:description" content="在我的上一篇文章 Android 系统启动流程分析中，我们分析了系统在开机以后的一系列行为，其中最后一阶段 AMS(ActivityManagerService) 会启动 Launcher 来展示我们手机中所有已安装的应用图标，点击图标后相应的应用程序将会被系统启动运行并展示在我们面前，那么，点击了图标之后系统道理做了哪些工作呢？应用进程是怎么被启动的呢？Activity 的生命周期是什么时候被谁调用的呢？本文将继续基于 Android Nougat 的 frameworks 层源码的解答这些问题。
阅读建议：
如果你是首次阅读这个过程的源码，建议你忽略一些细枝末节的代码，先抓主干代码，从整体上理解代码的执行流程（右下角文章目录视图中可以点击跳转到相应章节），否则将会被细节的代码扰乱思路。最后可以回头多看几遍，这时候如果有需要可以追踪一些枝干代码，做到融会贯通。
1. Launcher —— AMS 1.1 调用过程分析 1."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="五、App 启动流程分析"><meta name=twitter:description content="在我的上一篇文章 Android 系统启动流程分析中，我们分析了系统在开机以后的一系列行为，其中最后一阶段 AMS(ActivityManagerService) 会启动 Launcher 来展示我们手机中所有已安装的应用图标，点击图标后相应的应用程序将会被系统启动运行并展示在我们面前，那么，点击了图标之后系统道理做了哪些工作呢？应用进程是怎么被启动的呢？Activity 的生命周期是什么时候被谁调用的呢？本文将继续基于 Android Nougat 的 frameworks 层源码的解答这些问题。
阅读建议：
如果你是首次阅读这个过程的源码，建议你忽略一些细枝末节的代码，先抓主干代码，从整体上理解代码的执行流程（右下角文章目录视图中可以点击跳转到相应章节），否则将会被细节的代码扰乱思路。最后可以回头多看几遍，这时候如果有需要可以追踪一些枝干代码，做到融会贯通。
1. Launcher —— AMS 1.1 调用过程分析 1."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>五、App 启动流程分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.4c3ebbd971971c16df2dee22b7632aef.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.7fe6218ad14878dfbc3737ff901810c4.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.c07b772b30c71ceeb1916b92ce09a6f9.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><div class=row><div class=col-md-3 id=toc><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#1-launcher--ams>1. Launcher —— AMS</a><ol><li><a href=#11-调用过程分析>1.1 调用过程分析</a><ol><li><a href=#111-launcheronclick>1.1.1 Launcher.onClick</a></li><li><a href=#112-launcheronclickappshortcut>1.1.2 Launcher.onClickAppShortcut</a></li><li><a href=#113-launcherstartactivity>1.1.3 Launcher.startActivity</a></li><li><a href=#114-activitystartactivity>1.1.4 Activity.startActivity</a></li><li><a href=#115-activitystartactivityforresult>1.1.5 Activity.startActivityForResult</a></li><li><a href=#116-instrumentationexecstartactivity>1.1.6 Instrumentation.execStartActivity</a></li><li><a href=#117-activitymanagerproxystartactivity>1.1.7 ActivityManagerProxy.startActivity</a></li><li><a href=#118-activitymanagerservicestartactivity>1.1.8 ActivityManagerService.startActivity</a></li></ol></li><li><a href=#12-小结>1.2 小结</a></li></ol></li><li><a href=#2-ams--zygote>2. AMS —— zygote</a><ol><li><a href=#21-调用过程分析>2.1 调用过程分析</a><ol><li><a href=#211-activitymanagerservicestartactivityasuser>2.1.1 ActivityManagerService.startActivityAsUser</a></li><li><a href=#212-activitystarterstartactivitymaywait>2.1.2 ActivityStarter.startActivityMayWait</a></li><li><a href=#213-activitystarterstartactivitylocked>2.1.3 ActivityStarter.startActivityLocked</a></li><li><a href=#214-activitystarterdopendingactivitylauncheslocked>2.1.4 ActivityStarter.doPendingActivityLaunchesLocked</a></li><li><a href=#215-activitystarterstartactivityunchecked>2.1.5 ActivityStarter.startActivityUnchecked</a></li><li><a href=#216-activitystacksupervisorresumefocusedstacktopactivitylocked>2.1.6 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</a></li><li><a href=#217-activitystackresumetopactivityuncheckedlocked>2.1.7 ActivityStack.resumeTopActivityUncheckedLocked</a></li><li><a href=#218-activitystackresumetopactivityinnerlocked>2.1.8 ActivityStack.resumeTopActivityInnerLocked</a></li><li><a href=#219-activitystacksupervisorstartspecificactivitylocked>2.1.9 ActivityStackSupervisor.startSpecificActivityLocked</a></li><li><a href=#2110-activitymanagerservicestartprocesslocked>2.1.10 ActivityManagerService.startProcessLocked</a></li><li><a href=#2111-activitymanagerservicestartprocesslocked>2.1.11 ActivityManagerService.startProcessLocked</a></li><li><a href=#2112-activitymanagerservicestartprocesslocked>2.1.12 ActivityManagerService.startProcessLocked</a></li><li><a href=#2113-processstart>2.1.13 Process.start</a></li><li><a href=#2114-processstartviazygote>2.1.14 Process.startViaZygote</a></li><li><a href=#2115-processzygotesendargsandgetresultprocessopenzygotesocketifneeded>2.1.15 Process.zygoteSendArgsAndGetResult、Process.openZygoteSocketIfNeeded</a></li></ol></li><li><a href=#22-小结>2.2 小结</a></li></ol></li><li><a href=#3-zygote--activitythread>3. zygote —— ActivityThread</a><ol><li><a href=#31-调用过程分析>3.1 调用过程分析</a><ol><li><a href=#311-zygoteinitmain>3.1.1 ZygoteInit.main</a></li><li><a href=#312-zygoteinitrunselectloop>3.1.2 ZygoteInit.runSelectLoop</a></li><li><a href=#313-zygoteconnectionrunonce>3.1.3 ZygoteConnection.runOnce</a></li><li><a href=#314-zygoteconnectionhandlechildproc>3.1.4 ZygoteConnection.handleChildProc</a></li><li><a href=#315-runtimeinitzygoteinit>3.1.5 RuntimeInit.zygoteInit</a></li><li><a href=#316-runtimeinitapplicationinit>3.1.6 RuntimeInit.applicationInit</a></li><li><a href=#317-runtimeinitinvokestaticmain>3.1.7 RuntimeInit.invokeStaticMain</a></li><li><a href=#318-methodandargscallerrun>3.1.8 MethodAndArgsCaller.run</a></li><li><a href=#319-activitythread-main>3.1.9 ActivityThread .main</a></li></ol></li><li><a href=#32-小结>3.2 小结</a></li></ol></li><li><a href=#4-activitythread--activity>4. ActivityThread —— Activity</a><ol><li><a href=#41-调用过程分析>4.1 调用过程分析</a><ol><li><a href=#411-activitythreadattach>4.1.1 ActivityThread.attach</a></li><li><a href=#412-activitymanagerproxyattachapplication>4.1.2 ActivityManagerProxy.attachApplication</a></li><li><a href=#413-activitymanagernativeontransact>4.1.3 ActivityManagerNative.onTransact</a></li><li><a href=#414-activitymanagerserviceattachapplication>4.1.4 ActivityManagerService.attachApplication</a></li><li><a href=#415-activitymanagerserviceattachapplicationlocked>4.1.5 ActivityManagerService.attachApplicationLocked</a><ol><li><a href=#strong4151-activitythreadjavaapplicationthreadbindapplicationstrong><strong>4.1.5.1 ActivityThread.java::ApplicationThread.bindApplication</strong></a></li><li><a href=#strong4152-activitystacksupervisorattachapplicationlockedstrong><strong>4.1.5.2 ActivityStackSupervisor.attachApplicationLocked</strong></a><ol><li><a href=#strong41521-activitystacksupervisorrealstartactivitylockedstrong><strong>4.1.5.2.1 ActivityStackSupervisor.realStartActivityLocked</strong></a></li><li><a href=#strong41522-applicationthreadschedulelaunchactivitystrong><strong>4.1.5.2.2 ApplicationThread.scheduleLaunchActivity</strong></a></li><li><a href=#strong41523-activitythreadhandlelaunchactivitystrong><strong>4.1.5.2.3 ActivityThread.handleLaunchActivity</strong></a></li><li><a href=#strong41424-applicationthreadperformlaunchactivitystrong><strong>4.1.4.2.4 ApplicationThread.performLaunchActivity</strong></a></li><li><a href=#strong41525-instrumentationcallactivityoncreatestrong><strong>4.1.5.2.5 Instrumentation.callActivityOnCreate</strong></a></li><li><a href=#strong41526-activityperformcreatestrong><strong>4.1.5.2.6 Activity.performCreate</strong></a></li></ol></li></ol></li></ol></li><li><a href=#42-小结>4.2 小结</a></li></ol></li><li><a href=#5-总结>5. 总结</a></li></ol></nav></details></aside></div><div class=col-md-9><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>五、App 启动流程分析</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/zygote/>Zygote</a></li><li><a href=https://www.guanpj.top/tags/AMS/>Ams</a></li><li><a href=https://www.guanpj.top/tags/ActivityThread/>Activity thread</a></li><li><a href=https://www.guanpj.top/tags/Framework/>Framework</a></li></ul><p>在我的上一篇文章
<a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>Android 系统启动流程分析</a>中，我们分析了系统在开机以后的一系列行为，其中最后一阶段 AMS(ActivityManagerService) 会启动 Launcher 来展示我们手机中所有已安装的应用图标，点击图标后相应的应用程序将会被系统启动运行并展示在我们面前，那么，点击了图标之后系统道理做了哪些工作呢？应用进程是怎么被启动的呢？Activity 的生命周期是什么时候被谁调用的呢？本文将继续基于 Android Nougat 的 frameworks 层源码的解答这些问题。</p><p><strong>阅读建议：</strong></p><p>如果你是首次阅读这个过程的源码，建议你忽略一些细枝末节的代码，先抓主干代码，从整体上理解代码的执行流程（右下角文章目录视图中可以点击跳转到相应章节），否则将会被细节的代码扰乱思路。最后可以回头多看几遍，这时候如果有需要可以追踪一些枝干代码，做到融会贯通。</p><a href=#1-launcher--ams><h1 id=1-launcher--ams><span class=hanchor arialabel=Anchor># </span>1. Launcher —— AMS</h1></a><a href=#11-调用过程分析><h2 id=11-调用过程分析><span class=hanchor arialabel=Anchor># </span>1.1 调用过程分析</h2></a><a href=#111-launcheronclick><h3 id=111-launcheronclick><span class=hanchor arialabel=Anchor># </span>1.1.1 Launcher.onClick</h3></a><p>在 Launcher app 的主 Activity —— Launcher.java 中，App 图标的点击事件最终会回调 Launcher.java 中的 onClick 方法，</p><p>[packages/apps/Launcher3/src/com/android/launcher3/Launcher.java](
<a href=https://android.googlesource.com/platform/packages/apps/Launcher3/ rel=noopener>https://android.googlesource.com/platform/packages/apps/Launcher3/</a> /nougat-release/src/com/android/launcher3/Launcher.java?autodive=0/)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=o>(</span><span class=n>View</span> <span class=n>v</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>v</span><span class=o>.</span><span class=na>getTag</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>ShortcutInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 从快捷方式图标启动
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>onClickAppShortcut</span><span class=o>(</span><span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>FolderInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 文件夹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>v</span> <span class=k>instanceof</span> <span class=n>FolderIcon</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>           <span class=n>onClickFolderIcon</span><span class=o>(</span><span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>v</span> <span class=o>==</span> <span class=n>mAllAppsButton</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// “所有应用”按钮
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>onClickAllAppsButton</span><span class=o>(</span><span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>AppInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 从“所有应用”中启动的应用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startAppShortcutOrInfoActivity</span><span class=o>(</span><span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>LauncherAppWidgetInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 组件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>v</span> <span class=k>instanceof</span> <span class=n>PendingAppWidgetHostView</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>onClickPendingWidget</span><span class=o>((</span><span class=n>PendingAppWidgetHostView</span><span class=o>)</span> <span class=n>v</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#112-launcheronclickappshortcut><h3 id=112-launcheronclickappshortcut><span class=hanchor arialabel=Anchor># </span>1.1.2 Launcher.onClickAppShortcut</h3></a><p>如果是快捷方式图标，则调用 onClickAppShortcut 方法进而调用 startAppShortcutOrInfoActivity 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Thunk</span> <span class=kt>void</span> <span class=nf>startAppShortcutOrInfoActivity</span><span class=o>(</span><span class=n>View</span> <span class=n>v</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>v</span><span class=o>.</span><span class=na>getTag</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ShortcutInfo</span> <span class=n>shortcut</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>ShortcutInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>shortcut</span> <span class=o>=</span> <span class=o>(</span><span class=n>ShortcutInfo</span><span class=o>)</span> <span class=n>tag</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 去除对应的 Intent 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>intent</span> <span class=o>=</span> <span class=n>shortcut</span><span class=o>.</span><span class=na>intent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span><span class=o>[]</span> <span class=n>pos</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>int</span><span class=o>[</span><span class=n>2</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span><span class=o>.</span><span class=na>getLocationOnScreen</span><span class=o>(</span><span class=n>pos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=na>setSourceBounds</span><span class=o>(</span><span class=k>new</span> <span class=n>Rect</span><span class=o>(</span><span class=n>pos</span><span class=o>[</span><span class=n>0</span><span class=o>],</span> <span class=n>pos</span><span class=o>[</span><span class=n>1</span><span class=o>],</span>
</span></span><span class=line><span class=cl>                <span class=n>pos</span><span class=o>[</span><span class=n>0</span><span class=o>]</span> <span class=o>+</span> <span class=n>v</span><span class=o>.</span><span class=na>getWidth</span><span class=o>(),</span> <span class=n>pos</span><span class=o>[</span><span class=n>1</span><span class=o>]</span> <span class=o>+</span> <span class=n>v</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>tag</span> <span class=k>instanceof</span> <span class=n>AppInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>shortcut</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span> <span class=o>=</span> <span class=o>((</span><span class=n>AppInfo</span><span class=o>)</span> <span class=n>tag</span><span class=o>).</span><span class=na>intent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Input must be a Shortcut or AppInfo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 startActivitySafely 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>boolean</span> <span class=n>success</span> <span class=o>=</span> <span class=n>startActivitySafely</span><span class=o>(</span><span class=n>v</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>tag</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mStats</span><span class=o>.</span><span class=na>recordLaunch</span><span class=o>(</span><span class=n>v</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>shortcut</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>success</span> <span class=o>&amp;&amp;</span> <span class=n>v</span> <span class=k>instanceof</span> <span class=n>BubbleTextView</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mWaitingForResume</span> <span class=o>=</span> <span class=o>(</span><span class=n>BubbleTextView</span><span class=o>)</span> <span class=n>v</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mWaitingForResume</span><span class=o>.</span><span class=na>setStayPressed</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#113-launcherstartactivity><h3 id=113-launcherstartactivity><span class=hanchor arialabel=Anchor># </span>1.1.3 Launcher.startActivity</h3></a><p>获取相应 App 的 Intent 信息之后，调用 startActivity 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>View</span> <span class=n>v</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>Object</span> <span class=n>tag</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 启动新的任务栈
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>intent</span><span class=o>.</span><span class=na>addFlags</span><span class=o>(</span><span class=n>Intent</span><span class=o>.</span><span class=na>FLAG_ACTIVITY_NEW_TASK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>user</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>user</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>UserHandleCompat</span><span class=o>.</span><span class=na>myUserHandle</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>StrictMode</span><span class=o>.</span><span class=na>VmPolicy</span> <span class=n>oldPolicy</span> <span class=o>=</span> <span class=n>StrictMode</span><span class=o>.</span><span class=na>getVmPolicy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>            
</span></span><span class=line><span class=cl>                <span class=n>StrictMode</span><span class=o>.</span><span class=na>setVmPolicy</span><span class=o>(</span><span class=k>new</span> <span class=n>StrictMode</span><span class=o>.</span><span class=na>VmPolicy</span><span class=o>.</span><span class=na>Builder</span><span class=o>().</span><span class=na>detectAll</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>penaltyLog</span><span class=o>().</span><span class=na>build</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 调用 Activity 的 startActivity 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>startActivity</span><span class=o>(</span><span class=n>intent</span><span class=o>,</span> <span class=n>optsBundle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>StrictMode</span><span class=o>.</span><span class=na>setVmPolicy</span><span class=o>(</span><span class=n>oldPolicy</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>launcherApps</span><span class=o>.</span><span class=na>startActivityForProfile</span><span class=o>(</span><span class=n>intent</span><span class=o>.</span><span class=na>getComponent</span><span class=o>(),</span> <span class=n>user</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>intent</span><span class=o>.</span><span class=na>getSourceBounds</span><span class=o>(),</span> <span class=n>optsBundle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SecurityException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>      
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#114-activitystartactivity><h3 id=114-activitystartactivity><span class=hanchor arialabel=Anchor># </span>1.1.4 Activity.startActivity</h3></a><p>这里最终调用了 Activity 中的 startActivity 方法，并且设置 Flag 为 FLAG_ACTIVITY_NEW_TASK。到此为止，已经跟启动普通的 Activity 流程汇合起来了，继续往下分析。</p><p>[frameworks/base/core/java/android/app/Activity.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/Activity.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 第二个参数为 -1 表示不需要回调 onActivityResult 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>options</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivityForResult</span><span class=o>(</span><span class=n>intent</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Note we want to go through this call for compatibility with
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// applications that may have overridden the method.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startActivityForResult</span><span class=o>(</span><span class=n>intent</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#115-activitystartactivityforresult><h3 id=115-activitystartactivityforresult><span class=hanchor arialabel=Anchor># </span>1.1.5 Activity.startActivityForResult</h3></a><p>调用 Activity 的 startActivityForResult 方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>startActivityForResult</span><span class=o>(</span><span class=nd>@RequiresPermission</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=nd>@Nullable</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mParent 是当前 Activity 的父类，此时条件成立
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>mParent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 Instrumentation 的 execStartActivity 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Instrumentation</span><span class=o>.</span><span class=na>ActivityResult</span> <span class=n>ar</span> <span class=o>=</span> <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>execStartActivity</span><span class=o>(</span><span class=k>this</span><span class=o>,</span>
</span></span><span class=line><span class=cl>               <span class=n>mMainThread</span><span class=o>.</span><span class=na>getApplicationThread</span><span class=o>(),</span> <span class=n>mToken</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#116-instrumentationexecstartactivity><h3 id=116-instrumentationexecstartactivity><span class=hanchor arialabel=Anchor># </span>1.1.6 Instrumentation.execStartActivity</h3></a><p>[frameworks/base/core/java/android/app/Instrumentation.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/Instrumentation.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>ActivityResult</span> <span class=nf>execStartActivity</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Context</span> <span class=n>who</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>contextThread</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span> <span class=n>Activity</span> <span class=n>target</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=na>migrateExtraStreamToClipData</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=na>prepareToLeaveProcess</span><span class=o>(</span><span class=n>who</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取 AMS 的代理对象并调用其 startActivity 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>startActivity</span><span class=o>(</span><span class=n>whoThread</span><span class=o>,</span> <span class=n>who</span><span class=o>.</span><span class=na>getBasePackageName</span><span class=o>(),</span> <span class=n>intent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>intent</span><span class=o>.</span><span class=na>resolveTypeIfNeeded</span><span class=o>(</span><span class=n>who</span><span class=o>.</span><span class=na>getContentResolver</span><span class=o>()),</span>
</span></span><span class=line><span class=cl>                    <span class=n>token</span><span class=o>,</span> <span class=n>target</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>target</span><span class=o>.</span><span class=na>mEmbeddedID</span> <span class=o>:</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>requestCode</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>checkStartActivityResult</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>intent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Failure from system&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#117-activitymanagerproxystartactivity><h3 id=117-activitymanagerproxystartactivity><span class=hanchor arialabel=Anchor># </span>1.1.7 ActivityManagerProxy.startActivity</h3></a><p>以上过程是在 Launcher App 所在的进程中发生的，在我的另外一篇文章
<a href=https://guanpj.cn/2017/08/13/Android-Binder-Apply/ rel=noopener>借助 AIDL 理解 Android Binder 机制——AIDL 的使用和原理分析</a>中我们分析了 AIDL 的实现过程，由于远程 Service 跟使用 Service 的 Activity 不在同一个进程中，因此他们之间交互需要通过 Binder IPC 机制的支持，在这个过程中 Client 首先获取到 Server 端的代理对象，在 Client 看来 Server 代理对象同样具有 Server 本地对象承诺的能力，因此 Client 可以调用 Server 代理对象跟 Sever 本地对象进行数据交互，Binder 驱动作为桥梁在他们中间起到中间人的作用。</p><p>同样，在
<a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>Android 系统启动流程分析</a>中我们了解到，AMS 是运行在 system_server 线程中的，这时 AMS 就相当于 AIDL 中的远程 Service，App 进程要与 AMS 交互，需要通过 AMS 的代理对象 AMP(ActivityManagerProxy) 来完成，来看 ActivityManagerNative.getDefault() 拿到的是什么：
[frameworks/base/core/java/android/app/ActivityManagerNative.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/ActivityManagerNative.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>public</span> <span class=n>IActivityManager</span> <span class=nf>getDefault</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>gDefault</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>getDefault 是一个静态变量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityManager</span><span class=o>&gt;</span> <span class=n>gDefault</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityManager</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>IActivityManager</span> <span class=nf>create</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 向 ServiceManager 查询一个 key 为 &#34;activity&#34; 的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>IBinder</span> <span class=n>b</span> <span class=o>=</span> <span class=n>ServiceManager</span><span class=o>.</span><span class=na>getService</span><span class=o>(</span><span class=s>&#34;activity&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=kc>false</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=s>&#34;ActivityManager&#34;</span><span class=o>,</span> <span class=s>&#34;default service binder = &#34;</span> <span class=o>+</span> <span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>IActivityManager</span> <span class=n>am</span> <span class=o>=</span> <span class=n>asInterface</span><span class=o>(</span><span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=kc>false</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=na>v</span><span class=o>(</span><span class=s>&#34;ActivityManager&#34;</span><span class=o>,</span> <span class=s>&#34;default service = &#34;</span> <span class=o>+</span> <span class=n>am</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>am</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span></code></pre></td></tr></table></div></div><p>同样，在文章
<a href=https://guanpj.cn/2017/08/10/Android-Binder-Principle-Analyze/ rel=noopener>借助 AIDL 理解 Android Binder 机制——Binder 来龙去脉</a>中也讲到过：</p><blockquote><p>ServiceManager 是 Binder IPC 通信过程的核心，是上下文的管理者，Binder 服务端必须先向 ServerManager 注册才能够为客户端提供服务，Binder 客户端在与服务端通信之前需要从 ServerManager 中查找并获取 Binder 服务端的引用。</p></blockquote><p>这里通过 &ldquo;activity&rdquo; 这个名字向 ServiceManager 查询 AMS 的引用，获取 AMS 的引用后，调用 asInterface 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>public</span> <span class=n>IActivityManager</span> <span class=nf>asInterface</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>obj</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>obj</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 根据 descriptor 查询 obj 是否为 Binder 本地对象，具体过程请看前文中提到的文章
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>IActivityManager</span> <span class=n>in</span> <span class=o>=</span> <span class=o>(</span><span class=n>IActivityManager</span><span class=o>)</span><span class=n>obj</span><span class=o>.</span><span class=na>queryLocalInterface</span><span class=o>(</span><span class=n>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>in</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>in</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果 obj 不是 Binder 本地对象，则将其包装成代理对象并返回
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=n>ActivityManagerProxy</span><span class=o>(</span><span class=n>obj</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>因为 AMS 与 Launcher App 不在同一个进程中，这里返回的 IBinder 对象是一个 Binder 代理对象，因此这类将其包装成 AMP(ActivityManagerProxy) 对象并返回，AMP 是 AMN(ActivityManagerNative) 的内部类，查看 AMP 类 ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ActivityManagerProxy</span> <span class=kd>implements</span> <span class=n>IActivityManager</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>ActivityManagerProxy</span><span class=o>(</span><span class=n>IBinder</span> <span class=n>remote</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mRemote</span> <span class=o>=</span> <span class=n>remote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>IBinder</span> <span class=nf>asBinder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>options</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用号为 START_ACTIVITY_TRANSACTION
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>START_ACTIVITY_TRANSACTION</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>reply</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>ComponentName</span> <span class=nf>startService</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>service</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=kt>int</span> <span class=n>userId</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>START_SERVICE_TRANSACTION</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ComponentName</span> <span class=n>res</span> <span class=o>=</span> <span class=n>ComponentName</span><span class=o>.</span><span class=na>readFromParcel</span><span class=o>(</span><span class=n>reply</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，AMP 里面将客户端的请求通过 mRemote.transact 进行转发，mRemote 对象正是 Binder 驱动返回来的 Binder Proxy 对象，通过 Binder Proxy，Binder 驱动最终将调用处于 Binder Server 端 AMN 中的 onTransact 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTransact</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 根据方法调用号 code 决定调用哪个方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=o>(</span><span class=n>code</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>START_ACTIVITY_TRANSACTION</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 startActivity 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>startActivity</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resultTo</span><span class=o>,</span> <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>reply</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>START_SERVICE_TRANSACTION</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>ComponentName</span> <span class=n>cn</span> <span class=o>=</span> <span class=n>startService</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>service</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>userId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>ComponentName</span><span class=o>.</span><span class=na>writeToParcel</span><span class=o>(</span><span class=n>cn</span><span class=o>,</span> <span class=n>reply</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>AMN 是一个抽象类，它的 startActivity 为抽象方法，具体的实现在 ActivityManagerService.java 中。</p><a href=#118-activitymanagerservicestartactivity><h3 id=118-activitymanagerservicestartactivity><span class=hanchor arialabel=Anchor># </span>1.1.8 ActivityManagerService.startActivity</h3></a><p>[frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityManagerService.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ActivityManagerService</span> <span class=kd>extends</span> <span class=n>ActivityManagerNative</span>
</span></span><span class=line><span class=cl>        <span class=kd>implements</span> <span class=n>Watchdog</span><span class=o>.</span><span class=na>Monitor</span><span class=o>,</span> <span class=n>BatteryStatsImpl</span><span class=o>.</span><span class=na>BatteryCallback</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>startActivity</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                   <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                   <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>bOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>startActivityAsUser</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>resultTo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>bOptions</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>UserHandle</span><span class=o>.</span><span class=na>getCallingUserId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#12-小结><h2 id=12-小结><span class=hanchor arialabel=Anchor># </span>1.2 小结</h2></a><p>从 Launcher App 到 AMS 的调用过程中使用了 Binder IPC 机制，如果你已经看了上面提到的我之前写的两篇文章——
<a href=https://guanpj.cn/2017/08/10/Android-Binder-Principle-Analyze/ rel=noopener>借助 AIDL 理解 Android Binder 机制——Binder 来龙去脉</a>和
<a href=https://guanpj.cn/2017/08/13/Android-Binder-Apply/ rel=noopener>借助 AIDL 理解 Android Binder 机制——AIDL 的使用和原理分析</a>，并且运行了文章中使用到的
<a href=https://github.com/guanpj/BinderDemo rel=noopener>Demo</a>，你应该可以发现，相对于 AIDL 的调用过程，调用方 Launcher App 相当于 AIDL 过程中的 Activity 所在的 App，充当 Clinent 的角色；AMS 相当于远程 Service 的角色，充当 Server 端角色，他们的调用过程总体上都是一样的。</p><p>从 Launcher App 到 AMS 的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045438.png width=auto alt></p><a href=#2-ams--zygote><h1 id=2-ams--zygote><span class=hanchor arialabel=Anchor># </span>2. AMS —— zygote</h1></a><a href=#21-调用过程分析><h2 id=21-调用过程分析><span class=hanchor arialabel=Anchor># </span>2.1 调用过程分析</h2></a><a href=#211-activitymanagerservicestartactivityasuser><h3 id=211-activitymanagerservicestartactivityasuser><span class=hanchor arialabel=Anchor># </span>2.1.1 ActivityManagerService.startActivityAsUser</h3></a><p>接着从 AMS 的 startActivityAsUser 方法开始分析：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>startActivityAsUser</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>bOptions</span><span class=o>,</span> <span class=kt>int</span> <span class=n>userId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enforceNotIsolatedCaller</span><span class=o>(</span><span class=s>&#34;startActivity&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>userId</span> <span class=o>=</span> <span class=n>mUserController</span><span class=o>.</span><span class=na>handleIncomingUser</span><span class=o>(</span><span class=n>Binder</span><span class=o>.</span><span class=na>getCallingPid</span><span class=o>(),</span> <span class=n>Binder</span><span class=o>.</span><span class=na>getCallingUid</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>userId</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=n>ALLOW_FULL_ONLY</span><span class=o>,</span> <span class=s>&#34;startActivity&#34;</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO: Switch to user app stacks here.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 调用 ActivityStarter 的 startActivityMayWait 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>mActivityStarter</span><span class=o>.</span><span class=na>startActivityMayWait</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>resolvedType</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>profilerInfo</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>bOptions</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=n>userId</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#212-activitystarterstartactivitymaywait><h3 id=212-activitystarterstartactivitymaywait><span class=hanchor arialabel=Anchor># </span>2.1.2 ActivityStarter.startActivityMayWait</h3></a><p>继续跟进 [frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStarter.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>int</span> <span class=nf>startActivityMayWait</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=kt>int</span> <span class=n>callingUid</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IVoiceInteractionSession</span> <span class=n>voiceSession</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span> <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>IActivityManager</span><span class=o>.</span><span class=na>WaitResult</span> <span class=n>outResult</span><span class=o>,</span> <span class=n>Configuration</span> <span class=n>config</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Bundle</span> <span class=n>bOptions</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>ignoreTargetSecurity</span><span class=o>,</span> <span class=kt>int</span> <span class=n>userId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IActivityContainer</span> <span class=n>iContainer</span><span class=o>,</span> <span class=n>TaskRecord</span> <span class=n>inTask</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span>
</span></span><span class=line><span class=cl>   <span class=kd>synchronized</span> <span class=o>(</span><span class=n>mService</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 startActivityLocked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=n>startActivityLocked</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=n>intent</span><span class=o>,</span> <span class=n>ephemeralIntent</span><span class=o>,</span> <span class=n>resolvedType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>aInfo</span><span class=o>,</span> <span class=n>rInfo</span><span class=o>,</span> <span class=n>voiceSession</span><span class=o>,</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>resultTo</span><span class=o>,</span> <span class=n>resultWho</span><span class=o>,</span> <span class=n>requestCode</span><span class=o>,</span> <span class=n>callingPid</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>callingUid</span><span class=o>,</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=n>realCallingPid</span><span class=o>,</span> <span class=n>realCallingUid</span><span class=o>,</span> <span class=n>startFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>options</span><span class=o>,</span> <span class=n>ignoreTargetSecurity</span><span class=o>,</span> <span class=n>componentSpecified</span><span class=o>,</span> <span class=n>outRecord</span><span class=o>,</span> <span class=n>container</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>inTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#213-activitystarterstartactivitylocked><h3 id=213-activitystarterstartactivitylocked><span class=hanchor arialabel=Anchor># </span>2.1.3 ActivityStarter.startActivityLocked</h3></a><p>查看 startActivityLocked 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>int</span> <span class=nf>startActivityLocked</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>caller</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>ephemeralIntent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>resolvedType</span><span class=o>,</span> <span class=n>ActivityInfo</span> <span class=n>aInfo</span><span class=o>,</span> <span class=n>ResolveInfo</span> <span class=n>rInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IVoiceInteractionSession</span> <span class=n>voiceSession</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IBinder</span> <span class=n>resultTo</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultWho</span><span class=o>,</span> <span class=kt>int</span> <span class=n>requestCode</span><span class=o>,</span> <span class=kt>int</span> <span class=n>callingPid</span><span class=o>,</span> <span class=kt>int</span> <span class=n>callingUid</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>callingPackage</span><span class=o>,</span> <span class=kt>int</span> <span class=n>realCallingPid</span><span class=o>,</span> <span class=kt>int</span> <span class=n>realCallingUid</span><span class=o>,</span> <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>ignoreTargetSecurity</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>componentSpecified</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ActivityRecord</span><span class=o>[]</span> <span class=n>outActivity</span><span class=o>,</span> <span class=n>ActivityStackSupervisor</span><span class=o>.</span><span class=na>ActivityContainer</span> <span class=n>container</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>TaskRecord</span> <span class=n>inTask</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 doPendingActivityLaunchesLocked 方法，传入 false 参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>doPendingActivityLaunchesLocked</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>err</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#214-activitystarterdopendingactivitylauncheslocked><h3 id=214-activitystarterdopendingactivitylauncheslocked><span class=hanchor arialabel=Anchor># </span>2.1.4 ActivityStarter.doPendingActivityLaunchesLocked</h3></a><p>查看 doPendingActivityLaunchesLocked 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>doPendingActivityLaunchesLocked</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>doResume</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(!</span><span class=n>mPendingActivityLaunches</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>PendingActivityLaunch</span> <span class=n>pal</span> <span class=o>=</span> <span class=n>mPendingActivityLaunches</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>resume</span> <span class=o>=</span> <span class=n>doResume</span> <span class=o>&amp;&amp;</span> <span class=n>mPendingActivityLaunches</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用 startActivityUnchecked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>startActivityUnchecked</span><span class=o>(</span><span class=n>pal</span><span class=o>.</span><span class=na>r</span><span class=o>,</span> <span class=n>pal</span><span class=o>.</span><span class=na>sourceRecord</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>pal</span><span class=o>.</span><span class=na>startFlags</span><span class=o>,</span> <span class=n>resume</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>postStartActivityUncheckedProcessing</span><span class=o>(</span><span class=n>pal</span><span class=o>.</span><span class=na>r</span><span class=o>,</span> <span class=n>result</span><span class=o>,</span> <span class=n>mSupervisor</span><span class=o>.</span><span class=na>mFocusedStack</span><span class=o>.</span><span class=na>mStackId</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>mSourceRecord</span><span class=o>,</span> <span class=n>mTargetStack</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Slog</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Exception during pending activity launch pal=&#34;</span> <span class=o>+</span> <span class=n>pal</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pal</span><span class=o>.</span><span class=na>sendErrorResult</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#215-activitystarterstartactivityunchecked><h3 id=215-activitystarterstartactivityunchecked><span class=hanchor arialabel=Anchor># </span>2.1.5 ActivityStarter.startActivityUnchecked</h3></a><p>查看 startActivityUnchecked 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=nf>startActivityUnchecked</span><span class=o>(</span><span class=kd>final</span> <span class=n>ActivityRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>ActivityRecord</span> <span class=n>sourceRecord</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>IVoiceInteractionSession</span> <span class=n>voiceSession</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>startFlags</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>doResume</span><span class=o>,</span> <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>,</span> <span class=n>TaskRecord</span> <span class=n>inTask</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 ActivityStackSupervisor 的 resumeFocusedStackTopActivityLocked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mSupervisor</span><span class=o>.</span><span class=na>resumeFocusedStackTopActivityLocked</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=o>...</span> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>START_SUCCESS</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#216-activitystacksupervisorresumefocusedstacktopactivitylocked><h3 id=216-activitystacksupervisorresumefocusedstacktopactivitylocked><span class=hanchor arialabel=Anchor># </span>2.1.6 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</h3></a><p>[frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStackSupervisor.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>resumeFocusedStackTopActivityLocked</span><span class=o>(</span><span class=n>ActivityStack</span> <span class=n>targetStack</span><span class=o>,</span> <span class=n>ActivityRecord</span> <span class=n>target</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ActivityOptions</span> <span class=n>targetOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>targetStack</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>isFocusedStack</span><span class=o>(</span><span class=n>targetStack</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>targetStack</span><span class=o>.</span><span class=na>resumeTopActivityUncheckedLocked</span><span class=o>(</span><span class=n>target</span><span class=o>,</span> <span class=n>targetOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ActivityRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=n>mFocusedStack</span><span class=o>.</span><span class=na>topRunningActivityLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>r</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span> <span class=o>!=</span> <span class=n>RESUMED</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 ActivityStack 的 resumeTopActivityUncheckedLocked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mFocusedStack</span><span class=o>.</span><span class=na>resumeTopActivityUncheckedLocked</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#217-activitystackresumetopactivityuncheckedlocked><h3 id=217-activitystackresumetopactivityuncheckedlocked><span class=hanchor arialabel=Anchor># </span>2.1.7 ActivityStack.resumeTopActivityUncheckedLocked</h3></a><p>查看 [ActivityStack](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStack.java) 的 resumeTopActivityUncheckedLocked 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>resumeTopActivityUncheckedLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>prev</span><span class=o>,</span> <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 resumeTopActivityInnerLocked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>result</span> <span class=o>=</span> <span class=n>resumeTopActivityInnerLocked</span><span class=o>(</span><span class=n>prev</span><span class=o>,</span> <span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>inResumeTopActivity</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#218-activitystackresumetopactivityinnerlocked><h3 id=218-activitystackresumetopactivityinnerlocked><span class=hanchor arialabel=Anchor># </span>2.1.8 ActivityStack.resumeTopActivityInnerLocked</h3></a><p>查看 resumeTopActivityInnerLocked 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>resumeTopActivityInnerLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>prev</span><span class=o>,</span> <span class=n>ActivityOptions</span> <span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ActivityRecord</span> <span class=n>next</span> <span class=o>=</span> <span class=n>topRunningActivityLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>next</span><span class=o>.</span><span class=na>app</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>next</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>thread</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>DEBUG_STATES</span><span class=o>)</span> <span class=n>Slog</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG_STATES</span><span class=o>,</span> <span class=s>&#34;resumeTopActivityLocked: Restarting &#34;</span> <span class=o>+</span> <span class=n>next</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 ActivityStackSupervisor 的 startSpecificActivityLocked 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>startSpecificActivityLocked</span><span class=o>(</span><span class=n>next</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>DEBUG_STACK</span><span class=o>)</span> <span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>validateTopActivitiesLocked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#219-activitystacksupervisorstartspecificactivitylocked><h3 id=219-activitystacksupervisorstartspecificactivitylocked><span class=hanchor arialabel=Anchor># </span>2.1.9 ActivityStackSupervisor.startSpecificActivityLocked</h3></a><p>回到 ActivityStackSupervisor 的 startSpecificActivityLocked 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>startSpecificActivityLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>r</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>andResume</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>checkConfig</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前 Activity 附属的 Application
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ProcessRecord</span> <span class=n>app</span> <span class=o>=</span> <span class=n>mService</span><span class=o>.</span><span class=na>getProcessRecordLocked</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>processName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>.</span><span class=na>uid</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=na>task</span><span class=o>.</span><span class=na>stack</span><span class=o>.</span><span class=na>setLaunchTime</span><span class=o>(</span><span class=n>r</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果 Application 已经运行
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>app</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>app</span><span class=o>.</span><span class=na>thread</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span><span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>flags</span><span class=o>&amp;</span><span class=n>ActivityInfo</span><span class=o>.</span><span class=na>FLAG_MULTIPROCESS</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span>
</span></span><span class=line><span class=cl>                    <span class=o>||</span> <span class=o>!</span><span class=s>&#34;android&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>packageName</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>addPackage</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>packageName</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>.</span><span class=na>versionCode</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>mService</span><span class=o>.</span><span class=na>mProcessStats</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>realStartActivityLocked</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>app</span><span class=o>,</span> <span class=n>andResume</span><span class=o>,</span> <span class=n>checkConfig</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Slog</span><span class=o>.</span><span class=na>w</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Exception when starting activity &#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>+</span> <span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>.</span><span class=na>getComponent</span><span class=o>().</span><span class=na>flattenToShortString</span><span class=o>(),</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 启动新进程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mService</span><span class=o>.</span><span class=na>startProcessLocked</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>processName</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;activity&#34;</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>.</span><span class=na>getComponent</span><span class=o>(),</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，在方法中获取了当前 Activity 附属的 Application，如果已经在运行了，说明这个 App 是已经被启动过了的，这时候调用 <strong>realStartActivityLocked</strong> 方法就可以进入下一步的流程了，同一个 App 中不同 Activity 的相互启动就是走的这个流程。当 Application 没有运行的时候，就需要调用 AMS 的 startProcessLocked 方法启动一个进程去承载它然后完成后续的工作，顺便铺垫一下，当新进程被启动完成后还会调用回到这个方法，查看 AMS 的 startProcessLocked 方法：</p><a href=#2110-activitymanagerservicestartprocesslocked><h3 id=2110-activitymanagerservicestartprocesslocked><span class=hanchor arialabel=Anchor># </span>2.1.10 ActivityManagerService.startProcessLocked</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=n>ProcessRecord</span> <span class=nf>startProcessLocked</span><span class=o>(</span><span class=n>String</span> <span class=n>processName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ApplicationInfo</span> <span class=n>info</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>knownToBeDead</span><span class=o>,</span> <span class=kt>int</span> <span class=n>intentFlags</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>hostingType</span><span class=o>,</span> <span class=n>ComponentName</span> <span class=n>hostingName</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>allowWhileBooting</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>isolated</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>keepIfLarge</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>startProcessLocked</span><span class=o>(</span><span class=n>processName</span><span class=o>,</span> <span class=n>info</span><span class=o>,</span> <span class=n>knownToBeDead</span><span class=o>,</span> <span class=n>intentFlags</span><span class=o>,</span> <span class=n>hostingType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>hostingName</span><span class=o>,</span> <span class=n>allowWhileBooting</span><span class=o>,</span> <span class=n>isolated</span><span class=o>,</span> <span class=n>0</span> <span class=cm>/* isolatedUid */</span><span class=o>,</span> <span class=n>keepIfLarge</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kc>null</span> <span class=cm>/* ABI override */</span><span class=o>,</span> <span class=kc>null</span> <span class=cm>/* entryPoint */</span><span class=o>,</span> <span class=kc>null</span> <span class=cm>/* entryPointArgs */</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=kc>null</span> <span class=cm>/* crashHandler */</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2111-activitymanagerservicestartprocesslocked><h3 id=2111-activitymanagerservicestartprocesslocked><span class=hanchor arialabel=Anchor># </span>2.1.11 ActivityManagerService.startProcessLocked</h3></a><p>调用 startProcessLocked 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=n>ProcessRecord</span> <span class=nf>startProcessLocked</span><span class=o>(</span><span class=n>String</span> <span class=n>processName</span><span class=o>,</span> <span class=n>ApplicationInfo</span> <span class=n>info</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>knownToBeDead</span><span class=o>,</span> <span class=kt>int</span> <span class=n>intentFlags</span><span class=o>,</span> <span class=n>String</span> <span class=n>hostingType</span><span class=o>,</span> <span class=n>ComponentName</span> <span class=n>hostingName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>allowWhileBooting</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isolated</span><span class=o>,</span> <span class=kt>int</span> <span class=n>isolatedUid</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>keepIfLarge</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>abiOverride</span><span class=o>,</span> <span class=n>String</span> <span class=n>entryPoint</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>entryPointArgs</span><span class=o>,</span> <span class=n>Runnable</span> <span class=n>crashHandler</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>startProcessLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>hostingType</span><span class=o>,</span> <span class=n>hostingNameStr</span><span class=o>,</span> <span class=n>abiOverride</span><span class=o>,</span> <span class=n>entryPoint</span><span class=o>,</span> <span class=n>entryPointArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>checkTime</span><span class=o>(</span><span class=n>startTime</span><span class=o>,</span> <span class=s>&#34;startProcess: done starting proc!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=n>app</span><span class=o>.</span><span class=na>pid</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>?</span> <span class=n>app</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2112-activitymanagerservicestartprocesslocked><h3 id=2112-activitymanagerservicestartprocesslocked><span class=hanchor arialabel=Anchor># </span>2.1.12 ActivityManagerService.startProcessLocked</h3></a><p>调用 startProcessLocked 的重载方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>startProcessLocked</span><span class=o>(</span><span class=n>ProcessRecord</span> <span class=n>app</span><span class=o>,</span> <span class=n>String</span> <span class=n>hostingType</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>hostingNameStr</span><span class=o>,</span> <span class=n>String</span> <span class=n>abiOverride</span><span class=o>,</span> <span class=n>String</span> <span class=n>entryPoint</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>entryPointArgs</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 Process 的 start 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Process</span><span class=o>.</span><span class=na>ProcessStartResult</span> <span class=n>startResult</span> <span class=o>=</span> <span class=n>Process</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=n>entryPoint</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>processName</span><span class=o>,</span> <span class=n>uid</span><span class=o>,</span> <span class=n>uid</span><span class=o>,</span> <span class=n>gids</span><span class=o>,</span> <span class=n>debugFlags</span><span class=o>,</span> <span class=n>mountExternal</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>targetSdkVersion</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>seinfo</span><span class=o>,</span> <span class=n>requiredAbi</span><span class=o>,</span> <span class=n>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>dataDir</span><span class=o>,</span> <span class=n>entryPointArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2113-processstart><h3 id=2113-processstart><span class=hanchor arialabel=Anchor># </span>2.1.13 Process.start</h3></a><p>[frameworks/base/services/core/java/android/os/Process.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/os/Process.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>ProcessStartResult</span> <span class=nf>start</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span> <span class=n>processClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kd>final</span> <span class=n>String</span> <span class=n>niceName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>uid</span><span class=o>,</span> <span class=kt>int</span> <span class=n>gid</span><span class=o>,</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>debugFlags</span><span class=o>,</span> <span class=kt>int</span> <span class=n>mountExternal</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>seInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>abi</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>appDataDir</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span><span class=o>[]</span> <span class=n>zygoteArgs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 startViaZygote 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>startViaZygote</span><span class=o>(</span><span class=n>processClass</span><span class=o>,</span> <span class=n>niceName</span><span class=o>,</span> <span class=n>uid</span><span class=o>,</span> <span class=n>gid</span><span class=o>,</span> <span class=n>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>debugFlags</span><span class=o>,</span> <span class=n>mountExternal</span><span class=o>,</span> <span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>seInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>abi</span><span class=o>,</span> <span class=n>instructionSet</span><span class=o>,</span> <span class=n>appDataDir</span><span class=o>,</span> <span class=n>zygoteArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ZygoteStartFailedEx</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>LOG_TAG</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;Starting VM process through Zygote failed&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;Starting VM process through Zygote failed&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2114-processstartviazygote><h3 id=2114-processstartviazygote><span class=hanchor arialabel=Anchor># </span>2.1.14 Process.startViaZygote</h3></a><p>查看 startViaZygote 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>ProcessStartResult</span> <span class=nf>startViaZygote</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span> <span class=n>processClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kd>final</span> <span class=n>String</span> <span class=n>niceName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kd>final</span> <span class=kt>int</span> <span class=n>uid</span><span class=o>,</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>gid</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kd>final</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>debugFlags</span><span class=o>,</span> <span class=kt>int</span> <span class=n>mountExternal</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>seInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>abi</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>appDataDir</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span><span class=o>[]</span> <span class=n>extraArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                <span class=kd>throws</span> <span class=n>ZygoteStartFailedEx</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span><span class=o>(</span><span class=n>Process</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 zygoteSendArgsAndGetResult 方法，传入 openZygoteSocketIfNeeded 的返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>zygoteSendArgsAndGetResult</span><span class=o>(</span><span class=n>openZygoteSocketIfNeeded</span><span class=o>(</span><span class=n>abi</span><span class=o>),</span> <span class=n>argsForZygote</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2115-processzygotesendargsandgetresultprocessopenzygotesocketifneeded><h3 id=2115-processzygotesendargsandgetresultprocessopenzygotesocketifneeded><span class=hanchor arialabel=Anchor># </span>2.1.15 Process.zygoteSendArgsAndGetResult、Process.openZygoteSocketIfNeeded</h3></a><p>查看 zygoteSendArgsAndGetResult 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>ProcessStartResult</span> <span class=nf>zygoteSendArgsAndGetResult</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ZygoteState</span> <span class=n>zygoteState</span><span class=o>,</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>ZygoteStartFailedEx</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>BufferedWriter</span> <span class=n>writer</span> <span class=o>=</span> <span class=n>zygoteState</span><span class=o>.</span><span class=na>writer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>DataInputStream</span> <span class=n>inputStream</span> <span class=o>=</span> <span class=n>zygoteState</span><span class=o>.</span><span class=na>inputStream</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>Integer</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>args</span><span class=o>.</span><span class=na>size</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=na>newLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sz</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>arg</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>writer</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>arg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>writer</span><span class=o>.</span><span class=na>newLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=na>flush</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Should there be a timeout on this?
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ProcessStartResult</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ProcessStartResult</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 等待 socket 服务端（即zygote）返回新创建的进程pid;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>result</span><span class=o>.</span><span class=na>pid</span> <span class=o>=</span> <span class=n>inputStream</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=na>usingWrapper</span> <span class=o>=</span> <span class=n>inputStream</span><span class=o>.</span><span class=na>readBoolean</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>pid</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=s>&#34;fork() failed&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>zygoteState</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 zygoteSendArgsAndGetResult 中等待 Socket 服务端，也就是 zygote 进程返回创建新进程的结果，这里 zygoteState 参数是由 openZygoteSocketIfNeeded 方法返回的，openZygoteSocketIfNeeded 方法则负责根据 abi 向 Zygote 进程发起连接请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>ZygoteState</span> <span class=nf>openZygoteSocketIfNeeded</span><span class=o>(</span><span class=n>String</span> <span class=n>abi</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ZygoteStartFailedEx</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>primaryZygoteState</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>primaryZygoteState</span><span class=o>.</span><span class=na>isClosed</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 向主zygote发起connect()操作
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>primaryZygoteState</span> <span class=o>=</span> <span class=n>ZygoteState</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=n>ZYGOTE_SOCKET</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ioe</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=s>&#34;Error connecting to primary zygote&#34;</span><span class=o>,</span> <span class=n>ioe</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>primaryZygoteState</span><span class=o>.</span><span class=na>matches</span><span class=o>(</span><span class=n>abi</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>primaryZygoteState</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>secondaryZygoteState</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>secondaryZygoteState</span><span class=o>.</span><span class=na>isClosed</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 当主zygote没能匹配成功，则采用第二个zygote，发起connect()操作
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>secondaryZygoteState</span> <span class=o>=</span> <span class=n>ZygoteState</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=n>SECONDARY_ZYGOTE_SOCKET</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ioe</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=s>&#34;Error connecting to secondary zygote&#34;</span><span class=o>,</span> <span class=n>ioe</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>secondaryZygoteState</span><span class=o>.</span><span class=na>matches</span><span class=o>(</span><span class=n>abi</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>secondaryZygoteState</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteStartFailedEx</span><span class=o>(</span><span class=s>&#34;Unsupported zygote ABI: &#34;</span> <span class=o>+</span> <span class=n>abi</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#22-小结><h2 id=22-小结><span class=hanchor arialabel=Anchor># </span>2.2 小结</h2></a><p>如果是从桌面新启动一个 App 中的 Activity，此时是没有进程去承载这个 App 的，因此需要通过 AMS 向 zygote 继承发起请求去完成这个任务，AMS 运行在 system_server 进程中，它通过 Socket 向 zygote 发起 fock 进程的请求，从 AMS 开始的调用时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045449.png width=auto alt></p><a href=#3-zygote--activitythread><h1 id=3-zygote--activitythread><span class=hanchor arialabel=Anchor># </span>3. zygote —— ActivityThread</h1></a><a href=#31-调用过程分析><h2 id=31-调用过程分析><span class=hanchor arialabel=Anchor># </span>3.1 调用过程分析</h2></a><a href=#311-zygoteinitmain><h3 id=311-zygoteinitmain><span class=hanchor arialabel=Anchor># </span>3.1.1 ZygoteInit.main</h3></a><p>在
<a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>Android 系统启动流程分析</a> 文中提到过 zygote 进程的其中一项任务就是：</p><blockquote><p>调用 registerZygoteSocket() 函数建立 Socket 通道，使 zygote 进程成为 Socket 服务端，并通过 runSelectLoop() 函数等待 ActivityManagerService 发送请求创建新的应用程序进程。</p></blockquote><p>zygote 终于要再次上场了！接下来从 ZygoteInit.java 的 main 方法开始回顾一下 zygote 进程的工作：</p><p>[frameworks/base/core/java/com/android/internal/os/ZygoteInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteInit.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span> <span class=n>argv</span><span class=o>[])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>runSelectLoop</span><span class=o>(</span><span class=n>abiList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>....</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>MethodAndArgsCaller</span> <span class=n>caller</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>caller</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#312-zygoteinitrunselectloop><h3 id=312-zygoteinitrunselectloop><span class=hanchor arialabel=Anchor># </span>3.1.2 ZygoteInit.runSelectLoop</h3></a><p>查看 runSelectLoop 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>runSelectLoop</span><span class=o>(</span><span class=n>String</span> <span class=n>abiList</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 循环读取状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>pollFds</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>;</span> <span class=o>--</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 读取的状态不是客户端连接或者数据请求时，进入下一次循环
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>((</span><span class=n>pollFds</span><span class=o>[</span><span class=n>i</span><span class=o>].</span><span class=na>revents</span> <span class=o>&amp;</span> <span class=n>POLLIN</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span><span class=c1>// i = 0 表示跟客户端 Socket 连接上了
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>ZygoteConnection</span> <span class=n>newPeer</span> <span class=o>=</span> <span class=n>acceptCommandPeer</span><span class=o>(</span><span class=n>abiList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>peers</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>newPeer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>fds</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>newPeer</span><span class=o>.</span><span class=na>getFileDesciptor</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span><span class=c1>// i &gt; 0 表示接收到客户端 Socket 发送过来的请求
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// runOnce 方法创建一个新的应用程序进程
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kt>boolean</span> <span class=n>done</span> <span class=o>=</span> <span class=n>peers</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>runOnce</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>done</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>peers</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>fds</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#313-zygoteconnectionrunonce><h3 id=313-zygoteconnectionrunonce><span class=hanchor arialabel=Anchor># </span>3.1.3 ZygoteConnection.runOnce</h3></a><p>查看 [frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteConnection.java) 的 runOnce 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>runOnce</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>args</span><span class=o>[];</span>
</span></span><span class=line><span class=cl>    <span class=n>Arguments</span> <span class=n>parsedArgs</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FileDescriptor</span><span class=o>[]</span> <span class=n>descriptors</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 读取 socket 客户端发送过来的参数列表
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>args</span> <span class=o>=</span> <span class=n>readArgumentList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>descriptors</span> <span class=o>=</span> <span class=n>mSocket</span><span class=o>.</span><span class=na>getAncillaryFileDescriptors</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// EOF reached.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>closeSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将 socket 客户端传递过来的参数，解析成 Arguments 对象格式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>parsedArgs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Arguments</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 同样调用 Zygote.java 的 forkAndSpecialize 方法 fock 出子进程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pid</span> <span class=o>=</span> <span class=n>Zygote</span><span class=o>.</span><span class=na>forkAndSpecialize</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>uid</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>gid</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>gids</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>debugFlags</span><span class=o>,</span> <span class=n>rlimits</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>mountExternal</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>seInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span><span class=o>,</span> <span class=n>fdsToClose</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>.</span><span class=na>instructionSet</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>appDataDir</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>pid</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 子进程执行
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>serverPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverPipeFd</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 进入子进程流程
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>handleChildProc</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>,</span> <span class=n>descriptors</span><span class=o>,</span> <span class=n>childPipeFd</span><span class=o>,</span> <span class=n>newStderr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 父进程执行
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>childPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>childPipeFd</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>handleParentProc</span><span class=o>(</span><span class=n>pid</span><span class=o>,</span> <span class=n>descriptors</span><span class=o>,</span> <span class=n>serverPipeFd</span><span class=o>,</span> <span class=n>parsedArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>childPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>IoUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>serverPipeFd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#314-zygoteconnectionhandlechildproc><h3 id=314-zygoteconnectionhandlechildproc><span class=hanchor arialabel=Anchor># </span>3.1.4 ZygoteConnection.handleChildProc</h3></a><p>首先解析 Socket 客户端传过来的参数，[Zygote.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/Zygote.java) 的 forkAndSpecialize 返回的 pid == 0 的时候表示此时在 fock 出来的子进程中执行，继续调用 handleChildProc 方法，并将参数继续层层传递：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleChildProc</span><span class=o>(</span><span class=n>Arguments</span> <span class=n>parsedArgs</span><span class=o>,</span> <span class=n>FileDescriptor</span><span class=o>[]</span> 
</span></span><span class=line><span class=cl>    <span class=n>descriptors</span><span class=o>,</span> <span class=n>FileDescriptor</span> <span class=n>pipeFd</span><span class=o>,</span> <span class=n>PrintStream</span> <span class=n>newStderr</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*由于 fock 出来的 system_server 进程会复制 zygote 进程的地址空间，因此它也得到了 zygote
</span></span></span><span class=line><span class=cl><span class=cm>    进程中的 Socket，这个 Socket 对它来说并无用处，这里将其关闭 
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>    <span class=n>closeSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置进程名
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Process</span><span class=o>.</span><span class=na>setArgV0</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>niceName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>invokeWith</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 RuntimeInit 的 zygoteInit 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>RuntimeInit</span><span class=o>.</span><span class=na>zygoteInit</span><span class=o>(</span><span class=n>parsedArgs</span><span class=o>.</span><span class=na>targetSdkVersion</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsedArgs</span><span class=o>.</span><span class=na>remainingArgs</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#315-runtimeinitzygoteinit><h3 id=315-runtimeinitzygoteinit><span class=hanchor arialabel=Anchor># </span>3.1.5 RuntimeInit.zygoteInit</h3></a><p>查看 [frameworks/base/core/java/com/android/internal/os/RuntimeInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/RuntimeInit.java) 的 zygoteInit 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>zygoteInit</span><span class=o>(</span><span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>DEBUG</span><span class=o>)</span> <span class=n>Slog</span><span class=o>.</span><span class=na>d</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;RuntimeInit: Starting application from zygote&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>,</span> <span class=s>&#34;RuntimeInit&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 重定向 log 输出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>redirectLogStreams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化一些通用的设置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>commonInit</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     *通过 Native 层中 AndroidRuntime.cpp 的 JNI 方法最终调用 app_main.cpp 的 
</span></span></span><span class=line><span class=cl><span class=cm>     *onZygoteInit 方法启动 Binder 线程池， 使 system_server 进程可以使用 Binder  *与其他进程通信
</span></span></span><span class=line><span class=cl><span class=cm>     **/</span>
</span></span><span class=line><span class=cl>    <span class=n>nativeZygoteInit</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>    <span class=n>applicationInit</span><span class=o>(</span><span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>argv</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#316-runtimeinitapplicationinit><h3 id=316-runtimeinitapplicationinit><span class=hanchor arialabel=Anchor># </span>3.1.6 RuntimeInit.applicationInit</h3></a><p>继续调用 applicationInit 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>applicationInit</span><span class=o>(</span><span class=kt>int</span> <span class=n>targetSdkVersion</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>,</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 提取出参数里面的要启动的类的名字
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>invokeStaticMain</span><span class=o>(</span><span class=n>args</span><span class=o>.</span><span class=na>startClass</span><span class=o>,</span> <span class=n>args</span><span class=o>.</span><span class=na>startArgs</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#317-runtimeinitinvokestaticmain><h3 id=317-runtimeinitinvokestaticmain><span class=hanchor arialabel=Anchor># </span>3.1.7 RuntimeInit.invokeStaticMain</h3></a><p>主要调用了 invokeStaticMain 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>invokeStaticMain</span><span class=o>(</span><span class=n>String</span> <span class=n>className</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>,</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span>
</span></span><span class=line><span class=cl>         <span class=kd>throws</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>cl</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/** className 为通过 Socket 客户端（AMS）传递过来的一系列参数中的其中一个，这里获取到的值为传&#34;com.android.app.ActivityThread&#34;，然后通过反射得到 ActivityThread 类 **/</span>
</span></span><span class=line><span class=cl>        <span class=n>cl</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>className</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ClassNotFoundException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Missing class when invoking static main &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Method</span> <span class=n>m</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 找到 ActivityThread 类的 main 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>m</span> <span class=o>=</span> <span class=n>cl</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(</span><span class=s>&#34;main&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>Class</span><span class=o>[]</span> <span class=o>{</span> <span class=n>String</span><span class=o>[].</span><span class=na>class</span> <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchMethodException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Missing static main on &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SecurityException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Problem getting static main on &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>modifiers</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span> <span class=o>(</span><span class=n>Modifier</span><span class=o>.</span><span class=na>isStatic</span><span class=o>(</span><span class=n>modifiers</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>isPublic</span><span class=o>(</span><span class=n>modifiers</span><span class=o>)))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Main method is not public and static on &#34;</span> <span class=o>+</span> <span class=n>className</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** 将 main 方法包装在 ZygoteInit.MethodAndArgsCaller 类中并作为异常抛出
</span></span></span><span class=line><span class=cl><span class=cm>    捕获异常的地方在上一小节中 ZygoteInit.java 的 main 方法 **/</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>ZygoteInit</span><span class=o>.</span><span class=na>MethodAndArgsCaller</span><span class=o>(</span><span class=n>m</span><span class=o>,</span> <span class=n>argv</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#318-methodandargscallerrun><h3 id=318-methodandargscallerrun><span class=hanchor arialabel=Anchor># </span>3.1.8 MethodAndArgsCaller.run</h3></a><p>回到 ZygoteInit 的 main 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span> <span class=n>argv</span><span class=o>[])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>MethodAndArgsCaller</span> <span class=n>caller</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 接收到 caller 对象后调用它的 run 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>caller</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>TAG</span><span class=o>,</span> <span class=s>&#34;Zygote died with exception&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>closeServerSocket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>ex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>跟 system_server 进程的启动过程一样，这里同样通过抛出异常的方式来清空调用 ActivityThread.main 之前的方法栈帧。</p><p>ZygoteInit 的 MethodAndArgsCaller 类是一个 Exception 类，同时也实现了 Runnable 接口：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MethodAndArgsCaller</span> <span class=kd>extends</span> <span class=n>Exception</span>
</span></span><span class=line><span class=cl>        <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Method</span> <span class=n>mMethod</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>mArgs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>MethodAndArgsCaller</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mMethod</span> <span class=o>=</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mArgs</span> <span class=o>=</span> <span class=n>args</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用传递过来的 mMethod
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mMethod</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[]</span> <span class=o>{</span> <span class=n>mArgs</span> <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IllegalAccessException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InvocationTargetException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#319-activitythread-main><h3 id=319-activitythread-main><span class=hanchor arialabel=Anchor># </span>3.1.9 ActivityThread .main</h3></a><p>最后通过反射调用到 ActivityThread 的 main 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Environment</span><span class=o>.</span><span class=na>initForCurrentUser</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Process</span><span class=o>.</span><span class=na>setArgV0</span><span class=o>(</span><span class=s>&#34;&lt;pre-initialized&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建主线程 Looper
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Looper</span><span class=o>.</span><span class=na>prepareMainLooper</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ActivityThread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ActivityThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// attach 到系统进程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>thread</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>sMainThreadHandler</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sMainThreadHandler</span> <span class=o>=</span> <span class=n>thread</span><span class=o>.</span><span class=na>getHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 主线程进入轮询状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Looper</span><span class=o>.</span><span class=na>loop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 抛出异常说明轮询出现问题
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Main thread loop unexpectedly exited&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#32-小结><h2 id=32-小结><span class=hanchor arialabel=Anchor># </span>3.2 小结</h2></a><p>zygote 进程作为 Socket 服务端在接收到作为客户端的 AMS 发送过来的请求和参数之后，fock 出新的进程并根据各种参数进程了初始化的工作，这个过程和 zygote 启动 system_server 进程的过程如出一辙，时序图如下所示：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045452.png width=auto alt></p><a href=#4-activitythread--activity><h1 id=4-activitythread--activity><span class=hanchor arialabel=Anchor># </span>4. ActivityThread —— Activity</h1></a><a href=#41-调用过程分析><h2 id=41-调用过程分析><span class=hanchor arialabel=Anchor># </span>4.1 调用过程分析</h2></a><a href=#411-activitythreadattach><h3 id=411-activitythreadattach><span class=hanchor arialabel=Anchor># </span>4.1.1 ActivityThread.attach</h3></a><p>上一小节的最后，ActivityThread 的 main 通过反射被运行起来了，接着会调用 ActivityThread 的 attach 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>attach</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>system</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>mSystemThread</span> <span class=o>=</span> <span class=n>system</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>system</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取 ActivityManagerProxy 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>final</span> <span class=n>IActivityManager</span> <span class=n>mgr</span> <span class=o>=</span> <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 通过 Binder 调用 AMS 的 attachApplication 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mgr</span><span class=o>.</span><span class=na>attachApplication</span><span class=o>(</span><span class=n>mAppThread</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>ex</span><span class=o>.</span><span class=na>rethrowFromSystemServer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里，我们再一次通过 Binder IPC 机制跟 AMS 通信，通信模型跟前面 Launcher App 调用 AMS 的 startActivity 方法一样，getDefault 过程不重复分析，这次是调用了 AMS 的 attachApplication 方法，注意这里将 ApplicationThead 类型的 mAppThread 对象作为参数传递了过去，ApplicationThead 是 ActivityThread 的一个内部类，后面我们会讲到，先查看 AMP 的 attachApplication 方法：</p><a href=#412-activitymanagerproxyattachapplication><h3 id=412-activitymanagerproxyattachapplication><span class=hanchor arialabel=Anchor># </span>4.1.2 ActivityManagerProxy.attachApplication</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>attachApplication</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>app</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 asBinder 方法使其能够跨进程传输
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>data</span><span class=o>.</span><span class=na>writeStrongBinder</span><span class=o>(</span><span class=n>app</span><span class=o>.</span><span class=na>asBinder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过 transact 方法将数据交给 Binder 驱动
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>ATTACH_APPLICATION_TRANSACTION</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span> 
</span></span><span class=line><span class=cl>    <span class=n>reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#413-activitymanagernativeontransact><h3 id=413-activitymanagernativeontransact><span class=hanchor arialabel=Anchor># </span>4.1.3 ActivityManagerNative.onTransact</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTransact</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>code</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>ATTACH_APPLICATION_TRANSACTION</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>.</span><span class=na>enforceInterface</span><span class=o>(</span><span class=n>IActivityManager</span><span class=o>.</span><span class=na>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取 ApplicationThread 的代理对象，这里返回的是 ApplicationThreadNative(ATN)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 的内部类：ApplicationThreadProxy(ATP) 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>IApplicationThread</span> <span class=n>app</span> <span class=o>=</span> <span class=n>ApplicationThreadNative</span><span class=o>.</span><span class=na>asInterface</span><span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>readStrongBinder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>app</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 委托给 AMS 执行
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>attachApplication</span><span class=o>(</span><span class=n>app</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>asInterface 将 ActivityThread 对象转换成了 [ApplicationThreadNative(ATN)](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/ActivityManagerNative.java) 的 Binder 代理对象 ApplicationThreadProxy(ATP)，并作为参数传给 attachApplication 方法，其中 ATP 是 ATN 的内部类。</p><a href=#414-activitymanagerserviceattachapplication><h3 id=414-activitymanagerserviceattachapplication><span class=hanchor arialabel=Anchor># </span>4.1.4 ActivityManagerService.attachApplication</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>attachApplication</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>thread</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>callingPid</span> <span class=o>=</span> <span class=n>Binder</span><span class=o>.</span><span class=na>getCallingPid</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>long</span> <span class=n>origId</span> <span class=o>=</span> <span class=n>Binder</span><span class=o>.</span><span class=na>clearCallingIdentity</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>attachApplicationLocked</span><span class=o>(</span><span class=n>thread</span><span class=o>,</span> <span class=n>callingPid</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Binder</span><span class=o>.</span><span class=na>restoreCallingIdentity</span><span class=o>(</span><span class=n>origId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#415-activitymanagerserviceattachapplicationlocked><h3 id=415-activitymanagerserviceattachapplicationlocked><span class=hanchor arialabel=Anchor># </span>4.1.5 ActivityManagerService.attachApplicationLocked</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>attachApplicationLocked</span><span class=o>(</span><span class=n>IApplicationThread</span> <span class=n>thread</span><span class=o>,</span> <span class=kt>int</span> <span class=n>pid</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ProcessRecord</span> <span class=n>app</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 绑定死亡通知
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>AppDeathRecipient</span> <span class=n>adr</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AppDeathRecipient</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>pid</span><span class=o>,</span> <span class=n>thread</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>asBinder</span><span class=o>().</span><span class=na>linkToDeath</span><span class=o>(</span><span class=n>adr</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>deathRecipient</span> <span class=o>=</span> <span class=n>adr</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>resetPackageList</span><span class=o>(</span><span class=n>mProcessStats</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果 system_server 进程死亡则重新启动进程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startProcessLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=s>&#34;link fail&#34;</span><span class=o>,</span> <span class=n>processName</span><span class=o>);</span> 
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取应用appInfo
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ApplicationInfo</span> <span class=n>appInfo</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationInfo</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>                <span class=o>?</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationInfo</span> <span class=o>:</span> <span class=n>app</span><span class=o>.</span><span class=na>info</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 绑定应用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>thread</span><span class=o>.</span><span class=na>bindApplication</span><span class=o>(</span><span class=n>processName</span><span class=o>,</span> <span class=n>appInfo</span><span class=o>,</span> <span class=n>providers</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>profilerInfo</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationArguments</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>instrumentationWatcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>app</span><span class=o>.</span><span class=na>instrumentationUiAutomationConnection</span><span class=o>,</span> <span class=n>testMode</span><span class=o>,</span> <span class=n>enableOpenGlTrace</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>isRestrictedBackupMode</span> <span class=o>||</span> <span class=o>!</span><span class=n>normalMode</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>persistent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>mConfiguration</span><span class=o>),</span> <span class=n>app</span><span class=o>.</span><span class=na>compat</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>getCommonServicesLocked</span><span class=o>(</span><span class=n>app</span><span class=o>.</span><span class=na>isolated</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=n>mCoreSettingsObserver</span><span class=o>.</span><span class=na>getCoreSettingsLocked</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>resetPackageList</span><span class=o>(</span><span class=n>mProcessStats</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>unlinkDeathRecipient</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// bindApplication 失败也要重启进程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startProcessLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=s>&#34;bind fail&#34;</span><span class=o>,</span> <span class=n>processName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果是 Activity: 检查最顶层可见的Activity是否等待在该进程中运行
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>normalMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>mStackSupervisor</span><span class=o>.</span><span class=na>attachApplicationLocked</span><span class=o>(</span><span class=n>app</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>didSomething</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>badApp</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果是 Service: 寻找所有需要在该进程中运行的服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>badApp</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>didSomething</span> <span class=o>|=</span> <span class=n>mServices</span><span class=o>.</span><span class=na>attachApplicationLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=n>processName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>badApp</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果是 BroadcastReceiver: 检查是否在这个进程中有下一个广播接收者
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>badApp</span> <span class=o>&amp;&amp;</span> <span class=n>isPendingBroadcastProcessLocked</span><span class=o>(</span><span class=n>pid</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>didSomething</span> <span class=o>|=</span> <span class=n>sendPendingBroadcastsLocked</span><span class=o>(</span><span class=n>app</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>badApp</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 检查是否在这个进程中有下一个 backup 代理
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>badApp</span> <span class=o>&amp;&amp;</span> <span class=n>mBackupTarget</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mBackupTarget</span><span class=o>.</span><span class=na>appInfo</span><span class=o>.</span><span class=na>uid</span> <span class=o>==</span> <span class=n>app</span><span class=o>.</span><span class=na>uid</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ensurePackageDexOpt</span><span class=o>(</span><span class=n>mBackupTarget</span><span class=o>.</span><span class=na>appInfo</span><span class=o>.</span><span class=na>packageName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>thread</span><span class=o>.</span><span class=na>scheduleCreateBackupAgent</span><span class=o>(</span><span class=n>mBackupTarget</span><span class=o>.</span><span class=na>appInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>compatibilityInfoForPackageLocked</span><span class=o>(</span><span class=n>mBackupTarget</span><span class=o>.</span><span class=na>appInfo</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>mBackupTarget</span><span class=o>.</span><span class=na>backupMode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>badApp</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>badApp</span><span class=o>)</span> <span class=o>{</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// 杀掉 badApp
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>app</span><span class=o>.</span><span class=na>kill</span><span class=o>(</span><span class=s>&#34;error during init&#34;</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>handleAppDiedLocked</span><span class=o>(</span><span class=n>app</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>didSomething</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 更新 adj(组件的权值)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>updateOomAdjLocked</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，通过 ATP 使用 Binder 向 ATN 发起 bindApplication 请求，然后通过 normalMode 字段判断是否为 Activity，如果是则执行 ActivityStackSupervisor 的 attachApplicationLocked 方法。</p><a href=#strong4151-activitythreadjavaapplicationthreadbindapplicationstrong><h4 id=strong4151-activitythreadjavaapplicationthreadbindapplicationstrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.1 ActivityThread.java::ApplicationThread.bindApplication</strong></h4></a><p>thread 对象类型是 ATP，通过 Binder 驱动调到了 ATN 的方法，ATN 是一个抽象类，它的实现都委托给了 ApplicationThread(这跟 AMS 跟 AMN 的关系一样)，ApplicationThread 作为 ActivityThread 的内部类存在，它的 binderApplication 方法如下：</p><p>[ActivityThread.java::ApplicationThread](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/ActivityThread.java)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>bindApplication</span><span class=o>(</span><span class=n>String</span> <span class=n>processName</span><span class=o>,</span> <span class=n>ApplicationInfo</span> <span class=n>appInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>ProviderInfo</span><span class=o>&gt;</span> <span class=n>providers</span><span class=o>,</span> <span class=n>ComponentName</span> <span class=n>instrumentationName</span><span class=o>,</span> <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Bundle</span> <span class=n>instrumentationArgs</span><span class=o>,</span> <span class=n>IInstrumentationWatcher</span> <span class=n>instrumentationWatcher</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>IUiAutomationConnection</span> <span class=n>instrumentationUiConnection</span><span class=o>,</span> <span class=kt>int</span> <span class=n>debugMode</span><span class=o>,</span> <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>    <span class=n>enableOpenGlTrace</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isRestrictedBackupMode</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>persistent</span><span class=o>,</span> <span class=n>Configuration</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>,</span> <span class=n>CompatibilityInfo</span> <span class=n>compatInfo</span><span class=o>,</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>IBinder</span><span class=o>&gt;</span> <span class=n>services</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>coreSettings</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>services</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将services缓存起来, 减少binder检索服务的次数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ServiceManager</span><span class=o>.</span><span class=na>initServiceCache</span><span class=o>(</span><span class=n>services</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送消息 H.BIND_APPLICATION 给 Handler 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sendMessage</span><span class=o>(</span><span class=n>H</span><span class=o>.</span><span class=na>BIND_APPLICATION</span><span class=o>,</span> <span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>H 是 ActivityThread 中的一个 Handler 对象，用于处理发送过来的各种消息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>class</span> <span class=nc>H</span> <span class=kd>extends</span> <span class=n>Handler</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>BIND_APPLICATION</span>        <span class=o>=</span> <span class=n>110</span><span class=o>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>BIND_APPLICATION</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>Trace</span><span class=o>.</span><span class=na>traceBegin</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>,</span> <span class=s>&#34;bindApplication&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>AppBindData</span> <span class=n>data</span> <span class=o>=</span> <span class=o>(</span><span class=n>AppBindData</span><span class=o>)</span><span class=n>msg</span><span class=o>.</span><span class=na>obj</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>handleBindApplication</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Trace</span><span class=o>.</span><span class=na>traceEnd</span><span class=o>(</span><span class=n>Trace</span><span class=o>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>调用了 handleBindApplication 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleBindApplication</span><span class=o>(</span><span class=n>AppBindData</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取 LoadedApk 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>data</span><span class=o>.</span><span class=na>info</span> <span class=o>=</span> <span class=n>getPackageInfoNoCheck</span><span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>appInfo</span><span class=o>,</span> <span class=n>data</span><span class=o>.</span><span class=na>compatInfo</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建 ContextImpl 上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>ContextImpl</span> <span class=n>appContext</span> <span class=o>=</span> <span class=n>ContextImpl</span><span class=o>.</span><span class=na>createAppContext</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>data</span><span class=o>.</span><span class=na>info</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建 Instrumentation 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>instrumentationName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mInstrumentation</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Instrumentation</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 LoadedApk 的 makeApplication 方法创建 Application
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Application</span> <span class=n>app</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>makeApplication</span><span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>restrictedBackupMode</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mInitialApplication</span> <span class=o>=</span> <span class=n>app</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>onCreate</span><span class=o>(</span><span class=n>data</span><span class=o>.</span><span class=na>instrumentationArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 Application.onCreate 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callApplicationOnCreate</span><span class=o>(</span><span class=n>app</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>StrictMode</span><span class=o>.</span><span class=na>setThreadPolicy</span><span class=o>(</span><span class=n>savedPolicy</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong4152-activitystacksupervisorattachapplicationlockedstrong><h4 id=strong4152-activitystacksupervisorattachapplicationlockedstrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2 ActivityStackSupervisor.attachApplicationLocked</strong></h4></a><p>在 <strong>4.1.4</strong> 小节中通过 Binder 向 ActivityThread 发起 bindApplication 请求后，会根据启动组件的类型去做相应的处理，如果是 Acitivity，则会调用 ActivityStackSupervisor 的 attachApplicationLocked 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>attachApplicationLocked</span><span class=o>(</span><span class=n>ProcessRecord</span> <span class=n>app</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>String</span> <span class=n>processName</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=na>processName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>didSomething</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>displayNdx</span> <span class=o>=</span> <span class=n>mActivityDisplays</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>;</span> <span class=n>displayNdx</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>;</span> <span class=o>--</span><span class=n>displayNdx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ActivityStack</span><span class=o>&gt;</span> <span class=n>stacks</span> <span class=o>=</span> <span class=n>mActivityDisplays</span><span class=o>.</span><span class=na>valueAt</span><span class=o>(</span><span class=n>displayNdx</span><span class=o>).</span><span class=na>mStacks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>stackNdx</span> <span class=o>=</span> <span class=n>stacks</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>;</span> <span class=n>stackNdx</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>;</span> <span class=o>--</span><span class=n>stackNdx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>ActivityStack</span> <span class=n>stack</span> <span class=o>=</span> <span class=n>stacks</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>stackNdx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(!</span><span class=n>isFrontStack</span><span class=o>(</span><span class=n>stack</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取前台stack中栈顶第一个非 finishing 状态的 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ActivityRecord</span> <span class=n>hr</span> <span class=o>=</span> <span class=n>stack</span><span class=o>.</span><span class=na>topRunningActivityLocked</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>hr</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>hr</span><span class=o>.</span><span class=na>app</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>app</span><span class=o>.</span><span class=na>uid</span> <span class=o>==</span> <span class=n>hr</span><span class=o>.</span><span class=na>info</span><span class=o>.</span><span class=na>applicationInfo</span><span class=o>.</span><span class=na>uid</span> <span class=o>&amp;&amp;</span> <span class=n>processName</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>hr</span><span class=o>.</span><span class=na>processName</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 真正的启动 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>realStartActivityLocked</span><span class=o>(</span><span class=n>hr</span><span class=o>,</span> <span class=n>app</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>true</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>didSomething</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>didSomething</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong41521-activitystacksupervisorrealstartactivitylockedstrong><h5 id=strong41521-activitystacksupervisorrealstartactivitylockedstrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.1 ActivityStackSupervisor.realStartActivityLocked</strong></h5></a><p>前面 <strong>2.1.8 ActivityStackSupervisor.startSpecificActivityLocked</strong> 小节中分析过，如果当前 Activity 依附的 Application 已经被启动，则调用 realStartActivityLocked 方法，否则创建新的进程，再创建新的进程之后，两个流程的在这里合并起来了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>realStartActivityLocked</span><span class=o>(</span><span class=n>ActivityRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>ProcessRecord</span> <span class=n>app</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>andResume</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>checkConfig</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ActivityStack</span> <span class=n>stack</span> <span class=o>=</span> <span class=n>task</span><span class=o>.</span><span class=na>stack</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=na>forceProcessStateUpTo</span><span class=o>(</span><span class=n>mService</span><span class=o>.</span><span class=na>mTopProcessState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过 Binder 调用 ApplicationThread 的 scheduleLaunchActivity 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>app</span><span class=o>.</span><span class=na>thread</span><span class=o>.</span><span class=na>scheduleLaunchActivity</span><span class=o>(</span><span class=k>new</span> <span class=n>Intent</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>),</span> <span class=n>r</span><span class=o>.</span><span class=na>appToken</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>identityHashCode</span><span class=o>(</span><span class=n>r</span><span class=o>),</span> <span class=n>r</span><span class=o>.</span><span class=na>info</span><span class=o>,</span> <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>mService</span><span class=o>.</span><span class=na>mConfiguration</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>stack</span><span class=o>.</span><span class=na>mOverrideConfig</span><span class=o>),</span> <span class=n>r</span><span class=o>.</span><span class=na>compat</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>launchedFromPackage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>task</span><span class=o>.</span><span class=na>voiceInteractor</span><span class=o>,</span> <span class=n>app</span><span class=o>.</span><span class=na>repProcState</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>icicle</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>persistentState</span><span class=o>,</span> <span class=n>results</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>newIntents</span><span class=o>,</span> <span class=o>!</span><span class=n>andResume</span><span class=o>,</span> <span class=n>mService</span><span class=o>.</span><span class=na>isNextTransitionForward</span><span class=o>(),</span> <span class=n>profilerInfo</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>launchFailed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 第二次启动失败，则结束该 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mService</span><span class=o>.</span><span class=na>appDiedLocked</span><span class=o>(</span><span class=n>app</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>stack</span><span class=o>.</span><span class=na>requestFinishActivityLocked</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>appToken</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;2nd-crash&#34;</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 第一个启动失败，则重启进程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>app</span><span class=o>.</span><span class=na>activities</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>r</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里有一次使用 Binder 调用 ApplicationThread 的 scheduleLaunchActivity 方法。</p><a href=#strong41522-applicationthreadschedulelaunchactivitystrong><h5 id=strong41522-applicationthreadschedulelaunchactivitystrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.2 ApplicationThread.scheduleLaunchActivity</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>scheduleLaunchActivity</span><span class=o>(</span><span class=n>Intent</span> <span class=n>intent</span><span class=o>,</span> <span class=n>IBinder</span> <span class=n>token</span><span class=o>,</span> <span class=kt>int</span> <span class=n>ident</span><span class=o>,</span> <span class=n>ActivityInfo</span> 
</span></span><span class=line><span class=cl>        <span class=n>info</span><span class=o>,</span> <span class=n>Configuration</span> <span class=n>curConfig</span><span class=o>,</span> <span class=n>Configuration</span> <span class=n>overrideConfig</span><span class=o>,</span> <span class=n>CompatibilityInfo</span> 
</span></span><span class=line><span class=cl>        <span class=n>compatInfo</span><span class=o>,</span> <span class=n>String</span> <span class=n>referrer</span><span class=o>,</span> <span class=n>IVoiceInteractor</span> <span class=n>voiceInteractor</span><span class=o>,</span> <span class=kt>int</span> <span class=n>procState</span><span class=o>,</span> <span class=n>Bundle</span> 
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=o>,</span> <span class=n>PersistableBundle</span> <span class=n>persistentState</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ResultInfo</span><span class=o>&gt;</span> <span class=n>pendingResults</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>ReferrerIntent</span><span class=o>&gt;</span> <span class=n>pendingNewIntents</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>notResumed</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>isForward</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>ProfilerInfo</span> <span class=n>profilerInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>updateProcessState</span><span class=o>(</span><span class=n>procState</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ActivityClientRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ActivityClientRecord</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>sendMessage</span><span class=o>(</span><span class=n>H</span><span class=o>.</span><span class=na>LAUNCH_ACTIVITY</span><span class=o>,</span> <span class=n>r</span><span class=o>);</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面提到过，H 是 ActivityThread 中一个 Handler 类，它接收到 LAUNCH_ACTIVITY 消息后会调用 handleLaunchActivity 方法。</p><a href=#strong41523-activitythreadhandlelaunchactivitystrong><h5 id=strong41523-activitythreadhandlelaunchactivitystrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.3 ActivityThread.handleLaunchActivity</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleLaunchActivity</span><span class=o>(</span><span class=n>ActivityClientRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>customIntent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化 WMS
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WindowManagerGlobal</span><span class=o>.</span><span class=na>initialize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行 performLaunchActivity 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Activity</span> <span class=n>a</span> <span class=o>=</span> <span class=n>performLaunchActivity</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>customIntent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=na>createdConfig</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Configuration</span><span class=o>(</span><span class=n>mConfiguration</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Bundle</span> <span class=n>oldState</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 执行 handleResumeActivity 方法，最终调用 onStart 和 onResume 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>handleResumeActivity</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>isForward</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>r</span><span class=o>.</span><span class=na>startsNotResumed</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mFinished</span> <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>startsNotResumed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>.</span><span class=na>mCalled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callActivityOnPause</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>paused</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 停止该 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ActivityManagerNative</span><span class=o>.</span><span class=na>getDefault</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>finishActivity</span><span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span> <span class=n>Activity</span><span class=o>.</span><span class=na>RESULT_CANCELED</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong41424-applicationthreadperformlaunchactivitystrong><h5 id=strong41424-applicationthreadperformlaunchactivitystrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.4.2.4 ApplicationThread.performLaunchActivity</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>Activity</span> <span class=nf>performLaunchActivity</span><span class=o>(</span><span class=n>ActivityClientRecord</span> <span class=n>r</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>customIntent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Activity</span> <span class=n>activity</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassLoader</span> <span class=n>cl</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>packageInfo</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Instrumentation 中使用反射创建 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>activity</span> <span class=o>=</span> <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>newActivity</span><span class=o>(</span><span class=n>cl</span><span class=o>,</span> <span class=n>component</span><span class=o>.</span><span class=na>getClassName</span><span class=o>(),</span> <span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建 Application 对象并调用 Application 的 onCreate 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Application</span> <span class=n>app</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>packageInfo</span><span class=o>.</span><span class=na>makeApplication</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=n>mInstrumentation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>activity</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=n>Window</span> <span class=n>window</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>mPendingRemoveWindow</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=o>.</span><span class=na>mPreserveWindow</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>window</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>mPendingRemoveWindow</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=na>mPendingRemoveWindow</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=na>mPendingRemoveWindowManager</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// attach 到 Window 上
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>activity</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=n>appContext</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>getInstrumentation</span><span class=o>(),</span> <span class=n>r</span><span class=o>.</span><span class=na>token</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>r</span><span class=o>.</span><span class=na>ident</span><span class=o>,</span> <span class=n>app</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>intent</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>activityInfo</span><span class=o>,</span> <span class=n>title</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>parent</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>r</span><span class=o>.</span><span class=na>embeddedID</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>lastNonConfigurationInstances</span><span class=o>,</span> <span class=n>config</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>r</span><span class=o>.</span><span class=na>referrer</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>voiceInteractor</span><span class=o>,</span> <span class=n>window</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>customIntent</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>activity</span><span class=o>.</span><span class=na>mIntent</span> <span class=o>=</span> <span class=n>customIntent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=na>lastNonConfigurationInstances</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>activity</span><span class=o>.</span><span class=na>mStartedActivity</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>theme</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=na>activityInfo</span><span class=o>.</span><span class=na>getThemeResource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>theme</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 设置主题
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>activity</span><span class=o>.</span><span class=na>setTheme</span><span class=o>(</span><span class=n>theme</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>activity</span><span class=o>.</span><span class=na>mCalled</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>isPersistable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 重新创建的 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callActivityOnCreate</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>persistentState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 第一次创建的 Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>mInstrumentation</span><span class=o>.</span><span class=na>callActivityOnCreate</span><span class=o>(</span><span class=n>activity</span><span class=o>,</span> <span class=n>r</span><span class=o>.</span><span class=na>state</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>  <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>activity</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong41525-instrumentationcallactivityoncreatestrong><h5 id=strong41525-instrumentationcallactivityoncreatestrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.5 Instrumentation.callActivityOnCreate</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>callActivityOnCreate</span><span class=o>(</span><span class=n>Activity</span> <span class=n>activity</span><span class=o>,</span> <span class=n>Bundle</span> <span class=n>icicle</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>PersistableBundle</span> <span class=n>persistentState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>prePerformCreate</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 Activity 的 performCreate 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>activity</span><span class=o>.</span><span class=na>performCreate</span><span class=o>(</span><span class=n>icicle</span><span class=o>,</span> <span class=n>persistentState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>postPerformCreate</span><span class=o>(</span><span class=n>activity</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#strong41526-activityperformcreatestrong><h5 id=strong41526-activityperformcreatestrong><span class=hanchor arialabel=Anchor># </span><strong>4.1.5.2.6 Activity.performCreate</strong></h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>void</span> <span class=nf>performCreate</span><span class=o>(</span><span class=n>Bundle</span> <span class=n>icicle</span><span class=o>,</span> <span class=n>PersistableBundle</span> <span class=n>persistentState</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>restoreHasCurrentPermissionRequest</span><span class=o>(</span><span class=n>icicle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>onCreate</span><span class=o>(</span><span class=n>icicle</span><span class=o>,</span> <span class=n>persistentState</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mActivityTransitionState</span><span class=o>.</span><span class=na>readState</span><span class=o>(</span><span class=n>icicle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>performCreateCommon</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>终于，onCreate 方法被调用了！！！</p><a href=#42-小结><h2 id=42-小结><span class=hanchor arialabel=Anchor># </span>4.2 小结</h2></a><p>从 ActivityThread 到最终 Activity 被创建及生命周期被调用，核心过程涉及到了三次 Binder IPC 过程，分别是：ActivityThread 调用 AMS 的 attachApplication 方法、AMS 调用 ApplicationThread 的 bindApplication 方法、ASS 调用 Application 的 attachApplicationLocked 方法，整个过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045420.png width=auto alt></p><a href=#5-总结><h1 id=5-总结><span class=hanchor arialabel=Anchor># </span>5. 总结</h1></a><p>纵观整个过程，从 Launcher 到 AMS、从 AMS 再到 Zygote、再从 Zygote 到 ActivityThread，最后在 ActivitThread 中层层调用到 Activity 的生命周期方法，中间涉及到了无数的细节，但总体上脉络还是非常清晰的，各个 Android 版本的 Framework 层代码可以某些过程的实现不太一样，但是整个调用流程大体上也是相同的，借用
<a href=http://gityuan.com/android/ rel=noopener>Gityuan</a> 大神的一张图作为结尾：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045430.png width=auto alt></p><p><strong>系列文章</strong></p><p><a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>按下电源键后竟然发生了这一幕 —— Android 系统启动流程分析</a></p><p><a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析</a>（本文）</p><p><a href=https://guanpj.cn/2017/11/09/Android-View-Workflow/ rel=noopener>屏幕上内容究竟是怎样画出来的 —— Android View 工作原理详解</a></p><p><strong>参考文章</strong></p><p><a href=http://gityuan.com/2016/03/12/start-activity/ rel=noopener>startActivity 启动过程分析</a></p><p><a href=http://liuwangshu.cn/framework/component/1-activity-start-1.html rel=noopener>Android 深入四大组件（一）应用程序启动过程（前篇）</a></p><blockquote><p>如果你对文章内容有疑问或者有不同的意见，欢迎留言，我们一同探讨。</p></blockquote></article><hr><div class=page-end id=footer><div class=fixed-right><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></div></div></body></html>