<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="使用  导入依赖。  1 2 3 4 5 6 7 8 9  implementation &#34;com.squareup.okhttp3:okhttp:4.9.0&#34; implementation &#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34; implementation &#34;com.squareup.retrofit2:retrofit:2.9.0&#34; implementation &#34;com."><meta property="og:title" content="Retrofit 使用及源码分析"><meta property="og:description" content="使用  导入依赖。  1 2 3 4 5 6 7 8 9  implementation &#34;com.squareup.okhttp3:okhttp:4.9.0&#34; implementation &#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34; implementation &#34;com.squareup.retrofit2:retrofit:2.9.0&#34; implementation &#34;com."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Retrofit 使用及源码分析"><meta name=twitter:description content="使用  导入依赖。  1 2 3 4 5 6 7 8 9  implementation &#34;com.squareup.okhttp3:okhttp:4.9.0&#34; implementation &#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34; implementation &#34;com.squareup.retrofit2:retrofit:2.9.0&#34; implementation &#34;com."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>Retrofit 使用及源码分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.592437b1fbffed6c8a18843d158121af.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.53666c8c2dda7453db60134845619aac.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.4de5d4afe899a2b4bf5a54d74c9bc8fa.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>🌻 guanpjの花园 🌵</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Retrofit 使用及源码分析</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/Retrofit/>Retrofit</a></li><li><a href=https://www.guanpj.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>源码解析</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#使用>使用</a></li><li><a href=#解析>解析</a><ol><li><a href=#retrofitbuilder>Retrofit.Builder</a></li><li><a href=#retrofitcreate>Retrofit.create</a></li><li><a href=#loadservicemethodmethod>loadServiceMethod(method)</a><ol><li><a href=#createcalladapter>createCallAdapter</a><ol><li><a href=#defaultcalladapterfactoryget>DefaultCallAdapterFactory.get()</a></li><li><a href=#rxjava3calladapterfactoryget>RxJava3CallAdapterFactory.get()</a></li><li><a href=#completablefuturecalladapterfactoryget>CompletableFutureCallAdapterFactory.get()</a></li><li><a href=#小结>小结</a></li></ol></li><li><a href=#createresponseconverter>createResponseConverter</a><ol><li><a href=#builtinconvertersresponsebodyconverter>BuiltInConverters.responseBodyConverter()</a></li><li><a href=#gsonconverterfactory-responsebodyconverter>GsonConverterFactory. responseBodyConverter()</a></li><li><a href=#optionalconverterfactoryresponsebodyconverter>OptionalConverterFactory.responseBodyConverter()</a></li><li><a href=#小结-1>小结</a></li></ol></li><li><a href=#return>return</a><ol><li><a href=#calladapted>CallAdapted</a></li><li><a href=#suspendforresponse>SuspendForResponse</a></li><li><a href=#suspendforbody>SuspendForBody</a></li></ol></li></ol></li><li><a href=#httpservicemethodinvokeobject-args>HttpServiceMethod.invoke(Object[] args)</a><ol><li><a href=#new-okhttpcall>new OkHttpCall&lt;>()</a></li><li><a href=#httpservicemethodadapt>HttpServiceMethod.adapt()</a><ol><li><a href=#calladaptedadapt>CallAdapted.adapt</a><ol><li><a href=#defaultcalladapterfactory-中的匿名-calladapter>DefaultCallAdapterFactory 中的匿名 CallAdapter</a></li><li><a href=#rxjava3calladapterfactoryrxjava3calladapter>RxJava3CallAdapterFactory.RxJava3CallAdapter</a></li><li><a href=#completablefuturecalladapterfactoryresponsecalladapter>CompletableFutureCallAdapterFactory.ResponseCallAdapter</a></li><li><a href=#小结-2>小结</a></li></ol></li><li><a href=#suspendforresponseadapt>SuspendForResponse.adapt</a></li><li><a href=#suspendforbodyadapt>SuspendForBody.adapt</a></li></ol></li></ol></li><li><a href=#callenqueue>Call.enqueue()</a></li><li><a href=#observablesubscribe>Observable.subscribe()</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></details></aside><a href=#使用><h1 id=使用><span class=hanchor arialabel=Anchor># </span>使用</h1></a><ol><li>导入依赖。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.okhttp3:okhttp:4.9.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.retrofit2:retrofit:2.9.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.retrofit2:converter-gson:2.9.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.retrofit2:adapter-rxjava3:2.9.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;io.reactivex.rxjava3:rxjava:3.0.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;io.reactivex.rxjava3:rxandroid:3.0.0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>创建一个 interface 作为 WebService 的请求集合，在里面用注解写入需要配置的请求方法。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>interface</span> <span class=nc>GitHubService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>listRepos</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>Call</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>listReposRx</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>Observable</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>listReposCompletable</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>CompletableFuture</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>suspend</span> <span class=k>fun</span> <span class=nf>listReposSuspend</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>listReposOptional</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>Call</span><span class=p>&lt;</span><span class=n>Optional</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>在正式代码里用 Retrofit 创建出 interface 的实例。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>user</span> <span class=p>=</span> <span class=s2>&#34;guanpj&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>okHttpClient</span> <span class=p>=</span> <span class=n>OkHttpClient</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>connectTimeout</span><span class=p>(</span><span class=m>15</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>writeTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>readTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>proxy</span><span class=p>(</span><span class=n>Proxy</span><span class=p>.</span><span class=n>NO_PROXY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addInterceptor</span><span class=p>(</span><span class=n>HttpLoggingInterceptor</span> <span class=p>{</span> <span class=n>message</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>BuildConfig</span><span class=p>.</span><span class=n>DEBUG</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=p>.</span><span class=n>i</span><span class=p>(</span><span class=s2>&#34;OkHttp&#34;</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>retrofit</span> <span class=p>=</span> <span class=n>Retrofit</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>client</span><span class=p>(</span><span class=n>okHttpClient</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>baseUrl</span><span class=p>(</span><span class=s2>&#34;https://api.github.com/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addCallAdapterFactory</span><span class=p>(</span><span class=n>RxJava3CallAdapterFactory</span><span class=p>.</span><span class=n>create</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addConverterFactory</span><span class=p>(</span><span class=n>GsonConverterFactory</span><span class=p>.</span><span class=n>create</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>service</span> <span class=p>=</span> <span class=n>retrofit</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>GitHubService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>调用创建出的 Service 实例的对应方法，创建出相应的可以用来发起网络请求的 Call 对象 / Obsevable 对象 / suspend 挂起函数，并发起请求。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>listRepos</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listRepos</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>listRepos</span><span class=p>.</span><span class=n>enqueue</span><span class=p>(</span><span class=k>object</span> <span class=err>: </span><span class=nc>retrofit2</span><span class=p>.</span><span class=n>Callback</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onFailure</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>retrofit2</span><span class=p>.</span><span class=n>Call</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?&gt;,</span> <span class=n>t</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onResponse</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>retrofit2</span><span class=p>.</span><span class=n>Call</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?&gt;,</span> <span class=n>response</span><span class=p>:</span> <span class=n>retrofit2</span><span class=p>.</span><span class=n>Response</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?&gt;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;Response: </span><span class=si>${response.body()!![0].name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>listReposRx</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listReposRx</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>listReposRx</span><span class=p>.</span><span class=n>subscribeOn</span><span class=p>(</span><span class=n>Schedulers</span><span class=p>.</span><span class=n>io</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>observeOn</span><span class=p>(</span><span class=n>AndroidSchedulers</span><span class=p>.</span><span class=n>mainThread</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>subscribe</span><span class=p>(</span><span class=k>object</span> <span class=err>: </span><span class=nc>Observer</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onSubscribe</span><span class=p>(</span><span class=n>d</span><span class=p>:</span> <span class=n>Disposable</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onNext</span><span class=p>(</span><span class=n>t</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;size:</span><span class=si>${t?.size}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onComplete</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onError</span><span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>future</span><span class=p>:</span> <span class=n>CompletableFuture</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listReposCompletable</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>future</span><span class=p>.</span><span class=n>thenAccept</span> <span class=p>{</span> <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;size:</span><span class=si>${it.size}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MainScope</span><span class=p>().</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>list</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listReposSuspend</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;size:</span><span class=si>${list.size}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>call</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listReposOptional</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>thread</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 实际上这里是会抛出异常的，原因见后文分析
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=py>optionalList</span> <span class=p>=</span> <span class=n>call</span><span class=p>.</span><span class=n>execute</span><span class=p>().</span><span class=n>body</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>optionalList</span><span class=o>?.</span><span class=n>ifPresent</span> <span class=p>{</span> <span class=n>list</span> <span class=o>-&gt;</span> <span class=n>list</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=k>it</span><span class=p>.</span><span class=n>full_name</span><span class=p>)</span> <span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#解析><h1 id=解析><span class=hanchor arialabel=Anchor># </span>解析</h1></a><p>在正式开始前，先简单介绍一下几个关键词，供备忘：</p><ul><li><code>CallAdapter&lt;R, T></code>：将一个 Call 从响应类型 R 适配成 T 类型的适配器。<ul><li><code>Type responseType()</code> 适配器将 HTTP 响应体转换为 Java 对象时，该对象的类型。比如 <code>Call&lt;Repo></code> 的返回值是 Repo</li><li><code>T adapt(Call&lt;R> call)</code>：返回一个代理了 call 的 T</li></ul></li><li><code>CallAdapter.Factory</code>：用于创建 CallAdapter 实例的工厂<ul><li><code>CallAdapter&lt;?, ?> get(Type returnType, Annotation[] annotations, Retrofit retrofit)</code>：返回一个可以返回 returnType 的接口方法的 CallAdapter，如果不能处理，则返回 null</li></ul></li><li><code>Converter&lt;F, T></code>：将 F 转换为 T 类型的值的转换器。<ul><li><code>T convert(F value) throws IOException</code></li></ul></li><li><code>Converter.Factory</code>：基于一个类型和目标类型创建一个 Converter 实例的工厂<ul><li><code>Converter&lt;ResponseBody, ?> responseBodyConverter(Type type, Annotation[] annotations, Retrofit retrofit)</code>：返回一个可以转换 HTTP 响应体到 type 的转换器</li><li><code>Converter&lt;?, RequestBody> requestBodyConverter(Type type, Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit)</code>：返回一个可以转换 type 到 HTTP 请求体的转换器</li><li><code>Converter&lt;?, String> stringConverter(Type type, Annotation[] annotations, Retrofit retrofit)</code>：返回一个可以转换 type 到 String 的转换器</li></ul></li></ul><a href=#retrofitbuilder><h2 id=retrofitbuilder><span class=hanchor arialabel=Anchor># </span>Retrofit.Builder</h2></a><p>如果想知道 Retrofit 在创建时干了些什么，就不得不看 Retrofit.Builder ，它的构造方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Builder</span><span class=o>(</span><span class=n>Platform</span> <span class=n>platform</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>platform</span> <span class=o>=</span> <span class=n>platform</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Builder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>(</span><span class=n>Platform</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里首先是调用了 <code>Platform.get()</code> 获取了一个 Platform 实例，然后保存到变量 platform 中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Platform</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Platform</span> <span class=n>PLATFORM</span> <span class=o>=</span> <span class=n>findPlatform</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=n>Platform</span> <span class=nf>get</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>PLATFORM</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=n>Platform</span> <span class=nf>findPlatform</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;Dalvik&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;java.vm.name&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=k>new</span> <span class=n>Android</span><span class=o>()</span> <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>:</span> <span class=k>new</span> <span class=n>Platform</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>hasJava8Types</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=nd>@Nullable</span> <span class=n>Constructor</span><span class=o>&lt;</span><span class=n>Lookup</span><span class=o>&gt;</span> <span class=n>lookupConstructor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Platform</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>hasJava8Types</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>hasJava8Types</span> <span class=o>=</span> <span class=n>hasJava8Types</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Constructor</span><span class=o>&lt;</span><span class=n>Lookup</span><span class=o>&gt;</span> <span class=n>lookupConstructor</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>hasJava8Types</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Because the service interface might not be public, we need to use a MethodHandle lookup
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// that ignores the visibility of the declaringClass.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>lookupConstructor</span> <span class=o>=</span> <span class=n>Lookup</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getDeclaredConstructor</span><span class=o>(</span><span class=n>Class</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kt>int</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>lookupConstructor</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoClassDefFoundError</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Android API 24 or 25 where Lookup doesn&#39;t exist. Calling default methods on non-public
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// interfaces will fail, but there&#39;s nothing we can do about it.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchMethodException</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Assume JDK 14+ which contains a fix that allows a regular lookup to succeed.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// See https://bugs.openjdk.java.net/browse/JDK-8209005.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>lookupConstructor</span> <span class=o>=</span> <span class=n>lookupConstructor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=n>Executor</span> <span class=nf>defaultCallbackExecutor</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 1、如果 API &lt; 24，这里列表中只有一个 DefaultCallAdapterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 否则多一个 CompletableFutureCallAdapterFactory 用于支持 Java8
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>CallAdapter</span><span class=o>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=nf>defaultCallAdapterFactories</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@Nullable</span> <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DefaultCallAdapterFactory</span> <span class=n>executorFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultCallAdapterFactory</span><span class=o>(</span><span class=n>callbackExecutor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=n>asList</span><span class=o>(</span><span class=n>CompletableFutureCallAdapterFactory</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>,</span> <span class=n>executorFactory</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=n>singletonList</span><span class=o>(</span><span class=n>executorFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=nf>defaultCallAdapterFactoriesSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span> <span class=o>?</span> <span class=n>2</span> <span class=o>:</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 2、如果 API &lt; 24，这里列表为空；
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 否则会有一个 OptionalConverterFactory 用于支持 Java8
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Converter</span><span class=o>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=nf>defaultConverterFactories</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span> <span class=o>?</span> <span class=n>singletonList</span><span class=o>(</span><span class=n>OptionalConverterFactory</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>)</span> <span class=o>:</span> <span class=n>emptyList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=nf>defaultConverterFactoriesSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span> <span class=o>?</span> <span class=n>1</span> <span class=o>:</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@IgnoreJRERequirement</span> <span class=c1>// Only called on API 24+.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>boolean</span> <span class=nf>isDefaultMethod</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isDefault</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@IgnoreJRERequirement</span> <span class=c1>// Only called on API 26+.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=n>Object</span> <span class=nf>invokeDefaultMethod</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>declaringClass</span><span class=o>,</span> <span class=n>Object</span> <span class=n>object</span><span class=o>,</span> <span class=n>Object</span><span class=o>...</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=kd>throws</span> <span class=n>Throwable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Lookup</span> <span class=n>lookup</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>lookupConstructor</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=n>lookupConstructor</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=n>declaringClass</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span> <span class=cm>/* trusted */</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>:</span> <span class=n>MethodHandles</span><span class=o>.</span><span class=na>lookup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>lookup</span><span class=o>.</span><span class=na>unreflectSpecial</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>declaringClass</span><span class=o>).</span><span class=na>bindTo</span><span class=o>(</span><span class=n>object</span><span class=o>).</span><span class=na>invokeWithArguments</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Android</span> <span class=kd>extends</span> <span class=n>Platform</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Android</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//API 24 以上才支持 Java8
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kd>super</span><span class=o>(</span><span class=n>Build</span><span class=o>.</span><span class=na>VERSION</span><span class=o>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=n>24</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Executor</span> <span class=nf>defaultCallbackExecutor</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>MainThreadExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=nf>invokeDefaultMethod</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>declaringClass</span><span class=o>,</span> <span class=n>Object</span> <span class=n>object</span><span class=o>,</span> <span class=n>Object</span><span class=o>...</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Throwable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Build</span><span class=o>.</span><span class=na>VERSION</span><span class=o>.</span><span class=na>SDK_INT</span> <span class=o>&lt;</span> <span class=n>26</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>UnsupportedOperationException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Calling default methods on API 24 and 25 is not supported&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>invokeDefaultMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>declaringClass</span><span class=o>,</span> <span class=n>object</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>MainThreadExecutor</span> <span class=kd>implements</span> <span class=n>Executor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>Looper</span><span class=o>.</span><span class=na>getMainLooper</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>      <span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=o>.</span><span class=na>post</span><span class=o>(</span><span class=n>r</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>findPlatform 方法会返回一个 Android 类型的 Platform 对象，它继承自 Platform 并重写了 defaultCallbackExecutor 返回一个 MainThreadExecutor。</p><p>同时注意 43 行注释一和 57 行注释二关于 defaultCallAdapterFactories 和 defaultConverterFactories 集合的赋值情况。</p><p>接下来我们在创建 Retrofit 对象的时候通过 Retrofit.Builder 设置了一些参数，这些参数都会保存到成员变量中，我们对照 Retrofit.Builder.build 方法进行解释：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Retrofit</span> <span class=nf>build</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>baseUrl</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Base URL required.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// callFactory 就是传入的 OkHttpClient
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 因为 OkHttpClient 实现了 okhttp3.Call.Factory这个接口
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>callFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>callFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>callFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpClient</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果没有设置 callbackExecutor，则获取 platform 的默认 callbackExecutor
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 这里被赋值为了 MainThreadExecutor
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Executor</span> <span class=n>callbackExecutor</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>callbackExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>callbackExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>callbackExecutor</span> <span class=o>=</span> <span class=n>platform</span><span class=o>.</span><span class=na>defaultCallbackExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 在配置的时候设置了一个 RxJava3CallAdapterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 然后这里另外添加了一个 DefaultCallAdapterFactory，并传入刚获取的 callbackExecutor 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 如果 Android API &gt;= 24，默认还有一个 CompletableFutureCallAdapterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Make a defensive copy of the adapters and add the default Call adapter.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;</span><span class=n>CallAdapter</span><span class=o>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=n>callAdapterFactories</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=k>this</span><span class=o>.</span><span class=na>callAdapterFactories</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>platform</span><span class=o>.</span><span class=na>defaultCallAdapterFactories</span><span class=o>(</span><span class=n>callbackExecutor</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Make a defensive copy of the converters.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;</span><span class=n>Converter</span><span class=o>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=n>converterFactories</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>          <span class=n>1</span> <span class=o>+</span> <span class=k>this</span><span class=o>.</span><span class=na>converterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>+</span> <span class=n>platform</span><span class=o>.</span><span class=na>defaultConverterFactoriesSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Add the built-in converter factory first. This prevents overriding its behavior but also
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ensures correct behavior when using converters that consume all types.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 添加内置 ConverterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>converterFactories</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>BuiltInConverters</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 添加我们设置的 GsonConverterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>converterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>converterFactories</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果 Android API &gt;= 24，添加默认的 OptionalConverterFactory 支持 Java8
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>converterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>platform</span><span class=o>.</span><span class=na>defaultConverterFactories</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Retrofit</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>baseUrl</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>unmodifiableList</span><span class=o>(</span><span class=n>converterFactories</span><span class=o>),</span>
</span></span><span class=line><span class=cl>      <span class=n>unmodifiableList</span><span class=o>(</span><span class=n>callAdapterFactories</span><span class=o>),</span>
</span></span><span class=line><span class=cl>      <span class=n>callbackExecutor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>validateEagerly</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里首先是根据配置的内容和 Platform 获取到 callAdapterFactories 和 converterFactories 集合，然后利用这些参数创建一个 Retrofit 实例。</p><p>需要注意的是，第 37-39 行添加用户配置的 ConverterFactory 和 Platform 默认的 ConverterFactory 的顺序值得怀疑。后文分析过程将会进行解释。</p><a href=#retrofitcreate><h2 id=retrofitcreate><span class=hanchor arialabel=Anchor># </span>Retrofit.create</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>create</span><span class=o>(</span><span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>service</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>validateServiceInterface</span><span class=o>(</span><span class=n>service</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=n>Proxy</span><span class=o>.</span><span class=na>newProxyInstance</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>service</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>          <span class=k>new</span> <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=o>{</span><span class=n>service</span><span class=o>},</span>
</span></span><span class=line><span class=cl>          <span class=k>new</span> <span class=n>InvocationHandler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>private</span> <span class=kd>final</span> <span class=n>Platform</span> <span class=n>platform</span> <span class=o>=</span> <span class=n>Platform</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=kd>private</span> <span class=kd>final</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>emptyArgs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span> <span class=n>proxy</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=kd>throws</span> <span class=n>Throwable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=c1>// If the method is a method from Object then defer to normal invocation.
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=k>if</span> <span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>()</span> <span class=o>==</span> <span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>method</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>              <span class=n>args</span> <span class=o>=</span> <span class=n>args</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>args</span> <span class=o>:</span> <span class=n>emptyArgs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>              <span class=c1>// 如果是 default 方法，则通过 platform 调用此方法
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=c1>// 普通方法则进行 loadServiceMethod(method).invoke(args)
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=k>return</span> <span class=n>platform</span><span class=o>.</span><span class=na>isDefaultMethod</span><span class=o>(</span><span class=n>method</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                  <span class=o>?</span> <span class=n>platform</span><span class=o>.</span><span class=na>invokeDefaultMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>service</span><span class=o>,</span> <span class=n>proxy</span><span class=o>,</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                  <span class=o>:</span> <span class=n>loadServiceMethod</span><span class=o>(</span><span class=n>method</span><span class=o>).</span><span class=na>invoke</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>          <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>validateServiceInterface</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>service</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// service 必需是接口
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!</span><span class=n>service</span><span class=o>.</span><span class=na>isInterface</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;API declarations must be interfaces.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Deque</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>check</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayDeque</span><span class=o>&lt;&gt;(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>check</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>service</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=o>(!</span><span class=n>check</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>candidate</span> <span class=o>=</span> <span class=n>check</span><span class=o>.</span><span class=na>removeFirst</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>candidate</span><span class=o>.</span><span class=na>getTypeParameters</span><span class=o>().</span><span class=na>length</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>StringBuilder</span> <span class=n>message</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=s>&#34;Type parameters are unsupported on &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>candidate</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>candidate</span> <span class=o>!=</span> <span class=n>service</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34; which is an interface of &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>service</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Collections</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>check</span><span class=o>,</span> <span class=n>candidate</span><span class=o>.</span><span class=na>getInterfaces</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果 Retrofit.Builder 中设置了此参数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>validateEagerly</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Platform</span> <span class=n>platform</span> <span class=o>=</span> <span class=n>Platform</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 提前解析并验证所有非 default 和非 static 方法是否配置正确，并缓存解析结果
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=o>(</span><span class=n>Method</span> <span class=n>method</span> <span class=o>:</span> <span class=n>service</span><span class=o>.</span><span class=na>getDeclaredMethods</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>platform</span><span class=o>.</span><span class=na>isDefaultMethod</span><span class=o>(</span><span class=n>method</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>Modifier</span><span class=o>.</span><span class=na>isStatic</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>loadServiceMethod</span><span class=o>(</span><span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，通过 Retrofit.create(Class) 方法的调用，会创建出 GitHubService 的实例，从而使得 GitHubService 中配置的方法变得可用，这是 Retrofit 代码结构的核心。</p><p>Retrofit.create() 方法的核心，使用的是 Proxy.newProxyInstance() 方法来创建 GitHubService 实例。这个方法会为参数中的多个 interface（具体到 Retrofit 来说，是固定传入一个 interface）创建一个对象，这个对象实现了所有 interface 的每个方法，并且每个方法的实现都是雷同的：调用对象实例内部的一个 InvocationHandler 成员变量的 invoke() 方法，并把自己的方法信息传递进去。这样就在实质上实现了代理逻辑：interface 中的方法全部由一个另外设定的 InvocationHandler 对象来进行代理操作。并且，这些方法的具体实现是在运行时生成 interface 实例时才确定的，而不是在编译时（虽然在编译时就已经可以通过代码逻辑推断出来）。这就是<strong>「动态代理机制」</strong>的具体含义。</p><p>因此，invoke() 方法中的逻辑，就是 Retrofit 创建 Service 实例的关键。</p><p>当调用 GitHubService 中配置好的请求方法时，<code>InvocationHandler.invoke()</code> 方法就会被回调。在 invoke 方法中，会进行判断，如果调用的是我们配置的请求方法，则会走到 <code>loadServiceMethod(method).invoke(args)</code>。</p><a href=#loadservicemethodmethod><h2 id=loadservicemethodmethod><span class=hanchor arialabel=Anchor># </span>loadServiceMethod(method)</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ServiceMethod</span><span class=o>&lt;?&gt;</span> <span class=n>loadServiceMethod</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ServiceMethod</span><span class=o>&lt;?&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>serviceMethodCache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=n>serviceMethodCache</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>serviceMethodCache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>ServiceMethod</span><span class=o>.</span><span class=na>parseAnnotations</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>serviceMethodCache</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里对 ServiceMethod 进行了缓存设计。具体解析方法还是在 ServiceMethod 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>ServiceMethod</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>parseAnnotations</span><span class=o>(</span><span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 解析方法注解并创建 RequestFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>RequestFactory</span> <span class=n>requestFactory</span> <span class=o>=</span> <span class=n>RequestFactory</span><span class=o>.</span><span class=na>parseAnnotations</span><span class=o>(</span><span class=n>retrofit</span><span class=o>,</span> <span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>returnType</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getGenericReturnType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Utils</span><span class=o>.</span><span class=na>hasUnresolvableType</span><span class=o>(</span><span class=n>returnType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>method</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Method return type must not include a type variable or wildcard: %s&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>returnType</span> <span class=o>==</span> <span class=kt>void</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=s>&#34;Service methods cannot return void.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 解析方法注解并创建 HttpServiceMethod 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>HttpServiceMethod</span><span class=o>.</span><span class=na>parseAnnotations</span><span class=o>(</span><span class=n>retrofit</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>requestFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>abstract</span> <span class=nd>@Nullable</span> <span class=n>T</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>HttpServiceMethod 继承自 ServiceMethod，parseAnnotations 方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=nf>parseAnnotations</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>RequestFactory</span> <span class=n>requestFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>isKotlinSuspendFunction</span> <span class=o>=</span> <span class=n>requestFactory</span><span class=o>.</span><span class=na>isKotlinSuspendFunction</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>continuationWantsResponse</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>continuationBodyNullable</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getAnnotations</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>adapterType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果是 Kotlin suspend 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>isKotlinSuspendFunction</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span><span class=o>[]</span> <span class=n>parameterTypes</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getGenericParameterTypes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>responseType</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>Utils</span><span class=o>.</span><span class=na>getParameterLowerBound</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>parameterTypes</span><span class=o>[</span><span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>responseType</span><span class=o>)</span> <span class=o>==</span> <span class=n>Response</span><span class=o>.</span><span class=na>class</span> <span class=o>&amp;&amp;</span> <span class=n>responseType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Unwrap the actual body type from Response&lt;T&gt;.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>responseType</span> <span class=o>=</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>continuationWantsResponse</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// TODO figure out if type is nullable or not
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Metadata metadata = method.getDeclaringClass().getAnnotation(Metadata.class)
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Find the entry for method
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Determine if return type is nullable or not
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>adapterType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Utils</span><span class=o>.</span><span class=na>ParameterizedTypeImpl</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>Call</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span> <span class=o>=</span> <span class=n>SkipCallbackExecutorImpl</span><span class=o>.</span><span class=na>ensurePresent</span><span class=o>(</span><span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 普通方法返回泛型参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>adapterType</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getGenericReturnType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 1、根据 method 的返回值类型以及方法注解返回第一个可以处理的 CallAdapter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>callAdapter</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>createCallAdapter</span><span class=o>(</span><span class=n>retrofit</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>adapterType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>responseType</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>responseType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>responseType</span> <span class=o>==</span> <span class=n>okhttp3</span><span class=o>.</span><span class=na>Response</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;&#39;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=n>getRawType</span><span class=o>(</span><span class=n>responseType</span><span class=o>).</span><span class=na>getName</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=s>&#34;&#39; is not a valid response body type. Did you mean ResponseBody?&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>responseType</span> <span class=o>==</span> <span class=n>Response</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=s>&#34;Response must include generic type (e.g., Response&lt;String&gt;)&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// TODO support Unit for Kotlin?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>requestFactory</span><span class=o>.</span><span class=na>httpMethod</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;HEAD&#34;</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>Void</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>responseType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=s>&#34;HEAD method must use Void as response type.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 2、根据 responseType 以及方法注解返回第一个可以处理的 Converter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>responseConverter</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>createResponseConverter</span><span class=o>(</span><span class=n>retrofit</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 3、根据不同的场景返回不同的 HttpServiceMethod 实现
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span> <span class=o>=</span> <span class=n>retrofit</span><span class=o>.</span><span class=na>callFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!</span><span class=n>isKotlinSuspendFunction</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3.1、根据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=n>CallAdapted</span><span class=o>&lt;&gt;(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>,</span> <span class=n>callAdapter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>continuationWantsResponse</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>(</span><span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;)</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>SuspendForResponse</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;)</span> <span class=n>callAdapter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>(</span><span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;)</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>SuspendForBody</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;)</span> <span class=n>callAdapter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>continuationBodyNullable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这行代码负责读取 interface 中原方法的信息（包括返回值类型、方法注解、参数类型、参数注解），并将这些信息做初步分析后根据这些信息创建出每个方法对应的 CallAdapter 和 Convetor 等对象，并将这些对象传入一个 CallAdapted 对象并返回此对象。</p><p>这里分别分析 32 行 <code>createCallAdapter</code> 和 51 行 <code>createResponseConverter</code> 的代码。</p><a href=#createcalladapter><h3 id=createcalladapter><span class=hanchor arialabel=Anchor># </span>createCallAdapter</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=nf>createCallAdapter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>(</span><span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;)</span> <span class=n>retrofit</span><span class=o>.</span><span class=na>callAdapter</span><span class=o>(</span><span class=n>returnType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// Wide exception range because factories are user code.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>e</span><span class=o>,</span> <span class=s>&#34;Unable to create call adapter for %s&#34;</span><span class=o>,</span> <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>还是交给 Retrofit 类处理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>callAdapter</span><span class=o>(</span><span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>nextCallAdapter</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>nextCallAdapter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>CallAdapter</span><span class=o>.</span><span class=na>Factory</span> <span class=n>skipPast</span><span class=o>,</span> <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>returnType</span><span class=o>,</span> <span class=s>&#34;returnType == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>annotations</span><span class=o>,</span> <span class=s>&#34;annotations == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 遍历 callAdapterFactories 集合
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>start</span> <span class=o>=</span> <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=n>skipPast</span><span class=o>)</span> <span class=o>+</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=o>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过 CallAdapter.Factory.get 判断是否为符合要求的 CallAdapter
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>adapter</span> <span class=o>=</span> <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>get</span><span class=o>(</span><span class=n>returnType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>adapter</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>adapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>StringBuilder</span> <span class=n>builder</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=s>&#34;Could not locate call adapter for &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>returnType</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;.\n&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>skipPast</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;  Skipped:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>start</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;\n   * &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;\n&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;  Tried:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=o>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;\n   * &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=n>builder</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>逻辑比较简单，就是遍历 callAdapterFactories 集合，调用每个 CallAdapter.Factory.get() 方法并传入请求方法的注解信息和返回值信息，根据这些信息每个 CallAdapter.Factory 去判断此请求方法适不适合自己。</p><a href=#defaultcalladapterfactoryget><h4 id=defaultcalladapterfactoryget><span class=hanchor arialabel=Anchor># </span>DefaultCallAdapterFactory.get()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>get</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 方法返回值为 Call 类型
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>returnType</span><span class=o>)</span> <span class=o>!=</span> <span class=n>Call</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 方法返回值必须包含泛型 Call&lt;Foo&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!(</span><span class=n>returnType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;Call return type must be parameterized as Call&lt;Foo&gt; or Call&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>Type</span> <span class=n>responseType</span> <span class=o>=</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// executor = callbackExecutor = MainThreadExecutor
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>final</span> <span class=n>Executor</span> <span class=n>executor</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>Utils</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>annotations</span><span class=o>,</span> <span class=n>SkipCallbackExecutor</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=n>callbackExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回匿名对象实现 CallAdapter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=k>new</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;?&gt;&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Type</span> <span class=nf>responseType</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>responseType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>executor</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>call</span> <span class=o>:</span> <span class=k>new</span> <span class=n>ExecutorCallbackCall</span><span class=o>&lt;&gt;(</span><span class=n>executor</span><span class=o>,</span> <span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>};</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>DefaultCallAdapterFactory 首先通过判断方法返回值是否为 Call 类型并且是否带有泛型参数来确定能不能处理这个请求；</li><li>然后将 executor 赋值为前面 Retrofit.create 流程中获取到的 MainThreadExecutor；</li><li>最后返回一个 CallAdapter 的匿名实现类。</li></ol><a href=#rxjava3calladapterfactoryget><h4 id=rxjava3calladapterfactoryget><span class=hanchor arialabel=Anchor># </span>RxJava3CallAdapterFactory.get()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>get</span><span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>rawType</span> <span class=o>=</span> <span class=n>getRawType</span><span class=o>(</span><span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>rawType</span> <span class=o>==</span> <span class=n>Completable</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Completable is not parameterized (which is what the rest of this method deals with) so it
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// can only be created with a single configuration.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=k>new</span> <span class=n>RxJava3CallAdapter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>Void</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>scheduler</span><span class=o>,</span> <span class=n>isAsync</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isFlowable</span> <span class=o>=</span> <span class=n>rawType</span> <span class=o>==</span> <span class=n>Flowable</span><span class=o>.</span><span class=na>class</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isSingle</span> <span class=o>=</span> <span class=n>rawType</span> <span class=o>==</span> <span class=n>Single</span><span class=o>.</span><span class=na>class</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isMaybe</span> <span class=o>=</span> <span class=n>rawType</span> <span class=o>==</span> <span class=n>Maybe</span><span class=o>.</span><span class=na>class</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>rawType</span> <span class=o>!=</span> <span class=n>Observable</span><span class=o>.</span><span class=na>class</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isFlowable</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isSingle</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isMaybe</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isResult</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isBody</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>responseType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!(</span><span class=n>returnType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>String</span> <span class=n>name</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>isFlowable</span> <span class=o>?</span> <span class=s>&#34;Flowable&#34;</span> <span class=o>:</span> <span class=n>isSingle</span> <span class=o>?</span> <span class=s>&#34;Single&#34;</span> <span class=o>:</span> <span class=n>isMaybe</span> <span class=o>?</span> <span class=s>&#34;Maybe&#34;</span> <span class=o>:</span> <span class=s>&#34;Observable&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>name</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; return type must be parameterized&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; as &#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34;&lt;Foo&gt; or &#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34;&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>observableType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>rawObservableType</span> <span class=o>=</span> <span class=n>getRawType</span><span class=o>(</span><span class=n>observableType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>rawObservableType</span> <span class=o>==</span> <span class=n>Response</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!(</span><span class=n>observableType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Response must be parameterized&#34;</span> <span class=o>+</span> <span class=s>&#34; as Response&lt;Foo&gt; or Response&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>responseType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>observableType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>rawObservableType</span> <span class=o>==</span> <span class=n>Result</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!(</span><span class=n>observableType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Result must be parameterized&#34;</span> <span class=o>+</span> <span class=s>&#34; as Result&lt;Foo&gt; or Result&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>responseType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>observableType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>isResult</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>responseType</span> <span class=o>=</span> <span class=n>observableType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>isBody</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>RxJava3CallAdapter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>responseType</span><span class=o>,</span> <span class=n>scheduler</span><span class=o>,</span> <span class=n>isAsync</span><span class=o>,</span> <span class=n>isResult</span><span class=o>,</span> <span class=n>isBody</span><span class=o>,</span> <span class=n>isFlowable</span><span class=o>,</span> <span class=n>isSingle</span><span class=o>,</span> <span class=n>isMaybe</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#completablefuturecalladapterfactoryget><h4 id=completablefuturecalladapterfactoryget><span class=hanchor arialabel=Anchor># </span>CompletableFutureCallAdapterFactory.get()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>get</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>returnType</span><span class=o>)</span> <span class=o>!=</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!(</span><span class=n>returnType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;CompletableFuture return type must be parameterized&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=s>&#34; as CompletableFuture&lt;Foo&gt; or CompletableFuture&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>innerType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>innerType</span><span class=o>)</span> <span class=o>!=</span> <span class=n>Response</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Generic type is not Response&lt;T&gt;. Use it for body-only adapter.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=n>BodyCallAdapter</span><span class=o>&lt;&gt;(</span><span class=n>innerType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Generic type is Response&lt;T&gt;. Extract T and create the Response version of the adapter.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!(</span><span class=n>innerType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;Response must be parameterized&#34;</span> <span class=o>+</span> <span class=s>&#34; as Response&lt;Foo&gt; or Response&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>responseType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>innerType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>ResponseCallAdapter</span><span class=o>&lt;&gt;(</span><span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#小结><h4 id=小结><span class=hanchor arialabel=Anchor># </span>小结</h4></a><p>对于例子中 GithubService 中的请求方法：</p><ol><li><code>fun listRepos(@Path("user") user: String?): Call&lt;List&lt;Repo>></code></li></ol><p>返回匿名的 CallAdapter 实现类</p><ol start=2><li><code>fun listReposRx(@Path("user") user: String?): Observable&lt;List&lt;Repo>></code></li></ol><p>返回 RxJava3CallAdapter 实例</p><ol start=3><li><code>fun listReposCompletable(@Path("user") user: String?): CompletableFuture&lt;List&lt;Repo>></code></li></ol><p>返回 CompletableFutureCallAdapterFactory.ResponseCallAdapter 实例</p><p>Retrofit.callAdapter() 方法的逻辑如下：</p><ul><li>首先会遍历 callAdapterFactories 集合，并调用每个 CallAdapter.Factory.get() 方法并传入请求方法的注解信息和返回值信息，根据这些信息每个 CallAdapterFactory 去判断此请求方法适不适合自己。</li><li>一旦找到合适的 CallAdapter 则会立即打破循环并返回。</li><li>DefaultCallAdapterFactory 只能处理返回值为 <code>Call&lt;Foo></code> 或者 <code>Call&lt;? extends Foo></code> 的请求方法，并且为它们返回一个匿名的 CallAdapter 实现。</li><li>其它情况，如果要支持 Rxjava，则需要额外增加 CallAdapterFactory 支持。</li><li>如果 Android API >= 24，如果请求方法返回的是 CompletableFuture，Retrofit 默认会进行支持并返回 CompletableFutureCallAdapterFactory 进行处理。</li><li>如果需要支持其它的返回值类型，则需要手动通过 addCallAdapterFactory() 方法增加对 CallAdapterFactory 的支持。</li><li>如果请求方法返回值不受支持，则会抛出异常。</li></ul><a href=#createresponseconverter><h3 id=createresponseconverter><span class=hanchor arialabel=Anchor># </span>createResponseConverter</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=nf>createResponseConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Type</span> <span class=n>responseType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getAnnotations</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>retrofit</span><span class=o>.</span><span class=na>responseBodyConverter</span><span class=o>(</span><span class=n>responseType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// Wide exception range because factories are user code.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>e</span><span class=o>,</span> <span class=s>&#34;Unable to create converter for %s&#34;</span><span class=o>,</span> <span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>还是从 Retrofit 类中获取：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=nf>responseBodyConverter</span><span class=o>(</span><span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>nextResponseBodyConverter</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>type</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=nf>nextResponseBodyConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>Converter</span><span class=o>.</span><span class=na>Factory</span> <span class=n>skipPast</span><span class=o>,</span> <span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>type</span><span class=o>,</span> <span class=s>&#34;type == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>annotations</span><span class=o>,</span> <span class=s>&#34;annotations == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>start</span> <span class=o>=</span> <span class=n>converterFactories</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=n>skipPast</span><span class=o>)</span> <span class=o>+</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=o>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>converterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>converter</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>converterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>responseBodyConverter</span><span class=o>(</span><span class=n>type</span><span class=o>,</span> <span class=n>annotations</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>converter</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//noinspection unchecked
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=o>(</span><span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>T</span><span class=o>&gt;)</span> <span class=n>converter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>StringBuilder</span> <span class=n>builder</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=s>&#34;Could not locate ResponseBody converter for &#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>type</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;.\n&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>skipPast</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;  Skipped:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>start</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;\n   * &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>converterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;\n&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;  Tried:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=o>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>converterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;\n   * &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>converterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=n>builder</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#builtinconvertersresponsebodyconverter><h4 id=builtinconvertersresponsebodyconverter><span class=hanchor arialabel=Anchor># </span>BuiltInConverters.responseBodyConverter()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>responseBodyConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回值类型为 ResponseBody
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>ResponseBody</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Utils</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>annotations</span><span class=o>,</span> <span class=n>Streaming</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=n>StreamingResponseBodyConverter</span><span class=o>.</span><span class=na>INSTANCE</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=n>BufferingResponseBodyConverter</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回值为 void
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>Void</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>VoidResponseBodyConverter</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回值为 Kotlin 的 Unit
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>checkForKotlinUnit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>Unit</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>UnitResponseBodyConverter</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoClassDefFoundError</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>checkForKotlinUnit</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>据前面分析可知，BuiltInConverters 是 Retrofit 在 Android Platform 上唯一默认的 ConvertFactory。因此，请求方法的返回值的数据类型（注意不是返回值类型）只有在以上三种情况下，通过 Retrofit.Builder() 创建 Retrofit 的时候才可以不指定 ConvertFactory，否则调用该方法的时候将会抛出异常。</p><a href=#gsonconverterfactory-responsebodyconverter><h4 id=gsonconverterfactory-responsebodyconverter><span class=hanchor arialabel=Anchor># </span>GsonConverterFactory. responseBodyConverter()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>responseBodyConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>TypeAdapter</span><span class=o>&lt;?&gt;</span> <span class=n>adapter</span> <span class=o>=</span> <span class=n>gson</span><span class=o>.</span><span class=na>getAdapter</span><span class=o>(</span><span class=n>TypeToken</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>type</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>GsonResponseBodyConverter</span><span class=o>&lt;&gt;(</span><span class=n>gson</span><span class=o>,</span> <span class=n>adapter</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果通过 addConverterFactory() 添加了 GsonConverterFactory ，这里将返回一个 GsonResponseBodyConverter 实例，不用进行任何判断，当然 gson.getAdapter 中不能抛出异常。</p><a href=#optionalconverterfactoryresponsebodyconverter><h4 id=optionalconverterfactoryresponsebodyconverter><span class=hanchor arialabel=Anchor># </span>OptionalConverterFactory.responseBodyConverter()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>responseBodyConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>type</span><span class=o>)</span> <span class=o>!=</span> <span class=n>Optional</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取 Option 内层的泛型类型
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Type</span> <span class=n>innerType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>type</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>delegate</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>retrofit</span><span class=o>.</span><span class=na>responseBodyConverter</span><span class=o>(</span><span class=n>innerType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>OptionalConverter</span><span class=o>&lt;&gt;(</span><span class=n>delegate</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>它只处理返回值为 <code>Call&lt;Option&lt;Foo>></code> 类型的请求，并且脱去外衣获取 Option 内层的泛型类型 innerType，并且使用这个 innerType 查找到另外一个符合要求 Converter，最后的 Convert 操作都使用这个 delegate 进行转换操作。</p><a href=#小结-1><h4 id=小结-1><span class=hanchor arialabel=Anchor># </span>小结</h4></a><p>对于 BuiltInConverters，它只会查看泛型参数内容，如果泛型参数为 ResponseBody、Void 或者 Kotlin 的 Unit，BuiltInConverters 将会返回相应的 Converter；</p><p>对于 GsonConverterFactory，它将来者不拒，返回 GsonResponseBodyConverter。</p><p>对于 OptionalConverterFactory，它只处理返回值为 <code>Call&lt;Option&lt;Foo>></code> 类型的请求，并且委托另外一个符合要求 Converter 进行转换操作。</p><p>Retrofit.responseBodyConverter() 方法一旦找到合适的 CallAdapterFactory 则会立即打破循环并返回。</p><p>因此这里需要特别注意，前面提到过的 Retrofit.Builder.build() 方法中，converterFactories 的添加顺序如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 添加内置 ConverterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>converterFactories</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>BuiltInConverters</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=c1>// 添加我们设置的 GsonConverterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>converterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>converterFactories</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 如果 Android API &gt;= 24，添加默认的 OptionalConverterFactory 支持 Java8
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>converterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>platform</span><span class=o>.</span><span class=na>defaultConverterFactories</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>这时候如果要像这样使用 Optional 去接收数据：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>listReposOptional</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>Call</span><span class=p>&lt;</span><span class=n>Optional</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>就会抛出异常：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>com.google.gson.JsonSyntaxException: java.lang.IllegalStateException: Expected BEGIN_OBJECT but was BEGIN_ARRAY at line 1 column 2 path $
</span></span><span class=line><span class=cl>        at com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$Adapter.read(ReflectiveTypeAdapterFactory.java:226)
</span></span><span class=line><span class=cl>        at retrofit2.converter.gson.GsonResponseBodyConverter.convert(GsonResponseBodyConverter.java:40)
</span></span><span class=line><span class=cl>        at retrofit2.converter.gson.GsonResponseBodyConverter.convert(GsonResponseBodyConverter.java:27)
</span></span><span class=line><span class=cl>        at retrofit2.OkHttpCall.parseResponse(OkHttpCall.java:243)
</span></span><span class=line><span class=cl>        at retrofit2.OkHttpCall$1.onResponse(OkHttpCall.java:153)
</span></span></code></pre></td></tr></table></div></div><p>很明显这是来自 gson 的错误，根据前面的分析，如果在 Retrofit.Builder 过程添加了 GsonConverterFactory，responseBodyConverter() 方法中会直接返回一个 GsonResponseBodyConverter 对象，在解释返回结果的时候会拿 <code>Optional&lt;List&lt;Repo>></code> 去接收 JSON 数组，导致解析出错。</p><p>如果要使这个流程走得通，就需要将第 4 行和第 6 行代码进行交换。（本人亲自验证可行）</p><p>可能这是 Retrofit 的一个 bug，如果有其他不同的理解，欢迎讨论。</p><a href=#return><h3 id=return><span class=hanchor arialabel=Anchor># </span>return</h3></a><p>从以上分析可知，parseAnnotations() 方法最终会返回 HttpServiceMethod 实例，而 HttpServiceMethod 类又三个子类，parseAnnotations() 方法的最后会根据不同的条件来返回不同的子类实例。</p><p>如果我们的请求方法不是 Kotlin 挂起函数，返回的是 CallAdapted 对象。</p><a href=#calladapted><h4 id=calladapted><span class=hanchor arialabel=Anchor># </span>CallAdapted</h4></a><p>此时 loadServiceMethod() 返回的对象为 CallAdapted：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>CallAdapted</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>CallAdapted</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestFactory</span> <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>callAdapter</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callAdapter</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>ReturnT</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#suspendforresponse><h4 id=suspendforresponse><span class=hanchor arialabel=Anchor># </span>SuspendForResponse</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>SuspendForResponse</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>SuspendForResponse</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestFactory</span> <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>callAdapter</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callAdapter</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Object</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked Checked by reflection inside RequestFactory.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Continuation</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>continuation</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=o>(</span><span class=n>Continuation</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;)</span> <span class=n>args</span><span class=o>[</span><span class=n>args</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// See SuspendForBody for explanation about this try/catch.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>awaitResponse</span><span class=o>(</span><span class=n>call</span><span class=o>,</span> <span class=n>continuation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>suspendAndThrow</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=n>continuation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#suspendforbody><h4 id=suspendforbody><span class=hanchor arialabel=Anchor># </span>SuspendForBody</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>SuspendForBody</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isNullable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>SuspendForBody</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestFactory</span> <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>callAdapter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>isNullable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callAdapter</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>isNullable</span> <span class=o>=</span> <span class=n>isNullable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Object</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked Checked by reflection inside RequestFactory.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Continuation</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>continuation</span> <span class=o>=</span> <span class=o>(</span><span class=n>Continuation</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;)</span> <span class=n>args</span><span class=o>[</span><span class=n>args</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Calls to OkHttp Call.enqueue() like those inside await and awaitNullable can sometimes
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// invoke the supplied callback with an exception before the invoking stack frame can return.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Coroutines will intercept the subsequent invocation of the Continuation and throw the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// exception synchronously. A Java Proxy cannot throw checked exceptions without them being
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// declared on the interface method. To avoid the synchronous checked exception being wrapped
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// in an UndeclaredThrowableException, it is intercepted and supplied to a helper which will
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// force suspension to occur so that it can be instead delivered to the continuation to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// bypass this restriction.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>isNullable</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>awaitNullable</span><span class=o>(</span><span class=n>call</span><span class=o>,</span> <span class=n>continuation</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>await</span><span class=o>(</span><span class=n>call</span><span class=o>,</span> <span class=n>continuation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>suspendAndThrow</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=n>continuation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#httpservicemethodinvokeobject-args><h2 id=httpservicemethodinvokeobject-args><span class=hanchor arialabel=Anchor># </span>HttpServiceMethod.invoke(Object[] args)</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=nd>@Nullable</span> <span class=n>ReturnT</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpCall</span><span class=o>&lt;&gt;(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>args</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kd>abstract</span> <span class=nd>@Nullable</span> <span class=n>ReturnT</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#new-okhttpcall><h3 id=new-okhttpcall><span class=hanchor arialabel=Anchor># </span>new OkHttpCall&lt;>()</h3></a><p>OkHttpCall 的创建：<code>new OkHttpCall&lt;>(requestFactory, args, callFactory, responseConverter)</code></p><p>OkHttpCall 是 retrofit2.Call 的子类。这行代码负责将 ServiceMethod 解读到的信息（主要是一个 RequestFactory 、一个 CallFactory 和一个 ResponseConverter）封装进 OkHttpCall；而这个对象可以在需要的时候（例如它的 enqueue() 方法被调用的时候）， 利用 RequestFactory 和 CallFactory 来创建一个 okhttp3.Call 对象，并调用这个 okhttp3.Call 对象来进行网络请求的发起，然后利用 ResponseConverter 对结果进行预处理之后，交回给 Retrofit 的 Callback 。</p><a href=#httpservicemethodadapt><h3 id=httpservicemethodadapt><span class=hanchor arialabel=Anchor># </span>HttpServiceMethod.adapt()</h3></a><p>调用 adapt() 方法：<code>adapt(call, args)</code></p><p>创建 OkHttpCall 对象后，会调用 abstract 方法 <code>adapt(Call&lt;ResponseT> call, Object[] args)</code> 将 OkHttpCall 对象和请求参数传入。</p><p>根据前面的分析，HttpServiceMethod 有三个子类并且都是 HttpServiceMethod 的内部类，分别是</p><p>CallAdapted、SuspendForResponse 和 SuspendForBody。</p><a href=#calladaptedadapt><h4 id=calladaptedadapt><span class=hanchor arialabel=Anchor># </span>CallAdapted.adapt</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=n>ReturnT</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里是直接调用了 callAdapter 的 adapt 方法，这个 callAdapter 就是前面 loadServiceMethod() 流程中通过 createCallAdapter() 方法获取到的 CallAdapter 对象。</p><p>因此，根据前面的分析可知，此时的 CallAdapter 会根据请求方法的类型来使相应的实现类。</p><a href=#defaultcalladapterfactory-中的匿名-calladapter><h5 id=defaultcalladapterfactory-中的匿名-calladapter><span class=hanchor arialabel=Anchor># </span>DefaultCallAdapterFactory 中的匿名 CallAdapter</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;?&gt;&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Type</span> <span class=nf>responseType</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>responseType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>executor</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>call</span> <span class=o>:</span> <span class=k>new</span> <span class=n>ExecutorCallbackCall</span><span class=o>&lt;&gt;(</span><span class=n>executor</span><span class=o>,</span> <span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，adapt 方法返回的是 ExecutorCallbackCall 对象。</p><a href=#rxjava3calladapterfactoryrxjava3calladapter><h5 id=rxjava3calladapterfactoryrxjava3calladapter><span class=hanchor arialabel=Anchor># </span>RxJava3CallAdapterFactory.RxJava3CallAdapter</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Object</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Observable</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=n>responseObservable</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>isAsync</span> <span class=o>?</span> <span class=k>new</span> <span class=n>CallEnqueueObservable</span><span class=o>&lt;&gt;(</span><span class=n>call</span><span class=o>)</span> <span class=o>:</span> <span class=k>new</span> <span class=n>CallExecuteObservable</span><span class=o>&lt;&gt;(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Observable</span><span class=o>&lt;?&gt;</span> <span class=n>observable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isResult</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>observable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResultObservable</span><span class=o>&lt;&gt;(</span><span class=n>responseObservable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>isBody</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>observable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BodyObservable</span><span class=o>&lt;&gt;(</span><span class=n>responseObservable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>observable</span> <span class=o>=</span> <span class=n>responseObservable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>scheduler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>observable</span> <span class=o>=</span> <span class=n>observable</span><span class=o>.</span><span class=na>subscribeOn</span><span class=o>(</span><span class=n>scheduler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isFlowable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// We only ever deliver a single value, and the RS spec states that you MUST request at least
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// one element which means we never need to honor backpressure.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>observable</span><span class=o>.</span><span class=na>toFlowable</span><span class=o>(</span><span class=n>BackpressureStrategy</span><span class=o>.</span><span class=na>MISSING</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isSingle</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>observable</span><span class=o>.</span><span class=na>singleOrError</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isMaybe</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>observable</span><span class=o>.</span><span class=na>singleElement</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isCompletable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>observable</span><span class=o>.</span><span class=na>ignoreElements</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>RxJavaPlugins</span><span class=o>.</span><span class=na>onAssembly</span><span class=o>(</span><span class=n>observable</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#completablefuturecalladapterfactoryresponsecalladapter><h5 id=completablefuturecalladapterfactoryresponsecalladapter><span class=hanchor arialabel=Anchor># </span>CompletableFutureCallAdapterFactory.ResponseCallAdapter</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>adapt</span><span class=o>(</span><span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>future</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CallCancelCompletableFuture</span><span class=o>&lt;&gt;(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>call</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=k>new</span> <span class=n>BodyCallback</span><span class=o>(</span><span class=n>future</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>future</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#小结-2><h5 id=小结-2><span class=hanchor arialabel=Anchor># </span>小结</h5></a><p>对于例子中 GithubService 中的请求方法：</p><ol><li><code>fun listRepos(@Path("user") user: String?): Call&lt;List&lt;Repo>></code></li></ol><p>返回 DefaultCallAdapterFactory.ExecutorCallbackCall 实例</p><ol start=2><li><code>fun listReposRx(@Path("user") user: String?): Observable&lt;List&lt;Repo>></code></li></ol><p>异步方式返回 CallEnqueueObservable 实例，同步方式返回 CallExecuteObservable 实例</p><ol start=3><li><code>fun listReposCompletable(@Path("user") user: String?): CompletableFuture&lt;List&lt;Repo>></code></li></ol><p>返回 CompletableFutureCallAdapterFactory.CallCancelCompletableFuture 实例</p><p>因此，CallAdatper 的作用就是把 OkHttpCall 根据请求方法的返回值包装成一个新的对象，并且返回给调用者。</p><a href=#suspendforresponseadapt><h4 id=suspendforresponseadapt><span class=hanchor arialabel=Anchor># </span>SuspendForResponse.adapt</h4></a><a href=#suspendforbodyadapt><h4 id=suspendforbodyadapt><span class=hanchor arialabel=Anchor># </span>SuspendForBody.adapt</h4></a><a href=#callenqueue><h2 id=callenqueue><span class=hanchor arialabel=Anchor># </span>Call.enqueue()</h2></a><p>根据前面的分析，在 Android 平台上，对于返回 Call 类型的请求方法被调用时，会被一个匿名 CallAdapter 在 adapt 方法中包装成 ExecutorCallbackCall 并返回给调用者。不用多说也应该知道，这个类继承自 Call 接口。那么它是怎么实现请求的呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ExecutorCallbackCall</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>delegate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ExecutorCallbackCall</span><span class=o>(</span><span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>delegate</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callbackExecutor</span> <span class=o>=</span> <span class=n>callbackExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>delegate</span> <span class=o>=</span> <span class=n>delegate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>enqueue</span><span class=o>(</span><span class=kd>final</span> <span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>callback</span><span class=o>,</span> <span class=s>&#34;callback == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>delegate</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResponse</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=kd>final</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>response</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>callbackExecutor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                  <span class=k>if</span> <span class=o>(</span><span class=n>delegate</span><span class=o>.</span><span class=na>isCanceled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// Emulate OkHttp&#39;s behavior of throwing/delivering an IOException on
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// cancellation.
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>callback</span><span class=o>.</span><span class=na>onFailure</span><span class=o>(</span><span class=n>ExecutorCallbackCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=k>new</span> <span class=n>IOException</span><span class=o>(</span><span class=s>&#34;Canceled&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>callback</span><span class=o>.</span><span class=na>onResponse</span><span class=o>(</span><span class=n>ExecutorCallbackCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                  <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>});</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFailure</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=kd>final</span> <span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>callbackExecutor</span><span class=o>.</span><span class=na>execute</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>callback</span><span class=o>.</span><span class=na>onFailure</span><span class=o>(</span><span class=n>ExecutorCallbackCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=n>t</span><span class=o>));</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isExecuted</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>isExecuted</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>execute</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>execute</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>cancel</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>delegate</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isCanceled</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>isCanceled</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;CloneDoesntCallSuperClone&#34;</span><span class=o>)</span> <span class=c1>// Performing deep clone.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>clone</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>ExecutorCallbackCall</span><span class=o>&lt;&gt;(</span><span class=n>callbackExecutor</span><span class=o>,</span> <span class=n>delegate</span><span class=o>.</span><span class=na>clone</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Request</span> <span class=nf>request</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>request</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Timeout</span> <span class=nf>timeout</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>timeout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这是一个典型的代理模式的实现，ExecutorCallbackCall 的全部实现都交给了 delegate 对象，而这个 delegate 正是 HttpServiceMethod.invoke() 流程中生成的 OkHttpCall 对象。</p><p>在 enqueue() 方法中，首先会调用 OkHttpCall.enqueue() 方法获取请求结果，然后在 CallBack 回调中在 callbackExecutor.execute() 中将回调结果再次回调给 callback。</p><p>这里 callbackExecutor 就是 Platform.Android.MainThreadExecutor，因此外层获取的回调实在主线程中的，不用再切换线程。</p><p>那么再看 OkHttpCall.enqueue() 是如何工作的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>enqueue</span><span class=o>(</span><span class=kd>final</span> <span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>callback</span><span class=o>,</span> <span class=s>&#34;callback == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span> <span class=n>call</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Throwable</span> <span class=n>failure</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>executed</span><span class=o>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Already executed.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>executed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>call</span> <span class=o>=</span> <span class=n>rawCall</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>failure</span> <span class=o>=</span> <span class=n>creationFailure</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>call</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>failure</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>call</span> <span class=o>=</span> <span class=n>rawCall</span> <span class=o>=</span> <span class=n>createRawCall</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>throwIfFatal</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>failure</span> <span class=o>=</span> <span class=n>creationFailure</span> <span class=o>=</span> <span class=n>t</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>failure</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>onFailure</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>failure</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>canceled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>call</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>okhttp3</span><span class=o>.</span><span class=na>Callback</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResponse</span><span class=o>(</span><span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span> <span class=n>call</span><span class=o>,</span> <span class=n>okhttp3</span><span class=o>.</span><span class=na>Response</span> <span class=n>rawResponse</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>response</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 解析结果
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>response</span> <span class=o>=</span> <span class=n>parseResponse</span><span class=o>(</span><span class=n>rawResponse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>throwIfFatal</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>callFailure</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>callback</span><span class=o>.</span><span class=na>onResponse</span><span class=o>(</span><span class=n>OkHttpCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>throwIfFatal</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span> <span class=c1>// TODO this is not great
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFailure</span><span class=o>(</span><span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span> <span class=n>call</span><span class=o>,</span> <span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>callFailure</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kt>void</span> <span class=nf>callFailure</span><span class=o>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>callback</span><span class=o>.</span><span class=na>onFailure</span><span class=o>(</span><span class=n>OkHttpCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>throwIfFatal</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span> <span class=c1>// TODO this is not great
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>parseResponse</span><span class=o>(</span><span class=n>okhttp3</span><span class=o>.</span><span class=na>Response</span> <span class=n>rawResponse</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ResponseBody</span> <span class=n>rawBody</span> <span class=o>=</span> <span class=n>rawResponse</span><span class=o>.</span><span class=na>body</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Remove the body&#39;s source (the only stateful object) so we can pass the response along.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>rawResponse</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>rawResponse</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>newBuilder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>body</span><span class=o>(</span><span class=k>new</span> <span class=n>NoContentResponseBody</span><span class=o>(</span><span class=n>rawBody</span><span class=o>.</span><span class=na>contentType</span><span class=o>(),</span> <span class=n>rawBody</span><span class=o>.</span><span class=na>contentLength</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>code</span> <span class=o>=</span> <span class=n>rawResponse</span><span class=o>.</span><span class=na>code</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>code</span> <span class=o>&lt;</span> <span class=n>200</span> <span class=o>||</span> <span class=n>code</span> <span class=o>&gt;=</span> <span class=n>300</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Buffer the entire body to avoid future I/O.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>ResponseBody</span> <span class=n>bufferedBody</span> <span class=o>=</span> <span class=n>Utils</span><span class=o>.</span><span class=na>buffer</span><span class=o>(</span><span class=n>rawBody</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Response</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=n>bufferedBody</span><span class=o>,</span> <span class=n>rawResponse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>rawBody</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>code</span> <span class=o>==</span> <span class=n>204</span> <span class=o>||</span> <span class=n>code</span> <span class=o>==</span> <span class=n>205</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>rawBody</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Response</span><span class=o>.</span><span class=na>success</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>rawResponse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ExceptionCatchingResponseBody</span> <span class=n>catchingBody</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ExceptionCatchingResponseBody</span><span class=o>(</span><span class=n>rawBody</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用 responseConverter 完成转换
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>T</span> <span class=n>body</span> <span class=o>=</span> <span class=n>responseConverter</span><span class=o>.</span><span class=na>convert</span><span class=o>(</span><span class=n>catchingBody</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Response</span><span class=o>.</span><span class=na>success</span><span class=o>(</span><span class=n>body</span><span class=o>,</span> <span class=n>rawResponse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If the underlying source threw an exception, propagate that rather than indicating it was
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// a runtime exception.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>catchingBody</span><span class=o>.</span><span class=na>throwIfCaught</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里是依赖 OkHttp3 来实现网络请求的。获取到请求结果后，第 40 行将会调用 parseResponse() 方法将结果解析出来。parseResponse() 方法第 100 行将会调用 responseConverter 进行转换。</p><p>这一整个过程可以一下时序图直观展示：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Retrofit/clipboard_20230323_035658.png width=auto alt></p><a href=#observablesubscribe><h2 id=observablesubscribe><span class=hanchor arialabel=Anchor># </span>Observable.subscribe()</h2></a><p>对于返回 Observable 的请求方法，我们知道经过 RxJava3CallAdapter.adapt 方法的包装，最终返回的是 CallEnqueueObservable 或者 CallExecuteObservable。以前者为例，来看看具体的实现方式。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kd>class</span> <span class=nc>CallEnqueueObservable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>Observable</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>originalCall</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>CallEnqueueObservable</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>originalCall</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>originalCall</span> <span class=o>=</span> <span class=n>originalCall</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>subscribeActual</span><span class=o>(</span><span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>observer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Since Call is a one-shot type, clone it for each new observer.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span> <span class=o>=</span> <span class=n>originalCall</span><span class=o>.</span><span class=na>clone</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>CallCallback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>callback</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CallCallback</span><span class=o>&lt;&gt;(</span><span class=n>call</span><span class=o>,</span> <span class=n>observer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>observer</span><span class=o>.</span><span class=na>onSubscribe</span><span class=o>(</span><span class=n>callback</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>callback</span><span class=o>.</span><span class=na>isDisposed</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>callback</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>CallCallback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Disposable</span><span class=o>,</span> <span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;?&gt;</span> <span class=n>call</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>observer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>disposed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>terminated</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>CallCallback</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;?&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>observer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>call</span> <span class=o>=</span> <span class=n>call</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>observer</span> <span class=o>=</span> <span class=n>observer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResponse</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>response</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>disposed</span><span class=o>)</span> <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>observer</span><span class=o>.</span><span class=na>onNext</span><span class=o>(</span><span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>disposed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>terminated</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=n>observer</span><span class=o>.</span><span class=na>onComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Exceptions</span><span class=o>.</span><span class=na>throwIfFatal</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>terminated</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>RxJavaPlugins</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>disposed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>observer</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>inner</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Exceptions</span><span class=o>.</span><span class=na>throwIfFatal</span><span class=o>(</span><span class=n>inner</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>RxJavaPlugins</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=k>new</span> <span class=n>CompositeException</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>inner</span><span class=o>));</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFailure</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>call</span><span class=o>.</span><span class=na>isCanceled</span><span class=o>())</span> <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>observer</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>inner</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Exceptions</span><span class=o>.</span><span class=na>throwIfFatal</span><span class=o>(</span><span class=n>inner</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>RxJavaPlugins</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=k>new</span> <span class=n>CompositeException</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>inner</span><span class=o>));</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>dispose</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>disposed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDisposed</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>disposed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 subscribeActual() 方法中，同样调用的是 OkHttpCall.enqueue() 方法实现请求，并且在 CallCallback 回调中把请求结果通过 onNext(response) 发射给下游的 Observer。</p><p>这个过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Retrofit/clipboard_20230323_035702.png width=auto alt></p><a href=#总结><h1 id=总结><span class=hanchor arialabel=Anchor># </span>总结</h1></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Retrofit/clipboard_20230323_035708.png width=auto alt></p></article><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>