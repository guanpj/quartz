<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="ä½¿ç”¨  å¯¼å…¥ä¾èµ–ã€‚  1 2 3 4 5 6 7 8 9  implementation &#34;com.squareup.okhttp3:okhttp:4.9.0&#34; implementation &#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34; implementation &#34;com.squareup.retrofit2:retrofit:2.9.0&#34; implementation &#34;com."><meta property="og:title" content="Retrofit ä½¿ç”¨åŠæºç åˆ†æ"><meta property="og:description" content="ä½¿ç”¨  å¯¼å…¥ä¾èµ–ã€‚  1 2 3 4 5 6 7 8 9  implementation &#34;com.squareup.okhttp3:okhttp:4.9.0&#34; implementation &#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34; implementation &#34;com.squareup.retrofit2:retrofit:2.9.0&#34; implementation &#34;com."><meta property="og:type" content="website"><meta property="og:image" content="https://www.guanpj.top/icon.png"><meta property="og:url" content="https://www.guanpj.top/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Retrofit ä½¿ç”¨åŠæºç åˆ†æ"><meta name=twitter:description content="ä½¿ç”¨  å¯¼å…¥ä¾èµ–ã€‚  1 2 3 4 5 6 7 8 9  implementation &#34;com.squareup.okhttp3:okhttp:4.9.0&#34; implementation &#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34; implementation &#34;com.squareup.retrofit2:retrofit:2.9.0&#34; implementation &#34;com."><meta name=twitter:image content="https://www.guanpj.top/icon.png"><meta name=twitter:site content="guanpj"><title>Retrofit ä½¿ç”¨åŠæºç åˆ†æ</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.guanpj.top//icon.png><link href=https://www.guanpj.top/styles.592437b1fbffed6c8a18843d158121af.min.css rel=stylesheet><link href=https://www.guanpj.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.guanpj.top/js/darkmode.b65338f159f3469fa8b9dc7675293fba.min.js></script>
<script src=https://www.guanpj.top/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://www.guanpj.top/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://www.guanpj.top/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://www.guanpj.top/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://www.guanpj.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://www.guanpj.top/",fetchData=Promise.all([fetch("https://www.guanpj.top/indices/linkIndex.53666c8c2dda7453db60134845619aac.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.guanpj.top/indices/contentIndex.4de5d4afe899a2b4bf5a54d74c9bc8fa.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.guanpj.top",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.guanpj.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.guanpj.top\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=www.guanpj.top src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.guanpj.top/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://www.guanpj.top/>ğŸŒ» guanpjã®èŠ±å›­ ğŸŒµ</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Retrofit ä½¿ç”¨åŠæºç åˆ†æ</h1><p class=meta>Last updated
Mar 24, 2023</p><ul class=tags><li><a href=https://www.guanpj.top/tags/Retrofit/>Retrofit</a></li><li><a href=https://www.guanpj.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>æºç è§£æ</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a></li><li><a href=#è§£æ>è§£æ</a><ol><li><a href=#retrofitbuilder>Retrofit.Builder</a></li><li><a href=#retrofitcreate>Retrofit.create</a></li><li><a href=#loadservicemethodmethod>loadServiceMethod(method)</a><ol><li><a href=#createcalladapter>createCallAdapter</a><ol><li><a href=#defaultcalladapterfactoryget>DefaultCallAdapterFactory.get()</a></li><li><a href=#rxjava3calladapterfactoryget>RxJava3CallAdapterFactory.get()</a></li><li><a href=#completablefuturecalladapterfactoryget>CompletableFutureCallAdapterFactory.get()</a></li><li><a href=#å°ç»“>å°ç»“</a></li></ol></li><li><a href=#createresponseconverter>createResponseConverter</a><ol><li><a href=#builtinconvertersresponsebodyconverter>BuiltInConverters.responseBodyConverter()</a></li><li><a href=#gsonconverterfactory-responsebodyconverter>GsonConverterFactory. responseBodyConverter()</a></li><li><a href=#optionalconverterfactoryresponsebodyconverter>OptionalConverterFactory.responseBodyConverter()</a></li><li><a href=#å°ç»“-1>å°ç»“</a></li></ol></li><li><a href=#return>return</a><ol><li><a href=#calladapted>CallAdapted</a></li><li><a href=#suspendforresponse>SuspendForResponse</a></li><li><a href=#suspendforbody>SuspendForBody</a></li></ol></li></ol></li><li><a href=#httpservicemethodinvokeobject-args>HttpServiceMethod.invoke(Object[] args)</a><ol><li><a href=#new-okhttpcall>new OkHttpCall&lt;>()</a></li><li><a href=#httpservicemethodadapt>HttpServiceMethod.adapt()</a><ol><li><a href=#calladaptedadapt>CallAdapted.adapt</a><ol><li><a href=#defaultcalladapterfactory-ä¸­çš„åŒ¿å-calladapter>DefaultCallAdapterFactory ä¸­çš„åŒ¿å CallAdapter</a></li><li><a href=#rxjava3calladapterfactoryrxjava3calladapter>RxJava3CallAdapterFactory.RxJava3CallAdapter</a></li><li><a href=#completablefuturecalladapterfactoryresponsecalladapter>CompletableFutureCallAdapterFactory.ResponseCallAdapter</a></li><li><a href=#å°ç»“-2>å°ç»“</a></li></ol></li><li><a href=#suspendforresponseadapt>SuspendForResponse.adapt</a></li><li><a href=#suspendforbodyadapt>SuspendForBody.adapt</a></li></ol></li></ol></li><li><a href=#callenqueue>Call.enqueue()</a></li><li><a href=#observablesubscribe>Observable.subscribe()</a></li></ol></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></nav></details></aside><a href=#ä½¿ç”¨><h1 id=ä½¿ç”¨><span class=hanchor arialabel=Anchor># </span>ä½¿ç”¨</h1></a><ol><li>å¯¼å…¥ä¾èµ–ã€‚</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.okhttp3:okhttp:4.9.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.retrofit2:retrofit:2.9.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.retrofit2:converter-gson:2.9.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;com.squareup.retrofit2:adapter-rxjava3:2.9.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;io.reactivex.rxjava3:rxjava:3.0.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>implementation</span> <span class=s2>&#34;io.reactivex.rxjava3:rxandroid:3.0.0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>åˆ›å»ºä¸€ä¸ª interface ä½œä¸º WebService çš„è¯·æ±‚é›†åˆï¼Œåœ¨é‡Œé¢ç”¨æ³¨è§£å†™å…¥éœ€è¦é…ç½®çš„è¯·æ±‚æ–¹æ³•ã€‚</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>interface</span> <span class=nc>GitHubService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>listRepos</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>Call</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>listReposRx</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>Observable</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>listReposCompletable</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>CompletableFuture</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>suspend</span> <span class=k>fun</span> <span class=nf>listReposSuspend</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>listReposOptional</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>Call</span><span class=p>&lt;</span><span class=n>Optional</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>åœ¨æ­£å¼ä»£ç é‡Œç”¨ Retrofit åˆ›å»ºå‡º interface çš„å®ä¾‹ã€‚</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>user</span> <span class=p>=</span> <span class=s2>&#34;guanpj&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>okHttpClient</span> <span class=p>=</span> <span class=n>OkHttpClient</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>connectTimeout</span><span class=p>(</span><span class=m>15</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>writeTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>readTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>proxy</span><span class=p>(</span><span class=n>Proxy</span><span class=p>.</span><span class=n>NO_PROXY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addInterceptor</span><span class=p>(</span><span class=n>HttpLoggingInterceptor</span> <span class=p>{</span> <span class=n>message</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>BuildConfig</span><span class=p>.</span><span class=n>DEBUG</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=p>.</span><span class=n>i</span><span class=p>(</span><span class=s2>&#34;OkHttp&#34;</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>retrofit</span> <span class=p>=</span> <span class=n>Retrofit</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>client</span><span class=p>(</span><span class=n>okHttpClient</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>baseUrl</span><span class=p>(</span><span class=s2>&#34;https://api.github.com/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addCallAdapterFactory</span><span class=p>(</span><span class=n>RxJava3CallAdapterFactory</span><span class=p>.</span><span class=n>create</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addConverterFactory</span><span class=p>(</span><span class=n>GsonConverterFactory</span><span class=p>.</span><span class=n>create</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>service</span> <span class=p>=</span> <span class=n>retrofit</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>GitHubService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>è°ƒç”¨åˆ›å»ºå‡ºçš„ Service å®ä¾‹çš„å¯¹åº”æ–¹æ³•ï¼Œåˆ›å»ºå‡ºç›¸åº”çš„å¯ä»¥ç”¨æ¥å‘èµ·ç½‘ç»œè¯·æ±‚çš„ Call å¯¹è±¡ / Obsevable å¯¹è±¡ / suspend æŒ‚èµ·å‡½æ•°ï¼Œå¹¶å‘èµ·è¯·æ±‚ã€‚</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>listRepos</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listRepos</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>listRepos</span><span class=p>.</span><span class=n>enqueue</span><span class=p>(</span><span class=k>object</span> <span class=err>: </span><span class=nc>retrofit2</span><span class=p>.</span><span class=n>Callback</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onFailure</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>retrofit2</span><span class=p>.</span><span class=n>Call</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?&gt;,</span> <span class=n>t</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onResponse</span><span class=p>(</span><span class=n>call</span><span class=p>:</span> <span class=n>retrofit2</span><span class=p>.</span><span class=n>Call</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?&gt;,</span> <span class=n>response</span><span class=p>:</span> <span class=n>retrofit2</span><span class=p>.</span><span class=n>Response</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?&gt;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;Response: </span><span class=si>${response.body()!![0].name}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>listReposRx</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listReposRx</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>listReposRx</span><span class=p>.</span><span class=n>subscribeOn</span><span class=p>(</span><span class=n>Schedulers</span><span class=p>.</span><span class=n>io</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>observeOn</span><span class=p>(</span><span class=n>AndroidSchedulers</span><span class=p>.</span><span class=n>mainThread</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>subscribe</span><span class=p>(</span><span class=k>object</span> <span class=err>: </span><span class=nc>Observer</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onSubscribe</span><span class=p>(</span><span class=n>d</span><span class=p>:</span> <span class=n>Disposable</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onNext</span><span class=p>(</span><span class=n>t</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;size:</span><span class=si>${t?.size}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onComplete</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onError</span><span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>future</span><span class=p>:</span> <span class=n>CompletableFuture</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listReposCompletable</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>future</span><span class=p>.</span><span class=n>thenAccept</span> <span class=p>{</span> <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;size:</span><span class=si>${it.size}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MainScope</span><span class=p>().</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>list</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listReposSuspend</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=s2>&#34;size:</span><span class=si>${list.size}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>call</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>listReposOptional</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>thread</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å®é™…ä¸Šè¿™é‡Œæ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸çš„ï¼ŒåŸå› è§åæ–‡åˆ†æ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=py>optionalList</span> <span class=p>=</span> <span class=n>call</span><span class=p>.</span><span class=n>execute</span><span class=p>().</span><span class=n>body</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>optionalList</span><span class=o>?.</span><span class=n>ifPresent</span> <span class=p>{</span> <span class=n>list</span> <span class=o>-&gt;</span> <span class=n>list</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s2>&#34;gpj&#34;</span><span class=p>,</span> <span class=k>it</span><span class=p>.</span><span class=n>full_name</span><span class=p>)</span> <span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#è§£æ><h1 id=è§£æ><span class=hanchor arialabel=Anchor># </span>è§£æ</h1></a><p>åœ¨æ­£å¼å¼€å§‹å‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹å‡ ä¸ªå…³é”®è¯ï¼Œä¾›å¤‡å¿˜ï¼š</p><ul><li><code>CallAdapter&lt;R, T></code>ï¼šå°†ä¸€ä¸ª Call ä»å“åº”ç±»å‹ R é€‚é…æˆ T ç±»å‹çš„é€‚é…å™¨ã€‚<ul><li><code>Type responseType()</code> é€‚é…å™¨å°† HTTP å“åº”ä½“è½¬æ¢ä¸º Java å¯¹è±¡æ—¶ï¼Œè¯¥å¯¹è±¡çš„ç±»å‹ã€‚æ¯”å¦‚ <code>Call&lt;Repo></code> çš„è¿”å›å€¼æ˜¯ Repo</li><li><code>T adapt(Call&lt;R> call)</code>ï¼šè¿”å›ä¸€ä¸ªä»£ç†äº† call çš„ T</li></ul></li><li><code>CallAdapter.Factory</code>ï¼šç”¨äºåˆ›å»º CallAdapter å®ä¾‹çš„å·¥å‚<ul><li><code>CallAdapter&lt;?, ?> get(Type returnType, Annotation[] annotations, Retrofit retrofit)</code>ï¼šè¿”å›ä¸€ä¸ªå¯ä»¥è¿”å› returnType çš„æ¥å£æ–¹æ³•çš„ CallAdapterï¼Œå¦‚æœä¸èƒ½å¤„ç†ï¼Œåˆ™è¿”å› null</li></ul></li><li><code>Converter&lt;F, T></code>ï¼šå°† F è½¬æ¢ä¸º T ç±»å‹çš„å€¼çš„è½¬æ¢å™¨ã€‚<ul><li><code>T convert(F value) throws IOException</code></li></ul></li><li><code>Converter.Factory</code>ï¼šåŸºäºä¸€ä¸ªç±»å‹å’Œç›®æ ‡ç±»å‹åˆ›å»ºä¸€ä¸ª Converter å®ä¾‹çš„å·¥å‚<ul><li><code>Converter&lt;ResponseBody, ?> responseBodyConverter(Type type, Annotation[] annotations, Retrofit retrofit)</code>ï¼šè¿”å›ä¸€ä¸ªå¯ä»¥è½¬æ¢ HTTP å“åº”ä½“åˆ° type çš„è½¬æ¢å™¨</li><li><code>Converter&lt;?, RequestBody> requestBodyConverter(Type type, Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit)</code>ï¼šè¿”å›ä¸€ä¸ªå¯ä»¥è½¬æ¢ type åˆ° HTTP è¯·æ±‚ä½“çš„è½¬æ¢å™¨</li><li><code>Converter&lt;?, String> stringConverter(Type type, Annotation[] annotations, Retrofit retrofit)</code>ï¼šè¿”å›ä¸€ä¸ªå¯ä»¥è½¬æ¢ type åˆ° String çš„è½¬æ¢å™¨</li></ul></li></ul><a href=#retrofitbuilder><h2 id=retrofitbuilder><span class=hanchor arialabel=Anchor># </span>Retrofit.Builder</h2></a><p>å¦‚æœæƒ³çŸ¥é“ Retrofit åœ¨åˆ›å»ºæ—¶å¹²äº†äº›ä»€ä¹ˆï¼Œå°±ä¸å¾—ä¸çœ‹ Retrofit.Builder ï¼Œå®ƒçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Builder</span><span class=o>(</span><span class=n>Platform</span> <span class=n>platform</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>platform</span> <span class=o>=</span> <span class=n>platform</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Builder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>(</span><span class=n>Platform</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé¦–å…ˆæ˜¯è°ƒç”¨äº† <code>Platform.get()</code> è·å–äº†ä¸€ä¸ª Platform å®ä¾‹ï¼Œç„¶åä¿å­˜åˆ°å˜é‡ platform ä¸­ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Platform</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Platform</span> <span class=n>PLATFORM</span> <span class=o>=</span> <span class=n>findPlatform</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=n>Platform</span> <span class=nf>get</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>PLATFORM</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=n>Platform</span> <span class=nf>findPlatform</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;Dalvik&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;java.vm.name&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=k>new</span> <span class=n>Android</span><span class=o>()</span> <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>:</span> <span class=k>new</span> <span class=n>Platform</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>hasJava8Types</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=nd>@Nullable</span> <span class=n>Constructor</span><span class=o>&lt;</span><span class=n>Lookup</span><span class=o>&gt;</span> <span class=n>lookupConstructor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Platform</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>hasJava8Types</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>hasJava8Types</span> <span class=o>=</span> <span class=n>hasJava8Types</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Constructor</span><span class=o>&lt;</span><span class=n>Lookup</span><span class=o>&gt;</span> <span class=n>lookupConstructor</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>hasJava8Types</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Because the service interface might not be public, we need to use a MethodHandle lookup
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// that ignores the visibility of the declaringClass.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>lookupConstructor</span> <span class=o>=</span> <span class=n>Lookup</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getDeclaredConstructor</span><span class=o>(</span><span class=n>Class</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kt>int</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>lookupConstructor</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoClassDefFoundError</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Android API 24 or 25 where Lookup doesn&#39;t exist. Calling default methods on non-public
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// interfaces will fail, but there&#39;s nothing we can do about it.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchMethodException</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Assume JDK 14+ which contains a fix that allows a regular lookup to succeed.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// See https://bugs.openjdk.java.net/browse/JDK-8209005.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>lookupConstructor</span> <span class=o>=</span> <span class=n>lookupConstructor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=n>Executor</span> <span class=nf>defaultCallbackExecutor</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 1ã€å¦‚æœ API &lt; 24ï¼Œè¿™é‡Œåˆ—è¡¨ä¸­åªæœ‰ä¸€ä¸ª DefaultCallAdapterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// å¦åˆ™å¤šä¸€ä¸ª CompletableFutureCallAdapterFactory ç”¨äºæ”¯æŒ Java8
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>CallAdapter</span><span class=o>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=nf>defaultCallAdapterFactories</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=nd>@Nullable</span> <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DefaultCallAdapterFactory</span> <span class=n>executorFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultCallAdapterFactory</span><span class=o>(</span><span class=n>callbackExecutor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=n>asList</span><span class=o>(</span><span class=n>CompletableFutureCallAdapterFactory</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>,</span> <span class=n>executorFactory</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=n>singletonList</span><span class=o>(</span><span class=n>executorFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=nf>defaultCallAdapterFactoriesSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span> <span class=o>?</span> <span class=n>2</span> <span class=o>:</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 2ã€å¦‚æœ API &lt; 24ï¼Œè¿™é‡Œåˆ—è¡¨ä¸ºç©ºï¼›
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// å¦åˆ™ä¼šæœ‰ä¸€ä¸ª OptionalConverterFactory ç”¨äºæ”¯æŒ Java8
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Converter</span><span class=o>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=nf>defaultConverterFactories</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span> <span class=o>?</span> <span class=n>singletonList</span><span class=o>(</span><span class=n>OptionalConverterFactory</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>)</span> <span class=o>:</span> <span class=n>emptyList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=nf>defaultConverterFactoriesSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span> <span class=o>?</span> <span class=n>1</span> <span class=o>:</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@IgnoreJRERequirement</span> <span class=c1>// Only called on API 24+.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>boolean</span> <span class=nf>isDefaultMethod</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hasJava8Types</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>isDefault</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@IgnoreJRERequirement</span> <span class=c1>// Only called on API 26+.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>  <span class=n>Object</span> <span class=nf>invokeDefaultMethod</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>declaringClass</span><span class=o>,</span> <span class=n>Object</span> <span class=n>object</span><span class=o>,</span> <span class=n>Object</span><span class=o>...</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=kd>throws</span> <span class=n>Throwable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Lookup</span> <span class=n>lookup</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>lookupConstructor</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=n>lookupConstructor</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=n>declaringClass</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span> <span class=cm>/* trusted */</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>:</span> <span class=n>MethodHandles</span><span class=o>.</span><span class=na>lookup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>lookup</span><span class=o>.</span><span class=na>unreflectSpecial</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>declaringClass</span><span class=o>).</span><span class=na>bindTo</span><span class=o>(</span><span class=n>object</span><span class=o>).</span><span class=na>invokeWithArguments</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Android</span> <span class=kd>extends</span> <span class=n>Platform</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Android</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//API 24 ä»¥ä¸Šæ‰æ”¯æŒ Java8
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kd>super</span><span class=o>(</span><span class=n>Build</span><span class=o>.</span><span class=na>VERSION</span><span class=o>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=n>24</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Executor</span> <span class=nf>defaultCallbackExecutor</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>MainThreadExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=nf>invokeDefaultMethod</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>declaringClass</span><span class=o>,</span> <span class=n>Object</span> <span class=n>object</span><span class=o>,</span> <span class=n>Object</span><span class=o>...</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Throwable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>Build</span><span class=o>.</span><span class=na>VERSION</span><span class=o>.</span><span class=na>SDK_INT</span> <span class=o>&lt;</span> <span class=n>26</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>UnsupportedOperationException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Calling default methods on API 24 and 25 is not supported&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>invokeDefaultMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>declaringClass</span><span class=o>,</span> <span class=n>object</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>MainThreadExecutor</span> <span class=kd>implements</span> <span class=n>Executor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=o>(</span><span class=n>Looper</span><span class=o>.</span><span class=na>getMainLooper</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>      <span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=o>.</span><span class=na>post</span><span class=o>(</span><span class=n>r</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>findPlatform æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª Android ç±»å‹çš„ Platform å¯¹è±¡ï¼Œå®ƒç»§æ‰¿è‡ª Platform å¹¶é‡å†™äº† defaultCallbackExecutor è¿”å›ä¸€ä¸ª MainThreadExecutorã€‚</p><p>åŒæ—¶æ³¨æ„ 43 è¡Œæ³¨é‡Šä¸€å’Œ 57 è¡Œæ³¨é‡ŠäºŒå…³äº defaultCallAdapterFactories å’Œ defaultConverterFactories é›†åˆçš„èµ‹å€¼æƒ…å†µã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨åˆ›å»º Retrofit å¯¹è±¡çš„æ—¶å€™é€šè¿‡ Retrofit.Builder è®¾ç½®äº†ä¸€äº›å‚æ•°ï¼Œè¿™äº›å‚æ•°éƒ½ä¼šä¿å­˜åˆ°æˆå‘˜å˜é‡ä¸­ï¼Œæˆ‘ä»¬å¯¹ç…§ Retrofit.Builder.build æ–¹æ³•è¿›è¡Œè§£é‡Šï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Retrofit</span> <span class=nf>build</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>baseUrl</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Base URL required.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// callFactory å°±æ˜¯ä¼ å…¥çš„ OkHttpClient
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// å› ä¸º OkHttpClient å®ç°äº† okhttp3.Call.Factoryè¿™ä¸ªæ¥å£
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>callFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>callFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>callFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpClient</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å¦‚æœæ²¡æœ‰è®¾ç½® callbackExecutorï¼Œåˆ™è·å– platform çš„é»˜è®¤ callbackExecutor
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// è¿™é‡Œè¢«èµ‹å€¼ä¸ºäº† MainThreadExecutor
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Executor</span> <span class=n>callbackExecutor</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>callbackExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>callbackExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>callbackExecutor</span> <span class=o>=</span> <span class=n>platform</span><span class=o>.</span><span class=na>defaultCallbackExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// åœ¨é…ç½®çš„æ—¶å€™è®¾ç½®äº†ä¸€ä¸ª RxJava3CallAdapterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ç„¶åè¿™é‡Œå¦å¤–æ·»åŠ äº†ä¸€ä¸ª DefaultCallAdapterFactoryï¼Œå¹¶ä¼ å…¥åˆšè·å–çš„ callbackExecutor 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// å¦‚æœ Android API &gt;= 24ï¼Œé»˜è®¤è¿˜æœ‰ä¸€ä¸ª CompletableFutureCallAdapterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Make a defensive copy of the adapters and add the default Call adapter.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;</span><span class=n>CallAdapter</span><span class=o>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=n>callAdapterFactories</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=k>this</span><span class=o>.</span><span class=na>callAdapterFactories</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>platform</span><span class=o>.</span><span class=na>defaultCallAdapterFactories</span><span class=o>(</span><span class=n>callbackExecutor</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Make a defensive copy of the converters.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>List</span><span class=o>&lt;</span><span class=n>Converter</span><span class=o>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=n>converterFactories</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>          <span class=n>1</span> <span class=o>+</span> <span class=k>this</span><span class=o>.</span><span class=na>converterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>+</span> <span class=n>platform</span><span class=o>.</span><span class=na>defaultConverterFactoriesSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Add the built-in converter factory first. This prevents overriding its behavior but also
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ensures correct behavior when using converters that consume all types.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// æ·»åŠ å†…ç½® ConverterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>converterFactories</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>BuiltInConverters</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ·»åŠ æˆ‘ä»¬è®¾ç½®çš„ GsonConverterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>converterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>converterFactories</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å¦‚æœ Android API &gt;= 24ï¼Œæ·»åŠ é»˜è®¤çš„ OptionalConverterFactory æ”¯æŒ Java8
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>converterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>platform</span><span class=o>.</span><span class=na>defaultConverterFactories</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Retrofit</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>baseUrl</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>unmodifiableList</span><span class=o>(</span><span class=n>converterFactories</span><span class=o>),</span>
</span></span><span class=line><span class=cl>      <span class=n>unmodifiableList</span><span class=o>(</span><span class=n>callAdapterFactories</span><span class=o>),</span>
</span></span><span class=line><span class=cl>      <span class=n>callbackExecutor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>validateEagerly</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé¦–å…ˆæ˜¯æ ¹æ®é…ç½®çš„å†…å®¹å’Œ Platform è·å–åˆ° callAdapterFactories å’Œ converterFactories é›†åˆï¼Œç„¶ååˆ©ç”¨è¿™äº›å‚æ•°åˆ›å»ºä¸€ä¸ª Retrofit å®ä¾‹ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬ 37-39 è¡Œæ·»åŠ ç”¨æˆ·é…ç½®çš„ ConverterFactory å’Œ Platform é»˜è®¤çš„ ConverterFactory çš„é¡ºåºå€¼å¾—æ€€ç–‘ã€‚åæ–‡åˆ†æè¿‡ç¨‹å°†ä¼šè¿›è¡Œè§£é‡Šã€‚</p><a href=#retrofitcreate><h2 id=retrofitcreate><span class=hanchor arialabel=Anchor># </span>Retrofit.create</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>create</span><span class=o>(</span><span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>service</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>validateServiceInterface</span><span class=o>(</span><span class=n>service</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=n>Proxy</span><span class=o>.</span><span class=na>newProxyInstance</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>service</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>          <span class=k>new</span> <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=o>{</span><span class=n>service</span><span class=o>},</span>
</span></span><span class=line><span class=cl>          <span class=k>new</span> <span class=n>InvocationHandler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>private</span> <span class=kd>final</span> <span class=n>Platform</span> <span class=n>platform</span> <span class=o>=</span> <span class=n>Platform</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=kd>private</span> <span class=kd>final</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>emptyArgs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span> <span class=n>proxy</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=kd>throws</span> <span class=n>Throwable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=c1>// If the method is a method from Object then defer to normal invocation.
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=k>if</span> <span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>()</span> <span class=o>==</span> <span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>method</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>              <span class=n>args</span> <span class=o>=</span> <span class=n>args</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>args</span> <span class=o>:</span> <span class=n>emptyArgs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>              <span class=c1>// å¦‚æœæ˜¯ default æ–¹æ³•ï¼Œåˆ™é€šè¿‡ platform è°ƒç”¨æ­¤æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=c1>// æ™®é€šæ–¹æ³•åˆ™è¿›è¡Œ loadServiceMethod(method).invoke(args)
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=k>return</span> <span class=n>platform</span><span class=o>.</span><span class=na>isDefaultMethod</span><span class=o>(</span><span class=n>method</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                  <span class=o>?</span> <span class=n>platform</span><span class=o>.</span><span class=na>invokeDefaultMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>service</span><span class=o>,</span> <span class=n>proxy</span><span class=o>,</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                  <span class=o>:</span> <span class=n>loadServiceMethod</span><span class=o>(</span><span class=n>method</span><span class=o>).</span><span class=na>invoke</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>          <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>validateServiceInterface</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>service</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// service å¿…éœ€æ˜¯æ¥å£
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!</span><span class=n>service</span><span class=o>.</span><span class=na>isInterface</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;API declarations must be interfaces.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Deque</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>check</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayDeque</span><span class=o>&lt;&gt;(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>check</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>service</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=o>(!</span><span class=n>check</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>candidate</span> <span class=o>=</span> <span class=n>check</span><span class=o>.</span><span class=na>removeFirst</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>candidate</span><span class=o>.</span><span class=na>getTypeParameters</span><span class=o>().</span><span class=na>length</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>StringBuilder</span> <span class=n>message</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=s>&#34;Type parameters are unsupported on &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>candidate</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>candidate</span> <span class=o>!=</span> <span class=n>service</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34; which is an interface of &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>service</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Collections</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>check</span><span class=o>,</span> <span class=n>candidate</span><span class=o>.</span><span class=na>getInterfaces</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å¦‚æœ Retrofit.Builder ä¸­è®¾ç½®äº†æ­¤å‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>validateEagerly</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Platform</span> <span class=n>platform</span> <span class=o>=</span> <span class=n>Platform</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æå‰è§£æå¹¶éªŒè¯æ‰€æœ‰é default å’Œé static æ–¹æ³•æ˜¯å¦é…ç½®æ­£ç¡®ï¼Œå¹¶ç¼“å­˜è§£æç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=o>(</span><span class=n>Method</span> <span class=n>method</span> <span class=o>:</span> <span class=n>service</span><span class=o>.</span><span class=na>getDeclaredMethods</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>platform</span><span class=o>.</span><span class=na>isDefaultMethod</span><span class=o>(</span><span class=n>method</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>Modifier</span><span class=o>.</span><span class=na>isStatic</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>loadServiceMethod</span><span class=o>(</span><span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡ Retrofit.create(Class) æ–¹æ³•çš„è°ƒç”¨ï¼Œä¼šåˆ›å»ºå‡º GitHubService çš„å®ä¾‹ï¼Œä»è€Œä½¿å¾— GitHubService ä¸­é…ç½®çš„æ–¹æ³•å˜å¾—å¯ç”¨ï¼Œè¿™æ˜¯ Retrofit ä»£ç ç»“æ„çš„æ ¸å¿ƒã€‚</p><p>Retrofit.create() æ–¹æ³•çš„æ ¸å¿ƒï¼Œä½¿ç”¨çš„æ˜¯ Proxy.newProxyInstance() æ–¹æ³•æ¥åˆ›å»º GitHubService å®ä¾‹ã€‚è¿™ä¸ªæ–¹æ³•ä¼šä¸ºå‚æ•°ä¸­çš„å¤šä¸ª interfaceï¼ˆå…·ä½“åˆ° Retrofit æ¥è¯´ï¼Œæ˜¯å›ºå®šä¼ å…¥ä¸€ä¸ª interfaceï¼‰åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®ç°äº†æ‰€æœ‰ interface çš„æ¯ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”æ¯ä¸ªæ–¹æ³•çš„å®ç°éƒ½æ˜¯é›·åŒçš„ï¼šè°ƒç”¨å¯¹è±¡å®ä¾‹å†…éƒ¨çš„ä¸€ä¸ª InvocationHandler æˆå‘˜å˜é‡çš„ invoke() æ–¹æ³•ï¼Œå¹¶æŠŠè‡ªå·±çš„æ–¹æ³•ä¿¡æ¯ä¼ é€’è¿›å»ã€‚è¿™æ ·å°±åœ¨å®è´¨ä¸Šå®ç°äº†ä»£ç†é€»è¾‘ï¼šinterface ä¸­çš„æ–¹æ³•å…¨éƒ¨ç”±ä¸€ä¸ªå¦å¤–è®¾å®šçš„ InvocationHandler å¯¹è±¡æ¥è¿›è¡Œä»£ç†æ“ä½œã€‚å¹¶ä¸”ï¼Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°æ˜¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆ interface å®ä¾‹æ—¶æ‰ç¡®å®šçš„ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘æ—¶ï¼ˆè™½ç„¶åœ¨ç¼–è¯‘æ—¶å°±å·²ç»å¯ä»¥é€šè¿‡ä»£ç é€»è¾‘æ¨æ–­å‡ºæ¥ï¼‰ã€‚è¿™å°±æ˜¯<strong>ã€ŒåŠ¨æ€ä»£ç†æœºåˆ¶ã€</strong>çš„å…·ä½“å«ä¹‰ã€‚</p><p>å› æ­¤ï¼Œinvoke() æ–¹æ³•ä¸­çš„é€»è¾‘ï¼Œå°±æ˜¯ Retrofit åˆ›å»º Service å®ä¾‹çš„å…³é”®ã€‚</p><p>å½“è°ƒç”¨ GitHubService ä¸­é…ç½®å¥½çš„è¯·æ±‚æ–¹æ³•æ—¶ï¼Œ<code>InvocationHandler.invoke()</code> æ–¹æ³•å°±ä¼šè¢«å›è°ƒã€‚åœ¨ invoke æ–¹æ³•ä¸­ï¼Œä¼šè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè°ƒç”¨çš„æ˜¯æˆ‘ä»¬é…ç½®çš„è¯·æ±‚æ–¹æ³•ï¼Œåˆ™ä¼šèµ°åˆ° <code>loadServiceMethod(method).invoke(args)</code>ã€‚</p><a href=#loadservicemethodmethod><h2 id=loadservicemethodmethod><span class=hanchor arialabel=Anchor># </span>loadServiceMethod(method)</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ServiceMethod</span><span class=o>&lt;?&gt;</span> <span class=n>loadServiceMethod</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ServiceMethod</span><span class=o>&lt;?&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>serviceMethodCache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=n>serviceMethodCache</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>serviceMethodCache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>ServiceMethod</span><span class=o>.</span><span class=na>parseAnnotations</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>serviceMethodCache</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¯¹ ServiceMethod è¿›è¡Œäº†ç¼“å­˜è®¾è®¡ã€‚å…·ä½“è§£ææ–¹æ³•è¿˜æ˜¯åœ¨ ServiceMethod ä¸­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>ServiceMethod</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>parseAnnotations</span><span class=o>(</span><span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è§£ææ–¹æ³•æ³¨è§£å¹¶åˆ›å»º RequestFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>RequestFactory</span> <span class=n>requestFactory</span> <span class=o>=</span> <span class=n>RequestFactory</span><span class=o>.</span><span class=na>parseAnnotations</span><span class=o>(</span><span class=n>retrofit</span><span class=o>,</span> <span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>returnType</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getGenericReturnType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Utils</span><span class=o>.</span><span class=na>hasUnresolvableType</span><span class=o>(</span><span class=n>returnType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>method</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Method return type must not include a type variable or wildcard: %s&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>returnType</span> <span class=o>==</span> <span class=kt>void</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=s>&#34;Service methods cannot return void.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è§£ææ–¹æ³•æ³¨è§£å¹¶åˆ›å»º HttpServiceMethod 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>HttpServiceMethod</span><span class=o>.</span><span class=na>parseAnnotations</span><span class=o>(</span><span class=n>retrofit</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>requestFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>abstract</span> <span class=nd>@Nullable</span> <span class=n>T</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>HttpServiceMethod ç»§æ‰¿è‡ª ServiceMethodï¼ŒparseAnnotations æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=nf>parseAnnotations</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>RequestFactory</span> <span class=n>requestFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>isKotlinSuspendFunction</span> <span class=o>=</span> <span class=n>requestFactory</span><span class=o>.</span><span class=na>isKotlinSuspendFunction</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>continuationWantsResponse</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>continuationBodyNullable</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getAnnotations</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>adapterType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å¦‚æœæ˜¯ Kotlin suspend æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>isKotlinSuspendFunction</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span><span class=o>[]</span> <span class=n>parameterTypes</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getGenericParameterTypes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>responseType</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>Utils</span><span class=o>.</span><span class=na>getParameterLowerBound</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>parameterTypes</span><span class=o>[</span><span class=n>parameterTypes</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>responseType</span><span class=o>)</span> <span class=o>==</span> <span class=n>Response</span><span class=o>.</span><span class=na>class</span> <span class=o>&amp;&amp;</span> <span class=n>responseType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Unwrap the actual body type from Response&lt;T&gt;.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>responseType</span> <span class=o>=</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>continuationWantsResponse</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// TODO figure out if type is nullable or not
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Metadata metadata = method.getDeclaringClass().getAnnotation(Metadata.class)
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Find the entry for method
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// Determine if return type is nullable or not
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>adapterType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Utils</span><span class=o>.</span><span class=na>ParameterizedTypeImpl</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>Call</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span> <span class=o>=</span> <span class=n>SkipCallbackExecutorImpl</span><span class=o>.</span><span class=na>ensurePresent</span><span class=o>(</span><span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ™®é€šæ–¹æ³•è¿”å›æ³›å‹å‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>adapterType</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getGenericReturnType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 1ã€æ ¹æ® method çš„è¿”å›å€¼ç±»å‹ä»¥åŠæ–¹æ³•æ³¨è§£è¿”å›ç¬¬ä¸€ä¸ªå¯ä»¥å¤„ç†çš„ CallAdapter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>callAdapter</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>createCallAdapter</span><span class=o>(</span><span class=n>retrofit</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>adapterType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>responseType</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>responseType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>responseType</span> <span class=o>==</span> <span class=n>okhttp3</span><span class=o>.</span><span class=na>Response</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;&#39;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=n>getRawType</span><span class=o>(</span><span class=n>responseType</span><span class=o>).</span><span class=na>getName</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=s>&#34;&#39; is not a valid response body type. Did you mean ResponseBody?&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>responseType</span> <span class=o>==</span> <span class=n>Response</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=s>&#34;Response must include generic type (e.g., Response&lt;String&gt;)&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// TODO support Unit for Kotlin?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>requestFactory</span><span class=o>.</span><span class=na>httpMethod</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;HEAD&#34;</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>Void</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>responseType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=s>&#34;HEAD method must use Void as response type.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 2ã€æ ¹æ® responseType ä»¥åŠæ–¹æ³•æ³¨è§£è¿”å›ç¬¬ä¸€ä¸ªå¯ä»¥å¤„ç†çš„ Converter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>responseConverter</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>createResponseConverter</span><span class=o>(</span><span class=n>retrofit</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 3ã€æ ¹æ®ä¸åŒçš„åœºæ™¯è¿”å›ä¸åŒçš„ HttpServiceMethod å®ç°
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span> <span class=o>=</span> <span class=n>retrofit</span><span class=o>.</span><span class=na>callFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!</span><span class=n>isKotlinSuspendFunction</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3.1ã€æ ¹æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=n>CallAdapted</span><span class=o>&lt;&gt;(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>,</span> <span class=n>callAdapter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>continuationWantsResponse</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>(</span><span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;)</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>SuspendForResponse</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;)</span> <span class=n>callAdapter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>(</span><span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;)</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>SuspendForBody</span><span class=o>&lt;&gt;(</span>
</span></span><span class=line><span class=cl>            <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;)</span> <span class=n>callAdapter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>continuationBodyNullable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™è¡Œä»£ç è´Ÿè´£è¯»å– interface ä¸­åŸæ–¹æ³•çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬è¿”å›å€¼ç±»å‹ã€æ–¹æ³•æ³¨è§£ã€å‚æ•°ç±»å‹ã€å‚æ•°æ³¨è§£ï¼‰ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯åšåˆæ­¥åˆ†æåæ ¹æ®è¿™äº›ä¿¡æ¯åˆ›å»ºå‡ºæ¯ä¸ªæ–¹æ³•å¯¹åº”çš„ CallAdapter å’Œ Convetor ç­‰å¯¹è±¡ï¼Œå¹¶å°†è¿™äº›å¯¹è±¡ä¼ å…¥ä¸€ä¸ª CallAdapted å¯¹è±¡å¹¶è¿”å›æ­¤å¯¹è±¡ã€‚</p><p>è¿™é‡Œåˆ†åˆ«åˆ†æ 32 è¡Œ <code>createCallAdapter</code> å’Œ 51 è¡Œ <code>createResponseConverter</code> çš„ä»£ç ã€‚</p><a href=#createcalladapter><h3 id=createcalladapter><span class=hanchor arialabel=Anchor># </span>createCallAdapter</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=nf>createCallAdapter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>(</span><span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;)</span> <span class=n>retrofit</span><span class=o>.</span><span class=na>callAdapter</span><span class=o>(</span><span class=n>returnType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// Wide exception range because factories are user code.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>e</span><span class=o>,</span> <span class=s>&#34;Unable to create call adapter for %s&#34;</span><span class=o>,</span> <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿˜æ˜¯äº¤ç»™ Retrofit ç±»å¤„ç†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>callAdapter</span><span class=o>(</span><span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>nextCallAdapter</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>nextCallAdapter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>CallAdapter</span><span class=o>.</span><span class=na>Factory</span> <span class=n>skipPast</span><span class=o>,</span> <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>returnType</span><span class=o>,</span> <span class=s>&#34;returnType == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>annotations</span><span class=o>,</span> <span class=s>&#34;annotations == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// éå† callAdapterFactories é›†åˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>start</span> <span class=o>=</span> <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=n>skipPast</span><span class=o>)</span> <span class=o>+</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=o>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é€šè¿‡ CallAdapter.Factory.get åˆ¤æ–­æ˜¯å¦ä¸ºç¬¦åˆè¦æ±‚çš„ CallAdapter
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>adapter</span> <span class=o>=</span> <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>get</span><span class=o>(</span><span class=n>returnType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>adapter</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>adapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>StringBuilder</span> <span class=n>builder</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=s>&#34;Could not locate call adapter for &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>returnType</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;.\n&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>skipPast</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;  Skipped:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>start</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;\n   * &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;\n&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;  Tried:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=o>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;\n   * &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>callAdapterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=n>builder</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯éå† callAdapterFactories é›†åˆï¼Œè°ƒç”¨æ¯ä¸ª CallAdapter.Factory.get() æ–¹æ³•å¹¶ä¼ å…¥è¯·æ±‚æ–¹æ³•çš„æ³¨è§£ä¿¡æ¯å’Œè¿”å›å€¼ä¿¡æ¯ï¼Œæ ¹æ®è¿™äº›ä¿¡æ¯æ¯ä¸ª CallAdapter.Factory å»åˆ¤æ–­æ­¤è¯·æ±‚æ–¹æ³•é€‚ä¸é€‚åˆè‡ªå·±ã€‚</p><a href=#defaultcalladapterfactoryget><h4 id=defaultcalladapterfactoryget><span class=hanchor arialabel=Anchor># </span>DefaultCallAdapterFactory.get()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>get</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ–¹æ³•è¿”å›å€¼ä¸º Call ç±»å‹
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>returnType</span><span class=o>)</span> <span class=o>!=</span> <span class=n>Call</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// æ–¹æ³•è¿”å›å€¼å¿…é¡»åŒ…å«æ³›å‹ Call&lt;Foo&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!(</span><span class=n>returnType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;Call return type must be parameterized as Call&lt;Foo&gt; or Call&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>Type</span> <span class=n>responseType</span> <span class=o>=</span> <span class=n>Utils</span><span class=o>.</span><span class=na>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// executor = callbackExecutor = MainThreadExecutor
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>final</span> <span class=n>Executor</span> <span class=n>executor</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>Utils</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>annotations</span><span class=o>,</span> <span class=n>SkipCallbackExecutor</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=n>callbackExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// è¿”å›åŒ¿åå¯¹è±¡å®ç° CallAdapter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=k>new</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;?&gt;&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Type</span> <span class=nf>responseType</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>responseType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>executor</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>call</span> <span class=o>:</span> <span class=k>new</span> <span class=n>ExecutorCallbackCall</span><span class=o>&lt;&gt;(</span><span class=n>executor</span><span class=o>,</span> <span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>};</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>DefaultCallAdapterFactory é¦–å…ˆé€šè¿‡åˆ¤æ–­æ–¹æ³•è¿”å›å€¼æ˜¯å¦ä¸º Call ç±»å‹å¹¶ä¸”æ˜¯å¦å¸¦æœ‰æ³›å‹å‚æ•°æ¥ç¡®å®šèƒ½ä¸èƒ½å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼›</li><li>ç„¶åå°† executor èµ‹å€¼ä¸ºå‰é¢ Retrofit.create æµç¨‹ä¸­è·å–åˆ°çš„ MainThreadExecutorï¼›</li><li>æœ€åè¿”å›ä¸€ä¸ª CallAdapter çš„åŒ¿åå®ç°ç±»ã€‚</li></ol><a href=#rxjava3calladapterfactoryget><h4 id=rxjava3calladapterfactoryget><span class=hanchor arialabel=Anchor># </span>RxJava3CallAdapterFactory.get()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>get</span><span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>rawType</span> <span class=o>=</span> <span class=n>getRawType</span><span class=o>(</span><span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>rawType</span> <span class=o>==</span> <span class=n>Completable</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Completable is not parameterized (which is what the rest of this method deals with) so it
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// can only be created with a single configuration.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=k>new</span> <span class=n>RxJava3CallAdapter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>Void</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>scheduler</span><span class=o>,</span> <span class=n>isAsync</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isFlowable</span> <span class=o>=</span> <span class=n>rawType</span> <span class=o>==</span> <span class=n>Flowable</span><span class=o>.</span><span class=na>class</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isSingle</span> <span class=o>=</span> <span class=n>rawType</span> <span class=o>==</span> <span class=n>Single</span><span class=o>.</span><span class=na>class</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isMaybe</span> <span class=o>=</span> <span class=n>rawType</span> <span class=o>==</span> <span class=n>Maybe</span><span class=o>.</span><span class=na>class</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>rawType</span> <span class=o>!=</span> <span class=n>Observable</span><span class=o>.</span><span class=na>class</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isFlowable</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isSingle</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isMaybe</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isResult</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>isBody</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>responseType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!(</span><span class=n>returnType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>String</span> <span class=n>name</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>isFlowable</span> <span class=o>?</span> <span class=s>&#34;Flowable&#34;</span> <span class=o>:</span> <span class=n>isSingle</span> <span class=o>?</span> <span class=s>&#34;Single&#34;</span> <span class=o>:</span> <span class=n>isMaybe</span> <span class=o>?</span> <span class=s>&#34;Maybe&#34;</span> <span class=o>:</span> <span class=s>&#34;Observable&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=n>name</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; return type must be parameterized&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34; as &#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34;&lt;Foo&gt; or &#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s>&#34;&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>observableType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>rawObservableType</span> <span class=o>=</span> <span class=n>getRawType</span><span class=o>(</span><span class=n>observableType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>rawObservableType</span> <span class=o>==</span> <span class=n>Response</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!(</span><span class=n>observableType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Response must be parameterized&#34;</span> <span class=o>+</span> <span class=s>&#34; as Response&lt;Foo&gt; or Response&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>responseType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>observableType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>rawObservableType</span> <span class=o>==</span> <span class=n>Result</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!(</span><span class=n>observableType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Result must be parameterized&#34;</span> <span class=o>+</span> <span class=s>&#34; as Result&lt;Foo&gt; or Result&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>responseType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>observableType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>isResult</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>responseType</span> <span class=o>=</span> <span class=n>observableType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>isBody</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>RxJava3CallAdapter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>responseType</span><span class=o>,</span> <span class=n>scheduler</span><span class=o>,</span> <span class=n>isAsync</span><span class=o>,</span> <span class=n>isResult</span><span class=o>,</span> <span class=n>isBody</span><span class=o>,</span> <span class=n>isFlowable</span><span class=o>,</span> <span class=n>isSingle</span><span class=o>,</span> <span class=n>isMaybe</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#completablefuturecalladapterfactoryget><h4 id=completablefuturecalladapterfactoryget><span class=hanchor arialabel=Anchor># </span>CompletableFutureCallAdapterFactory.get()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>CallAdapter</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>get</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>returnType</span><span class=o>)</span> <span class=o>!=</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(!(</span><span class=n>returnType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;CompletableFuture return type must be parameterized&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>+</span> <span class=s>&#34; as CompletableFuture&lt;Foo&gt; or CompletableFuture&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>innerType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>returnType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>innerType</span><span class=o>)</span> <span class=o>!=</span> <span class=n>Response</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Generic type is not Response&lt;T&gt;. Use it for body-only adapter.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=n>BodyCallAdapter</span><span class=o>&lt;&gt;(</span><span class=n>innerType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Generic type is Response&lt;T&gt;. Extract T and create the Response version of the adapter.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(!(</span><span class=n>innerType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;Response must be parameterized&#34;</span> <span class=o>+</span> <span class=s>&#34; as Response&lt;Foo&gt; or Response&lt;? extends Foo&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Type</span> <span class=n>responseType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>innerType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>ResponseCallAdapter</span><span class=o>&lt;&gt;(</span><span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#å°ç»“><h4 id=å°ç»“><span class=hanchor arialabel=Anchor># </span>å°ç»“</h4></a><p>å¯¹äºä¾‹å­ä¸­ GithubService ä¸­çš„è¯·æ±‚æ–¹æ³•ï¼š</p><ol><li><code>fun listRepos(@Path("user") user: String?): Call&lt;List&lt;Repo>></code></li></ol><p>è¿”å›åŒ¿åçš„ CallAdapter å®ç°ç±»</p><ol start=2><li><code>fun listReposRx(@Path("user") user: String?): Observable&lt;List&lt;Repo>></code></li></ol><p>è¿”å› RxJava3CallAdapter å®ä¾‹</p><ol start=3><li><code>fun listReposCompletable(@Path("user") user: String?): CompletableFuture&lt;List&lt;Repo>></code></li></ol><p>è¿”å› CompletableFutureCallAdapterFactory.ResponseCallAdapter å®ä¾‹</p><p>Retrofit.callAdapter() æ–¹æ³•çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆä¼šéå† callAdapterFactories é›†åˆï¼Œå¹¶è°ƒç”¨æ¯ä¸ª CallAdapter.Factory.get() æ–¹æ³•å¹¶ä¼ å…¥è¯·æ±‚æ–¹æ³•çš„æ³¨è§£ä¿¡æ¯å’Œè¿”å›å€¼ä¿¡æ¯ï¼Œæ ¹æ®è¿™äº›ä¿¡æ¯æ¯ä¸ª CallAdapterFactory å»åˆ¤æ–­æ­¤è¯·æ±‚æ–¹æ³•é€‚ä¸é€‚åˆè‡ªå·±ã€‚</li><li>ä¸€æ—¦æ‰¾åˆ°åˆé€‚çš„ CallAdapter åˆ™ä¼šç«‹å³æ‰“ç ´å¾ªç¯å¹¶è¿”å›ã€‚</li><li>DefaultCallAdapterFactory åªèƒ½å¤„ç†è¿”å›å€¼ä¸º <code>Call&lt;Foo></code> æˆ–è€… <code>Call&lt;? extends Foo></code> çš„è¯·æ±‚æ–¹æ³•ï¼Œå¹¶ä¸”ä¸ºå®ƒä»¬è¿”å›ä¸€ä¸ªåŒ¿åçš„ CallAdapter å®ç°ã€‚</li><li>å…¶å®ƒæƒ…å†µï¼Œå¦‚æœè¦æ”¯æŒ Rxjavaï¼Œåˆ™éœ€è¦é¢å¤–å¢åŠ  CallAdapterFactory æ”¯æŒã€‚</li><li>å¦‚æœ Android API >= 24ï¼Œå¦‚æœè¯·æ±‚æ–¹æ³•è¿”å›çš„æ˜¯ CompletableFutureï¼ŒRetrofit é»˜è®¤ä¼šè¿›è¡Œæ”¯æŒå¹¶è¿”å› CompletableFutureCallAdapterFactory è¿›è¡Œå¤„ç†ã€‚</li><li>å¦‚æœéœ€è¦æ”¯æŒå…¶å®ƒçš„è¿”å›å€¼ç±»å‹ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨é€šè¿‡ addCallAdapterFactory() æ–¹æ³•å¢åŠ å¯¹ CallAdapterFactory çš„æ”¯æŒã€‚</li><li>å¦‚æœè¯·æ±‚æ–¹æ³•è¿”å›å€¼ä¸å—æ”¯æŒï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li></ul><a href=#createresponseconverter><h3 id=createresponseconverter><span class=hanchor arialabel=Anchor># </span>createResponseConverter</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=nf>createResponseConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Type</span> <span class=n>responseType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getAnnotations</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>retrofit</span><span class=o>.</span><span class=na>responseBodyConverter</span><span class=o>(</span><span class=n>responseType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// Wide exception range because factories are user code.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>throw</span> <span class=n>methodError</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>e</span><span class=o>,</span> <span class=s>&#34;Unable to create converter for %s&#34;</span><span class=o>,</span> <span class=n>responseType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿˜æ˜¯ä» Retrofit ç±»ä¸­è·å–ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=nf>responseBodyConverter</span><span class=o>(</span><span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>nextResponseBodyConverter</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>type</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=nf>nextResponseBodyConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Nullable</span> <span class=n>Converter</span><span class=o>.</span><span class=na>Factory</span> <span class=n>skipPast</span><span class=o>,</span> <span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>type</span><span class=o>,</span> <span class=s>&#34;type == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>annotations</span><span class=o>,</span> <span class=s>&#34;annotations == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>start</span> <span class=o>=</span> <span class=n>converterFactories</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=n>skipPast</span><span class=o>)</span> <span class=o>+</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=o>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>converterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>converter</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>converterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>responseBodyConverter</span><span class=o>(</span><span class=n>type</span><span class=o>,</span> <span class=n>annotations</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>converter</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//noinspection unchecked
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=o>(</span><span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>T</span><span class=o>&gt;)</span> <span class=n>converter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>StringBuilder</span> <span class=n>builder</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=s>&#34;Could not locate ResponseBody converter for &#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>type</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;.\n&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>skipPast</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;  Skipped:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>start</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;\n   * &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>converterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;\n&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;  Tried:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=o>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>converterFactories</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;\n   * &#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>converterFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=n>builder</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#builtinconvertersresponsebodyconverter><h4 id=builtinconvertersresponsebodyconverter><span class=hanchor arialabel=Anchor># </span>BuiltInConverters.responseBodyConverter()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>responseBodyConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è¿”å›å€¼ç±»å‹ä¸º ResponseBody
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>ResponseBody</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Utils</span><span class=o>.</span><span class=na>isAnnotationPresent</span><span class=o>(</span><span class=n>annotations</span><span class=o>,</span> <span class=n>Streaming</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=n>StreamingResponseBodyConverter</span><span class=o>.</span><span class=na>INSTANCE</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=n>BufferingResponseBodyConverter</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è¿”å›å€¼ä¸º void
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>Void</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>VoidResponseBodyConverter</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è¿”å›å€¼ä¸º Kotlin çš„ Unit
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>checkForKotlinUnit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>Unit</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>UnitResponseBodyConverter</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoClassDefFoundError</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>checkForKotlinUnit</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ®å‰é¢åˆ†æå¯çŸ¥ï¼ŒBuiltInConverters æ˜¯ Retrofit åœ¨ Android Platform ä¸Šå”¯ä¸€é»˜è®¤çš„ ConvertFactoryã€‚å› æ­¤ï¼Œè¯·æ±‚æ–¹æ³•çš„è¿”å›å€¼çš„æ•°æ®ç±»å‹ï¼ˆæ³¨æ„ä¸æ˜¯è¿”å›å€¼ç±»å‹ï¼‰åªæœ‰åœ¨ä»¥ä¸Šä¸‰ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡ Retrofit.Builder() åˆ›å»º Retrofit çš„æ—¶å€™æ‰å¯ä»¥ä¸æŒ‡å®š ConvertFactoryï¼Œå¦åˆ™è°ƒç”¨è¯¥æ–¹æ³•çš„æ—¶å€™å°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><a href=#gsonconverterfactory-responsebodyconverter><h4 id=gsonconverterfactory-responsebodyconverter><span class=hanchor arialabel=Anchor># </span>GsonConverterFactory. responseBodyConverter()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>responseBodyConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>TypeAdapter</span><span class=o>&lt;?&gt;</span> <span class=n>adapter</span> <span class=o>=</span> <span class=n>gson</span><span class=o>.</span><span class=na>getAdapter</span><span class=o>(</span><span class=n>TypeToken</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>type</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>GsonResponseBodyConverter</span><span class=o>&lt;&gt;(</span><span class=n>gson</span><span class=o>,</span> <span class=n>adapter</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœé€šè¿‡ addConverterFactory() æ·»åŠ äº† GsonConverterFactory ï¼Œè¿™é‡Œå°†è¿”å›ä¸€ä¸ª GsonResponseBodyConverter å®ä¾‹ï¼Œä¸ç”¨è¿›è¡Œä»»ä½•åˆ¤æ–­ï¼Œå½“ç„¶ gson.getAdapter ä¸­ä¸èƒ½æŠ›å‡ºå¼‚å¸¸ã€‚</p><a href=#optionalconverterfactoryresponsebodyconverter><h4 id=optionalconverterfactoryresponsebodyconverter><span class=hanchor arialabel=Anchor># </span>OptionalConverterFactory.responseBodyConverter()</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@Nullable</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>responseBodyConverter</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=n>type</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>getRawType</span><span class=o>(</span><span class=n>type</span><span class=o>)</span> <span class=o>!=</span> <span class=n>Optional</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// è·å– Option å†…å±‚çš„æ³›å‹ç±»å‹
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Type</span> <span class=n>innerType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>type</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>delegate</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>retrofit</span><span class=o>.</span><span class=na>responseBodyConverter</span><span class=o>(</span><span class=n>innerType</span><span class=o>,</span> <span class=n>annotations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>OptionalConverter</span><span class=o>&lt;&gt;(</span><span class=n>delegate</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®ƒåªå¤„ç†è¿”å›å€¼ä¸º <code>Call&lt;Option&lt;Foo>></code> ç±»å‹çš„è¯·æ±‚ï¼Œå¹¶ä¸”è„±å»å¤–è¡£è·å– Option å†…å±‚çš„æ³›å‹ç±»å‹ innerTypeï¼Œå¹¶ä¸”ä½¿ç”¨è¿™ä¸ª innerType æŸ¥æ‰¾åˆ°å¦å¤–ä¸€ä¸ªç¬¦åˆè¦æ±‚ Converterï¼Œæœ€åçš„ Convert æ“ä½œéƒ½ä½¿ç”¨è¿™ä¸ª delegate è¿›è¡Œè½¬æ¢æ“ä½œã€‚</p><a href=#å°ç»“-1><h4 id=å°ç»“-1><span class=hanchor arialabel=Anchor># </span>å°ç»“</h4></a><p>å¯¹äº BuiltInConvertersï¼Œå®ƒåªä¼šæŸ¥çœ‹æ³›å‹å‚æ•°å†…å®¹ï¼Œå¦‚æœæ³›å‹å‚æ•°ä¸º ResponseBodyã€Void æˆ–è€… Kotlin çš„ Unitï¼ŒBuiltInConverters å°†ä¼šè¿”å›ç›¸åº”çš„ Converterï¼›</p><p>å¯¹äº GsonConverterFactoryï¼Œå®ƒå°†æ¥è€…ä¸æ‹’ï¼Œè¿”å› GsonResponseBodyConverterã€‚</p><p>å¯¹äº OptionalConverterFactoryï¼Œå®ƒåªå¤„ç†è¿”å›å€¼ä¸º <code>Call&lt;Option&lt;Foo>></code> ç±»å‹çš„è¯·æ±‚ï¼Œå¹¶ä¸”å§”æ‰˜å¦å¤–ä¸€ä¸ªç¬¦åˆè¦æ±‚ Converter è¿›è¡Œè½¬æ¢æ“ä½œã€‚</p><p>Retrofit.responseBodyConverter() æ–¹æ³•ä¸€æ—¦æ‰¾åˆ°åˆé€‚çš„ CallAdapterFactory åˆ™ä¼šç«‹å³æ‰“ç ´å¾ªç¯å¹¶è¿”å›ã€‚</p><p>å› æ­¤è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œå‰é¢æåˆ°è¿‡çš„ Retrofit.Builder.build() æ–¹æ³•ä¸­ï¼ŒconverterFactories çš„æ·»åŠ é¡ºåºå¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æ·»åŠ å†…ç½® ConverterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>converterFactories</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>BuiltInConverters</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=c1>// æ·»åŠ æˆ‘ä»¬è®¾ç½®çš„ GsonConverterFactory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>converterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>converterFactories</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// å¦‚æœ Android API &gt;= 24ï¼Œæ·»åŠ é»˜è®¤çš„ OptionalConverterFactory æ”¯æŒ Java8
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>converterFactories</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>platform</span><span class=o>.</span><span class=na>defaultConverterFactories</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ—¶å€™å¦‚æœè¦åƒè¿™æ ·ä½¿ç”¨ Optional å»æ¥æ”¶æ•°æ®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@GET</span><span class=p>(</span><span class=s2>&#34;users/{user}/repos&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>listReposOptional</span><span class=p>(</span><span class=nd>@Path</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span> <span class=n>user</span><span class=p>:</span> <span class=n>String</span><span class=p>?):</span> <span class=n>Call</span><span class=p>&lt;</span><span class=n>Optional</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>Repo</span><span class=p>&gt;&gt;&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>com.google.gson.JsonSyntaxException: java.lang.IllegalStateException: Expected BEGIN_OBJECT but was BEGIN_ARRAY at line 1 column 2 path $
</span></span><span class=line><span class=cl>        at com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$Adapter.read(ReflectiveTypeAdapterFactory.java:226)
</span></span><span class=line><span class=cl>        at retrofit2.converter.gson.GsonResponseBodyConverter.convert(GsonResponseBodyConverter.java:40)
</span></span><span class=line><span class=cl>        at retrofit2.converter.gson.GsonResponseBodyConverter.convert(GsonResponseBodyConverter.java:27)
</span></span><span class=line><span class=cl>        at retrofit2.OkHttpCall.parseResponse(OkHttpCall.java:243)
</span></span><span class=line><span class=cl>        at retrofit2.OkHttpCall$1.onResponse(OkHttpCall.java:153)
</span></span></code></pre></td></tr></table></div></div><p>å¾ˆæ˜æ˜¾è¿™æ˜¯æ¥è‡ª gson çš„é”™è¯¯ï¼Œæ ¹æ®å‰é¢çš„åˆ†æï¼Œå¦‚æœåœ¨ Retrofit.Builder è¿‡ç¨‹æ·»åŠ äº† GsonConverterFactoryï¼ŒresponseBodyConverter() æ–¹æ³•ä¸­ä¼šç›´æ¥è¿”å›ä¸€ä¸ª GsonResponseBodyConverter å¯¹è±¡ï¼Œåœ¨è§£é‡Šè¿”å›ç»“æœçš„æ—¶å€™ä¼šæ‹¿ <code>Optional&lt;List&lt;Repo>></code> å»æ¥æ”¶ JSON æ•°ç»„ï¼Œå¯¼è‡´è§£æå‡ºé”™ã€‚</p><p>å¦‚æœè¦ä½¿è¿™ä¸ªæµç¨‹èµ°å¾—é€šï¼Œå°±éœ€è¦å°†ç¬¬ 4 è¡Œå’Œç¬¬ 6 è¡Œä»£ç è¿›è¡Œäº¤æ¢ã€‚ï¼ˆæœ¬äººäº²è‡ªéªŒè¯å¯è¡Œï¼‰</p><p>å¯èƒ½è¿™æ˜¯ Retrofit çš„ä¸€ä¸ª bugï¼Œå¦‚æœæœ‰å…¶ä»–ä¸åŒçš„ç†è§£ï¼Œæ¬¢è¿è®¨è®ºã€‚</p><a href=#return><h3 id=return><span class=hanchor arialabel=Anchor># </span>return</h3></a><p>ä»ä»¥ä¸Šåˆ†æå¯çŸ¥ï¼ŒparseAnnotations() æ–¹æ³•æœ€ç»ˆä¼šè¿”å› HttpServiceMethod å®ä¾‹ï¼Œè€Œ HttpServiceMethod ç±»åˆä¸‰ä¸ªå­ç±»ï¼ŒparseAnnotations() æ–¹æ³•çš„æœ€åä¼šæ ¹æ®ä¸åŒçš„æ¡ä»¶æ¥è¿”å›ä¸åŒçš„å­ç±»å®ä¾‹ã€‚</p><p>å¦‚æœæˆ‘ä»¬çš„è¯·æ±‚æ–¹æ³•ä¸æ˜¯ Kotlin æŒ‚èµ·å‡½æ•°ï¼Œè¿”å›çš„æ˜¯ CallAdapted å¯¹è±¡ã€‚</p><a href=#calladapted><h4 id=calladapted><span class=hanchor arialabel=Anchor># </span>CallAdapted</h4></a><p>æ­¤æ—¶ loadServiceMethod() è¿”å›çš„å¯¹è±¡ä¸º CallAdaptedï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>CallAdapted</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>CallAdapted</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestFactory</span> <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>ReturnT</span><span class=o>&gt;</span> <span class=n>callAdapter</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callAdapter</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>ReturnT</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#suspendforresponse><h4 id=suspendforresponse><span class=hanchor arialabel=Anchor># </span>SuspendForResponse</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>SuspendForResponse</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>SuspendForResponse</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestFactory</span> <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>callAdapter</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callAdapter</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Object</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked Checked by reflection inside RequestFactory.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Continuation</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>continuation</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=o>(</span><span class=n>Continuation</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;)</span> <span class=n>args</span><span class=o>[</span><span class=n>args</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// See SuspendForBody for explanation about this try/catch.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>awaitResponse</span><span class=o>(</span><span class=n>call</span><span class=o>,</span> <span class=n>continuation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>suspendAndThrow</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=n>continuation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#suspendforbody><h4 id=suspendforbody><span class=hanchor arialabel=Anchor># </span>SuspendForBody</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>SuspendForBody</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>HttpServiceMethod</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isNullable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>SuspendForBody</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestFactory</span> <span class=n>requestFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span><span class=o>.</span><span class=na>Factory</span> <span class=n>callFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=o>,</span> <span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>responseConverter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;&gt;</span> <span class=n>callAdapter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>isNullable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callAdapter</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>isNullable</span> <span class=o>=</span> <span class=n>isNullable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Object</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//noinspection unchecked Checked by reflection inside RequestFactory.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Continuation</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>continuation</span> <span class=o>=</span> <span class=o>(</span><span class=n>Continuation</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;)</span> <span class=n>args</span><span class=o>[</span><span class=n>args</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Calls to OkHttp Call.enqueue() like those inside await and awaitNullable can sometimes
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// invoke the supplied callback with an exception before the invoking stack frame can return.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Coroutines will intercept the subsequent invocation of the Continuation and throw the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// exception synchronously. A Java Proxy cannot throw checked exceptions without them being
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// declared on the interface method. To avoid the synchronous checked exception being wrapped
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// in an UndeclaredThrowableException, it is intercepted and supplied to a helper which will
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// force suspension to occur so that it can be instead delivered to the continuation to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// bypass this restriction.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>isNullable</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>awaitNullable</span><span class=o>(</span><span class=n>call</span><span class=o>,</span> <span class=n>continuation</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>await</span><span class=o>(</span><span class=n>call</span><span class=o>,</span> <span class=n>continuation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>KotlinExtensions</span><span class=o>.</span><span class=na>suspendAndThrow</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=n>continuation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#httpservicemethodinvokeobject-args><h2 id=httpservicemethodinvokeobject-args><span class=hanchor arialabel=Anchor># </span>HttpServiceMethod.invoke(Object[] args)</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=nd>@Nullable</span> <span class=n>ReturnT</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpCall</span><span class=o>&lt;&gt;(</span><span class=n>requestFactory</span><span class=o>,</span> <span class=n>args</span><span class=o>,</span> <span class=n>callFactory</span><span class=o>,</span> <span class=n>responseConverter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kd>abstract</span> <span class=nd>@Nullable</span> <span class=n>ReturnT</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#new-okhttpcall><h3 id=new-okhttpcall><span class=hanchor arialabel=Anchor># </span>new OkHttpCall&lt;>()</h3></a><p>OkHttpCall çš„åˆ›å»ºï¼š<code>new OkHttpCall&lt;>(requestFactory, args, callFactory, responseConverter)</code></p><p>OkHttpCall æ˜¯ retrofit2.Call çš„å­ç±»ã€‚è¿™è¡Œä»£ç è´Ÿè´£å°† ServiceMethod è§£è¯»åˆ°çš„ä¿¡æ¯ï¼ˆä¸»è¦æ˜¯ä¸€ä¸ª RequestFactory ã€ä¸€ä¸ª CallFactory å’Œä¸€ä¸ª ResponseConverterï¼‰å°è£…è¿› OkHttpCallï¼›è€Œè¿™ä¸ªå¯¹è±¡å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™ï¼ˆä¾‹å¦‚å®ƒçš„ enqueue() æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼‰ï¼Œ åˆ©ç”¨ RequestFactory å’Œ CallFactory æ¥åˆ›å»ºä¸€ä¸ª okhttp3.Call å¯¹è±¡ï¼Œå¹¶è°ƒç”¨è¿™ä¸ª okhttp3.Call å¯¹è±¡æ¥è¿›è¡Œç½‘ç»œè¯·æ±‚çš„å‘èµ·ï¼Œç„¶ååˆ©ç”¨ ResponseConverter å¯¹ç»“æœè¿›è¡Œé¢„å¤„ç†ä¹‹åï¼Œäº¤å›ç»™ Retrofit çš„ Callback ã€‚</p><a href=#httpservicemethodadapt><h3 id=httpservicemethodadapt><span class=hanchor arialabel=Anchor># </span>HttpServiceMethod.adapt()</h3></a><p>è°ƒç”¨ adapt() æ–¹æ³•ï¼š<code>adapt(call, args)</code></p><p>åˆ›å»º OkHttpCall å¯¹è±¡åï¼Œä¼šè°ƒç”¨ abstract æ–¹æ³• <code>adapt(Call&lt;ResponseT> call, Object[] args)</code> å°† OkHttpCall å¯¹è±¡å’Œè¯·æ±‚å‚æ•°ä¼ å…¥ã€‚</p><p>æ ¹æ®å‰é¢çš„åˆ†æï¼ŒHttpServiceMethod æœ‰ä¸‰ä¸ªå­ç±»å¹¶ä¸”éƒ½æ˜¯ HttpServiceMethod çš„å†…éƒ¨ç±»ï¼Œåˆ†åˆ«æ˜¯</p><p>CallAdaptedã€SuspendForResponse å’Œ SuspendForBodyã€‚</p><a href=#calladaptedadapt><h4 id=calladaptedadapt><span class=hanchor arialabel=Anchor># </span>CallAdapted.adapt</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=n>ReturnT</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>ResponseT</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>callAdapter</span><span class=o>.</span><span class=na>adapt</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨äº† callAdapter çš„ adapt æ–¹æ³•ï¼Œè¿™ä¸ª callAdapter å°±æ˜¯å‰é¢ loadServiceMethod() æµç¨‹ä¸­é€šè¿‡ createCallAdapter() æ–¹æ³•è·å–åˆ°çš„ CallAdapter å¯¹è±¡ã€‚</p><p>å› æ­¤ï¼Œæ ¹æ®å‰é¢çš„åˆ†æå¯çŸ¥ï¼Œæ­¤æ—¶çš„ CallAdapter ä¼šæ ¹æ®è¯·æ±‚æ–¹æ³•çš„ç±»å‹æ¥ä½¿ç›¸åº”çš„å®ç°ç±»ã€‚</p><a href=#defaultcalladapterfactory-ä¸­çš„åŒ¿å-calladapter><h5 id=defaultcalladapterfactory-ä¸­çš„åŒ¿å-calladapter><span class=hanchor arialabel=Anchor># </span>DefaultCallAdapterFactory ä¸­çš„åŒ¿å CallAdapter</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;?&gt;&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Type</span> <span class=nf>responseType</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>responseType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>executor</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>call</span> <span class=o>:</span> <span class=k>new</span> <span class=n>ExecutorCallbackCall</span><span class=o>&lt;&gt;(</span><span class=n>executor</span><span class=o>,</span> <span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œadapt æ–¹æ³•è¿”å›çš„æ˜¯ ExecutorCallbackCall å¯¹è±¡ã€‚</p><a href=#rxjava3calladapterfactoryrxjava3calladapter><h5 id=rxjava3calladapterfactoryrxjava3calladapter><span class=hanchor arialabel=Anchor># </span>RxJava3CallAdapterFactory.RxJava3CallAdapter</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Object</span> <span class=nf>adapt</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Observable</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=n>responseObservable</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>isAsync</span> <span class=o>?</span> <span class=k>new</span> <span class=n>CallEnqueueObservable</span><span class=o>&lt;&gt;(</span><span class=n>call</span><span class=o>)</span> <span class=o>:</span> <span class=k>new</span> <span class=n>CallExecuteObservable</span><span class=o>&lt;&gt;(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Observable</span><span class=o>&lt;?&gt;</span> <span class=n>observable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isResult</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>observable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResultObservable</span><span class=o>&lt;&gt;(</span><span class=n>responseObservable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>isBody</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>observable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BodyObservable</span><span class=o>&lt;&gt;(</span><span class=n>responseObservable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>observable</span> <span class=o>=</span> <span class=n>responseObservable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>scheduler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>observable</span> <span class=o>=</span> <span class=n>observable</span><span class=o>.</span><span class=na>subscribeOn</span><span class=o>(</span><span class=n>scheduler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isFlowable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// We only ever deliver a single value, and the RS spec states that you MUST request at least
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// one element which means we never need to honor backpressure.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>observable</span><span class=o>.</span><span class=na>toFlowable</span><span class=o>(</span><span class=n>BackpressureStrategy</span><span class=o>.</span><span class=na>MISSING</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isSingle</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>observable</span><span class=o>.</span><span class=na>singleOrError</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isMaybe</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>observable</span><span class=o>.</span><span class=na>singleElement</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>isCompletable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>observable</span><span class=o>.</span><span class=na>ignoreElements</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>RxJavaPlugins</span><span class=o>.</span><span class=na>onAssembly</span><span class=o>(</span><span class=n>observable</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#completablefuturecalladapterfactoryresponsecalladapter><h5 id=completablefuturecalladapterfactoryresponsecalladapter><span class=hanchor arialabel=Anchor># </span>CompletableFutureCallAdapterFactory.ResponseCallAdapter</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>adapt</span><span class=o>(</span><span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>future</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CallCancelCompletableFuture</span><span class=o>&lt;&gt;(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>call</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=k>new</span> <span class=n>BodyCallback</span><span class=o>(</span><span class=n>future</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>future</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#å°ç»“-2><h5 id=å°ç»“-2><span class=hanchor arialabel=Anchor># </span>å°ç»“</h5></a><p>å¯¹äºä¾‹å­ä¸­ GithubService ä¸­çš„è¯·æ±‚æ–¹æ³•ï¼š</p><ol><li><code>fun listRepos(@Path("user") user: String?): Call&lt;List&lt;Repo>></code></li></ol><p>è¿”å› DefaultCallAdapterFactory.ExecutorCallbackCall å®ä¾‹</p><ol start=2><li><code>fun listReposRx(@Path("user") user: String?): Observable&lt;List&lt;Repo>></code></li></ol><p>å¼‚æ­¥æ–¹å¼è¿”å› CallEnqueueObservable å®ä¾‹ï¼ŒåŒæ­¥æ–¹å¼è¿”å› CallExecuteObservable å®ä¾‹</p><ol start=3><li><code>fun listReposCompletable(@Path("user") user: String?): CompletableFuture&lt;List&lt;Repo>></code></li></ol><p>è¿”å› CompletableFutureCallAdapterFactory.CallCancelCompletableFuture å®ä¾‹</p><p>å› æ­¤ï¼ŒCallAdatper çš„ä½œç”¨å°±æ˜¯æŠŠ OkHttpCall æ ¹æ®è¯·æ±‚æ–¹æ³•çš„è¿”å›å€¼åŒ…è£…æˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶ä¸”è¿”å›ç»™è°ƒç”¨è€…ã€‚</p><a href=#suspendforresponseadapt><h4 id=suspendforresponseadapt><span class=hanchor arialabel=Anchor># </span>SuspendForResponse.adapt</h4></a><a href=#suspendforbodyadapt><h4 id=suspendforbodyadapt><span class=hanchor arialabel=Anchor># </span>SuspendForBody.adapt</h4></a><a href=#callenqueue><h2 id=callenqueue><span class=hanchor arialabel=Anchor># </span>Call.enqueue()</h2></a><p>æ ¹æ®å‰é¢çš„åˆ†æï¼Œåœ¨ Android å¹³å°ä¸Šï¼Œå¯¹äºè¿”å› Call ç±»å‹çš„è¯·æ±‚æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šè¢«ä¸€ä¸ªåŒ¿å CallAdapter åœ¨ adapt æ–¹æ³•ä¸­åŒ…è£…æˆ ExecutorCallbackCall å¹¶è¿”å›ç»™è°ƒç”¨è€…ã€‚ä¸ç”¨å¤šè¯´ä¹Ÿåº”è¯¥çŸ¥é“ï¼Œè¿™ä¸ªç±»ç»§æ‰¿è‡ª Call æ¥å£ã€‚é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå®ç°è¯·æ±‚çš„å‘¢ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ExecutorCallbackCall</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>delegate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ExecutorCallbackCall</span><span class=o>(</span><span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=o>,</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>delegate</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>callbackExecutor</span> <span class=o>=</span> <span class=n>callbackExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>delegate</span> <span class=o>=</span> <span class=n>delegate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>enqueue</span><span class=o>(</span><span class=kd>final</span> <span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>callback</span><span class=o>,</span> <span class=s>&#34;callback == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>delegate</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResponse</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=kd>final</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>response</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>callbackExecutor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                  <span class=k>if</span> <span class=o>(</span><span class=n>delegate</span><span class=o>.</span><span class=na>isCanceled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// Emulate OkHttp&#39;s behavior of throwing/delivering an IOException on
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// cancellation.
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>callback</span><span class=o>.</span><span class=na>onFailure</span><span class=o>(</span><span class=n>ExecutorCallbackCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=k>new</span> <span class=n>IOException</span><span class=o>(</span><span class=s>&#34;Canceled&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>callback</span><span class=o>.</span><span class=na>onResponse</span><span class=o>(</span><span class=n>ExecutorCallbackCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                  <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>});</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>          <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFailure</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=kd>final</span> <span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>callbackExecutor</span><span class=o>.</span><span class=na>execute</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>callback</span><span class=o>.</span><span class=na>onFailure</span><span class=o>(</span><span class=n>ExecutorCallbackCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=n>t</span><span class=o>));</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isExecuted</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>isExecuted</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>execute</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>execute</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>cancel</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>delegate</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isCanceled</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>isCanceled</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;CloneDoesntCallSuperClone&#34;</span><span class=o>)</span> <span class=c1>// Performing deep clone.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>clone</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>ExecutorCallbackCall</span><span class=o>&lt;&gt;(</span><span class=n>callbackExecutor</span><span class=o>,</span> <span class=n>delegate</span><span class=o>.</span><span class=na>clone</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Request</span> <span class=nf>request</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>request</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Timeout</span> <span class=nf>timeout</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>timeout</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ä»£ç†æ¨¡å¼çš„å®ç°ï¼ŒExecutorCallbackCall çš„å…¨éƒ¨å®ç°éƒ½äº¤ç»™äº† delegate å¯¹è±¡ï¼Œè€Œè¿™ä¸ª delegate æ­£æ˜¯ HttpServiceMethod.invoke() æµç¨‹ä¸­ç”Ÿæˆçš„ OkHttpCall å¯¹è±¡ã€‚</p><p>åœ¨ enqueue() æ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨ OkHttpCall.enqueue() æ–¹æ³•è·å–è¯·æ±‚ç»“æœï¼Œç„¶ååœ¨ CallBack å›è°ƒä¸­åœ¨ callbackExecutor.execute() ä¸­å°†å›è°ƒç»“æœå†æ¬¡å›è°ƒç»™ callbackã€‚</p><p>è¿™é‡Œ callbackExecutor å°±æ˜¯ Platform.Android.MainThreadExecutorï¼Œå› æ­¤å¤–å±‚è·å–çš„å›è°ƒå®åœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œä¸ç”¨å†åˆ‡æ¢çº¿ç¨‹ã€‚</p><p>é‚£ä¹ˆå†çœ‹ OkHttpCall.enqueue() æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>enqueue</span><span class=o>(</span><span class=kd>final</span> <span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>callback</span><span class=o>,</span> <span class=s>&#34;callback == null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span> <span class=n>call</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Throwable</span> <span class=n>failure</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>executed</span><span class=o>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Already executed.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>executed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>call</span> <span class=o>=</span> <span class=n>rawCall</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>failure</span> <span class=o>=</span> <span class=n>creationFailure</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>call</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>failure</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>call</span> <span class=o>=</span> <span class=n>rawCall</span> <span class=o>=</span> <span class=n>createRawCall</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>throwIfFatal</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>failure</span> <span class=o>=</span> <span class=n>creationFailure</span> <span class=o>=</span> <span class=n>t</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>failure</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=na>onFailure</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>failure</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>canceled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>call</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>okhttp3</span><span class=o>.</span><span class=na>Callback</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResponse</span><span class=o>(</span><span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span> <span class=n>call</span><span class=o>,</span> <span class=n>okhttp3</span><span class=o>.</span><span class=na>Response</span> <span class=n>rawResponse</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>response</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è§£æç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>response</span> <span class=o>=</span> <span class=n>parseResponse</span><span class=o>(</span><span class=n>rawResponse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>throwIfFatal</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>callFailure</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>callback</span><span class=o>.</span><span class=na>onResponse</span><span class=o>(</span><span class=n>OkHttpCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>throwIfFatal</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span> <span class=c1>// TODO this is not great
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFailure</span><span class=o>(</span><span class=n>okhttp3</span><span class=o>.</span><span class=na>Call</span> <span class=n>call</span><span class=o>,</span> <span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>callFailure</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kt>void</span> <span class=nf>callFailure</span><span class=o>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>callback</span><span class=o>.</span><span class=na>onFailure</span><span class=o>(</span><span class=n>OkHttpCall</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>throwIfFatal</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span> <span class=c1>// TODO this is not great
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>parseResponse</span><span class=o>(</span><span class=n>okhttp3</span><span class=o>.</span><span class=na>Response</span> <span class=n>rawResponse</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ResponseBody</span> <span class=n>rawBody</span> <span class=o>=</span> <span class=n>rawResponse</span><span class=o>.</span><span class=na>body</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Remove the body&#39;s source (the only stateful object) so we can pass the response along.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>rawResponse</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>rawResponse</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>newBuilder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>body</span><span class=o>(</span><span class=k>new</span> <span class=n>NoContentResponseBody</span><span class=o>(</span><span class=n>rawBody</span><span class=o>.</span><span class=na>contentType</span><span class=o>(),</span> <span class=n>rawBody</span><span class=o>.</span><span class=na>contentLength</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>code</span> <span class=o>=</span> <span class=n>rawResponse</span><span class=o>.</span><span class=na>code</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>code</span> <span class=o>&lt;</span> <span class=n>200</span> <span class=o>||</span> <span class=n>code</span> <span class=o>&gt;=</span> <span class=n>300</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Buffer the entire body to avoid future I/O.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>ResponseBody</span> <span class=n>bufferedBody</span> <span class=o>=</span> <span class=n>Utils</span><span class=o>.</span><span class=na>buffer</span><span class=o>(</span><span class=n>rawBody</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Response</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=n>bufferedBody</span><span class=o>,</span> <span class=n>rawResponse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>rawBody</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>code</span> <span class=o>==</span> <span class=n>204</span> <span class=o>||</span> <span class=n>code</span> <span class=o>==</span> <span class=n>205</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>rawBody</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Response</span><span class=o>.</span><span class=na>success</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>rawResponse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ExceptionCatchingResponseBody</span> <span class=n>catchingBody</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ExceptionCatchingResponseBody</span><span class=o>(</span><span class=n>rawBody</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä½¿ç”¨ responseConverter å®Œæˆè½¬æ¢
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>T</span> <span class=n>body</span> <span class=o>=</span> <span class=n>responseConverter</span><span class=o>.</span><span class=na>convert</span><span class=o>(</span><span class=n>catchingBody</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Response</span><span class=o>.</span><span class=na>success</span><span class=o>(</span><span class=n>body</span><span class=o>,</span> <span class=n>rawResponse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If the underlying source threw an exception, propagate that rather than indicating it was
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// a runtime exception.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>catchingBody</span><span class=o>.</span><span class=na>throwIfCaught</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ˜¯ä¾èµ– OkHttp3 æ¥å®ç°ç½‘ç»œè¯·æ±‚çš„ã€‚è·å–åˆ°è¯·æ±‚ç»“æœåï¼Œç¬¬ 40 è¡Œå°†ä¼šè°ƒç”¨ parseResponse() æ–¹æ³•å°†ç»“æœè§£æå‡ºæ¥ã€‚parseResponse() æ–¹æ³•ç¬¬ 100 è¡Œå°†ä¼šè°ƒç”¨ responseConverter è¿›è¡Œè½¬æ¢ã€‚</p><p>è¿™ä¸€æ•´ä¸ªè¿‡ç¨‹å¯ä»¥ä¸€ä¸‹æ—¶åºå›¾ç›´è§‚å±•ç¤ºï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Retrofit/clipboard_20230323_035658.png width=auto alt></p><a href=#observablesubscribe><h2 id=observablesubscribe><span class=hanchor arialabel=Anchor># </span>Observable.subscribe()</h2></a><p>å¯¹äºè¿”å› Observable çš„è¯·æ±‚æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“ç»è¿‡ RxJava3CallAdapter.adapt æ–¹æ³•çš„åŒ…è£…ï¼Œæœ€ç»ˆè¿”å›çš„æ˜¯ CallEnqueueObservable æˆ–è€… CallExecuteObservableã€‚ä»¥å‰è€…ä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹å…·ä½“çš„å®ç°æ–¹å¼ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kd>class</span> <span class=nc>CallEnqueueObservable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>Observable</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>originalCall</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>CallEnqueueObservable</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>originalCall</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>originalCall</span> <span class=o>=</span> <span class=n>originalCall</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>subscribeActual</span><span class=o>(</span><span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>observer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Since Call is a one-shot type, clone it for each new observer.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span> <span class=o>=</span> <span class=n>originalCall</span><span class=o>.</span><span class=na>clone</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>CallCallback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>callback</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CallCallback</span><span class=o>&lt;&gt;(</span><span class=n>call</span><span class=o>,</span> <span class=n>observer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>observer</span><span class=o>.</span><span class=na>onSubscribe</span><span class=o>(</span><span class=n>callback</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>callback</span><span class=o>.</span><span class=na>isDisposed</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span><span class=o>.</span><span class=na>enqueue</span><span class=o>(</span><span class=n>callback</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>CallCallback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Disposable</span><span class=o>,</span> <span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;?&gt;</span> <span class=n>call</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>observer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>disposed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>terminated</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>CallCallback</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;?&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>observer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>call</span> <span class=o>=</span> <span class=n>call</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>observer</span> <span class=o>=</span> <span class=n>observer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResponse</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>response</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>disposed</span><span class=o>)</span> <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>observer</span><span class=o>.</span><span class=na>onNext</span><span class=o>(</span><span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>disposed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>terminated</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=n>observer</span><span class=o>.</span><span class=na>onComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Exceptions</span><span class=o>.</span><span class=na>throwIfFatal</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>terminated</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>RxJavaPlugins</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>disposed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>observer</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>inner</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Exceptions</span><span class=o>.</span><span class=na>throwIfFatal</span><span class=o>(</span><span class=n>inner</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>RxJavaPlugins</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=k>new</span> <span class=n>CompositeException</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>inner</span><span class=o>));</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFailure</span><span class=o>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span><span class=o>,</span> <span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>call</span><span class=o>.</span><span class=na>isCanceled</span><span class=o>())</span> <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>observer</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>inner</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Exceptions</span><span class=o>.</span><span class=na>throwIfFatal</span><span class=o>(</span><span class=n>inner</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>RxJavaPlugins</span><span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=k>new</span> <span class=n>CompositeException</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>inner</span><span class=o>));</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>dispose</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>disposed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>call</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDisposed</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>disposed</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ subscribeActual() æ–¹æ³•ä¸­ï¼ŒåŒæ ·è°ƒç”¨çš„æ˜¯ OkHttpCall.enqueue() æ–¹æ³•å®ç°è¯·æ±‚ï¼Œå¹¶ä¸”åœ¨ CallCallback å›è°ƒä¸­æŠŠè¯·æ±‚ç»“æœé€šè¿‡ onNext(response) å‘å°„ç»™ä¸‹æ¸¸çš„ Observerã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹çš„æ—¶åºå›¾å¦‚ä¸‹ï¼š</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Retrofit/clipboard_20230323_035702.png width=auto alt></p><a href=#æ€»ç»“><h1 id=æ€»ç»“><span class=hanchor arialabel=Anchor># </span>æ€»ç»“</h1></a><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Retrofit/clipboard_20230323_035708.png width=auto alt></p></article><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.guanpj.top/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by guanpj using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://www.guanpj.top/>Home</a></li><li><a href=https://twitter.com/guanpj>Twitter</a></li><li><a href=https://github.com/guanpj>GitHub</a></li></ul></footer></div></div></body></html>